<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Sign in – Tutor Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./i18n.js"></script>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 50%, #f1f5f9 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      color: #0f172a;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px -34px rgba(15, 23, 42, 0.25), 0 0 0 1px rgba(148, 163, 184, 0.15);
    }

    h1 {
      margin: 0 0 12px;
      font-size: 22px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #475569;
    }

    input {
      width: 100%;
      padding: 8px;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      font-size: 13px;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .primary {
      background: #0f172a;
      color: #fff;
    }

    .secondary {
      background: #fff;
      color: #0f172a;
      border: 1px solid #cbd5e1;
    }

    .text-sm {
      font-size: 12px;
      color: #475569;
    }

    .mt-2 {
      margin-top: 8px;
    }

    .mt-3 {
      margin-top: 12px;
    }

    .mt-4 {
      margin-top: 16px;
    }

    .hint {
      font-size: 11px;
      color: #94a3b8;
    }

    .error {
      color: #b91c1c;
      font-size: 12px;
      margin-top: 8px;
    }

    .hidden {
      display: none !important;
    }

    .page-shell {
      width: 100%;
      max-width: 420px;
    }

    .lang-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .lang-label {
      font-size: 11px;
      color: #475569;
      font-weight: 600;
    }

    .lang-select {
      border: 1px solid #cbd5e1;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      background: #fff;
      color: #0f172a;
    }

    .lang-banner {
      background: #e0f2fe;
      color: #0f172a;
      border: 1px solid #bae6fd;
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12px;
      margin-bottom: 12px;
      box-shadow: 0 10px 24px -18px rgba(15, 23, 42, 0.35);
    }

    .lang-banner-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .lang-banner-actions button {
      border: 1px solid #94a3b8;
      background: #fff;
      color: #0f172a;
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 999px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="page-shell">
    <div id="langBanner" class="lang-banner hidden">
      <div id="langBannerText" data-i18n="lang.banner">Choose language / Elige idioma / Choisissez la langue / 请选择语言</div>
      <div class="lang-banner-actions">
        <button type="button" data-lang-button="en">English</button>
        <button type="button" data-lang-button="es">Español</button>
        <button type="button" data-lang-button="fr">Français</button>
        <button type="button" data-lang-button="zh">中文（简体）</button>
      </div>
    </div>
    <div class="card">
      <div class="lang-row">
        <label class="lang-label" data-i18n="top.language_label">Language / Idioma / Langue / 中文</label>
        <select class="lang-select" data-lang-select>
          <option value="en" data-i18n="lang.option.en">English</option>
          <option value="es" data-i18n="lang.option.es">Español</option>
          <option value="fr" data-i18n="lang.option.fr">Français</option>
          <option value="zh" data-i18n="lang.option.zh">中文（简体）</option>
        </select>
      </div>
    <!-- Tabs -->
    <div class="flex border-b border-slate-200 mb-4">
      <button class="tab-btn active" data-tab="owner" data-i18n="auth.owner_tab">Owner</button>
      <button class="tab-btn" data-tab="parent" data-i18n="auth.parent_tab">Parent</button>
      <button class="tab-btn" data-tab="student" data-i18n="auth.student_tab">Student</button>
    </div>

    <!-- Owner Login -->
    <div id="owner-tab" class="tab-content">
      <h1 data-i18n="auth.sign_in">Sign in</h1>
      <p class="text-sm" data-i18n="auth.owner_desc">Tutor/Owner access. Students and parents use their login code.</p>
      <form id="ownerForm" class="mt-3">
        <div class="mt-3">
          <label data-i18n="auth.email">Email</label>
          <input type="email" name="email" required autocomplete="email">
        </div>
        <div class="mt-3">
          <label data-i18n="auth.password">Password</label>
          <input type="password" name="password" required autocomplete="current-password">
        </div>
        <button type="submit" class="primary mt-4" data-i18n="auth.sign_in">Sign in</button>
      </form>
      <button id="forgotBtn" class="secondary mt-2" data-i18n="auth.forgot_password">Forgot password</button>
    </div>

    <!-- Parent Login -->
    <div id="parent-tab" class="tab-content hidden">
      <h1 data-i18n="auth.parent_access">Parent Access</h1>
      <p class="text-sm" data-i18n="auth.parent_code_prompt">Enter your Access Code.</p>
      <p class="hint" data-i18n-html="auth.terms_privacy_notice">By signing in, you agree to the <a href="./tos.html" target="_blank" rel="noopener">Terms of Service</a> and <a href="./privacy.html" target="_blank" rel="noopener">Privacy Policy</a>.</p>
      <form id="parentForm" class="mt-3">
        <div class="mt-3">
          <label data-i18n="auth.access_code">Access Code</label>
          <input type="text" name="code" required class="font-mono text-center tracking-widest uppercase"
            placeholder="XXXXXX" data-i18n-attr="placeholder:auth.access_code">
        </div>
        <button type="submit" class="primary mt-4" data-i18n="auth.enter">Enter</button>
      </form>
    </div>

    <!-- Student Login -->
    <div id="student-tab" class="tab-content hidden">
      <h1 data-i18n="auth.student_access">Student Access</h1>
      <p class="text-sm" data-i18n="auth.student_code_prompt">Enter your Student Code.</p>
      <p class="hint" data-i18n-html="auth.terms_privacy_notice">By signing in, you agree to the <a href="./tos.html" target="_blank" rel="noopener">Terms of Service</a> and <a href="./privacy.html" target="_blank" rel="noopener">Privacy Policy</a>.</p>
      <form id="studentForm" class="mt-3">
        <div class="mt-3">
          <label data-i18n="auth.student_code">Student Code</label>
          <input type="text" name="code" required class="font-mono text-center tracking-widest uppercase"
            placeholder="XXXXXX" data-i18n-attr="placeholder:auth.student_code">
        </div>
        <button type="submit" class="primary mt-4" data-i18n="auth.start_learning">Start Learning</button>
      </form>
    </div>

    <div id="msg" class="error"></div>
    <footer class="hint mt-4" data-merchant-disclosure></footer>
    </div>
  </div>

  <script>
    const CANONICAL_ORIGIN = 'https://tutor-mcp.com';
    const LEGACY_BASE_PATH = '/tutor-dashboard';
    const isLocalDevHost = /^(localhost|127\.0\.0\.1|0\.0\.0\.0|::1)$/i.test(window.location.hostname);
    const APP_ORIGIN = isLocalDevHost ? window.location.origin : CANONICAL_ORIGIN;
    const appUrl = (path = '/') => new URL(path, `${APP_ORIGIN}/`).href;

    if (!isLocalDevHost && window.location.origin !== CANONICAL_ORIGIN) {
      const target = new URL(window.location.href);
      target.protocol = 'https:';
      target.host = new URL(CANONICAL_ORIGIN).host;
      if (target.pathname === LEGACY_BASE_PATH) {
        target.pathname = '/';
      } else if (target.pathname.startsWith(`${LEGACY_BASE_PATH}/`)) {
        target.pathname = target.pathname.slice(LEGACY_BASE_PATH.length) || '/';
      }
      window.location.replace(target.toString());
    }

    const SUPABASE_URL = 'https://wdsqnbebutuhwckjpwqf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indkc3FuYmVidXR1aHdja2pwd3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMDE1NzcsImV4cCI6MjA3OTY3NzU3N30.pJglpTaZouSQFUVCbQONHK1UsB9CgWewKQCIV13NOEM';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const CODE_EMAIL_SUFFIX = '@codes.tutor';


    // Silence noisy "output" reference errors some browsers surface
    const suppressOutputError = (msg = '') => String(msg).toLowerCase().includes('output');
    window.addEventListener('error', (event) => {
      if (suppressOutputError(event.message)) {
        event.preventDefault();
        return true;
      }
      return false;
    });
    window.addEventListener('unhandledrejection', (event) => {
      const reason = String(event.reason?.message || event.reason || '').toLowerCase();
      if (suppressOutputError(reason)) {
        event.preventDefault();
        return true;
      }
      return false;
    });

    // Tabs logic
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        btn.classList.add('active');
        document.getElementById(`${btn.dataset.tab}-tab`).classList.remove('hidden');
        document.getElementById('msg').textContent = '';
      });
    });

    if (window.initLanguageUI) initLanguageUI();

    const ownerForm = document.getElementById('ownerForm');
    const msg = document.getElementById('msg');

    ownerForm.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = '';
      const email = ownerForm.email.value.trim();
      const password = ownerForm.password.value;

      try {
        const { data, error } = await supabaseClient.functions.invoke('owner-password-login', {
          body: { email, password }
        });
        if (error) {
          const ctx = error?.context || {};
          let details = ctx.error || ctx.message || error?.message || '';
          if (!details && ctx.body) {
            try {
              const parsed = typeof ctx.body === 'string' ? JSON.parse(ctx.body) : ctx.body;
              details = parsed?.error || '';
            } catch (_) { }
          }

          // Fallback: try direct auth sign-in if edge function path fails.
          const direct = await supabaseClient.auth.signInWithPassword({ email, password });
          if (direct?.error || !direct?.data?.session) {
            throw new Error(details || direct?.error?.message || t('auth.error_login_failed'));
          }
          window.location.href = appUrl('/index.html');
          return;
        }
        if (!data?.access_token || !data?.refresh_token) {
          throw new Error(data?.error || t('auth.error_login_failed'));
        }
        const { error: setErr } = await supabaseClient.auth.setSession({
          access_token: data.access_token,
          refresh_token: data.refresh_token
        });
        if (setErr) throw setErr;
        window.location.href = appUrl('/index.html');
      } catch (err) {
        msg.textContent = err.message || t('auth.error_login_failed');
      }
    };

    /**
     * Handles the Code Login Flow using the service-edge function (no captcha required)
     * @param {string} code - The access code
     * @param {string} role - 'student' or 'parent'
     * @param {string} token - The hCaptcha token (unused fallback)
     * @param {string} widgetId - The widget ID to reset if needed
     */
    async function handleCodeLogin(code, role) {
      msg.textContent = t('auth.verifying_code');
      const cleanCode = code.trim().toUpperCase();

      try {
        // Call edge function to mint a session with service role (bypasses captcha)
        const { data, error } = await supabaseClient.functions.invoke('login-with-code', {
          body: { code: cleanCode, role }
        });
        if (error) {
          const ctx = error?.context || {};
          const status = ctx.status || error.status || 0;
          let retryAfter = data?.retry_after_sec;
          if (!retryAfter && ctx.body) {
            try {
              const parsed = typeof ctx.body === 'string' ? JSON.parse(ctx.body) : ctx.body;
              retryAfter = parsed?.retry_after_sec;
            } catch { }
          }
          if (status === 429) {
            const mins = retryAfter ? Math.max(1, Math.ceil(retryAfter / 60)) : 30;
            throw new Error(t('auth.error_retry', { mins }));
          }
          const details = ctx.error || ctx.message || data?.error || error.message || t('auth.error_login_failed');
          throw new Error(details);
        }
        if (data?.success === false) {
          throw new Error(data?.error || t('auth.error_invalid_code'));
        }
        if (!data?.access_token || !data?.refresh_token) {
          throw new Error(data?.error || t('auth.error_new_code'));
        }

        const { error: setErr } = await supabaseClient.auth.setSession({
          access_token: data.access_token,
          refresh_token: data.refresh_token
        });
        if (setErr) throw setErr;

        window.location.href = appUrl('/index.html');
      } catch (err) {
        console.error(err);
        const message = err?.message || err?.error || t('auth.error_access_failed');
        msg.textContent = message;
      }
    }

    document.getElementById('studentForm').onsubmit = (e) => {
      e.preventDefault();
      handleCodeLogin(e.target.code.value, 'student');
    };

    document.getElementById('parentForm').onsubmit = (e) => {
      e.preventDefault();
      handleCodeLogin(e.target.code.value, 'parent');
    };

    document.getElementById('forgotBtn').onclick = async () => {
      alert(t('auth.forgot_alert'));
    };

  </script>

  <style>
    .tab-btn {
      flex: 1;
      padding: 10px;
      font-size: 13px;
      font-weight: 500;
      color: #64748b;
      background: #f1f5f9;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn:first-child {
      border-top-left-radius: 8px;
    }

    .tab-btn:last-child {
      border-top-right-radius: 8px;
    }

    .tab-btn:hover {
      background: #e2e8f0;
    }

    .tab-btn.active {
      background: #fff;
      color: #0f172a;
      border-bottom-color: #0f172a;
      font-weight: 600;
    }

    .tab-content {
      animation: fadeIn 0.2s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }
  </style>
  <script src="./business-config.js"></script>
  <script src="./business-ui.js"></script>
</body>

</html>
