<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Sign in â€“ Tutor Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 50%, #f1f5f9 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      color: #0f172a;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px -34px rgba(15, 23, 42, 0.25), 0 0 0 1px rgba(148, 163, 184, 0.15);
    }

    h1 {
      margin: 0 0 12px;
      font-size: 22px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #475569;
    }

    input {
      width: 100%;
      padding: 8px;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      font-size: 13px;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .primary {
      background: #0f172a;
      color: #fff;
    }

    .secondary {
      background: #fff;
      color: #0f172a;
      border: 1px solid #cbd5e1;
    }

    .text-sm {
      font-size: 12px;
      color: #475569;
    }

    .mt-2 {
      margin-top: 8px;
    }

    .mt-3 {
      margin-top: 12px;
    }

    .mt-4 {
      margin-top: 16px;
    }

    .hint {
      font-size: 11px;
      color: #94a3b8;
    }

    .error {
      color: #b91c1c;
      font-size: 12px;
      margin-top: 8px;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <div class="card">
    <!-- Tabs -->
    <div class="flex border-b border-slate-200 mb-4">
      <button class="tab-btn active" data-tab="owner">Owner</button>
      <button class="tab-btn" data-tab="parent">Parent</button>
      <button class="tab-btn" data-tab="student">Student</button>
    </div>

    <!-- Owner Login -->
    <div id="owner-tab" class="tab-content">
      <h1>Sign in</h1>
      <p class="text-sm">Tutor/Owner access. Students and parents use their login code.</p>
      <form id="ownerForm" class="mt-3">
        <div class="mt-3">
          <label>Email</label>
          <input type="email" name="email" required autocomplete="email">
        </div>
        <div class="mt-3">
          <label>Password</label>
          <input type="password" name="password" required autocomplete="current-password">
        </div>
        <button type="submit" class="primary mt-4">Sign in</button>
      </form>
      <button id="forgotBtn" class="secondary mt-2">Forgot password</button>
    </div>

    <!-- Parent Login -->
    <div id="parent-tab" class="tab-content hidden">
      <h1>Parent Access</h1>
      <p class="text-sm">Enter your Access Code.</p>
      <p class="hint">By signing in, you agree to the <a href="./tos.html" target="_blank" rel="noopener">Terms of Service</a> and <a href="./privacy.html" target="_blank" rel="noopener">Privacy Policy</a>.</p>
      <form id="parentForm" class="mt-3">
        <div class="mt-3">
          <label>Access Code</label>
          <input type="text" name="code" required class="font-mono text-center tracking-widest uppercase"
            placeholder="XXXXXX">
        </div>
        <button type="submit" class="primary mt-4">Enter</button>
      </form>
    </div>

    <!-- Student Login -->
    <div id="student-tab" class="tab-content hidden">
      <h1>Student Access</h1>
      <p class="text-sm">Enter your Student Code.</p>
      <p class="hint">By signing in, you agree to the <a href="./tos.html" target="_blank" rel="noopener">Terms of Service</a> and <a href="./privacy.html" target="_blank" rel="noopener">Privacy Policy</a>.</p>
      <form id="studentForm" class="mt-3">
        <div class="mt-3">
          <label>Student Code</label>
          <input type="text" name="code" required class="font-mono text-center tracking-widest uppercase"
            placeholder="XXXXXX">
        </div>
        <button type="submit" class="primary mt-4">Start Learning</button>
      </form>
    </div>

    <div id="msg" class="error"></div>
    <footer class="hint mt-4" data-merchant-disclosure></footer>
  </div>

  <script>
    const SUPABASE_URL = 'https://wdsqnbebutuhwckjpwqf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indkc3FuYmVidXR1aHdja2pwd3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMDE1NzcsImV4cCI6MjA3OTY3NzU3N30.pJglpTaZouSQFUVCbQONHK1UsB9CgWewKQCIV13NOEM';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const CODE_EMAIL_SUFFIX = '@codes.tutor';


    // Silence noisy "output" reference errors some browsers surface
    const suppressOutputError = (msg = '') => String(msg).toLowerCase().includes('output');
    window.addEventListener('error', (event) => {
      if (suppressOutputError(event.message)) {
        event.preventDefault();
        return true;
      }
      return false;
    });
    window.addEventListener('unhandledrejection', (event) => {
      const reason = String(event.reason?.message || event.reason || '').toLowerCase();
      if (suppressOutputError(reason)) {
        event.preventDefault();
        return true;
      }
      return false;
    });

    // Tabs logic
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        btn.classList.add('active');
        document.getElementById(`${btn.dataset.tab}-tab`).classList.remove('hidden');
        document.getElementById('msg').textContent = '';
      });
    });

    const ownerForm = document.getElementById('ownerForm');
    const msg = document.getElementById('msg');

    ownerForm.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = '';
      const email = ownerForm.email.value.trim();
      const password = ownerForm.password.value.trim();

      try {
        const { data, error } = await supabaseClient.functions.invoke('owner-password-login', {
          body: { email, password }
        });
        if (error) {
          const details = error?.context?.error || error?.message || 'Login failed';
          throw new Error(details);
        }
        if (!data?.access_token || !data?.refresh_token) {
          throw new Error(data?.error || 'Login failed');
        }
        const { error: setErr } = await supabaseClient.auth.setSession({
          access_token: data.access_token,
          refresh_token: data.refresh_token
        });
        if (setErr) throw setErr;
        window.location.href = './index.html';
      } catch (err) {
        msg.textContent = err.message || 'Login failed';
      }
    };

    /**
     * Handles the Code Login Flow using the service-edge function (no captcha required)
     * @param {string} code - The access code
     * @param {string} role - 'student' or 'parent'
     * @param {string} token - The hCaptcha token (unused fallback)
     * @param {string} widgetId - The widget ID to reset if needed
     */
    async function handleCodeLogin(code, role) {
      msg.textContent = 'Verifying code...';
      const cleanCode = code.trim().toUpperCase();

      try {
        // Call edge function to mint a session with service role (bypasses captcha)
        const { data, error } = await supabaseClient.functions.invoke('login-with-code', {
          body: { code: cleanCode, role }
        });
        if (error) {
          const ctx = error?.context || {};
          const details = ctx.error || ctx.message || data?.error || error.message || 'Login failed.';
          throw new Error(details);
        }
        if (data?.success === false) {
          const dbg = data?.debug ? ` [debug: ${JSON.stringify(data.debug)}]` : '';
          throw new Error((data?.error || 'Invalid code') + dbg);
        }
        if (!data?.access_token || !data?.refresh_token) {
          throw new Error(data?.error || 'Login failed. Ask your tutor for a new code.');
        }

        const { error: setErr } = await supabaseClient.auth.setSession({
          access_token: data.access_token,
          refresh_token: data.refresh_token
        });
        if (setErr) throw setErr;

        window.location.href = './index.html';
      } catch (err) {
        console.error(err);
        const message = err?.message || err?.error || 'Access failed. Please try again.';
        msg.textContent = message;
      }
    }

    document.getElementById('studentForm').onsubmit = (e) => {
      e.preventDefault();
      handleCodeLogin(e.target.code.value, 'student');
    };

    document.getElementById('parentForm').onsubmit = (e) => {
      e.preventDefault();
      handleCodeLogin(e.target.code.value, 'parent');
    };

    document.getElementById('forgotBtn').onclick = async () => {
      alert('Please reset via email using the standard flow or contact support.');
    };

  </script>

  <style>
    .tab-btn {
      flex: 1;
      padding: 10px;
      font-size: 13px;
      font-weight: 500;
      color: #64748b;
      background: #f1f5f9;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn:first-child {
      border-top-left-radius: 8px;
    }

    .tab-btn:last-child {
      border-top-right-radius: 8px;
    }

    .tab-btn:hover {
      background: #e2e8f0;
    }

    .tab-btn.active {
      background: #fff;
      color: #0f172a;
      border-bottom-color: #0f172a;
      font-weight: 600;
    }

    .tab-content {
      animation: fadeIn 0.2s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }
  </style>
  <script src="./business-config.js"></script>
  <script src="./business-ui.js"></script>
</body>

</html>
