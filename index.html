<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tutoring Dashboard ‚Äì Physics ‚Ä¢ Chemistry ‚Ä¢ Maths</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg-main-light: #f3f4f6;
      --bg-main-dark: #020617;
      --card-light: #ffffff;
      --card-dark: #020617;
      --text-light: #020617;
      --text-dark: #e5e7eb;
      --border-dark: #1e293b;
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:
        radial-gradient(circle at 12% 20%, rgba(79,70,229,0.12), transparent 45%),
        radial-gradient(circle at 88% 18%, rgba(14,165,233,0.14), transparent 46%),
        linear-gradient(135deg, #f8fafc 0%, #eef2ff 50%, #f1f5f9 100%);
      background-attachment: fixed;
      color: var(--text-light);
    }
    body.dark {
      background:
        radial-gradient(circle at 12% 20%, rgba(59,130,246,0.18), transparent 42%),
        radial-gradient(circle at 85% 25%, rgba(34,211,238,0.12), transparent 50%),
        linear-gradient(135deg, #020617 0%, #0b1221 45%, #0b1324 100%);
      background-attachment: fixed;
      color: var(--text-dark);
    }
    body.dark .sidebar,
    body.dark .topbar {
      background: rgba(15,23,42,0.98) !important;
      border-color: var(--border-dark) !important;
      backdrop-filter: blur(18px);
    }
    body.dark #viewsContainer {
      background: transparent !important;
    }
    .card {
      background-color: var(--card-light);
      border: 1px solid rgba(148,163,184,0.25);
      border-radius: 1.1rem;
      box-shadow:
        0 20px 60px -34px rgba(15,23,42,0.7),
        0 0 0 1px rgba(148,163,184,0.12);
      transition: background 0.25s ease, border-color 0.2s ease, box-shadow 0.25s ease, transform 0.18s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow:
        0 26px 70px -36px rgba(15,23,42,0.85),
        0 0 0 1px rgba(148,163,184,0.2);
    }
    body.dark .card {
      background: radial-gradient(circle at 0% 0%, #111827 0, #0b1221 48%);
      border-color: var(--border-dark);
      color: var(--text-dark);
      box-shadow:
        0 20px 60px -30px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,0.85);
    }
    .sidebar {
      background: radial-gradient(circle at 0% 0%, #0f172a 0, #020617 70%);
      border-right: 1px solid #020617;
      box-shadow: 6px 0 24px -20px rgba(15,23,42,0.9);
    }
    .topbar {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(18px);
      border-bottom: 1px solid rgba(148,163,184,0.25);
    }
    body.dark .topbar {
      color: var(--text-dark);
      border-color: rgba(51,65,85,0.75);
      background: rgba(8,15,27,0.92);
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(148,163,184,0.8);
      border-radius: 999px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background-color: transparent;
    }
    .badge {
      border-radius: 999px;
      padding: 0.15rem 0.6rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .subject-physics { background-color: #eff6ff; color: #1d4ed8; }
    .subject-chemistry { background-color: #ecfdf3; color: #15803d; }
    .subject-maths { background-color: #fef2f2; color: #b91c1c; }
    body.dark .subject-physics { background-color: rgba(37,99,235,0.16); color: #93c5fd; }
    body.dark .subject-chemistry { background-color: rgba(22,163,74,0.14); color: #6ee7b7; }
    body.dark .subject-maths { background-color: rgba(248,113,113,0.16); color: #fecaca; }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 0.35rem;
    }
    .calendar-day {
      min-height: 6rem;
      border-radius: 0.8rem;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 0.4rem 0.45rem;
      display: flex;
      flex-direction: column;
      font-size: 0.75rem;
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(12px);
    }
    body.dark .calendar-day {
      background: radial-gradient(circle at 0% 0%, #020617 0, #020617 55%);
      border-color: rgba(51,65,85,0.9);
    }

    .tag-pill {
      font-size: 0.7rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      background-color: #e5e7eb;
      margin-right: 0.25rem;
      margin-bottom: 0.15rem;
      display: inline-flex;
      align-items: center;
      gap: 0.15rem;
    }
    body.dark .tag-pill {
      background-color: rgba(51,65,85,0.9);
      color: #e5e7eb;
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      backdrop-filter: blur(18px);
    }
    .overlay.show {
      display: flex;
    }

    /* Session chips */
    .session-card {
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 0.75rem;
      padding: 0.45rem 0.55rem;
      background: rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    .session-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px -20px rgba(15,23,42,0.4);
    }
    .session-chip {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: rgba(248,250,252,0.7);
    }
    .session-time {
      font-weight: 700;
      font-size: 0.8rem;
    }

    /* AUTH OVERLAY */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      backdrop-filter: blur(20px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
      padding: 1.5rem;
    }
    .auth-overlay.show {
      display: flex;
    }

    .read-only-banner {
      background: #fef3c7;
      color: #92400e;
      border-bottom: 1px solid #f59e0b;
    }

    .owner-locked {
      opacity: 0.55;
      pointer-events: none;
      cursor: not-allowed;
    }

    /* NAV */
    .nav-btn {
      border-radius: 999px;
      margin-inline: 0.5rem;
      margin-bottom: 0.2rem;
      padding-inline: 0.75rem;
      transition: background 0.18s ease, color 0.18s ease, transform 0.12s ease;
    }
    .nav-btn span:first-child {
      width: 1.3rem;
      text-align: center;
    }
    .nav-btn.active,
    .nav-btn.bg-slate-800 {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: #e5e7eb;
      transform: translateY(-1px);
    }
    .nav-btn:hover {
      background-color: rgba(15,23,42,0.6);
    }

    /* INPUTS / TEXTAREAS / SELECTS */
    input[type="text"],
    input[type="search"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    textarea,
    select {
      transition: background 0.16s ease, border-color 0.16s ease, color 0.16s ease, box-shadow 0.16s ease;
    }
    body.dark input[type="text"],
    body.dark input[type="search"],
    body.dark input[type="number"],
    body.dark input[type="date"],
    body.dark input[type="time"],
    body.dark textarea,
    body.dark select {
      background-color: #020617;
      border-color: var(--border-dark);
      color: var(--text-dark);
    }
    body.dark input::placeholder,
    body.dark textarea::placeholder {
      color: #64748b;
    }

    /* THEME TOGGLE BUTTON */
    #themeToggleBtn {
      box-shadow: 0 6px 18px -8px rgba(15,23,42,0.9);
      background: radial-gradient(circle at 30% 20%, #fef3c7 0, #fbbf24 40%, #f97316 100%);
      color: #111827;
    }
    body.dark #themeToggleBtn {
      background: radial-gradient(circle at 30% 20%, #22d3ee 0, #0ea5e9 40%, #1d4ed8 100%);
      color: #e5e7eb;
      box-shadow: 0 6px 20px -8px rgba(59,130,246,0.9);
    }

    /* TIGHTEN TABLES IN COMPACT MODE (density) ‚Äì class is toggled on #viewsContainer */
    .dense-mode table td,
    .dense-mode table th {
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
    }

    /* Light utility chips */
    .chip-btn {
      border: 1px solid rgba(148,163,184,0.6);
      border-radius: 999px;
      padding: 0.25rem 0.65rem;
      font-size: 0.75rem;
      transition: all 0.15s ease;
    }
    .chip-btn.active {
      background: linear-gradient(135deg, #4f46e5, #22d3ee);
      color: #f8fafc;
      border-color: transparent;
      box-shadow: 0 10px 30px -20px rgba(79,70,229,0.8);
    }

    .progress-track {
      height: 0.55rem;
      border-radius: 999px;
      background: rgba(148,163,184,0.25);
      overflow: hidden;
    }
    .progress-thumb {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #6366f1, #22c55e);
      transition: width 0.2s ease;
    }
    body.dark .progress-track {
      background: rgba(51,65,85,0.9);
    }

    .hint {
      font-size: 0.7rem;
      color: #94a3b8;
    }

    /* Section breathing */
    .section-shell {
      background: linear-gradient(135deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
      border: 1px solid rgba(148,163,184,0.22);
      border-radius: 1.3rem;
      padding: 1.25rem;
      box-shadow: 0 24px 70px -48px rgba(15,23,42,0.55);
    }
    body.dark .section-shell {
      background: linear-gradient(135deg, rgba(15,23,42,0.75), rgba(15,23,42,0.65));
      border-color: rgba(51,65,85,0.8);
    }
  </style>
</head>
<body>
  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="sidebar w-64 text-slate-200 flex flex-col border-r border-slate-900">
      <div class="px-4 py-4 flex items-center gap-2 border-b border-slate-800">
        <div class="h-9 w-9 rounded-2xl bg-indigo-500 flex items-center justify-center text-white font-bold text-lg">
          T
        </div>
        <div>
          <div class="font-semibold text-sm">Tutor Control Center</div>
          <div class="text-xs text-slate-400">Physics ‚Ä¢ Chemistry ‚Ä¢ Maths</div>
        </div>
      </div>

      <nav class="mt-4 flex-1 overflow-y-auto scrollbar-thin pb-2">
        <button data-view="dashboard" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üè†</span><span>Dashboard</span>
        </button>
        <button data-view="students" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üë•</span><span>Students</span>
        </button>
        <button data-view="schedule" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üìÖ</span><span>Schedule</span>
        </button>
        <button data-view="resources" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üìö</span><span>Resources</span>
        </button>
        <button data-view="finance" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üí∞</span><span>Finance</span>
        </button>
        <button data-view="settings" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>‚öôÔ∏è</span><span>Settings</span>
        </button>
      </nav>

      <div class="px-4 py-3 border-t border-slate-800 text-[11px] text-slate-400">
        Local-only data ‚Ä¢ Auto-saved
      </div>
    </aside>

    <!-- Main content -->
    <div class="flex-1 flex flex-col">
      <!-- Top bar -->
      <header class="topbar h-16 flex items-center justify-between px-6 gap-4">
        <!-- Search -->
        <div class="flex-1 max-w-xl">
          <div class="relative">
            <input id="globalSearchInput" type="search" placeholder="Search students, sessions, resources, invoices‚Ä¶"
                   class="w-full rounded-2xl border border-slate-200 px-10 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white/80">
            <span class="absolute left-3 top-1.5">üîç</span>
            <div id="globalSearchResults" class="absolute mt-1 w-full bg-white border border-slate-200 rounded-xl shadow-xl text-xs hidden max-h-64 overflow-y-auto z-20"></div>
          </div>
        </div>

        <!-- Quick actions -->
        <div class="flex items-center gap-2">
          <button id="quickAddStudentBtn" data-owner-only class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700 shadow-sm">
            Ôºã Student
          </button>
          <button id="quickAddSessionBtn" data-owner-only class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-slate-900 text-white text-xs font-medium hover:bg-slate-800 shadow-sm">
            Ôºã Session
          </button>
          <button id="signOutBtn" class="hidden inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl border border-slate-300 text-xs font-medium hover:bg-slate-50">
            ‚èè Sign out
          </button>

          <!-- Theme toggle -->
          <button id="themeToggleBtn" class="ml-2 inline-flex items-center justify-center h-8 w-8 rounded-full border border-slate-300 text-sm">
            üåô
          </button>
        </div>
      </header>
      <div id="readOnlyBanner" class="read-only-banner hidden px-6 py-2 text-xs">
        Read-only mode: sign in as the owner to edit.
      </div>

      <!-- Views container -->
      <main id="viewsContainer" class="flex-1 overflow-y-auto bg-transparent px-8 py-8 space-y-8 max-w-7xl mx-auto w-full">
        <!-- Dashboard -->
        <section id="view-dashboard" class="view">
          <div class="section-shell space-y-6">
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
              <div class="card p-5 col-span-8 space-y-3">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-[10px] uppercase tracking-wide text-slate-500">Weekly direction</p>
                    <h3 class="text-sm font-semibold">Focus & reflection</h3>
                  </div>
                  <span class="hint">Set in Settings</span>
                </div>
                <div id="reflectionText" class="text-sm text-slate-700 leading-relaxed">
                  Add a short note in settings to keep this week intentional.
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                  <div class="border border-slate-200 rounded-lg p-3 bg-white/70">
                    <div class="text-[10px] text-slate-500">Next session</div>
                    <div id="focusNextSession" class="font-semibold">No sessions planned</div>
                    <div id="focusNextSessionMeta" class="text-[10px] text-slate-500"></div>
                  </div>
                  <div class="border border-slate-200 rounded-lg p-3 bg-white/70">
                    <div class="text-[10px] text-slate-500">Homework due soon</div>
                    <div id="focusHomework" class="font-semibold">0</div>
                    <div class="text-[10px] text-slate-500">Due within 5 days</div>
                  </div>
                    <div class="border border-slate-200 rounded-lg p-3 bg-white/70">
                    <div class="text-[10px] text-slate-500">Overdue invoices</div>
                    <div id="focusInvoices" class="font-semibold text-rose-600">0</div>
                    <div class="text-[10px] text-slate-500">Follow up today</div>
                  </div>
                </div>
              </div>
              <div class="card p-5 col-span-4 space-y-4">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold">Goals</h3>
                  <span class="hint">Live progress</span>
                </div>
                <div>
                  <div class="flex items-center justify-between text-[11px] mb-1">
                    <span>Hours this week</span>
                    <span id="goalHoursLabel">0 / 0h</span>
                  </div>
                  <div class="progress-track">
                    <div id="goalHoursProgress" class="progress-thumb" style="width:0%"></div>
                  </div>
                </div>
                <div>
                  <div class="flex items-center justify-between text-[11px] mb-1">
                    <span>Income this month</span>
                    <span id="goalIncomeLabel">R 0 / R 0</span>
                  </div>
                  <div class="progress-track">
                    <div id="goalIncomeProgress" class="progress-thumb" style="width:0%"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
              <div class="card p-5 col-span-1">
                <div class="flex items-center justify-between mb-1">
                  <h3 class="text-xs font-medium text-slate-500">Active students</h3>
                </div>
                <div id="kpiStudents" class="text-2xl font-semibold text-slate-900">0</div>
                <p class="text-[11px] text-slate-500 mt-1">Students with at least one session in the last 30 days.</p>
              </div>
              <div class="card p-5 col-span-1">
                <h3 class="text-xs font-medium text-slate-500 mb-1">Hours this week</h3>
                <div id="kpiHoursWeek" class="text-2xl font-semibold text-slate-900">0</div>
                <p class="text-[11px] text-slate-500 mt-1">Sum of completed sessions.</p>
              </div>
              <div class="card p-5 col-span-1">
                <h3 class="text-xs font-medium text-slate-500 mb-1">Expected income (month)</h3>
                <div id="kpiExpectedIncome" class="text-2xl font-semibold text-slate-900">0</div>
                <p class="text-[11px] text-slate-500 mt-1">From issued & upcoming sessions.</p>
              </div>
              <div class="card p-5 col-span-1">
                <h3 class="text-xs font-medium text-slate-500 mb-1">Overdue invoices</h3>
                <div id="kpiOverdue" class="text-2xl font-semibold text-rose-600">0</div>
                <p class="text-[11px] text-slate-500 mt-1">Count of unpaid invoices past due date.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
              <div class="card p-5 col-span-7">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">Subject mix (hours)</h3>
                </div>
                <canvas id="subjectMixChart" class="w-full h-64"></canvas>
              </div>
              <div class="card p-5 col-span-5">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">Upcoming sessions (next 7 days)</h3>
                </div>
                <ul id="upcomingSessionsList" class="text-xs space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
              <div class="card p-5 col-span-4">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">At-risk students</h3>
                  <span class="hint">No session in 21+ days</span>
                </div>
                <ul id="atRiskList" class="text-xs space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-5 col-span-4">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">Homework due soon</h3>
                  <span class="hint">Next 5 days</span>
                </div>
                <ul id="dueHomeworkList" class="text-xs space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-5 col-span-4">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">Prep queue (next 3)</h3>
                  <span class="hint">Click to open</span>
                </div>
                <ul id="prepQueueList" class="text-xs space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
            </div>
          </div>
        </section>

        <!-- Students -->
        <section id="view-students" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold">Students</h2>
                <p class="text-xs text-slate-500">Manage profiles, 360¬∞ timelines and subject mix.</p>
              </div>
              <button id="addStudentBtn" data-owner-only class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700 shadow-sm">
                Ôºã Add student
              </button>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
              <!-- Student list -->
              <div class="card p-4 col-span-1 max-h-[75vh] overflow-y-auto scrollbar-thin">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">All students</h3>
                </div>
                <div class="flex flex-wrap gap-2 mb-2 text-[11px]">
                  <select id="studentSubjectFilter" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                    <option value="">All subjects</option>
                    <option value="Physics">Physics</option>
                    <option value="Chemistry">Chemistry</option>
                    <option value="Maths">Maths</option>
                  </select>
                  <select id="studentActivityFilter" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                    <option value="">All activity</option>
                    <option value="active">Active (&lt;14 days)</option>
                    <option value="quiet">Quiet (14+ days)</option>
                  </select>
                </div>
                <ul id="studentsList" class="space-y-2 text-xs"></ul>
              </div>

              <!-- Student detail -->
              <div class="card p-4 col-span-2 max-h-[75vh] overflow-y-auto scrollbar-thin">
              <div id="studentDetailEmpty" class="text-xs text-slate-500">
                Select a student on the left to view their 360¬∞ panel.
              </div>
              <div id="studentDetail" class="hidden text-xs space-y-3">
                <div class="flex items-center justify-between">
                  <div>
                    <div id="studentDetailName" class="text-base font-semibold"></div>
                    <div id="studentDetailMeta" class="text-[11px] text-slate-500"></div>
                  </div>
                  <button id="editStudentBtn" data-owner-only class="px-2 py-1 text-[11px] rounded-lg border border-slate-300 hover:bg-slate-50">
                    Edit
                  </button>
                </div>

                <!-- Subject mix bar -->
                <div>
                  <h4 class="text-[11px] font-semibold mb-1">Subject mix (last 30 days)</h4>
                  <div class="w-full h-3 rounded-full bg-slate-100 overflow-hidden flex text-[10px]">
                    <div id="mixPhysics" class="bg-indigo-500 h-full text-center text-white"></div>
                    <div id="mixChemistry" class="bg-emerald-500 h-full text-center text-white"></div>
                    <div id="mixMaths" class="bg-rose-500 h-full text-center text-white"></div>
                  </div>
                  <div class="flex justify-between mt-1 text-[10px] text-slate-500">
                    <span>Physics</span><span>Chemistry</span><span>Maths</span>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                  <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                    <div class="text-[10px] text-slate-500">Hours (last 30 days)</div>
                    <div id="engagementHours" class="text-lg font-semibold">0</div>
                  </div>
                  <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                    <div class="text-[10px] text-slate-500">Streak (weeks)</div>
                    <div id="engagementStreak" class="text-lg font-semibold">0</div>
                    <div class="text-[10px] text-slate-500" id="engagementNextGap"></div>
                  </div>
                  <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                    <div class="text-[10px] text-slate-500">Homework completion</div>
                    <div class="flex items-center justify-between">
                      <div id="engagementHomework" class="text-lg font-semibold">0%</div>
                      <div class="progress-track w-24">
                        <div id="engagementHomeworkProgress" class="progress-thumb" style="width:0%"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                  <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                    <div class="flex items-center justify-between mb-1">
                      <h4 class="text-[11px] font-semibold">Follow-ups</h4>
                      <span class="hint">Personal tasks</span>
                    </div>
                    <ul id="studentTodosList" class="space-y-1 text-[11px]"></ul>
                    <form id="studentTodoForm" class="mt-2 grid grid-cols-3 gap-1 text-[11px]">
                      <input name="todoText" placeholder="Email parent‚Ä¶" class="col-span-2 border border-slate-300 rounded-lg px-2 py-1">
                      <input name="todoDue" type="date" class="border border-slate-300 rounded-lg px-2 py-1">
                      <button class="col-span-3 bg-slate-900 text-white rounded-lg py-1">Add follow-up</button>
                    </form>
                  </div>
                  <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                    <div class="flex items-center justify-between mb-1">
                      <h4 class="text-[11px] font-semibold">Check-ins</h4>
                      <span class="hint">Timestamped notes</span>
                    </div>
                    <ul id="studentCheckinsList" class="space-y-1 text-[11px] max-h-32 overflow-y-auto scrollbar-thin"></ul>
                    <form id="studentCheckinForm" class="mt-2 space-y-1 text-[11px]">
                      <textarea name="checkinText" rows="2" class="w-full border border-slate-300 rounded-lg px-2 py-1" placeholder="Short note..."></textarea>
                      <button class="w-full bg-indigo-600 text-white rounded-lg py-1">Add check-in</button>
                    </form>
                  </div>
                  <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                    <div class="flex items-center justify-between mb-1">
                      <h4 class="text-[11px] font-semibold">Lesson contracts</h4>
                      <button id="uploadContractBtn" class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50">Upload scan</button>
                    </div>
                    <ul id="studentContractsList" class="space-y-1 text-[11px] max-h-32 overflow-y-auto scrollbar-thin"></ul>
                    <p class="hint mt-1">PDF or image stored locally; attach one per agreement.</p>
                  </div>
                </div>

                <!-- Tabs for detail -->
                <div class="border-b border-slate-200 flex gap-4 text-[11px]" id="studentDetailTabs">
                  <button data-student-tab="timeline" class="student-tab border-b-2 border-indigo-500 pb-1 font-medium">
                    Timeline
                  </button>
                  <button data-student-tab="sessions" class="student-tab pb-1 text-slate-500">
                    Sessions
                  </button>
                  <button data-student-tab="documents" class="student-tab pb-1 text-slate-500">
                    Documents
                  </button>
                  <button data-student-tab="finance" class="student-tab pb-1 text-slate-500">
                    Finance
                  </button>
                </div>

                <div id="studentTab-timeline" class="student-tab-pane space-y-2 mt-2">
                  <ul id="studentTimeline" class="space-y-2 text-[11px]"></ul>
                </div>
                <div id="studentTab-sessions" class="student-tab-pane hidden mt-2">
                  <ul id="studentSessionsList" class="space-y-2 text-[11px]"></ul>
                </div>
                <div id="studentTab-documents" class="student-tab-pane hidden mt-2">
                  <div class="flex items-center justify-between mb-1">
                    <h4 class="text-[11px] font-semibold">Documents</h4>
                    <button id="addDocumentForStudentBtn" data-owner-only class="px-2 py-1 rounded-lg border border-slate-300 text-[10px] hover:bg-slate-50">
                      Ôºã Add document
                    </button>
                  </div>
                  <ul id="studentDocumentsList" class="space-y-2 text-[11px]"></ul>
                </div>
                <div id="studentTab-finance" class="student-tab-pane hidden mt-2">
                  <div class="flex items-center justify-between mb-1">
                    <h4 class="text-[11px] font-semibold">Invoices & balance</h4>
                    <button id="studentCreateInvoiceBtn" data-owner-only class="px-2 py-1 rounded-lg border border-emerald-500 text-emerald-600 text-[10px] hover:bg-emerald-50">
                      Ôºã Invoice for this student
                    </button>
                  </div>
                  <div id="studentBalance" class="text-xs mb-1"></div>
                  <ul id="studentInvoicesList" class="space-y-1 text-[11px]"></ul>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Schedule -->
        <section id="view-schedule" class="view hidden">
          <div class="section-shell space-y-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-[10px] uppercase tracking-wide text-slate-500">Planner</p>
                <h2 class="text-lg font-semibold">Schedule</h2>
                <p class="text-xs text-slate-500">Week grid, quick stats, and conflict signals.</p>
              </div>
              <div class="flex items-center gap-2">
                <button id="schedulePrevWeek" class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs hover:bg-slate-50">‚Üê Prev</button>
                <button id="scheduleToday" class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs hover:bg-slate-50">Today</button>
                <button id="scheduleNextWeek" class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs hover:bg-slate-50">Next ‚Üí</button>
                <button id="addSessionBtn" data-owner-only class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium hover:bg-slate-800 shadow-sm">
                  Ôºã Session
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 items-start">
              <!-- Left column: week grid -->
              <div class="card p-5 col-span-2 space-y-3 h-full">
                <div class="flex items-center justify-between text-xs">
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-slate-700"><span class="h-2 w-2 rounded-full bg-indigo-500"></span> Physics</span>
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-slate-700"><span class="h-2 w-2 rounded-full bg-emerald-500"></span> Chemistry</span>
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-slate-700"><span class="h-2 w-2 rounded-full bg-rose-500"></span> Maths</span>
                  </div>
                  <div id="scheduleWeekLabel" class="font-medium text-slate-700"></div>
                </div>
                <div id="dayLoadRow" class="grid grid-cols-7 gap-2 text-[11px]"></div>
                <div class="calendar-grid text-[11px] min-h-[520px]" id="scheduleCalendarGrid">
                  <!-- days injected here -->
                </div>
                <div class="flex items-center justify-between text-[10px] text-slate-500">
                  <span>Click a session chip to open quick actions.</span>
                  <span class="flex items-center gap-2">
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 border border-amber-200">‚ö† Clash</span>
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-sky-50 text-sky-700 border border-sky-200">‚è± Tight gap</span>
                  </span>
                </div>
              </div>

              <!-- Right column: daily + conflict cards -->
              <div class="flex flex-col gap-4 h-full">
                <div class="card p-4 text-xs space-y-2 h-full">
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold">Today</h3>
                    <span class="text-[10px] text-slate-500">Live list</span>
                  </div>
                  <ul id="todaySessionsList" class="space-y-1 max-h-60 overflow-y-auto scrollbar-thin"></ul>
                </div>
                <div class="card p-4 text-xs space-y-2">
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold">Potential clashes</h3>
                    <span class="text-[10px] text-amber-600">Overlap same student</span>
                  </div>
                  <ul id="clashList" class="space-y-1 max-h-32 overflow-y-auto scrollbar-thin text-[11px]"></ul>
                </div>
                <div class="card p-4 text-xs space-y-2">
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold">Tight transitions</h3>
                    <span class="text-[10px] text-slate-500">&lt; 20 min gap</span>
                  </div>
                  <ul id="tightTransitionsList" class="space-y-1 max-h-32 overflow-y-auto scrollbar-thin text-[11px]"></ul>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Resources -->
        <section id="view-resources" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
            <h2 class="text-lg font-semibold">Resources</h2>
            <p class="text-xs text-slate-500">Worksheets, lectures, and homework tracking. Upload files for quick download.</p>
              </div>
              <button id="addResourceBtn" data-owner-only class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700 shadow-sm">
                Ôºã Add resource
              </button>
            </div>

          <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <div class="card p-4 col-span-2 max-h-[75vh] overflow-y-auto scrollbar-thin">
              <div class="flex items-center justify-between mb-2 text-xs">
                <div class="flex gap-2">
                  <select id="resourceSubjectFilter" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                    <option value="">All subjects</option>
                    <option value="Physics">Physics</option>
                    <option value="Chemistry">Chemistry</option>
                    <option value="Maths">Maths</option>
                  </select>
                  <input id="resourceSearchInput" type="text" placeholder="Search resources"
                         class="border border-slate-300 rounded-xl px-2 py-1 text-xs w-40">
                </div>
              </div>
              <div id="resourceTagFilters" class="flex flex-wrap gap-2 mb-3 text-[10px]"></div>
              <ul id="resourcesList" class="space-y-2 text-xs"></ul>
            </div>

            <!-- Homework board -->
            <div class="card p-4 col-span-1 max-h-[75vh] overflow-y-auto scrollbar-thin text-xs">
              <h3 class="text-sm font-semibold mb-2">Homework board</h3>
              <div class="grid grid-cols-3 gap-2 text-[11px]">
                <div>
                  <div class="font-semibold mb-1">To Do</div>
                  <ul id="hwTodo" class="space-y-1"></ul>
                </div>
                <div>
                  <div class="font-semibold mb-1">In progress</div>
                  <ul id="hwInProgress" class="space-y-1"></ul>
                </div>
                <div>
                  <div class="font-semibold mb-1">Completed</div>
                  <ul id="hwDone" class="space-y-1"></ul>
                </div>
              </div>
              <p class="mt-2 text-[10px] text-slate-500">Change status using the dropdown on each card.</p>
            </div>
            </div>
          </div>
        </section>

        <!-- Finance -->
        <section id="view-finance" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold">Finance</h2>
                <p class="text-xs text-slate-500">Invoices, balances & overdue reminders.</p>
              </div>
              <button id="addInvoiceBtn" data-owner-only class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-emerald-600 text-white text-xs font-medium hover:bg-emerald-700 shadow-sm">
                Ôºã Create invoice
              </button>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 text-xs">
              <div class="card p-4 col-span-2 max-h-[75vh] overflow-y-auto scrollbar-thin">
              <h3 class="text-sm font-semibold mb-2">Student balances</h3>
              <table class="w-full text-[11px]">
                <thead>
                <tr class="text-left text-[10px] text-slate-500 border-b border-slate-200">
                  <th class="py-1 pr-1">Student</th>
                  <th class="py-1 pr-1 text-right">Balance</th>
                  <th class="py-1 pr-1 text-right">Unpaid invoices</th>
                </tr>
                </thead>
                <tbody id="financeStudentTable"></tbody>
              </table>
            </div>
            <div class="card p-4 col-span-1 max-h-[75vh] overflow-y-auto scrollbar-thin">
              <h3 class="text-sm font-semibold mb-2">Overdue invoices</h3>
              <ul id="overdueInvoicesList" class="space-y-2 text-[11px]"></ul>
              <p class="mt-2 text-[10px] text-slate-500">Click ‚ÄúReminder text‚Äù to generate a polite message you can paste into email or chat.</p>
            </div>
          </div>

          <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 text-xs mt-4">
            <div class="card p-4 col-span-2">
              <h3 class="text-sm font-semibold mb-2">Unbilled hours</h3>
              <ul id="unbilledList" class="space-y-2 text-[11px]"></ul>
              <p class="mt-2 text-[10px] text-slate-500">Calculated from sessions since the last invoice per student (using their rate).</p>
            </div>
            <div class="card p-4 col-span-1">
              <h3 class="text-sm font-semibold mb-2">Cashflow forecast (14 days)</h3>
              <div id="forecastSummary" class="text-sm font-semibold"></div>
              <ul id="forecastList" class="space-y-1 text-[11px] mt-2"></ul>
            </div>
          </div>
        </section>

        <!-- Settings -->
        <section id="view-settings" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold">Settings</h2>
                <p class="text-xs text-slate-500">Theme, layout & data backup.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="card p-5 text-xs space-y-3">
              <h3 class="text-sm font-semibold mb-1">Appearance</h3>
              <div class="flex items-center justify-between">
                <span>Theme</span>
                <select id="settingsThemeSelect" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                  <option value="light">Light</option>
                  <option value="dark">Dark</option>
                </select>
              </div>
              <div class="flex items-center justify-between">
                <span>Layout density</span>
                <select id="settingsDensitySelect" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                  <option value="comfortable">Comfortable</option>
                  <option value="compact">Compact</option>
                </select>
              </div>
            </div>

            <div class="card p-5 text-xs space-y-3">
              <h3 class="text-sm font-semibold mb-1">Goals & defaults</h3>
              <div class="flex items-center justify-between gap-2">
                <span>Weekly hours goal</span>
                <input id="settingsWeeklyGoal" type="number" step="0.5" class="border border-slate-300 rounded-xl px-2 py-1 text-xs w-24">
              </div>
              <div class="flex items-center justify-between gap-2">
                <span>Monthly income goal (R)</span>
                <input id="settingsMonthlyGoal" type="number" step="100" class="border border-slate-300 rounded-xl px-2 py-1 text-xs w-24">
              </div>
              <div class="flex items-center justify-between gap-2">
                <span>Default session duration (h)</span>
                <input id="settingsDefaultDuration" type="number" step="0.25" class="border border-slate-300 rounded-xl px-2 py-1 text-xs w-24">
              </div>
              <div>
                <label class="block text-[11px] mb-1">Weekly reflection note</label>
                <textarea id="settingsReflection" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]" placeholder="What matters this week?"></textarea>
              </div>
            </div>

            <div class="card p-5 text-xs space-y-3">
              <h3 class="text-sm font-semibold mb-1">Data backup</h3>
              <p>Export your dashboard data as JSON and paste it somewhere safe. You can import it later.</p>
              <div class="flex gap-2">
                <button id="exportDataBtn" class="px-3 py-1.5 rounded-2xl bg-slate-900 text-white text-xs shadow-sm">Export</button>
                <button id="importDataBtn" class="px-3 py-1.5 rounded-2xl border border-slate-300 text-xs">Import</button>
              </div>
              <textarea id="backupTextarea" rows="5" class="mt-2 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]" placeholder="Exported JSON will appear here. Paste JSON here to import."></textarea>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- OVERLAY & MODALS -->

  <div id="modalOverlay" class="overlay">
    <div id="modalContainer" class="card w-full max-w-lg max-h-[90vh] overflow-y-auto p-4 text-xs">
      <!-- modal content injected here -->
    </div>
  </div>

  <!-- AUTH OVERLAY -->
  <div id="authOverlay" class="auth-overlay">
    <div class="card w-full max-w-sm p-5 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold">Sign in</h2>
      </div>
      <p class="text-[11px] text-slate-500">Private access to your dashboard. Sign up once, confirm your email, then sign in.</p>
      <form id="authForm" class="space-y-2">
        <div>
          <label class="block text-[11px] mb-1">Email</label>
          <input type="email" name="email" required class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
        </div>
        <div>
          <label class="block text-[11px] mb-1">Password</label>
          <input type="password" name="password" required class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
        </div>
        <div class="flex gap-2">
          <button type="submit" data-action="signin" class="flex-1 px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium">Sign in</button>
          <button type="submit" data-action="signup" class="flex-1 px-3 py-1.5 rounded-xl border border-slate-300 text-xs">Sign up</button>
        </div>
      </form>
      <div id="authMessage" class="text-[11px] text-rose-600"></div>
    </div>
  </div>

  <script>
    /***********************
     * STATE & PERSISTENCE *
     ***********************/
    const STORAGE_KEY = 'tutoringDashboardState_v1';

    /***********************
     * SUPABASE CONFIG      *
     ***********************/
    const SUPABASE_URL = 'https://wdsqnbebutuhwckjpwqf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indkc3FuYmVidXR1aHdja2pwd3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMDE1NzcsImV4cCI6MjA3OTY3NzU3N30.pJglpTaZouSQFUVCbQONHK1UsB9CgWewKQCIV13NOEM';
    const OWNER_EMAIL = 'erichuang.shangjing@outlook.com';
    // If true, try Supabase Storage uploads; if false, always fall back to local data URL to avoid 400/RLS spam until backend is fixed.
    const ALLOW_STORAGE_UPLOADS = true;
    const supabaseAvailable =
      typeof supabase !== 'undefined' &&
      SUPABASE_URL.startsWith('https://') &&
      !SUPABASE_URL.includes('YOUR_PROJECT') &&
      SUPABASE_ANON_KEY.length > 10 &&
      !SUPABASE_ANON_KEY.includes('YOUR_ANON');
    let supabaseClient = null;
    let supabaseSession = null;
    let readOnlyMode = false;

    // SAFE deep clone helper
    function deepClone(obj) {
      return JSON.parse(JSON.stringify(obj));
    }

    const defaultState = {
      students: [],
      sessions: [],
      resources: [],
      invoices: [],
      documents: [],
      homework: [],
      studentTodos: [],
      studentCheckins: [],
      contracts: [],
      settings: {
        theme: 'light',
        density: 'comfortable',
        weeklyGoalHours: 10,
        monthlyIncomeGoal: 0,
        reflection: '',
        defaultSessionDuration: 1.5
      }
    };

    let state = loadState();

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return deepClone(defaultState);
        const parsed = JSON.parse(raw);
        const merged = Object.assign(deepClone(defaultState), parsed);
        merged.settings = Object.assign(deepClone(defaultState.settings), parsed.settings || {});
        return merged;
      } catch (e) {
        console.error('Failed to load state', e);
        return deepClone(defaultState);
      }
    }

    function cleanId(val) {
      return String(val || '').trim().replace(/['"]/g, '');
    }

    function isUuid(val) {
      const cleaned = cleanId(val);
      return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(cleaned);
    }

    function stripBucketPrefix(path, bucket) {
      if (!path) return '';
      const trimmed = cleanId(path);
      if (trimmed.startsWith(bucket + '/')) {
        return trimmed.slice(bucket.length + 1);
      }
      return trimmed;
    }

    function sanitizeState(st) {
      ['students','sessions','resources','homework','documents','contracts','invoices','studentTodos','studentCheckins'].forEach(key => {
        if (!Array.isArray(st[key])) st[key] = [];
      });
      st.students.forEach(s => { s.id = cleanId(s.id); s.studentEmail = (s.studentEmail || s.student_email || '').trim().toLowerCase(); });
      st.sessions.forEach(s => {
        s.id = cleanId(s.id);
        s.studentIds = (s.studentIds || []).map(cleanId);
      });
      st.resources.forEach(r => {
        r.id = cleanId(r.id);
        r.storage_path = stripBucketPrefix(r.storage_path, 'resources');
        r.fileName = r.fileName || r.file_name || '';
      });
      st.homework.forEach(h => { h.id = cleanId(h.id); h.studentId = cleanId(h.studentId); h.resourceId = cleanId(h.resourceId); });
      st.documents.forEach(d => { d.id = cleanId(d.id); d.studentId = cleanId(d.studentId); });
      st.contracts.forEach(c => {
        c.id = cleanId(c.id);
        c.studentId = cleanId(c.studentId);
        c.storage_path = stripBucketPrefix(c.storage_path, 'contracts');
      });
      st.invoices.forEach(i => { i.id = cleanId(i.id); i.studentId = cleanId(i.studentId); });
      st.studentTodos.forEach(t => { t.id = cleanId(t.id); t.studentId = cleanId(t.studentId); });
      st.studentCheckins.forEach(c => { c.id = cleanId(c.id); c.studentId = cleanId(c.studentId); });
    }

    function forceUuid(val) {
      const cleaned = cleanId(val);
      return isUuid(cleaned) ? cleaned : (crypto?.randomUUID ? crypto.randomUUID() : cleaned);
    }

    function enforceUuidFields() {
      state.students.forEach(s => { s.id = forceUuid(s.id); });
      state.sessions.forEach(sess => { sess.id = forceUuid(sess.id); sess.studentIds = (sess.studentIds || []).map(forceUuid); });
      state.resources.forEach(r => { r.id = forceUuid(r.id); });
      state.homework.forEach(hw => { hw.id = forceUuid(hw.id); hw.studentId = forceUuid(hw.studentId); hw.resourceId = forceUuid(hw.resourceId); });
      state.documents.forEach(d => { d.id = forceUuid(d.id); d.studentId = forceUuid(d.studentId); });
      state.contracts.forEach(c => { c.id = forceUuid(c.id); c.studentId = forceUuid(c.studentId); });
      state.invoices.forEach(inv => { inv.id = forceUuid(inv.id); inv.studentId = forceUuid(inv.studentId); });
      state.studentTodos.forEach(t => { t.id = forceUuid(t.id); t.studentId = forceUuid(t.studentId); });
      state.studentCheckins.forEach(c => { c.id = forceUuid(c.id); c.studentId = forceUuid(c.studentId); });
    }

    function normalizeIdsToUuid() {
      sanitizeState(state);
      const maps = {
        students: new Map(),
        sessions: new Map(),
        resources: new Map(),
        homework: new Map(),
        documents: new Map(),
        contracts: new Map(),
        studentTodos: new Map(),
        studentCheckins: new Map()
      };
      function ensureId(entity, key, map) {
        entity.id = cleanId(entity.id);
        if (isUuid(entity.id)) return entity.id;
        const existing = map.get(entity.id);
        if (existing) {
          entity.id = existing;
          return existing;
        }
        const newId = crypto.randomUUID();
        map.set(entity.id, newId);
        entity.id = newId;
        return newId;
      }
      state.students.forEach(s => ensureId(s, 'students', maps.students));
      state.sessions.forEach(sess => ensureId(sess, 'sessions', maps.sessions));
      state.resources.forEach(r => ensureId(r, 'resources', maps.resources));
      state.homework.forEach(hw => ensureId(hw, 'homework', maps.homework));
      state.documents.forEach(d => ensureId(d, 'documents', maps.documents));
      state.contracts.forEach(c => ensureId(c, 'contracts', maps.contracts));
      state.studentTodos.forEach(t => ensureId(t, 'studentTodos', maps.studentTodos));
      state.studentCheckins.forEach(c => ensureId(c, 'studentCheckins', maps.studentCheckins));

      // remap references
      state.sessions.forEach(sess => {
        const seen = new Set();
        sess.studentIds = (sess.studentIds || [])
          .map(id => {
            const cleaned = cleanId(id);
            return maps.students.get(cleaned) || cleaned;
          })
          .filter(id => {
            if (!id) return false;
            if (seen.has(id)) return false;
            seen.add(id);
            return true;
          });
      });
      state.homework.forEach(hw => {
        const sid = cleanId(hw.studentId);
        const rid = cleanId(hw.resourceId);
        hw.studentId = maps.students.get(sid) || sid;
        hw.resourceId = maps.resources.get(rid) || rid;
      });
      state.documents.forEach(d => {
        const sid = cleanId(d.studentId);
        d.studentId = maps.students.get(sid) || sid;
      });
      state.contracts.forEach(c => {
        const sid = cleanId(c.studentId);
        c.studentId = maps.students.get(sid) || sid;
      });
      state.invoices.forEach(inv => {
        const sid = cleanId(inv.studentId);
        inv.studentId = maps.students.get(sid) || sid;
      });
      state.studentTodos.forEach(t => {
        const sid = cleanId(t.studentId);
        t.studentId = maps.students.get(sid) || sid;
      });
      state.studentCheckins.forEach(c => {
        const sid = cleanId(c.studentId);
        c.studentId = maps.students.get(sid) || sid;
      });
    }

    function saveState() {
      if (readOnlyMode) {
        console.warn('Read-only mode: changes are not saved.');
        return;
      }
      normalizeIdsToUuid();
      enforceUuidFields();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      updateKPIsAndCharts();
      if (isSupabaseReady()) {
        syncStateToSupabase().catch(err => console.error('Supabase sync failed', err));
      }
    }

    function isSupabaseReady() {
      return !!(supabaseClient && supabaseSession);
    }

    async function syncStateToSupabase() {
      if (readOnlyMode) return;
      normalizeIdsToUuid();
      enforceUuidFields();
      const uid = supabaseSession?.user?.id;
      if (!uid) return;

      // prepare rows with user_id
      const students = state.students.map(s => ({
        id: cleanId(s.id),
        user_id: uid,
        name: s.name,
        grade_level: s.gradeLevel,
        rate: s.rate,
        subjects: s.subjects,
        notes: s.notes,
        student_email: (s.studentEmail || '').trim(),
        created_at: s.createdAt
      }));
      await upsertAndPrune('students', students, 'id');

      const sessionsClean = state.sessions
        .map(sess => ({
          ...sess,
          studentIds: (sess.studentIds || []).map(cleanId).filter(Boolean)
        }))
        .filter(sess => sess.date && sess.studentIds.length > 0);

      const sessions = sessionsClean.map(sess => ({
        id: cleanId(sess.id),
        user_id: uid,
        date: sess.date,
        start_time: sess.startTime,
        duration_hours: sess.durationHours,
        subject: sess.subject,
        topic: sess.topic,
        notes: sess.notes,
        completed: sess.completed
      }));
      await upsertAndPrune('sessions', sessions, 'id');

      const sessionStudents = [];
      const pairSeen = new Set();
      sessionsClean.forEach(sess => {
        const sId = cleanId(sess.id);
        if (!sId) return;
        (sess.studentIds || []).forEach(stuId => {
          const stuClean = cleanId(stuId);
          if (!stuClean) return;
          const key = `${sId}|${stuClean}`;
          if (pairSeen.has(key)) return;
          pairSeen.add(key);
          sessionStudents.push({
            session_id: sId,
            student_id: stuClean,
            user_id: uid
          });
        });
      });
      if (sessionStudents.length) {
        const { error } = await supabaseClient
          .from('session_students')
          .upsert(sessionStudents, { onConflict: 'session_id,student_id', ignoreDuplicates: true });
        if (error) console.error('session_students insert failed', error);
      }

      const resources = state.resources.map(r => ({
        id: cleanId(r.id),
        user_id: uid,
        title: r.title,
        subject: r.subject,
        level: r.level,
        tags: r.tags,
        description: r.description,
        created_at: r.createdAt,
        favorite: r.favorite,
        storage_path: r.storage_path,
        file_name: r.fileName
      }));
      try {
        await upsertAndPrune('resources', resources, 'id');
      } catch (err) {
        console.error('Resources upsert failed (check RLS on table "resources")', err);
      }

      const homework = state.homework.map(h => ({
        id: cleanId(h.id),
        user_id: uid,
        student_id: cleanId(h.studentId),
        resource_id: cleanId(h.resourceId),
        status: h.status,
        due_date: h.dueDate,
        assigned_date: h.assignedDate
      }));
      await upsertAndPrune('homework', homework, 'id');

      const documents = state.documents.map(d => ({
        id: cleanId(d.id),
        user_id: uid,
        student_id: cleanId(d.studentId),
        title: d.title,
        status: d.status,
        date: d.date,
        notes: d.notes,
        created_at: d.createdAt
      }));
      await upsertAndPrune('documents', documents, 'id');

      const contracts = state.contracts.map(c => ({
        id: cleanId(c.id),
        user_id: uid,
        student_id: cleanId(c.studentId),
        file_name: c.fileName,
        storage_path: c.storage_path,
        status: c.status,
        notes: c.notes,
        uploaded_at: c.uploadedAt
      }));
      await upsertAndPrune('contracts', contracts, 'id');

      const invoices = state.invoices.map(inv => ({
        id: cleanId(inv.id),
        user_id: uid,
        student_id: cleanId(inv.studentId),
        issue_date: inv.issueDate,
        due_date: inv.dueDate,
        base_amount: inv.baseAmount,
        total: inv.total,
        late_fee_percent: inv.lateFeePercent,
        short_notice_percent: inv.shortNoticePercent,
        late_applied: inv.lateApplied,
        short_applied: inv.shortApplied,
        paid: inv.paid,
        notes: inv.notes
      }));
      await upsertAndPrune('invoices', invoices, 'id');

      const todos = state.studentTodos.map(t => ({
        id: cleanId(t.id),
        user_id: uid,
        student_id: cleanId(t.studentId),
        text: t.text,
        due_date: t.dueDate,
        done: t.done,
        created_at: t.createdAt
      }));
      await upsertAndPrune('student_todos', todos, 'id');

      const checkins = state.studentCheckins.map(c => ({
        id: cleanId(c.id),
        user_id: uid,
        student_id: cleanId(c.studentId),
        text: c.text,
        date: c.date,
        created_at: c.createdAt
      }));
      await upsertAndPrune('student_checkins', checkins, 'id');
    }

    async function upsertAndPrune(table, rows, pk) {
      if (!supabaseClient) return;
      const uid = supabaseSession?.user?.id;
      if (!uid) return;
      // Upsert rows
      if (rows.length) {
        const { error } = await supabaseClient.from(table).upsert(rows);
        if (error) throw error;
      }
      // Prune skipped to avoid accidental deletions; Supabase is source of truth.
    }

    function generateId(prefix) {
      return prefix + '_' + Math.random().toString(36).slice(2, 10);
    }

    /****************
     * INITIAL SETUP *
     ****************/
    // Catch any unhandled promise rejections so Safari doesn‚Äôt throw ‚Äúoutput‚Äù ReferenceErrors
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection', event.reason);
      event.preventDefault();
      return true;
    });
    window.onunhandledrejection = (event) => {
      console.error('Unhandled promise rejection (onunhandledrejection)', event.reason);
      if (event.preventDefault) event.preventDefault();
      return true;
    };

    document.addEventListener('DOMContentLoaded', async () => {
      await initSupabaseAuth();
      setupNav();
      setupTopbar();
      applySettingsToUI();
      if (!supabaseAvailable || supabaseSession) {
        await tryLoadRemoteThenLocal();
        renderAllViews();
      }
      updateReadOnlyUI();

      // expose functions for inline onclick handlers
      window.openSessionModal = openSessionModal;
      window.getSessionById = getSessionById;
      window.openSessionQuickActions = openSessionQuickActions;
      window.openResourceModal = openResourceModal;
      window.getResourceById = getResourceById;
      window.openAssignResourceModal = openAssignResourceModal;
      window.updateHomeworkStatus = updateHomeworkStatus;
      window.openDocumentModal = openDocumentModal;
      window.getDocumentById = getDocumentById;
      window.openInvoiceModal = openInvoiceModal;
      window.getInvoiceById = getInvoiceById;
      window.markInvoicePaid = markInvoicePaid;
      window.generateReminder = generateReminder;
      window.selectStudent = selectStudent;
      window.toggleResourceFavorite = toggleResourceFavorite;
      window.toggleTodoStatus = toggleTodoStatus;
      window.deleteTodo = deleteTodo;
      window.openContractUpload = openContractUpload;
      window.markContractStatus = markContractStatus;
    });

    function setupNav() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          switchView(view);
          document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-slate-800', 'active'));
          btn.classList.add('bg-slate-800', 'active');
        });
      });
      // default view
      switchView('dashboard');
      const dashBtn = document.querySelector('.nav-btn[data-view="dashboard"]');
      if (dashBtn) dashBtn.classList.add('bg-slate-800', 'active');
    }

    function switchView(viewName) {
      document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
      // block switching if Supabase is configured but not signed in
      if (supabaseAvailable && !supabaseSession) {
        toggleAuthOverlay(true);
        return;
      }
      document.getElementById('view-' + viewName).classList.remove('hidden');
      if (viewName === 'dashboard') updateKPIsAndCharts();
      if (viewName === 'students') renderStudentsView();
      if (viewName === 'schedule') renderScheduleView();
      if (viewName === 'resources') renderResourcesView();
      if (viewName === 'finance') renderFinanceView();
      if (viewName === 'settings') applySettingsToUI();
    }

    function setupTopbar() {
      document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);
      document.getElementById('quickAddStudentBtn').addEventListener('click', () => { if (guardEdit()) openStudentModal(); });
      document.getElementById('quickAddSessionBtn').addEventListener('click', () => { if (guardEdit()) openSessionModal(); });
      document.getElementById('globalSearchInput').addEventListener('input', handleGlobalSearch);
      const signOutBtn = document.getElementById('signOutBtn');
      if (signOutBtn) {
        signOutBtn.onclick = async () => {
          if (supabaseClient) {
            await supabaseClient.auth.signOut();
          }
          supabaseSession = null;
          toggleAuthOverlay(true);
        };
      }

      // Settings bindings
      document.getElementById('settingsThemeSelect').addEventListener('change', e => {
        state.settings.theme = e.target.value;
        applyTheme();
        saveState();
      });
      document.getElementById('settingsDensitySelect').addEventListener('change', e => {
        state.settings.density = e.target.value;
        applyDensity();
        saveState();
      });
      document.getElementById('settingsWeeklyGoal').addEventListener('input', e => {
        state.settings.weeklyGoalHours = Number(e.target.value || 0);
        saveState();
      });
      document.getElementById('settingsMonthlyGoal').addEventListener('input', e => {
        state.settings.monthlyIncomeGoal = Number(e.target.value || 0);
        saveState();
      });
      document.getElementById('settingsReflection').addEventListener('input', e => {
        state.settings.reflection = e.target.value;
        saveState();
      });
      document.getElementById('settingsDefaultDuration').addEventListener('input', e => {
        state.settings.defaultSessionDuration = Number(e.target.value || 1);
        saveState();
      });
      document.getElementById('exportDataBtn').addEventListener('click', () => {
        document.getElementById('backupTextarea').value = JSON.stringify(state, null, 2);
      });
      document.getElementById('importDataBtn').addEventListener('click', () => {
        const txt = document.getElementById('backupTextarea').value.trim();
        if (!txt) return alert('Paste JSON first.');
        try {
          const imported = JSON.parse(txt);
          state = Object.assign(deepClone(defaultState), imported);
          saveState();
          renderAllViews();
          applySettingsToUI();
          alert('Data imported.');
        } catch (e) {
          alert('Invalid JSON.');
        }
      });

      document.getElementById('addStudentBtn').addEventListener('click', () => { if (guardEdit()) openStudentModal(); });
      document.getElementById('addSessionBtn').addEventListener('click', () => { if (guardEdit()) openSessionModal(); });
      document.getElementById('addResourceBtn').addEventListener('click', () => { if (guardEdit()) openResourceModal(); });
      document.getElementById('addInvoiceBtn').addEventListener('click', () => { if (guardEdit()) openInvoiceModal(); });
    }

    function applySettingsToUI() {
      document.getElementById('settingsThemeSelect').value = state.settings.theme;
      document.getElementById('settingsDensitySelect').value = state.settings.density;
      document.getElementById('settingsWeeklyGoal').value = state.settings.weeklyGoalHours ?? '';
      document.getElementById('settingsMonthlyGoal').value = state.settings.monthlyIncomeGoal ?? '';
      document.getElementById('settingsReflection').value = state.settings.reflection || '';
      document.getElementById('settingsDefaultDuration').value = state.settings.defaultSessionDuration ?? 1.5;
      applyTheme();
      applyDensity();
    }

    /***********************
     * SUPABASE AUTH
     ***********************/
    async function initSupabaseAuth() {
      if (!supabaseAvailable) {
        toggleAuthOverlay(false);
        return;
      }
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const { data: sessionData } = await supabaseClient.auth.getSession();
      supabaseSession = sessionData.session;
      toggleAuthOverlay(!supabaseSession);
      if (supabaseSession) {
        document.getElementById('signOutBtn')?.classList.remove('hidden');
      }
      updateReadOnlyUI();
      supabaseClient.auth.onAuthStateChange((event, session) => {
        supabaseSession = session;
        toggleAuthOverlay(!session);
        if (session) {
          document.getElementById('signOutBtn')?.classList.remove('hidden');
          tryLoadRemoteThenLocal().then(renderAllViews);
        } else {
          document.getElementById('signOutBtn')?.classList.add('hidden');
          state = deepClone(defaultState);
        }
        updateReadOnlyUI();
      });

      const authForm = document.getElementById('authForm');
      const authMsg = document.getElementById('authMessage');
      if (authForm) {
        authForm.onsubmit = async (e) => {
          e.preventDefault();
          const action = e.submitter?.dataset?.action || 'signin';
          const email = authForm.email.value.trim();
          const password = authForm.password.value.trim();
          authMsg.textContent = '';
          try {
            if (action === 'signup') {
              const { error } = await supabaseClient.auth.signUp({ email, password });
              if (error) throw error;
              authMsg.textContent = 'Check your email to confirm, then sign in.';
            } else {
              const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
              if (error) throw error;
            }
          } catch (err) {
            authMsg.textContent = err.message || 'Auth error';
          }
        };
      }
    }

    function toggleAuthOverlay(show) {
      const overlay = document.getElementById('authOverlay');
      if (!overlay) return;
      const mustShow = supabaseAvailable ? show : show;
      overlay.classList.toggle('show', !!mustShow);
      if (mustShow) {
        document.body.classList.add('overflow-hidden');
      } else {
        document.body.classList.remove('overflow-hidden');
      }
    }

    function isOwner() {
      if (!supabaseAvailable) return true;
      return !!(supabaseSession && supabaseSession.user?.email === OWNER_EMAIL);
    }

    function updateReadOnlyUI() {
      if (supabaseAvailable && !supabaseSession) {
        // Session not resolved yet; keep UI as-is
        return;
      }
      readOnlyMode = supabaseAvailable ? !isOwner() : false;
      const banner = document.getElementById('readOnlyBanner');
      if (banner) banner.classList.toggle('hidden', !readOnlyMode);
      const main = document.querySelector('main#viewsContainer');
      if (main) main.classList.toggle('opacity-70', readOnlyMode);
      document.querySelectorAll('[data-owner-only]').forEach(el => {
        if (el.tagName === 'BUTTON' || el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.disabled = readOnlyMode;
        }
        el.classList.toggle('owner-locked', readOnlyMode);
      });
    }

    function guardEdit() {
      if (readOnlyMode) {
        alert('Read-only mode: sign in as the owner to edit.');
        return false;
      }
      return true;
    }

    async function tryLoadRemoteThenLocal() {
      if (supabaseAvailable && !supabaseSession) {
        // hold current/local state until session resolved
        state = loadState();
        return;
      }
      if (isSupabaseReady()) {
        try {
          state = await loadStateFromSupabase();
          if (!readOnlyMode) saveState(); // persist locally as cache
          return;
        } catch (e) {
          console.error('Failed to load from Supabase, falling back to local', e);
        }
      }
      state = supabaseAvailable ? deepClone(defaultState) : loadState();
    }

    async function loadStateFromSupabase() {
      const uid = supabaseSession?.user?.id;
      if (!uid) return supabaseAvailable ? deepClone(defaultState) : loadState();
      const isOwnerUser = isOwner();

      const fetchTable = (table, cols = '*') => {
        // rely on RLS; do not add extra filters that might drop older rows
        return supabaseClient.from(table).select(cols);
      };

      const [
        studentsRes,
        sessionsRes,
        sessionStudentsRes,
        resourcesRes,
        homeworkRes,
        documentsRes,
        contractsRes,
        invoicesRes,
        todosRes,
        checkinsRes
      ] = await Promise.all([
        fetchTable('students'),
        fetchTable('sessions'),
        fetchTable('session_students'),
        fetchTable('resources'),
        fetchTable('homework'),
        fetchTable('documents'),
        fetchTable('contracts'),
        fetchTable('invoices'),
        fetchTable('student_todos'),
        fetchTable('student_checkins')
      ]);

      [studentsRes, sessionsRes, sessionStudentsRes, resourcesRes, homeworkRes, documentsRes, contractsRes, invoicesRes, todosRes, checkinsRes].forEach(res => {
        if (res.error) throw res.error;
      });

      const sessions = (sessionsRes.data || []).map(sess => {
        const studentIds = (sessionStudentsRes.data || [])
          .filter(ss => ss.session_id === sess.id)
          .map(ss => cleanId(ss.student_id))
          .filter(Boolean);
        return {
          id: sess.id,
          date: sess.date,
          startTime: sess.start_time,
          durationHours: sess.duration_hours,
          subject: sess.subject,
          topic: sess.topic,
          notes: sess.notes,
          completed: sess.completed,
          studentIds
        };
      });
      const sessionsWithStudents = sessions.filter(s => (s.studentIds || []).length > 0);

      // Fetch signed URLs for contracts if storage_path exists (ignore missing/forbidden)
      const contracts = await Promise.all(
        (contractsRes.data || []).map(async c => {
          try {
            if (c.storage_path && supabaseClient.storage) {
              const { data, error } = await supabaseClient.storage.from('contracts').createSignedUrl(c.storage_path, 60 * 60 * 24);
              if (!error && data?.signedUrl) {
                return {
                  id: c.id,
                  studentId: c.student_id,
                  fileName: c.file_name,
                  storage_path: c.storage_path,
                  status: c.status,
                  notes: c.notes,
                  uploadedAt: c.uploaded_at,
                  signedUrl: data.signedUrl
                };
              }
            }
          } catch (err) {
            console.warn('Contract signed URL fetch failed', err);
          }
          return {
            id: c.id,
            studentId: c.student_id,
            fileName: c.file_name,
            storage_path: c.storage_path,
            status: c.status,
            notes: c.notes,
            uploadedAt: c.uploaded_at
          };
        })
      );

      const merged = deepClone(defaultState);
      merged.students = (studentsRes.data || []).map(s => ({
        id: s.id,
        name: s.name,
        gradeLevel: s.grade_level ?? s.gradeLevel,
        rate: s.rate,
        subjects: s.subjects,
        notes: s.notes,
        studentEmail: s.student_email || '',
        createdAt: s.created_at
      }));
      merged.sessions = sessionsWithStudents;
      const resources = await Promise.all(
        (resourcesRes.data || []).map(async r => {
          let signedUrl = '';
          try {
            if (r.storage_path && supabaseClient.storage) {
              const { data, error } = await supabaseClient.storage.from('resources').createSignedUrl(r.storage_path, 60 * 60 * 24);
              if (!error && data?.signedUrl) signedUrl = data.signedUrl;
            }
          } catch (err) {
            console.warn('Resource signed URL fetch failed', err);
          }
          return {
            id: r.id,
            title: r.title,
            subject: r.subject,
            level: r.level,
            tags: r.tags,
            description: r.description,
            createdAt: r.created_at,
            favorite: r.favorite,
            storage_path: r.storage_path,
            fileName: r.file_name,
            signedUrl
          };
        })
      );
      merged.resources = resources;
      merged.homework = (homeworkRes.data || []).map(h => ({
        id: h.id,
        studentId: h.student_id,
        resourceId: h.resource_id,
        status: h.status,
        dueDate: h.due_date,
        assignedDate: h.assigned_date
      }));
      merged.documents = (documentsRes.data || []).map(d => ({
        id: d.id,
        studentId: d.student_id,
        title: d.title,
        status: d.status,
        date: d.date,
        notes: d.notes,
        createdAt: d.created_at
      }));
      merged.contracts = contracts;
      merged.invoices = (invoicesRes.data || []).map(inv => ({
        id: inv.id,
        studentId: inv.student_id,
        issueDate: inv.issue_date,
        dueDate: inv.due_date,
        baseAmount: inv.base_amount,
        total: inv.total,
        lateFeePercent: inv.late_fee_percent,
        shortNoticePercent: inv.short_notice_percent,
        lateApplied: inv.late_applied,
        shortApplied: inv.short_applied,
        paid: inv.paid,
        notes: inv.notes
      }));
      merged.studentTodos = (todosRes.data || []).map(t => ({
        id: t.id,
        studentId: t.student_id,
        text: t.text,
        dueDate: t.due_date,
        done: t.done,
        createdAt: t.created_at
      }));
      merged.studentCheckins = (checkinsRes.data || []).map(c => ({
        id: c.id,
        studentId: c.student_id,
        text: c.text,
        date: c.date,
        createdAt: c.created_at
      }));
      merged.settings = loadState().settings; // keep local settings
      sanitizeState(merged);
      normalizeIdsToUuid();
      return merged;
    }

    function applyTheme() {
      const isDark = state.settings.theme === 'dark';
      document.body.classList.toggle('dark', isDark);
      const btn = document.getElementById('themeToggleBtn');
      btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    function toggleTheme() {
      state.settings.theme = state.settings.theme === 'dark' ? 'light' : 'dark';
      applyTheme();
      saveState();
    }

    function applyDensity() {
      const compact = state.settings.density === 'compact';
      const container = document.getElementById('viewsContainer');
      container.classList.toggle('py-8', !compact);
      container.classList.toggle('py-5', compact);
      container.classList.toggle('dense-mode', compact);
    }

    function renderAllViews() {
      updateKPIsAndCharts();
      renderStudentsView();
      renderScheduleView();
      renderResourcesView();
      renderFinanceView();
    }

    /******************
     * GLOBAL SEARCH  *
     ******************/
    function handleGlobalSearch(e) {
      const query = e.target.value.trim().toLowerCase();
      const resultsBox = document.getElementById('globalSearchResults');
      if (!query) {
        resultsBox.innerHTML = '';
        resultsBox.classList.add('hidden');
        return;
      }

      const results = [];

      // Students
      state.students.forEach(s => {
        if (s.name.toLowerCase().includes(query) || (s.notes || '').toLowerCase().includes(query)) {
          results.push({ type: 'Student', label: s.name, id: s.id });
        }
      });

      // Resources
      state.resources.forEach(r => {
        if (r.title.toLowerCase().includes(query) || (r.tags || []).some(t => t.toLowerCase().includes(query))) {
          results.push({ type: 'Resource', label: r.title + ' (' + r.subject + ')', id: r.id });
        }
      });

      // Sessions
      state.sessions.forEach(sess => {
        const studentNames = sess.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
        const text = (sess.topic || '') + ' ' + studentNames;
        if (text.toLowerCase().includes(query)) {
          results.push({ type: 'Session', label: studentNames + ' ‚Äì ' + (sess.topic || 'Session'), id: sess.id });
        }
      });

      // Invoices
      state.invoices.forEach(inv => {
        const s = getStudentById(inv.studentId);
        const label = (s?.name || 'Unknown') + ' ‚Äì ' + inv.id;
        if (label.toLowerCase().includes(query)) {
          results.push({ type: 'Invoice', label, id: inv.id });
        }
      });

      if (!results.length) {
        resultsBox.innerHTML = '<div class="px-3 py-2 text-slate-500">No results</div>';
        resultsBox.classList.remove('hidden');
        return;
      }

      resultsBox.innerHTML = results.map(r => `
        <div class="px-3 py-1.5 hover:bg-slate-50 cursor-pointer" data-type="${r.type}" data-id="${r.id}">
          <span class="text-[10px] uppercase text-slate-400">${r.type}</span>
          <div class="text-xs">${r.label}</div>
        </div>
      `).join('');
      resultsBox.classList.remove('hidden');

      resultsBox.querySelectorAll('[data-type]').forEach(el => {
        el.addEventListener('click', () => {
          const type = el.dataset.type;
          const id = el.dataset.id;
          if (type === 'Student') {
            switchView('students');
            selectStudent(id);
          } else if (type === 'Resource') {
            switchView('resources');
          } else if (type === 'Session') {
            switchView('schedule');
          } else if (type === 'Invoice') {
            switchView('finance');
          }
          resultsBox.classList.add('hidden');
        });
      });
    }

    /***************
     * DASHBOARD   *
     ***************/
    let subjectMixChart;

    function updateKPIsAndCharts() {
      const now = new Date();
      const cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      const today = new Date();

      const activeStudentIds = new Set(
        state.sessions
          .filter(s => new Date(s.date) >= cutoff)
          .flatMap(s => s.studentIds)
      );
      document.getElementById('kpiStudents').textContent = activeStudentIds.size;

      const startOfWeek = getMonday(now);
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(endOfWeek.getDate() + 7);

      let hoursThisWeek = 0;
      state.sessions.forEach(s => {
        const d = new Date(s.date);
        if (d >= startOfWeek && d < endOfWeek) {
          hoursThisWeek += Number(s.durationHours || 0);
        }
      });
      document.getElementById('kpiHoursWeek').textContent = hoursThisWeek.toFixed(1);

      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      let expected = 0;
      state.invoices.forEach(inv => {
        const d = new Date(inv.issueDate);
        if (d >= startOfMonth && d < endOfMonth) {
          expected += Number(inv.total || 0);
        }
      });
      document.getElementById('kpiExpectedIncome').textContent = 'R ' + expected.toFixed(2);

      const overdueCount = state.invoices.filter(inv => !inv.paid && inv.dueDate && new Date(inv.dueDate) < today).length;
      document.getElementById('kpiOverdue').textContent = overdueCount;

      // Goals & focus
      const weeklyGoal = Number(state.settings.weeklyGoalHours || 0);
      const weeklyPct = weeklyGoal ? Math.min(100, (hoursThisWeek / weeklyGoal) * 100) : 0;
      document.getElementById('goalHoursLabel').textContent = `${hoursThisWeek.toFixed(1)} / ${weeklyGoal || 0}h`;
      document.getElementById('goalHoursProgress').style.width = `${weeklyPct}%`;

      const monthlyGoal = Number(state.settings.monthlyIncomeGoal || 0);
      const monthlyPct = monthlyGoal ? Math.min(100, (expected / monthlyGoal) * 100) : 0;
      document.getElementById('goalIncomeLabel').textContent = `R ${expected.toFixed(0)} / R ${monthlyGoal || 0}`;
      document.getElementById('goalIncomeProgress').style.width = `${monthlyPct}%`;

      const reflection = (state.settings.reflection || '').trim();
      document.getElementById('reflectionText').textContent = reflection || 'Add a short intention in Settings to keep this week focused.';

      const upcomingSoon = [...state.sessions]
        .filter(s => new Date(s.date + 'T' + (s.startTime || '00:00')) >= now)
        .sort((a, b) => new Date(a.date + 'T' + (a.startTime || '00:00')) - new Date(b.date + 'T' + (b.startTime || '00:00')));
      if (upcomingSoon.length) {
        const next = upcomingSoon[0];
        const names = next.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
        document.getElementById('focusNextSession').textContent = names;
        document.getElementById('focusNextSessionMeta').textContent = `${next.subject} ‚Ä¢ ${next.date} ${next.startTime || ''}`;
      } else {
        document.getElementById('focusNextSession').textContent = 'No sessions planned';
        document.getElementById('focusNextSessionMeta').textContent = '';
      }

      const homeworkDueSoon = state.homework.filter(hw => {
        if (hw.status === 'Completed') return false;
        if (!hw.dueDate) return false;
        const due = new Date(hw.dueDate);
        const fiveDays = new Date(now.getTime() + 5 * 24 * 60 * 60 * 1000);
        return due >= today && due <= fiveDays;
      });
      document.getElementById('focusHomework').textContent = homeworkDueSoon.length;
      document.getElementById('focusInvoices').textContent = overdueCount;

      const hours = { Physics: 0, Chemistry: 0, Maths: 0 };
      state.sessions.forEach(s => {
        if (hours[s.subject] != null) {
          hours[s.subject] += Number(s.durationHours || 0);
        }
      });

      const ctx = document.getElementById('subjectMixChart').getContext('2d');
      if (subjectMixChart) subjectMixChart.destroy();
      subjectMixChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Physics', 'Chemistry', 'Maths'],
          datasets: [{
            label: 'Hours taught',
            data: [hours.Physics, hours.Chemistry, hours.Maths],
            backgroundColor: ['#4f46e5', '#16a34a', '#dc2626'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });

      const upcomingList = document.getElementById('upcomingSessionsList');
      const sevenDays = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
      const upcoming = state.sessions
        .filter(s => {
          const d = new Date(s.date + 'T' + (s.startTime || '00:00'));
          return d >= now && d <= sevenDays;
        })
        .sort((a, b) => new Date(a.date + 'T' + (a.startTime || '00:00')) - new Date(b.date + 'T' + (b.startTime || '00:00')))
        .slice(0, 10);

      if (!upcoming.length) {
        upcomingList.innerHTML = '<li class="text-slate-500">No upcoming sessions in the next 7 days.</li>';
      } else {
        upcomingList.innerHTML = upcoming.map(s => {
          const names = s.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
          return `<li class="border border-slate-200 bg-white/80 rounded-lg px-2 py-1">
              <div class="font-medium">${names}</div>
              <div class="text-[10px] text-slate-500">${s.subject} ‚Ä¢ ${s.date} ‚Ä¢ ${s.startTime || ''} (${s.durationHours || 1}h)</div>
              <div class="text-[10px]">${s.topic || ''}</div>
            </li>`;
        }).join('');
      }

      const atRiskList = document.getElementById('atRiskList');
      const atRisk = state.students
        .map(s => {
          const last = getLastSessionDate(s.id);
          const daysSince = last ? Math.floor((now - last) / (1000 * 60 * 60 * 24)) : 999;
          return { student: s, daysSince };
        })
        .filter(item => item.daysSince >= 21)
        .sort((a, b) => b.daysSince - a.daysSince)
        .slice(0, 6);
      if (!atRisk.length) {
        atRiskList.innerHTML = '<li class="text-slate-500">All students taught in the last 21 days.</li>';
      } else {
        atRiskList.innerHTML = atRisk.map(item => `
          <li class="border border-amber-200 bg-amber-50 rounded-lg px-2 py-1">
            <div class="font-medium">${item.student.name}</div>
            <div class="text-[10px] text-slate-600">${item.daysSince} days since last session</div>
          </li>
        `).join('');
      }

      const dueList = document.getElementById('dueHomeworkList');
      if (!homeworkDueSoon.length) {
        dueList.innerHTML = '<li class="text-slate-500">Nothing due soon.</li>';
      } else {
        dueList.innerHTML = homeworkDueSoon.slice(0, 6).map(hw => {
          const res = getResourceById(hw.resourceId);
          const stu = getStudentById(hw.studentId);
          return `<li class="border border-slate-200 bg-white/80 rounded-lg px-2 py-1">
            <div class="font-medium">${res?.title || 'Homework'}</div>
            <div class="text-[10px] text-slate-500">${stu?.name || ''} ‚Ä¢ Due ${hw.dueDate}</div>
          </li>`;
        }).join('');
      }

      const prepQueue = document.getElementById('prepQueueList');
      const prepItems = upcomingSoon.slice(0, 3);
      if (!prepItems.length) {
        prepQueue.innerHTML = '<li class="text-slate-500">No prep needed right now.</li>';
      } else {
        prepQueue.innerHTML = prepItems.map(sess => {
          const names = sess.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
            <div>
              <div class="font-medium">${names}</div>
              <div class="text-[10px] text-slate-500">${sess.date} ‚Ä¢ ${sess.startTime || ''} ‚Ä¢ ${sess.subject}</div>
              <div class="text-[10px]">${sess.topic || 'Lesson focus'}</div>
            </div>
            <button class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                    onclick="openSessionQuickActions('${sess.id}')">Open</button>
          </li>`;
        }).join('');
      }
    }

    /****************
     * STUDENTS VIEW *
     ****************/
    let selectedStudentId = null;

    function renderStudentsView() {
      const list = document.getElementById('studentsList');
      const subjectSelect = document.getElementById('studentSubjectFilter');
      const activitySelect = document.getElementById('studentActivityFilter');
      if (subjectSelect) subjectSelect.onchange = renderStudentsView;
      if (activitySelect) activitySelect.onchange = renderStudentsView;

      const subjectFilter = subjectSelect?.value || '';
      const activityFilter = activitySelect?.value || '';
      const now = new Date();

      const filtered = state.students.filter(s => {
        if (subjectFilter && !(s.subjects || []).includes(subjectFilter)) return false;
        const last = getLastSessionDate(s.id);
        const daysSince = last ? (now - last) / (1000 * 60 * 60 * 24) : Infinity;
        if (activityFilter === 'active' && daysSince > 14) return false;
        if (activityFilter === 'quiet' && daysSince <= 14) return false;
        return true;
      });

      if (!filtered.length) {
        list.innerHTML = '<li class="text-slate-500 text-xs">No students match this filter.</li>';
      } else {
        list.innerHTML = filtered.map(s => {
          const hours = getStudentSubjectHours(s.id);
          const total = hours.Physics + hours.Chemistry + hours.Maths || 1;
          const pPhysics = (hours.Physics / total * 100).toFixed(0);
          const pChem = (hours.Chemistry / total * 100).toFixed(0);
          const pMath = (hours.Maths / total * 100).toFixed(0);
          const last = getLastSessionDate(s.id);
          const daysSince = last ? Math.floor((now - last) / (1000 * 60 * 60 * 24)) : null;
          const next = getNextSessionForStudent(s.id);
          const nextLabel = next ? `${next.date} ${next.startTime || ''}` : 'Unscheduled';
          return `<li class="border border-slate-200 bg-white/85 rounded-xl px-3 py-2 cursor-pointer hover:bg-slate-50 flex flex-col gap-1"
                     data-student-id="${s.id}">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-semibold">${s.name}</div>
                  <div class="text-[10px] text-slate-500">${s.gradeLevel || ''}</div>
                </div>
                <div class="text-[11px] text-slate-600 text-right">${s.subjects?.join(', ') || ''}</div>
              </div>
              <div class="flex items-center justify-between text-[10px] text-slate-500">
                <span>${daysSince != null ? `${daysSince}d since last` : 'No sessions yet'}</span>
                <span>${nextLabel}</span>
              </div>
              <div class="mt-1 w-full h-1.5 rounded-full bg-slate-100 overflow-hidden flex">
                <div style="width:${pPhysics}%" class="bg-indigo-500"></div>
                <div style="width:${pChem}%" class="bg-emerald-500"></div>
                <div style="width:${pMath}%" class="bg-rose-500"></div>
              </div>
            </li>`;
        }).join('');
      }

      list.querySelectorAll('[data-student-id]').forEach(li => {
        li.addEventListener('click', () => {
          selectStudent(li.dataset.studentId);
        });
      });

      const current = getStudentById(selectedStudentId);
      if (current) {
        showStudentDetail(selectedStudentId);
      } else {
        document.getElementById('studentDetailEmpty').classList.remove('hidden');
        document.getElementById('studentDetail').classList.add('hidden');
      }
    }

    function getStudentById(id) {
      return state.students.find(s => s.id === id);
    }

    function getStudentSubjectHours(studentId) {
      const res = { Physics: 0, Chemistry: 0, Maths: 0 };
      const now = new Date();
      const cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      state.sessions.forEach(sess => {
        if (!sess.studentIds.includes(studentId)) return;
        const d = new Date(sess.date);
        if (d >= cutoff) {
          if (res[sess.subject] != null) {
            res[sess.subject] += Number(sess.durationHours || 0);
          }
        }
      });
      return res;
    }

    function getLastSessionDate(studentId) {
      const sessions = state.sessions
        .filter(sess => sess.studentIds.includes(studentId))
        .map(sess => new Date(sess.date))
        .sort((a, b) => b - a);
      return sessions[0] || null;
    }

    function getNextSessionForStudent(studentId) {
      const now = new Date();
      const sessions = state.sessions
        .filter(sess => sess.studentIds.includes(studentId))
        .sort((a, b) => new Date(a.date + 'T' + (a.startTime || '00:00')) - new Date(b.date + 'T' + (b.startTime || '00:00')));
      return sessions.find(sess => new Date(sess.date + 'T' + (sess.startTime || '00:00')) >= now) || null;
    }

    function getStudentHomeworkStats(studentId) {
      const items = state.homework.filter(hw => hw.studentId === studentId);
      const total = items.length;
      const completed = items.filter(hw => hw.status === 'Completed').length;
      return { total, completed, rate: total ? Math.round((completed / total) * 100) : 0 };
    }

    function getWeeklyStreak(studentId) {
      let streak = 0;
      const today = new Date();
      let cursor = getMonday(today);
      while (true) {
        const end = new Date(cursor);
        end.setDate(end.getDate() + 7);
        const hasSession = state.sessions.some(sess => {
          if (!sess.studentIds.includes(studentId)) return false;
          const d = new Date(sess.date);
          return d >= cursor && d < end;
        });
        if (hasSession) {
          streak++;
          cursor.setDate(cursor.getDate() - 7);
        } else {
          break;
        }
      }
      return streak;
    }

    function selectStudent(id) {
      selectedStudentId = id;
      showStudentDetail(id);
      switchView('students');
    }

    function showStudentDetail(id) {
      const s = getStudentById(id);
      if (!s) return;
      document.getElementById('studentDetailEmpty').classList.add('hidden');
      document.getElementById('studentDetail').classList.remove('hidden');

      document.getElementById('studentDetailName').textContent = s.name;
      document.getElementById('studentDetailMeta').textContent =
        `${s.gradeLevel || ''} ‚Ä¢ ${s.subjects?.join(', ') || ''} ‚Ä¢ Rate: ${s.rate ? 'R ' + s.rate + '/h' : '‚Äî'}`;

      const hours = getStudentSubjectHours(id);
      const total = hours.Physics + hours.Chemistry + hours.Maths || 1;
      const pPhysics = (hours.Physics / total * 100).toFixed(0);
      const pChem = (hours.Chemistry / total * 100).toFixed(0);
      const pMath = (hours.Maths / total * 100).toFixed(0);
      const physEl = document.getElementById('mixPhysics');
      const chemEl = document.getElementById('mixChemistry');
      const mathEl = document.getElementById('mixMaths');
      physEl.style.width = pPhysics + '%';
      chemEl.style.width = pChem + '%';
      mathEl.style.width = pMath + '%';
      physEl.textContent = pPhysics > 15 ? pPhysics + '%' : '';
      chemEl.textContent = pChem > 15 ? pChem + '%' : '';
      mathEl.textContent = pMath > 15 ? pMath + '%' : '';

      const totalHours = (hours.Physics + hours.Chemistry + hours.Maths).toFixed(1);
      document.getElementById('engagementHours').textContent = totalHours + 'h';
      const streak = getWeeklyStreak(id);
      document.getElementById('engagementStreak').textContent = streak;
      const last = getLastSessionDate(id);
      document.getElementById('engagementNextGap').textContent = last
        ? `${Math.floor((new Date() - last) / (1000 * 60 * 60 * 24))} days since last`
        : 'No sessions yet';
      const hwStats = getStudentHomeworkStats(id);
      document.getElementById('engagementHomework').textContent = `${hwStats.rate}%`;
      document.getElementById('engagementHomeworkProgress').style.width = `${hwStats.rate}%`;

      renderStudentTimeline(id);
      renderStudentSessions(id);
      renderStudentDocuments(id);
      renderStudentFinance(id);
      renderStudentTodos(id);
      renderStudentCheckins(id);
      renderStudentContracts(id);

      document.getElementById('editStudentBtn').onclick = () => openStudentModal(s);
      document.getElementById('studentCreateInvoiceBtn').onclick = () => { if (guardEdit()) openInvoiceModal(null); };

      document.querySelectorAll('#studentDetailTabs .student-tab').forEach(tab => {
        tab.classList.remove('border-indigo-500', 'text-slate-900');
        tab.classList.add('text-slate-500');
      });
      const defaultTab = document.querySelector('#studentDetailTabs .student-tab[data-student-tab="timeline"]');
      defaultTab.classList.add('border-indigo-500', 'text-slate-900');
      defaultTab.classList.remove('text-slate-500');
      document.querySelectorAll('.student-tab-pane').forEach(p => p.classList.add('hidden'));
      document.getElementById('studentTab-timeline').classList.remove('hidden');

      document.querySelectorAll('#studentDetailTabs .student-tab').forEach(tab => {
        tab.onclick = () => {
          const tabId = tab.dataset.studentTab;
          document.querySelectorAll('#studentDetailTabs .student-tab').forEach(t => {
            t.classList.remove('border-indigo-500', 'text-slate-900');
            t.classList.add('text-slate-500');
          });
          tab.classList.add('border-indigo-500', 'text-slate-900');
          tab.classList.remove('text-slate-500');
          document.querySelectorAll('.student-tab-pane').forEach(p => p.classList.add('hidden'));
          document.getElementById('studentTab-' + tabId).classList.remove('hidden');
        };
      });

      document.getElementById('addDocumentForStudentBtn').onclick = () => { if (guardEdit()) openDocumentModal(null, s.id); };
      const todoForm = document.getElementById('studentTodoForm');
      if (todoForm) {
        todoForm.onsubmit = (e) => {
          if (!guardEdit()) return;
          e.preventDefault();
          const text = todoForm.todoText.value.trim();
          const dueDate = todoForm.todoDue.value;
          if (!text) return;
          state.studentTodos.push({
            id: generateId('todo'),
            studentId: id,
            text,
            dueDate,
            done: false
          });
          saveState();
          renderStudentTodos(id);
          todoForm.reset();
        };
      }
      const checkinForm = document.getElementById('studentCheckinForm');
      if (checkinForm) {
        checkinForm.onsubmit = (e) => {
          if (!guardEdit()) return;
          e.preventDefault();
          const text = checkinForm.checkinText.value.trim();
          if (!text) return;
          state.studentCheckins.push({
            id: generateId('note'),
            studentId: id,
            text,
            date: new Date().toISOString().slice(0, 10)
          });
          saveState();
          renderStudentCheckins(id);
          renderStudentTimeline(id);
          checkinForm.reset();
        };
      }
      const contractBtn = document.getElementById('uploadContractBtn');
      if (contractBtn) {
        contractBtn.onclick = () => openContractUpload(id);
      }
    }

    function renderStudentTimeline(studentId) {
      const ul = document.getElementById('studentTimeline');
      const events = [];

      state.sessions.filter(sess => sess.studentIds.includes(studentId)).forEach(sess => {
        events.push({
          date: sess.date,
          type: 'Session',
          description: `${sess.subject} ‚Ä¢ ${sess.topic || 'Lesson'} (${sess.durationHours || 1}h)`
        });
      });

      state.homework.filter(hw => hw.studentId === studentId).forEach(hw => {
        const res = state.resources.find(r => r.id === hw.resourceId);
        if (!res) return;
        events.push({
          date: hw.assignedDate || res.createdAt || new Date().toISOString().slice(0,10),
          type: 'Homework',
          description: `${res.title} [${hw.status}]`
        });
      });

      state.invoices.filter(inv => inv.studentId === studentId).forEach(inv => {
        events.push({
          date: inv.issueDate,
          type: 'Invoice',
          description: `${inv.id} ‚Äì R ${inv.total?.toFixed(2) || inv.total} (${inv.paid ? 'Paid' : 'Unpaid'})`
        });
      });

      state.documents.filter(doc => doc.studentId === studentId).forEach(doc => {
        events.push({
          date: doc.date || doc.createdAt || new Date().toISOString().slice(0,10),
          type: 'Document',
          description: `${doc.title} [${doc.status}]`
        });
      });

      state.studentCheckins.filter(note => note.studentId === studentId).forEach(note => {
        events.push({
          date: note.date || new Date().toISOString().slice(0,10),
          type: 'Check-in',
          description: note.text
        });
      });

      state.contracts.filter(c => c.studentId === studentId).forEach(c => {
        events.push({
          date: c.uploadedAt || new Date().toISOString().slice(0,10),
          type: 'Contract',
          description: `${c.fileName || 'Contract'} [${c.status || 'Pending'}]`
        });
      });

      events.sort((a, b) => new Date(b.date) - new Date(a.date));

      if (!events.length) {
        ul.innerHTML = '<li class="text-slate-500">No events yet.</li>';
        return;
      }

      ul.innerHTML = events.map(ev => `
        <li class="flex items-start gap-2">
          <div class="mt-1 h-2 w-2 rounded-full ${ev.type === 'Session' ? 'bg-indigo-500' :
                                                ev.type === 'Invoice' ? 'bg-emerald-500' :
                                                ev.type === 'Document' ? 'bg-amber-500' :
                                                'bg-slate-400'}"></div>
          <div>
            <div class="text-[10px] text-slate-500">${ev.date} ‚Ä¢ ${ev.type}</div>
            <div>${ev.description}</div>
          </div>
        </li>
      `).join('');
    }

    function renderStudentSessions(studentId) {
      const ul = document.getElementById('studentSessionsList');
      const sessions = state.sessions.filter(sess => sess.studentIds.includes(studentId))
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      if (!sessions.length) {
        ul.innerHTML = '<li class="text-slate-500">No sessions recorded.</li>';
        return;
      }
      ul.innerHTML = sessions.map(sess => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 flex justify-between items-center bg-white/80">
          <div>
            <div class="font-medium">${sess.subject} ‚Äì ${sess.topic || 'Lesson'}</div>
            <div class="text-[10px] text-slate-500">${sess.date} ‚Ä¢ ${sess.startTime || ''} ‚Ä¢ ${sess.durationHours || 1}h</div>
          </div>
            <button data-owner-only class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                    onclick="if(guardEdit()) openSessionModal(getSessionById('${sess.id}'))">
            Edit
          </button>
        </li>
      `).join('');
    }

    function renderStudentDocuments(studentId) {
      const ul = document.getElementById('studentDocumentsList');
      const docs = state.documents.filter(doc => doc.studentId === studentId);
      if (!docs.length) {
        ul.innerHTML = '<li class="text-slate-500">No documents for this student.</li>';
        return;
      }
      ul.innerHTML = docs.map(doc => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 flex justify-between items-center bg-white/85">
          <div>
            <div class="font-medium">${doc.title}</div>
            <div class="text-[10px] text-slate-500">${doc.status} ‚Ä¢ ${doc.date || ''}</div>
          </div>
          <button data-owner-only class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                  onclick="if(guardEdit()) openDocumentModal(getDocumentById('${doc.id}'))">
            Edit
          </button>
        </li>
      `).join('');
    }

    function renderStudentFinance(studentId) {
      const ul = document.getElementById('studentInvoicesList');
      const invs = state.invoices.filter(inv => inv.studentId === studentId)
        .sort((a, b) => new Date(b.issueDate) - new Date(a.issueDate));
      let balance = 0;
      invs.forEach(inv => {
        if (!inv.paid) balance += Number(inv.total || 0);
      });
      const balanceLabel = balance > 0 ? 'Owed balance' : 'Balance';
      document.getElementById('studentBalance').textContent = `${balanceLabel}: R ${balance.toFixed(2)}`;
      if (!invs.length) {
        ul.innerHTML = '<li class="text-slate-500">No invoices yet.</li>';
        return;
      }
      ul.innerHTML = invs.map(inv => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 flex justify-between items-center bg-white/80">
          <div>
            <div class="font-medium">${inv.id}</div>
            <div class="text-[10px] text-slate-500">
              Issued ${inv.issueDate} ‚Ä¢ Due ${inv.dueDate || '‚Äî'}
              ‚Ä¢ Total R ${Number(inv.total || 0).toFixed(2)}
              ‚Ä¢ ${inv.paid ? 'Paid' : 'Unpaid'}
              ${inv.lateApplied && inv.lateFeePercent ? ` ‚Ä¢ Late fee ${inv.lateFeePercent}%` : ''}
              ${inv.shortApplied && inv.shortNoticePercent ? ` ‚Ä¢ Short notice ${inv.shortNoticePercent}%` : ''}
            </div>
          </div>
          <button data-owner-only class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                  onclick="if(guardEdit()) openInvoiceModal(getInvoiceById('${inv.id}'))">
            Edit
          </button>
        </li>
      `).join('');
    }

    function renderStudentTodos(studentId) {
      const list = document.getElementById('studentTodosList');
      if (!list) return;
      const todos = state.studentTodos.filter(t => t.studentId === studentId);
      if (!todos.length) {
        list.innerHTML = '<li class="text-slate-500">No follow-ups yet.</li>';
        return;
      }
      list.innerHTML = todos.map(t => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 flex justify-between items-center bg-white/80">
          <div>
            <div class="${t.done ? 'line-through text-slate-400' : ''}">${t.text}</div>
            <div class="text-[10px] text-slate-500">${t.dueDate ? 'Due ' + t.dueDate : 'No due date'}</div>
          </div>
          <div class="flex gap-1">
            <button class="text-[10px] px-2 py-0.5 rounded-lg border border-slate-300"
                    onclick="toggleTodoStatus('${t.id}')">${t.done ? 'Undo' : 'Done'}</button>
            <button class="text-[10px] px-2 py-0.5 rounded-lg border border-rose-200 text-rose-600"
                    onclick="deleteTodo('${t.id}')">‚úï</button>
          </div>
        </li>
      `).join('');
    }

    function toggleTodoStatus(todoId) {
      const todo = state.studentTodos.find(t => t.id === todoId);
      if (!todo) return;
      todo.done = !todo.done;
      saveState();
      if (selectedStudentId) renderStudentTodos(selectedStudentId);
    }

    function deleteTodo(todoId) {
      if (!guardEdit()) return;
      state.studentTodos = state.studentTodos.filter(t => t.id !== todoId);
      saveState();
      if (selectedStudentId) renderStudentTodos(selectedStudentId);
    }

    function renderStudentContracts(studentId) {
      const list = document.getElementById('studentContractsList');
      if (!list) return;
      const contracts = state.contracts
        .filter(c => c.studentId === studentId)
        .sort((a, b) => new Date(b.uploadedAt || 0) - new Date(a.uploadedAt || 0));
      if (!contracts.length) {
        list.innerHTML = '<li class="text-slate-500">No contracts uploaded yet.</li>';
        return;
      }
      list.innerHTML = contracts.map(c => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
          <div>
            <div class="font-medium flex items-center gap-1">${c.fileName || 'Contract'} <span class="text-[10px] px-2 py-0.5 rounded-full ${c.status === 'Signed' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${c.status || 'Pending'}</span></div>
            <div class="text-[10px] text-slate-500">Uploaded ${c.uploadedAt || ''}</div>
          </div>
          <div class="flex gap-1">
            ${c.signedUrl ? `<a class="text-[10px] px-2 py-0.5 rounded-lg border border-slate-300 hover:bg-slate-50" href="${c.signedUrl}" target="_blank">Open</a>` : ''}
            ${c.dataUrl ? `<a class="text-[10px] px-2 py-0.5 rounded-lg border border-slate-300 hover:bg-slate-50" href="${c.dataUrl}" download="${c.fileName || 'contract'}" target="_blank">Open</a>` : ''}
            <button data-owner-only class="text-[10px] px-2 py-0.5 rounded-lg border border-emerald-300 text-emerald-700"
                    onclick="if(guardEdit()) markContractStatus('${c.id}', '${c.status === 'Signed' ? 'Pending' : 'Signed'}')">
              ${c.status === 'Signed' ? 'Mark pending' : 'Mark signed'}
            </button>
          </div>
        </li>
      `).join('');
    }

    function renderStudentCheckins(studentId) {
      const list = document.getElementById('studentCheckinsList');
      if (!list) return;
      const notes = state.studentCheckins
        .filter(n => n.studentId === studentId)
        .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
      if (!notes.length) {
        list.innerHTML = '<li class="text-slate-500">No check-ins yet.</li>';
        return;
      }
      list.innerHTML = notes.map(n => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
          <div class="text-[10px] text-slate-500">${n.date}</div>
          <div>${n.text}</div>
        </li>
      `).join('');
    }

    function openContractUpload(studentId) {
      const student = getStudentById(studentId);
      if (!student) return;
      if (!guardEdit()) return;
      const html = `
        <h2 class="text-sm font-semibold mb-3">Upload contract for ${student.name}</h2>
        <form id="contractForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Contract file (PDF or image)</label>
            <input type="file" name="file" accept=".pdf,image/*" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Status</label>
            <select name="status" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              <option value="Pending">Pending</option>
              <option value="Signed">Signed</option>
            </select>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Notes</label>
            <textarea name="notes" rows="2" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]" placeholder="Optional notes"></textarea>
          </div>
          <button type="submit" class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-xs font-medium">Upload</button>
        </form>
        <p class="hint mt-2">If signed in, files go to Supabase Storage; otherwise they stay local (base64).</p>
      `;
      openModal(html, () => {
        const form = document.getElementById('contractForm');
        form.onsubmit = (e) => {
          e.preventDefault();
          const file = form.file.files[0];
          const status = form.status.value;
          const notes = form.notes.value.trim();
          if (!file) {
            alert('Select a PDF or image file.');
            return;
          }
          if (isSupabaseReady()) {
            uploadContractToSupabase(studentId, file, status, notes)
              .then(() => {
                closeModal();
                renderStudentContracts(studentId);
                renderStudentTimeline(studentId);
              })
              .catch(err => {
                console.error(err);
                alert('Upload failed. See console for details.');
              });
          } else {
            const reader = new FileReader();
            reader.onload = () => {
              state.contracts.push({
                id: generateId('contract'),
                studentId,
                fileName: file.name,
                dataUrl: reader.result,
                status,
                notes,
                uploadedAt: new Date().toISOString().slice(0,10)
              });
              saveState();
              closeModal();
              renderStudentContracts(studentId);
              renderStudentTimeline(studentId);
            };
            reader.readAsDataURL(file);
          }
        };
      });
    }

    async function uploadContractToSupabase(studentId, file, status, notes) {
      const uid = supabaseSession?.user?.id;
      if (!uid) throw new Error('No session');
      const ext = file.name.includes('.') ? file.name.split('.').pop() : 'bin';
      // Object key must NOT include bucket name; folder prefix is the user id for RLS.
      const path = `${uid}/${generateId('file')}.${ext}`;
      const { error: uploadErr } = await supabaseClient.storage.from('contracts').upload(path, file, { upsert: false });
      if (uploadErr) throw uploadErr;
      const contract = {
        id: generateId('contract'),
        studentId,
        user_id: uid,
        fileName: file.name,
        storage_path: path,
        status,
        notes,
        uploadedAt: new Date().toISOString().slice(0,10),
        signedUrl: signed?.signedUrl
      };
      state.contracts.push(contract);
      saveState();
    }

    function markContractStatus(contractId, status) {
      const c = state.contracts.find(ct => ct.id === contractId);
      if (!c) return;
      c.status = status;
      saveState();
      if (selectedStudentId) {
        renderStudentContracts(selectedStudentId);
        renderStudentTimeline(selectedStudentId);
      }
    }

    /**************
     * SCHEDULE   *
     **************/
    let currentWeekStart = getMonday(new Date());

    function getMonday(d) {
      const date = new Date(d);
      const day = date.getDay();
      const diff = (day === 0 ? -6 : 1 - day);
      date.setDate(date.getDate() + diff);
      date.setHours(0,0,0,0);
      return date;
    }

    function renderScheduleView() {
      const label = document.getElementById('scheduleWeekLabel');
      const end = new Date(currentWeekStart);
      end.setDate(end.getDate() + 6);
      label.textContent = `${currentWeekStart.toISOString().slice(0,10)} ‚Äì ${end.toISOString().slice(0,10)}`;

      const grid = document.getElementById('scheduleCalendarGrid');
      const dayLoadRow = document.getElementById('dayLoadRow');
      const dayLoads = [];
      grid.innerHTML = '';
      for (let i = 0; i < 7; i++) {
        const day = new Date(currentWeekStart);
        day.setDate(day.getDate() + i);
        const isoDate = day.toISOString().slice(0,10);
        const sessions = state.sessions.filter(s => s.date === isoDate);
        const totalHours = sessions.reduce((acc, s) => acc + Number(s.durationHours || 0), 0);
        dayLoads.push({ totalHours, dayName: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][i] });
        const dayName = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][i];
        grid.innerHTML += `
          <div class="calendar-day" data-date="${isoDate}">
            <div class="flex flex-col mb-1">
              <span class="font-semibold">${dayName}</span>
              <span class="text-[10px] text-slate-500 whitespace-nowrap">${isoDate}</span>
            </div>
            <div class="space-y-1 text-[11px]">
              ${
        sessions.map(s => {
                  const subjectClass = s.subject === 'Physics'
                    ? 'text-indigo-700'
                    : s.subject === 'Chemistry'
                      ? 'text-emerald-700'
                      : 'text-rose-700';
                  const names = s.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
                  return `<div class="session-card cursor-pointer" onclick="openSessionQuickActions('${s.id}')">
                            <div class="flex items-center justify-between">
                              <span class="session-time ${subjectClass}">${s.startTime || ''}</span>
                              <span class="session-chip ${subjectClass}">${s.subject}</span>
                            </div>
                            <div class="text-[11px] font-semibold text-slate-800">${names}</div>
                            <div class="text-[10px] text-slate-600 leading-snug">${s.topic || ''}</div>
                          </div>`;
                }).join('')
              }
            </div>
          </div>
        `;
      }
      if (dayLoadRow) {
        const maxLoad = Math.max(...dayLoads.map(d => d.totalHours), 1);
        dayLoadRow.innerHTML = dayLoads.map(dl => {
          const pct = maxLoad ? Math.min(100, (dl.totalHours / maxLoad) * 100) : 0;
          return `<div class="flex flex-col gap-1">
            <div class="text-[10px] font-semibold">${dl.dayName}</div>
            <div class="w-full bg-slate-100 rounded-full h-2">
              <div class="h-2 rounded-full bg-indigo-500" style="width:${pct}%"></div>
            </div>
            <div class="text-[10px] text-slate-500">${dl.totalHours.toFixed(1)}h</div>
          </div>`;
        }).join('');
      }

      document.getElementById('schedulePrevWeek').onclick = () => {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        renderScheduleView();
      };
      document.getElementById('scheduleNextWeek').onclick = () => {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        renderScheduleView();
      };
      document.getElementById('scheduleToday').onclick = () => {
        currentWeekStart = getMonday(new Date());
        renderScheduleView();
      };

      const todayIso = new Date().toISOString().slice(0,10);
      const todayList = document.getElementById('todaySessionsList');
      const todaySessions = state.sessions.filter(s => s.date === todayIso)
        .sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));
      if (!todaySessions.length) {
        todayList.innerHTML = '<li class="text-slate-500">No sessions today.</li>';
      } else {
        todayList.innerHTML = todaySessions.map(s => {
          const names = s.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
          return `<li class="session-card">
            <div class="flex items-center justify-between">
              <div class="text-[10px] uppercase tracking-wide text-slate-500">${s.subject}</div>
              <div class="session-time">${s.startTime || ''}</div>
            </div>
            <div class="text-[11px] font-semibold text-slate-800">${names}</div>
            <div class="text-[10px] text-slate-600">${s.topic || ''} ‚Ä¢ ${s.durationHours || 1}h</div>
            <button class="mt-1 text-[10px] px-2 py-0.5 rounded-lg border border-slate-300 hover:bg-slate-50"
                    onclick="openSessionQuickActions('${s.id}')">
              Open
            </button>
          </li>`;
        }).join('');
      }

      renderClashes();
      renderTightTransitions();
    }

    function renderClashes() {
      const ul = document.getElementById('clashList');
      const clashes = [];
      const sessions = [...state.sessions].sort((a, b) => (a.date + 'T' + (a.startTime || '00:00')).localeCompare(b.date + 'T' + (b.startTime || '00:00')));
      for (let i = 0; i < sessions.length; i++) {
        for (let j = i+1; j < sessions.length; j++) {
          const a = sessions[i], b = sessions[j];
          if (a.date !== b.date) continue;
          const aStart = timeToMinutes(a.startTime || '00:00');
          const aEnd = aStart + Number(a.durationHours || 1) * 60;
          const bStart = timeToMinutes(b.startTime || '00:00');
          const bEnd = bStart + Number(b.durationHours || 1) * 60;
          if (aEnd <= bStart || bEnd <= aStart) continue;
          const sharedStudents = a.studentIds.filter(id => b.studentIds.includes(id));
          if (sharedStudents.length) {
            clashes.push({ a, b, sharedStudents });
          }
        }
      }
      if (!clashes.length) {
        ul.innerHTML = '<li class="text-slate-500">No clashes detected.</li>';
        return;
      }
      ul.innerHTML = clashes.slice(0, 10).map(c => {
        const names = c.sharedStudents.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
        return `<li class="border border-amber-300 bg-amber-50 text-amber-900 rounded-lg px-2 py-1">
          <div class="font-medium">Clash for ${names}</div>
          <div class="text-[10px]">
            ${c.a.date} ‚Ä¢ ${c.a.startTime || ''} vs ${c.b.startTime || ''}<br>
            ${c.a.subject} ‚Äì ${c.a.topic || 'Lesson'} <br>
            ${c.b.subject} ‚Äì ${c.b.topic || 'Lesson'}
          </div>
        </li>`;
      }).join('');
    }

    function renderTightTransitions() {
      const list = document.getElementById('tightTransitionsList');
      const byDate = {};
      state.sessions.forEach(s => {
        if (!byDate[s.date]) byDate[s.date] = [];
        byDate[s.date].push(s);
      });
      const tight = [];
      Object.keys(byDate).forEach(date => {
        const sessions = byDate[date].sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));
        for (let i = 0; i < sessions.length - 1; i++) {
          const currentEnd = timeToMinutes(sessions[i].startTime || '00:00') + Number(sessions[i].durationHours || 1) * 60;
          const nextStart = timeToMinutes(sessions[i+1].startTime || '00:00');
          const gap = nextStart - currentEnd;
          if (gap >= 0 && gap < 20) {
            tight.push({ a: sessions[i], b: sessions[i+1], gap, date });
          }
        }
      });
      if (!tight.length) {
        list.innerHTML = '<li class="text-slate-500">No tight transitions.</li>';
        return;
      }
      list.innerHTML = tight.slice(0, 6).map(item => {
        const aNames = item.a.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
        const bNames = item.b.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
        return `<li class="border border-amber-200 bg-amber-50 rounded-lg px-2 py-1">
          <div class="font-medium">${item.gap} min gap</div>
          <div class="text-[10px]">${item.date}: ${item.a.startTime || ''} ${aNames} ‚Üí ${item.b.startTime || ''} ${bNames}</div>
        </li>`;
      }).join('');
    }

    function timeToMinutes(t) {
      const [h, m] = t.split(':').map(Number);
      return h*60 + m;
    }

    function getSessionById(id) {
      return state.sessions.find(s => s.id === id);
    }

    function openSessionQuickActions(sessionId) {
      const sess = getSessionById(sessionId);
      if (!sess) return;
      const names = sess.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
      openModal(`
        <h2 class="text-sm font-semibold mb-2">Session with ${names}</h2>
        <p class="text-[11px] mb-2">${sess.subject} ‚Ä¢ ${sess.date} ‚Ä¢ ${sess.startTime || ''} (${sess.durationHours || 1}h)</p>
        <p class="text-[11px] mb-3">${sess.topic || ''}</p>

        <div class="space-y-2">
          <button id="sessionMarkCompletedBtn" class="w-full px-3 py-1.5 rounded-xl bg-emerald-600 text-white text-xs font-medium" data-owner-only>
            Mark attended & complete session
          </button>
          <button id="sessionEditBtn" class="w-full px-3 py-1.5 rounded-xl border border-slate-300 text-xs" data-owner-only>
            Edit session
          </button>
        </div>
      `, () => {
        document.getElementById('sessionMarkCompletedBtn').onclick = () => {
          if (!guardEdit()) return;
          sess.completed = true;
          saveState();
          closeModal();
          renderScheduleView();
          renderStudentsView();
        };
        document.getElementById('sessionEditBtn').onclick = () => {
          if (!guardEdit()) return;
          closeModal();
          openSessionModal(sess);
        };
      });
    }

    /*************
     * RESOURCES *
     *************/
    function renderResourcesView() {
      const list = document.getElementById('resourcesList');
      const subjectFilter = document.getElementById('resourceSubjectFilter').value;
      const searchTerm = document.getElementById('resourceSearchInput').value.trim().toLowerCase();
      const tagFiltersEl = document.getElementById('resourceTagFilters');
      const activeTag = tagFiltersEl?.dataset.active || '';

      const tagCounts = {};
      state.resources.forEach(r => {
        (r.tags || []).forEach(tag => {
          const key = tag.trim();
          if (!key) return;
          tagCounts[key] = (tagCounts[key] || 0) + 1;
        });
      });
      const topTags = Object.entries(tagCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);
      if (tagFiltersEl) {
        tagFiltersEl.innerHTML = (topTags.length ? topTags.map(([tag, count]) => `
          <button class="chip-btn ${activeTag === tag.toLowerCase() ? 'active' : ''}" data-tag="${tag}">#${tag} (${count})</button>
        `).join('') : '<span class="text-slate-500">Tags will appear after you add resources.</span>')
          + (activeTag ? ' <button class="chip-btn" data-tag="">Clear</button>' : '');
        tagFiltersEl.querySelectorAll('button[data-tag]').forEach(btn => {
          btn.onclick = () => {
            tagFiltersEl.dataset.active = (btn.dataset.tag || '').toLowerCase();
            renderResourcesView();
          };
        });
      }

      const filtered = state.resources.filter(r => {
        if (subjectFilter && r.subject !== subjectFilter) return false;
        if (searchTerm && !r.title.toLowerCase().includes(searchTerm) && !(r.tags || []).some(t => t.toLowerCase().includes(searchTerm))) {
          return false;
        }
        if (activeTag && !(r.tags || []).some(t => t.toLowerCase() === activeTag)) return false;
        return true;
      }).sort((a, b) => (b.favorite === true) - (a.favorite === true));
      if (!filtered.length) {
        list.innerHTML = '<li class="text-slate-500 text-xs">No resources yet. Add worksheets, lectures, or notes.</li>';
      } else {
        list.innerHTML = filtered.map(r => `
          <li class="border border-slate-200 rounded-xl px-3 py-2 bg-white/85">
            <div class="flex justify-between items-start gap-2">
              <div>
                <div class="font-semibold">${r.title}</div>
                <div class="text-[10px] text-slate-500">${r.subject} ‚Ä¢ ${r.level || ''}</div>
              </div>
              <div class="flex items-center gap-1">
                <button class="text-[12px]" title="Favorite"
                        onclick="toggleResourceFavorite('${r.id}')">${r.favorite ? '‚≠ê' : '‚òÜ'}</button>
                <button class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                        onclick="openResourceModal(getResourceById('${r.id}'))">
                  Edit
                </button>
              </div>
            </div>
            <div class="mt-1 text-[10px]">${r.description || ''}</div>
          <div class="mt-1 flex flex-wrap">
              ${(r.tags || []).map(tag => `<span class="tag-pill">#${tag}</span>`).join('')}
            </div>
            <div class="mt-1 text-[10px] text-slate-500">
              ${getResourceUsageText(r.id)}
            </div>
            <div class="mt-2 flex gap-2 text-[11px] flex-wrap items-center">
              <button data-owner-only class="px-2 py-1 rounded-lg bg-slate-900 text-white hover:bg-slate-800"
                      onclick="if(guardEdit()) openAssignResourceModal('${r.id}')">
                Assign to student(s)
              </button>
              ${r.signedUrl ? `<a class="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50" href="${r.signedUrl}" target="_blank">Download file</a>` : ''}
              ${!r.signedUrl && r.dataUrl ? `<a class="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50" href="${r.dataUrl}" download="${r.fileName || 'resource'}" target="_blank">Download local copy</a>` : ''}
            </div>
          </li>
        `).join('');
      }

      document.getElementById('resourceSubjectFilter').onchange = renderResourcesView;
      document.getElementById('resourceSearchInput').oninput = renderResourcesView;

      renderHomeworkBoard();
    }

    function getResourceById(id) {
      return state.resources.find(r => r.id === id);
    }

    function getResourceUsageText(resourceId) {
      const assignments = state.homework.filter(hw => hw.resourceId === resourceId);
      if (!assignments.length) return 'Not assigned yet.';
      const last = assignments
        .map(a => a.dueDate || a.assignedDate)
        .filter(Boolean)
        .sort((a, b) => new Date(b) - new Date(a))[0];
      return `Assigned ${assignments.length}√ó ‚Ä¢ Last due ${last || 'n/a'}`;
    }

    function toggleResourceFavorite(resourceId) {
      const res = getResourceById(resourceId);
      if (!res) return;
      res.favorite = !res.favorite;
      saveState();
      renderResourcesView();
    }

    function renderHomeworkBoard() {
      const todo = document.getElementById('hwTodo');
      const doing = document.getElementById('hwInProgress');
      const done = document.getElementById('hwDone');
      todo.innerHTML = doing.innerHTML = done.innerHTML = '';

      const grouped = {
        'To do': [],
        'In progress': [],
        'Completed': []
      };

      state.homework.forEach(hw => {
        const res = state.resources.find(r => r.id === hw.resourceId);
        const student = getStudentById(hw.studentId);
        if (!res || !student) return;
        grouped[hw.status || 'To do'].push({
          ...hw,
          res, student
        });
      });

      function makeCard(hwObj) {
        const hw = hwObj;
        return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/85">
          <div class="font-medium">${hw.res.title}</div>
          <div class="text-[10px] text-slate-500">${hw.student.name} ‚Ä¢ Due ${hw.dueDate || 'n/a'}</div>
          <select class="mt-1 w-full border border-slate-300 rounded-lg px-1 py-0.5 text-[10px]"
                  onchange="updateHomeworkStatus('${hw.id}', this.value)">
            <option value="To do" ${hw.status === 'To do' ? 'selected' : ''}>To do</option>
            <option value="In progress" ${hw.status === 'In progress' ? 'selected' : ''}>In progress</option>
            <option value="Completed" ${hw.status === 'Completed' ? 'selected' : ''}>Completed</option>
          </select>
        </li>`;
      }

      todo.innerHTML = grouped['To do'].map(makeCard).join('') || '<li class="text-slate-500 text-[11px]">Nothing here.</li>';
      doing.innerHTML = grouped['In progress'].map(makeCard).join('') || '<li class="text-slate-500 text-[11px]">Nothing here.</li>';
      done.innerHTML = grouped['Completed'].map(makeCard).join('') || '<li class="text-slate-500 text-[11px]">Nothing here.</li>';
    }

    function updateHomeworkStatus(hwId, status) {
      const hw = state.homework.find(h => h.id === hwId);
      if (!hw) return;
      hw.status = status;
      saveState();
      renderResourcesView();
      if (selectedStudentId) {
        renderStudentTimeline(selectedStudentId);
      }
    }

    /*************
     * FINANCE   *
     *************/
    function getInvoiceById(id) {
      return state.invoices.find(inv => inv.id === id);
    }

    function renderFinanceView() {
      const tbody = document.getElementById('financeStudentTable');
      if (!state.students.length) {
        tbody.innerHTML = '';
      } else {
        tbody.innerHTML = state.students.map(s => {
          const invs = state.invoices.filter(inv => inv.studentId === s.id);
          let balance = 0;
          let unpaidCount = 0;
          invs.forEach(inv => {
            if (!inv.paid) {
              balance += Number(inv.total || 0);
              unpaidCount++;
            }
          });
          return `<tr>
            <td class="py-1 pr-1">${s.name}</td>
            <td class="py-1 pr-1 text-right ${balance > 0 ? 'text-rose-600' : 'text-emerald-600'}">
              R ${balance.toFixed(2)}
            </td>
            <td class="py-1 pr-1 text-right">${unpaidCount}</td>
          </tr>`;
        }).join('');
      }

      const overdueList = document.getElementById('overdueInvoicesList');
      const today = new Date();
      const overdue = state.invoices.filter(inv => !inv.paid && inv.dueDate && new Date(inv.dueDate) < today)
        .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

      if (!overdue.length) {
        overdueList.innerHTML = '<li class="text-slate-500">No overdue invoices.</li>';
      } else {
        overdueList.innerHTML = overdue.map(inv => {
          const s = getStudentById(inv.studentId);
          const studentName = s?.name || 'Unknown';
          return `<li class="border border-rose-200 bg-rose-50 text-rose-900 rounded-lg px-2 py-1">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-medium">${studentName}</div>
                <div class="text-[10px]">Invoice ${inv.id} ‚Ä¢ Due ${inv.dueDate} ‚Ä¢ R ${Number(inv.total || 0).toFixed(2)}</div>
                ${(inv.lateApplied && inv.lateFeePercent) || (inv.shortApplied && inv.shortNoticePercent) ? `<div class="text-[10px]">Fees: ${inv.lateApplied && inv.lateFeePercent ? 'Late ' + inv.lateFeePercent + '%' : ''} ${inv.shortApplied && inv.shortNoticePercent ? 'Short ' + inv.shortNoticePercent + '%' : ''}</div>` : ''}
              </div>
              <div class="flex flex-col gap-1">
                <button class="text-[10px] px-2 py-0.5 rounded-lg border border-rose-300 bg-rose-100"
                        onclick="markInvoicePaid('${inv.id}')">
                  Mark paid
                </button>
                <button class="text-[10px] px-2 py-0.5 rounded-lg border border-rose-300 bg-white"
                        onclick="generateReminder('${inv.id}')">
                  Reminder text
                </button>
              </div>
            </div>
          </li>`;
        }).join('');
      }

      const unbilledList = document.getElementById('unbilledList');
      if (unbilledList) {
        const unbilled = state.students.map(s => {
          const invs = state.invoices.filter(inv => inv.studentId === s.id);
          const lastInvoiceDate = invs.length
            ? new Date(Math.max(...invs.map(inv => new Date(inv.issueDate || inv.dueDate || 0))))
            : new Date(0);
          const sessionsAfter = state.sessions.filter(sess => sess.studentIds.includes(s.id) && new Date(sess.date) > lastInvoiceDate);
          const hours = sessionsAfter.reduce((acc, sess) => acc + Number(sess.durationHours || 0), 0);
          const amount = hours * (Number(s.rate) || 0);
          return { student: s, hours, amount, lastInvoiceDate: lastInvoiceDate.getFullYear() > 1970 ? lastInvoiceDate.toISOString().slice(0,10) : 'No invoices yet' };
        }).filter(item => item.hours > 0.01)
          .sort((a, b) => b.amount - a.amount)
          .slice(0, 6);
        if (!unbilled.length) {
          unbilledList.innerHTML = '<li class="text-slate-500">No unbilled sessions detected.</li>';
        } else {
          unbilledList.innerHTML = unbilled.map(item => `
            <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
              <div>
                <div class="font-medium">${item.student.name}</div>
                <div class="text-[10px] text-slate-500">${item.hours.toFixed(1)}h since ${item.lastInvoiceDate}</div>
              </div>
              <div class="text-right text-[11px] font-semibold">R ${item.amount.toFixed(0)}</div>
            </li>
          `).join('');
        }
      }

      const forecastList = document.getElementById('forecastList');
      const forecastSummary = document.getElementById('forecastSummary');
      if (forecastList && forecastSummary) {
        const soonCutoff = new Date();
        soonCutoff.setDate(soonCutoff.getDate() + 14);
        const overdueInvoices = state.invoices.filter(inv => !inv.paid && inv.dueDate && new Date(inv.dueDate) < today);
        const dueSoon = state.invoices
          .filter(inv => !inv.paid && inv.dueDate && new Date(inv.dueDate) >= today && new Date(inv.dueDate) <= soonCutoff)
          .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        const overdueTotal = overdueInvoices.reduce((sum, inv) => sum + Number(inv.total || 0), 0);
        const dueSoonTotal = dueSoon.reduce((sum, inv) => sum + Number(inv.total || 0), 0);
        forecastSummary.textContent = `R ${dueSoonTotal.toFixed(0)} due in 14 days ‚Ä¢ R ${overdueTotal.toFixed(0)} overdue`;
        if (!dueSoon.length) {
          forecastList.innerHTML = '<li class="text-slate-500">No invoices due in the next 14 days.</li>';
        } else {
          forecastList.innerHTML = dueSoon.map(inv => {
            const s = getStudentById(inv.studentId);
            return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
              <div>
                <div class="font-medium">${s?.name || 'Unknown'}</div>
                <div class="text-[10px] text-slate-500">Invoice ${inv.id} ‚Ä¢ Due ${inv.dueDate}</div>
              </div>
              <div class="text-right text-[11px] font-semibold">R ${Number(inv.total || 0).toFixed(0)}</div>
            </li>`;
          }).join('');
        }
      }
    }

    function markInvoicePaid(id) {
      if (!guardEdit()) return;
      const inv = getInvoiceById(id);
      if (!inv) return;
      inv.paid = true;
      saveState();
      renderFinanceView();
      if (selectedStudentId) renderStudentFinance(selectedStudentId);
    }

    function generateReminder(id) {
      const inv = getInvoiceById(id);
      if (!inv) return;
      const s = getStudentById(inv.studentId);
      const name = s?.name || 'your child';
      const today = new Date().toISOString().slice(0,10);
      const text =
`Hi,

Just a friendly reminder about invoice ${inv.id} for ${name}, issued on ${inv.issueDate}, for R ${Number(inv.total || 0).toFixed(2)}. The due date was ${inv.dueDate || 'n/a'}.

If you have already made payment, please ignore this message. Otherwise, I‚Äôd appreciate it if you could settle it at your convenience.

Best regards,
[Your name]
(${today})`;
      openModal(`
        <h2 class="text-sm font-semibold mb-2">Reminder text</h2>
        <textarea class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]" rows="8">${text}</textarea>
        <p class="mt-2 text-[10px] text-slate-500">
          You can copy this message and paste it into email or WhatsApp.
        </p>
      `);
    }

    /*************
     * MODALS    *
     *************/
    function openModal(html, onReady) {
      const overlay = document.getElementById('modalOverlay');
      const container = document.getElementById('modalContainer');
      container.innerHTML = `
        <div class="flex justify-between items-start mb-3">
          <div></div>
          <button id="modalCloseBtn" class="h-7 w-7 rounded-full border border-slate-300 flex items-center justify-center text-xs">‚úï</button>
        </div>
        ${html}
      `;
      overlay.classList.add('show');
      document.getElementById('modalCloseBtn').onclick = closeModal;
      overlay.onclick = (e) => {
        if (e.target === overlay) closeModal();
      };
      if (onReady) onReady();
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('show');
    }

    /***********************
     * STUDENT CRUD MODAL  *
     ***********************/
    function openStudentModal(student) {
      if (!guardEdit()) return;
      const isEdit = !!student;
      const html = `
        <h2 class="text-sm font-semibold mb-3">${isEdit ? 'Edit student' : 'Add student'}</h2>
        <form id="studentForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Name</label>
            <input name="name" value="${student?.name || ''}" required
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Student email (for login)</label>
            <input name="studentEmail" type="email" value="${student?.studentEmail || ''}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs" ${readOnlyMode ? 'disabled' : ''}>
            <p class="text-[10px] text-slate-500 mt-1">Set to the student's login email. They will only see their own profile.</p>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Grade / Level</label>
              <input name="gradeLevel" value="${student?.gradeLevel || ''}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div>
              <label class="block text-[11px] mb-1">Hourly rate (R)</label>
              <input name="rate" type="number" step="0.01" value="${student?.rate || ''}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Subjects (comma separated)</label>
            <input name="subjects" value="${student?.subjects?.join(', ') || ''}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Notes</label>
            <textarea name="notes" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${student?.notes || ''}</textarea>
          </div>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-xs font-medium">
              ${isEdit ? 'Save changes' : 'Add student'}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteStudentBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                Delete
              </button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        document.getElementById('studentForm').onsubmit = (e) => {
          e.preventDefault();
          const form = e.target;
          const newStudent = {
            id: student?.id || generateId('stu'),
            name: form.name.value.trim(),
            gradeLevel: form.gradeLevel.value.trim(),
            rate: Number(form.rate.value || 0),
            subjects: form.subjects.value.split(',').map(s => s.trim()).filter(Boolean),
            notes: form.notes.value.trim(),
            studentEmail: form.studentEmail.value.trim()
          };
          if (!newStudent.name) {
            alert('Name is required.');
            return;
          }
          if (isEdit) {
            const idx = state.students.findIndex(s => s.id === student.id);
            state.students[idx] = newStudent;
          } else {
            state.students.push(newStudent);
          }
          saveState();
          closeModal();
          renderStudentsView();
        };
        if (isEdit) {
          document.getElementById('deleteStudentBtn').onclick = () => {
            if (!confirm('Delete this student? This will not delete existing sessions/invoices but will orphan them.')) return;
            state.students = state.students.filter(s => s.id !== student.id);
            saveState();
            closeModal();
            selectedStudentId = null;
            renderStudentsView();
          };
        }
      });
    }

    /***********************
     * SESSION CRUD MODAL  *
     ***********************/
    function openSessionModal(session) {
      if (!guardEdit()) return;
      const isEdit = !!session;
      const html = `
        <h2 class="text-sm font-semibold mb-3">${isEdit ? 'Edit session' : 'Add session'}</h2>
        <form id="sessionForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Students</label>
            <div class="grid grid-cols-2 gap-1 max-h-32 overflow-y-auto border border-slate-300 rounded-lg px-2 py-1">
              ${
                state.students.length
                  ? state.students.map(s => `
                      <label class="flex items-center gap-1 text-[11px]">
                        <input type="checkbox" name="studentIds" value="${s.id}"
                          ${session?.studentIds?.includes(s.id) ? 'checked' : ''}>
                        <span>${s.name}</span>
                      </label>
                    `).join('')
                  : '<div class="text-slate-500 text-[11px]">No students yet.</div>'
              }
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Date</label>
              <input type="date" name="date" value="${session?.date || new Date().toISOString().slice(0,10)}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs" required>
            </div>
            <div>
              <label class="block text-[11px] mb-1">Start time</label>
              <input type="time" name="startTime" value="${session?.startTime || '16:00'}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Duration (hours)</label>
              <input type="number" step="0.25" name="durationHours" value="${(session?.durationHours ?? state.settings.defaultSessionDuration) || 1}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div>
              <label class="block text-[11px] mb-1">Subject</label>
              <select name="subject" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                <option value="Physics" ${session?.subject === 'Physics' ? 'selected' : ''}>Physics</option>
                <option value="Chemistry" ${session?.subject === 'Chemistry' ? 'selected' : ''}>Chemistry</option>
                <option value="Maths" ${session?.subject === 'Maths' ? 'selected' : ''}>Maths</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Topic / focus</label>
            <input name="topic" value="${session?.topic || ''}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Notes</label>
            <textarea name="notes" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${session?.notes || ''}</textarea>
          </div>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium">
              ${isEdit ? 'Save changes' : 'Add session'}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteSessionBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                Delete
              </button>` : ''}
          </div>
          <div id="sessionClashWarning" class="mt-2 text-[10px] text-amber-600"></div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('sessionForm');

        function updateClashWarning() {
          const date = form.date.value;
          const startTime = form.startTime.value || '00:00';
          const durationHours = Number(form.durationHours.value || 1);
          const selectedIds = [...form.querySelectorAll('input[name="studentIds"]:checked')].map(i => i.value);
          const warningEl = document.getElementById('sessionClashWarning');
          const clashes = state.sessions.filter(s => {
            if (isEdit && s.id === session.id) return false;
            if (s.date !== date) return false;
            const shared = s.studentIds.some(id => selectedIds.includes(id));
            if (!shared) return false;
            const aStart = timeToMinutes(startTime);
            const aEnd = aStart + durationHours * 60;
            const bStart = timeToMinutes(s.startTime || '00:00');
            const bEnd = bStart + Number(s.durationHours || 1) * 60;
            return !(aEnd <= bStart || bEnd <= aStart);
          });
          if (clashes.length) {
            warningEl.textContent = '‚ö† Potential clash: this overlaps with another session for the same student(s).';
          } else {
            warningEl.textContent = '';
          }
        }

        ['change','input'].forEach(ev => {
          form.date.addEventListener(ev, updateClashWarning);
          form.startTime.addEventListener(ev, updateClashWarning);
          form.durationHours.addEventListener(ev, updateClashWarning);
          form.querySelectorAll('input[name="studentIds"]').forEach(cb => cb.addEventListener(ev, updateClashWarning));
        });
        updateClashWarning();

        form.onsubmit = (e) => {
          e.preventDefault();
          const selectedIds = [...form.querySelectorAll('input[name="studentIds"]:checked')].map(i => i.value);
          if (!selectedIds.length) {
            alert('Select at least one student.');
            return;
          }
          const newSession = {
            id: session?.id || generateId('sess'),
            studentIds: selectedIds,
            date: form.date.value,
            startTime: form.startTime.value,
            durationHours: Number(form.durationHours.value || 1),
            subject: form.subject.value,
            topic: form.topic.value.trim(),
            notes: form.notes.value.trim(),
            completed: session?.completed || false
          };
          if (isEdit) {
            const idx = state.sessions.findIndex(s => s.id === session.id);
            state.sessions[idx] = newSession;
          } else {
            state.sessions.push(newSession);
          }
          saveState();
          closeModal();
          renderScheduleView();
          renderStudentsView();
        };

        if (isEdit) {
          document.getElementById('deleteSessionBtn').onclick = () => {
            if (!confirm('Delete this session?')) return;
            deleteSessionAndLinks(session.id).then(() => {
              closeModal();
              renderScheduleView();
              renderStudentsView();
            }).catch(err => {
              console.error(err);
              alert('Delete failed. See console for details.');
            });
          };
        }
      });
    }

    async function deleteSessionAndLinks(sessionId) {
      // remove locally
      state.sessions = state.sessions.filter(s => s.id !== sessionId);
      saveState();
      // remove remotely if connected
      if (isSupabaseReady()) {
        const { error: linkErr } = await supabaseClient.from('session_students').delete().eq('session_id', sessionId);
        if (linkErr) throw linkErr;
        const { error: sessErr } = await supabaseClient.from('sessions').delete().eq('id', sessionId);
        if (sessErr) throw sessErr;
      }
    }

    /***********************
     * RESOURCE CRUD MODAL *
     ***********************/
    function openResourceModal(resource) {
      if (!guardEdit()) return;
      const isEdit = !!resource;
      const html = `
        <h2 class="text-sm font-semibold mb-3">${isEdit ? 'Edit resource' : 'Add resource'}</h2>
        <form id="resourceForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Title</label>
            <input name="title" value="${resource?.title || ''}" required
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Subject</label>
              <select name="subject" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                <option value="Physics" ${resource?.subject === 'Physics' ? 'selected' : ''}>Physics</option>
                <option value="Chemistry" ${resource?.subject === 'Chemistry' ? 'selected' : ''}>Chemistry</option>
                <option value="Maths" ${resource?.subject === 'Maths' ? 'selected' : ''}>Maths</option>
              </select>
            </div>
            <div>
              <label class="block text-[11px] mb-1">Level</label>
              <input name="level" value="${resource?.level || ''}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Tags (comma separated)</label>
            <input name="tags" value="${(resource?.tags || []).join(', ')}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Description / location</label>
            <textarea name="description" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${resource?.description || ''}</textarea>
          </div>
          <div class="border border-dashed border-slate-300 rounded-lg p-2 bg-slate-50">
            <label class="block text-[11px] mb-1">Attach file (PDF/Image/Doc)</label>
            <input type="file" name="file" class="w-full text-[11px]">
            <p class="text-[10px] text-slate-500 mt-1">Uploads require Supabase sign-in. Current file: ${resource?.fileName || 'None'}.</p>
            <div class="flex gap-2 mt-2">
              <button type="button" id="uploadResourceFileBtn" class="px-2 py-1 rounded-lg bg-slate-900 text-white text-[11px]">Upload</button>
              ${resource?.signedUrl ? `<a class="px-2 py-1 rounded-lg border border-slate-300 text-[11px]" href="${resource.signedUrl}" target="_blank">Download</a>` : ''}
            </div>
          </div>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-xs font-medium">
              ${isEdit ? 'Save changes' : 'Add resource'}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteResourceBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                Delete
              </button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('resourceForm');
        form.onsubmit = (e) => {
          e.preventDefault();
          const newRes = {
            id: resource?.id || generateId('res'),
            title: form.title.value.trim(),
            subject: form.subject.value,
            level: form.level.value.trim(),
            tags: form.tags.value.split(',').map(t => t.trim()).filter(Boolean),
            description: form.description.value.trim(),
            createdAt: resource?.createdAt || new Date().toISOString().slice(0,10),
            storage_path: resource?.storage_path || '',
            fileName: resource?.fileName || '',
            signedUrl: resource?.signedUrl || '',
            favorite: resource?.favorite || false
          };
          if (!newRes.title) {
            alert('Title is required.');
            return;
          }
          if (isEdit) {
            const idx = state.resources.findIndex(r => r.id === resource.id);
            state.resources[idx] = newRes;
          } else {
            state.resources.push(newRes);
          }
          saveState();
          closeModal();
          renderResourcesView();
        };

        if (isEdit) {
          document.getElementById('deleteResourceBtn').onclick = () => {
            if (!confirm('Delete this resource?')) return;
            state.resources = state.resources.filter(r => r.id !== resource.id);
            state.homework = state.homework.filter(hw => hw.resourceId !== resource.id);
            saveState();
            closeModal();
            renderResourcesView();
          };
        }

        const uploadBtn = document.getElementById('uploadResourceFileBtn');
        if (uploadBtn) {
          uploadBtn.onclick = async () => {
            const file = form.file?.files?.[0];
            if (!file) {
              alert('Choose a file to upload.');
              return;
            }
            if (!isSupabaseReady()) {
              alert('Sign in to upload files.');
              return;
            }
            try {
              const uploaded = await uploadResourceFile(file);
              resource = {
                ...(resource || { id: generateId('res') }),
                storage_path: uploaded.storage_path,
                fileName: uploaded.fileName,
                signedUrl: uploaded.signedUrl,
                dataUrl: uploaded.dataUrl || ''
              };
              alert(uploaded.storage_path ? 'File uploaded. Save the resource to keep the link.' : 'Stored file locally. Save to keep the link (Supabase storage was blocked).');
            } catch (err) {
              console.error(err);
              alert('Upload failed. See console for details.');
            }
          };
        }
      });
    }

    let storageBlocked = false;

    async function uploadResourceFile(file) {
      // Fallback-friendly upload: try Supabase storage; if blocked by RLS/bucket issues, fall back to data URL so the user can still attach the file.
      const readAsDataUrl = (blob) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });

      const uid = supabaseSession?.user?.id;
      // If storage uploads are disabled or blocked, or not signed in, store locally as data URL
      if (!ALLOW_STORAGE_UPLOADS || storageBlocked || !uid || !supabaseClient?.storage) {
        const dataUrl = await readAsDataUrl(file);
        return { dataUrl, fileName: file.name, storage_path: '', signedUrl: '' };
      }

      const ext = file.name.includes('.') ? file.name.split('.').pop() : 'bin';
      // Object key must NOT include bucket name; folder prefix is the user id for RLS.
      const path = `${uid}/${generateId('file')}.${ext}`;
      const { error: uploadErr } = await supabaseClient.storage.from('resources').upload(path, file, { upsert: false });
      if (uploadErr) {
        const msg = (uploadErr?.message || '').toLowerCase();
        if (msg.includes('bucket') || msg.includes('policy') || msg.includes('row-level')) {
          storageBlocked = true;
          console.warn('Storage upload blocked, using local data URL fallback', uploadErr);
          const dataUrl = await readAsDataUrl(file);
          return { dataUrl, fileName: file.name, storage_path: '', signedUrl: '' };
        }
        throw uploadErr;
      }
      const { data: signed } = await supabaseClient.storage.from('resources').createSignedUrl(path, 60 * 60 * 24);
      return {
        storage_path: path,
        fileName: file.name,
        signedUrl: signed?.signedUrl || ''
      };
    }

    function openAssignResourceModal(resourceId) {
      if (!guardEdit()) return;
      const res = getResourceById(resourceId);
      if (!res) return;
      const html = `
        <h2 class="text-sm font-semibold mb-3">Assign "${res.title}"</h2>
        <form id="assignForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Students</label>
            <div class="grid grid-cols-2 gap-1 max-h-32 overflow-y-auto border border-slate-300 rounded-lg px-2 py-1">
              ${
                state.students.length
                  ? state.students.map(s => `
                      <label class="flex items-center gap-1 text-[11px]">
                        <input type="checkbox" name="studentIds" value="${s.id}">
                        <span>${s.name}</span>
                      </label>
                    `).join('')
                  : '<div class="text-slate-500 text-[11px]">No students yet.</div>'
              }
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Due date</label>
            <input type="date" name="dueDate" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs"
                   value="${new Date().toISOString().slice(0,10)}">
          </div>
          <button type="submit" class="mt-2 px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium">
            Assign
          </button>
        </form>
      `;
      openModal(html, () => {
        document.getElementById('assignForm').onsubmit = (e) => {
          e.preventDefault();
          const form = e.target;
          const ids = [...form.querySelectorAll('input[name="studentIds"]:checked')].map(i => i.value);
          if (!ids.length) {
            alert('Select at least one student.');
            return;
          }
          const dueDate = form.dueDate.value;
          const today = new Date().toISOString().slice(0,10);
          ids.forEach(stuId => {
            state.homework.push({
              id: generateId('hw'),
              studentId: stuId,
              resourceId,
              status: 'To do',
              dueDate,
              assignedDate: today
            });
          });
          saveState();
          closeModal();
          renderResourcesView();
          if (selectedStudentId) {
            renderStudentTimeline(selectedStudentId);
          }
        };
      });
    }

    /***********************
     * DOCUMENTS CRUD      *
     ***********************/
    function getDocumentById(id) {
      return state.documents.find(doc => doc.id === id);
    }

    function openDocumentModal(doc, fixedStudentId) {
      if (!guardEdit()) return;
      const isEdit = !!doc;
      const html = `
        <h2 class="text-sm font-semibold mb-3">${isEdit ? 'Edit document' : 'Add document'}</h2>
        <form id="docForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Student</label>
            <select name="studentId" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              ${
                state.students.map(s => `
                  <option value="${s.id}"
                    ${(doc?.studentId === s.id || fixedStudentId === s.id) ? 'selected' : ''}>
                    ${s.name}
                  </option>
                `).join('')
              }
            </select>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Title</label>
            <input name="title" value="${doc?.title || ''}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Status</label>
            <select name="status" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              <option value="Draft" ${doc?.status === 'Draft' ? 'selected' : ''}>Draft</option>
              <option value="Sent" ${doc?.status === 'Sent' ? 'selected' : ''}>Sent</option>
              <option value="Signed" ${doc?.status === 'Signed' ? 'selected' : ''}>Signed</option>
              <option value="Expired" ${doc?.status === 'Expired' ? 'selected' : ''}>Expired</option>
            </select>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Date</label>
            <input type="date" name="date" value="${doc?.date || new Date().toISOString().slice(0,10)}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Location / notes</label>
            <textarea name="notes" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${doc?.notes || ''}</textarea>
          </div>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-amber-600 text-white text-xs font-medium">
              ${isEdit ? 'Save changes' : 'Add document'}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteDocBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                Delete
              </button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('docForm');
        form.onsubmit = (e) => {
          e.preventDefault();
          const newDoc = {
            id: doc?.id || generateId('doc'),
            studentId: form.studentId.value,
            title: form.title.value.trim(),
            status: form.status.value,
            date: form.date.value,
            notes: form.notes.value.trim(),
            createdAt: doc?.createdAt || new Date().toISOString().slice(0,10)
          };
          if (!newDoc.studentId) {
            alert('Select a student.');
            return;
          }
          if (!newDoc.title) {
            alert('Title required.');
            return;
          }
          if (isEdit) {
            const idx = state.documents.findIndex(d => d.id === doc.id);
            state.documents[idx] = newDoc;
          } else {
            state.documents.push(newDoc);
          }
          saveState();
          closeModal();
          if (selectedStudentId) {
            renderStudentDocuments(selectedStudentId);
            renderStudentTimeline(selectedStudentId);
          }
        };

        if (isEdit) {
          document.getElementById('deleteDocBtn').onclick = () => {
            if (!confirm('Delete this document?')) return;
            state.documents = state.documents.filter(d => d.id !== doc.id);
            saveState();
            closeModal();
            if (selectedStudentId) {
              renderStudentDocuments(selectedStudentId);
              renderStudentTimeline(selectedStudentId);
            }
          };
        }
      });
    }

    /***********************
     * INVOICE CRUD MODAL  *
     ***********************/
    function openInvoiceModal(inv) {
      if (!guardEdit()) return;
      const isEdit = !!inv;
      const html = `
        <h2 class="text-sm font-semibold mb-3">${isEdit ? 'Edit invoice' : 'Create invoice'}</h2>
        <form id="invoiceForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Student</label>
            <select name="studentId" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              ${
                state.students.map(s => `
                  <option value="${s.id}"
                    ${(inv?.studentId === s.id || (!inv && selectedStudentId === s.id)) ? 'selected' : ''}>
                    ${s.name}
                  </option>
                `).join('')
              }
            </select>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Invoice ID</label>
              <input name="id" value="${inv?.id || generateId('inv')}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div>
              <label class="block text-[11px] mb-1">Issue date</label>
              <input type="date" name="issueDate" value="${inv?.issueDate || new Date().toISOString().slice(0,10)}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Due date</label>
              <input type="date" name="dueDate" value="${inv?.dueDate || ''}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div>
              <label class="block text-[11px] mb-1">Base amount (R)</label>
              <input type="number" step="0.01" name="baseAmount" value="${inv?.baseAmount ?? inv?.total ?? ''}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Late fee %</label>
              <div class="flex items-center gap-2">
                <select name="lateFeePercent" class="flex-1 border border-slate-300 rounded-lg px-2 py-1 text-xs">
                  ${[0,5,10,15,20].map(p => `<option value="${p}" ${inv?.lateFeePercent === p ? 'selected' : ''}>${p}%</option>`).join('')}
                </select>
                <label class="flex items-center gap-1 text-[10px]">
                  <input type="checkbox" name="applyLate" ${inv?.lateApplied ? 'checked' : ''}>
                  <span>Apply</span>
                </label>
              </div>
            </div>
            <div>
              <label class="block text-[11px] mb-1">Short notice %</label>
              <div class="flex items-center gap-2">
                <select name="shortNoticePercent" class="flex-1 border border-slate-300 rounded-lg px-2 py-1 text-xs">
                  ${[0,5,10,15].map(p => `<option value="${p}" ${inv?.shortNoticePercent === p ? 'selected' : ''}>${p}%</option>`).join('')}
                </select>
                <label class="flex items-center gap-1 text-[10px]">
                  <input type="checkbox" name="applyShort" ${inv?.shortApplied ? 'checked' : ''}>
                  <span>Apply</span>
                </label>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Total amount (R)</label>
              <input type="number" step="0.01" name="total" value="${inv?.total || ''}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div class="flex items-end">
              <div class="text-[10px] text-slate-500">Computed with fees: <span id="computedTotal">R 0.00</span></div>
            </div>
          </div>
          <div class="flex items-center gap-1 mt-1">
            <input type="checkbox" name="paid" id="invPaid" ${inv?.paid ? 'checked' : ''}>
            <label for="invPaid" class="text-[11px]">Mark as paid</label>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Notes</label>
            <textarea name="notes" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${inv?.notes || ''}</textarea>
          </div>
          <p class="text-[10px] text-slate-500">
            Tip: set a base amount, tick ‚ÄúApply‚Äù on late/short notice fees, and we‚Äôll recalc the total automatically.
          </p>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-emerald-600 text-white text-xs font-medium">
              ${isEdit ? 'Save invoice' : 'Create invoice'}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteInvoiceBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                Delete
              </button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('invoiceForm');

        function computeTotalFromFees() {
          const base = Number(form.baseAmount.value || form.total.value || 0);
          const latePct = form.applyLate.checked ? Number(form.lateFeePercent.value || 0) : 0;
          const shortPct = form.applyShort.checked ? Number(form.shortNoticePercent.value || 0) : 0;
          const total = base * (1 + latePct/100 + shortPct/100);
          if (base > 0) {
            form.total.value = total.toFixed(2);
            const display = document.getElementById('computedTotal');
            if (display) display.textContent = 'R ' + total.toFixed(2);
          }
        }

        ['baseAmount','lateFeePercent','shortNoticePercent'].forEach(name => {
          const el = form[name];
          if (el) el.addEventListener('input', computeTotalFromFees);
        });
        ['applyLate','applyShort'].forEach(name => {
          const el = form[name];
          if (el) el.addEventListener('change', computeTotalFromFees);
        });
        computeTotalFromFees();

        form.onsubmit = (e) => {
          e.preventDefault();
          const newInv = {
            id: form.id.value.trim(),
            studentId: form.studentId.value,
            issueDate: form.issueDate.value,
            dueDate: form.dueDate.value,
            total: Number(form.total.value || 0),
            baseAmount: Number(form.baseAmount.value || 0),
            lateFeePercent: Number(form.lateFeePercent.value || 0),
            shortNoticePercent: Number(form.shortNoticePercent.value || 0),
            lateApplied: form.applyLate.checked,
            shortApplied: form.applyShort.checked,
            paid: form.paid.checked,
            notes: form.notes.value.trim()
          };
          if (!newInv.studentId) {
            alert('Select a student.');
            return;
          }
          if (!newInv.id) {
            alert('Invoice ID is required.');
            return;
          }
          if (isEdit) {
            const idx = state.invoices.findIndex(i => i.id === inv.id);
            state.invoices[idx] = newInv;
          } else {
            const idx = state.invoices.findIndex(i => i.id === newInv.id);
            if (idx >= 0) state.invoices[idx] = newInv;
            else state.invoices.push(newInv);
          }
          saveState();
          closeModal();
          renderFinanceView();
          if (selectedStudentId) renderStudentFinance(selectedStudentId);
        };

        if (isEdit) {
          document.getElementById('deleteInvoiceBtn').onclick = () => {
            if (!confirm('Delete this invoice?')) return;
            state.invoices = state.invoices.filter(i => i.id !== inv.id);
            saveState();
            closeModal();
            renderFinanceView();
            if (selectedStudentId) renderStudentFinance(selectedStudentId);
          };
        }
      });
    }

    /***********************
     * VALIDATION SUMMARY  *
     ***********************
     * Changes this debug pass:
     * - Dark mode completely reskinned: cohesive gradients, proper backgrounds for cards, sidebar, topbar, calendar, inputs.
     * - Layout tightened: centered main content (max-width), rounded cards, consistent spacing, better nav styling.
     * - Innovation / integration: quick ‚ÄúInvoice for this student‚Äù button inside the student finance tab wired to invoice modal; homework, docs, invoices, sessions still visible in the 360¬∞ timeline.
     * All core features (students, schedule, resources + homework, invoices, documents, search, backup, theme, density) remain wired and functional.
     */
  </script>
</body>
</html>
