<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Tutor Control Center ‚Äì Physics ‚Ä¢ Chemistry ‚Ä¢ Maths</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'self'; object-src 'none'; img-src 'self' https: data: blob:; font-src 'self' https://fonts.gstatic.com data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://js.hcaptcha.com; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.deepseek.com; frame-src https://hcaptcha.com https://*.hcaptcha.com https://8x8.vc https://*.8x8.vc;">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- i18n -->
  <script src="./i18n.js"></script>
  <script src="./legal-i18n.js"></script>
  <!-- hCaptcha -->
  <script src="https://js.hcaptcha.com/1/api.js?onload=hcaptchaOnLoad&render=explicit" async defer></script>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Favicons (SVG with cache-bust + inline fallback for GH Pages) -->
  <link rel="icon" type="image/svg+xml" href="./favicon.svg?v=7">
  <link rel="shortcut icon" type="image/svg+xml" href="./favicon.svg?v=7">
  <link rel="apple-touch-icon" href="./favicon.svg?v=7">
  <link rel="alternate icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%234f46e5'/%3E%3Cstop offset='100%25' stop-color='%230ea5e9'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='2' y='2' width='60' height='60' rx='12' fill='%23f8fafc' stroke='%233b82f6' stroke-width='3'/%3E%3Cpath d='M18 18h28v6H34v22h-6V24H18z' fill='url(%23g)'/%3E%3Ccircle cx='46' cy='42' r='6' fill='%23f97316'/%3E%3C/svg%3E">

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg-main-light: #f3f4f6;
      --bg-main-dark: #020617;
      --card-light: #ffffff;
      --card-dark: #020617;
      --text-light: #020617;
      --text-dark: #e5e7eb;
      --border-dark: #1e293b;
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-right: env(safe-area-inset-right, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-left: env(safe-area-inset-left, 0px);
    }

    .hidden {
      display: none !important;
    }

    html {
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:
        radial-gradient(circle at 12% 20%, rgba(79, 70, 229, 0.12), transparent 45%),
        radial-gradient(circle at 88% 18%, rgba(14, 165, 233, 0.14), transparent 46%),
        linear-gradient(135deg, #f8fafc 0%, #eef2ff 50%, #f1f5f9 100%);
      background-attachment: fixed;
      color: var(--text-light);
    }

    body.dark {
      background:
        radial-gradient(circle at 12% 20%, rgba(59, 130, 246, 0.18), transparent 42%),
        radial-gradient(circle at 85% 25%, rgba(34, 211, 238, 0.12), transparent 50%),
        linear-gradient(135deg, #020617 0%, #0b1221 45%, #0b1324 100%);
      background-attachment: fixed;
      color: var(--text-dark);
    }

    body.dark .sidebar,
    body.dark .topbar {
      background: rgba(15, 23, 42, 0.98) !important;
      border-color: var(--border-dark) !important;
      backdrop-filter: blur(18px);
    }

    body.dark #viewsContainer {
      background: transparent !important;
    }

    .card {
      background-color: var(--card-light);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 1.1rem;
      box-shadow:
        0 20px 60px -34px rgba(15, 23, 42, 0.7),
        0 0 0 1px rgba(148, 163, 184, 0.12);
      transition: background 0.25s ease, border-color 0.2s ease, box-shadow 0.25s ease, transform 0.18s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow:
        0 26px 70px -36px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(148, 163, 184, 0.2);
    }

    body.dark .card {
      background: radial-gradient(circle at 0% 0%, #111827 0, #0b1221 48%);
      border-color: var(--border-dark);
      color: var(--text-dark);
      box-shadow:
        0 20px 60px -30px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.85);
    }

    .sidebar {
      background: radial-gradient(circle at 0% 0%, #0f172a 0, #020617 70%);
      border-right: 1px solid #020617;
      box-shadow: 6px 0 24px -20px rgba(15, 23, 42, 0.9);
    }

    .topbar {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(18px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }

    body.dark .topbar {
      color: var(--text-dark);
      border-color: rgba(51, 65, 85, 0.75);
      background: rgba(8, 15, 27, 0.92);
    }

    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.8);
      border-radius: 999px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
      background-color: transparent;
    }

    .badge {
      border-radius: 999px;
      padding: 0.15rem 0.6rem;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .subject-physics {
      background-color: #eff6ff;
      color: #1d4ed8;
    }

    .subject-chemistry {
      background-color: #ecfdf3;
      color: #15803d;
    }

    .subject-maths {
      background-color: #fef2f2;
      color: #b91c1c;
    }

    body.dark .subject-physics {
      background-color: rgba(37, 99, 235, 0.16);
      color: #93c5fd;
    }

    body.dark .subject-chemistry {
      background-color: rgba(22, 163, 74, 0.14);
      color: #6ee7b7;
    }

    body.dark .subject-maths {
      background-color: rgba(248, 113, 113, 0.16);
      color: #fecaca;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 0.35rem;
    }

    .calendar-day {
      min-height: 6rem;
      min-width: 0;
      overflow: visible;
      border-radius: 0.8rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 0.4rem 0.45rem;
      display: flex;
      flex-direction: column;
      font-size: 0.75rem;
      background: rgba(255, 255, 255, 0.88);
      backdrop-filter: blur(12px);
    }

    .calendar-day-header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 0.35rem;
    }

    .calendar-day-title {
      display: flex;
      flex-direction: column;
      min-width: 80px;
      flex: 1 1 120px;
    }

    .calendar-day-action {
      margin-left: auto;
    }

    body.dark .calendar-day {
      background: radial-gradient(circle at 0% 0%, #020617 0, #020617 55%);
      border-color: rgba(51, 65, 85, 0.9);
    }

    .calendar-day.busy-day {
      border-color: rgba(248, 113, 113, 0.65);
      background: rgba(254, 226, 226, 0.72);
    }

    body.dark .calendar-day.busy-day {
      background: rgba(127, 29, 29, 0.18);
      border-color: rgba(248, 113, 113, 0.55);
    }

    .busy-badge {
      font-size: 0.65rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      background: rgba(248, 113, 113, 0.15);
      color: #b91c1c;
      border: 1px solid rgba(248, 113, 113, 0.4);
    }

    body.dark .busy-badge {
      color: #fecaca;
      border-color: rgba(248, 113, 113, 0.4);
    }

    .session-chip-busy {
      background: rgba(248, 113, 113, 0.18);
      color: #b91c1c;
    }

    body.dark .session-chip-busy {
      background: rgba(248, 113, 113, 0.16);
      color: #fecaca;
    }

    .tag-pill {
      font-size: 0.7rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      background-color: #e5e7eb;
      margin-right: 0.25rem;
      margin-bottom: 0.15rem;
      display: inline-flex;
      align-items: center;
      gap: 0.15rem;
    }

    body.dark .tag-pill {
      background-color: rgba(51, 65, 85, 0.9);
      color: #e5e7eb;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 80;
      backdrop-filter: blur(18px);
    }

    .overlay.show {
      display: flex;
    }

    /* Session chips */
    .session-card {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.75rem;
      padding: 0.45rem 0.55rem;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      min-width: 0;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }

    .session-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px -20px rgba(15, 23, 42, 0.4);
    }

    .session-card.completed {
      border-color: rgba(16, 185, 129, 0.6);
      background: rgba(236, 253, 245, 0.95);
    }

    .session-card.completed .session-time,
    .session-card.completed .text-slate-800 {
      text-decoration: line-through;
      opacity: 0.8;
    }

    .session-card.pending-review {
      border-color: rgba(245, 158, 11, 0.55);
      background: rgba(255, 251, 235, 0.95);
    }

    .session-card.voided {
      border-color: rgba(148, 163, 184, 0.55);
      background: rgba(241, 245, 249, 0.95);
      opacity: 0.85;
    }

    .session-card.voided .session-time,
    .session-card.voided .text-slate-800 {
      text-decoration: line-through;
      opacity: 0.7;
    }

    .session-card.no-show-chargeable {
      border-color: rgba(99, 102, 241, 0.5);
      background: rgba(238, 242, 255, 0.95);
    }

    .session-chip {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: rgba(248, 250, 252, 0.7);
    }

    .session-chip-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.25rem;
      min-width: 0;
    }

    .session-chip-row-center {
      justify-content: center;
      width: 100%;
    }

    .session-chip-online {
      background: rgba(14, 165, 233, 0.12);
      color: #0369a1;
      border-color: rgba(14, 165, 233, 0.25);
    }

    .session-chip-inperson {
      background: rgba(148, 163, 184, 0.12);
      color: #475569;
      border-color: rgba(148, 163, 184, 0.3);
    }

    .session-chip-completed {
      background: rgba(16, 185, 129, 0.15);
      color: #047857;
      border-color: rgba(16, 185, 129, 0.35);
    }

    .session-chip-attended {
      background: rgba(245, 158, 11, 0.16);
      color: #b45309;
      border-color: rgba(245, 158, 11, 0.35);
    }

    .session-chip-pending-review {
      background: rgba(245, 158, 11, 0.12);
      color: #92400e;
      border-color: rgba(245, 158, 11, 0.28);
    }

    .session-chip-voided {
      background: rgba(148, 163, 184, 0.16);
      color: #475569;
      border-color: rgba(148, 163, 184, 0.3);
    }

    .session-chip-no-show {
      background: rgba(99, 102, 241, 0.14);
      color: #4338ca;
      border-color: rgba(99, 102, 241, 0.28);
    }

    .session-chip-restored {
      background: rgba(20, 184, 166, 0.14);
      color: #0f766e;
      border-color: rgba(20, 184, 166, 0.28);
    }

    .portal-cta-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      min-height: 44px;
      padding: 0.5rem 0.95rem;
      border-radius: 0.8rem;
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      border: 1px solid transparent;
      transition: transform 0.12s ease, box-shadow 0.18s ease, filter 0.15s ease;
      line-height: 1.2;
      cursor: pointer;
      touch-action: manipulation;
      -webkit-appearance: none;
      appearance: none;
      -webkit-tap-highlight-color: rgba(37, 99, 235, 0.2);
    }

    .portal-cta-btn:hover {
      transform: translateY(-1px);
      filter: brightness(0.98);
    }

    .portal-cta-btn:active {
      transform: translateY(0);
      filter: brightness(0.94);
    }

    .portal-cta-btn:focus-visible {
      outline: 3px solid rgba(37, 99, 235, 0.35);
      outline-offset: 2px;
    }

    .portal-cta-btn[disabled] {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .portal-cta-btn-block {
      width: 100%;
    }

    .portal-cta-contract {
      color: #ffffff;
      background: #b45309;
      border-color: #b45309;
      box-shadow: 0 8px 22px -16px rgba(180, 83, 9, 0.75);
    }

    .portal-cta-join {
      color: #ffffff;
      background: #1d4ed8;
      border-color: #1d4ed8;
      box-shadow: 0 10px 24px -18px rgba(29, 78, 216, 0.8);
    }

    .portal-cta-pay {
      color: #ffffff;
      background: #047857;
      border-color: #047857;
      box-shadow: 0 10px 24px -18px rgba(4, 120, 87, 0.8);
    }

    .portal-cta-subtle {
      color: #334155;
      background: #ffffff;
      border-color: rgba(148, 163, 184, 0.45);
    }

    .portal-consent-card {
      border: 1px solid rgba(245, 158, 11, 0.35);
      background: rgba(255, 251, 235, 0.85);
      border-radius: 0.8rem;
      padding: 0.7rem 0.75rem;
    }

    body.dark .portal-cta-subtle {
      color: #e2e8f0;
      background: rgba(15, 23, 42, 0.75);
      border-color: rgba(148, 163, 184, 0.35);
    }

    body.dark .portal-consent-card {
      border-color: rgba(245, 158, 11, 0.42);
      background: rgba(120, 53, 15, 0.22);
    }

    @media (max-width: 1024px) {
      .sidebar {
        width: 13.5rem;
      }

      .topbar {
        min-height: 4.5rem;
        height: auto;
        padding: 0.75rem 1rem;
        align-items: flex-start;
        flex-wrap: wrap;
      }

      .topbar>div:first-child {
        flex: 1 1 260px;
        max-width: none;
      }

      .topbar>div:last-child {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }

      #viewsContainer {
        padding: 1rem;
      }

      footer {
        padding-inline: 1rem !important;
      }
    }

    @media (hover: none) and (pointer: coarse) {
      .portal-cta-btn {
        min-height: 52px;
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
      }

      .portal-cta-btn:hover {
        transform: none;
        filter: none;
      }

      #parentProfilePrompt .flex,
      #parentEmailOptInCard .flex,
      #parentGuideCard .flex {
        flex-direction: column;
        align-items: stretch;
      }

      #parentCompleteProfileBtn,
      #parentEmailOptInBtn,
      #parentInvoiceAlertActionBtn {
        width: 100%;
      }
    }

    @supports (-webkit-touch-callout: none) {
      @media (hover: none) and (pointer: coarse) {
        body,
        body.dark {
          background-attachment: scroll;
        }

        input[type="text"],
        input[type="search"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
          font-size: 16px !important;
        }
      }
    }

    .session-time {
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .maintenance-banner {
      background: #fff7ed;
      color: #9a3412;
      border-bottom: 1px solid #fed7aa;
    }

    .maintenance-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 95;
      padding: 1.5rem;
    }

    .maintenance-overlay.show {
      display: flex;
    }

    /* AUTH OVERLAY */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(20px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
      padding: 1.5rem;
    }

    .auth-overlay.show {
      display: flex;
    }

    .read-only-banner {
      background: #fef3c7;
      color: #92400e;
      border-bottom: 1px solid #f59e0b;
    }

    .tour-banner {
      background: linear-gradient(135deg, #e0f2fe, #f0f9ff);
      color: #0c4a6e;
      border-bottom: 1px solid #7dd3fc;
    }

    .session-alert-banner {
      background: linear-gradient(135deg, #fee2e2, #fff7ed);
      color: #9a3412;
      border-bottom: 1px solid #fb7185;
    }

    body.dark .session-alert-banner {
      background: linear-gradient(135deg, rgba(153, 27, 27, 0.7), rgba(124, 45, 18, 0.7));
      color: #ffe4e6;
      border-bottom-color: rgba(251, 113, 133, 0.6);
    }

    .tour-pill {
      border: 1px solid #7dd3fc;
      background: #e0f2fe;
      color: #0369a1;
    }

    .owner-locked {
      opacity: 0.55;
      pointer-events: none;
      cursor: not-allowed;
    }

    /* NAV */
    .nav-btn {
      border-radius: 999px;
      margin-inline: 0.5rem;
      margin-bottom: 0.2rem;
      padding-inline: 0.75rem;
      transition: background 0.18s ease, color 0.18s ease, transform 0.12s ease;
    }

    .nav-btn span:first-child {
      width: 1.3rem;
      text-align: center;
    }

    .nav-btn.active,
    .nav-btn.bg-slate-800 {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: #e5e7eb;
      transform: translateY(-1px);
    }

    .nav-btn:hover {
      background-color: rgba(15, 23, 42, 0.6);
    }

    /* INPUTS / TEXTAREAS / SELECTS */
    input[type="text"],
    input[type="search"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    textarea,
    select {
      transition: background 0.16s ease, border-color 0.16s ease, color 0.16s ease, box-shadow 0.16s ease;
    }

    body.dark input[type="text"],
    body.dark input[type="search"],
    body.dark input[type="number"],
    body.dark input[type="date"],
    body.dark input[type="time"],
    body.dark textarea,
    body.dark select {
      background-color: #020617;
      border-color: var(--border-dark);
      color: var(--text-dark);
    }

    body.dark input::placeholder,
    body.dark textarea::placeholder {
      color: #64748b;
    }

    /* THEME TOGGLE BUTTON */
    #themeToggleBtn {
      box-shadow: 0 6px 18px -8px rgba(15, 23, 42, 0.9);
      background: radial-gradient(circle at 30% 20%, #fef3c7 0, #fbbf24 40%, #f97316 100%);
      color: #111827;
    }

    body.dark #themeToggleBtn {
      background: radial-gradient(circle at 30% 20%, #22d3ee 0, #0ea5e9 40%, #1d4ed8 100%);
      color: #e5e7eb;
      box-shadow: 0 6px 20px -8px rgba(59, 130, 246, 0.9);
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .sr-only:focus {
      position: static;
      width: auto;
      height: auto;
      margin: 0;
      overflow: visible;
      clip: auto;
      white-space: normal;
    }

    /* TIGHTEN TABLES IN COMPACT MODE (density) ‚Äì class is toggled on #viewsContainer */
    .dense-mode table td,
    .dense-mode table th {
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
    }

    /* Light utility chips */
    .chip-btn {
      border: 1px solid rgba(148, 163, 184, 0.6);
      border-radius: 999px;
      padding: 0.25rem 0.65rem;
      font-size: 0.75rem;
      transition: all 0.15s ease;
    }

    .chip-btn.active {
      background: linear-gradient(135deg, #4f46e5, #22d3ee);
      color: #f8fafc;
      border-color: transparent;
      box-shadow: 0 10px 30px -20px rgba(79, 70, 229, 0.8);
    }

    .progress-track {
      height: 0.55rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.25);
      overflow: hidden;
    }

    .progress-thumb {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #6366f1, #22c55e);
      transition: width 0.2s ease;
    }

    body.dark .progress-track {
      background: rgba(51, 65, 85, 0.9);
    }

    .hint {
      font-size: 0.7rem;
      color: #94a3b8;
    }

    .lang-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .lang-label {
      font-size: 0.7rem;
      color: #64748b;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .lang-select {
      border: 1px solid #cbd5e1;
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.7rem;
      background: #fff;
      color: #0f172a;
    }

    .lang-banner {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: space-between;
      background: #eef2ff;
      color: #1e1b4b;
      padding: 0.6rem 1rem;
      border-bottom: 1px solid #c7d2fe;
      font-size: 0.75rem;
    }

    .lang-banner-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .lang-banner-actions button {
      border: 1px solid #94a3b8;
      background: #fff;
      color: #0f172a;
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 999px;
      cursor: pointer;
    }

    /* Section breathing */
    .section-shell {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.72), rgba(255, 255, 255, 0.6));
      border: 1px solid rgba(148, 163, 184, 0.22);
      border-radius: 1.3rem;
      padding: 1.25rem;
      box-shadow: 0 24px 70px -48px rgba(15, 23, 42, 0.55);
    }

    body.dark .section-shell {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(15, 23, 42, 0.65));
      border-color: rgba(51, 65, 85, 0.8);
    }
  </style>
</head>

<body>
  <div id="langBanner" class="lang-banner hidden">
    <div data-lang-banner-text data-i18n="lang.banner">Choose language / Elige idioma / Choisissez la langue / ËØ∑ÈÄâÊã©ËØ≠Ë®Ä</div>
    <div class="lang-banner-actions">
      <button type="button" data-lang-button="en">English</button>
      <button type="button" data-lang-button="es">Espa√±ol</button>
      <button type="button" data-lang-button="fr">Fran√ßais</button>
      <button type="button" data-lang-button="zh">‰∏≠ÊñáÔºàÁÆÄ‰ΩìÔºâ</button>
    </div>
  </div>
  <a href="#mainContent"
    class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-indigo-600 text-white px-3 py-2 rounded-lg"
    data-i18n="common.skip_main">Skip to main content</a>
  <div id="appShell" class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="sidebar w-64 text-slate-200 flex flex-col border-r border-slate-900" role="navigation"
      aria-label="Primary">
      <div class="px-4 py-4 flex items-center gap-2 border-b border-slate-800">
        <div class="h-9 w-9 rounded-2xl bg-indigo-500 flex items-center justify-center text-white font-bold text-lg">
          T
        </div>
        <div>
          <div class="font-semibold text-sm" data-platform-name>PLATFORM_NAME</div>
          <div class="text-xs text-slate-400" data-i18n="brand.tagline">Physics ‚Ä¢ Chemistry ‚Ä¢ Maths</div>
        </div>
      </div>

      <nav class="mt-4 flex-1 overflow-y-auto scrollbar-thin pb-2">
        <button data-view="dashboard"
          class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üè†</span><span data-i18n="nav.dashboard">Dashboard</span>
        </button>
        <button data-view="students"
          class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üë•</span><span data-i18n="nav.students">Students</span>
        </button>
        <button data-view="schedule"
          class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üìÖ</span><span data-i18n="nav.schedule">Schedule</span>
        </button>
        <button data-view="resources"
          class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üìö</span><span data-i18n="nav.resources">Resources</span>
        </button>
        <button id="navFinanceBtn" data-view="finance"
          class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üí∞</span><span data-i18n="nav.finance">Finance</span>
        </button>
        <button data-view="settings"
          class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>‚öôÔ∏è</span><span data-i18n="nav.settings">Settings</span>
        </button>
        <button id="navReportsBtn" data-view="reports"
          class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üìä</span><span data-i18n="nav.reports">Reports</span>
        </button>
        <button data-view="profile"
          class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üë§</span><span data-i18n="nav.profile">Profile</span>
        </button>
        <button data-view="portal" id="navPortalBtn"
          class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition hidden">
          <span>üìÇ</span><span data-i18n="nav.portal">My portal</span>
        </button>
        <button data-view="parent-portal" id="navParentPortalBtn"
          class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition hidden">
          <span>üë™</span><span data-i18n="nav.parent_portal">Parent portal</span>
        </button>
      </nav>

    </aside>

    <!-- Main content -->
    <div class="flex-1 flex flex-col" id="mainContent" role="main">
      <!-- Top bar -->
      <header class="topbar h-16 flex items-center justify-between px-6 gap-4">
        <!-- Search -->
        <div class="flex-1 max-w-xl">
          <div class="relative">
            <input id="globalSearchInput" type="search" placeholder="Search students, sessions, resources, invoices‚Ä¶"
              data-i18n-attr="placeholder:top.search.placeholder"
              class="w-full rounded-2xl border border-slate-200 px-10 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white/80">
            <span class="absolute left-3 top-1.5">üîç</span>
            <div id="globalSearchResults"
              class="absolute mt-1 w-full bg-white border border-slate-200 rounded-xl shadow-xl text-xs hidden max-h-64 overflow-y-auto z-20">
            </div>
          </div>
        </div>

        <!-- Quick actions -->
        <div class="flex items-center gap-2">
          <button id="quickAddStudentBtn" data-owner-only
            class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700 shadow-sm">
            <span data-i18n="top.add_student">Ôºã Student</span>
          </button>
          <button id="quickAddSessionBtn" data-owner-only
            class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-slate-900 text-white text-xs font-medium hover:bg-slate-800 shadow-sm">
            <span data-i18n="top.add_session">Ôºã Session</span>
          </button>
          <button id="refreshBtn"
            class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl border border-slate-300 text-xs font-medium hover:bg-slate-50">
            <span data-i18n="top.refresh">‚ü≥ Refresh</span>
          </button>
          <button id="signOutBtn"
            class="hidden inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl border border-slate-300 text-xs font-medium hover:bg-slate-50">
            <span data-i18n="top.sign_out">‚èè Sign out</span>
          </button>
          <span id="tourBadge"
            class="hidden inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl text-xs font-medium tour-pill">
            <span data-i18n="top.tour_mode">üö© Tour mode</span>
          </span>
          <button id="exitTourBtn"
            class="hidden inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl border border-slate-300 text-xs font-medium hover:bg-slate-50">
            <span data-i18n="top.exit_tour">Exit tour</span>
          </button>

          <!-- Theme toggle -->
          <button id="themeToggleBtn"
            class="ml-2 inline-flex items-center justify-center h-8 w-8 rounded-full border border-slate-300 text-sm">
            üåô
          </button>
          <div class="lang-row ml-2">
            <label class="lang-label" data-i18n="top.language_label">Language / Idioma / Langue / ‰∏≠Êñá</label>
            <select class="lang-select" data-lang-select>
              <option value="en" data-i18n="lang.option.en">English</option>
              <option value="es" data-i18n="lang.option.es">Espa√±ol</option>
              <option value="fr" data-i18n="lang.option.fr">Fran√ßais</option>
              <option value="zh" data-i18n="lang.option.zh">‰∏≠ÊñáÔºàÁÆÄ‰ΩìÔºâ</option>
            </select>
          </div>
        </div>
      </header>
      <div id="tourBanner" class="tour-banner hidden px-6 py-2 text-xs">
        <span data-i18n="banner.tour">Tour mode (verification): explore the full product safely. Changes stay in this browser only.</span>
      </div>
      <div id="readOnlyBanner" class="read-only-banner hidden px-6 py-2 text-xs">
        <span data-i18n="banner.read_only">Read-only mode: sign in as the owner to edit.</span>
      </div>
      <div id="maintenanceBanner" class="maintenance-banner hidden px-6 py-2 text-xs"></div>
      <div id="supabaseStatusBanner" class="hidden px-6 py-2 text-xs bg-amber-50 text-amber-900 border-b border-amber-200"></div>
      <div id="sessionAlertBanner" class="session-alert-banner hidden px-6 py-2 text-xs"></div>

      <!-- Views container -->
      <main id="viewsContainer"
        class="flex-1 overflow-y-auto bg-transparent px-8 py-8 space-y-8 max-w-7xl mx-auto w-full">
        <!-- Dashboard -->
        <section id="view-dashboard" class="view">
          <div class="section-shell space-y-6">
            <div id="ownerDashboardPanelNav" class="hidden card p-3 space-y-2" data-owner-only>
              <div class="text-[11px] text-slate-500">Dashboard sections</div>
              <div class="flex flex-wrap items-center gap-2">
                <button data-owner-dashboard-panel-target="overview" class="owner-panel-btn px-3 py-1.5 rounded-xl border border-slate-300 text-[11px]">Overview</button>
                <button data-owner-dashboard-panel-target="analytics" class="owner-panel-btn px-3 py-1.5 rounded-xl border border-slate-300 text-[11px]">Analytics</button>
                <button data-owner-dashboard-panel-target="support" class="owner-panel-btn px-3 py-1.5 rounded-xl border border-slate-300 text-[11px]">Support</button>
              </div>
            </div>

            <div data-owner-dashboard-panel="overview" class="space-y-6">
              <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
              <div class="card p-5 col-span-8 space-y-3">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-[10px] uppercase tracking-wide text-slate-500" data-i18n="dashboard.weekly_direction">Weekly direction</p>
                    <h3 class="text-sm font-semibold" data-i18n="dashboard.focus_reflection">Focus & reflection</h3>
                  </div>
                  <span class="hint" data-i18n="dashboard.set_in_settings">Set in Settings</span>
                </div>
                <div id="reflectionText" class="text-sm text-slate-700 leading-relaxed">
                  <span data-i18n="dashboard.reflection_placeholder">Add a short note in settings to keep this week intentional.</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                  <div class="border border-slate-200 rounded-lg p-3 bg-white/70">
                    <div class="text-[10px] text-slate-500" data-i18n="dashboard.next_session">Next session</div>
                    <div id="focusNextSession" class="font-semibold" data-i18n="dashboard.no_sessions_planned">No sessions planned</div>
                    <div id="focusNextSessionMeta" class="text-[10px] text-slate-500"></div>
                  </div>
                  <div class="border border-slate-200 rounded-lg p-3 bg-white/70">
                    <div class="text-[10px] text-slate-500" data-i18n="dashboard.homework_due">Homework due soon</div>
                    <div id="focusHomework" class="font-semibold">0</div>
                    <div class="text-[10px] text-slate-500" data-i18n="dashboard.due_within_5_days">Due within 5 days</div>
                  </div>
                  <div class="border border-slate-200 rounded-lg p-3 bg-white/70">
                    <div class="text-[10px] text-slate-500" data-i18n="dashboard.overdue_invoices">Overdue invoices</div>
                    <div id="focusInvoices" class="font-semibold text-rose-600">0</div>
                    <div class="text-[10px] text-slate-500" data-i18n="dashboard.follow_up">Follow up today</div>
                  </div>
                </div>
              </div>
              <div class="card p-5 col-span-4 space-y-4">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold" data-i18n="dashboard.goals">Goals</h3>
                  <span class="hint" data-i18n="dashboard.live_progress">Live progress</span>
                </div>
                <div>
                  <div class="flex items-center justify-between text-[11px] mb-1">
                    <span data-i18n="dashboard.hours_this_week">Hours this week</span>
                    <span id="goalHoursLabel">0 / 0h</span>
                  </div>
                  <div class="progress-track">
                    <div id="goalHoursProgress" class="progress-thumb" style="width:0%"></div>
                  </div>
                </div>
                <div>
                  <div class="flex items-center justify-between text-[11px] mb-1">
                    <span data-i18n="dashboard.income_this_month">Income this month</span>
                    <span id="goalIncomeLabel">R 0 / R 0</span>
                  </div>
                  <div class="progress-track">
                    <div id="goalIncomeProgress" class="progress-thumb" style="width:0%"></div>
                  </div>
                </div>
              </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                <div class="card p-5 col-span-1">
                  <div class="flex items-center justify-between mb-1">
                    <h3 class="text-xs font-medium text-slate-500" data-i18n="dashboard.active_students">Active students</h3>
                  </div>
                  <div id="kpiStudents" class="text-2xl font-semibold text-slate-900">0</div>
                  <p class="text-[11px] text-slate-500 mt-1" data-i18n="dashboard.active_students_hint">Students with at least one session in the last 30 days.</p>
                </div>
                <div class="card p-5 col-span-1">
                  <h3 class="text-xs font-medium text-slate-500 mb-1" data-i18n="dashboard.hours_this_week">Hours this week</h3>
                  <div id="kpiHoursWeek" class="text-2xl font-semibold text-slate-900">0</div>
                  <p class="text-[11px] text-slate-500 mt-1" data-i18n="dashboard.hours_week_hint">Sum of completed sessions.</p>
                </div>
                <div class="card p-5 col-span-1">
                  <h3 class="text-xs font-medium text-slate-500 mb-1" data-i18n="dashboard.expected_income_month">Expected income (month)</h3>
                  <div id="kpiExpectedIncome" class="text-2xl font-semibold text-slate-900">0</div>
                  <p class="text-[11px] text-slate-500 mt-1" data-i18n="dashboard.expected_income_hint">From issued & upcoming sessions.</p>
                </div>
                <div class="card p-5 col-span-1">
                  <h3 class="text-xs font-medium text-slate-500 mb-1" data-i18n="dashboard.overdue_invoices">Overdue invoices</h3>
                  <div id="kpiOverdue" class="text-2xl font-semibold text-rose-600">0</div>
                  <p class="text-[11px] text-slate-500 mt-1" data-i18n="dashboard.overdue_hint">Count of unpaid invoices past due date.</p>
                </div>
              </div>
            </div>

            <div data-owner-dashboard-panel="analytics" class="space-y-6">
              <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
                <div class="card p-5 col-span-7">
                  <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-semibold" data-i18n="dashboard.subject_mix">Subject mix (hours)</h3>
                  </div>
                  <canvas id="subjectMixChart" class="w-full h-64"></canvas>
                </div>
                <div class="card p-5 col-span-5">
                  <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-semibold" data-i18n="dashboard.upcoming_next_7_days">Upcoming sessions (next 7 days)</h3>
                  </div>
                  <ul id="upcomingSessionsList" class="text-xs space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
                </div>
              </div>

              <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
                <div class="card p-5 col-span-4">
                  <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-semibold" data-i18n="dashboard.at_risk">At-risk students</h3>
                    <span class="hint" data-i18n="dashboard.at_risk_hint">No session in 21+ days</span>
                  </div>
                  <ul id="atRiskList" class="text-xs space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
                </div>
                <div class="card p-5 col-span-4">
                  <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-semibold" data-i18n="dashboard.homework_due">Homework due soon</h3>
                    <span class="hint" data-i18n="dashboard.next_5_days">Next 5 days</span>
                  </div>
                  <ul id="dueHomeworkList" class="text-xs space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
                </div>
                <div class="card p-5 col-span-4">
                  <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-semibold" data-i18n="dashboard.prep_queue">Prep queue (next 3)</h3>
                    <span class="hint" data-i18n="dashboard.click_to_open">Click to open</span>
                  </div>
                  <ul id="prepQueueList" class="text-xs space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
                </div>
              </div>
            </div>

            <div data-owner-dashboard-panel="support" class="space-y-6">
              <div class="card p-5 space-y-3" id="ownerSupportCard" data-owner-only>
                <div class="flex items-center justify-between">
                  <div>
                    <h3 class="text-sm font-semibold">Support inbox</h3>
                    <p class="text-[11px] text-slate-500">Parent and student tickets.</p>
                  </div>
                  <div class="flex items-center gap-2">
                    <button id="ownerSupportRefreshBtn"
                      class="portal-cta-btn portal-cta-subtle text-[11px]">Refresh</button>
                    <button id="ownerSupportNewBtn"
                      class="portal-cta-btn portal-cta-pay text-[11px]">New ticket</button>
                  </div>
                </div>
                <div id="ownerSupportStatus" class="text-[11px] text-slate-500 hidden"></div>
                <ul id="ownerSupportTickets" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin text-xs"></ul>
              </div>
            </div>
          </div>
        </section>

        <!-- Students -->
        <section id="view-students" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold" data-i18n="students.title">Students</h2>
                <p class="text-xs text-slate-500" data-i18n="students.subtitle">Manage profiles, 360¬∞ timelines and subject mix.</p>
              </div>
              <button id="addStudentBtn" data-owner-only
                class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700 shadow-sm">
                <span data-i18n="students.add_student">Ôºã Add student</span>
              </button>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
              <!-- Student list -->
              <div class="card p-4 col-span-1 max-h-[75vh] overflow-y-auto scrollbar-thin">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">All students</h3>
                </div>
                <div class="flex flex-wrap gap-2 mb-2 text-[11px]">
                  <select id="studentSubjectFilter" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                    <option value="" data-i18n="subjects.all">All subjects</option>
                    <option value="Physics" data-i18n="subjects.physics">Physics</option>
                    <option value="Chemistry" data-i18n="subjects.chemistry">Chemistry</option>
                    <option value="Maths" data-i18n="subjects.maths">Maths</option>
                  </select>
                  <select id="studentActivityFilter" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                    <option value="" data-i18n="students.activity_all">All activity</option>
                    <option value="active" data-i18n="students.activity_active">Active (&lt;14 days)</option>
                    <option value="quiet" data-i18n="students.activity_quiet">Quiet (14+ days)</option>
                  </select>
                </div>
                <ul id="studentsList" class="space-y-2 text-xs"></ul>
                <div class="border-t border-slate-200 mt-4 pt-3 space-y-2" data-owner-only>
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold" data-i18n="parents.title">Parents</h3>
                    <button id="addParentBtn" class="px-2 py-1 rounded-lg border border-slate-300 text-[11px]">
                      <span data-i18n="parents.add">Ôºã Add</span>
                    </button>
                  </div>
                  <ul id="parentsList" class="space-y-2 text-xs"></ul>
                </div>
              </div>

              <!-- Student detail -->
              <div class="card p-4 col-span-2 max-h-[75vh] overflow-y-auto scrollbar-thin">
                <div id="studentDetailEmpty" class="text-xs text-slate-500" data-i18n="students.select_prompt">
                  Select a student on the left to view their 360¬∞ panel.
                </div>
                <div id="studentDetail" class="hidden text-xs space-y-3">
                  <div class="flex items-center justify-between">
                    <div>
                      <div id="studentDetailName" class="text-base font-semibold"></div>
                      <div id="studentDetailMeta" class="text-[11px] text-slate-500"></div>
                      <div id="studentScheduleMeta" class="text-[10px] text-slate-500"></div>
                      <div id="studentContractMeta" class="text-[10px] text-slate-500"></div>
                    </div>
                    <div class="flex flex-wrap items-center gap-2">
                      <span id="studentLoginCodeBadge"
                        class="hidden px-2 py-1 text-[10px] rounded-lg bg-indigo-50 text-indigo-700 font-mono border border-indigo-100"></span>
                      <button id="studentLoginCodeCopy" data-owner-only
                        class="hidden px-2 py-1 text-[10px] rounded-lg border border-indigo-200 text-indigo-700 hover:bg-indigo-50">
                        <span data-i18n="students.copy_code">Copy code</span>
                      </button>
                      <span id="studentContractBadge"
                        class="px-2 py-1 text-[11px] rounded-lg bg-rose-100 text-rose-700 font-semibold" data-i18n="students.contract_invalid">INVALID ‚Äì
                        CONTRACT NOT SIGNED</span>
                      <button id="studentContractLinkBtn"
                        class="px-2 py-1 text-[10px] rounded-lg border border-slate-300 hover:bg-slate-50">
                        <span data-i18n="students.copy_parent_link">Copy parent link</span>
                      </button>
                      <button id="studentContractDeleteBtn" data-owner-only
                        class="px-2 py-1 text-[10px] rounded-lg border border-rose-300 text-rose-700 hover:bg-rose-50 hidden">
                        <span data-i18n="students.remove_contract">Remove contract</span>
                      </button>
                    </div>
                    <button id="editStudentBtn" data-owner-only
                      class="px-2 py-1 text-[11px] rounded-lg border border-slate-300 hover:bg-slate-50">
                      <span data-i18n="common.edit">Edit</span>
                    </button>
                  </div>

                  <!-- Subject mix bar -->
                  <div>
                    <h4 class="text-[11px] font-semibold mb-1" data-i18n="students.subject_mix_30">Subject mix (last 30 days)</h4>
                    <div class="w-full h-3 rounded-full bg-slate-100 overflow-hidden flex text-[10px]">
                      <div id="mixPhysics" class="bg-indigo-500 h-full text-center text-white"></div>
                      <div id="mixChemistry" class="bg-emerald-500 h-full text-center text-white"></div>
                      <div id="mixMaths" class="bg-rose-500 h-full text-center text-white"></div>
                    </div>
                    <div class="flex justify-between mt-1 text-[10px] text-slate-500">
                      <span data-i18n="subjects.physics">Physics</span>
                      <span data-i18n="subjects.chemistry">Chemistry</span>
                      <span data-i18n="subjects.maths">Maths</span>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                      <div class="text-[10px] text-slate-500" data-i18n="students.hours_30">Hours (last 30 days)</div>
                      <div id="engagementHours" class="text-lg font-semibold">0</div>
                    </div>
                    <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                      <div class="text-[10px] text-slate-500" data-i18n="students.streak_weeks">Streak (weeks)</div>
                      <div id="engagementStreak" class="text-lg font-semibold">0</div>
                      <div class="text-[10px] text-slate-500" id="engagementNextGap"></div>
                    </div>
                    <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                      <div class="text-[10px] text-slate-500" data-i18n="students.homework_completion">Homework completion</div>
                      <div class="flex items-center justify-between">
                        <div id="engagementHomework" class="text-lg font-semibold">0%</div>
                        <div class="progress-track w-24">
                          <div id="engagementHomeworkProgress" class="progress-thumb" style="width:0%"></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                      <div class="flex items-center justify-between mb-1">
                        <h4 class="text-[11px] font-semibold" data-i18n="students.followups">Follow-ups</h4>
                        <span class="hint" data-i18n="students.personal_tasks">Personal tasks</span>
                      </div>
                      <ul id="studentTodosList" class="space-y-1 text-[11px]"></ul>
                      <form id="studentTodoForm" class="mt-2 grid grid-cols-3 gap-1 text-[11px]">
                        <input name="todoText" placeholder="Email parent‚Ä¶"
                          data-i18n-attr="placeholder:students.todo_placeholder"
                          class="col-span-2 border border-slate-300 rounded-lg px-2 py-1">
                        <input name="todoDue" type="date" class="border border-slate-300 rounded-lg px-2 py-1">
                        <button class="col-span-3 bg-slate-900 text-white rounded-lg py-1" data-i18n="students.add_followup">Add follow-up</button>
                      </form>
                    </div>
                    <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                      <div class="flex items-center justify-between mb-1">
                        <h4 class="text-[11px] font-semibold" data-i18n="students.checkins">Check-ins</h4>
                        <span class="hint" data-i18n="students.timestamped_notes">Timestamped notes</span>
                      </div>
                      <ul id="studentCheckinsList"
                        class="space-y-1 text-[11px] max-h-32 overflow-y-auto scrollbar-thin"></ul>
                      <form id="studentCheckinForm" class="mt-2 space-y-1 text-[11px]">
                        <textarea name="checkinText" rows="2"
                          class="w-full border border-slate-300 rounded-lg px-2 py-1"
                          placeholder="Short note..."
                          data-i18n-attr="placeholder:students.checkin_placeholder"></textarea>
                        <button class="w-full bg-indigo-600 text-white rounded-lg py-1" data-i18n="students.add_checkin">Add check-in</button>
                      </form>
                    </div>
                    <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                      <div class="flex items-center justify-between mb-1">
                        <h4 class="text-[11px] font-semibold" data-i18n="students.contracts">Lesson contracts</h4>
                        <button id="uploadContractBtn"
                          class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50">
                          <span data-i18n="students.upload_scan">Upload scan</span>
                        </button>
                      </div>
                      <ul id="studentContractsList"
                        class="space-y-1 text-[11px] max-h-32 overflow-y-auto scrollbar-thin"></ul>
                      <p class="hint mt-1" data-i18n="students.contracts_hint">PDF or image stored locally; attach one per agreement.</p>
                    </div>
                  </div>

                  <!-- Tabs for detail -->
                  <div class="border-b border-slate-200 flex gap-4 text-[11px]" id="studentDetailTabs">
                    <button data-student-tab="timeline"
                      class="student-tab border-b-2 border-indigo-500 pb-1 font-medium">
                      <span data-i18n="students.tab_timeline">Timeline</span>
                    </button>
                    <button data-student-tab="sessions" class="student-tab pb-1 text-slate-500">
                      <span data-i18n="students.tab_sessions">Sessions</span>
                    </button>
                    <button data-student-tab="documents" class="student-tab pb-1 text-slate-500">
                      <span data-i18n="students.tab_documents">Documents</span>
                    </button>
                    <button data-student-tab="finance" class="student-tab pb-1 text-slate-500">
                      <span data-i18n="students.tab_finance">Finance</span>
                    </button>
                    <button data-student-tab="messages" class="student-tab pb-1 text-slate-500">
                      <span data-i18n="students.tab_messages">Messages</span>
                    </button>
                  </div>
                  <div id="studentUnsignedNotice"
                    class="border border-rose-300 bg-rose-50 text-rose-800 text-[11px] rounded-lg px-3 py-2 hidden">
                    <span data-i18n="students.contract_unsigned_notice">Contract not signed. Share the parent link so the guardian can sign. Some features may be limited until signing is complete.</span>
                  </div>

                  <div id="studentTab-timeline" class="student-tab-pane space-y-2 mt-2">
                    <ul id="studentTimeline" class="space-y-2 text-[11px]"></ul>
                  </div>
                  <div id="studentTab-sessions" class="student-tab-pane hidden mt-2">
                    <ul id="studentSessionsList" class="space-y-2 text-[11px]"></ul>
                  </div>
                  <div id="studentTab-documents" class="student-tab-pane hidden mt-2">
                    <div class="flex items-center justify-between mb-1">
                      <h4 class="text-[11px] font-semibold" data-i18n="students.documents">Documents</h4>
                      <button id="addDocumentForStudentBtn" data-owner-only
                        class="px-2 py-1 rounded-lg border border-slate-300 text-[10px] hover:bg-slate-50">
                        <span data-i18n="students.add_document">Ôºã Add document</span>
                      </button>
                    </div>
                    <ul id="studentDocumentsList" class="space-y-2 text-[11px]"></ul>
                  </div>
                  <div id="studentTab-finance" class="student-tab-pane hidden mt-2">
                    <div class="flex items-center justify-between mb-1">
                      <h4 class="text-[11px] font-semibold" data-i18n="students.invoices_balance">Invoices & balance</h4>
                      <button id="studentCreateInvoiceBtn" data-owner-only
                        class="px-2 py-1 rounded-lg border border-emerald-500 text-emerald-600 text-[10px] hover:bg-emerald-50">
                        <span data-i18n="students.add_invoice_student">Ôºã Invoice for this student</span>
                      </button>
                    </div>
                    <div id="studentBalance" class="text-xs mb-1"></div>
                    <ul id="studentInvoicesList" class="space-y-1 text-[11px]"></ul>
                  </div>
                  <div id="studentTab-messages" class="student-tab-pane hidden mt-2">
                    <div class="flex items-center justify-between mb-1">
                      <h4 class="text-[11px] font-semibold" data-i18n="students.messages">Messages</h4>
                      <div class="flex items-center gap-2">
                        <span class="hint" data-i18n="students.messages_hint">Owner & student thread</span>
                        <button id="studentMessageAiBtn" data-owner-only
                          class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50">
                          <span data-i18n="students.draft_ai">Draft with AI</span>
                        </button>
                      </div>
                    </div>
                    <ul id="studentMessagesList" class="space-y-1 text-[11px] max-h-64 overflow-y-auto scrollbar-thin">
                    </ul>
                    <form id="studentMessageForm" class="mt-2 space-y-1 text-[11px]">
                      <textarea name="messageText" rows="2" class="w-full border border-slate-300 rounded-lg px-2 py-1"
                        placeholder="Write a note to this student"
                        data-i18n-attr="placeholder:students.message_placeholder"></textarea>
                      <button class="w-full bg-slate-900 text-white rounded-lg py-1" data-i18n="common.send">Send</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
        </section>

        <!-- Schedule -->
        <section id="view-schedule" class="view hidden">
          <div class="section-shell space-y-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-[10px] uppercase tracking-wide text-slate-500" data-i18n="schedule.planner">Planner</p>
                <h2 class="text-lg font-semibold" data-i18n="schedule.title">Schedule</h2>
                <p class="text-xs text-slate-500" data-i18n="schedule.subtitle">Week grid, quick stats, and conflict signals.</p>
              </div>
              <div class="flex items-center gap-2">
                <button id="schedulePrevWeek"
                  class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs hover:bg-slate-50" data-i18n="schedule.prev">‚Üê Prev</button>
                <button id="scheduleToday"
                  class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs hover:bg-slate-50" data-i18n="schedule.today">Today</button>
                <button id="scheduleNextWeek"
                  class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs hover:bg-slate-50" data-i18n="schedule.next">Next ‚Üí</button>
                <button id="addSessionBtn" data-owner-only
                  class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium hover:bg-slate-800 shadow-sm">
                  <span data-i18n="schedule.add_session">Ôºã Session</span>
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-4 gap-4 items-start">
              <!-- Left column: week grid -->
              <div class="card p-5 xl:col-span-3 space-y-3 h-full">
                <div class="flex items-center justify-between text-xs">
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-slate-700"><span
                        class="h-2 w-2 rounded-full bg-indigo-500"></span> <span data-i18n="subjects.physics">Physics</span></span>
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-slate-700"><span
                        class="h-2 w-2 rounded-full bg-emerald-500"></span> <span data-i18n="subjects.chemistry">Chemistry</span></span>
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-slate-700"><span
                        class="h-2 w-2 rounded-full bg-rose-500"></span> <span data-i18n="subjects.maths">Maths</span></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <button id="exportIcsBtn"
                      class="px-2 py-1 rounded-lg border border-indigo-300 text-indigo-700 hover:bg-indigo-50" data-i18n="schedule.export_ics">Export
                      ICS</button>
                    <div id="scheduleWeekLabel" class="font-medium text-slate-700"></div>
                  </div>
                </div>
                <div id="dayLoadRow" class="grid grid-cols-7 gap-2 text-[11px]"></div>
                <div class="calendar-grid text-[11px] min-h-[520px]" id="scheduleCalendarGrid">
                  <!-- days injected here -->
                </div>
                <div class="flex items-center justify-between text-[10px] text-slate-500">
                  <span data-i18n="schedule.quick_actions_hint">Click a session chip to open quick actions.</span>
                  <span class="flex items-center gap-2">
                    <span
                      class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 border border-amber-200">‚ö†
                      <span data-i18n="schedule.clash">Clash</span></span>
                    <span
                      class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-sky-50 text-sky-700 border border-sky-200">‚è±
                      <span data-i18n="schedule.tight_gap">Tight gap</span></span>
                  </span>
                </div>
              </div>

              <!-- Right column: daily + conflict cards -->
              <div class="flex flex-col gap-4 h-full">
                <div class="card p-4 text-xs space-y-2 h-full">
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold" data-i18n="schedule.today_title">Today</h3>
                    <span class="text-[10px] text-slate-500" data-i18n="schedule.live_list">Live list</span>
                  </div>
                  <ul id="todaySessionsList" class="space-y-1 max-h-60 overflow-y-auto scrollbar-thin"></ul>
                </div>
                <div class="card p-4 text-xs space-y-2">
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold" data-i18n="schedule.potential_clashes">Potential clashes</h3>
                    <span class="text-[10px] text-amber-600" data-i18n="schedule.overlap_same_student">Overlap same student</span>
                  </div>
                  <ul id="clashList" class="space-y-1 max-h-32 overflow-y-auto scrollbar-thin text-[11px]"></ul>
                </div>
                <div class="card p-4 text-xs space-y-2">
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold" data-i18n="schedule.tight_transitions">Tight transitions</h3>
                    <span class="text-[10px] text-slate-500" data-i18n="schedule.gap_under_20">&lt; 20 min gap</span>
                  </div>
                  <ul id="tightTransitionsList" class="space-y-1 max-h-32 overflow-y-auto scrollbar-thin text-[11px]">
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Resources -->
        <section id="view-resources" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold" data-i18n="resources.title">Resources</h2>
                <p class="text-xs text-slate-500" data-i18n="resources.subtitle">Worksheets, lectures, and homework tracking. Upload files for quick download.</p>
              </div>
              <button id="addResourceBtn" data-owner-only
                class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700 shadow-sm">
                <span data-i18n="resources.add_resource">Ôºã Add resource</span>
              </button>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
              <div class="card p-4 col-span-2 max-h-[75vh] overflow-y-auto scrollbar-thin">
                <div class="flex items-center justify-between mb-2 text-xs">
                  <div class="flex gap-2">
                    <select id="resourceSubjectFilter" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                      <option value="" data-i18n="subjects.all">All subjects</option>
                      <option value="Physics" data-i18n="subjects.physics">Physics</option>
                      <option value="Chemistry" data-i18n="subjects.chemistry">Chemistry</option>
                      <option value="Maths" data-i18n="subjects.maths">Maths</option>
                    </select>
                    <input id="resourceSearchInput" type="text" placeholder="Search resources"
                      data-i18n-attr="placeholder:resources.search_placeholder"
                      class="border border-slate-300 rounded-xl px-2 py-1 text-xs w-40">
                  </div>
                </div>
                <div id="resourceTagFilters" class="flex flex-wrap gap-2 mb-3 text-[10px]"></div>
                <ul id="resourcesList" class="space-y-2 text-xs"></ul>
              </div>

              <!-- Homework board -->
              <div id="resourcesHomeworkBoard" class="card p-4 col-span-1 max-h-[75vh] overflow-y-auto scrollbar-thin text-xs">
                <h3 id="homeworkBoardTitle" class="text-sm font-semibold mb-2" data-i18n="resources.homework_board">Homework board</h3>
                <div class="grid grid-cols-3 gap-2 text-[11px]">
                  <div>
                    <div class="font-semibold mb-1" data-i18n="resources.hw_todo">To Do</div>
                    <ul id="hwTodo" class="space-y-1"></ul>
                  </div>
                  <div>
                    <div class="font-semibold mb-1" data-i18n="resources.hw_in_progress">In progress</div>
                    <ul id="hwInProgress" class="space-y-1"></ul>
                  </div>
                  <div>
                    <div class="font-semibold mb-1" data-i18n="schedule.completed">Completed</div>
                    <ul id="hwDone" class="space-y-1"></ul>
                  </div>
                </div>
                <p id="homeworkBoardHint" class="mt-2 text-[10px] text-slate-500" data-i18n="resources.hw_hint">Change status using the dropdown on each card.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Finance -->
        <section id="view-finance" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold" data-i18n="finance.title">Finance</h2>
                <p class="text-xs text-slate-500" data-i18n="finance.subtitle">Invoices, balances & overdue reminders.</p>
              </div>
              <div class="flex items-center gap-2">
                <button id="toggleVoidedInvoicesBtn" data-owner-only
                  class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl border border-slate-300 text-xs font-medium hover:bg-slate-50">
                  <span data-i18n="finance.show_voided">Show voided</span>
                </button>
                <button id="addInvoiceBtn" data-owner-only
                  class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-emerald-600 text-white text-xs font-medium hover:bg-emerald-700 shadow-sm">
                  <span data-i18n="finance.add_invoice">Ôºã Create invoice</span>
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 text-xs">
              <div class="card p-4 col-span-2 max-h-[75vh] overflow-y-auto scrollbar-thin">
                <h3 class="text-sm font-semibold mb-2" data-i18n="finance.student_balances">Student balances</h3>
                <table class="w-full text-[11px]">
                  <thead>
                    <tr class="text-left text-[10px] text-slate-500 border-b border-slate-200">
                      <th class="py-1 pr-1" data-i18n="finance.table_student">Student</th>
                      <th class="py-1 pr-1 text-right" data-i18n="finance.table_balance">Balance</th>
                      <th class="py-1 pr-1 text-right" data-i18n="finance.table_unpaid">Unpaid invoices</th>
                    </tr>
                  </thead>
                  <tbody id="financeStudentTable"></tbody>
                </table>
              </div>
              <div class="card p-4 col-span-1 max-h-[75vh] overflow-y-auto scrollbar-thin">
                <h3 class="text-sm font-semibold mb-2" data-i18n="dashboard.overdue_invoices">Overdue invoices</h3>
                <ul id="overdueInvoicesList" class="space-y-2 text-[11px]"></ul>
                <div class="mt-3 space-y-2" data-owner-only>
                  <button id="sendOverdueReminderEmailsBtn"
                    class="portal-cta-btn portal-cta-pay portal-cta-btn-block text-[11px]">
                    Send overdue reminder emails
                  </button>
                  <button id="sendOverdueReminderTestEmailBtn"
                    class="portal-cta-btn portal-cta-subtle portal-cta-btn-block text-[11px]">
                    Send test reminder email (eh8125809@gmail.com)
                  </button>
                  <div id="sendOverdueReminderEmailsStatus" class="hidden text-[10px] rounded-lg border px-2 py-1"></div>
                </div>
                <p class="mt-2 text-[10px] text-slate-500" data-i18n="finance.reminder_hint">Click ‚ÄúReminder text‚Äù to generate a polite message you can paste into email or chat.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 text-xs mt-4">
              <div class="card p-4 col-span-2">
                <h3 class="text-sm font-semibold mb-2" data-i18n="finance.unbilled_hours">Unbilled hours</h3>
                <ul id="unbilledList" class="space-y-2 text-[11px]"></ul>
                <p class="mt-2 text-[10px] text-slate-500" data-i18n="finance.unbilled_hint">Calculated from sessions since the last invoice per student (using their rate).</p>
              </div>
              <div class="card p-4 col-span-1">
                <h3 class="text-sm font-semibold mb-2" data-i18n="finance.cashflow_forecast">Cashflow forecast (14 days)</h3>
                <div id="forecastSummary" class="text-sm font-semibold"></div>
                <ul id="forecastList" class="space-y-1 text-[11px] mt-2"></ul>
              </div>
            </div>
        </section>

        <!-- Settings -->
        <section id="view-settings" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold" data-i18n="settings.title">Settings</h2>
                <p class="text-xs text-slate-500" data-i18n="settings.subtitle">Theme, layout & data backup.</p>
              </div>
            </div>

            <div id="ownerSettingsPanelNav" class="hidden card p-3 space-y-2" data-owner-only>
              <div class="text-[11px] text-slate-500">Settings sections</div>
              <div class="flex flex-wrap items-center gap-2">
                <button data-owner-settings-panel-target="general" class="owner-panel-btn px-3 py-1.5 rounded-xl border border-slate-300 text-[11px]">General</button>
                <button data-owner-settings-panel-target="operations" class="owner-panel-btn px-3 py-1.5 rounded-xl border border-slate-300 text-[11px]">Operations</button>
                <button data-owner-settings-panel-target="activity" class="owner-panel-btn px-3 py-1.5 rounded-xl border border-slate-300 text-[11px]">Activity</button>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="card p-5 text-xs space-y-3" data-owner-settings-panel="general">
                <h3 class="text-sm font-semibold mb-1" data-i18n="settings.appearance">Appearance</h3>
                <div class="flex items-center justify-between">
                  <span data-i18n="settings.theme">Theme</span>
                  <select id="settingsThemeSelect" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                    <option value="light" data-i18n="settings.theme_light">Light</option>
                    <option value="dark" data-i18n="settings.theme_dark">Dark</option>
                  </select>
                </div>
                <div class="flex items-center justify-between">
                  <span data-i18n="settings.layout_density">Layout density</span>
                  <select id="settingsDensitySelect" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                    <option value="comfortable" data-i18n="settings.density_comfortable">Comfortable</option>
                    <option value="compact" data-i18n="settings.density_compact">Compact</option>
                  </select>
                </div>
              </div>

              <div class="card p-5 text-xs space-y-3" data-owner-settings-panel="general">
                <h3 class="text-sm font-semibold mb-1" data-i18n="settings.goals_defaults">Goals & defaults</h3>
                <div class="flex items-center justify-between gap-2">
                  <span data-i18n="settings.weekly_hours_goal">Weekly hours goal</span>
                  <input id="settingsWeeklyGoal" type="number" step="0.5"
                    class="border border-slate-300 rounded-xl px-2 py-1 text-xs w-24">
                </div>
                <div class="flex items-center justify-between gap-2">
                  <span data-i18n="settings.monthly_income_goal">Monthly income goal (R)</span>
                  <input id="settingsMonthlyGoal" type="number" step="100"
                    class="border border-slate-300 rounded-xl px-2 py-1 text-xs w-24">
                </div>
                <div class="flex items-center justify-between gap-2">
                  <span data-i18n="settings.default_session_duration">Default session duration (h)</span>
                  <input id="settingsDefaultDuration" type="number" step="0.25"
                    class="border border-slate-300 rounded-xl px-2 py-1 text-xs w-24">
                </div>
                <div class="flex items-center justify-between gap-2">
                  <span data-i18n="settings.pending_review_grace">Pending review grace (h)</span>
                  <input id="settingsPendingReviewGraceHours" type="number" step="1" min="1"
                    class="border border-slate-300 rounded-xl px-2 py-1 text-xs w-24">
                </div>
                <div class="space-y-1">
                  <label class="flex items-center gap-2 text-[11px]">
                    <input id="settingsChargeableNoShow" type="checkbox">
                    <span data-i18n="settings.chargeable_no_show">Chargeable no-show policy</span>
                  </label>
                  <label class="flex items-center gap-2 text-[11px]">
                    <input id="settingsChargeableLateCancel" type="checkbox">
                    <span data-i18n="settings.chargeable_late_cancel">Chargeable late cancellation policy</span>
                  </label>
                </div>
                <div>
                  <label class="block text-[11px] mb-1" data-i18n="settings.weekly_reflection_note">Weekly reflection note</label>
                  <textarea id="settingsReflection" rows="3"
                    class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]"
                    data-i18n-attr="placeholder:settings.reflection_placeholder"
                    placeholder="What matters this week?"></textarea>
                </div>
              </div>

              <div class="card p-5 text-xs space-y-3" data-owner-only data-owner-settings-panel="operations">
                <h3 class="text-sm font-semibold mb-1" data-i18n="settings.maintenance_title">Scheduled maintenance</h3>
                <p class="text-[11px] text-slate-500" data-i18n="settings.maintenance_hint">Notify users ahead of time and lock the site during maintenance.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <label class="text-[11px]">
                    <span>Mode</span>
                    <select id="maintenanceModeSelect"
                      class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                      <option value="graceful">Graceful degradation (banner + restricted mode)</option>
                      <option value="hard_stop">Hard stop (serve 503 page)</option>
                    </select>
                  </label>
                  <label class="text-[11px]">
                    <span>Warning starts (optional)</span>
                    <input id="maintenanceWarningStartInput" type="datetime-local"
                      class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                  </label>
                  <label class="text-[11px]">
                    <span data-i18n="settings.maintenance_start">Start date/time</span>
                    <input id="maintenanceStartInput" type="datetime-local"
                      class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                  </label>
                  <label class="text-[11px]">
                    <span data-i18n="settings.maintenance_end">End date/time (optional)</span>
                    <input id="maintenanceEndInput" type="datetime-local"
                      class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                  </label>
                </div>
                <label class="text-[11px] block">
                  <span>Retry-After seconds (for hard stop / 503)</span>
                  <input id="maintenanceRetryAfterInput" type="number" min="60" step="60"
                    class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                </label>
                <div class="text-[10px] text-slate-500">
                  Hard stop requires edge/server-level 503 responses. For Cloudflare use <code>ops/cloudflare-worker-maintenance.js</code>.
                </div>
                <div class="text-[10px] text-slate-500" data-i18n="settings.maintenance_end_hint">Leave end blank to keep maintenance active until you clear it.</div>
                <label class="text-[11px] block">
                  <span data-i18n="settings.maintenance_message">Message to users (optional)</span>
                  <input id="maintenanceMessageInput" type="text"
                    data-i18n-attr="placeholder:settings.maintenance_message_placeholder"
                    placeholder="Example: Database upgrade in progress."
                    class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                </label>
                <div class="flex items-center gap-2">
                  <button id="maintenanceSaveBtn"
                    class="px-3 py-1.5 rounded-2xl bg-amber-600 text-white text-xs font-medium hover:bg-amber-700">
                    <span data-i18n="settings.maintenance_schedule">Schedule maintenance</span>
                  </button>
                  <button id="maintenanceStartNowBtn"
                    class="px-3 py-1.5 rounded-2xl border border-amber-300 text-amber-700 text-xs">
                    <span data-i18n="settings.maintenance_start_now">Start now</span>
                  </button>
                  <button id="maintenanceClearBtn"
                    class="px-3 py-1.5 rounded-2xl border border-slate-300 text-xs">
                    <span data-i18n="settings.maintenance_clear">Clear maintenance</span>
                  </button>
                </div>
                <div id="maintenanceStatusText" class="text-[11px] text-slate-500"></div>
              </div>

              <div class="card p-5 text-xs space-y-3" data-owner-only data-owner-settings-panel="operations">
                <h3 class="text-sm font-semibold mb-1">Broadcast announcements</h3>
                <p class="text-[11px] text-slate-500">
                  Publish one-time overlays for all users. Useful for domain changes and Privacy Policy updates.
                </p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <label class="text-[11px]">
                    <span>Type</span>
                    <select id="announcementTypeSelect" class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                      <option value="general">General</option>
                      <option value="domain_change">Domain change</option>
                      <option value="privacy_policy_update">Privacy policy update</option>
                    </select>
                  </label>
                  <label class="text-[11px]">
                    <span>Expires at (optional)</span>
                    <input id="announcementExpiresAtInput" type="datetime-local"
                      class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                  </label>
                </div>
                <label class="text-[11px] block">
                  <span>Title</span>
                  <input id="announcementTitleInput" type="text"
                    placeholder="Important update"
                    class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                </label>
                <label class="text-[11px] block">
                  <span>Message</span>
                  <textarea id="announcementBodyInput" rows="3"
                    placeholder="Write the update your users should see once on next login."
                    class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]"></textarea>
                </label>
                <div id="announcementDomainFields" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <label class="text-[11px]">
                    <span>Old domain</span>
                    <input id="announcementDomainFromInput" type="text"
                      placeholder="old.example.com"
                      class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                  </label>
                  <label class="text-[11px]">
                    <span>New domain</span>
                    <input id="announcementDomainToInput" type="text"
                      placeholder="new.example.com"
                      class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                  </label>
                </div>
                <div id="announcementPrivacyFields" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <label class="text-[11px]">
                    <span>Privacy policy version</span>
                    <input id="announcementPolicyVersionInput" type="text"
                      placeholder="2026-02-19"
                      class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                  </label>
                  <label class="text-[11px]">
                    <span>Policy link (optional)</span>
                    <input id="announcementPolicyUrlInput" type="text"
                      placeholder="./privacy.html"
                      class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                  </label>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <label class="text-[11px]">
                    <span>Primary button label (optional)</span>
                    <input id="announcementCtaLabelInput" type="text"
                      placeholder="Open details"
                      class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                  </label>
                  <label class="text-[11px]">
                    <span>Primary button URL (optional)</span>
                    <input id="announcementCtaUrlInput" type="text"
                      placeholder="https://example.com"
                      class="mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                  </label>
                </div>
                <div class="space-y-2">
                  <div class="flex items-center justify-between gap-2">
                    <div class="text-[11px] font-medium text-slate-700">Additional buttons (optional)</div>
                    <button id="announcementAddButtonRowBtn"
                      class="px-2 py-1 rounded-lg border border-slate-300 text-[10px]">
                      Add button
                    </button>
                  </div>
                  <div id="announcementButtonRows" class="space-y-2"></div>
                  <div class="text-[10px] text-slate-500">
                    Add multiple links (for example Privacy Policy and Terms). Each button needs both label and URL.
                  </div>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                  <button id="announcementPresetDomainBtn"
                    class="px-3 py-1.5 rounded-2xl border border-slate-300 text-xs">
                    Use domain-change template
                  </button>
                  <button id="announcementPresetPrivacyBtn"
                    class="px-3 py-1.5 rounded-2xl border border-slate-300 text-xs">
                    Use privacy-update template
                  </button>
                  <button id="publishAnnouncementBtn"
                    class="px-3 py-1.5 rounded-2xl bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700">
                    Publish announcement
                  </button>
                </div>
                <div id="announcementAdminStatus" class="text-[11px] text-slate-600 hidden"></div>
                <ul id="announcementAdminList" class="space-y-2 max-h-56 overflow-y-auto scrollbar-thin"></ul>
              </div>

              <div class="card p-5 text-xs space-y-3" data-owner-only data-owner-settings-panel="operations">
                <h3 class="text-sm font-semibold mb-1">Debug test accounts</h3>
                <p class="text-[11px] text-slate-500">
                  Instantly create a linked test parent + student with contract status already signed.
                </p>
                <div class="flex flex-wrap items-center gap-2">
                  <button id="createDebugTestPairBtn"
                    class="px-3 py-1.5 rounded-2xl bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700">
                    Create test parent + student
                  </button>
                  <button id="refreshDebugTestPairsBtn"
                    class="px-3 py-1.5 rounded-2xl border border-slate-300 text-xs">
                    Refresh list
                  </button>
                </div>
                <div id="debugTestPairStatus" class="text-[11px] text-slate-600 hidden"></div>
                <ul id="debugTestPairsList" class="space-y-2 max-h-56 overflow-y-auto scrollbar-thin"></ul>
              </div>

              <div class="card p-5 text-xs space-y-3" data-owner-settings-panel="general">
                <h3 class="text-sm font-semibold mb-1" data-i18n="settings.data_backup">Data backup</h3>
                <p data-i18n="settings.data_backup_hint">Export your dashboard data as JSON and paste it somewhere safe. You can import it later.</p>
                <div class="flex gap-2">
                  <button id="exportDataBtn"
                    class="px-3 py-1.5 rounded-2xl bg-slate-900 text-white text-xs shadow-sm" data-i18n="settings.export">Export</button>
                  <button id="importDataBtn"
                    class="px-3 py-1.5 rounded-2xl border border-slate-300 text-xs" data-i18n="settings.import">Import</button>
                </div>
                <textarea id="backupTextarea" rows="5"
                  class="mt-2 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]"
                  data-i18n-attr="placeholder:settings.backup_placeholder"
                  placeholder="Exported JSON will appear here. Paste JSON here to import."></textarea>
              </div>

              <div class="card p-5 text-xs space-y-3" data-owner-settings-panel="activity">
                <h3 class="text-sm font-semibold mb-1" data-i18n="settings.activity_log">Activity log</h3>
                <p class="text-[11px] text-slate-500" data-i18n="settings.activity_log_hint">Recent actions for this account (last 25).</p>
                <ul id="activityLogList" class="space-y-1 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
            </div>
        </section>

        <!-- Profile -->
        <section id="view-profile" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold" data-i18n="profile.title">Your profile</h2>
                <p class="text-xs text-slate-500" data-i18n="profile.subtitle">Account details, security, and data controls.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 text-xs">
              <div class="card p-5 space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold" data-i18n="profile.account">Account</h3>
                  <span id="profileEmailVerified"
                    class="text-[10px] px-2 py-0.5 rounded-full bg-amber-100 text-amber-700" data-i18n="profile.unverified">Unverified</span>
                </div>
                <div class="text-[11px] text-slate-500" data-i18n="profile.email">Email</div>
                <div id="profileEmail" class="text-sm font-semibold">‚Äî</div>
                <div class="grid grid-cols-2 gap-3 mt-2">
                  <div>
                    <div class="text-[11px] text-slate-500" data-i18n="profile.role">Role</div>
                    <div id="profileRole" class="text-[11px] font-semibold">‚Äî</div>
                  </div>
                  <div>
                    <div class="text-[11px] text-slate-500" data-i18n="profile.user_id">User ID</div>
                    <div id="profileUid" class="text-[11px] font-semibold truncate">‚Äî</div>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-2">
                  <div>
                    <div class="text-[11px] text-slate-500" data-i18n="profile.created">Created</div>
                    <div id="profileCreated" class="text-[11px] font-semibold">‚Äî</div>
                  </div>
                  <div>
                    <div class="text-[11px] text-slate-500" data-i18n="profile.last_sign_in">Last sign-in</div>
                    <div id="profileLastSignIn" class="text-[11px] font-semibold">‚Äî</div>
                  </div>
                </div>
                <div class="text-[10px] text-slate-500 mt-2" id="profileSessionMeta"></div>
              </div>

              <div class="card p-5 space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold" data-i18n="profile.business_policies">Business & policies</h3>
                  <span class="text-[10px] text-slate-500" data-i18n="profile.verification">Verification</span>
                </div>
                <div class="text-[11px] text-slate-500" data-i18n="profile.business_name">Business name</div>
                <div id="businessName" class="text-[11px] font-semibold" data-brand-name>BRAND_NAME</div>
                <div class="grid grid-cols-2 gap-3 mt-2">
                  <div>
                    <div class="text-[11px] text-slate-500" data-i18n="profile.contact">Contact</div>
                    <div id="businessContactEmail" class="text-[11px] font-semibold">‚Äî</div>
                  </div>
                  <div>
                    <div class="text-[11px] text-slate-500" data-i18n="profile.payment_provider">Payment provider</div>
                    <div id="businessPaymentProvider" class="text-[11px] font-semibold">PayFast</div>
                  </div>
                </div>
                <div class="text-[11px] text-slate-500 mt-2" data-i18n="profile.policies">Policies</div>
                <div class="flex flex-wrap gap-2 text-[11px]">
                  <a class="text-indigo-600 hover:underline" href="./tos.html" data-i18n="profile.terms">Terms of Service</a>
                  <a class="text-indigo-600 hover:underline" href="./privacy.html" data-i18n="profile.privacy">Privacy Policy</a>
                </div>
                <div class="text-[10px] text-slate-500" data-i18n="profile.refunds_notice">Refunds and cancellations are covered in the Terms.</div>
              </div>

              <div class="card p-5 space-y-3 border border-rose-200 bg-rose-50">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold text-rose-700" data-i18n="profile.delete_account">Delete account</h3>
                  <span class="text-[10px] text-rose-600" data-i18n="profile.irreversible">Irreversible</span>
                </div>
                <p class="text-[11px] text-rose-700" data-i18n="profile.delete_warning">
                  This deletes your account and all associated data (students, sessions, invoices, resources, notes).
                  You‚Äôll need to sign up again to use the dashboard.
                </p>
                <button id="deleteAccountBtn"
                  class="px-3 py-1.5 rounded-xl border border-rose-400 bg-rose-600 text-white text-xs font-semibold hover:bg-rose-700">
                  <span data-i18n="profile.delete_button">Delete my account</span>
                </button>
                <div id="deleteAccountStatus" class="text-[11px] text-rose-700"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Student portal (student-mode only) -->
        <section id="view-portal" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold" data-i18n="portal.title">My portal</h2>
                <p class="text-xs text-slate-500" data-i18n="portal.subtitle">Your schedule, homework, invoices, and resources.</p>
              </div>
            </div>
            <div id="portalBlocker"
              class="hidden border border-rose-300 bg-rose-50 text-rose-800 rounded-lg px-3 py-2 text-xs">
              <div data-i18n="portal.contract_invalid">INVALID ‚Äì CONTRACT NOT SIGNED. Ask your parent/guardian to sign the contract to unlock this portal.</div>
              <button id="portalCheckContractBtn"
                class="mt-2 px-2 py-1 rounded-lg border border-rose-300 text-rose-700 hover:bg-rose-100 text-[10px]">
                <span data-i18n="portal.refresh_contract_status">Refresh contract status</span>
              </button>
            </div>
            <div id="portalBusyNotice" class="hidden border border-rose-200 bg-rose-50 text-rose-800 rounded-lg px-3 py-2 text-xs">
              <div class="font-semibold" data-i18n="portal.busy_notice_title">Tutor unavailable on the dates below (not a live status)</div>
              <ul id="portalBusyList" class="mt-2 space-y-1 text-[11px]"></ul>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 text-xs">
              <div class="card p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold" data-i18n="portal.upcoming_sessions">Upcoming sessions</h3>
                  <span class="hint" data-i18n="portal.all_upcoming">All upcoming</span>
                </div>
                <div id="portalSessionReminder" class="hidden rounded-lg border px-2 py-1 text-[11px]"></div>
                <ul id="portalSessions" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold" data-i18n="portal.homework">Homework</h3>
                  <span class="hint" data-i18n="portal.open_items">Open items</span>
                </div>
                <ul id="portalHomework" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold" data-i18n="portal.invoices">Invoices</h3>
                  <span class="hint" data-i18n="portal.unpaid_first">Unpaid first</span>
                </div>
                <ul id="portalInvoices" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
                <p id="portalInvoiceDisclosure" class="text-[10px] text-slate-500" data-merchant-receipt></p>
              </div>
              <div class="card p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold" data-i18n="portal.resources">Resources</h3>
                  <span class="hint" data-i18n="portal.assigned_to_you">Assigned to you</span>
                </div>
                <ul id="portalResources" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold" data-i18n="portal.messages">Messages</h3>
                  <span class="hint" data-i18n="portal.tutor_student">Tutor ‚Üî Student</span>
                </div>
                <ul id="portalMessages" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold">Support</h3>
                  <button id="portalSupportNewBtn" class="portal-cta-btn portal-cta-subtle text-[11px]">New ticket</button>
                </div>
                <div id="portalSupportStatus" class="text-[11px] text-slate-500 hidden"></div>
                <ul id="portalSupportTickets" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div id="portalAiCard" class="card p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold" data-i18n="portal.ai_helper">AI Study Helper</h3>
                  <span class="hint" data-i18n="portal.ai_helper_hint">Uses recent lessons/resources</span>
                </div>
                <textarea id="portalAiQuestion" rows="2"
                  class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]"
                  data-i18n-attr="placeholder:portal.ai_placeholder"
                  placeholder="Ask a question about your lessons or resources"></textarea>
                <div class="flex items-center gap-2">
                  <button id="portalAiAskBtn" class="px-3 py-1 rounded-lg bg-indigo-600 text-white text-xs" data-i18n="portal.ai_ask">Ask</button>
                  <span id="portalAiStatus" class="text-[10px] text-slate-500"></span>
                </div>
                <div id="portalAiAnswer" class="text-[11px] text-slate-700 whitespace-pre-wrap"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Reports -->
        <section id="view-reports" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold" data-i18n="reports.title">Reports</h2>
                <p class="text-xs text-slate-500" data-i18n="reports.subtitle">Earnings, attendance, subject mix, and homework completion.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
              <div class="card p-4">
                <div class="text-[11px] text-slate-500" data-i18n="reports.this_month_earnings">This month earnings</div>
                <div id="repEarningsMonth" class="text-2xl font-semibold">R 0</div>
                <div class="text-[10px] text-slate-500" id="repEarningsCount"></div>
              </div>
              <div class="card p-4">
                <div class="text-[11px] text-slate-500" data-i18n="reports.attendance">Attendance</div>
                <div id="repAttendance" class="text-2xl font-semibold">0%</div>
                <div class="text-[10px] text-slate-500" id="repAttendanceMeta"></div>
              </div>
              <div class="card p-4">
                <div class="text-[11px] text-slate-500" data-i18n="reports.homework_completion">Homework completion</div>
                <div id="repHomework" class="text-2xl font-semibold">0%</div>
                <div class="text-[10px] text-slate-500" id="repHomeworkMeta"></div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
              <div class="card p-4">
                <h3 class="text-sm font-semibold mb-2" data-i18n="reports.subject_hours_total">Subject hours (total)</h3>
                <ul id="repSubjectMix" class="space-y-1"></ul>
              </div>
              <div class="card p-4">
                <h3 class="text-sm font-semibold mb-2" data-i18n="reports.unpaid_invoices">Unpaid invoices</h3>
                <ul id="repUnpaidList" class="space-y-1 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
            </div>
          </div>
        </section>

        <!-- Parent portal (parent-mode only) -->
        <section id="view-parent-portal" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold" data-i18n="parent.title">Parent portal</h2>
                <p class="text-xs text-slate-500" data-i18n="parent.subtitle">Linked students, schedules, homework, invoices, and messages.</p>
              </div>
              <button id="parentEditProfileBtn"
                class="px-3 py-1.5 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 text-[11px]">
                <span data-i18n="parent.edit_profile">Edit profile</span>
              </button>
            </div>
            <div id="parentProfilePrompt" class="card p-4 hidden">
              <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold" data-i18n="parent.complete_profile_title">Complete your profile</div>
                  <div id="parentProfilePromptText" class="text-[11px] text-slate-500"></div>
                </div>
                <button id="parentCompleteProfileBtn"
                  class="w-full sm:w-auto px-3 py-1.5 rounded-lg border border-indigo-300 text-indigo-700 hover:bg-indigo-50 text-[11px]">
                  <span data-i18n="parent.complete_profile">Complete profile</span>
                </button>
              </div>
            </div>
            <div id="parentEmailOptInCard" class="card p-4 hidden border border-amber-200 bg-amber-50/70">
              <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold text-amber-900">Email notices</div>
                  <div id="parentEmailOptInText" class="text-[11px] text-amber-800"></div>
                </div>
                <button id="parentEmailOptInBtn"
                  class="portal-cta-btn portal-cta-subtle text-[11px] w-full sm:w-auto">
                  Update
                </button>
              </div>
            </div>
            <div id="parentGuideCard" class="card p-4 hidden">
              <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold" data-i18n="parent.getting_started">Getting started</div>
                  <div id="parentGuideSummary" class="text-[11px] text-slate-500"></div>
                </div>
                <button id="parentGuideDismissBtn"
                  class="w-full sm:w-auto px-2 py-1 rounded-lg border border-slate-300 text-[10px] hover:bg-slate-50">
                  <span data-i18n="parent.hide_guide">Hide guide</span>
                </button>
              </div>
              <div id="parentGuideSteps" class="mt-3 space-y-2 text-[11px]"></div>
            </div>
            <div id="parentBusyNotice" class="card p-4 hidden border border-rose-200 bg-rose-50 text-rose-800">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold" data-i18n="parent.busy_notice_title">Tutor unavailable on these dates (not a live status)</div>
                  <div class="text-[11px] text-rose-700" data-i18n="parent.busy_notice_detail">These are specific calendar dates where sessions are not scheduled.</div>
                </div>
              </div>
              <ul id="parentBusyList" class="mt-2 space-y-1 text-[11px]"></ul>
            </div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 text-xs">
              <div class="card p-4 space-y-2">
                <h3 class="text-sm font-semibold" data-i18n="parent.linked_students">Linked students</h3>
                <ul id="parentStudentsList" class="space-y-2 max-h-72 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-4 space-y-2">
                <h3 class="text-sm font-semibold" data-i18n="parent.messages">Messages</h3>
                <ul id="parentMessages" class="space-y-2 max-h-72 overflow-y-auto scrollbar-thin"></ul>
              </div>
            </div>
            <div class="card p-4 space-y-2 text-xs">
              <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold">Support</h3>
                <div class="flex items-center gap-2">
                  <button id="parentSupportRefreshBtn" class="portal-cta-btn portal-cta-subtle text-[11px]">Refresh</button>
                  <button id="parentSupportNewBtn" class="portal-cta-btn portal-cta-pay text-[11px]">New ticket</button>
                </div>
              </div>
              <div id="parentSupportStatus" class="text-[11px] text-slate-500 hidden"></div>
              <ul id="parentSupportTickets" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
            </div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 text-xs">
              <div class="card p-4 space-y-2">
                <h3 class="text-sm font-semibold" data-i18n="parent.all_sessions">All sessions</h3>
                <div id="parentSessionPaymentNotice" class="hidden rounded-lg border border-amber-200 bg-amber-50/70 p-2">
                  <div class="text-[11px] font-medium text-amber-900" data-i18n="parent.sessions_locked_title">Upcoming sessions appear after payment</div>
                  <div class="text-[10px] text-amber-800" data-i18n="parent.sessions_locked_detail">Pay the invoice to unlock the schedule.</div>
                </div>
                <ul id="parentSessions" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-4 space-y-2">
                <h3 class="text-sm font-semibold" data-i18n="parent.homework_status">Homework status</h3>
                <ul id="parentHomework" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
            </div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 text-xs">
              <div class="card p-4 space-y-2" id="parentInvoicesCard">
                <h3 class="text-sm font-semibold" data-i18n="parent.invoices">Invoices</h3>
                <div id="parentInvoiceAlert" class="hidden rounded-lg border border-amber-200 bg-amber-50/70 p-2">
                  <div class="text-[11px] font-medium text-amber-900" data-i18n="parent.invoice_alert_title">Payment needed to schedule lessons</div>
                  <div class="text-[10px] text-amber-800" data-i18n="parent.invoice_alert_detail">Tap a ‚ÄúPay now‚Äù button below to confirm payment.</div>
                  <button id="parentInvoiceAlertActionBtn" type="button" class="mt-2 portal-cta-btn portal-cta-pay portal-cta-btn-block">
                    Go to unpaid invoices
                  </button>
                </div>
                <div id="parentInvoiceStatus" class="hidden rounded-lg border border-amber-200 bg-amber-50/70 p-2">
                  <div id="parentInvoiceStatusTitle" class="text-[11px] font-medium text-amber-900"></div>
                  <div id="parentInvoiceStatusDetail" class="text-[10px] text-amber-800"></div>
                </div>
                <ul id="parentInvoices" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
                <p id="parentInvoiceDisclosure" class="text-[10px] text-slate-500" data-merchant-receipt></p>
              </div>
              <div class="card p-4 space-y-2">
                <h3 class="text-sm font-semibold" data-i18n="parent.resources">Resources</h3>
                <ul id="parentResources" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
            </div>
          </div>
        </section>
      </main>
      <footer class="px-8 py-4 text-[10px] text-slate-500" data-merchant-disclosure></footer>
    </div>
  </div>

  <!-- Landing Page -->
  <div id="landingPage"
    class="fixed inset-0 z-50 bg-gradient-to-br from-indigo-50 via-white to-cyan-50 text-slate-900 hidden overflow-y-auto">
    <div class="max-w-5xl mx-auto px-6 py-12">
      <header class="flex items-center justify-between mb-10">
        <div class="text-xl font-bold text-indigo-700" data-platform-name>PLATFORM_NAME</div>
        <div class="flex gap-3">
          <a href="./login.html"
            class="px-4 py-2 rounded-full border border-indigo-200 text-indigo-700 hover:bg-indigo-100 text-sm font-semibold" data-i18n="landing.tutor_sign_in">Tutor
            sign in</a>
          <button data-tour-trigger
            class="px-4 py-2 rounded-full border border-indigo-200 text-indigo-700 hover:bg-indigo-100 text-sm font-semibold">
            <span data-i18n="landing.take_tour">Take a tour</span>
          </button>
          <a href="./login.html"
            class="px-4 py-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 text-sm font-semibold" data-i18n="landing.enter_code">Enter
            login code</a>
        </div>
      </header>
      <div class="grid md:grid-cols-2 gap-10 items-center">
        <div class="space-y-4">
          <p class="text-indigo-600 text-xs font-semibold tracking-wide uppercase" data-i18n="landing.subjects">Physics ‚Ä¢ Chemistry ‚Ä¢ Maths</p>
          <h1 class="text-3xl md:text-4xl font-bold leading-tight" data-i18n="landing.headline">A private tutoring hub for students and parents.</h1>
          <p class="text-slate-600 text-sm md:text-base" data-i18n="landing.subhead">Schedule lessons, track invoices (paid one month in advance),
            share resources, and keep contracts signed and stored securely. Students and parents each see a tailored
            portal.</p>
          <div class="flex flex-wrap gap-3">
            <a href="./login.html"
              class="px-4 py-2 rounded-full bg-slate-900 text-white hover:bg-slate-800 text-sm font-semibold" data-i18n="landing.enter_login">Enter
              your login code</a>
            <a href="./login.html"
              class="px-4 py-2 rounded-full border border-slate-300 text-sm font-semibold hover:bg-slate-100" data-i18n="landing.tutor_sign_in">Tutor
              sign in</a>
            <button data-tour-trigger
              class="px-4 py-2 rounded-full border border-indigo-300 text-indigo-700 text-sm font-semibold hover:bg-indigo-50">
              <span data-i18n="landing.take_guided_tour">Take a guided tour</span>
            </button>
          </div>
          <p class="text-[11px] text-slate-500" data-i18n="landing.tour_mode_note">Tour mode is a local demo. Changes stay in your browser only.</p>
          <ul class="text-slate-700 text-sm space-y-2 mt-4">
            <li data-i18n="landing.feature_portal">‚Ä¢ Parent & student portals with contract gating</li>
            <li data-i18n="landing.feature_invoices">‚Ä¢ Prepaid monthly invoicing and balances</li>
            <li data-i18n="landing.feature_contracts">‚Ä¢ Secure contracts with view/download links</li>
            <li data-i18n="landing.feature_ai">‚Ä¢ AI helpers for study, parent summaries, and lesson plans</li>
          </ul>
        </div>
        <div class="bg-white/70 backdrop-blur shadow-xl border border-indigo-100 rounded-3xl p-6 space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs text-slate-500" data-i18n="landing.live_overview">Live overview</p>
              <p class="text-lg font-semibold" data-i18n="landing.dashboard_preview">Dashboard Preview</p>
            </div>
            <span class="px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 text-xs font-semibold" data-i18n="landing.private_badge">Private</span>
          </div>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="p-3 rounded-xl border border-slate-200 bg-slate-50">
              <p class="text-[11px] text-slate-500" data-i18n="landing.card_contracts_title">Contracts</p>
              <p class="text-base font-semibold" data-i18n="landing.card_contracts_status">SIGNED / PENDING</p>
              <p class="text-[11px] text-emerald-600" data-i18n="landing.card_contracts_hint">Share, sign, download</p>
            </div>
            <div class="p-3 rounded-xl border border-slate-200 bg-slate-50">
              <p class="text-[11px] text-slate-500" data-i18n="landing.card_invoices_title">Invoices</p>
              <p class="text-base font-semibold" data-i18n="landing.card_invoices_status">Prepaid Monthly</p>
              <p class="text-[11px] text-slate-500" data-i18n="landing.card_invoices_hint">One month in advance</p>
            </div>
            <div class="p-3 rounded-xl border border-slate-200 bg-slate-50">
              <p class="text-[11px] text-slate-500" data-i18n="landing.card_sessions_title">Sessions</p>
              <p class="text-base font-semibold" data-i18n="landing.card_sessions_status">Schedule & track</p>
              <p class="text-[11px] text-slate-500" data-i18n="landing.card_sessions_hint">Locked until contract & payment</p>
            </div>
            <div class="p-3 rounded-xl border border-slate-200 bg-slate-50">
              <p class="text-[11px] text-slate-500" data-i18n="landing.card_ai_title">AI Assistance</p>
              <p class="text-base font-semibold" data-i18n="landing.card_ai_status">Study & Summaries</p>
              <p class="text-[11px] text-slate-500" data-i18n="landing.card_ai_hint">Tutor voice: Shangjing Huang</p>
            </div>
          </div>
          <div class="flex items-center gap-3 text-[11px] text-slate-500">
            <span class="h-2 w-2 rounded-full bg-emerald-500"></span><span data-i18n="landing.secure_backend">Secure Supabase backend</span>
            <span class="h-2 w-2 rounded-full bg-indigo-500 ml-4"></span><span data-i18n="landing.role_portals">Role-aware portals</span>
          </div>
        </div>
      </div>
      <section class="mt-12 space-y-4">
        <div>
          <h2 class="text-lg font-semibold" data-i18n="landing.verification_title">Business verification snapshot</h2>
          <p class="text-xs text-slate-500" data-i18n="landing.verification_subtitle">Clear policies, contact details, and payment information help providers verify the service.</p>
        </div>
        <div class="grid md:grid-cols-3 gap-4 text-xs">
          <div class="card p-4 bg-white/70 backdrop-blur border border-slate-200">
            <h3 class="text-sm font-semibold" data-i18n="landing.business_contact_title">Business & contact</h3>
            <p class="text-[11px] text-slate-600 mt-1" data-i18n="landing.business_contact_subtitle">Private tutoring services for Physics, Chemistry, and Maths.</p>
            <div class="mt-2 space-y-1 text-[11px]">
              <div><span class="text-slate-500" data-i18n="landing.contact_label">Contact:</span> <span id="landingContactEmail" class="font-semibold" data-support-email>SUPPORT_EMAIL</span></div>
              <div><span class="text-slate-500" data-i18n="landing.service_label">Service:</span> <span data-i18n="landing.service_detail">One-on-one sessions and parent/student portals.</span></div>
            </div>
            <p class="text-[10px] text-slate-500 mt-2" data-about-operator-merchant></p>
          </div>
          <div class="card p-4 bg-white/70 backdrop-blur border border-slate-200">
            <h3 class="text-sm font-semibold" data-i18n="landing.payments_title">Payments</h3>
            <ul class="mt-2 space-y-1 text-[11px] text-slate-600">
              <li data-i18n="landing.payments_item1">‚Ä¢ Online card payments via PayFast</li>
              <li data-i18n="landing.payments_item2">‚Ä¢ Invoices issued monthly, prepaid</li>
              <li data-i18n="landing.payments_item3">‚Ä¢ Secure access codes for parents/students</li>
            </ul>
          </div>
          <div class="card p-4 bg-white/70 backdrop-blur border border-slate-200">
            <h3 class="text-sm font-semibold" data-i18n="landing.policies_title">Policies</h3>
            <ul class="mt-2 space-y-1 text-[11px]">
              <li><a class="text-indigo-600 hover:underline" href="./tos.html" data-i18n="profile.terms">Terms of Service</a></li>
              <li><a class="text-indigo-600 hover:underline" href="./privacy.html" data-i18n="profile.privacy">Privacy Policy</a></li>
            </ul>
            <p class="text-[10px] text-slate-500 mt-2" data-i18n="landing.refunds_note">Refunds and cancellations are detailed in the Terms.</p>
          </div>
        </div>
      </section>
      <footer class="mt-10 text-[10px] text-slate-500" data-merchant-disclosure></footer>
    </div>
  </div>

  <!-- OVERLAY & MODALS -->

  <div id="modalOverlay" class="overlay">
    <div id="modalContainer" class="card w-full max-w-lg max-h-[90vh] overflow-y-auto p-4 text-xs">
      <!-- modal content injected here -->
    </div>
  </div>

  <!-- AUTH OVERLAY -->
  <div id="authOverlay" class="auth-overlay">
    <div class="card w-full max-w-sm p-5 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold" data-i18n="auth.sign_in">Sign in</h2>
      </div>
      <p class="text-[11px] text-slate-500" data-i18n="auth.overlay_hint">Please sign in from the login page or use your access code.</p>
      <div class="space-y-2">
        <a href="./login.html"
          class="block px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium text-center" data-i18n="auth.go_to_sign_in">Go to Sign in</a>
      </div>
    </div>
  </div>

  <script src="./business-config.js"></script>
  <script src="./business-ui.js"></script>

  <div id="maintenanceOverlay" class="maintenance-overlay">
    <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl p-5 text-slate-900 text-xs">
      <div id="maintenanceOverlayTitle" class="text-sm font-semibold text-amber-700" data-i18n="maintenance.overlay_title">Scheduled maintenance in progress</div>
      <p id="maintenanceOverlayMessage" class="mt-2 text-slate-600">
        <span data-i18n="maintenance.overlay_message">The dashboard is temporarily locked while maintenance is underway. Please check back soon.</span>
      </p>
    </div>
  </div>

  <div id="announcementOverlay" class="maintenance-overlay">
    <div class="max-w-lg w-full bg-white rounded-2xl shadow-2xl p-5 text-slate-900 text-xs">
      <div class="inline-flex items-center px-2 py-0.5 rounded-full border border-indigo-200 bg-indigo-50 text-indigo-700 text-[10px] font-medium">
        Announcement
      </div>
      <h3 id="announcementOverlayTitle" class="mt-2 text-base font-semibold text-slate-900">Important update</h3>
      <p id="announcementOverlayBody" class="mt-2 text-slate-700 whitespace-pre-wrap"></p>
      <div id="announcementOverlayMeta" class="mt-2 text-[10px] text-slate-500 hidden"></div>
      <div id="announcementOverlayActions" class="mt-4 hidden flex flex-wrap items-center gap-2"></div>
      <div class="mt-4 flex flex-wrap items-center gap-2">
        <button id="announcementOverlayDismissBtn"
          class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs">
          Dismiss
        </button>
      </div>
    </div>
  </div>
  <script>
    /***********************
     * STATE & PERSISTENCE *
     ***********************/
    const STORAGE_KEY = 'tutoringDashboardState_v1';
    const TOUR_STORAGE_KEY = 'tutoringDashboardTourState_v1';
    const TOUR_MODE_KEY = 'tutoringDashboardTourMode';
    const TOUR_START_KEY = 'tutoringDashboardTourStart';
    const tourQuery = new URLSearchParams(window.location.search).get('tour') === '1';
    const tourMode = tourQuery || sessionStorage.getItem(TOUR_MODE_KEY) === '1';
    if (tourMode) sessionStorage.setItem(TOUR_MODE_KEY, '1');

    const BUSINESS = window.BUSINESS_CONFIG || {};
    const BRAND_NAME = BUSINESS.brandName || 'BRAND_NAME';
    const PLATFORM_NAME = BUSINESS.platformName || BRAND_NAME;
    const OPERATOR_NAME = BUSINESS.operatorName || 'OPERATOR_NAME';
    const MERCHANT_NAME = BUSINESS.merchantName || 'MERCHANT_NAME';
    const SUPPORT_EMAIL = BUSINESS.supportEmail || 'SUPPORT_EMAIL';
    const BUSINESS_ADDRESS = BUSINESS.businessAddress || 'BUSINESS_ADDRESS';
    const TERMS_EFFECTIVE_DATE = BUSINESS.termsEffectiveDate || 'TERMS_EFFECTIVE_DATE';
    const DEFAULT_TIMEZONE = 'Africa/Johannesburg';
    const WEEKDAY_KEYS = ['day.sun', 'day.mon', 'day.tue', 'day.wed', 'day.thu', 'day.fri', 'day.sat'];
    const PHONE_CODES = ['+1', '+27', '+44', '+61', '+65', '+91'];

    function enableTourMode() {
      sessionStorage.setItem(TOUR_MODE_KEY, '1');
      sessionStorage.setItem(TOUR_START_KEY, '1');
      const url = new URL(window.location.href);
      url.searchParams.set('tour', '1');
      window.location.href = url.toString();
    }

    function exitTourMode() {
      sessionStorage.removeItem(TOUR_MODE_KEY);
      sessionStorage.removeItem(TOUR_START_KEY);
      const url = new URL(window.location.href);
      url.searchParams.delete('tour');
      window.location.href = url.toString();
    }

    const CANONICAL_ORIGIN = 'https://tutor-mcp.com';
    const LEGACY_BASE_PATH = '/tutor-dashboard';
    const isLocalDevHost = /^(localhost|127\.0\.0\.1|0\.0\.0\.0|::1)$/i.test(window.location.hostname);
    const APP_ORIGIN = isLocalDevHost ? window.location.origin : CANONICAL_ORIGIN;
    const appUrl = (path = '/') => new URL(path, `${APP_ORIGIN}/`).href;

    if (!isLocalDevHost && window.location.origin !== CANONICAL_ORIGIN) {
      const target = new URL(window.location.href);
      target.protocol = 'https:';
      target.host = new URL(CANONICAL_ORIGIN).host;
      if (target.pathname === LEGACY_BASE_PATH) {
        target.pathname = '/';
      } else if (target.pathname.startsWith(`${LEGACY_BASE_PATH}/`)) {
        target.pathname = target.pathname.slice(LEGACY_BASE_PATH.length) || '/';
      }
      window.location.replace(target.toString());
    }

    /***********************
     * SUPABASE CONFIG      *
     ***********************/
    const SUPABASE_URL = 'https://wdsqnbebutuhwckjpwqf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indkc3FuYmVidXR1aHdja2pwd3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMDE1NzcsImV4cCI6MjA3OTY3NzU3N30.pJglpTaZouSQFUVCbQONHK1UsB9CgWewKQCIV13NOEM';
    const FUNCTIONS_URL = SUPABASE_URL + '/functions/v1';
    const OWNER_EMAIL = 'erichuang.shangjing@outlook.com';
    const CODE_EMAIL_SUFFIX = '@codes.tutor';
    // If true, try Supabase Storage uploads; if false, always fall back to local data URL.
    const ALLOW_STORAGE_UPLOADS = !tourMode;
    // hCaptcha config
    const HCAPTCHA_ENABLED = true;
    const HCAPTCHA_SITEKEY = '3ff631fc-4c9c-43ee-a486-3232939eedb2';
    const MEETING_JOIN_LEAD_MINUTES = 10;
    const MAINTENANCE_MIN_DAYS = 1;
    const PAYFAST_PROVIDER = 'PayFast';
    const PAYFAST_RETURN_URL = new URL('/?payfast=success', `${APP_ORIGIN}/`).href;
    const PAYFAST_CANCEL_URL = new URL('/?payfast=cancel', `${APP_ORIGIN}/`).href;
    const PAYFAST_NOTIFY_URL = `${SUPABASE_URL}/functions/v1/payfast-ipn`;
    const supabaseAvailable =
      !tourMode &&
      typeof supabase !== 'undefined' &&
      SUPABASE_URL.startsWith('https://') &&
      !SUPABASE_URL.includes('YOUR_PROJECT') &&
      SUPABASE_ANON_KEY.length > 10 &&
      !SUPABASE_ANON_KEY.includes('YOUR_ANON');
    let supabaseClient = null;
    let supabaseSession = null;
    let readOnlyMode = false;
    let studentMode = false;
    let parentMode = false;
    let hcaptchaWidgetId = null;
    let currentView = null;
    let hcaptchaToken = '';
    let accountEmails = [];
    let privacyRead = false;
    let tosRead = false;
    let presenceHeartbeat = null;
    let ownerRealtimeChannel = null;
    let ownerRealtimeRefreshTimer = null;
    let ownerRealtimeRefreshInFlight = false;
    let supportRealtimeRefreshTimer = null;
    let supportRealtimeRefreshInFlight = false;
    let presenceRefreshInFlight = null;
    let lastPresenceRefreshAt = 0;
    let maintenanceTicker = null;
    let presenceMap = new Map();
    let ownerAnnouncements = [];
    let announcementCheckInFlight = null;
    let announcementCheckedUserId = '';
    let announcementShownInThisSession = false;
    let announcementAdminTicker = null;
    let overdueReminderSendInFlight = false;
    let overdueReminderTestSendInFlight = false;
    let syncDebounceTimer = null;
    let syncInFlight = false;
    let syncQueued = false;
    let realtimeSuppressedUntil = 0;
    const SUPABASE_SYNC_DEBOUNCE_MS = 1200;
    const REALTIME_REFRESH_DEBOUNCE_MS = 900;
    const REALTIME_SELF_WRITE_SUPPRESS_MS = 5000;
    const PRESENCE_HEARTBEAT_MS = 60000;
    const PRESENCE_REFRESH_MIN_INTERVAL_MS = 45000;
    const SUPABASE_NETWORK_BACKOFF_MS = 2 * 60 * 1000;
    const SUPPORT_CACHE_TTL_MS = 15000;
    const OWNER_PANEL_PREFS_KEY = 'ownerPanelPrefs_v1';
    const ownerPanelPrefs = {
      dashboard: 'overview',
      settings: 'general'
    };
    let supportTicketsCache = {
      cacheKey: '',
      loadedAt: 0,
      tickets: [],
      loading: false,
      error: ''
    };
    let supportTicketsInFlight = null;

    function requireAccessToken(errorMessage = '') {
      const token = supabaseSession?.access_token;
      if (!token) {
        throw new Error(errorMessage || t('alert.sign_in_first'));
      }
      return token;
    }

    function formatRandAmount(value) {
      const amount = Number(value || 0);
      if (!Number.isFinite(amount)) return 'R 0.00';
      return `R ${amount.toFixed(2)}`;
    }

    function buildPortalInvoiceLink(invoiceId = '') {
      try {
        const url = new URL(appUrl('/index.html'));
        if (invoiceId) url.searchParams.set('invoice', String(invoiceId));
        return url.toString();
      } catch (_) {
        return appUrl('/index.html');
      }
    }

    function buildPortalStudentLink(studentId = '') {
      try {
        const url = new URL(appUrl('/index.html'));
        if (studentId) url.searchParams.set('student', String(studentId));
        return url.toString();
      } catch (_) {
        return appUrl('/index.html');
      }
    }

    async function notifyParentServiceEvent(payload, { silent = true } = {}) {
      if (!isSupabaseReady() || !isOwner()) return null;
      try {
        const accessToken = requireAccessToken(t('alert.sign_in_first'));
        const body = {
          ...payload,
          owner_user_id: cleanId(payload?.owner_user_id || supabaseSession?.user?.id || '')
        };
        if (!body.owner_user_id) return null;
        const { data, error } = await supabaseClient.functions.invoke('notify-parent-service-event', {
          body,
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (error || data?.success === false) {
          const message = data?.error || error?.message || 'Notification email trigger failed';
          if (!silent) throw new Error(message);
          console.warn('notify-parent-service-event failed', { message, payload: body });
          return null;
        }
        return data || null;
      } catch (err) {
        if (!silent) throw err;
        console.warn('notify-parent-service-event exception', err);
        return null;
      }
    }

    function maybeNotifyInvoiceIssued(inv, { dedupeKey = '' } = {}) {
      const invoice = inv || {};
      const status = String(invoice.invoiceStatus || invoice.invoice_status || '').toLowerCase();
      const total = Number(invoice.total || 0);
      const studentId = cleanId(invoice.studentId || invoice.student_id || '');
      if (!studentId || isInvoiceVoid(invoice) || invoice.paid || status === 'void' || !(total > 0)) return;
      const student = getStudentById(studentId);
      const invoiceId = cleanId(invoice.id || '');
      void notifyParentServiceEvent({
        event_type: 'invoice_issued',
        student_id: studentId,
        invoice_id: invoiceId,
        dedupe_key: dedupeKey || (invoiceId ? `invoice_issued:${invoiceId}` : `invoice_issued:${studentId}:${Date.now()}`),
        meta: {
          student_name: student?.name || '',
          amount: formatRandAmount(total),
          due_date: invoice.dueDate || invoice.due_date || '',
          cta_label: 'View invoice',
          cta_url: buildPortalInvoiceLink(invoiceId)
        }
      });
    }

    const ACTION_NONCE_ACTIONS = Object.freeze({
      deleteContract: 'delete_contract',
      refund: 'payfast_refund',
      deleteAccountByCode: 'delete_account_by_code'
    });

    function buildActionRequestFingerprint(action, context = {}) {
      const entries = Object.entries(context || {})
        .map(([key, value]) => [String(key), String(value ?? '')])
        .sort((a, b) => a[0].localeCompare(b[0]));
      const serialized = entries.map(([key, value]) => `${key}=${value}`).join('|');
      return `${action}|${serialized}`.slice(0, 512);
    }

    async function issueActionNonce(action, context = {}, accessTokenOverride = '') {
      if (!isSupabaseReady()) {
        throw new Error(t('alert.sign_in_first'));
      }
      const accessToken = accessTokenOverride || requireAccessToken(t('alert.sign_in_first'));
      const requestFingerprint = buildActionRequestFingerprint(action, context);
      const { data, error } = await supabaseClient.functions.invoke('issue-action-nonce', {
        body: {
          action,
          request_fingerprint: requestFingerprint
        },
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      if (error || !data?.success || !data?.nonce) {
        const ctx = error?.context || {};
        let message = data?.error || ctx.error || ctx.message || error?.message || 'Step-up verification required.';
        if (ctx.body) {
          try {
            const parsed = typeof ctx.body === 'string' ? JSON.parse(ctx.body) : ctx.body;
            message = parsed?.error || message;
          } catch (_) { }
        }
        throw new Error(message);
      }
      return {
        nonce: data.nonce,
        requestFingerprint
      };
    }

    // SAFE deep clone helper
    function deepClone(obj) {
      return JSON.parse(JSON.stringify(obj));
    }

    function normalizeCode(code) {
      return (code || '').trim().toUpperCase();
    }

    function normalizeTimeValue(value) {
      const raw = String(value || '').trim();
      if (!raw) return '';
      const match = raw.match(/^(\d{1,2}):(\d{2})(?::\d{2}(?:\.\d+)?)?$/);
      if (!match) return raw;
      const hours = match[1].padStart(2, '0');
      const minutes = match[2].padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    function codeToEmail(code) {
      const normalized = normalizeCode(code);
      return normalized ? `${normalized.toLowerCase()}${CODE_EMAIL_SUFFIX}` : '';
    }

    function normalizeScheduleDays(value) {
      if (Array.isArray(value)) {
        return value.map(v => Number(v)).filter(v => Number.isFinite(v) && v >= 0 && v <= 6);
      }
      if (typeof value === 'string') {
        const parts = value.split(',').map(v => v.trim()).filter(Boolean);
        const map = { sun: 0, mon: 1, tue: 2, wed: 3, thu: 4, fri: 5, sat: 6 };
        return parts.map(p => {
          const lower = p.toLowerCase();
          if (map[lower] != null) return map[lower];
          const asNum = Number(p);
          return Number.isFinite(asNum) ? asNum : null;
        }).filter(v => v != null && v >= 0 && v <= 6);
      }
      return [];
    }

    function normalizeSessionMode(value, fallback = 'in_person') {
      const raw = String(value || '').toLowerCase().trim();
      if (raw === 'online') return 'online';
      if (['in_person', 'in-person', 'in person', 'inperson'].includes(raw)) return 'in_person';
      return fallback;
    }

    function getSessionModeLabel(mode) {
      return normalizeSessionMode(mode) === 'online' ? t('schedule.online') : t('schedule.in_person');
    }

    function getDayShortLabel(index) {
      const keys = ['day.mon', 'day.tue', 'day.wed', 'day.thu', 'day.fri', 'day.sat', 'day.sun'];
      const key = keys[index] || '';
      return key ? t(key) : '';
    }

    function getDayOfWeekLabel(index) {
      const key = WEEKDAY_KEYS[index] || '';
      return key ? t(key) : t('common.day');
    }

    function getHomeworkStatusLabel(status) {
      const raw = String(status || '').toLowerCase();
      if (raw === 'completed') return t('homework.status_completed');
      if (raw === 'in progress') return t('homework.status_in_progress');
      if (raw === 'to do') return t('homework.status_todo');
      return status || t('common.na');
    }

    function getSlotSessionMode(slot, fallback = 'in_person') {
      return normalizeSessionMode(slot?.sessionMode ?? slot?.session_mode ?? slot?.mode, fallback);
    }

    function isOnlineSession(session) {
      return normalizeSessionMode(session?.sessionMode ?? session?.session_mode ?? session?.mode) === 'online';
    }

    function normalizeScheduleSlots(value, fallbackTimezone = DEFAULT_TIMEZONE) {
      if (!Array.isArray(value)) return [];
      const slots = value.map(raw => {
        const day = Number(raw?.dayOfWeek ?? raw?.day_of_week ?? raw?.day ?? raw?.dow);
        const startTime = normalizeTimeValue(raw?.startTime ?? raw?.start_time ?? '');
        const durationRaw = raw?.durationHours ?? raw?.duration_hours ?? raw?.duration ?? '';
        const durationHours = Number(durationRaw || 0) || Number(state.settings.defaultSessionDuration || 1);
        const timezone = String(raw?.timezone || raw?.tz || fallbackTimezone || DEFAULT_TIMEZONE).trim() || DEFAULT_TIMEZONE;
        const sessionMode = normalizeSessionMode(raw?.sessionMode ?? raw?.session_mode ?? raw?.mode);
        if (!Number.isFinite(day) || day < 0 || day > 6 || !startTime) return null;
        return { dayOfWeek: day, startTime, durationHours, timezone, sessionMode };
      }).filter(Boolean);
      return slots;
    }

    function serializeScheduleSlots(slots, fallbackTimezone = DEFAULT_TIMEZONE) {
      if (!Array.isArray(slots)) return [];
      return slots.map(slot => ({
        day_of_week: Number(slot.dayOfWeek),
        start_time: normalizeTimeValue(slot.startTime || ''),
        duration_hours: Number(slot.durationHours || 0) || Number(state.settings.defaultSessionDuration || 1),
        timezone: String(slot.timezone || fallbackTimezone || DEFAULT_TIMEZONE).trim() || DEFAULT_TIMEZONE,
        session_mode: normalizeSessionMode(slot.sessionMode ?? slot.session_mode ?? slot.mode, 'in_person')
      })).filter(s => Number.isFinite(s.day_of_week) && s.day_of_week >= 0 && s.day_of_week <= 6 && s.start_time);
    }

    function getScheduleDaysFromSlots(slots) {
      if (!Array.isArray(slots)) return [];
      const days = slots
        .map(slot => Number(slot?.dayOfWeek ?? slot?.day_of_week))
        .filter(day => Number.isFinite(day) && day >= 0 && day <= 6);
      return Array.from(new Set(days)).sort((a, b) => a - b);
    }

    function getScheduleSlots(student) {
      const fallbackTimezone = student?.scheduleTimezone || student?.schedule_timezone || DEFAULT_TIMEZONE;
      const rawSlots = student?.scheduleSlots || student?.schedule_slots || [];
      let slots = normalizeScheduleSlots(rawSlots, fallbackTimezone);
      if (!slots.length) {
        const days = normalizeScheduleDays(student?.scheduleDays || student?.schedule_days || []);
        const preferredTime = normalizeTimeValue(student?.preferredTime || student?.preferred_time || '');
        if (days.length && preferredTime) {
          const durationHours = Number(student?.sessionLengthHours || student?.session_length_hours || 0)
            || Number(state.settings.defaultSessionDuration || 1);
          const legacyMode = normalizeSessionMode(student?.sessionMode || student?.session_mode || 'in_person');
          slots = days.map(day => ({
            dayOfWeek: day,
            startTime: preferredTime,
            durationHours,
            timezone: fallbackTimezone,
            sessionMode: legacyMode
          }));
        }
      }
      return slots;
    }

    function formatScheduleSlotLabel(slot) {
      const dayLabel = getDayOfWeekLabel(slot.dayOfWeek);
      const duration = Number(slot.durationHours || 0) || Number(state.settings.defaultSessionDuration || 1);
      const modeLabel = getSessionModeLabel(getSlotSessionMode(slot));
      return `${dayLabel} ${slot.startTime} (${duration}h) ‚Ä¢ ${modeLabel}`;
    }

    function formatScheduleDays(days) {
      const normalized = normalizeScheduleDays(days);
      if (!normalized.length) return '';
      const unique = Array.from(new Set(normalized)).sort();
      return unique.map(d => getDayOfWeekLabel(d)).join(', ');
    }

    function toDateOnly(d) {
      const dt = new Date(d);
      const year = dt.getFullYear();
      const month = String(dt.getMonth() + 1).padStart(2, '0');
      const day = String(dt.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function parseDateOnly(value) {
      if (!value) return null;
      const parts = String(value).split('-').map(Number);
      if (parts.length !== 3) return null;
      const [year, month, day] = parts;
      if (!year || !month || !day) return null;
      const parsed = new Date(year, month - 1, day);
      parsed.setHours(0, 0, 0, 0);
      return parsed;
    }

    function endOfMonth(d) {
      return new Date(d.getFullYear(), d.getMonth() + 1, 0);
    }

    function maxDate(a, b) {
      return a && b ? (a > b ? a : b) : (a || b || null);
    }

    function listScheduleDates(days, start, end) {
      const results = [];
      if (!days.length || !start || !end) return results;
      const cursor = new Date(start);
      cursor.setHours(0, 0, 0, 0);
      const endDate = new Date(end);
      endDate.setHours(0, 0, 0, 0);
      while (cursor <= endDate) {
        if (days.includes(cursor.getDay())) results.push(toDateOnly(cursor));
        cursor.setDate(cursor.getDate() + 1);
      }
      return results;
    }

    function listScheduleOccurrences(slots, start, end) {
      const results = [];
      if (!slots.length || !start || !end) return results;
      const cursor = new Date(start);
      cursor.setHours(0, 0, 0, 0);
      const endDate = new Date(end);
      endDate.setHours(0, 0, 0, 0);
      while (cursor <= endDate) {
        const dateStr = toDateOnly(cursor);
        if (isBusyDate(dateStr)) {
          cursor.setDate(cursor.getDate() + 1);
          continue;
        }
        const day = cursor.getDay();
        slots.forEach(slot => {
          if (slot.dayOfWeek === day) {
            results.push({ date: dateStr, slot });
          }
        });
        cursor.setDate(cursor.getDate() + 1);
      }
      return results;
    }

    function getSchedulePrefs(student) {
      const scheduleSlots = getScheduleSlots(student);
      const scheduleStartDate = student.scheduleStartDate || student.schedule_start_date || '';
      const timezone = student.scheduleTimezone || student.schedule_timezone || DEFAULT_TIMEZONE;
      const scheduleNotes = student.scheduleNotes || student.schedule_notes || '';
      return { scheduleSlots, scheduleStartDate, timezone, scheduleNotes };
    }

    function formatScheduleSummary(student) {
      const prefs = getSchedulePrefs(student);
      if (!prefs.scheduleSlots.length) return t('schedule.summary_not_set');
      const slotLabel = prefs.scheduleSlots.map(formatScheduleSlotLabel).join(' ‚Ä¢ ');
      const startLabel = prefs.scheduleStartDate
        ? t('schedule.summary_start', { date: prefs.scheduleStartDate })
        : '';
      return t('schedule.summary', { slots: slotLabel, start: startLabel ? ` ${startLabel}` : '' });
    }

    function computeInvoiceTotal(baseAmount, inv) {
      const base = Number(baseAmount || 0);
      let total = base;
      if (inv?.lateApplied && inv?.lateFeePercent) {
        total += base * (Number(inv.lateFeePercent) / 100);
      }
      if (inv?.shortApplied && inv?.shortNoticePercent) {
        total += base * (Number(inv.shortNoticePercent) / 100);
      }
      return Number(total.toFixed(2));
    }

    const SESSION_STATUS = Object.freeze({
      SCHEDULED: 'scheduled',
      COMPLETE: 'complete',
      PENDING_REVIEW: 'pending_review',
      VOIDED: 'voided',
      NO_SHOW_CHARGEABLE: 'no_show_chargeable',
      RESTORED: 'restored'
    });

    const SESSION_ABSENCE_REASONS = Object.freeze({
      STUDENT_NO_SHOW: 'student_no_show',
      TUTOR_ABSENT: 'tutor_absent',
      CANCELLED_IN_TIME: 'cancelled_in_time',
      CANCELLED_LATE: 'cancelled_late',
      ADMIN_VOID: 'admin_void'
    });

    function normalizeSessionStatus(raw, fallback = '') {
      const val = String(raw || '').trim().toLowerCase();
      const allowed = new Set(Object.values(SESSION_STATUS));
      if (allowed.has(val)) return val;
      return fallback;
    }

    function getSessionStatus(sess) {
      if (!sess) return SESSION_STATUS.SCHEDULED;
      if (sess.completed) return SESSION_STATUS.COMPLETE;
      const raw = sess.status || sess.sessionStatus || sess.session_status || '';
      return normalizeSessionStatus(raw, SESSION_STATUS.SCHEDULED);
    }

    function isSessionVoided(sess) {
      return getSessionStatus(sess) === SESSION_STATUS.VOIDED;
    }

    function isSessionChargeable(sess) {
      const status = getSessionStatus(sess);
      return status !== SESSION_STATUS.VOIDED;
    }

    function getSessionBillingRate(sess, student) {
      const raw = Number(sess?.billingRate ?? sess?.billing_rate ?? 0);
      if (raw > 0) return raw;
      const fallback = Number(student?.rate ?? 0);
      return fallback > 0 ? fallback : 0;
    }

    function getSessionBillableAmount(sess, student) {
      const rate = getSessionBillingRate(sess, student);
      const hours = Number(sess?.durationHours || 0) || Number(state.settings.defaultSessionDuration || 1);
      return Number((rate * hours).toFixed(2));
    }

    function getSessionEndAt(sess) {
      if (!sess?.date) return null;
      const startIso = sess.date + 'T' + (sess.startTime || '00:00');
      const start = new Date(startIso);
      if (isNaN(start.getTime())) return null;
      const durationHours = Number(sess.durationHours || 0) || Number(state.settings.defaultSessionDuration || 1);
      const durationMs = durationHours * 60 * 60 * 1000;
      return new Date(start.getTime() + durationMs);
    }

    function hasSessionEnded(sess, now = new Date()) {
      const endAt = getSessionEndAt(sess);
      return !!(endAt && now >= endAt);
    }

    function isInvoiceLocked(inv) {
      if (!inv) return false;
      if (isInvoiceVoid(inv)) return true;
      if (inv.paid) return true;
      const status = String(inv.invoiceStatus || inv.invoice_status || '').toLowerCase();
      return status === 'paid';
    }

    function isInvoiceVoid(inv) {
      const status = String(inv?.invoiceStatus || inv?.invoice_status || '').toLowerCase();
      return status === 'void' || !!inv?.voidedAt || !!inv?.voided_at;
    }

    function getInvoiceStatusLabel(inv) {
      if (isInvoiceVoid(inv)) return t('invoice.void');
      if ((inv?.invoiceType || inv?.invoice_type) === 'refund') return t('invoice.refunded');
      return inv?.paid ? t('invoice.paid') : t('invoice.unpaid');
    }

    function getInvoicePaymentMethod(inv) {
      const method = String(inv?.paymentMethod || inv?.payment_method || '').toLowerCase();
      if (method === 'cash') return 'cash';
      if (method === 'online') return 'online';
      if (!inv?.paid) return '';
      const provider = String(inv?.paymentProvider || inv?.payment_provider || '').toLowerCase();
      if (provider === 'payfast' || inv?.paymentProviderId || inv?.payment_provider_id) return 'online';
      if (provider === 'cash') return 'cash';
      return '';
    }

    function getInvoicePaymentLabel(inv) {
      if (!inv?.paid || isInvoiceVoid(inv)) return '';
      const method = getInvoicePaymentMethod(inv);
      if (method === 'online') return t('invoice.online_payfast');
      if (method === 'cash') return t('invoice.cash');
      return '';
    }

    function invoiceRequiresPayment(inv) {
      if (!inv || isInvoiceVoid(inv)) return false;
      if (inv.paid) return false;
      const type = String(inv.invoiceType || inv.invoice_type || '').toLowerCase();
      if (type === 'refund') return false;
      return Number(inv.total || 0) > 0.009;
    }

    function buildPayfastPayload(inv) {
      const student = getStudentById(inv.studentId);
      const studentLabel = student?.name ? ` - ${student.name}` : '';
      return {
        itemName: `${BRAND_NAME} tutoring invoice ${inv.id}${studentLabel}`,
        amount: Number(inv.total || 0).toFixed(2),
        returnUrl: PAYFAST_RETURN_URL,
        cancelUrl: PAYFAST_CANCEL_URL,
        notifyUrl: PAYFAST_NOTIFY_URL
      };
    }

    async function startPayfastPayment(invoiceId) {
      if (!guardMaintenanceWrite('Invoice payment')) return;
      if (!supabaseAvailable || !supabaseSession) {
        alert(t('alert.sign_in_pay_invoices'));
        return;
      }
      const inv = getInvoiceById(invoiceId);
      if (!inv) {
        alert(t('alert.invoice_not_found'));
        return;
      }
      if ((inv.invoiceType || inv.invoice_type) === 'refund') {
        alert(t('alert.refund_entries_cannot_be_paid'));
        return;
      }
      if (Number(inv.total || 0) <= 0) {
        alert(t('alert.invoice_no_payment_required'));
        return;
      }
      if (isInvoiceVoid(inv)) {
        alert(t('alert.invoice_voided'));
        return;
      }
      if (inv.paid) {
        alert(t('alert.invoice_already_paid'));
        return;
      }
      try {
        const accessToken = requireAccessToken(t('alert.sign_in_first'));
        const { data, error } = await supabaseClient.functions.invoke('payfast-create-payment', {
          body: { invoice_id: inv.id },
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (error) throw error;
        if (!data?.fields || !data?.process_url) {
          throw new Error(data?.error || t('alert.payfast_prepare_failed'));
        }
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = data.process_url;
        Object.entries(data.fields).forEach(([key, value]) => {
          if (value == null || value === '') return;
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = String(value);
          form.appendChild(input);
        });
        document.body.appendChild(form);
        form.submit();
      } catch (err) {
        console.error('PayFast init failed', err);
        alert(err?.message || t('alert.payfast_start_failed'));
      }
    }

    const defaultState = {
      students: [],
      parents: [],
      parentLinks: [],
      sessions: [],
      sessionCancellations: [],
      busyDays: [],
      resources: [],
      invoices: [],
      documents: [],
      homework: [],
      studentTodos: [],
      studentCheckins: [],
      contracts: [],
      contractSignatures: [],
      messages: [],
      activityLog: [],
      settings: {
        theme: 'light',
        density: 'comfortable',
        weeklyGoalHours: 10,
        monthlyIncomeGoal: 0,
        reflection: '',
        defaultSessionDuration: 1.5,
        pendingReviewGraceHours: 24,
        policyChargeableNoShow: true,
        policyChargeableLateCancel: true,
        showVoidedInvoices: false,
        maintenanceEnabled: false,
        maintenanceStart: '',
        maintenanceEnd: '',
        maintenanceStartAt: '',
        maintenanceEndAt: '',
        maintenanceWarningStartAt: '',
        maintenanceMode: 'graceful',
        maintenanceRetryAfterSeconds: 3600,
        maintenanceMessage: ''
      }
    };

    function getStorageKey() {
      return tourMode ? TOUR_STORAGE_KEY : STORAGE_KEY;
    }

    function buildDemoState() {
      const today = new Date();
      const addDays = (base, days) => {
        const d = new Date(base);
        d.setDate(d.getDate() + days);
        return d;
      };
      const toIso = (d) => d.toISOString().slice(0, 10);
      const demo = deepClone(defaultState);

      const studentAId = 'demo-stu-1';
      const studentBId = 'demo-stu-2';
      const parentId = 'demo-par-1';
      const invoiceA = 'INV-2024-01';
      const invoiceB = 'INV-2024-02';
      const resA = 'demo-res-1';
      const resB = 'demo-res-2';
      const resC = 'demo-res-3';
      const contractA = '11111111-1111-4111-8111-111111111111';

      demo.settings = Object.assign({}, demo.settings, {
        weeklyGoalHours: 12,
        monthlyIncomeGoal: 12000,
        reflection: 'Focus on momentum, stoichiometry, and exam confidence.',
        defaultSessionDuration: 1.5
      });

      demo.students = [
        {
          id: studentAId,
          name: 'Ava Naidoo',
          gradeLevel: 'Grade 11',
          rate: 320,
          subjects: ['Physics', 'Maths'],
          notes: 'Targets 85%+ final results.',
          studentEmail: 'ava.naidoo@example.com',
          loginCode: 'AVAN8QK2',
          contractSigned: true,
          contractSignedAt: toIso(addDays(today, -28)),
          contractVersion: 'v1',
          contractSignerName: 'Priya Naidoo',
          contractSignerEmail: 'priya.naidoo@example.com',
          lastContractId: contractA,
          scheduleSlots: [
            { dayOfWeek: 1, startTime: '16:00', durationHours: 1.5, timezone: DEFAULT_TIMEZONE, sessionMode: 'in_person' },
            { dayOfWeek: 3, startTime: '16:00', durationHours: 1.5, timezone: DEFAULT_TIMEZONE, sessionMode: 'online' },
            { dayOfWeek: 5, startTime: '16:00', durationHours: 1.5, timezone: DEFAULT_TIMEZONE, sessionMode: 'in_person' }
          ],
          scheduleDays: [1, 3, 5],
          preferredTime: '16:00',
          scheduleTimezone: DEFAULT_TIMEZONE,
          scheduleStartDate: toIso(addDays(today, -28)),
          sessionLengthHours: 1.5,
          scheduleNotes: 'After school'
        },
        {
          id: studentBId,
          name: 'Liam Patel',
          gradeLevel: 'Grade 10',
          rate: 280,
          subjects: ['Chemistry'],
          notes: 'Needs help with balancing equations.',
          studentEmail: 'liam.patel@example.com',
          loginCode: 'LIAM7P2Q',
          contractSigned: false,
          contractSignedAt: null,
          contractVersion: 'v1',
          contractSignerName: '',
          contractSignerEmail: '',
          lastContractId: '',
          scheduleSlots: [
            { dayOfWeek: 2, startTime: '17:00', durationHours: 1.5, timezone: DEFAULT_TIMEZONE, sessionMode: 'in_person' },
            { dayOfWeek: 4, startTime: '17:00', durationHours: 1.5, timezone: DEFAULT_TIMEZONE, sessionMode: 'in_person' }
          ],
          scheduleDays: [2, 4],
          preferredTime: '17:00',
          scheduleTimezone: DEFAULT_TIMEZONE,
          scheduleStartDate: toIso(addDays(today, 2)),
          sessionLengthHours: 1.5,
          scheduleNotes: 'Evenings'
        }
      ];

      demo.parents = [
        {
          id: parentId,
          name: 'Priya Naidoo',
          email: 'priya.naidoo@example.com',
          phone: '+27 82 123 4567',
          notes: 'Prefers WhatsApp updates.',
          verified: true,
          loginCode: 'PRYA4K9Z',
          emailNotificationsOptIn: true,
          emailNotificationsOptInAt: new Date().toISOString()
        }
      ];

      demo.parentLinks = [
        { id: 'demo-link-1', parentId, studentId: studentAId, relationship: 'Mother' },
        { id: 'demo-link-2', parentId, studentId: studentBId, relationship: 'Mother' }
      ];

      demo.busyDays = [
        {
          id: 'demo-busy-1',
          date: toIso(addDays(today, 4)),
          note: 'School event',
          createdAt: new Date().toISOString()
        }
      ];

      demo.sessions = [
        {
          id: 'demo-sess-1',
          studentIds: [studentAId],
          date: toIso(addDays(today, 2)),
          startTime: '16:00',
          durationHours: 1.5,
          subject: 'Physics',
          topic: 'Momentum and collisions',
          notes: 'Bring worksheet 4.',
          attended: false,
          completed: false,
          invoiceId: invoiceA,
          sessionMode: 'in_person'
        },
        {
          id: 'demo-sess-2',
          studentIds: [studentAId, studentBId],
          date: toIso(addDays(today, 6)),
          startTime: '15:30',
          durationHours: 2,
          subject: 'Maths',
          topic: 'Trigonometry revision',
          notes: 'Review identities.',
          attended: false,
          completed: false,
          invoiceId: '',
          sessionMode: 'online'
        },
        {
          id: 'demo-sess-3',
          studentIds: [studentBId],
          date: toIso(addDays(today, -3)),
          startTime: '17:00',
          durationHours: 1.25,
          subject: 'Chemistry',
          topic: 'Stoichiometry recap',
          notes: 'Check limiting reagent.',
          attended: true,
          completed: true,
          invoiceId: invoiceB,
          sessionMode: 'in_person'
        }
      ];

      demo.resources = [
        {
          id: resA,
          title: 'Momentum worksheet',
          subject: 'Physics',
          level: 'Grade 11',
          description: 'Practice problems on impulse and collisions.',
          tags: ['mechanics', 'exam'],
          favorite: true
        },
        {
          id: resB,
          title: 'Stoichiometry notes',
          subject: 'Chemistry',
          level: 'Grade 10',
          description: 'Step-by-step mole calculations.',
          tags: ['foundations', 'worked'],
          favorite: false
        },
        {
          id: resC,
          title: 'Trig summary sheet',
          subject: 'Maths',
          level: 'Grade 11',
          description: 'Key identities and unit circle.',
          tags: ['revision', 'quick'],
          favorite: false
        }
      ];

      demo.homework = [
        {
          id: 'demo-hw-1',
          studentId: studentAId,
          resourceId: resA,
          status: 'To do',
          dueDate: toIso(addDays(today, 5)),
          assignedDate: toIso(addDays(today, -1))
        },
        {
          id: 'demo-hw-2',
          studentId: studentBId,
          resourceId: resB,
          status: 'In progress',
          dueDate: toIso(addDays(today, 4)),
          assignedDate: toIso(addDays(today, -2))
        }
      ];

      demo.invoices = [
        {
          id: invoiceA,
          studentId: studentAId,
          issueDate: toIso(addDays(today, -2)),
          dueDate: toIso(addDays(today, 7)),
          baseAmount: 960,
          total: 960,
          lateFeePercent: 10,
          shortNoticePercent: 25,
          lateApplied: false,
          shortApplied: false,
          paid: false,
          notes: 'Prepaid month of January.',
          servicePeriodStart: toIso(addDays(today, -1)),
          servicePeriodEnd: toIso(endOfMonth(today)),
          numSessions: 3,
          invoiceType: 'monthly',
          autoGenerated: true,
          paidAt: '',
          paymentProvider: '',
          paymentMethod: ''
        },
        {
          id: invoiceB,
          studentId: studentBId,
          issueDate: toIso(addDays(today, -15)),
          dueDate: toIso(addDays(today, -5)),
          baseAmount: 560,
          total: 560,
          lateFeePercent: 10,
          shortNoticePercent: 25,
          lateApplied: false,
          shortApplied: false,
          paid: true,
          notes: 'Paid via EFT.',
          servicePeriodStart: toIso(addDays(today, -20)),
          servicePeriodEnd: toIso(endOfMonth(addDays(today, -20))),
          numSessions: 2,
          invoiceType: 'monthly',
          autoGenerated: true,
          paidAt: addDays(today, -12).toISOString(),
          paymentProvider: PAYFAST_PROVIDER,
          paymentMethod: 'online'
        }
      ];

      demo.documents = [
        {
          id: 'demo-doc-1',
          studentId: studentAId,
          title: 'Report card',
          status: 'Received',
          date: toIso(addDays(today, -20))
        }
      ];

      demo.contracts = [
        {
          id: contractA,
          studentId: studentAId,
          fileName: 'Tutoring_Contract_Ava.pdf',
          status: 'Signed',
          notes: 'Signed digitally.',
          uploadedAt: toIso(addDays(today, -28)),
          signedUrl: 'https://example.com/contract-demo.pdf'
        },
        {
          id: 'demo-contract-2',
          studentId: studentBId,
          fileName: 'Tutoring_Contract_Liam.pdf',
          status: 'Pending',
          notes: 'Awaiting signature.',
          uploadedAt: toIso(addDays(today, -7)),
          signedUrl: ''
        }
      ];

      demo.contractSignatures = [
        {
          id: contractA,
          studentId: studentAId,
          parentName: 'Priya Naidoo',
          signedAt: toIso(addDays(today, -28)),
          renderedPdfUrl: 'https://example.com/contract-demo.pdf'
        }
      ];

      demo.studentTodos = [
        {
          id: 'demo-todo-1',
          studentId: studentAId,
          text: 'Confirm exam timetable',
          dueDate: toIso(addDays(today, 10)),
          done: false
        },
        {
          id: 'demo-todo-2',
          studentId: studentBId,
          text: 'Send stoichiometry quiz',
          dueDate: '',
          done: true
        }
      ];

      demo.studentCheckins = [
        {
          id: 'demo-checkin-1',
          studentId: studentAId,
          date: toIso(addDays(today, -1)),
          text: 'Confidence improving on momentum questions.'
        }
      ];

      demo.messages = [
        {
          id: 'demo-msg-1',
          studentId: studentAId,
          sender: 'owner',
          text: 'Great work today. Please review the worksheet before next session.',
          created_at: addDays(today, -1).toISOString()
        },
        {
          id: 'demo-msg-2',
          studentId: studentBId,
          sender: 'student',
          text: 'Can we go over molar ratios again?',
          created_at: addDays(today, -2).toISOString()
        }
      ];

      demo.activityLog = [
        {
          id: 'demo-act-1',
          action: 'Added student',
          detail: 'Ava Naidoo',
          created_at: addDays(today, -30).toISOString()
        },
        {
          id: 'demo-act-2',
          action: 'Uploaded contract',
          detail: 'Tutoring_Contract_Ava.pdf',
          created_at: addDays(today, -28).toISOString()
        },
        {
          id: 'demo-act-3',
          action: 'Sent invoice',
          detail: invoiceA + ' to Ava Naidoo',
          created_at: addDays(today, -2).toISOString()
        }
      ];

      return demo;
    }

    let state = loadState();

    function loadState() {
      try {
        const raw = localStorage.getItem(getStorageKey());
        if (!raw) return tourMode ? buildDemoState() : deepClone(defaultState);
        const parsed = JSON.parse(raw);
        const merged = Object.assign(deepClone(defaultState), parsed);
        merged.settings = Object.assign(deepClone(defaultState.settings), parsed.settings || {});
        return merged;
      } catch (e) {
        console.error('Failed to load state', e);
        return tourMode ? buildDemoState() : deepClone(defaultState);
      }
    }

    function cleanId(val) {
      return String(val || '').trim().replace(/['"]/g, '');
    }

    function isUuid(val) {
      const cleaned = cleanId(val);
      return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(cleaned);
    }

    function stripBucketPrefix(path, bucket) {
      if (!path) return '';
      const trimmed = cleanId(path);
      if (trimmed.startsWith(bucket + '/')) {
        return trimmed.slice(bucket.length + 1);
      }
      return trimmed;
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/`/g, '&#96;');
    }

    function esc(value) {
      return escapeHtml(value);
    }

    function sanitizeState(st) {
      ['students', 'parents', 'parentLinks', 'sessions', 'sessionCancellations', 'busyDays', 'resources', 'homework', 'documents', 'contracts', 'invoices', 'studentTodos', 'studentCheckins', 'messages'].forEach(key => {
        if (!Array.isArray(st[key])) st[key] = [];
      });
      if (!st.settings || typeof st.settings !== 'object') st.settings = {};
      st.settings = Object.assign({}, defaultState.settings, st.settings);
      if (!Array.isArray(st.activityLog)) st.activityLog = [];
      st.students.forEach(s => {
        s.id = cleanId(s.id);
        s.authUserId = cleanId(s.authUserId || s.auth_user_id || '');
        s.studentEmail = (s.studentEmail || s.student_email || '').trim().toLowerCase();
        s.contractSigned = !!s.contractSigned;
        s.contractSignedAt = s.contractSignedAt || s.contract_signed_at || '';
        s.contractVersion = s.contractVersion || s.contract_version || 'v1';
        s.contractSignerName = s.contractSignerName || s.contract_signer_name || '';
        s.contractSignerEmail = s.contractSignerEmail || s.contract_signer_email || '';
        s.lastContractId = s.lastContractId || s.last_contract_id || '';
        s.loginCode = normalizeCode(s.loginCode || s.login_code || '');
        const legacyDays = normalizeScheduleDays(s.scheduleDays || s.schedule_days || []);
        const legacyPreferredTime = (s.preferredTime || s.preferred_time || '').trim();
        const legacyDuration = Number(s.sessionLengthHours || s.session_length_hours || 0) || Number(defaultState.settings.defaultSessionDuration || 1);
        const fallbackTimezone = s.scheduleTimezone || s.schedule_timezone || DEFAULT_TIMEZONE;
        const normalizedSlots = normalizeScheduleSlots(s.scheduleSlots || s.schedule_slots || [], fallbackTimezone);
        const derivedSlots = normalizedSlots.length
          ? normalizedSlots
          : getScheduleSlots({
            scheduleDays: legacyDays,
            preferredTime: legacyPreferredTime,
            sessionLengthHours: legacyDuration,
            scheduleTimezone: fallbackTimezone
          });
        s.scheduleSlots = derivedSlots;
        s.scheduleDays = derivedSlots.length ? getScheduleDaysFromSlots(derivedSlots) : legacyDays;
        s.preferredTime = legacyPreferredTime || (derivedSlots[0]?.startTime || '').trim();
        s.scheduleTimezone = fallbackTimezone;
        s.scheduleStartDate = s.scheduleStartDate || s.schedule_start_date || '';
        s.sessionLengthHours = Number(s.sessionLengthHours || s.session_length_hours || derivedSlots[0]?.durationHours || 0)
          || Number(defaultState.settings.defaultSessionDuration || 1);
        s.scheduleNotes = s.scheduleNotes || s.schedule_notes || '';
      });
      st.parents.forEach(p => {
        p.id = cleanId(p.id);
        p.authUserId = cleanId(p.authUserId || p.auth_user_id || '');
        p.email = (p.email || '').trim().toLowerCase();
        p.phone = normalizePhoneValue(p.phone || '');
        p.loginCode = normalizeCode(p.loginCode || p.login_code || '');
        p.emailNotificationsOptIn = !!(p.emailNotificationsOptIn ?? p.email_notifications_opt_in);
        p.emailNotificationsOptInAt = p.emailNotificationsOptInAt || p.email_notifications_opt_in_at || '';
        if (!p.email || !p.emailNotificationsOptIn) p.emailNotificationsOptInAt = '';
      });
      st.parentLinks.forEach(pl => { pl.id = cleanId(pl.id); pl.parentId = cleanId(pl.parentId); pl.studentId = cleanId(pl.studentId); });
      st.sessions.forEach(s => {
        s.id = cleanId(s.id);
        s.studentIds = (s.studentIds || []).map(cleanId);
        s.invoiceId = cleanId(s.invoiceId);
        s.startTime = normalizeTimeValue(s.startTime || s.start_time || '');
        s.attended = !!s.attended;
        s.completed = !!s.completed;
        const rawStatus = s.status || s.sessionStatus || s.session_status || '';
        s.status = normalizeSessionStatus(rawStatus, s.completed ? SESSION_STATUS.COMPLETE : SESSION_STATUS.SCHEDULED);
        if (s.status === SESSION_STATUS.COMPLETE) {
          s.completed = true;
          s.attended = true;
        }
        if (s.status === SESSION_STATUS.VOIDED) {
          s.completed = false;
        }
        if (s.status === SESSION_STATUS.NO_SHOW_CHARGEABLE) {
          s.completed = false;
          s.attended = false;
        }
        s.absenceReason = String(s.absenceReason || s.absence_reason || '').trim().toLowerCase();
        s.pendingReviewStartedAt = s.pendingReviewStartedAt || s.pending_review_started_at || '';
        s.billingRate = Number(s.billingRate ?? s.billing_rate ?? 0) || null;
        if (!s.billingRate && (s.studentIds || []).length === 1) {
          const stu = st.students.find(stu => cleanId(stu.id) === cleanId(s.studentIds[0]));
          const rate = Number(stu?.rate || 0);
          if (rate > 0) s.billingRate = rate;
        }
        s.sessionMode = normalizeSessionMode(s.sessionMode || s.session_mode || s.mode || 'in_person');
        s.meetingRoom = (s.meetingRoom || s.meeting_room || '').trim();
        s.meetingProvider = (s.meetingProvider || s.meeting_provider || '').trim();
        s.meetingStatus = (s.meetingStatus || s.meeting_status || '').trim();
        s.meetingStartedAt = s.meetingStartedAt || s.meeting_started_at || '';
        s.meetingEndedAt = s.meetingEndedAt || s.meeting_ended_at || '';
      });
      st.sessionCancellations.forEach(c => {
        c.id = cleanId(c.id);
        c.studentId = cleanId(c.studentId || c.student_id || '');
        c.date = c.date || c.session_date || '';
        c.startTime = normalizeTimeValue(c.startTime || c.start_time || '');
        c.durationHours = Number(c.durationHours || c.duration_hours || 0) || 0;
        c.sessionId = cleanId(c.sessionId || c.session_id || '');
        c.invoiceId = cleanId(c.invoiceId || c.invoice_id || '');
        c.reason = (c.reason || '').trim();
        c.cancelledAt = c.cancelledAt || c.cancelled_at || '';
      });
      st.busyDays.forEach(b => {
        b.id = cleanId(b.id);
        const rawDate = b.date || b.busy_date || '';
        const parsed = parseDateOnly(rawDate);
        b.date = parsed ? toDateOnly(parsed) : String(rawDate || '').slice(0, 10);
        b.note = (b.note || '').trim();
        b.createdAt = b.createdAt || b.created_at || '';
      });
      st.resources.forEach(r => {
        r.id = cleanId(r.id);
        r.storage_path = stripBucketPrefix(r.storage_path, 'resources');
        r.fileName = r.fileName || r.file_name || '';
        r.linkUrl = r.linkUrl || r.link_url || '';
        r.resourceType = r.resourceType || r.resource_type || '';
        r.estimatedMinutes = Number(r.estimatedMinutes || r.estimated_minutes || 0) || 0;
      });
      st.homework.forEach(h => { h.id = cleanId(h.id); h.studentId = cleanId(h.studentId); h.resourceId = cleanId(h.resourceId); });
      st.documents.forEach(d => { d.id = cleanId(d.id); d.studentId = cleanId(d.studentId); });
      st.contracts.forEach(c => {
        c.id = cleanId(c.id);
        c.studentId = cleanId(c.studentId);
        c.storage_path = stripBucketPrefix(stripBucketPrefix(c.storage_path, 'signed_contracts'), 'contracts');
      });
      st.invoices.forEach(i => {
        i.id = cleanId(i.id);
        i.studentId = cleanId(i.studentId);
        i.servicePeriodStart = i.servicePeriodStart || i.service_period_start || '';
        i.servicePeriodEnd = i.servicePeriodEnd || i.service_period_end || '';
        i.numSessions = Number(i.numSessions ?? i.num_sessions ?? 0);
        i.invoiceType = i.invoiceType || i.invoice_type || 'manual';
        i.autoGenerated = !!(i.autoGenerated ?? i.auto_generated);
        i.paidAt = i.paidAt || i.paid_at || '';
        i.paymentProvider = i.paymentProvider || i.payment_provider || '';
        i.paymentProviderId = i.paymentProviderId || i.payment_provider_id || '';
        i.paymentMethod = i.paymentMethod || i.payment_method || '';
        i.amountReceived = Number(i.amountReceived ?? i.amount_received ?? 0) || 0;
        i.amountRefunded = Number(i.amountRefunded ?? i.amount_refunded ?? 0) || 0;
        i.refundStatus = i.refundStatus || i.refund_status || '';
        i.refundLastAt = i.refundLastAt || i.refund_last_at || '';
        i.invoiceStatus = i.invoiceStatus || i.invoice_status || (i.paid ? 'paid' : 'issued');
        i.voidedAt = i.voidedAt || i.voided_at || '';
        i.adjustmentReason = i.adjustmentReason || i.adjustment_reason || '';
        i.relatedSessionId = i.relatedSessionId || i.related_session_id || '';
        i.moveToDate = i.moveToDate || i.move_to_date || '';
        i.moveToTime = normalizeTimeValue(i.moveToTime || i.move_to_time || '');
        i.moveToDurationHours = Number(i.moveToDurationHours || i.move_to_duration_hours || 0) || 0;
        i.moveRequestedAt = i.moveRequestedAt || i.move_requested_at || '';
        i.moveAppliedAt = i.moveAppliedAt || i.move_applied_at || '';
        if (!i.paymentMethod && i.paid) {
          const provider = String(i.paymentProvider || '').toLowerCase();
          if (provider === 'payfast' || i.paymentProviderId) i.paymentMethod = 'online';
          if (provider === 'cash') i.paymentMethod = 'cash';
        }
        if (i.voidedAt) i.invoiceStatus = 'void';
        if (i.paid && i.invoiceStatus !== 'void') i.invoiceStatus = 'paid';
      });
      st.studentTodos.forEach(t => { t.id = cleanId(t.id); t.studentId = cleanId(t.studentId); });
      st.studentCheckins.forEach(c => { c.id = cleanId(c.id); c.studentId = cleanId(c.studentId); });
      if (!Array.isArray(st.contractSignatures)) st.contractSignatures = [];
      st.contractSignatures.forEach(cs => {
        cs.id = cleanId(cs.id);
        cs.studentId = cleanId(cs.studentId);
        cs.contract_version = cs.contract_version || cs.contractVersion || 'v1';
        cs.rendered_pdf_url = cs.rendered_pdf_url || cs.renderedPdfUrl || '';
        cs.contract_text_snapshot = cs.contract_text_snapshot || cs.contractTextSnapshot || '';
      });
      st.activityLog.forEach(a => { a.id = cleanId(a.id); });
      st.messages.forEach(m => { m.id = cleanId(m.id); m.studentId = cleanId(m.studentId); m.sender = (m.sender || '').trim(); });
      st.messages.forEach(m => { m.id = cleanId(m.id); m.studentId = cleanId(m.studentId); });
    }

    function forceUuid(val) {
      const cleaned = cleanId(val);
      return isUuid(cleaned) ? cleaned : (crypto?.randomUUID ? crypto.randomUUID() : cleaned);
    }

    function enforceUuidFields() {
      state.students.forEach(s => { s.id = forceUuid(s.id); });
      state.parents.forEach(p => { p.id = forceUuid(p.id); });
      state.parentLinks.forEach(pl => { pl.id = forceUuid(pl.id); pl.parentId = forceUuid(pl.parentId); pl.studentId = forceUuid(pl.studentId); });
      state.sessions.forEach(sess => { sess.id = forceUuid(sess.id); sess.studentIds = (sess.studentIds || []).map(forceUuid); sess.invoiceId = cleanId(sess.invoiceId); });
      state.sessionCancellations.forEach(c => {
        c.id = forceUuid(c.id);
        c.studentId = forceUuid(c.studentId);
        c.sessionId = cleanId(c.sessionId);
        c.invoiceId = cleanId(c.invoiceId);
      });
      state.busyDays.forEach(b => { b.id = forceUuid(b.id); });
      state.resources.forEach(r => { r.id = forceUuid(r.id); });
      state.homework.forEach(hw => { hw.id = forceUuid(hw.id); hw.studentId = forceUuid(hw.studentId); hw.resourceId = forceUuid(hw.resourceId); });
      state.documents.forEach(d => { d.id = forceUuid(d.id); d.studentId = forceUuid(d.studentId); });
      state.contracts.forEach(c => { c.id = forceUuid(c.id); c.studentId = forceUuid(c.studentId); });
      state.contractSignatures.forEach(cs => { cs.id = forceUuid(cs.id); cs.studentId = forceUuid(cs.studentId); });
      // Do NOT force invoice IDs to UUIDs to preserve existing invoice identifiers in the DB.
      state.invoices.forEach(inv => { inv.id = cleanId(inv.id); inv.studentId = forceUuid(inv.studentId); });
      state.studentTodos.forEach(t => { t.id = forceUuid(t.id); t.studentId = forceUuid(t.studentId); });
      state.studentCheckins.forEach(c => { c.id = forceUuid(c.id); c.studentId = forceUuid(c.studentId); });
      state.activityLog.forEach(l => { l.id = forceUuid(l.id); });
      state.messages.forEach(m => { m.id = forceUuid(m.id); m.studentId = forceUuid(m.studentId); });
    }

    function normalizeIdsToUuid() {
      sanitizeState(state);
      const maps = {
        students: new Map(),
        parents: new Map(),
        parentLinks: new Map(),
        sessions: new Map(),
        sessionCancellations: new Map(),
        busyDays: new Map(),
        resources: new Map(),
        homework: new Map(),
        documents: new Map(),
        contracts: new Map(),
        studentTodos: new Map(),
        studentCheckins: new Map(),
        messages: new Map()
      };
      function ensureId(entity, key, map) {
        entity.id = cleanId(entity.id);
        if (isUuid(entity.id)) return entity.id;
        const existing = map.get(entity.id);
        if (existing) {
          entity.id = existing;
          return existing;
        }
        const newId = crypto.randomUUID();
        map.set(entity.id, newId);
        entity.id = newId;
        return newId;
      }
      state.students.forEach(s => ensureId(s, 'students', maps.students));
      state.parents.forEach(p => ensureId(p, 'parents', maps.parents));
      state.parentLinks.forEach(pl => ensureId(pl, 'parentLinks', maps.parentLinks));
      state.sessions.forEach(sess => ensureId(sess, 'sessions', maps.sessions));
      state.sessionCancellations.forEach(c => ensureId(c, 'sessionCancellations', maps.sessionCancellations));
      state.busyDays.forEach(b => ensureId(b, 'busyDays', maps.busyDays));
      state.resources.forEach(r => ensureId(r, 'resources', maps.resources));
      state.homework.forEach(hw => ensureId(hw, 'homework', maps.homework));
      state.documents.forEach(d => ensureId(d, 'documents', maps.documents));
      state.contracts.forEach(c => ensureId(c, 'contracts', maps.contracts));
      state.studentTodos.forEach(t => ensureId(t, 'studentTodos', maps.studentTodos));
      state.studentCheckins.forEach(c => ensureId(c, 'studentCheckins', maps.studentCheckins));
      state.messages.forEach(m => ensureId(m, 'messages', maps.messages));
      state.messages.forEach(m => ensureId(m, 'messages', maps.messages));

      // remap references
      state.sessions.forEach(sess => {
        const seen = new Set();
        sess.studentIds = (sess.studentIds || [])
          .map(id => {
            const cleaned = cleanId(id);
            return maps.students.get(cleaned) || cleaned;
          })
          .filter(id => {
            if (!id) return false;
            if (seen.has(id)) return false;
            seen.add(id);
            return true;
          });
      });
      state.sessionCancellations.forEach(c => {
        const sid = cleanId(c.studentId);
        const sessId = cleanId(c.sessionId);
        c.studentId = maps.students.get(sid) || sid;
        c.sessionId = maps.sessions.get(sessId) || sessId;
      });
      state.homework.forEach(hw => {
        const sid = cleanId(hw.studentId);
        const rid = cleanId(hw.resourceId);
        hw.studentId = maps.students.get(sid) || sid;
        hw.resourceId = maps.resources.get(rid) || rid;
      });
      state.documents.forEach(d => {
        const sid = cleanId(d.studentId);
        d.studentId = maps.students.get(sid) || sid;
      });
      state.contracts.forEach(c => {
        const sid = cleanId(c.studentId);
        c.studentId = maps.students.get(sid) || sid;
      });
      state.contractSignatures.forEach(cs => {
        const sid = cleanId(cs.studentId);
        cs.studentId = maps.students.get(sid) || sid;
      });
      state.invoices.forEach(inv => {
        const sid = cleanId(inv.studentId);
        inv.studentId = maps.students.get(sid) || sid;
      });
      state.studentTodos.forEach(t => {
        const sid = cleanId(t.studentId);
        t.studentId = maps.students.get(sid) || sid;
      });
      state.studentCheckins.forEach(c => {
        const sid = cleanId(c.studentId);
        c.studentId = maps.students.get(sid) || sid;
      });
    }

    function saveState(opts = {}) {
      if (readOnlyMode) {
        console.warn('Read-only mode: changes are not saved.');
        return;
      }
      const skipSync = !!opts.skipSync;
      const requestedDelay = Number(opts.syncDelayMs);
      const syncDelayMs = Number.isFinite(requestedDelay) ? Math.max(0, requestedDelay) : SUPABASE_SYNC_DEBOUNCE_MS;
      normalizeIdsToUuid();
      enforceUuidFields();
      localStorage.setItem(getStorageKey(), JSON.stringify(state));
      updateKPIsAndCharts();
      if (!skipSync && shouldAttemptFullSync()) {
        queueSupabaseSync(syncDelayMs);
      }
    }

    function queueSupabaseSync(delayMs = SUPABASE_SYNC_DEBOUNCE_MS) {
      if (!shouldAttemptFullSync()) return;
      const safeDelay = Number.isFinite(delayMs) ? Math.max(0, delayMs) : SUPABASE_SYNC_DEBOUNCE_MS;
      if (syncInFlight) {
        syncQueued = true;
        return;
      }
      if (syncDebounceTimer) clearTimeout(syncDebounceTimer);
      syncDebounceTimer = setTimeout(() => {
        syncDebounceTimer = null;
        runSupabaseSync();
      }, safeDelay);
    }

    async function runSupabaseSync() {
      if (syncInFlight) {
        syncQueued = true;
        return;
      }
      if (!shouldAttemptFullSync()) return;
      syncInFlight = true;
      syncQueued = false;
      realtimeSuppressedUntil = Date.now() + REALTIME_SELF_WRITE_SUPPRESS_MS;
      try {
        await syncStateToSupabase();
        supabaseSyncBackoffUntil = 0;
      } catch (err) {
        console.error('Supabase sync failed', err);
        if (isNetworkLoadFailure(err)) {
          supabaseSyncBackoffUntil = Date.now() + 60 * 1000;
          registerSupabaseNetworkIssue('Cannot reach Supabase right now (network/CORS). Changes are saved locally and will retry automatically.');
          setSupabaseStatusBanner('Supabase sync is temporarily blocked by network/CORS settings. Changes are saved locally and sync will retry in about 1 minute.');
        }
      } finally {
        syncInFlight = false;
        if (syncQueued) {
          syncQueued = false;
          queueSupabaseSync(400);
        }
      }
    }

    function isSupabaseReady() {
      return !!(supabaseClient && supabaseSession);
    }

    let supabaseSyncBackoffUntil = 0;
    let supabaseNetworkBackoffUntil = 0;

    function isNetworkLoadFailure(err) {
      const msg = String(err?.message || err || '').toLowerCase();
      return (
        msg.includes('load failed') ||
        msg.includes('failed to fetch') ||
        msg.includes('networkerror') ||
        msg.includes('access control checks') ||
        msg.includes('failed to send a request to the edge function')
      );
    }

    function isMissingColumnErrorMessage(err) {
      const msg = String(err?.message || err || '').toLowerCase();
      return msg.includes('column') && msg.includes('does not exist');
    }

    function shouldAttemptFullSync() {
      if (tourMode || readOnlyMode) return false;
      if (!isSupabaseReady()) return false;
      if (!isPrimaryOwnerSession()) return false;
      if (Date.now() < supabaseNetworkBackoffUntil) return false;
      if (Date.now() < supabaseSyncBackoffUntil) return false;
      return true;
    }

    function registerSupabaseNetworkIssue(message = '') {
      supabaseNetworkBackoffUntil = Date.now() + SUPABASE_NETWORK_BACKOFF_MS;
      if (message) setSupabaseStatusBanner(message);
    }

    async function syncStateToSupabase() {
      if (readOnlyMode) return;
      if (!isPrimaryOwnerSession()) return;
      if (Date.now() < supabaseNetworkBackoffUntil) return;
      if (Date.now() < supabaseSyncBackoffUntil) return;
      realtimeSuppressedUntil = Math.max(realtimeSuppressedUntil, Date.now() + REALTIME_SELF_WRITE_SUPPRESS_MS);
      normalizeIdsToUuid();
      enforceUuidFields();
      const uid = supabaseSession?.user?.id;
      if (!uid) return;

      const parents = state.parents.map(p => {
        const email = (p.email || '').trim().toLowerCase();
        const loginCode = normalizeCode(p.loginCode);
        const emailNotificationsOptIn = !!p.emailNotificationsOptIn && !!email;
        const emailNotificationsOptInAt = emailNotificationsOptIn
          ? (p.emailNotificationsOptInAt || p.email_notifications_opt_in_at || new Date().toISOString())
          : null;
        return {
          id: cleanId(p.id),
          user_id: uid,
          email: email || null,
          name: p.name,
          phone: p.phone,
          notes: p.notes,
          verified: p.verified || false,
          login_code: loginCode || null,
          email_notifications_opt_in: emailNotificationsOptIn,
          email_notifications_opt_in_at: emailNotificationsOptInAt
        };
      });
      try {
        await upsertAndPrune('parents', parents, 'id');
      } catch (err) {
        if (!isMissingColumnErrorMessage(err)) throw err;
        const legacyParents = parents.map(p => ({
          id: p.id,
          user_id: p.user_id,
          email: p.email,
          name: p.name,
          phone: p.phone,
          notes: p.notes,
          verified: p.verified,
          login_code: p.login_code
        }));
        await upsertAndPrune('parents', legacyParents, 'id');
      }

      const parentLinks = state.parentLinks.map(pl => ({
        id: cleanId(pl.id),
        user_id: uid,
        parent_id: cleanId(pl.parentId),
        student_id: cleanId(pl.studentId),
        relationship: pl.relationship
      }));
      await upsertAndPrune('parent_students', parentLinks, 'id');

      // prepare rows with user_id
      const students = state.students.map(s => {
        const slots = getScheduleSlots(s);
        const legacyDays = getScheduleDaysFromSlots(slots);
        const legacyPreferredTime = (slots[0]?.startTime || s.preferredTime || '').trim() || null;
        const legacyDuration = Number(slots[0]?.durationHours || s.sessionLengthHours || 0) || null;
        const scheduleTimezone = (s.scheduleTimezone || slots[0]?.timezone || DEFAULT_TIMEZONE).trim() || DEFAULT_TIMEZONE;
        return {
          id: cleanId(s.id),
          user_id: uid,
          name: s.name,
          grade_level: s.gradeLevel,
          rate: s.rate,
          subjects: s.subjects,
          notes: s.notes,
          student_email: (s.studentEmail || '').trim() || null,
          created_at: s.createdAt,
          contract_signed: !!s.contractSigned,
          contract_signed_at: s.contractSignedAt || null,
          contract_version: s.contractVersion || 'v1',
          contract_signer_name: s.contractSignerName || null,
          contract_signer_email: s.contractSignerEmail || null,
          last_contract_id: isUuid(s.lastContractId) ? cleanId(s.lastContractId) : null,
          login_code: normalizeCode(s.loginCode) || null,
          schedule_slots: serializeScheduleSlots(slots, scheduleTimezone),
          schedule_days: legacyDays,
          preferred_time: legacyPreferredTime,
          schedule_timezone: scheduleTimezone,
          schedule_start_date: s.scheduleStartDate || null,
          session_length_hours: legacyDuration,
          schedule_notes: s.scheduleNotes || null
        };
      });
      await upsertAndPrune('students', students, 'id');
      const studentIdSet = new Set(students.map(s => cleanId(s.id)));

      const sessionsClean = state.sessions
        .map(sess => ({
          ...sess,
          studentIds: (sess.studentIds || []).map(cleanId).filter(Boolean)
        }))
        .filter(sess => sess.date && sess.studentIds.length > 0);

      const sessions = sessionsClean.map(sess => ({
        id: cleanId(sess.id),
        user_id: uid,
        date: sess.date,
        start_time: normalizeTimeValue(sess.startTime || '') || null,
        duration_hours: Number(sess.durationHours || 0) || null,
        subject: sess.subject,
        topic: sess.topic,
        notes: sess.notes,
        attended: !!sess.attended,
        completed: !!sess.completed,
        status: normalizeSessionStatus(sess.status || sess.sessionStatus || sess.session_status || '', sess.completed ? SESSION_STATUS.COMPLETE : SESSION_STATUS.SCHEDULED),
        absence_reason: (sess.absenceReason || sess.absence_reason || '').trim() || null,
        pending_review_started_at: sess.pendingReviewStartedAt || sess.pending_review_started_at || null,
        billing_rate: Number(sess.billingRate ?? sess.billing_rate ?? 0) || null,
        invoice_id: sess.invoiceId ? cleanId(sess.invoiceId) : null,
        session_mode: normalizeSessionMode(sess.sessionMode ?? sess.session_mode ?? sess.mode),
        meeting_room: (sess.meetingRoom || sess.meeting_room || '').trim() || null,
        meeting_provider: (sess.meetingProvider || sess.meeting_provider || '').trim() || null,
        meeting_status: (sess.meetingStatus || sess.meeting_status || '').trim() || null,
        meeting_started_at: sess.meetingStartedAt || sess.meeting_started_at || null,
        meeting_ended_at: sess.meetingEndedAt || sess.meeting_ended_at || null
      }));
      try {
        await upsertAndPrune('lesson_sessions', sessions, 'id');
      } catch (err) {
        console.warn('Sessions sync failed (check schema for invoice_id column):', err?.message || err);
        if (isNetworkLoadFailure(err)) throw err;
      }

      const sessionStudents = [];
      const pairSeen = new Set();
      sessionsClean.forEach(sess => {
        const sId = cleanId(sess.id);
        if (!sId) return;
        (sess.studentIds || []).forEach(stuId => {
          const stuClean = cleanId(stuId);
          if (!stuClean) return;
          const key = `${sId}|${stuClean}`;
          if (pairSeen.has(key)) return;
          pairSeen.add(key);
          sessionStudents.push({
            session_id: sId,
            student_id: stuClean,
            user_id: uid
          });
        });
      });
      if (sessionStudents.length) {
        const { error } = await supabaseClient
          .from('session_students')
          .upsert(sessionStudents, { onConflict: 'session_id,student_id', ignoreDuplicates: true });
        if (error) console.error('session_students insert failed', error);
      }

      const cancellations = state.sessionCancellations
        .map(c => ({
          id: cleanId(c.id),
          user_id: uid,
          student_id: cleanId(c.studentId),
          session_date: c.date,
          start_time: normalizeTimeValue(c.startTime || '') || null,
          duration_hours: Number(c.durationHours || 0) || null,
          session_id: c.sessionId ? cleanId(c.sessionId) : null,
          invoice_id: c.invoiceId || null,
          reason: c.reason || null,
          cancelled_at: c.cancelledAt || null
        }))
        .filter(c => c.student_id && c.session_date && c.start_time);
      if (cancellations.length) {
        try {
          await upsertAndPrune('session_cancellations', cancellations, 'id');
        } catch (err) {
          console.warn('Session cancellations sync skipped', err);
          if (isNetworkLoadFailure(err)) throw err;
        }
      }

      const busyDays = state.busyDays
        .map(b => ({
          id: cleanId(b.id),
          user_id: uid,
          date: b.date,
          note: b.note || null,
          created_at: b.createdAt || null
        }))
        .filter(b => b.date);
      if (busyDays.length) {
        try {
          await upsertAndPrune('busy_days', busyDays, 'id');
        } catch (err) {
          console.warn('Busy days sync skipped', err);
          if (isNetworkLoadFailure(err)) throw err;
        }
      }

      if (isOwner()) {
        const settingsRowFull = {
          user_id: uid,
          maintenance_enabled: !!state.settings.maintenanceEnabled,
          maintenance_mode: normalizeMaintenanceMode(state.settings.maintenanceMode || 'graceful'),
          maintenance_start: state.settings.maintenanceStart || null,
          maintenance_end: state.settings.maintenanceEnd || null,
          maintenance_start_at: state.settings.maintenanceStartAt || null,
          maintenance_end_at: state.settings.maintenanceEndAt || null,
          maintenance_warning_start_at: state.settings.maintenanceWarningStartAt || null,
          maintenance_retry_after_seconds: Math.max(60, Number(state.settings.maintenanceRetryAfterSeconds || 3600) || 3600),
          maintenance_message: (state.settings.maintenanceMessage || '').trim() || null,
          updated_at: new Date().toISOString()
        };
        const settingsRowMid = {
          user_id: uid,
          maintenance_enabled: !!state.settings.maintenanceEnabled,
          maintenance_start: state.settings.maintenanceStart || null,
          maintenance_end: state.settings.maintenanceEnd || null,
          maintenance_start_at: state.settings.maintenanceStartAt || null,
          maintenance_end_at: state.settings.maintenanceEndAt || null,
          maintenance_message: (state.settings.maintenanceMessage || '').trim() || null,
          updated_at: new Date().toISOString()
        };
        const settingsRowLegacy = {
          user_id: uid,
          maintenance_enabled: !!state.settings.maintenanceEnabled,
          maintenance_start: state.settings.maintenanceStart || null,
          maintenance_end: state.settings.maintenanceEnd || null,
          maintenance_message: (state.settings.maintenanceMessage || '').trim() || null,
          updated_at: new Date().toISOString()
        };
        try {
          let { error: settingsErr } = await supabaseClient
            .from('owner_settings')
            .upsert(settingsRowFull, { onConflict: 'user_id' });
          if (settingsErr) {
            if (isNetworkLoadFailure(settingsErr)) throw settingsErr;
            const msg = String(settingsErr.message || settingsErr).toLowerCase();
            if (
              msg.includes('maintenance_mode') ||
              msg.includes('maintenance_warning_start_at') ||
              msg.includes('maintenance_retry_after_seconds')
            ) {
              const mid = await supabaseClient
                .from('owner_settings')
                .upsert(settingsRowMid, { onConflict: 'user_id' });
              settingsErr = mid.error;
              if (settingsErr && isNetworkLoadFailure(settingsErr)) throw settingsErr;
            }
            if (settingsErr) {
              const nextMsg = String(settingsErr.message || settingsErr).toLowerCase();
              if (nextMsg.includes('maintenance_start_at') || nextMsg.includes('maintenance_end_at')) {
                const { error: legacyErr } = await supabaseClient
                  .from('owner_settings')
                  .upsert(settingsRowLegacy, { onConflict: 'user_id' });
                if (legacyErr) {
                  if (isNetworkLoadFailure(legacyErr)) throw legacyErr;
                  console.warn('Owner settings sync failed', legacyErr);
                }
              } else {
                console.warn('Owner settings sync failed', settingsErr);
              }
            } else {
              // synced via fallback row
            }
          }
        } catch (err) {
          console.warn('Owner settings sync skipped', err);
          if (isNetworkLoadFailure(err)) throw err;
        }
      }

      const resources = state.resources.map(r => ({
        id: cleanId(r.id),
        user_id: uid,
        title: r.title,
        subject: r.subject,
        level: r.level,
        tags: r.tags,
        description: r.description,
        resource_type: r.resourceType || null,
        estimated_minutes: r.estimatedMinutes ?? null,
        link_url: r.linkUrl || null,
        created_at: r.createdAt,
        favorite: r.favorite,
        storage_path: r.storage_path,
        file_name: r.fileName
      }));
      const resourceIdSet = new Set(resources.map(r => cleanId(r.id)).filter(Boolean));
      try {
        await upsertAndPrune('resources', resources, 'id');
      } catch (err) {
        console.error('Resources upsert failed (check RLS on table "resources")', err);
        if (isNetworkLoadFailure(err)) throw err;
      }

      const activity = state.activityLog.map(a => ({
        id: cleanId(a.id),
        user_id: uid,
        action: a.action,
        detail: a.detail,
        created_at: a.created_at
      }));
      try {
        await upsertAndPrune('activity_log', activity, 'id');
      } catch (err) {
        console.warn('Activity log sync skipped', err);
        if (isNetworkLoadFailure(err)) throw err;
      }

      const homework = state.homework
        .map(h => ({
          id: cleanId(h.id),
          user_id: uid,
          student_id: cleanId(h.studentId),
          resource_id: cleanId(h.resourceId),
          status: h.status,
          due_date: h.dueDate,
          assigned_date: h.assignedDate
        }))
        .filter(h => h.id && h.student_id && h.resource_id && studentIdSet.has(h.student_id) && resourceIdSet.has(h.resource_id));
      if (homework.length !== state.homework.length) {
        console.warn('Skipping homework rows with missing student/resource references during sync');
      }
      try {
        await upsertAndPrune('homework', homework, 'id');
      } catch (err) {
        console.warn('Homework sync skipped', err);
        if (isNetworkLoadFailure(err)) throw err;
      }

      const documents = state.documents.map(d => ({
        id: cleanId(d.id),
        user_id: uid,
        student_id: cleanId(d.studentId),
        title: d.title,
        status: d.status,
        date: d.date,
        notes: d.notes,
        created_at: d.createdAt
      }));
      await upsertAndPrune('documents', documents, 'id');

      const contracts = state.contracts.map(c => ({
        id: cleanId(c.id),
        user_id: uid,
        student_id: cleanId(c.studentId),
        file_name: c.fileName,
        storage_path: c.storage_path,
        status: c.status,
        notes: c.notes,
        uploaded_at: c.uploadedAt
      }));
      await upsertAndPrune('contracts', contracts, 'id');

      const invoices = state.invoices.map(inv => ({
        id: cleanId(inv.id),
        user_id: uid,
        student_id: cleanId(inv.studentId),
        issue_date: inv.issueDate,
        due_date: inv.dueDate,
        base_amount: inv.baseAmount,
        total: inv.total,
        late_fee_percent: inv.lateFeePercent,
        short_notice_percent: inv.shortNoticePercent,
        late_applied: inv.lateApplied,
        short_applied: inv.shortApplied,
        paid: inv.paid,
        notes: inv.notes,
        service_period_start: inv.servicePeriodStart || null,
        service_period_end: inv.servicePeriodEnd || null,
        num_sessions: inv.numSessions ?? null,
        invoice_type: inv.invoiceType || 'manual',
        auto_generated: !!inv.autoGenerated,
        paid_at: inv.paidAt || null,
        payment_provider: inv.paymentProvider || null,
        payment_provider_id: inv.paymentProviderId || null,
        payment_method: inv.paymentMethod || null,
        amount_received: inv.amountReceived ?? null,
        amount_refunded: inv.amountRefunded ?? null,
        refund_status: inv.refundStatus || null,
        refund_last_at: inv.refundLastAt || null,
        invoice_status: inv.invoiceStatus || (inv.paid ? 'paid' : 'issued'),
        voided_at: inv.voidedAt || null,
        adjustment_reason: inv.adjustmentReason || null,
        related_session_id: inv.relatedSessionId || null,
        move_to_date: inv.moveToDate || null,
        move_to_time: inv.moveToTime || null,
        move_to_duration_hours: inv.moveToDurationHours || null,
        move_requested_at: inv.moveRequestedAt || null,
        move_applied_at: inv.moveAppliedAt || null
      }));
      await upsertAndPrune('invoices', invoices, 'id');

      const todos = state.studentTodos.map(t => ({
        id: cleanId(t.id),
        user_id: uid,
        student_id: cleanId(t.studentId),
        text: t.text,
        due_date: t.dueDate,
        done: t.done,
        created_at: t.createdAt
      }));
      await upsertAndPrune('student_todos', todos, 'id');

      const checkins = state.studentCheckins.map(c => ({
        id: cleanId(c.id),
        user_id: uid,
        student_id: cleanId(c.studentId),
        text: c.text,
        date: c.date,
        created_at: c.createdAt
      }));
      await upsertAndPrune('student_checkins', checkins, 'id');

      const messages = state.messages.map(m => ({
        id: cleanId(m.id),
        user_id: uid,
        student_id: cleanId(m.studentId),
        text: m.text,
        sender: m.sender,
        created_at: m.created_at
      })).filter(m => m.student_id && studentIdSet.has(m.student_id));
      try {
        await upsertAndPrune('messages', messages, 'id');
      } catch (err) {
        console.warn('Messages sync skipped', err);
        if (isNetworkLoadFailure(err)) throw err;
      }
    }

    async function upsertAndPrune(table, rows, pk) {
      if (!supabaseClient) return;
      const uid = supabaseSession?.user?.id;
      if (!uid) return;
      // Upsert rows
      if (rows.length) {
        const { error } = await supabaseClient.from(table).upsert(rows);
        if (error) {
          console.error(`Upsert failed for ${table}`, error);
          throw error;
        }
      }
      // Prune skipped to avoid accidental deletions; Supabase is source of truth.
    }

    function isPrimaryOwnerSession() {
      if (!supabaseAvailable) return true;
      if (!supabaseSession) return false;
      const ownerEmail = (OWNER_EMAIL || '').trim().toLowerCase();
      if (!ownerEmail) return false;
      return getSessionEmail() === ownerEmail;
    }

    function collectOrphanInvoiceIds() {
      const studentIds = new Set((state.students || []).map(s => cleanId(s.id)).filter(Boolean));
      const sessionIds = new Set((state.sessions || []).map(s => cleanId(s.id)).filter(Boolean));
      const sessionInvoiceRefs = new Set(
        (state.sessions || [])
          .filter(s => (s.studentIds || []).some(id => studentIds.has(cleanId(id))))
          .map(s => cleanId(s.invoiceId || s.invoice_id || ''))
          .filter(Boolean)
      );
      const orphanIds = [];
      (state.invoices || []).forEach(inv => {
        const invoiceId = cleanId(inv.id || '');
        if (!invoiceId) return;
        const studentId = cleanId(inv.studentId || inv.student_id || '');
        const relatedSessionId = cleanId(inv.relatedSessionId || inv.related_session_id || '');
        const studentMissing = !studentId || !studentIds.has(studentId);
        const relatedSessionMissing = !!relatedSessionId && !sessionIds.has(relatedSessionId);
        if (studentMissing || relatedSessionMissing) {
          if (!sessionInvoiceRefs.has(invoiceId)) orphanIds.push(invoiceId);
        }
      });
      return [...new Set(orphanIds)];
    }

    async function pruneOrphanInvoices(opts = {}) {
      const persistRemote = !!opts.persistRemote;
      const skipSave = !!opts.skipSave;
      const orphanIds = collectOrphanInvoiceIds();
      if (!orphanIds.length) return 0;
      const orphanSet = new Set(orphanIds);
      state.invoices = state.invoices.filter(inv => !orphanSet.has(cleanId(inv.id || '')));
      if (!skipSave) saveState();
      if (persistRemote && isSupabaseReady() && isOwner()) {
        const batchSize = 100;
        for (let i = 0; i < orphanIds.length; i += batchSize) {
          const chunk = orphanIds.slice(i, i + batchSize);
          const { error } = await supabaseClient.from('invoices').delete().in('id', chunk);
          if (error) {
            console.warn('Orphan invoice remote delete failed', error);
            break;
          }
        }
      }
      return orphanIds.length;
    }

    async function deleteContractForStudent(signatureId, studentId) {
      if (isSupabaseReady()) {
        const accessToken = requireAccessToken(t('alert.sign_in_first'));
        const stepUp = await issueActionNonce(
          ACTION_NONCE_ACTIONS.deleteContract,
          { contract_id: signatureId || '', student_id: studentId },
          accessToken
        );
        const { data, error } = await supabaseClient.functions.invoke('delete-contract', {
          body: {
            contract_id: signatureId || undefined,
            student_id: studentId,
            action_nonce: stepUp.nonce,
            request_fingerprint: stepUp.requestFingerprint
          },
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (error || !data?.success) {
          throw error || new Error(data?.error || 'Contract delete failed.');
        }
      }

      if (signatureId) {
        state.contractSignatures = state.contractSignatures.filter(cs => cs.id !== signatureId);
        state.contracts = state.contracts.filter(c => c.id !== signatureId);
      } else {
        state.contractSignatures = state.contractSignatures.filter(cs => cs.studentId !== studentId);
        state.contracts = state.contracts.filter(c => c.studentId !== studentId);
      }
      const stu = getStudentById(studentId);
      if (stu) {
        stu.contractSigned = false;
        stu.contractSignedAt = null;
        stu.contractSignerName = '';
        stu.contractSignerEmail = '';
        stu.lastContractId = '';
      }
      saveState();
      renderStudentContracts(studentId);
      renderStudentFinance(studentId);
      renderStudentTimeline(studentId);
      renderStudentsView();
    }

    async function upsertInvoiceRemote(inv) {
      if (!isSupabaseReady()) return;
      const { error } = await supabaseClient.from('invoices').upsert({
        id: cleanId(inv.id),
        user_id: supabaseSession.user.id,
        student_id: cleanId(inv.studentId),
        issue_date: inv.issueDate,
        due_date: inv.dueDate,
        base_amount: inv.baseAmount,
        total: inv.total,
        late_fee_percent: inv.lateFeePercent,
        short_notice_percent: inv.shortNoticePercent,
        late_applied: inv.lateApplied,
        short_applied: inv.shortApplied,
        paid: inv.paid,
        notes: inv.notes,
        service_period_start: inv.servicePeriodStart || null,
        service_period_end: inv.servicePeriodEnd || null,
        num_sessions: inv.numSessions ?? null,
        invoice_type: inv.invoiceType || 'manual',
        auto_generated: !!inv.autoGenerated,
        paid_at: inv.paidAt || null,
        payment_provider: inv.paymentProvider || null,
        payment_provider_id: inv.paymentProviderId || null,
        payment_method: inv.paymentMethod || null,
        amount_received: inv.amountReceived ?? null,
        amount_refunded: inv.amountRefunded ?? null,
        refund_status: inv.refundStatus || null,
        refund_last_at: inv.refundLastAt || null,
        invoice_status: inv.invoiceStatus || (inv.paid ? 'paid' : 'issued'),
        voided_at: inv.voidedAt || null,
        adjustment_reason: inv.adjustmentReason || null,
        related_session_id: inv.relatedSessionId || null,
        move_to_date: inv.moveToDate || null,
        move_to_time: inv.moveToTime || null,
        move_to_duration_hours: inv.moveToDurationHours || null,
        move_requested_at: inv.moveRequestedAt || null,
        move_applied_at: inv.moveAppliedAt || null
      });
      if (error) throw new Error('Supabase invoice upsert failed: ' + error.message);
    }

    async function deleteInvoiceRemote(id) {
      if (!isSupabaseReady()) return;
      const { error } = await supabaseClient.from('invoices').delete().eq('id', cleanId(id));
      if (error) throw new Error('Supabase invoice delete failed: ' + error.message);
    }

    async function provisionLoginCode(role, code, opts = {}) {
      if (!isSupabaseReady() || !isOwner()) return;
      const normalized = normalizeCode(code);
      if (!normalized) return;
      try {
        const accessToken = requireAccessToken(t('alert.sign_in_first'));
        await supabaseClient.functions.invoke('issue-login-code', {
          body: {
            role,
            code: normalized,
            studentId: opts.studentId || null,
            parentId: opts.parentId || null,
            fullName: opts.fullName || ''
          },
          headers: { Authorization: `Bearer ${accessToken}` }
        });
      } catch (err) {
        console.warn('Login code provisioning failed', err);
      }
    }

    const DEBUG_TEST_MARKER_PREFIX = '[debug-test-pair:';
    const LOGIN_CODE_ALPHABET = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';

    function buildDebugPairMarker(tag) {
      return `${DEBUG_TEST_MARKER_PREFIX}${String(tag || '').trim()}]`;
    }

    function extractDebugPairTag(text) {
      const raw = String(text || '');
      const match = raw.match(/\[debug-test-pair:([a-z0-9_-]+)\]/i);
      return match?.[1] ? match[1].trim() : '';
    }

    function appendDebugPairMarker(text, tag) {
      const marker = buildDebugPairMarker(tag);
      const existing = String(text || '').trim();
      if (!existing) return marker;
      if (extractDebugPairTag(existing)) return existing;
      return `${existing}\n${marker}`;
    }

    function randomLoginCode(length = 8) {
      let code = '';
      for (let i = 0; i < length; i++) {
        code += LOGIN_CODE_ALPHABET[Math.floor(Math.random() * LOGIN_CODE_ALPHABET.length)];
      }
      return code;
    }

    function generateUniqueLoginCode() {
      const used = new Set([
        ...state.students.map(s => normalizeCode(s.loginCode || s.login_code || '')),
        ...state.parents.map(p => normalizeCode(p.loginCode || p.login_code || ''))
      ].filter(Boolean));
      for (let i = 0; i < 50; i++) {
        const candidate = randomLoginCode(8);
        if (!used.has(candidate)) return candidate;
      }
      throw new Error('Unable to generate a unique login code. Please retry.');
    }

    function getDebugTestPairs() {
      const pairs = new Map();
      state.students.forEach(student => {
        const tag = extractDebugPairTag(student.notes);
        if (!tag) return;
        if (!pairs.has(tag)) pairs.set(tag, { tag, student: null, parent: null });
        pairs.get(tag).student = student;
      });
      state.parents.forEach(parent => {
        const tag = extractDebugPairTag(parent.notes);
        if (!tag) return;
        if (!pairs.has(tag)) pairs.set(tag, { tag, student: null, parent: null });
        pairs.get(tag).parent = parent;
      });
      state.parentLinks.forEach(link => {
        const student = state.students.find(s => s.id === link.studentId);
        const parent = state.parents.find(p => p.id === link.parentId);
        const studentTag = extractDebugPairTag(student?.notes);
        const parentTag = extractDebugPairTag(parent?.notes);
        const tag = studentTag || parentTag;
        if (!tag) return;
        if (!pairs.has(tag)) pairs.set(tag, { tag, student: null, parent: null });
        const entry = pairs.get(tag);
        if (!entry.student && student) entry.student = student;
        if (!entry.parent && parent) entry.parent = parent;
      });
      return [...pairs.values()].sort((a, b) => String(a.tag).localeCompare(String(b.tag)));
    }

    function renderDebugTestPairs() {
      const listEl = document.getElementById('debugTestPairsList');
      const statusEl = document.getElementById('debugTestPairStatus');
      if (!listEl) return;
      if (!isOwner()) {
        listEl.innerHTML = '';
        if (statusEl) statusEl.classList.add('hidden');
        return;
      }
      const pairs = getDebugTestPairs();
      if (!pairs.length) {
        listEl.innerHTML = `<li class="text-slate-500 text-[11px]">No debug test accounts created yet.</li>`;
      } else {
        listEl.innerHTML = pairs.map(pair => {
          const student = pair.student;
          const parent = pair.parent;
          const studentCode = normalizeCode(student?.loginCode || student?.login_code || '');
          const parentCode = normalizeCode(parent?.loginCode || parent?.login_code || '');
          return `
            <li class="border border-slate-200 rounded-lg p-2 bg-white/80 space-y-1" data-debug-tag="${esc(pair.tag)}">
              <div class="text-[11px] font-semibold">Pair ${esc(pair.tag)}</div>
              <div class="text-[10px] text-slate-600">
                Student: ${esc(student?.name || 'Missing')} ${studentCode ? `‚Ä¢ <code class="font-mono">${esc(studentCode)}</code>` : ''}
              </div>
              <div class="text-[10px] text-slate-600">
                Parent: ${esc(parent?.name || 'Missing')} ${parentCode ? `‚Ä¢ <code class="font-mono">${esc(parentCode)}</code>` : ''}
              </div>
              <div class="flex flex-wrap gap-2 text-[10px]">
                ${studentCode ? `<button type="button" class="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50" data-copy-debug-code="${esc(studentCode)}">Copy student code</button>` : ''}
                ${parentCode ? `<button type="button" class="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50" data-copy-debug-code="${esc(parentCode)}">Copy parent code</button>` : ''}
                <button type="button" class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700 hover:bg-rose-50" data-delete-debug-tag="${esc(pair.tag)}">Delete pair</button>
              </div>
            </li>
          `;
        }).join('');
      }
      listEl.querySelectorAll('[data-copy-debug-code]').forEach(btn => {
        btn.onclick = () => {
          const code = String(btn.dataset.copyDebugCode || '');
          if (!code) return;
          navigator.clipboard?.writeText(code).then(() => {
            if (statusEl) {
              statusEl.textContent = `Copied code: ${code}`;
              statusEl.classList.remove('hidden');
            }
          }).catch(() => prompt(t('prompt.copy_link'), code));
        };
      });
      listEl.querySelectorAll('[data-delete-debug-tag]').forEach(btn => {
        btn.onclick = async () => {
          const tag = String(btn.dataset.deleteDebugTag || '').trim();
          if (!tag) return;
          await deleteDebugTestPair(tag);
        };
      });
    }

    async function createDebugTestPair() {
      if (!guardEdit() || !isOwner()) return;
      const statusEl = document.getElementById('debugTestPairStatus');
      const createBtn = document.getElementById('createDebugTestPairBtn');
      const pairTag = `${Date.now().toString(36)}${Math.random().toString(36).slice(2, 5)}`.toUpperCase();
      try {
        if (createBtn) createBtn.disabled = true;
        if (statusEl) {
          statusEl.textContent = 'Creating debug test parent/student...';
          statusEl.classList.remove('hidden');
        }

        const nowIso = new Date().toISOString();
        const makeUuid = () => (crypto?.randomUUID ? crypto.randomUUID() : forceUuid(generateId('id')));
        const studentId = makeUuid();
        const parentId = makeUuid();
        const signatureId = makeUuid();
        const contractId = makeUuid();
        const studentCode = generateUniqueLoginCode();
        let parentCode = generateUniqueLoginCode();
        while (parentCode === studentCode) {
          parentCode = generateUniqueLoginCode();
        }
        const marker = buildDebugPairMarker(pairTag);

        const testStudent = {
          id: studentId,
          name: `Test Student ${pairTag}`,
          gradeLevel: 'Test',
          rate: 350,
          subjects: ['Maths'],
          notes: appendDebugPairMarker('Auto-generated debug student.', pairTag),
          studentEmail: '',
          loginCode: studentCode,
          contractSigned: true,
          contractSignedAt: nowIso,
          contractVersion: 'v1',
          contractSignerName: `Test Parent ${pairTag}`,
          contractSignerEmail: '',
          lastContractId: signatureId,
          scheduleSlots: [
            { dayOfWeek: 1, startTime: '16:00', durationHours: Number(state.settings.defaultSessionDuration || 1), timezone: DEFAULT_TIMEZONE, sessionMode: 'online' }
          ],
          scheduleDays: [1],
          preferredTime: '16:00',
          scheduleStartDate: toDateOnly(new Date()),
          sessionLengthHours: Number(state.settings.defaultSessionDuration || 1),
          scheduleTimezone: DEFAULT_TIMEZONE,
          scheduleNotes: marker,
          authUserId: ''
        };
        const testParent = {
          id: parentId,
          name: `Test Parent ${pairTag}`,
          email: '',
          phone: '',
          notes: appendDebugPairMarker('Auto-generated debug parent.', pairTag),
          verified: true,
          loginCode: parentCode,
          authUserId: '',
          emailNotificationsOptIn: false,
          emailNotificationsOptInAt: ''
        };

        state.students.push(testStudent);
        state.parents.push(testParent);
        state.parentLinks.push({
          id: makeUuid(),
          parentId,
          studentId,
          relationship: 'Parent'
        });
        state.contractSignatures.push({
          id: signatureId,
          studentId,
          parentName: testParent.name,
          parentEmail: '',
          signedAt: nowIso,
          contractVersion: 'v1',
          contractTextSnapshot: `Debug contract signature placeholder for ${testStudent.name}. ${marker}`,
          renderedPdfUrl: '',
          signatureMethod: 'debug_seed',
          parentIp: ''
        });
        state.contracts.push({
          id: contractId,
          studentId,
          fileName: `debug_contract_${pairTag}.pdf`,
          storage_path: '',
          status: 'Signed',
          notes: appendDebugPairMarker('Debug signed contract placeholder.', pairTag),
          uploadedAt: nowIso,
          signedUrl: ''
        });

        refreshAutoBilling();
        saveState();
        renderAllViews();
        renderDebugTestPairs();

        if (isSupabaseReady()) {
          try {
            await syncStateToSupabase();
          } catch (syncErr) {
            console.warn('Debug pair sync before provisioning failed', syncErr);
          }
          await provisionLoginCode('student', studentCode, { studentId, fullName: testStudent.name });
          await provisionLoginCode('parent', parentCode, { parentId, fullName: testParent.name });
        }

        logActivity('Created debug test pair', `${testStudent.name} / ${testParent.name}`);
        if (statusEl) {
          statusEl.textContent = `Created ${testStudent.name}. Student code: ${studentCode} | Parent code: ${parentCode}`;
          statusEl.classList.remove('hidden');
        }
      } catch (err) {
        console.error('Debug test pair create failed', err);
        if (statusEl) {
          statusEl.textContent = err?.message || 'Failed to create debug test accounts.';
          statusEl.classList.remove('hidden');
        }
      } finally {
        if (createBtn) createBtn.disabled = false;
      }
    }

    async function deleteDebugTestPair(tag) {
      if (!guardEdit() || !isOwner()) return;
      const safeTag = String(tag || '').trim();
      if (!safeTag) return;
      const normalizedTag = safeTag.toLowerCase();
      const targetParents = state.parents.filter(p => extractDebugPairTag(p.notes).toLowerCase() === normalizedTag);
      const parentIdSet = new Set(targetParents.map(p => cleanId(p.id)).filter(Boolean));
      const linkedStudentIds = state.parentLinks
        .filter(pl => parentIdSet.has(cleanId(pl.parentId || pl.parent_id)))
        .map(pl => cleanId(pl.studentId || pl.student_id))
        .filter(Boolean);
      const targetStudents = [
        ...state.students.filter(s => extractDebugPairTag(s.notes).toLowerCase() === normalizedTag),
        ...state.students.filter(s => linkedStudentIds.includes(cleanId(s.id)))
      ].filter((s, idx, arr) => arr.findIndex(other => cleanId(other.id) === cleanId(s.id)) === idx);
      if (!targetStudents.length && !targetParents.length) {
        renderDebugTestPairs();
        return;
      }
      if (!confirm(`Delete debug pair ${safeTag}? This removes linked sessions, invoices, homework, and contract records for that test student.`)) {
        return;
      }
      const statusEl = document.getElementById('debugTestPairStatus');
      if (statusEl) {
        statusEl.textContent = `Deleting debug pair ${safeTag}...`;
        statusEl.classList.remove('hidden');
      }
      try {
        for (const student of targetStudents) {
          await deleteStudentAndDependencies(student.id);
        }
        for (const parent of targetParents) {
          const stillLinked = state.parentLinks.some(pl => pl.parentId === parent.id);
          if (!stillLinked) {
            await deleteParentAndLinks(parent.id);
          }
        }
        state.contractSignatures = state.contractSignatures.filter(cs => extractDebugPairTag(cs.contractTextSnapshot || '').toLowerCase() !== normalizedTag);
        state.contracts = state.contracts.filter(c => extractDebugPairTag(c.notes).toLowerCase() !== normalizedTag);
        saveState();
        renderAllViews();
        renderDebugTestPairs();
        logActivity('Deleted debug test pair', safeTag);
        if (statusEl) {
          statusEl.textContent = `Deleted debug pair ${safeTag}.`;
          statusEl.classList.remove('hidden');
        }
      } catch (err) {
        console.error('Debug test pair delete failed', err);
        if (statusEl) {
          statusEl.textContent = err?.message || `Failed to delete debug pair ${safeTag}.`;
          statusEl.classList.remove('hidden');
        }
      }
    }

    function generateId(prefix) {
      return prefix + '_' + Math.random().toString(36).slice(2, 10);
    }

    const TOUR_STEPS = [
      {
        view: 'dashboard',
        title: `Welcome to ${PLATFORM_NAME}`,
        body: 'This is a safe demo. Explore KPIs and weekly focus. Changes stay local.'
      },
      {
        view: 'students',
        title: 'Students and login codes',
        body: 'Create profiles, generate login codes, and track contracts and tutoring notes.'
      },
      {
        view: 'schedule',
        title: 'Schedule lessons',
        body: 'Plan sessions, avoid clashes, and mark sessions complete.'
      },
      {
        view: 'resources',
        title: 'Resources and homework',
        body: 'Upload resources, tag them, and assign homework to students.'
      },
      {
        view: 'finance',
        title: 'Invoices and balances',
        body: 'Create prepaid invoices, review balances, and send payment reminders.'
      },
      {
        view: 'profile',
        title: 'Business, policies, and payments',
        body: 'Contact details, payment provider (PayFast), and policy links are published here for verification.'
      },
      {
        view: 'parent-portal',
        title: 'Parent portal view',
        body: 'Parents see upcoming sessions, homework, invoices, and messages.'
      },
      {
        view: 'portal',
        title: 'Student portal view',
        body: 'Students see sessions, homework, resources, and the AI study helper.'
      }
    ];

    function startGuidedTour(startIndex = 0) {
      if (!tourMode) return;
      sessionStorage.removeItem(TOUR_START_KEY);
      showTourStep(startIndex);
    }

    function showTourStep(index) {
      const step = TOUR_STEPS[index];
      if (!step) {
        closeModal();
        return;
      }
      switchView(step.view);
      const isLast = index === TOUR_STEPS.length - 1;
      const backDisabled = index === 0 ? 'opacity-40 pointer-events-none' : '';
      const html = `
        <h2 class="text-sm font-semibold mb-1">${step.title}</h2>
        <p class="text-[11px] text-slate-600 mb-3">${step.body}</p>
        <div class="flex items-center justify-between gap-2">
          <button id="tourBackBtn" class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs ${backDisabled}" ${index === 0 ? 'disabled' : ''}>
            Back
          </button>
          <div class="flex gap-2">
            <button id="tourExitBtn" class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs">
              Exit tour
            </button>
            <button id="tourNextBtn" class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs">
              ${isLast ? 'Finish tour' : 'Next'}
            </button>
          </div>
        </div>
        <div class="text-[10px] text-slate-400 mt-2">Step ${index + 1} of ${TOUR_STEPS.length}</div>
      `;
      openModal(html, () => {
        const backBtn = document.getElementById('tourBackBtn');
        const nextBtn = document.getElementById('tourNextBtn');
        const exitBtn = document.getElementById('tourExitBtn');
        if (backBtn) backBtn.onclick = () => showTourStep(index - 1);
        if (nextBtn) {
          nextBtn.onclick = () => {
            if (isLast) {
              closeModal();
              return;
            }
            showTourStep(index + 1);
          };
        }
        if (exitBtn) exitBtn.onclick = () => exitTourMode();
      });
    }

    /****************
     * AI HELPERS   *
     ****************/
    async function callLLM(mode, payload) {
      if (tourMode) throw new Error('AI helpers are disabled in tour mode.');
      if (!supabaseAvailable) throw new Error('Supabase not configured.');
      if (!isOwner()) throw new Error('AI helpers are available to the tutor only.');
      const token = supabaseSession?.access_token;
      if (!token) throw new Error('Please sign in again to use AI helpers.');
      const res = await fetch(`${FUNCTIONS_URL}/call-llm`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ mode, payload })
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(json?.error || `LLM request failed (${res.status})`);
      }
      return json.content || '';
    }

    async function suggestLessonPlan(studentId, subject, level, examDate = '') {
      const student = getStudentById(studentId) || {};
      const pastSessions = state.sessions
        .filter(s => s.studentIds.includes(studentId))
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5)
        .map(s => ({ date: s.date, topic: s.topic, notes: s.notes }));
      return callLLM('lesson_plan', {
        student: { name: student.name, grade: student.gradeLevel, subjects: student.subjects },
        subject: subject || (student.subjects || [])[0] || 'General',
        level: level || student.gradeLevel || 'N/A',
        examDate,
        pastSessions,
        constraints: { durationMinutes: 75 }
      });
    }

    async function draftMessageAI(opts) {
      return callLLM('draft_message', {
        tone: opts.tone || 'friendly and professional',
        purpose: opts.purpose || 'progress update',
        bullets: opts.bullets || [],
        audience: opts.audience || 'parent',
        context: opts.context || ''
      });
    }

    function renderAiMarkup(el, text) {
      if (!el) return;
      const safe = (text || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const html = safe
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/__(.+?)__/g, '<u>$1</u>')
        .replace(/_(.+?)_/g, '<em>$1</em>')
        .replace(/~~(.+?)~~/g, '<s>$1</s>');
      el.innerHTML = html;
    }

    /****************
     * INITIAL SETUP *
     ****************/
    // Catch errors to avoid Safari ‚Äúoutput‚Äù ReferenceErrors and noisy hCaptcha CSP iframe errors
    const suppressOutputError = (msg = '', src = '') => {
      const lowerMsg = String(msg).toLowerCase();
      const lowerSrc = String(src || '').toLowerCase();
      if (lowerMsg.includes('output')) return true;
      if (lowerMsg.includes('resp.payload')) return true;
      if (lowerMsg.includes('refused to execute a script') && lowerSrc.includes('hcaptcha')) return true;
      if (lowerMsg.includes('csp') && lowerSrc.includes('hcaptcha')) return true;
      return false;
    };
    window.addEventListener('error', (event) => {
      if (suppressOutputError(event.message, event.filename)) {
        event.preventDefault();
        return true;
      }
      return false;
    });
    window.onerror = (msg, src, line, col, err) => {
      if (suppressOutputError(msg, src)) return true;
      console.error('Global error', msg, err);
      return true;
    };
    // Catch any unhandled promise rejections so Safari doesn‚Äôt throw ‚Äúoutput‚Äù ReferenceErrors
    window.addEventListener('unhandledrejection', (event) => {
      const reason = String(event.reason?.message || event.reason || '');
      const lower = reason.toLowerCase();
      if (lower.includes('output') || lower.includes('resp.payload')) {
        event.preventDefault();
        return true;
      }
      console.error('Unhandled promise rejection', event.reason);
      event.preventDefault();
      return true;
    });
    window.onunhandledrejection = (event) => {
      const reason = String(event.reason?.message || event.reason || '');
      const lower = reason.toLowerCase();
      if (lower.includes('output') || lower.includes('resp.payload')) {
        if (event.preventDefault) event.preventDefault();
        return true;
      }
      console.error('Unhandled promise rejection (onunhandledrejection)', event.reason);
      if (event.preventDefault) event.preventDefault();
      return true;
    };

    document.addEventListener('DOMContentLoaded', async () => {
      if (window.initLanguageUI) initLanguageUI();
      await initSupabaseAuth();
      setupNav();
      setupTopbar();
      setupOwnerPanelNavigation();
      document.querySelectorAll('[data-tour-trigger]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          enableTourMode();
        });
      });
      applyTourUI();
      applySettingsToUI();
      if (!supabaseAvailable || supabaseSession) {
        await tryLoadRemoteThenLocal();
        await loadAccountEmails().catch(err => console.warn('Account email fetch failed', err));
        renderAllViews();
        await maybeShowPendingAnnouncement().catch(err => console.warn('Announcement check failed', err));
      }
      window.addEventListener('i18n:change', () => {
        if (window.applyBusinessText) window.applyBusinessText(document);
        renderAllViewsUI();
      });
      updateReadOnlyUI();
      if (tourMode && (sessionStorage.getItem(TOUR_START_KEY) === '1' || tourQuery)) {
        sessionStorage.removeItem(TOUR_START_KEY);
        startGuidedTour();
      }

      // expose functions for inline onclick handlers
      window.openSessionModal = openSessionModal;
      window.getSessionById = getSessionById;
      window.openSessionQuickActions = openSessionQuickActions;
      window.openResourceModal = openResourceModal;
      window.getResourceById = getResourceById;
      window.openAssignResourceModal = openAssignResourceModal;
      window.updateHomeworkStatus = updateHomeworkStatus;
      window.unassignHomework = unassignHomework;
      window.openResourceLink = openResourceLink;
      window.copyResourceLink = copyResourceLink;
      window.openDocumentModal = openDocumentModal;
      window.getDocumentById = getDocumentById;
      window.openInvoiceModal = openInvoiceModal;
      window.getInvoiceById = getInvoiceById;
      window.markInvoicePaid = markInvoicePaid;
      window.startPayfastPayment = startPayfastPayment;
      window.generateReminder = generateReminder;
      window.selectStudent = selectStudent;
      window.toggleResourceFavorite = toggleResourceFavorite;
      window.toggleTodoStatus = toggleTodoStatus;
      window.deleteTodo = deleteTodo;
      window.openContractUpload = openContractUpload;
      window.markContractStatus = markContractStatus;
      window.explainInvoiceAI = explainInvoiceAI;
      window.parentSummaryAI = parentSummaryAI;
      window.openSupportTicketComposer = openSupportTicketComposer;
      window.openSupportTicketThread = openSupportTicketThread;
      window.refreshSupportForCurrentRole = refreshSupportForCurrentRole;
      window.setAnnouncementActive = setAnnouncementActive;
      window.markAnnouncementSeenForCurrentUser = markAnnouncementSeenForCurrentUser;
      window.markAnnouncementUnseenForAll = markAnnouncementUnseenForAll;
      setupRealtime();
    });

    function setupNav() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          switchView(view);
          document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-slate-800', 'active'));
          btn.classList.add('bg-slate-800', 'active');
        });
      });
      // default view
      const defaultView = studentMode ? 'portal' : parentMode ? 'parent-portal' : 'dashboard';
      switchView(defaultView);
      const activeBtn = document.querySelector(`.nav-btn[data-view="${defaultView}"]`);
      if (activeBtn) activeBtn.classList.add('bg-slate-800', 'active');
    }

    /***********************
     * REALTIME UPDATES
     ***********************/
    function teardownRealtime() {
      if (ownerRealtimeRefreshTimer) clearTimeout(ownerRealtimeRefreshTimer);
      ownerRealtimeRefreshTimer = null;
      ownerRealtimeRefreshInFlight = false;
      if (supportRealtimeRefreshTimer) clearTimeout(supportRealtimeRefreshTimer);
      supportRealtimeRefreshTimer = null;
      supportRealtimeRefreshInFlight = false;
      if (ownerRealtimeChannel && supabaseClient) {
        try {
          supabaseClient.removeChannel(ownerRealtimeChannel);
        } catch (_) {
          // ignore cleanup failures
        }
      }
      ownerRealtimeChannel = null;
    }

    function scheduleOwnerRealtimeRefresh() {
      if (!isSupabaseReady() || !isOwner()) return;
      if (Date.now() < supabaseNetworkBackoffUntil) return;
      if (Date.now() < realtimeSuppressedUntil) return;
      if (ownerRealtimeRefreshTimer) clearTimeout(ownerRealtimeRefreshTimer);
      ownerRealtimeRefreshTimer = setTimeout(async () => {
        ownerRealtimeRefreshTimer = null;
        if (ownerRealtimeRefreshInFlight) return;
        ownerRealtimeRefreshInFlight = true;
        try {
          await tryLoadRemoteThenLocal();
          renderAllViews();
        } catch (err) {
          console.error('Realtime refresh failed', err);
        } finally {
          ownerRealtimeRefreshInFlight = false;
        }
      }, REALTIME_REFRESH_DEBOUNCE_MS);
    }

    function scheduleSupportRealtimeRefresh() {
      supportTicketsCache.loadedAt = 0;
      if (!isSupabaseReady() || !isOwner()) return;
      if (Date.now() < supabaseNetworkBackoffUntil) return;
      if (Date.now() < realtimeSuppressedUntil) return;
      if (supportRealtimeRefreshTimer) clearTimeout(supportRealtimeRefreshTimer);
      supportRealtimeRefreshTimer = setTimeout(async () => {
        supportRealtimeRefreshTimer = null;
        if (supportRealtimeRefreshInFlight) return;
        supportRealtimeRefreshInFlight = true;
        try {
          await renderOwnerSupportCard({ force: true });
        } catch (err) {
          console.error('Support realtime refresh failed', err);
        } finally {
          supportRealtimeRefreshInFlight = false;
        }
      }, REALTIME_REFRESH_DEBOUNCE_MS);
    }

    function schedulePresenceRealtimeRefresh() {
      if (!isSupabaseReady() || !isOwner()) return;
      if (Date.now() < supabaseNetworkBackoffUntil) return;
      if (Date.now() < realtimeSuppressedUntil) return;
      refreshPresence({ force: true })
        .then(() => renderStudentsView())
        .catch(err => console.error('Presence realtime refresh failed', err));
    }

    function setupRealtime() {
      if (!supabaseClient || !supabaseSession || !isOwner()) {
        teardownRealtime();
        return;
      }
      if (ownerRealtimeChannel) return;
      const ownerRealtimeTables = ['students', 'lesson_sessions', 'session_cancellations', 'homework', 'invoices', 'messages', 'resources', 'documents', 'contracts', 'student_todos', 'student_checkins', 'parent_contract_signatures'];
      const channelSuffix = cleanId(supabaseSession.user.id || '').slice(0, 8) || 'owner';
      const channel = supabaseClient.channel(`owner-realtime-${channelSuffix}`);
      ownerRealtimeTables.forEach(table => {
        channel.on('postgres_changes', { event: '*', schema: 'public', table }, () => {
          scheduleOwnerRealtimeRefresh();
        });
      });
      channel
        .on('postgres_changes', { event: '*', schema: 'public', table: 'support_tickets' }, () => {
          scheduleSupportRealtimeRefresh();
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'support_ticket_messages' }, () => {
          scheduleSupportRealtimeRefresh();
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'presence' }, (payload) => {
          const changedUserId = cleanId(payload?.new?.user_id || payload?.old?.user_id || '');
          if (changedUserId && changedUserId === cleanId(supabaseSession?.user?.id || '')) return;
          schedulePresenceRealtimeRefresh();
        })
        .subscribe((status) => {
          if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
            console.warn('Owner realtime channel error', status);
          }
        });
      ownerRealtimeChannel = channel;
    }

    function switchView(viewName) {
      document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
      // block switching if Supabase is configured but not signed in
      if (supabaseAvailable && !supabaseSession) {
        toggleLanding(true);
        return;
      }
      let targetView = viewName;
      if (studentMode && ['finance', 'reports', 'dashboard', 'parent-portal'].includes(targetView)) {
        targetView = 'portal';
      }
      if (parentMode) {
        const allowed = new Set(['parent-portal', 'students', 'schedule', 'resources', 'profile', 'settings']);
        if (!allowed.has(targetView)) targetView = 'parent-portal';
      }
      document.getElementById('view-' + targetView)?.classList.remove('hidden');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-slate-800', 'active'));
      const activeBtn = document.querySelector(`.nav-btn[data-view="${targetView}"]`);
      if (activeBtn) activeBtn.classList.add('bg-slate-800', 'active');
      currentView = targetView;
      if (targetView === 'dashboard') {
        updateKPIsAndCharts();
        applyOwnerDashboardPanel();
      }
      if (targetView === 'students') renderStudentsView();
      if (targetView === 'schedule') renderScheduleView();
      if (targetView === 'resources') renderResourcesView();
      if (targetView === 'finance') renderFinanceView();
      if (targetView === 'settings') {
        applySettingsToUI();
        applyOwnerSettingsPanel();
      }
      if (targetView === 'profile') renderProfileView();
      if (targetView === 'portal') renderStudentPortal();
      if (targetView === 'parent-portal') renderParentPortal();
      if (targetView === 'reports') renderReportsView();
      renderSessionAlerts();
    }

    function setupTopbar() {
      document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);
      document.getElementById('quickAddStudentBtn').addEventListener('click', () => { if (guardEdit()) openStudentModal(); });
      document.getElementById('quickAddSessionBtn').addEventListener('click', () => { if (guardEdit()) openSessionModal(); });
      document.getElementById('globalSearchInput').addEventListener('input', handleGlobalSearch);
      const signOutBtn = document.getElementById('signOutBtn');
      if (signOutBtn) {
        signOutBtn.onclick = async () => {
          if (supabaseClient) {
            await supabaseClient.auth.signOut();
          }
          supabaseSession = null;
          toggleAuthOverlay(true);
        };
      }
      const exitTourBtn = document.getElementById('exitTourBtn');
      if (exitTourBtn) {
        exitTourBtn.onclick = () => exitTourMode();
      }

      // Settings bindings
      document.getElementById('settingsThemeSelect').addEventListener('change', e => {
        state.settings.theme = e.target.value;
        applyTheme();
        saveState();
      });
      document.getElementById('settingsDensitySelect').addEventListener('change', e => {
        state.settings.density = e.target.value;
        applyDensity();
        saveState();
      });
      document.getElementById('settingsWeeklyGoal').addEventListener('input', e => {
        state.settings.weeklyGoalHours = Number(e.target.value || 0);
        saveState();
      });
      document.getElementById('settingsMonthlyGoal').addEventListener('input', e => {
        state.settings.monthlyIncomeGoal = Number(e.target.value || 0);
        saveState();
      });
      document.getElementById('settingsReflection').addEventListener('input', e => {
        state.settings.reflection = e.target.value;
        saveState();
      });
      document.getElementById('settingsDefaultDuration').addEventListener('input', e => {
        state.settings.defaultSessionDuration = Number(e.target.value || 1);
        saveState();
      });
      const graceHoursEl = document.getElementById('settingsPendingReviewGraceHours');
      if (graceHoursEl) graceHoursEl.addEventListener('input', e => {
        state.settings.pendingReviewGraceHours = Number(e.target.value || 24) || 24;
        saveState();
      });
      const chargeableNoShowEl = document.getElementById('settingsChargeableNoShow');
      if (chargeableNoShowEl) chargeableNoShowEl.addEventListener('change', e => {
        state.settings.policyChargeableNoShow = !!e.target.checked;
        saveState();
      });
      const chargeableLateCancelEl = document.getElementById('settingsChargeableLateCancel');
      if (chargeableLateCancelEl) chargeableLateCancelEl.addEventListener('change', e => {
        state.settings.policyChargeableLateCancel = !!e.target.checked;
        saveState();
      });
      const ns = document.getElementById('notifySessionsDays');
      const nh = document.getElementById('notifyHomeworkDays');
      const ni = document.getElementById('notifyInvoicesDays');
      if (ns) ns.addEventListener('input', e => { state.settings.notifySessionsDays = Number(e.target.value || 0); saveState(); });
      if (nh) nh.addEventListener('input', e => { state.settings.notifyHomeworkDays = Number(e.target.value || 0); saveState(); });
      if (ni) ni.addEventListener('input', e => { state.settings.notifyInvoicesDays = Number(e.target.value || 0); saveState(); });
      const maintenanceSaveBtn = document.getElementById('maintenanceSaveBtn');
      const maintenanceStartNowBtn = document.getElementById('maintenanceStartNowBtn');
      const maintenanceClearBtn = document.getElementById('maintenanceClearBtn');
      if (maintenanceSaveBtn) {
        maintenanceSaveBtn.addEventListener('click', async () => {
          if (!isOwner()) return;
          const modeSelect = document.getElementById('maintenanceModeSelect');
          const warningStartInput = document.getElementById('maintenanceWarningStartInput');
          const retryAfterInput = document.getElementById('maintenanceRetryAfterInput');
          const startInput = document.getElementById('maintenanceStartInput');
          const endInput = document.getElementById('maintenanceEndInput');
          const msgInput = document.getElementById('maintenanceMessageInput');
          const mode = normalizeMaintenanceMode(modeSelect?.value || state.settings.maintenanceMode || 'graceful');
          const warningVal = (warningStartInput?.value || '').trim();
          const startVal = (startInput?.value || '').trim();
          const endVal = (endInput?.value || '').trim();
          if (!startVal) {
            alert(t('maintenance.alert_select_start'));
            return;
          }
          const warningStartDate = warningVal ? parseLocalDateTimeInput(warningVal) : null;
          const startDate = parseLocalDateTimeInput(startVal);
          const endDate = endVal ? parseLocalDateTimeInput(endVal) : null;
          const retryAfterSeconds = Math.max(60, Number(retryAfterInput?.value || state.settings.maintenanceRetryAfterSeconds || 3600) || 3600);
          if (warningVal && !warningStartDate) {
            alert('Invalid warning start date/time.');
            return;
          }
          if (!startDate) {
            alert(t('maintenance.alert_invalid_start'));
            return;
          }
          const minDateStr = getMaintenanceMinDate();
          const minDate = parseLocalDateTimeInput(minDateStr);
          if (minDate && startDate < minDate) {
            alert(t('maintenance.alert_min_days', { days: MAINTENANCE_MIN_DAYS }));
            return;
          }
          if (endDate && endDate < startDate) {
            alert(t('maintenance.alert_end_after_start'));
            return;
          }
          if (warningStartDate && warningStartDate > startDate) {
            alert('Warning start must be before maintenance start.');
            return;
          }
          state.settings.maintenanceEnabled = true;
          state.settings.maintenanceMode = mode;
          state.settings.maintenanceStartAt = startDate.toISOString();
          state.settings.maintenanceEndAt = endDate ? endDate.toISOString() : '';
          state.settings.maintenanceWarningStartAt = warningStartDate ? warningStartDate.toISOString() : '';
          state.settings.maintenanceRetryAfterSeconds = retryAfterSeconds;
          state.settings.maintenanceStart = toDateOnly(startDate);
          state.settings.maintenanceEnd = endDate ? toDateOnly(endDate) : '';
          state.settings.maintenanceMessage = (msgInput?.value || '').trim();
          saveState();
          applySettingsToUI();
          renderMaintenanceUI();
          try {
            await syncHardStopEdgeGate('maintenance_schedule');
          } catch (err) {
            console.warn('Hard-stop sync failed after scheduling maintenance', err);
            alert(`Maintenance saved, but Cloudflare hard-stop sync failed.\n${err?.message || err}`);
          }
        });
      }
      if (maintenanceStartNowBtn) {
        maintenanceStartNowBtn.addEventListener('click', async () => {
          if (!isOwner()) return;
          if (!confirm(t('maintenance.confirm_start_now'))) return;
          const modeSelect = document.getElementById('maintenanceModeSelect');
          const warningStartInput = document.getElementById('maintenanceWarningStartInput');
          const retryAfterInput = document.getElementById('maintenanceRetryAfterInput');
          const msgInput = document.getElementById('maintenanceMessageInput');
          const now = new Date();
          const warningVal = (warningStartInput?.value || '').trim();
          const warningStartDate = warningVal ? parseLocalDateTimeInput(warningVal) : null;
          const retryAfterSeconds = Math.max(60, Number(retryAfterInput?.value || state.settings.maintenanceRetryAfterSeconds || 3600) || 3600);
          if (warningVal && !warningStartDate) {
            alert('Invalid warning start date/time.');
            return;
          }
          state.settings.maintenanceEnabled = true;
          state.settings.maintenanceMode = normalizeMaintenanceMode(modeSelect?.value || state.settings.maintenanceMode || 'graceful');
          state.settings.maintenanceStartAt = now.toISOString();
          state.settings.maintenanceEndAt = '';
          state.settings.maintenanceWarningStartAt = warningStartDate ? warningStartDate.toISOString() : '';
          state.settings.maintenanceRetryAfterSeconds = retryAfterSeconds;
          state.settings.maintenanceStart = toDateOnly(now);
          state.settings.maintenanceEnd = '';
          state.settings.maintenanceMessage = (msgInput?.value || '').trim();
          saveState();
          applySettingsToUI();
          renderMaintenanceUI();
          try {
            await syncHardStopEdgeGate('maintenance_start_now');
          } catch (err) {
            console.warn('Hard-stop sync failed after maintenance start-now', err);
            alert(`Maintenance started, but Cloudflare hard-stop sync failed.\n${err?.message || err}`);
          }
        });
      }
      if (maintenanceClearBtn) {
        maintenanceClearBtn.addEventListener('click', async () => {
          if (!isOwner()) return;
          if (!confirm(t('maintenance.confirm_clear'))) return;
          const previousSettings = { ...state.settings };
          state.settings.maintenanceEnabled = false;
          state.settings.maintenanceStart = '';
          state.settings.maintenanceEnd = '';
          state.settings.maintenanceStartAt = '';
          state.settings.maintenanceEndAt = '';
          state.settings.maintenanceWarningStartAt = '';
          state.settings.maintenanceMode = 'graceful';
          state.settings.maintenanceRetryAfterSeconds = 3600;
          state.settings.maintenanceMessage = '';
          saveState();
          applySettingsToUI();
          renderMaintenanceUI();
          try {
            await syncHardStopEdgeGate('maintenance_clear');
          } catch (err) {
            console.warn('Hard-stop sync failed after maintenance clear', err);
            state.settings = { ...previousSettings };
            saveState();
            applySettingsToUI();
            renderMaintenanceUI();
            alert(`Maintenance clear was rolled back because Cloudflare hard-stop sync failed.\n${err?.message || err}`);
          }
        });
      }
      const announcementTypeSelect = document.getElementById('announcementTypeSelect');
      if (announcementTypeSelect) {
        announcementTypeSelect.addEventListener('change', () => toggleAnnouncementTypeFields());
      }
      const announcementPresetDomainBtn = document.getElementById('announcementPresetDomainBtn');
      if (announcementPresetDomainBtn) {
        announcementPresetDomainBtn.addEventListener('click', () => applyAnnouncementPreset('domain_change'));
      }
      const announcementPresetPrivacyBtn = document.getElementById('announcementPresetPrivacyBtn');
      if (announcementPresetPrivacyBtn) {
        announcementPresetPrivacyBtn.addEventListener('click', () => applyAnnouncementPreset('privacy_policy_update'));
      }
      const announcementAddButtonRowBtn = document.getElementById('announcementAddButtonRowBtn');
      if (announcementAddButtonRowBtn) {
        announcementAddButtonRowBtn.addEventListener('click', () => appendAnnouncementButtonRow('', ''));
      }
      const announcementButtonRows = document.getElementById('announcementButtonRows');
      if (announcementButtonRows) {
        announcementButtonRows.addEventListener('click', (event) => {
          const removeBtn = event.target?.closest?.('.announcement-btn-remove');
          if (!removeBtn) return;
          const row = removeBtn.closest('.announcement-button-row');
          if (row) row.remove();
        });
      }
      const publishAnnouncementBtn = document.getElementById('publishAnnouncementBtn');
      if (publishAnnouncementBtn) {
        publishAnnouncementBtn.addEventListener('click', () => publishAnnouncementFromSettings());
      }
      const createDebugPairBtn = document.getElementById('createDebugTestPairBtn');
      if (createDebugPairBtn) {
        createDebugPairBtn.addEventListener('click', () => {
          createDebugTestPair();
        });
      }
      const refreshDebugPairsBtn = document.getElementById('refreshDebugTestPairsBtn');
      if (refreshDebugPairsBtn) {
        refreshDebugPairsBtn.addEventListener('click', () => renderDebugTestPairs());
      }
      document.getElementById('exportDataBtn').addEventListener('click', () => {
        document.getElementById('backupTextarea').value = JSON.stringify(state, null, 2);
      });
      document.getElementById('importDataBtn').addEventListener('click', () => {
        const txt = document.getElementById('backupTextarea').value.trim();
        if (!txt) return alert(t('maintenance.alert_paste_json'));
        try {
          const imported = JSON.parse(txt);
          state = Object.assign(deepClone(defaultState), imported);
          saveState();
          renderAllViews();
          applySettingsToUI();
          alert(t('maintenance.alert_import_success'));
        } catch (e) {
          alert(t('maintenance.alert_invalid_json'));
        }
      });

      document.getElementById('addStudentBtn').addEventListener('click', () => { if (guardEdit()) openStudentModal(); });
      document.getElementById('addSessionBtn').addEventListener('click', () => { if (guardEdit()) openSessionModal(); });
      document.getElementById('addResourceBtn').addEventListener('click', () => { if (guardEdit()) openResourceModal(); });
      document.getElementById('addInvoiceBtn').addEventListener('click', () => { if (guardEdit()) openInvoiceModal(); });
      const sendOverdueReminderEmailsBtn = document.getElementById('sendOverdueReminderEmailsBtn');
      if (sendOverdueReminderEmailsBtn) {
        sendOverdueReminderEmailsBtn.addEventListener('click', () => {
          sendOverdueReminderEmails();
        });
      }
      const sendOverdueReminderTestEmailBtn = document.getElementById('sendOverdueReminderTestEmailBtn');
      if (sendOverdueReminderTestEmailBtn) {
        sendOverdueReminderTestEmailBtn.addEventListener('click', () => {
          sendOverdueReminderTestEmail();
        });
      }
      const addParentBtn = document.getElementById('addParentBtn');
      if (addParentBtn) addParentBtn.onclick = () => { if (guardEdit()) openParentModal(); };
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) {
        refreshBtn.onclick = async () => {
          if (supabaseAvailable) {
            await tryLoadRemoteThenLocal();
            renderAllViews();
          } else {
            state = loadState();
            renderAllViews();
          }
        };
      }
      const deleteBtn = document.getElementById('deleteAccountBtn');
      if (deleteBtn) deleteBtn.onclick = deleteAccountFlow;

      // Show portal nav only for student mode
      const navPortal = document.getElementById('navPortalBtn');
      if (navPortal) {
        navPortal.classList.toggle('hidden', !studentMode);
        if (studentMode) navPortal.classList.add('bg-slate-800', 'active');
      }
      const navParentPortal = document.getElementById('navParentPortalBtn');
      if (navParentPortal) {
        navParentPortal.classList.toggle('hidden', !parentMode);
        if (parentMode) navParentPortal.classList.add('bg-slate-800', 'active');
      }
      const navFinance = document.getElementById('navFinanceBtn');
      const navReports = document.getElementById('navReportsBtn');
      if (navFinance) navFinance.classList.toggle('hidden', studentMode || parentMode);
      if (navReports) navReports.classList.toggle('hidden', studentMode || parentMode);
      const navDashboard = document.querySelector('.nav-btn[data-view="dashboard"]');
      if (navDashboard) navDashboard.classList.toggle('hidden', studentMode || parentMode);

      const exportIcsBtn = document.getElementById('exportIcsBtn');
      if (exportIcsBtn) {
        exportIcsBtn.onclick = downloadIcsFile;
      }
    }

    function applySettingsToUI() {
      const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.value = val ?? '';
      };
      const setChecked = (id, checked) => {
        const el = document.getElementById(id);
        if (el) el.checked = !!checked;
      };
      setVal('settingsThemeSelect', state.settings.theme);
      setVal('settingsDensitySelect', state.settings.density);
      setVal('settingsWeeklyGoal', state.settings.weeklyGoalHours);
      setVal('settingsMonthlyGoal', state.settings.monthlyIncomeGoal);
      setVal('settingsReflection', state.settings.reflection || '');
      setVal('settingsDefaultDuration', state.settings.defaultSessionDuration ?? 1.5);
      setVal('settingsPendingReviewGraceHours', state.settings.pendingReviewGraceHours ?? 24);
      setChecked('settingsChargeableNoShow', !!state.settings.policyChargeableNoShow);
      setChecked('settingsChargeableLateCancel', !!state.settings.policyChargeableLateCancel);
      setVal('notifySessionsDays', state.settings.notifySessionsDays ?? 3);
      setVal('notifyHomeworkDays', state.settings.notifyHomeworkDays ?? 3);
      setVal('notifyInvoicesDays', state.settings.notifyInvoicesDays ?? 3);
      const startAtValue = state.settings.maintenanceStartAt || '';
      const endAtValue = state.settings.maintenanceEndAt || '';
      const warningAtValue = state.settings.maintenanceWarningStartAt || '';
      const legacyStart = state.settings.maintenanceStart || '';
      const legacyEnd = state.settings.maintenanceEnd || '';
      setVal('maintenanceModeSelect', normalizeMaintenanceMode(state.settings.maintenanceMode || 'graceful'));
      setVal('maintenanceWarningStartInput', toLocalDateTimeInput(warningAtValue));
      setVal('maintenanceStartInput', toLocalDateTimeInput(startAtValue || (legacyStart ? `${legacyStart}T00:00` : '')));
      setVal('maintenanceEndInput', toLocalDateTimeInput(endAtValue || (legacyEnd ? `${legacyEnd}T23:59` : '')));
      setVal('maintenanceRetryAfterInput', Math.max(60, Number(state.settings.maintenanceRetryAfterSeconds || 3600) || 3600));
      setVal('maintenanceMessageInput', state.settings.maintenanceMessage || '');
      const startInput = document.getElementById('maintenanceStartInput');
      if (startInput) startInput.min = getMaintenanceMinDate();
      setVal('announcementTypeSelect', 'general');
      toggleAnnouncementTypeFields();
      setAnnouncementButtonRows([]);
      const announcementStatus = document.getElementById('announcementAdminStatus');
      if (announcementStatus) {
        announcementStatus.textContent = '';
        announcementStatus.classList.add('hidden');
      }
      // lock settings for students
      const lockIds = [
        'settingsWeeklyGoal', 'settingsMonthlyGoal', 'settingsDefaultDuration',
        'settingsPendingReviewGraceHours', 'settingsChargeableNoShow', 'settingsChargeableLateCancel',
        'settingsReflection', 'notifySessionsDays', 'notifyHomeworkDays', 'notifyInvoicesDays'
      ];
      lockIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = studentMode;
      });
      const statusText = document.getElementById('maintenanceStatusText');
      if (statusText) {
        const status = getMaintenanceStatus();
        if (!status.enabled) {
          statusText.textContent = t('maintenance.none_scheduled');
        } else if (status.active) {
          if (status.mode === 'hard_stop') {
            const retrySeconds = Math.max(60, Number(status.retryAfterSeconds || 3600) || 3600);
            statusText.textContent = `Hard stop active (503). Retry-After: ${retrySeconds}s${status.endAt ? ` ‚Ä¢ ${formatMaintenanceRange(status)}` : ''}`;
          } else {
            statusText.textContent = status.endAt
              ? t('maintenance.active_until', {
                countdown: formatCountdown(status.msToEnd),
                range: formatMaintenanceRange(status)
              })
              : t('maintenance.active_open');
          }
        } else if (status.warning) {
          statusText.textContent = `Warning phase active. Maintenance ${status.mode === 'hard_stop' ? 'hard stop' : 'restricted mode'} starts in ${formatCountdown(status.msToStart)} (${formatMaintenanceRange(status)}).`;
        } else if (status.scheduled) {
          statusText.textContent = t('maintenance.scheduled_starts_in', {
            range: formatMaintenanceRange(status),
            countdown: formatCountdown(status.msToStart)
          });
        } else {
          statusText.textContent = t('maintenance.scheduled_for', { range: formatMaintenanceRange(status) });
        }
      }
      applyTheme();
      applyDensity();
      if (announcementAdminTicker) {
        clearInterval(announcementAdminTicker);
        announcementAdminTicker = null;
      }
      if (isOwner()) {
        loadOwnerAnnouncements();
        announcementAdminTicker = setInterval(() => {
          renderOwnerAnnouncementsList();
          deactivateExpiredAnnouncementsForOwner();
        }, 60 * 1000);
      } else {
        ownerAnnouncements = [];
        renderOwnerAnnouncementsList();
      }
      renderDebugTestPairs();
    }

    function pad2(n) {
      return String(n).padStart(2, '0');
    }

    function toLocalDateTimeInput(value) {
      if (!value) return '';
      const d = value instanceof Date ? value : new Date(value);
      if (Number.isNaN(d.getTime())) return '';
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    function parseLocalDateTimeInput(value) {
      const raw = String(value || '').trim();
      if (!raw) return null;
      const [datePart, timePart] = raw.split('T');
      if (!datePart || !timePart) return null;
      const [y, m, d] = datePart.split('-').map(Number);
      const [hh, mm] = timePart.split(':').map(Number);
      if (!y || !m || !d) return null;
      return new Date(y, (m - 1), d, hh || 0, mm || 0, 0, 0);
    }

    function formatDateTimeShort(value) {
      if (!value) return '';
      const d = value instanceof Date ? value : new Date(value);
      if (Number.isNaN(d.getTime())) return '';
      return `${toDateOnly(d)} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    function formatCountdown(ms) {
      if (!Number.isFinite(ms) || ms <= 0) return '0m';
      const totalMinutes = Math.ceil(ms / 60000);
      const days = Math.floor(totalMinutes / 1440);
      const hours = Math.floor((totalMinutes % 1440) / 60);
      const minutes = totalMinutes % 60;
      const parts = [];
      if (days) parts.push(`${days}d`);
      if (hours) parts.push(`${hours}h`);
      if (!days && minutes) parts.push(`${minutes}m`);
      return parts.join(' ');
    }

    function getMaintenanceMinDate() {
      const d = new Date();
      d.setDate(d.getDate() + MAINTENANCE_MIN_DAYS);
      d.setHours(0, 0, 0, 0);
      return toLocalDateTimeInput(d);
    }

    function formatMaintenanceRange(status) {
      if (!status?.startAt) return '';
      const startLabel = formatDateTimeShort(status.startAt);
      if (status.endAt) return `${startLabel} ‚Äì ${formatDateTimeShort(status.endAt)}`;
      return startLabel;
    }

    function normalizeMaintenanceMode(value) {
      return String(value || '').trim().toLowerCase() === 'hard_stop' ? 'hard_stop' : 'graceful';
    }

    function isMaintenanceGracefulWriteBlocked() {
      const status = getMaintenanceStatus();
      return status.gracefulActive && !isOwner();
    }

    function isMaintenanceHardStopForViewer() {
      const status = getMaintenanceStatus();
      return status.hardStopActive && !isOwner();
    }

    function guardMaintenanceWrite(actionLabel = 'This action') {
      const status = getMaintenanceStatus();
      if (!(status.gracefulActive || status.hardStopActive) || isOwner()) return true;
      const range = formatMaintenanceRange(status);
      const message = status.message || (status.hardStopActive
        ? 'Service is temporarily unavailable due to maintenance.'
        : 'Maintenance in progress');
      alert(`${actionLabel} is temporarily disabled during maintenance.\n${message}${range ? `\nWindow: ${range}` : ''}`);
      return false;
    }

    async function getEdgeInvokeErrorMeta(error, fallbackMessage = 'Request failed') {
      let status = Number(
        error?.context?.status ||
        error?.status ||
        error?.response?.status ||
        0
      );
      let message = String(error?.message || fallbackMessage).trim();
      const response = (
        (typeof Response !== 'undefined' && error?.context instanceof Response) ? error.context :
        (typeof Response !== 'undefined' && error?.response instanceof Response) ? error.response :
        null
      );
      if (response) {
        if (!status) status = Number(response.status || 0);
        try {
          const bodyText = await response.clone().text();
          if (bodyText) {
            try {
              const parsed = JSON.parse(bodyText);
              const bodyMsg = String(parsed?.error || parsed?.message || '').trim();
              if (bodyMsg) message = bodyMsg;
            } catch {
              message = String(bodyText).trim().slice(0, 300) || message;
            }
          }
        } catch {
          // keep fallback message
        }
      }
      return { status, message: message || fallbackMessage };
    }

    async function syncHardStopEdgeGate(source = 'dashboard_maintenance') {
      if (!isOwner()) return { skipped: true };
      if (!isSupabaseReady()) {
        throw new Error('Cloudflare sync is unavailable right now. Please sign out and sign in again, then retry.');
      }
      const status = getMaintenanceStatus();
      const targetMode = status.hardStopActive ? 'hard_stop' : 'off';
      const retryAfter = Math.max(60, Number(status.retryAfterSeconds || 3600) || 3600);
      const maintenanceMode = normalizeMaintenanceMode(state.settings.maintenanceMode || 'graceful');
      const accessToken = requireAccessToken(t('alert.sign_in_first'));
      const { data, error } = await supabaseClient.functions.invoke('sync-maintenance-hard-stop', {
        body: {
          mode: targetMode,
          retry_after: retryAfter,
          maintenance_enabled: !!state.settings.maintenanceEnabled,
          maintenance_mode: maintenanceMode,
          maintenance_start_at: state.settings.maintenanceStartAt || null,
          maintenance_end_at: state.settings.maintenanceEndAt || null,
          maintenance_warning_start_at: state.settings.maintenanceWarningStartAt || null,
          source
        },
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      if (error) {
        const meta = await getEdgeInvokeErrorMeta(error, 'Unable to sync hard-stop mode to Cloudflare.');
        if (meta.status === 401) {
          throw new Error('Re-authentication required. Please sign out and sign in again, then retry hard-stop sync.');
        }
        throw new Error(meta.message || 'Unable to sync hard-stop mode to Cloudflare.');
      }
      if (!data?.success) {
        throw new Error(data?.error || 'Cloudflare hard-stop sync failed.');
      }
      return data;
    }

    function getMaintenanceStatus() {
      const enabled = !!state.settings.maintenanceEnabled;
      const mode = normalizeMaintenanceMode(state.settings.maintenanceMode || 'graceful');
      let startAt = state.settings.maintenanceStartAt ? new Date(state.settings.maintenanceStartAt) : null;
      let endAt = state.settings.maintenanceEndAt ? new Date(state.settings.maintenanceEndAt) : null;
      let warningStartAt = state.settings.maintenanceWarningStartAt ? new Date(state.settings.maintenanceWarningStartAt) : null;
      if ((!startAt || Number.isNaN(startAt.getTime())) && state.settings.maintenanceStart) {
        startAt = new Date(state.settings.maintenanceStart + 'T00:00:00');
      }
      if ((!endAt || Number.isNaN(endAt.getTime())) && state.settings.maintenanceEnd) {
        endAt = new Date(state.settings.maintenanceEnd + 'T23:59:00');
      }
      if ((!warningStartAt || Number.isNaN(warningStartAt.getTime())) && startAt && !Number.isNaN(startAt.getTime())) {
        warningStartAt = new Date(startAt.getTime() - (24 * 60 * 60 * 1000));
      }
      if (!enabled || !startAt || Number.isNaN(startAt.getTime())) {
        return {
          enabled: false,
          active: false,
          scheduled: false,
          warning: false,
          gracefulActive: false,
          hardStopActive: false,
          mode,
          startAt: null,
          endAt: null,
          warningStartAt: null,
          message: '',
          retryAfterSeconds: Math.max(60, Number(state.settings.maintenanceRetryAfterSeconds || 3600) || 3600)
        };
      }
      const now = new Date();
      if (endAt && now > endAt) {
        return {
          enabled: false,
          active: false,
          scheduled: false,
          warning: false,
          gracefulActive: false,
          hardStopActive: false,
          mode,
          startAt: null,
          endAt: null,
          warningStartAt: null,
          message: '',
          retryAfterSeconds: Math.max(60, Number(state.settings.maintenanceRetryAfterSeconds || 3600) || 3600)
        };
      }
      const active = now >= startAt && (!endAt || now <= endAt);
      const scheduled = now < startAt;
      const warning = !!(scheduled && warningStartAt && now >= warningStartAt);
      const msToStart = startAt ? startAt.getTime() - now.getTime() : 0;
      const msToEnd = endAt ? endAt.getTime() - now.getTime() : 0;
      const retryAfterSeconds = Math.max(60, Number(state.settings.maintenanceRetryAfterSeconds || 3600) || 3600);
      return {
        enabled: true,
        active,
        scheduled,
        warning,
        gracefulActive: active && mode === 'graceful',
        hardStopActive: active && mode === 'hard_stop',
        mode,
        startAt,
        endAt,
        warningStartAt,
        msToStart,
        msToEnd,
        retryAfterSeconds,
        message: (state.settings.maintenanceMessage || '').trim()
      };
    }

    function renderMaintenanceUI() {
      const status = getMaintenanceStatus();
      const banner = document.getElementById('maintenanceBanner');
      const overlay = document.getElementById('maintenanceOverlay');
      const overlayTitle = document.getElementById('maintenanceOverlayTitle');
      const overlayMsg = document.getElementById('maintenanceOverlayMessage');
      if (banner) {
        if (!status.enabled) {
          banner.classList.add('hidden');
          banner.textContent = '';
        } else {
          banner.classList.remove('hidden');
          if (status.hardStopActive) {
            const suffix = status.endAt
              ? t('maintenance.overlay_ends_in', { countdown: formatCountdown(status.msToEnd) })
              : t('maintenance.overlay_active_until');
            banner.textContent = `Maintenance hard stop active (503 mode). ${status.message || t('maintenance.banner_default_active')} ‚Ä¢ ${suffix}`;
          } else if (status.gracefulActive) {
            const suffix = status.endAt
              ? t('maintenance.overlay_ends_in', { countdown: formatCountdown(status.msToEnd) })
              : t('maintenance.overlay_active_until');
            banner.textContent = `Maintenance restricted mode active. Write actions are temporarily disabled. ${t('maintenance.banner_active', {
              range: formatMaintenanceRange(status),
              suffix,
              message: status.message || t('maintenance.banner_default_active')
            })}`;
          } else if (status.warning) {
            banner.textContent = `Scheduled maintenance warning: ${status.mode === 'hard_stop' ? 'hard stop (503)' : 'restricted mode'} begins in ${formatCountdown(status.msToStart)} (${formatMaintenanceRange(status)}). ${status.message || t('maintenance.banner_default')}`;
          } else if (status.scheduled) {
            banner.textContent = t('maintenance.banner_scheduled_starts', {
              countdown: formatCountdown(status.msToStart),
              range: formatMaintenanceRange(status),
              message: status.message || t('maintenance.banner_default')
            });
          } else {
            banner.textContent = t('maintenance.banner_scheduled', {
              range: formatMaintenanceRange(status),
              message: status.message || t('maintenance.banner_default')
            });
          }
        }
      }
      if (overlay) {
        if (status.hardStopActive && !isOwner()) {
          overlay.classList.add('show');
        } else {
          overlay.classList.remove('show');
        }
      }
      if (overlayTitle) {
        overlayTitle.textContent = status.hardStopActive
          ? 'Service temporarily unavailable (maintenance)'
          : 'Scheduled maintenance in progress';
      }
      if (overlayMsg && status.hardStopActive) {
        const extra = status.endAt
          ? t('maintenance.overlay_ends_in', { countdown: formatCountdown(status.msToEnd) })
          : t('maintenance.overlay_active_until');
        const retryAfter = Math.max(60, Number(status.retryAfterSeconds || 3600) || 3600);
        const details = status.message
          ? t('maintenance.overlay_with_message', {
            message: status.message,
            range: formatMaintenanceRange(status),
            extra
          })
          : t('maintenance.overlay_default', {
            range: formatMaintenanceRange(status),
            extra
          });
        overlayMsg.textContent = `${details} Retry-After: ${retryAfter}s`;
      }
      if (status.enabled && !maintenanceTicker) {
        maintenanceTicker = setInterval(() => renderMaintenanceUI(), 60000);
      } else if (!status.enabled && maintenanceTicker) {
        clearInterval(maintenanceTicker);
        maintenanceTicker = null;
      }
    }

    function normalizeAnnouncementType(type) {
      const raw = String(type || '').trim().toLowerCase();
      if (raw === 'domain_change') return 'domain_change';
      if (raw === 'privacy_policy_update') return 'privacy_policy_update';
      return 'general';
    }

    function formatAnnouncementTypeLabel(type) {
      const normalized = normalizeAnnouncementType(type);
      if (normalized === 'domain_change') return 'Domain change';
      if (normalized === 'privacy_policy_update') return 'Privacy policy update';
      return 'General';
    }

    function resolveAnnouncementSeenVersion(announcement) {
      const raw = String(
        announcement?.seen_version ||
        announcement?.updated_at ||
        announcement?.publish_at ||
        announcement?.created_at ||
        ''
      ).trim();
      if (!raw) return 'v0';
      const ts = new Date(raw).getTime();
      if (Number.isFinite(ts) && !Number.isNaN(ts)) return `ts_${ts}`;
      return `raw_${raw.replace(/[^a-z0-9]+/gi, '_').slice(0, 48)}`;
    }

    function getAnnouncementSeenStorageKey(userId, announcementId, seenVersion = '') {
      const uid = cleanId(userId);
      const aid = cleanId(announcementId);
      const version = String(seenVersion || 'v0').trim() || 'v0';
      return `announcement_seen_v1_${uid}_${aid}_${version}`;
    }

    function isAnnouncementLocallySeen(userId, announcementId, seenVersion = '') {
      const key = getAnnouncementSeenStorageKey(userId, announcementId, seenVersion);
      return localStorage.getItem(key) === '1';
    }

    function markAnnouncementLocallySeen(userId, announcementId, seenVersion = '') {
      const key = getAnnouncementSeenStorageKey(userId, announcementId, seenVersion);
      localStorage.setItem(key, '1');
    }

    function clearAnnouncementLocalSeen(userId, announcementId) {
      const uid = cleanId(userId);
      const aid = cleanId(announcementId);
      const prefix = `announcement_seen_v1_${uid}_${aid}_`;
      const toDelete = [];
      for (let i = 0; i < localStorage.length; i += 1) {
        const key = localStorage.key(i);
        if (key && key.startsWith(prefix)) toDelete.push(key);
      }
      toDelete.forEach(key => localStorage.removeItem(key));
    }

    function isMissingColumnError(err, columnName) {
      const col = String(columnName || '').trim().toLowerCase();
      if (!col) return false;
      const code = String(err?.code || '').trim();
      const msg = String(err?.message || '').toLowerCase();
      return code === '42703' || (msg.includes('column') && msg.includes(col) && msg.includes('does not exist'));
    }

    function normalizeAnnouncementButtons(rawButtons, fallbackLabel, fallbackUrl) {
      const out = [];
      const pushIfValid = (labelRaw, urlRaw) => {
        const label = String(labelRaw || '').trim();
        const url = normalizeAnnouncementUrl(urlRaw);
        if (!label || !url) return;
        const key = `${label}::${url}`;
        if (out.some(btn => `${btn.label}::${btn.url}` === key)) return;
        out.push({ label, url });
      };
      if (Array.isArray(rawButtons)) {
        rawButtons.forEach(btn => {
          pushIfValid(btn?.label, btn?.url);
        });
      }
      if (!out.length) {
        pushIfValid(fallbackLabel, fallbackUrl);
      }
      return out.slice(0, 6);
    }

    function buildAnnouncementButtonRow(label = '', url = '') {
      return `
        <div class="announcement-button-row border border-slate-200 rounded-lg p-2 bg-slate-50/60">
          <div class="grid grid-cols-1 sm:grid-cols-[minmax(0,1fr),minmax(0,1fr),auto] gap-2 items-end">
            <label class="text-[10px]">
              <span class="text-slate-600">Label</span>
              <input type="text" value="${esc(label)}"
                placeholder="Read Terms"
                class="announcement-btn-label mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px] bg-white">
            </label>
            <label class="text-[10px]">
              <span class="text-slate-600">URL</span>
              <input type="text" value="${esc(url)}"
                placeholder="https://example.com/terms"
                class="announcement-btn-url mt-1 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px] bg-white">
            </label>
            <button type="button"
              class="announcement-btn-remove px-2 py-1 rounded-lg border border-rose-200 text-rose-700 text-[10px]">
              Remove
            </button>
          </div>
        </div>
      `;
    }

    function appendAnnouncementButtonRow(label = '', url = '') {
      const rows = document.getElementById('announcementButtonRows');
      if (!rows) return;
      rows.insertAdjacentHTML('beforeend', buildAnnouncementButtonRow(label, url));
    }

    function setAnnouncementButtonRows(buttons = []) {
      const rows = document.getElementById('announcementButtonRows');
      if (!rows) return;
      rows.innerHTML = '';
      const valid = Array.isArray(buttons) ? buttons : [];
      valid.forEach(btn => appendAnnouncementButtonRow(btn?.label || '', btn?.url || ''));
    }

    function readAnnouncementButtonRowsFromInputs() {
      const rows = document.getElementById('announcementButtonRows');
      if (!rows) return [];
      const buttons = [];
      rows.querySelectorAll('.announcement-button-row').forEach(row => {
        const label = String(row.querySelector('.announcement-btn-label')?.value || '').trim();
        const urlRaw = String(row.querySelector('.announcement-btn-url')?.value || '').trim();
        if (!label && !urlRaw) return;
        if (!label || !urlRaw) {
          throw new Error('Each additional button needs both label and URL.');
        }
        const url = normalizeAnnouncementUrl(urlRaw);
        if (!url) throw new Error(`Invalid button URL: ${urlRaw}`);
        buttons.push({ label, url });
      });
      return buttons;
    }

    function normalizeAnnouncementUrl(value) {
      const raw = String(value || '').trim();
      if (!raw) return '';
      let candidate = raw;
      if (candidate.startsWith('./') || candidate.startsWith('/')) {
        candidate = appUrl(candidate.replace(/^\.\//, '/'));
      } else if (!/^https?:\/\//i.test(candidate)) {
        candidate = ensureHttpUrl(candidate);
      }
      try {
        const parsed = new URL(candidate);
        if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') return '';
        return parsed.href;
      } catch (_err) {
        return '';
      }
    }

    function announcementDefaultsForType(type, draft = {}) {
      const normalized = normalizeAnnouncementType(type);
      if (normalized === 'domain_change') {
        const fromDomain = String(draft.domain_from || '').trim();
        const toDomain = String(draft.domain_to || '').trim();
        const fromLabel = fromDomain || 'the previous domain';
        const toLabel = toDomain || window.location.host;
        const title = 'Domain update';
        const body = `We moved from ${fromLabel} to ${toLabel}. Please use the new domain for future access.`;
        const ctaLabel = 'Open new domain';
        const ctaUrl = toDomain ? ensureHttpUrl(toDomain) : APP_ORIGIN;
        return {
          title,
          body,
          ctaLabel,
          ctaUrl,
          ctaButtons: [{ label: ctaLabel, url: ctaUrl }]
        };
      }
      if (normalized === 'privacy_policy_update') {
        const version = String(draft.policy_version || '').trim();
        const versionPart = version ? ` (${version})` : '';
        const title = `Privacy Policy update${versionPart}`;
        const body = 'Our Privacy Policy was updated. Please review the latest version.';
        const ctaLabel = 'Read Privacy Policy';
        const ctaUrl = appUrl('/privacy.html');
        return {
          title,
          body,
          ctaLabel,
          ctaUrl,
          ctaButtons: [
            { label: 'Read Privacy Policy', url: appUrl('/privacy.html') },
            { label: 'Read Terms of Service', url: appUrl('/tos.html') }
          ]
        };
      }
      return {
        title: 'Important update',
        body: 'Please review this announcement.',
        ctaLabel: '',
        ctaUrl: '',
        ctaButtons: []
      };
    }

    function toggleAnnouncementTypeFields() {
      const type = normalizeAnnouncementType(document.getElementById('announcementTypeSelect')?.value || 'general');
      const domainFields = document.getElementById('announcementDomainFields');
      const privacyFields = document.getElementById('announcementPrivacyFields');
      if (domainFields) domainFields.classList.toggle('hidden', type !== 'domain_change');
      if (privacyFields) privacyFields.classList.toggle('hidden', type !== 'privacy_policy_update');
    }

    function applyAnnouncementPreset(type) {
      const normalized = normalizeAnnouncementType(type);
      const typeSelect = document.getElementById('announcementTypeSelect');
      if (typeSelect) typeSelect.value = normalized;
      toggleAnnouncementTypeFields();
      const draft = {
        domain_from: document.getElementById('announcementDomainFromInput')?.value || '',
        domain_to: document.getElementById('announcementDomainToInput')?.value || '',
        policy_version: document.getElementById('announcementPolicyVersionInput')?.value || ''
      };
      const defaults = announcementDefaultsForType(normalized, draft);
      const titleInput = document.getElementById('announcementTitleInput');
      const bodyInput = document.getElementById('announcementBodyInput');
      const ctaLabelInput = document.getElementById('announcementCtaLabelInput');
      const ctaUrlInput = document.getElementById('announcementCtaUrlInput');
      if (titleInput && !String(titleInput.value || '').trim()) titleInput.value = defaults.title;
      if (bodyInput && !String(bodyInput.value || '').trim()) bodyInput.value = defaults.body;
      if (ctaLabelInput && !String(ctaLabelInput.value || '').trim()) ctaLabelInput.value = defaults.ctaLabel;
      if (ctaUrlInput && !String(ctaUrlInput.value || '').trim()) ctaUrlInput.value = defaults.ctaUrl;
      const hasRows = Array.from(document.querySelectorAll('#announcementButtonRows .announcement-button-row')).length > 0;
      if (!hasRows && Array.isArray(defaults.ctaButtons) && defaults.ctaButtons.length) {
        setAnnouncementButtonRows(defaults.ctaButtons);
      }
    }

    function buildAnnouncementPayloadFromInputs() {
      const type = normalizeAnnouncementType(document.getElementById('announcementTypeSelect')?.value || 'general');
      const titleRaw = String(document.getElementById('announcementTitleInput')?.value || '').trim();
      const bodyRaw = String(document.getElementById('announcementBodyInput')?.value || '').trim();
      const ctaLabelRaw = String(document.getElementById('announcementCtaLabelInput')?.value || '').trim();
      const ctaUrlRaw = String(document.getElementById('announcementCtaUrlInput')?.value || '').trim();
      const expiresRaw = String(document.getElementById('announcementExpiresAtInput')?.value || '').trim();
      const domainFromRaw = String(document.getElementById('announcementDomainFromInput')?.value || '').trim();
      const domainToRaw = String(document.getElementById('announcementDomainToInput')?.value || '').trim();
      const policyVersionRaw = String(document.getElementById('announcementPolicyVersionInput')?.value || '').trim();
      const policyUrlRaw = String(document.getElementById('announcementPolicyUrlInput')?.value || '').trim();
      const defaults = announcementDefaultsForType(type, {
        domain_from: domainFromRaw,
        domain_to: domainToRaw,
        policy_version: policyVersionRaw
      });
      const title = titleRaw || defaults.title;
      const body = bodyRaw || defaults.body;
      const ctaLabel = ctaLabelRaw || defaults.ctaLabel;
      let ctaUrl = ctaUrlRaw || defaults.ctaUrl;
      if (!ctaUrl && type === 'privacy_policy_update' && policyUrlRaw) {
        ctaUrl = policyUrlRaw;
      }
      ctaUrl = normalizeAnnouncementUrl(ctaUrl);
      if (ctaLabel && !ctaUrl) {
        throw new Error('Primary button URL is required when a primary label is provided.');
      }
      if (!ctaLabel && ctaUrl) {
        throw new Error('Primary button label is required when a primary URL is provided.');
      }
      const additionalButtons = readAnnouncementButtonRowsFromInputs();
      const defaultButtons = Array.isArray(defaults.ctaButtons) ? defaults.ctaButtons : [];
      let ctaButtons = [];
      if (ctaLabel && ctaUrl) {
        ctaButtons.push({ label: ctaLabel, url: ctaUrl });
      }
      ctaButtons = ctaButtons.concat(additionalButtons);
      if (!ctaButtons.length && defaultButtons.length && !titleRaw && !bodyRaw) {
        ctaButtons = normalizeAnnouncementButtons(defaultButtons, '', '');
      } else {
        ctaButtons = normalizeAnnouncementButtons(ctaButtons, '', '');
      }
      if (ctaButtons.length > 6) {
        throw new Error('Maximum 6 announcement buttons are allowed.');
      }
      const expiresAtDate = expiresRaw ? parseLocalDateTimeInput(expiresRaw) : null;
      if (expiresRaw && !expiresAtDate) {
        throw new Error('Invalid expiry date/time.');
      }
      if (expiresAtDate && expiresAtDate <= new Date()) {
        throw new Error('Expiry must be in the future.');
      }
      return {
        announcement_type: type,
        title,
        body,
        cta_label: ctaButtons[0]?.label || null,
        cta_url: ctaButtons[0]?.url || null,
        cta_buttons: ctaButtons.length ? ctaButtons : null,
        domain_from: domainFromRaw || null,
        domain_to: domainToRaw || null,
        policy_version: policyVersionRaw || null,
        publish_at: new Date().toISOString(),
        expires_at: expiresAtDate ? expiresAtDate.toISOString() : null,
        is_active: true
      };
    }

    function clearAnnouncementComposer(resetType = false) {
      const setVal = (id, value = '') => {
        const el = document.getElementById(id);
        if (el) el.value = value;
      };
      if (resetType) setVal('announcementTypeSelect', 'general');
      setVal('announcementTitleInput', '');
      setVal('announcementBodyInput', '');
      setVal('announcementCtaLabelInput', '');
      setVal('announcementCtaUrlInput', '');
      setVal('announcementExpiresAtInput', '');
      setVal('announcementDomainFromInput', '');
      setVal('announcementDomainToInput', '');
      setVal('announcementPolicyVersionInput', '');
      setVal('announcementPolicyUrlInput', '');
      setAnnouncementButtonRows([]);
      toggleAnnouncementTypeFields();
    }

    function isAnnouncementExpired(announcement, nowTs = Date.now()) {
      const expiresAt = String(announcement?.expires_at || '').trim();
      if (!expiresAt) return false;
      const ts = new Date(expiresAt).getTime();
      if (!Number.isFinite(ts)) return false;
      return ts < nowTs;
    }

    function renderOwnerAnnouncementsList() {
      const list = document.getElementById('announcementAdminList');
      if (!list) return;
      const nowTs = Date.now();
      const visibleAnnouncements = ownerAnnouncements
        .filter(a => !isAnnouncementExpired(a, nowTs))
        .sort((a, b) => new Date(b.publish_at || 0) - new Date(a.publish_at || 0));
      if (!visibleAnnouncements.length) {
        list.innerHTML = `<li class="text-slate-500 text-[11px]">No active announcements right now.</li>`;
        return;
      }
      list.innerHTML = visibleAnnouncements.map(a => {
        const id = cleanId(a.id);
        const isActive = !!a.is_active;
        const publishAt = a.publish_at ? formatDateTimeShort(a.publish_at) : t('common.na');
        const expiresAt = a.expires_at ? formatDateTimeShort(a.expires_at) : 'No expiry';
        const statusClass = isActive ? 'border-emerald-200 bg-emerald-50 text-emerald-700' : 'border-slate-200 bg-slate-100 text-slate-600';
        const toggleLabel = isActive ? 'Deactivate' : 'Activate';
        const buttonCount = Array.isArray(a.cta_buttons) ? a.cta_buttons.length : 0;
        return `
          <li class="border border-slate-200 rounded-lg px-2 py-2 bg-white/90">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="font-medium text-slate-900 truncate">${esc(a.title || 'Untitled announcement')}</div>
                <div class="text-[10px] text-slate-500 mt-0.5">
                  ${esc(formatAnnouncementTypeLabel(a.announcement_type))} ‚Ä¢ Published ${esc(publishAt)} ‚Ä¢ Expires ${esc(expiresAt)} ‚Ä¢ Buttons ${esc(buttonCount)}
                </div>
              </div>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] font-medium ${statusClass}">${isActive ? 'Active' : 'Inactive'}</span>
            </div>
            <div class="mt-2 flex flex-wrap gap-2">
              <button class="px-2 py-1 rounded-lg border border-slate-300 text-[10px]"
                onclick="setAnnouncementActive('${id}', ${isActive ? 'false' : 'true'})">${toggleLabel}</button>
              <button class="px-2 py-1 rounded-lg border border-slate-300 text-[10px]"
                onclick="markAnnouncementSeenForCurrentUser('${id}')">Mark current account seen</button>
              <button class="px-2 py-1 rounded-lg border border-amber-300 text-amber-700 text-[10px]"
                onclick="markAnnouncementUnseenForAll('${id}')">Mark all accounts unseen</button>
            </div>
          </li>
        `;
      }).join('');
    }

    function mapAnnouncementRow(row) {
      const buttons = normalizeAnnouncementButtons(
        row?.cta_buttons,
        row?.cta_label || '',
        row?.cta_url || ''
      );
      return {
        id: row.id,
        announcement_type: normalizeAnnouncementType(row.announcement_type),
        title: row.title || '',
        body: row.body || '',
        cta_label: buttons[0]?.label || row.cta_label || '',
        cta_url: buttons[0]?.url || normalizeAnnouncementUrl(row.cta_url || ''),
        cta_buttons: buttons,
        domain_from: row.domain_from || '',
        domain_to: row.domain_to || '',
        policy_version: row.policy_version || '',
        publish_at: row.publish_at || row.created_at || '',
        updated_at: row.updated_at || '',
        seen_version: resolveAnnouncementSeenVersion(row),
        expires_at: row.expires_at || '',
        is_active: !!row.is_active
      };
    }

    async function deactivateExpiredAnnouncementsForOwner() {
      if (!isSupabaseReady() || !isOwner()) return;
      const nowIso = new Date().toISOString();
      try {
        const { error } = await supabaseClient
          .from('global_announcements')
          .update({
            is_active: false,
            updated_at: nowIso
          })
          .eq('is_active', true)
          .lt('expires_at', nowIso);
        if (error) throw error;
      } catch (err) {
        console.warn('Announcement expiry cleanup failed', err);
      }
    }

    async function loadOwnerAnnouncements() {
      if (!isSupabaseReady() || !isOwner()) {
        ownerAnnouncements = [];
        renderOwnerAnnouncementsList();
        return;
      }
      try {
        await deactivateExpiredAnnouncementsForOwner();
        const { data, error } = await supabaseClient
          .from('global_announcements')
          .select('*')
          .order('publish_at', { ascending: false })
          .limit(30);
        if (error) throw error;
        ownerAnnouncements = (data || []).map(row => mapAnnouncementRow(row));
      } catch (err) {
        console.warn('Announcements load failed', err);
        ownerAnnouncements = [];
      }
      renderOwnerAnnouncementsList();
    }

    async function publishAnnouncementFromSettings() {
      if (!isSupabaseReady() || !isOwner()) {
        alert('Owner sign-in is required.');
        return;
      }
      const statusEl = document.getElementById('announcementAdminStatus');
      const setStatus = (msg, isError = false) => {
        if (!statusEl) return;
        statusEl.textContent = msg;
        statusEl.classList.remove('hidden');
        statusEl.classList.toggle('text-rose-600', !!isError);
        statusEl.classList.toggle('text-emerald-700', !isError);
      };
      try {
        const payload = buildAnnouncementPayloadFromInputs();
        if (!payload.title || !payload.body) {
          throw new Error('Title and message are required.');
        }
        const insertPayload = {
          ...payload,
          created_by: cleanId(supabaseSession?.user?.id || '')
        };
        let { error } = await supabaseClient
          .from('global_announcements')
          .insert(insertPayload);
        if (error && isMissingColumnError(error, 'cta_buttons')) {
          const fallbackPayload = { ...insertPayload };
          delete fallbackPayload.cta_buttons;
          const retry = await supabaseClient
            .from('global_announcements')
            .insert(fallbackPayload);
          error = retry.error;
        }
        if (error) throw error;
        setStatus('Announcement published.');
        clearAnnouncementComposer(false);
        await loadOwnerAnnouncements();
        logActivity('Published announcement', payload.title);
        const primaryButton = Array.isArray(payload.cta_buttons) && payload.cta_buttons.length
          ? payload.cta_buttons[0]
          : null;
        void notifyParentServiceEvent({
          event_type: 'announcement_notice',
          dedupe_key: `announcement_notice:${String(payload.title || '').slice(0, 80)}:${Date.now()}`,
          meta: {
            title: payload.title || '',
            message: payload.body || '',
            policy_version: payload.policy_version || '',
            domain_from: payload.domain_from || '',
            domain_to: payload.domain_to || '',
            cta_label: primaryButton?.label || payload.cta_label || 'Read announcement',
            cta_url: primaryButton?.url || payload.cta_url || buildPortalInvoiceLink('')
          }
        });
      } catch (err) {
        console.error('Announcement publish failed', err);
        setStatus(err?.message || 'Failed to publish announcement.', true);
      }
    }

    async function setAnnouncementActive(id, active) {
      const announcementId = cleanId(id);
      if (!announcementId || !isSupabaseReady() || !isOwner()) return;
      try {
        const { error } = await supabaseClient
          .from('global_announcements')
          .update({ is_active: !!active, updated_at: new Date().toISOString() })
          .eq('id', announcementId);
        if (error) throw error;
        await loadOwnerAnnouncements();
      } catch (err) {
        console.warn('Announcement status update failed', err);
        alert(err?.message || 'Failed to update announcement status.');
      }
    }

    async function markAnnouncementSeenForCurrentUser(id) {
      const announcementId = cleanId(id);
      const uid = cleanId(supabaseSession?.user?.id || '');
      if (!announcementId || !uid || !isSupabaseReady()) return;
      const announcement = ownerAnnouncements.find(a => cleanId(a.id) === announcementId);
      const seenVersion = resolveAnnouncementSeenVersion(announcement);
      try {
        const { error } = await supabaseClient
          .from('announcement_reads')
          .upsert({
            announcement_id: announcementId,
            user_id: uid,
            seen_at: new Date().toISOString()
          }, { onConflict: 'announcement_id,user_id' });
        if (error) throw error;
        markAnnouncementLocallySeen(uid, announcementId, seenVersion);
      } catch (err) {
        console.warn('Announcement mark seen failed', err);
      }
    }

    async function markAnnouncementUnseenForAll(id) {
      const announcementId = cleanId(id);
      if (!announcementId || !isSupabaseReady() || !isOwner()) return;
      const announcement = ownerAnnouncements.find(a => cleanId(a.id) === announcementId);
      const title = announcement?.title || 'this announcement';
      if (!confirm(`Mark all accounts as unseen for "${title}"?`)) return;
      try {
        const nowIso = new Date().toISOString();
        const { error: deleteReadsErr } = await supabaseClient
          .from('announcement_reads')
          .delete()
          .eq('announcement_id', announcementId);
        if (deleteReadsErr) throw deleteReadsErr;
        const { error: updateErr } = await supabaseClient
          .from('global_announcements')
          .update({ updated_at: nowIso })
          .eq('id', announcementId);
        if (updateErr) throw updateErr;
        const uid = cleanId(supabaseSession?.user?.id || '');
        if (uid) clearAnnouncementLocalSeen(uid, announcementId);
        announcementCheckedUserId = '';
        announcementShownInThisSession = false;
        await loadOwnerAnnouncements();
        logActivity('Marked announcement unseen for all accounts', title);
      } catch (err) {
        console.warn('Announcement mark unseen for all failed', err);
        alert(err?.message || 'Failed to mark all accounts as unseen for this announcement.');
      }
    }

    function hideAnnouncementOverlay() {
      const overlay = document.getElementById('announcementOverlay');
      if (overlay) overlay.classList.remove('show');
    }

    function showAnnouncementOverlay(announcement) {
      const overlay = document.getElementById('announcementOverlay');
      if (!overlay) return;
      const titleEl = document.getElementById('announcementOverlayTitle');
      const bodyEl = document.getElementById('announcementOverlayBody');
      const metaEl = document.getElementById('announcementOverlayMeta');
      const actionsEl = document.getElementById('announcementOverlayActions');
      const dismissBtn = document.getElementById('announcementOverlayDismissBtn');

      if (titleEl) titleEl.textContent = announcement.title || 'Announcement';
      if (bodyEl) bodyEl.textContent = announcement.body || '';

      const metaParts = [];
      metaParts.push(formatAnnouncementTypeLabel(announcement.announcement_type));
      if (announcement.policy_version) metaParts.push(`Version: ${announcement.policy_version}`);
      if (announcement.domain_from || announcement.domain_to) {
        const fromLabel = announcement.domain_from || '?';
        const toLabel = announcement.domain_to || '?';
        metaParts.push(`${fromLabel} -> ${toLabel}`);
      }
      if (metaEl) {
        const meta = metaParts.filter(Boolean).join(' ‚Ä¢ ');
        metaEl.textContent = meta;
        metaEl.classList.toggle('hidden', !meta);
      }

      const buttons = normalizeAnnouncementButtons(
        announcement?.cta_buttons,
        announcement?.cta_label,
        announcement?.cta_url
      );
      if (actionsEl) {
        actionsEl.innerHTML = '';
        if (buttons.length) {
          buttons.forEach((btn, idx) => {
            const buttonEl = document.createElement('button');
            buttonEl.type = 'button';
            buttonEl.className = idx === 0
              ? 'px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700'
              : 'px-3 py-1.5 rounded-xl border border-slate-300 text-xs';
            buttonEl.textContent = btn.label || t('common.open');
            buttonEl.addEventListener('click', () => {
              openPopupWithConfirm(btn.url, btn.label || 'Announcement link');
            });
            actionsEl.appendChild(buttonEl);
          });
          actionsEl.classList.remove('hidden');
        } else {
          actionsEl.classList.add('hidden');
        }
      }

      if (dismissBtn) {
        dismissBtn.textContent = t('common.dismiss');
        dismissBtn.onclick = () => hideAnnouncementOverlay();
      }
      overlay.classList.add('show');
    }

    async function getPendingAnnouncementsForCurrentUser() {
      if (!isSupabaseReady()) return [];
      if (Date.now() < supabaseNetworkBackoffUntil) return [];
      const userId = cleanId(supabaseSession?.user?.id || '');
      if (!userId) return [];
      const nowIso = new Date().toISOString();
      const { data, error } = await supabaseClient
        .from('global_announcements')
        .select('*')
        .eq('is_active', true)
        .lte('publish_at', nowIso)
        .order('publish_at', { ascending: true });
      if (error) throw error;
      const nowTime = Date.now();
      const rows = (data || [])
        .filter(row => {
          if (!row?.expires_at) return true;
          const expiry = new Date(row.expires_at).getTime();
          return Number.isFinite(expiry) ? expiry >= nowTime : true;
        })
        .filter(row => !isAnnouncementLocallySeen(userId, row.id, resolveAnnouncementSeenVersion(row)));
      if (!rows.length) return [];

      const ids = rows.map(row => cleanId(row.id)).filter(Boolean);
      if (!ids.length) return [];
      const { data: reads, error: readsErr } = await supabaseClient
        .from('announcement_reads')
        .select('announcement_id')
        .eq('user_id', userId)
        .in('announcement_id', ids);
      if (readsErr) {
        console.warn('Announcement reads fetch failed', readsErr);
      }
      const seenSet = new Set((reads || []).map(r => cleanId(r.announcement_id)).filter(Boolean));
      return rows
        .filter(row => !seenSet.has(cleanId(row.id)))
        .map(row => mapAnnouncementRow(row));
    }

    async function markAnnouncementSeen(announcementId, seenVersion = '') {
      const uid = cleanId(supabaseSession?.user?.id || '');
      const id = cleanId(announcementId);
      if (!uid || !id || !isSupabaseReady()) return;
      markAnnouncementLocallySeen(uid, id, seenVersion || resolveAnnouncementSeenVersion({}));
      const { error } = await supabaseClient
        .from('announcement_reads')
        .upsert({
          announcement_id: id,
          user_id: uid,
          seen_at: new Date().toISOString()
        }, { onConflict: 'announcement_id,user_id' });
      if (error) {
        console.warn('Announcement seen upsert failed', error);
      }
    }

    async function maybeShowPendingAnnouncement(opts = {}) {
      if (!isSupabaseReady()) return;
      if (announcementShownInThisSession) return;
      if (isMaintenanceHardStopForViewer()) return;
      const uid = cleanId(supabaseSession?.user?.id || '');
      if (!uid) return;
      const force = !!opts.force;
      if (!force && announcementCheckedUserId === uid) return;
      if (announcementCheckInFlight) {
        await announcementCheckInFlight;
        return;
      }
      announcementCheckInFlight = (async () => {
        try {
          const pending = await getPendingAnnouncementsForCurrentUser();
          announcementCheckedUserId = uid;
          if (!pending.length) return;
          const next = pending[0];
          await markAnnouncementSeen(next.id, resolveAnnouncementSeenVersion(next));
          announcementShownInThisSession = true;
          showAnnouncementOverlay(next);
        } catch (err) {
          if (isNetworkLoadFailure(err)) {
            registerSupabaseNetworkIssue('Cannot reach Supabase right now (network/CORS). Non-critical checks are temporarily paused.');
          }
          console.warn('Announcement check failed', err);
        }
      })();
      try {
        await announcementCheckInFlight;
      } finally {
        announcementCheckInFlight = null;
      }
    }

    function resetAnnouncementSessionState() {
      announcementCheckInFlight = null;
      announcementCheckedUserId = '';
      announcementShownInThisSession = false;
      hideAnnouncementOverlay();
    }

    function renderActivityLog() {
      const list = document.getElementById('activityLogList');
      if (!list) return;
      const items = [...(state.activityLog || [])].sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      if (!items.length) {
        list.innerHTML = `<li class="text-slate-500 text-xs">${esc(t('activity.none'))}</li>`;
        return;
      }
      list.innerHTML = items.slice(0, 25).map(a => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
          <div>
            <div class="font-medium">${esc(a.action)}</div>
            <div class="text-[10px] text-slate-500">${esc(a.detail || '')}</div>
          </div>
          <div class="text-[10px] text-slate-500">${esc(a.created_at ? new Date(a.created_at).toLocaleString() : '')}</div>
        </li>
      `).join('');
    }

    function logActivity(action, detail) {
      const entry = {
        id: generateId('act'),
        action,
        detail,
        created_at: new Date().toISOString()
      };
      state.activityLog.push(entry);
      // keep last 200
      if (state.activityLog.length > 200) {
        state.activityLog = state.activityLog.slice(-200);
      }
      saveState();
      renderActivityLog();
    }

    /***********************
     * PROFILE
     ***********************/
    function renderProfileView() {
      const user = supabaseSession?.user;
      const emailEl = document.getElementById('profileEmail');
      const createdEl = document.getElementById('profileCreated');
      const lastEl = document.getElementById('profileLastSignIn');
      const badge = document.getElementById('profileEmailVerified');
      const roleEl = document.getElementById('profileRole');
      const uidEl = document.getElementById('profileUid');
      const sessMeta = document.getElementById('profileSessionMeta');
      const businessEmailEl = document.getElementById('businessContactEmail');
      const businessPaymentEl = document.getElementById('businessPaymentProvider');
      if (businessEmailEl) businessEmailEl.textContent = SUPPORT_EMAIL || '‚Äî';
      if (businessPaymentEl) businessPaymentEl.textContent = 'PayFast';
      if (!user) {
        if (tourMode) {
          if (emailEl) emailEl.textContent = 'tour@demo.local';
          if (createdEl) createdEl.textContent = t('profile.local_demo');
          if (lastEl) lastEl.textContent = '‚Äî';
          if (badge) {
            badge.textContent = t('profile.tour_mode');
            badge.className = 'text-[10px] px-2 py-0.5 rounded-full bg-sky-100 text-sky-700';
          }
          if (roleEl) roleEl.textContent = t('profile.owner_tour');
          if (uidEl) uidEl.textContent = 'tour-local';
          if (sessMeta) sessMeta.textContent = t('profile.local_session');
          return;
        }
        if (emailEl) emailEl.textContent = t('profile.not_signed_in');
        if (createdEl) createdEl.textContent = '‚Äî';
        if (lastEl) lastEl.textContent = '‚Äî';
        if (badge) {
          badge.textContent = t('profile.not_signed_in');
          badge.className = 'text-[10px] px-2 py-0.5 rounded-full bg-amber-100 text-amber-700';
        }
        if (roleEl) roleEl.textContent = '‚Äî';
        if (uidEl) uidEl.textContent = '‚Äî';
        if (sessMeta) sessMeta.textContent = '';
        return;
      }
      if (emailEl) emailEl.textContent = user.email || '‚Äî';
      const metadata = user.user_metadata || {};
      const created = user.created_at ? new Date(user.created_at).toLocaleString() : '‚Äî';
      const lastSignIn = user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleString() : '‚Äî';
      if (createdEl) createdEl.textContent = created;
      if (lastEl) lastEl.textContent = lastSignIn;
      if (roleEl) {
        if (isOwner()) roleEl.textContent = t('role.owner');
        else if (parentMode) roleEl.textContent = t('role.parent');
        else roleEl.textContent = t('role.student');
      }
      if (uidEl) uidEl.textContent = user.id || '‚Äî';
      if (sessMeta && supabaseSession?.expires_at) {
        const exp = new Date(supabaseSession.expires_at * 1000).toLocaleString();
        sessMeta.textContent = t('profile.session_expires', { date: exp });
      }
      const verified = metadata.email_verified || user.email_confirmed_at;
      if (badge) {
        if (verified) {
          badge.textContent = t('profile.verified');
          badge.className = 'text-[10px] px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700';
        } else {
          badge.textContent = t('profile.unverified');
          badge.className = 'text-[10px] px-2 py-0.5 rounded-full bg-amber-100 text-amber-700';
        }
      }
    }

    function getSupportRoleHint() {
      if (isOwner()) return 'owner';
      if (parentMode) return 'parent';
      if (studentMode) return 'student';
      const sessionRole = getSessionRole();
      if (sessionRole === 'owner' || sessionRole === 'parent' || sessionRole === 'student') {
        return sessionRole;
      }
      return '';
    }

    function shortSupportTicketId(ticketId) {
      const clean = cleanId(ticketId).replace(/-/g, '').toUpperCase();
      return clean ? clean.slice(0, 8) : 'UNKNOWN';
    }

    function formatSupportTimestamp(value) {
      if (!value) return '';
      const dt = new Date(value);
      if (Number.isNaN(dt.getTime())) return '';
      return dt.toLocaleString();
    }

    function getSupportStatusLabel(status) {
      const key = String(status || '').toLowerCase();
      if (key === 'open') return 'Open';
      if (key === 'waiting_owner') return 'Waiting on tutor';
      if (key === 'waiting_parent') return 'Waiting on family';
      if (key === 'resolved') return 'Resolved';
      if (key === 'closed') return 'Closed';
      return key || 'Unknown';
    }

    function getSupportStatusClass(status) {
      const key = String(status || '').toLowerCase();
      if (key === 'open') return 'bg-rose-100 text-rose-700';
      if (key === 'waiting_owner') return 'bg-amber-100 text-amber-800';
      if (key === 'waiting_parent') return 'bg-sky-100 text-sky-700';
      if (key === 'resolved') return 'bg-emerald-100 text-emerald-700';
      if (key === 'closed') return 'bg-slate-100 text-slate-600';
      return 'bg-slate-100 text-slate-600';
    }

    function supportCacheKey(roleHint) {
      const uid = cleanId(supabaseSession?.user?.id || '');
      const parentId = roleHint === 'parent' ? cleanId(getParentProfileBySession()?.id || '') : '';
      const studentId = roleHint === 'student' ? cleanId(getStudentProfileBySession()?.id || '') : '';
      return [uid, roleHint, parentId, studentId].join('|');
    }

    const SUPPORT_FUNCTION_NAMES = ['support-ticket-api', 'support-ticket'];

    async function getSupportFunctionErrorMeta(error, data) {
      let status = Number(
        error?.context?.status ||
        error?.status ||
        error?.response?.status ||
        0
      );
      let message = String(data?.error || error?.message || '').trim();
      let responseBody = '';

      const response = (
        (typeof Response !== 'undefined' && error?.context instanceof Response) ? error.context :
        (typeof Response !== 'undefined' && error?.response instanceof Response) ? error.response :
        null
      );

      if (response) {
        if (!status) status = Number(response.status || 0);
        try {
          const bodyText = await response.clone().text();
          responseBody = String(bodyText || '').trim();
          if (!message && responseBody) {
            message = responseBody.slice(0, 300);
          }
          const parsed = JSON.parse(bodyText || '{}');
          const bodyMsg = String(parsed?.error || parsed?.message || '').trim();
          if (bodyMsg) message = bodyMsg;
        } catch {
          // keep fallback message
        }
      }

      const combined = `${message} ${responseBody} ${String(error?.message || '')}`.toLowerCase();
      const missingRoute = status === 404 && (
        combined.includes('function not found') ||
        combined.includes('no route matched') ||
        combined.includes('worker not found')
      );

      return {
        status,
        missingRoute,
        message: message || 'Support request failed'
      };
    }

    async function invokeSupportTicketApi(action, payload = {}) {
      if (!isSupabaseReady()) throw new Error('Please sign in first.');
      const accessToken = requireAccessToken(t('alert.sign_in_first'));
      const roleHint = getSupportRoleHint();
      const body = {
        action,
        ...(payload || {})
      };
      if (roleHint && !body.role) body.role = roleHint;
      let lastMissing = false;
      let lastMessage = '';
      for (const fnName of SUPPORT_FUNCTION_NAMES) {
        const { data, error } = await supabaseClient.functions.invoke(fnName, {
          body,
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (!error && data?.success !== false) {
          return data || {};
        }
        const meta = await getSupportFunctionErrorMeta(error, data);
        if (!meta.missingRoute) {
          throw new Error(meta.message);
        }
        lastMissing = true;
        lastMessage = meta.message;
      }
      if (lastMissing) {
        throw new Error('Support service is not deployed. Please deploy the "support-ticket-api" edge function.');
      }
      throw new Error(lastMessage || 'Support request failed');
    }

    async function fetchSupportTickets({ force = false, status = 'all', limit = 60 } = {}) {
      const roleHint = getSupportRoleHint();
      const cacheKey = `${supportCacheKey(roleHint)}|${status}|${limit}`;
      const now = Date.now();
      if (!force && supportTicketsCache.cacheKey === cacheKey && (now - Number(supportTicketsCache.loadedAt || 0)) < SUPPORT_CACHE_TTL_MS) {
        return supportTicketsCache.tickets || [];
      }
      if (supportTicketsCache.loading && supportTicketsInFlight && supportTicketsCache.cacheKey === cacheKey) {
        return await supportTicketsInFlight;
      }
      supportTicketsCache.loading = true;
      supportTicketsCache.cacheKey = cacheKey;
      supportTicketsInFlight = (async () => {
        const resp = await invokeSupportTicketApi('list_tickets', { status, limit });
        const tickets = Array.isArray(resp?.tickets) ? resp.tickets : [];
        supportTicketsCache = {
          cacheKey,
          loadedAt: Date.now(),
          tickets,
          loading: false,
          error: ''
        };
        return tickets;
      })();
      try {
        return await supportTicketsInFlight;
      } catch (err) {
        supportTicketsCache.loading = false;
        supportTicketsCache.error = String(err?.message || err || 'Support ticket fetch failed');
        throw err;
      } finally {
        supportTicketsInFlight = null;
      }
    }

    function setSupportStatusText(elementId, message, isError = false) {
      const el = document.getElementById(elementId);
      if (!el) return;
      const text = String(message || '').trim();
      el.textContent = text;
      el.classList.toggle('hidden', !text);
      el.className = `text-[11px] ${isError ? 'text-rose-700' : 'text-slate-500'}${text ? '' : ' hidden'}`;
    }

    function renderSupportTicketItems(listEl, tickets, { ownerView = false } = {}) {
      if (!listEl) return;
      if (!Array.isArray(tickets) || !tickets.length) {
        listEl.innerHTML = `<li class="text-slate-500 text-xs">No support tickets yet.</li>`;
        return;
      }
      listEl.innerHTML = tickets.map(ticket => {
        const statusLabel = getSupportStatusLabel(ticket.status);
        const statusClass = getSupportStatusClass(ticket.status);
        const updatedAt = formatSupportTimestamp(ticket.last_message_at || ticket.updated_at || ticket.created_at);
        const subject = esc(ticket.subject || 'Support request');
        const ticketShort = shortSupportTicketId(ticket.id);
        const ticketId = cleanId(ticket.id);
        const ownerMeta = ownerView
          ? `${esc(ticket.student_name || '‚Äî')} ‚Ä¢ ${esc(ticket.parent_name || '‚Äî')}`
          : '';
        const roleMeta = ownerMeta ? `${ownerMeta} ‚Ä¢ ` : '';
        return `
          <li class="border border-slate-200 rounded-lg px-2 py-2 bg-white/80">
            <div class="flex items-start justify-between gap-2">
              <div>
                <div class="font-medium">#${esc(ticketShort)} ‚Ä¢ ${subject}</div>
                <div class="text-[10px] text-slate-500">${roleMeta}${esc(updatedAt || '‚Äî')}</div>
              </div>
              <span class="text-[10px] px-2 py-0.5 rounded-full ${statusClass}">${esc(statusLabel)}</span>
            </div>
            <div class="mt-2">
              <button class="portal-cta-btn portal-cta-subtle text-[11px]" data-support-open="${ticketId}">
                Open thread
              </button>
            </div>
          </li>
        `;
      }).join('');
      listEl.querySelectorAll('[data-support-open]').forEach(btn => {
        btn.onclick = () => {
          const ticketId = cleanId(btn.getAttribute('data-support-open') || '');
          if (ticketId) openSupportTicketThread(ticketId);
        };
      });
    }

    function sortSupportTickets(tickets) {
      const order = { open: 0, waiting_owner: 1, waiting_parent: 2, resolved: 3, closed: 4 };
      return [...(tickets || [])].sort((a, b) => {
        const aRank = order[String(a.status || '').toLowerCase()] ?? 9;
        const bRank = order[String(b.status || '').toLowerCase()] ?? 9;
        if (aRank !== bRank) return aRank - bRank;
        const aTime = new Date(a.last_message_at || a.updated_at || a.created_at || 0).getTime();
        const bTime = new Date(b.last_message_at || b.updated_at || b.created_at || 0).getTime();
        return bTime - aTime;
      });
    }

    async function renderOwnerSupportCard({ force = false } = {}) {
      const card = document.getElementById('ownerSupportCard');
      const listEl = document.getElementById('ownerSupportTickets');
      const statusElId = 'ownerSupportStatus';
      const refreshBtn = document.getElementById('ownerSupportRefreshBtn');
      const newBtn = document.getElementById('ownerSupportNewBtn');
      if (!card || !listEl || !refreshBtn || !newBtn) return;
      if (!isOwner() || !isSupabaseReady()) {
        card.classList.add('hidden');
        return;
      }
      card.classList.remove('hidden');
      refreshBtn.onclick = () => void renderOwnerSupportCard({ force: true });
      newBtn.onclick = () => openSupportTicketComposer();
      setSupportStatusText(statusElId, force ? 'Refreshing support tickets...' : 'Loading support tickets...');
      try {
        const tickets = sortSupportTickets(await fetchSupportTickets({ force, limit: 120 }));
        const openCount = tickets.filter(t => {
          const status = String(t.status || '').toLowerCase();
          return status !== 'resolved' && status !== 'closed';
        }).length;
        setSupportStatusText(statusElId, `${openCount} open ‚Ä¢ ${tickets.length} total`);
        renderSupportTicketItems(listEl, tickets.slice(0, 50), { ownerView: true });
      } catch (err) {
        setSupportStatusText(statusElId, err?.message || 'Failed to load support tickets.', true);
        listEl.innerHTML = `<li class="text-rose-700 text-xs">${esc(err?.message || 'Failed to load support tickets.')}</li>`;
      }
    }

    async function renderParentSupportCard({ force = false } = {}) {
      const listEl = document.getElementById('parentSupportTickets');
      const newBtn = document.getElementById('parentSupportNewBtn');
      const refreshBtn = document.getElementById('parentSupportRefreshBtn');
      const statusElId = 'parentSupportStatus';
      if (!listEl || !newBtn || !refreshBtn) return;
      const blocked = isMaintenanceGracefulWriteBlocked() || isMaintenanceHardStopForViewer();
      newBtn.disabled = blocked;
      newBtn.title = blocked ? 'Temporarily disabled during maintenance restricted mode.' : '';
      newBtn.onclick = () => openSupportTicketComposer();
      refreshBtn.onclick = () => void renderParentSupportCard({ force: true });
      if (!isSupabaseReady() || !parentMode) {
        setSupportStatusText(statusElId, 'Sign in to view support tickets.');
        listEl.innerHTML = `<li class="text-slate-500 text-xs">No support tickets available.</li>`;
        return;
      }
      setSupportStatusText(statusElId, force ? 'Refreshing support tickets...' : 'Loading support tickets...');
      try {
        const tickets = sortSupportTickets(await fetchSupportTickets({ force, limit: 80 }));
        setSupportStatusText(statusElId, `${tickets.length} ticket${tickets.length === 1 ? '' : 's'}`);
        renderSupportTicketItems(listEl, tickets);
      } catch (err) {
        setSupportStatusText(statusElId, err?.message || 'Failed to load support tickets.', true);
        listEl.innerHTML = `<li class="text-rose-700 text-xs">${esc(err?.message || 'Failed to load support tickets.')}</li>`;
      }
    }

    async function renderStudentSupportCard({ force = false } = {}) {
      const listEl = document.getElementById('portalSupportTickets');
      const newBtn = document.getElementById('portalSupportNewBtn');
      const statusElId = 'portalSupportStatus';
      if (!listEl || !newBtn) return;
      const blocked = isMaintenanceGracefulWriteBlocked() || isMaintenanceHardStopForViewer();
      newBtn.disabled = blocked;
      newBtn.title = blocked ? 'Temporarily disabled during maintenance restricted mode.' : '';
      newBtn.onclick = () => openSupportTicketComposer();
      if (!isSupabaseReady() || !studentMode) {
        setSupportStatusText(statusElId, 'Sign in to view support tickets.');
        listEl.innerHTML = `<li class="text-slate-500 text-xs">No support tickets available.</li>`;
        return;
      }
      setSupportStatusText(statusElId, force ? 'Refreshing support tickets...' : 'Loading support tickets...');
      try {
        const tickets = sortSupportTickets(await fetchSupportTickets({ force, limit: 80 }));
        setSupportStatusText(statusElId, `${tickets.length} ticket${tickets.length === 1 ? '' : 's'}`);
        renderSupportTicketItems(listEl, tickets);
      } catch (err) {
        setSupportStatusText(statusElId, err?.message || 'Failed to load support tickets.', true);
        listEl.innerHTML = `<li class="text-rose-700 text-xs">${esc(err?.message || 'Failed to load support tickets.')}</li>`;
      }
    }

    async function refreshSupportForCurrentRole({ force = true } = {}) {
      supportTicketsCache.loadedAt = 0;
      if (isOwner()) {
        await renderOwnerSupportCard({ force });
        return;
      }
      if (parentMode) {
        await renderParentSupportCard({ force });
        return;
      }
      if (studentMode) {
        await renderStudentSupportCard({ force });
      }
    }

    function buildSupportStatusOptions(roleHint, currentStatus) {
      const ownerStatuses = ['open', 'waiting_owner', 'waiting_parent', 'resolved', 'closed'];
      const memberStatuses = ['open', 'resolved', 'closed'];
      const allowed = roleHint === 'owner' ? ownerStatuses : memberStatuses;
      return allowed.map(status => {
        const selected = status === currentStatus ? 'selected' : '';
        return `<option value="${status}" ${selected}>${esc(getSupportStatusLabel(status))}</option>`;
      }).join('');
    }

    function openSupportTicketComposer() {
      if (!guardMaintenanceWrite('Support ticket creation')) return;
      if (!isSupabaseReady()) {
        alert('Please sign in first.');
        return;
      }
      const roleHint = getSupportRoleHint();
      const parent = parentMode ? getParentProfileBySession() : null;
      const student = studentMode ? getStudentProfileBySession() : null;
      const parentStudents = parent ? getChildrenForParent() : [];
      const ownerStudents = isOwner() ? [...state.students].sort((a, b) => String(a.name || '').localeCompare(String(b.name || ''))) : [];
      const ownerParents = isOwner() ? [...state.parents].sort((a, b) => String(a.name || '').localeCompare(String(b.name || ''))) : [];
      const parentStudentOptions = [
        `<option value="">General parent issue</option>`,
        ...parentStudents.map(s => `<option value="${cleanId(s.id)}">${esc(s.name || 'Student')}</option>`)
      ].join('');
      const ownerStudentOptions = [`<option value="">Select student (optional)</option>`]
        .concat(ownerStudents.map(s => `<option value="${cleanId(s.id)}">${esc(s.name || 'Student')}</option>`))
        .join('');
      const ownerParentOptions = [`<option value="">Select parent (optional)</option>`]
        .concat(ownerParents.map(p => `<option value="${cleanId(p.id)}">${esc(p.name || p.email || 'Parent')}</option>`))
        .join('');
      const roleDetail = roleHint === 'owner'
        ? 'Create a ticket for a parent and/or student.'
        : roleHint === 'parent'
          ? `Submitting as ${esc(parent?.name || 'Parent')}.`
          : `Submitting as ${esc(student?.name || 'Student')}.`;
      openModal(`
        <div class="space-y-3 text-xs">
          <h2 class="text-sm font-semibold">New support ticket</h2>
          <p class="text-[11px] text-slate-500">${roleDetail}</p>
          ${roleHint === 'owner' ? `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              <label class="space-y-1">
                <div class="text-[11px] text-slate-500">Parent</div>
                <select id="supportComposeParentId" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${ownerParentOptions}</select>
              </label>
              <label class="space-y-1">
                <div class="text-[11px] text-slate-500">Student</div>
                <select id="supportComposeStudentId" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${ownerStudentOptions}</select>
              </label>
            </div>
          ` : ''}
          ${roleHint === 'parent' ? `
            <label class="space-y-1">
              <div class="text-[11px] text-slate-500">Student (optional)</div>
              <select id="supportComposeStudentId" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${parentStudentOptions}</select>
            </label>
          ` : ''}
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <label class="space-y-1">
              <div class="text-[11px] text-slate-500">Category</div>
              <select id="supportComposeCategory" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                <option value="general">General</option>
                <option value="billing">Billing</option>
                <option value="schedule">Schedule</option>
                <option value="technical">Technical</option>
                <option value="contract">Contract</option>
                <option value="account">Account</option>
              </select>
            </label>
            <label class="space-y-1">
              <div class="text-[11px] text-slate-500">Priority</div>
              <select id="supportComposePriority" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">
                <option value="normal">Normal</option>
                <option value="low">Low</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </label>
          </div>
          <label class="space-y-1">
            <div class="text-[11px] text-slate-500">Subject</div>
            <input id="supportComposeSubject" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]" maxlength="180"
              placeholder="Short summary (e.g., Invoice due date question)" />
          </label>
          <label class="space-y-1">
            <div class="text-[11px] text-slate-500">Message</div>
            <textarea id="supportComposeBody" rows="5" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]"
              maxlength="8000" placeholder="Describe the issue in detail."></textarea>
          </label>
          <div id="supportComposeStatus" class="text-[11px] text-slate-500 hidden"></div>
          <div class="flex items-center gap-2">
            <button id="supportComposeSubmitBtn" class="portal-cta-btn portal-cta-pay text-[11px]">Create ticket</button>
            <button id="supportComposeCancelBtn" class="portal-cta-btn portal-cta-subtle text-[11px]">Cancel</button>
          </div>
        </div>
      `, () => {
        const submitBtn = document.getElementById('supportComposeSubmitBtn');
        const cancelBtn = document.getElementById('supportComposeCancelBtn');
        const statusEl = document.getElementById('supportComposeStatus');
        const subjectEl = document.getElementById('supportComposeSubject');
        if (cancelBtn) cancelBtn.onclick = closeModal;
        if (!submitBtn || !statusEl || !subjectEl) return;
        submitBtn.onclick = async () => {
          const subject = String(document.getElementById('supportComposeSubject')?.value || '').trim();
          const body = String(document.getElementById('supportComposeBody')?.value || '').trim();
          const category = String(document.getElementById('supportComposeCategory')?.value || 'general').trim();
          const priority = String(document.getElementById('supportComposePriority')?.value || 'normal').trim();
          const parentId = cleanId(document.getElementById('supportComposeParentId')?.value || '');
          const studentId = cleanId(document.getElementById('supportComposeStudentId')?.value || '');
          if (!subject) {
            statusEl.textContent = 'Please enter a subject.';
            statusEl.className = 'text-[11px] text-rose-700';
            statusEl.classList.remove('hidden');
            return;
          }
          if (!body) {
            statusEl.textContent = 'Please enter a message.';
            statusEl.className = 'text-[11px] text-rose-700';
            statusEl.classList.remove('hidden');
            return;
          }
          const payload = { subject, body, category, priority };
          if (roleHint === 'owner') {
            if (parentId) payload.parent_id = parentId;
            if (studentId) payload.student_id = studentId;
          } else if (roleHint === 'parent') {
            if (studentId) payload.student_id = studentId;
          }
          submitBtn.disabled = true;
          statusEl.textContent = 'Creating ticket...';
          statusEl.className = 'text-[11px] text-slate-500';
          statusEl.classList.remove('hidden');
          try {
            const resp = await invokeSupportTicketApi('create_ticket', payload);
            const ticketId = cleanId(resp?.ticket_id || '');
            closeModal();
            await refreshSupportForCurrentRole({ force: true });
            if (ticketId) openSupportTicketThread(ticketId);
          } catch (err) {
            statusEl.textContent = err?.message || 'Failed to create ticket.';
            statusEl.className = 'text-[11px] text-rose-700';
          } finally {
            submitBtn.disabled = false;
          }
        };
      });
    }

    function openSupportTicketThread(ticketId) {
      const safeTicketId = cleanId(ticketId);
      if (!safeTicketId) return;
      openModal(`
        <div class="space-y-3 text-xs">
          <h2 id="supportThreadTitle" class="text-sm font-semibold">Support ticket</h2>
          <div id="supportThreadMeta" class="text-[11px] text-slate-500"></div>
          <ul id="supportThreadMessages" class="space-y-2 max-h-72 overflow-y-auto scrollbar-thin border border-slate-200 rounded-lg p-2 bg-slate-50"></ul>
          <label class="space-y-1">
            <div class="text-[11px] text-slate-500">Reply</div>
            <textarea id="supportThreadReplyBody" rows="4" maxlength="8000"
              class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]"
              placeholder="Type your reply"></textarea>
          </label>
          <label id="supportThreadInternalWrap" class="hidden flex items-center gap-2 text-[11px] text-slate-600">
            <input id="supportThreadInternal" type="checkbox" />
            Internal note (owner only)
          </label>
          <div class="flex flex-wrap items-center gap-2">
            <button id="supportThreadReplyBtn" class="portal-cta-btn portal-cta-pay text-[11px]">Send reply</button>
            <select id="supportThreadStatusSelect" class="border border-slate-300 rounded-lg px-2 py-1 text-[11px]"></select>
            <button id="supportThreadStatusBtn" class="portal-cta-btn portal-cta-subtle text-[11px]">Update status</button>
            <button id="supportThreadDeleteBtn" class="hidden px-3 py-1.5 text-[11px] rounded-lg border border-rose-200 text-rose-700 hover:bg-rose-50">Delete ticket</button>
          </div>
          <div id="supportThreadStatusText" class="text-[11px] text-slate-500 hidden"></div>
        </div>
      `, () => {
        const titleEl = document.getElementById('supportThreadTitle');
        const metaEl = document.getElementById('supportThreadMeta');
        const listEl = document.getElementById('supportThreadMessages');
        const replyEl = document.getElementById('supportThreadReplyBody');
        const replyBtn = document.getElementById('supportThreadReplyBtn');
        const statusSelect = document.getElementById('supportThreadStatusSelect');
        const statusBtn = document.getElementById('supportThreadStatusBtn');
        const deleteBtn = document.getElementById('supportThreadDeleteBtn');
        const statusText = document.getElementById('supportThreadStatusText');
        const internalWrap = document.getElementById('supportThreadInternalWrap');
        const internalInput = document.getElementById('supportThreadInternal');
        const roleHint = getSupportRoleHint();
        if (!titleEl || !metaEl || !listEl || !replyEl || !replyBtn || !statusSelect || !statusBtn || !deleteBtn || !statusText || !internalWrap || !internalInput) return;
        internalWrap.classList.toggle('hidden', roleHint !== 'owner');
        deleteBtn.classList.toggle('hidden', roleHint !== 'owner');
        let currentTicket = null;

        const setStatusText = (message, isError = false) => {
          const text = String(message || '').trim();
          statusText.textContent = text;
          statusText.classList.toggle('hidden', !text);
          statusText.className = `text-[11px] ${isError ? 'text-rose-700' : 'text-slate-500'}${text ? '' : ' hidden'}`;
        };

        const senderLabel = (senderRole) => {
          if (senderRole === 'owner') return 'Tutor';
          if (senderRole === 'parent') return 'Parent';
          if (senderRole === 'student') return 'Student';
          return 'User';
        };

        const refreshThread = async () => {
          setStatusText('Loading ticket...');
          try {
            const resp = await invokeSupportTicketApi('get_ticket_thread', { ticket_id: safeTicketId });
            const ticket = resp?.ticket || {};
            currentTicket = ticket;
            const messages = Array.isArray(resp?.messages) ? resp.messages : [];
            const shortId = shortSupportTicketId(ticket.id || safeTicketId);
            titleEl.textContent = `Ticket #${shortId} ‚Ä¢ ${ticket.subject || 'Support ticket'}`;
            const metaBits = [
              `Status: ${getSupportStatusLabel(ticket.status)}`,
              ticket.student_name ? `Student: ${ticket.student_name}` : '',
              ticket.parent_name ? `Parent: ${ticket.parent_name}` : '',
              `Updated: ${formatSupportTimestamp(ticket.last_message_at || ticket.updated_at || ticket.created_at)}`
            ].filter(Boolean);
            metaEl.textContent = metaBits.join(' ‚Ä¢ ');
            statusSelect.innerHTML = buildSupportStatusOptions(roleHint, String(ticket.status || '').toLowerCase());
            if (!messages.length) {
              listEl.innerHTML = `<li class="text-slate-500 text-[11px]">No messages yet.</li>`;
            } else {
              listEl.innerHTML = messages.map(msg => {
                const isInternal = !!msg.is_internal;
                const body = esc(msg.body || '').replace(/\n/g, '<br/>');
                return `
                  <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white">
                    <div class="flex items-center justify-between text-[10px] text-slate-500">
                      <span>${esc(senderLabel(msg.sender_role))}${isInternal ? ' ‚Ä¢ Internal' : ''}</span>
                      <span>${esc(formatSupportTimestamp(msg.created_at))}</span>
                    </div>
                    <div class="mt-1">${body || '‚Äî'}</div>
                  </li>
                `;
              }).join('');
            }
            setStatusText('');
          } catch (err) {
            setStatusText(err?.message || 'Failed to load ticket thread.', true);
            listEl.innerHTML = `<li class="text-rose-700 text-[11px]">${esc(err?.message || 'Failed to load ticket thread.')}</li>`;
          }
        };

        replyBtn.onclick = async () => {
          if (!guardMaintenanceWrite('Support reply')) return;
          const body = String(replyEl.value || '').trim();
          if (!body) {
            setStatusText('Please enter a reply.', true);
            return;
          }
          const isInternal = roleHint === 'owner' && !!internalInput.checked;
          replyBtn.disabled = true;
          setStatusText('Sending reply...');
          try {
            await invokeSupportTicketApi('reply_ticket', {
              ticket_id: safeTicketId,
              body,
              is_internal: isInternal
            });
            replyEl.value = '';
            internalInput.checked = false;
            await refreshThread();
            await refreshSupportForCurrentRole({ force: true });
          } catch (err) {
            setStatusText(err?.message || 'Failed to send reply.', true);
          } finally {
            replyBtn.disabled = false;
          }
        };

        statusBtn.onclick = async () => {
          if (!guardMaintenanceWrite('Support status update')) return;
          const status = String(statusSelect.value || '').trim().toLowerCase();
          if (!status) return;
          statusBtn.disabled = true;
          setStatusText('Updating status...');
          try {
            await invokeSupportTicketApi('set_ticket_status', {
              ticket_id: safeTicketId,
              status
            });
            await refreshThread();
            await refreshSupportForCurrentRole({ force: true });
          } catch (err) {
            setStatusText(err?.message || 'Failed to update status.', true);
          } finally {
            statusBtn.disabled = false;
          }
        };

        deleteBtn.onclick = async () => {
          if (roleHint !== 'owner') return;
          if (!guardMaintenanceWrite('Support ticket deletion')) return;
          const typed = prompt('Type DELETE to permanently delete this ticket.');
          if (typed === null) return;
          if (String(typed || '').trim().toUpperCase() !== 'DELETE') {
            setStatusText('Deletion cancelled. Confirmation did not match DELETE.', true);
            return;
          }
          const reasonInput = prompt('Delete reason (required; stored in activity log):');
          if (reasonInput === null) return;
          const reason = String(reasonInput || '').trim();
          if (!reason) {
            setStatusText('Delete reason is required.', true);
            return;
          }
          const shortId = shortSupportTicketId(currentTicket?.id || safeTicketId);
          if (!confirm(`Delete ticket #${shortId}? This cannot be undone.`)) return;
          deleteBtn.disabled = true;
          setStatusText('Deleting ticket...');
          try {
            await invokeSupportTicketApi('delete_ticket', {
              ticket_id: safeTicketId,
              confirmation: 'DELETE',
              reason
            });
            closeModal();
            await refreshSupportForCurrentRole({ force: true });
          } catch (err) {
            setStatusText(err?.message || 'Failed to delete ticket.', true);
          } finally {
            deleteBtn.disabled = false;
          }
        };

        void refreshThread();
      });
    }

    function loadOwnerPanelPrefs() {
      try {
        const raw = localStorage.getItem(OWNER_PANEL_PREFS_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === 'object') {
          const dash = String(parsed.dashboard || '').trim();
          const settings = String(parsed.settings || '').trim();
          if (dash) ownerPanelPrefs.dashboard = dash;
          if (settings) ownerPanelPrefs.settings = settings;
        }
      } catch {
        // ignore invalid stored panel prefs
      }
    }

    function saveOwnerPanelPrefs() {
      try {
        localStorage.setItem(OWNER_PANEL_PREFS_KEY, JSON.stringify(ownerPanelPrefs));
      } catch {
        // ignore storage failures
      }
    }

    function applyOwnerDashboardPanel() {
      const nav = document.getElementById('ownerDashboardPanelNav');
      const panels = [...document.querySelectorAll('[data-owner-dashboard-panel]')];
      if (!panels.length) return;
      if (!isOwner()) {
        if (nav) nav.classList.add('hidden');
        panels.forEach(panel => panel.classList.remove('hidden'));
        return;
      }
      if (nav) nav.classList.remove('hidden');
      const available = new Set(panels.map(panel => panel.getAttribute('data-owner-dashboard-panel')));
      if (!available.has(ownerPanelPrefs.dashboard)) {
        ownerPanelPrefs.dashboard = String(panels[0]?.getAttribute('data-owner-dashboard-panel') || 'overview');
      }
      panels.forEach(panel => {
        const key = String(panel.getAttribute('data-owner-dashboard-panel') || '');
        panel.classList.toggle('hidden', key !== ownerPanelPrefs.dashboard);
      });
      if (nav) {
        nav.querySelectorAll('[data-owner-dashboard-panel-target]').forEach(btn => {
          const key = String(btn.getAttribute('data-owner-dashboard-panel-target') || '');
          const active = key === ownerPanelPrefs.dashboard;
          btn.classList.toggle('bg-slate-900', active);
          btn.classList.toggle('text-white', active);
          btn.classList.toggle('border-slate-900', active);
        });
      }
    }

    function applyOwnerSettingsPanel() {
      const nav = document.getElementById('ownerSettingsPanelNav');
      const panels = [...document.querySelectorAll('[data-owner-settings-panel]')];
      if (!panels.length) return;
      if (!isOwner()) {
        if (nav) nav.classList.add('hidden');
        panels.forEach(panel => panel.classList.remove('hidden'));
        return;
      }
      if (nav) nav.classList.remove('hidden');
      const available = new Set(panels.map(panel => panel.getAttribute('data-owner-settings-panel')));
      if (!available.has(ownerPanelPrefs.settings)) {
        ownerPanelPrefs.settings = String(panels[0]?.getAttribute('data-owner-settings-panel') || 'general');
      }
      panels.forEach(panel => {
        const key = String(panel.getAttribute('data-owner-settings-panel') || '');
        panel.classList.toggle('hidden', key !== ownerPanelPrefs.settings);
      });
      if (nav) {
        nav.querySelectorAll('[data-owner-settings-panel-target]').forEach(btn => {
          const key = String(btn.getAttribute('data-owner-settings-panel-target') || '');
          const active = key === ownerPanelPrefs.settings;
          btn.classList.toggle('bg-slate-900', active);
          btn.classList.toggle('text-white', active);
          btn.classList.toggle('border-slate-900', active);
        });
      }
    }

    function setOwnerDashboardPanel(panel) {
      const next = String(panel || '').trim();
      if (!next || ownerPanelPrefs.dashboard === next) return;
      ownerPanelPrefs.dashboard = next;
      saveOwnerPanelPrefs();
      applyOwnerDashboardPanel();
    }

    function setOwnerSettingsPanel(panel) {
      const next = String(panel || '').trim();
      if (!next || ownerPanelPrefs.settings === next) return;
      ownerPanelPrefs.settings = next;
      saveOwnerPanelPrefs();
      applyOwnerSettingsPanel();
    }

    function setupOwnerPanelNavigation() {
      loadOwnerPanelPrefs();
      const dashboardNav = document.getElementById('ownerDashboardPanelNav');
      if (dashboardNav && dashboardNav.dataset.bound !== '1') {
        dashboardNav.dataset.bound = '1';
        dashboardNav.querySelectorAll('[data-owner-dashboard-panel-target]').forEach(btn => {
          btn.onclick = () => setOwnerDashboardPanel(btn.getAttribute('data-owner-dashboard-panel-target'));
        });
      }
      const settingsNav = document.getElementById('ownerSettingsPanelNav');
      if (settingsNav && settingsNav.dataset.bound !== '1') {
        settingsNav.dataset.bound = '1';
        settingsNav.querySelectorAll('[data-owner-settings-panel-target]').forEach(btn => {
          btn.onclick = () => setOwnerSettingsPanel(btn.getAttribute('data-owner-settings-panel-target'));
        });
      }
      applyOwnerDashboardPanel();
      applyOwnerSettingsPanel();
    }

    function renderStudentPortal() {
      const student = tourMode ? getTourStudent() : getStudentProfileBySession();
      const sessionsUl = document.getElementById('portalSessions');
      const hwUl = document.getElementById('portalHomework');
      const invUl = document.getElementById('portalInvoices');
      const resUl = document.getElementById('portalResources');
      const portalBlocker = document.getElementById('portalBlocker');
      if (!student) {
        const msg = `<li class="text-slate-500 text-xs">${esc(t('portal.no_student_linked'))}</li>`;
        if (sessionsUl) sessionsUl.innerHTML = msg;
        if (hwUl) hwUl.innerHTML = msg;
        if (invUl) invUl.innerHTML = msg;
        if (resUl) resUl.innerHTML = msg;
        void renderStudentSupportCard();
        return;
      }
      // If contract not signed, show blocker and limit content
      const signed = !!student.contractSigned;
      if (portalBlocker) {
        portalBlocker.classList.toggle('hidden', signed);
      }
      if (!signed) {
        const checkBtn = document.getElementById('portalCheckContractBtn');
        if (checkBtn) {
          checkBtn.onclick = () => startContractStatusWatch([student.id], { maxMs: 120000 });
        }
        startContractStatusWatch([student.id], { maxMs: 120000 });
        const msg = `<li class="text-slate-500 text-xs">${esc(t('portal.contract_not_signed'))}</li>`;
        if (sessionsUl) sessionsUl.innerHTML = msg;
        if (hwUl) hwUl.innerHTML = msg;
        if (invUl) invUl.innerHTML = msg;
        if (resUl) resUl.innerHTML = msg;
        const msgsList = document.getElementById('portalMessages');
        if (msgsList) msgsList.innerHTML = msg;
        void renderStudentSupportCard();
        return;
      }
      const busyNotice = document.getElementById('portalBusyNotice');
      const busyList = document.getElementById('portalBusyList');
      const upcomingBusy = getUpcomingBusyDays(45);
      if (busyNotice && busyList) {
        if (!upcomingBusy.length) {
          busyNotice.classList.add('hidden');
        } else {
          busyNotice.classList.remove('hidden');
          busyList.innerHTML = upcomingBusy.map(b => `
            <li class="flex items-start gap-2">
              <span class="busy-badge">${esc(t('schedule.busy'))}</span>
              <span>${esc(b.date)}${b.note ? ` ‚Ä¢ ${esc(b.note)}` : ''}</span>
            </li>
          `).join('');
        }
      }
      const now = new Date();
      const mySessions = getScheduleVisibleSessions()
        .filter(s => s.studentIds.includes(student.id))
        .filter(s => getSessionStatus(s) !== SESSION_STATUS.COMPLETE && getSessionStatus(s) !== SESSION_STATUS.VOIDED)
        .filter(s => {
          const start = new Date(s.date + 'T' + (s.startTime || '00:00'));
          const durationMs = Number(s.durationHours || 1) * 60 * 60 * 1000;
          const end = new Date(start.getTime() + durationMs);
          return end >= now;
        })
        .sort((a, b) => new Date(a.date + 'T' + (a.startTime || '00:00')) - new Date(b.date + 'T' + (b.startTime || '00:00')));
      const portalReminder = document.getElementById('portalSessionReminder');
      if (portalReminder) {
        const activeSessions = mySessions.filter(s => {
          const start = new Date(s.date + 'T' + (s.startTime || '00:00'));
          const durationMs = Number(s.durationHours || 1) * 60 * 60 * 1000;
          const end = new Date(start.getTime() + durationMs);
          return now >= start && now <= end;
        });
        const lateSessions = activeSessions.filter(s => !s.attended);
        const returnSessions = activeSessions.filter(s => s.attended && getSessionStatus(s) !== SESSION_STATUS.COMPLETE);
        if (!lateSessions.length && !returnSessions.length) {
          portalReminder.classList.add('hidden');
          portalReminder.innerHTML = '';
        } else {
          const isLate = lateSessions.length > 0;
          portalReminder.className = `rounded-lg border px-2 py-1 text-[11px] ${isLate ? 'border-rose-200 bg-rose-50 text-rose-800' : 'border-amber-200 bg-amber-50 text-amber-900'}`;
          const lines = [];
          if (lateSessions.length) {
            lines.push(`<div class="font-semibold">${esc(t('portal.reminder_late_title'))}</div>`);
            lines.push(`<ul class="mt-1 space-y-0.5">${lateSessions.map(s => {
              return `<li>${esc(t('portal.reminder_late_line', { subject: s.subject || t('common.lesson'), time: s.startTime || '' }))}</li>`;
            }).join('')}</ul>`);
          }
          if (returnSessions.length) {
            lines.push(`<div class="font-semibold mt-2">${esc(t('portal.reminder_return_title'))}</div>`);
            lines.push(`<ul class="mt-1 space-y-0.5">${returnSessions.map(s => {
              return `<li>${esc(t('portal.reminder_return_line', { subject: s.subject || t('common.lesson'), time: s.startTime || '' }))}</li>`;
            }).join('')}</ul>`);
          }
          portalReminder.innerHTML = lines.join('');
          portalReminder.classList.remove('hidden');
        }
      }
      if (sessionsUl) {
        sessionsUl.innerHTML = mySessions.length ? mySessions.map(s => {
          const modeLabel = getSessionModeLabel(s.sessionMode ?? s.session_mode ?? s.mode);
          const isOnline = isOnlineSession(s);
          const isBusyDay = isBusyDate(s.date);
          const busyLabel = isBusyDay ? `<span class="session-chip session-chip-busy">${esc(t('schedule.busy_date'))}</span>` : '';
          const safeSessionId = cleanId(s.id);
          const joinBtn = isOnline
            ? (isBusyDay
              ? `<button class="portal-cta-btn portal-cta-subtle portal-cta-btn-block text-rose-700 border-rose-300 cursor-not-allowed" disabled>
                  ${esc(t('schedule.tutor_busy_on_date'))}
                </button>`
              : canJoinMeetingNow(s)
              ? `<button class="portal-cta-btn portal-cta-join portal-cta-btn-block" onclick="openMeetingForSession('${safeSessionId}')" aria-label="Join online lesson for ${esc(s.subject || t('common.lesson'))} on ${esc(s.date)}">${esc(t('meeting.join_online'))}</button>`
              : `<button class="portal-cta-btn portal-cta-subtle portal-cta-btn-block cursor-not-allowed" disabled>
                  ${esc(t('meeting.join_10_min_before'))}
                </button>`)
            : '';
          return `
          <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${esc(s.subject)} ‚Ä¢ ${esc(s.topic || t('common.lesson'))}</div>
            <div class="text-[10px] text-slate-500 flex items-center gap-2">
              <span>${esc(s.date)} ${esc(s.startTime || '')} ‚Ä¢ ${esc(s.durationHours || 1)}h ‚Ä¢ ${esc(modeLabel)}</span>
              ${busyLabel}
            </div>
            ${joinBtn ? `<div class="mt-2">${joinBtn}</div>` : ''}
          </li>
        `;
        }).join('') : `<li class="text-slate-500 text-xs">${esc(t('portal.no_sessions_next_14'))}</li>`;
      }

      const allHw = state.homework.filter(hw => hw.studentId === student.id);
      const myHw = allHw.filter(hw => hw.status !== 'Completed');
      if (hwUl) {
        hwUl.innerHTML = myHw.length ? myHw.map(hw => {
          const res = getResourceById(hw.resourceId);
          const statusLabel = getHomeworkStatusLabel(hw.status);
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${esc(res?.title || t('common.homework'))}</div>
            <div class="text-[10px] text-slate-500">${esc(t('homework.status_label'))} ${esc(statusLabel)} ‚Ä¢ ${esc(t('homework.due_label'))} ${esc(hw.dueDate || t('common.na'))}</div>
          </li>`;
        }).join('') : `<li class="text-slate-500 text-xs">${esc(t('portal.no_open_homework'))}</li>`;
      }

      const myInv = state.invoices.filter(inv => inv.studentId === student.id && !isInvoiceVoid(inv))
        .sort((a, b) => new Date(a.dueDate || 0) - new Date(b.dueDate || 0));
      if (invUl) {
        invUl.innerHTML = myInv.length ? myInv.map(inv => {
          const methodLabel = getInvoicePaymentLabel(inv);
          const sessionLabel = inv.numSessions === 1 ? t('common.session') : t('common.sessions');
          return `
          <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${esc(t('invoice.label', { id: inv.id }))}</div>
            <div class="text-[10px] text-slate-500">
              ${esc(t('invoice.issued_label'))} ${esc(inv.issueDate || t('common.na'))} ‚Ä¢ ${esc(t('invoice.due_label'))} ${esc(inv.dueDate || t('common.na'))}
              ${inv.servicePeriodStart && inv.servicePeriodEnd ? ` ‚Ä¢ ${esc(inv.servicePeriodStart)} ‚Üí ${esc(inv.servicePeriodEnd)}` : ''}
              ${inv.numSessions ? ` ‚Ä¢ ${esc(inv.numSessions)} ${esc(sessionLabel)}` : ''}
              ‚Ä¢ R ${esc(Number(inv.total || 0).toFixed(2))} ‚Ä¢ ${esc(getInvoiceStatusLabel(inv))}
              ${methodLabel ? ` ‚Ä¢ ${esc(methodLabel)}` : ''}
              ${(inv.invoiceType || inv.invoice_type) === 'adjustment' ? ` ‚Ä¢ ${esc(t('invoice.adjustment'))}` : ''}
              ${(inv.invoiceType || inv.invoice_type) === 'refund' ? ` ‚Ä¢ ${esc(t('invoice.refund'))}` : ''}
            </div>
          </li>
        `;
        }).join('') : `<li class="text-slate-500 text-xs">${esc(t('portal.no_invoices'))}</li>`;
      }

      // Resources assigned via homework
      const resourceIds = new Set(allHw.map(hw => hw.resourceId));
      const myRes = state.resources.filter(r => resourceIds.has(r.id));
      if (resUl) {
        resUl.innerHTML = myRes.length ? myRes.map(r => `
          <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${esc(r.title)}</div>
            <div class="text-[10px] text-slate-500">${esc(r.subject)} ‚Ä¢ ${esc(r.level || '')}</div>
            ${getResourceOpenUrl(r) ? `<a class="text-[10px] text-indigo-600" href="${esc(getResourceOpenUrl(r))}" target="_blank">${esc(t('resources.open_resource'))}</a>` : ''}
          </li>
        `).join('') : `<li class="text-slate-500 text-xs">${esc(t('portal.no_resources'))}</li>`;
      }

      // Messages in portal
      const msgsList = document.getElementById('portalMessages');
      if (msgsList) {
        const msgs = state.messages
          .filter(m => m.studentId === student.id)
          .sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
        msgsList.innerHTML = msgs.length ? msgs.map(m => `
          <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="flex justify-between text-[10px] text-slate-500">
              <span>${m.sender === 'owner' ? esc(t('messages.tutor')) : esc(t('messages.you'))}</span>
              <span>${esc(m.created_at ? new Date(m.created_at).toLocaleString() : '')}</span>
            </div>
            <div>${esc(m.text)}</div>
          </li>
        `).join('') : `<li class="text-slate-500 text-xs">${esc(t('portal.no_messages'))}</li>`;
      }

      // AI Study Helper wiring
      const aiBtn = document.getElementById('portalAiAskBtn');
      const aiQ = document.getElementById('portalAiQuestion');
      const aiOut = document.getElementById('portalAiAnswer');
      const aiStatus = document.getElementById('portalAiStatus');
      const aiCard = document.getElementById('portalAiCard');
      if (aiCard) aiCard.classList.toggle('hidden', !isOwner());
      if (aiBtn && aiQ && aiOut) {
        aiBtn.onclick = async () => {
          const question = aiQ.value.trim();
          if (!question) return;
          aiBtn.disabled = true;
          aiStatus.textContent = t('ai.thinking');
          aiOut.textContent = '';
          try {
            const recentSessions = state.sessions
              .filter(s => s.studentIds.includes(student.id))
              .sort((a, b) => new Date(b.date) - new Date(a.date))
              .slice(0, 5)
              .map(s => ({ date: s.date, subject: s.subject, topic: s.topic, notes: s.notes }));
            const resourceIds = new Set(state.homework.filter(h => h.studentId === student.id).map(h => h.resourceId));
            const resources = state.resources
              .filter(r => resourceIds.has(r.id))
              .map(r => ({ title: r.title, subject: r.subject, tags: r.tags, description: r.description }));
            const answer = await callLLM('study_helper', { question, recentSessions, resources });
            renderAiMarkup(aiOut, answer || t('ai.no_answer'));
          } catch (err) {
            aiOut.textContent = err?.message || 'AI helper failed.';
          } finally {
            aiBtn.disabled = false;
            aiStatus.textContent = '';
          }
        };
      }
      void renderStudentSupportCard();
    }

    function getChildrenForParent() {
      const parent = getParentProfileBySession();
      if (!parent) return [];
      const links = state.parentLinks.filter(pl => pl.parentId === parent.id);
      return links.map(pl => state.students.find(s => s.id === pl.studentId)).filter(Boolean);
    }

    function normalizePersonValue(value) {
      return String(value || '').replace(/\s+/g, ' ').trim();
    }

    function normalizePhoneValue(value) {
      const cleaned = normalizePersonValue(value);
      if (!cleaned) return '';
      const match = cleaned.match(/^\+\d+/);
      if (!match) return cleaned;
      const code = match[0];
      let rest = cleaned.slice(code.length).trim();
      while (rest.startsWith(code)) {
        rest = rest.slice(code.length).trim();
      }
      rest = rest.replace(/^\+\d+\s*/, '');
      return rest ? `${code} ${rest}` : code;
    }

    function splitPhoneValue(value) {
      const normalized = normalizePhoneValue(value);
      const match = normalized.match(/^\+\d+/);
      const code = match ? match[0] : '';
      const safeCode = PHONE_CODES.includes(code) ? code : '';
      const local = safeCode ? normalized.slice(safeCode.length).trim() : normalized;
      return { code: safeCode, local };
    }

    function buildPhoneValue(code, local) {
      const cleanedCode = normalizePersonValue(code);
      let cleanedLocal = normalizePersonValue(local);
      cleanedLocal = cleanedLocal.replace(/^\+\d+\s*/, '');
      if (!cleanedCode && !cleanedLocal) return '';
      if (cleanedCode && cleanedLocal) return `${cleanedCode} ${cleanedLocal}`;
      return cleanedCode || cleanedLocal;
    }

    function getParentPromptStorageKey(parent) {
      const id = parent?.id || getSessionParentId() || getSessionLoginCode() || getSessionEmail() || 'parent';
      return `parentProfilePrompted:${id}`;
    }

    function getMissingParentFields(parent) {
      if (!parent) return ['common.name', 'common.phone', 'common.email'];
      const missing = [];
      if (!normalizePersonValue(parent.name)) missing.push('common.name');
      if (!normalizePersonValue(parent.phone)) missing.push('common.phone');
      if (!normalizePersonValue(parent.email)) missing.push('common.email');
      return missing;
    }

    function hasPromptedParentProfile(parent) {
      try {
        return localStorage.getItem(getParentPromptStorageKey(parent)) === '1';
      } catch {
        return false;
      }
    }

    function markParentProfilePrompted(parent) {
      try {
        localStorage.setItem(getParentPromptStorageKey(parent), '1');
      } catch { }
    }

    function openParentSelfProfileModal(parent, opts = {}) {
      if (!opts?.allowMaintenanceBypass && !guardMaintenanceWrite('Profile updates')) return;
      if (!parent) {
        alert(t('parent.profile_not_found'));
        return;
      }
      const missing = getMissingParentFields(parent);
      const title = missing.length ? t('parent.complete_profile_title') : t('parent.edit_profile');
      const phoneParts = splitPhoneValue(parent.phone || '');
      const phoneCode = phoneParts.code;
      const phoneLocal = phoneParts.local;
      const currentEmailOptIn = !!parent.emailNotificationsOptIn;
      const allowSkip = !opts.forcePrompt;
      const html = `
        <h2 class="text-sm font-semibold mb-1">${title}</h2>
        <p class="text-[11px] text-slate-500 mb-3">
          ${t('parent.profile_prompt')}
        </p>
        <form id="parentSelfProfileForm" class="space-y-2 text-xs">
          <div>
            <label class="block text-[11px] mb-1">${t('common.name')}</label>
            <input name="name" value="${esc(parent.name || '')}" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs" required>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${t('form.email_optional')}</label>
            <input name="email" value="${esc(parent.email || '')}" placeholder="${t('form.email_placeholder')}"
              class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div class="portal-consent-card">
            <label class="flex items-start gap-3 text-[12px] text-slate-800 cursor-pointer">
              <input type="checkbox" name="emailNotificationsOptIn" ${currentEmailOptIn ? 'checked' : ''} class="mt-0.5 h-5 w-5 accent-indigo-600">
              <span>
                <span class="font-semibold">Enable service email notices</span>
                <span class="block text-[11px] text-slate-600 mt-0.5">Receive invoices, overdue reminders, lesson/schedule updates, and policy/domain notices.</span>
              </span>
            </label>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${t('common.phone')}</label>
            <div class="flex gap-2">
              <select name="phoneCode" class="border border-slate-300 rounded-lg px-2 py-1 text-xs w-28">
                ${PHONE_CODES.map(c => `<option value="${c}" ${phoneCode === c ? 'selected' : ''}>${c}</option>`).join('')}
                <option value="" ${!phoneCode ? 'selected' : ''}>${t('common.code')}</option>
              </select>
              <input name="phoneLocal" value="${esc(phoneLocal)}" class="flex-1 border border-slate-300 rounded-lg px-2 py-1 text-xs" placeholder="${t('common.number')}">
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${t('form.notes_optional')}</label>
            <textarea name="notes" rows="2" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${esc(parent.notes || '')}</textarea>
          </div>
          <div id="parentSelfProfileStatus" class="text-[10px] text-rose-600"></div>
          <div class="flex justify-between items-center mt-3">
            <button id="parentSelfProfileSaveBtn" type="submit"
              class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-xs font-medium">
              ${t('common.save')}
            </button>
            ${allowSkip ? `<button type="button" id="parentSelfProfileSkipBtn" class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs">${t('common.not_now')}</button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('parentSelfProfileForm');
        const status = document.getElementById('parentSelfProfileStatus');
        const saveBtn = document.getElementById('parentSelfProfileSaveBtn');
        const skipBtn = document.getElementById('parentSelfProfileSkipBtn');
        if (skipBtn) {
          skipBtn.onclick = () => {
            closeModal();
            markParentProfilePrompted(parent);
          };
        }
        form.onsubmit = async (e) => {
          e.preventDefault();
          if (status) status.textContent = '';
          const name = normalizePersonValue(form.name.value);
          const email = normalizePersonValue(form.email.value).toLowerCase();
          const emailNotificationsOptIn = !!form.emailNotificationsOptIn?.checked;
          if (email && !emailNotificationsOptIn) {
            if (status) status.textContent = 'Please confirm email consent to receive service emails.';
            return;
          }
          const phone = buildPhoneValue(form.phoneCode.value, form.phoneLocal.value);
          const notes = normalizePersonValue(form.notes.value);
          if (!name) {
            if (status) status.textContent = t('form.error_name_required');
            return;
          }
          if (email && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
            if (status) status.textContent = t('form.error_email_invalid');
            return;
          }
          const taken = email && state.parents.some(p => p.email === email && p.id !== parent.id);
          if (taken) {
            if (status) status.textContent = t('form.error_email_taken_parent');
            return;
          }
          if (saveBtn) saveBtn.disabled = true;
          try {
            const updates = {
              name,
              email: email || '',
              phone: phone || '',
              notes: notes || '',
              emailNotificationsOptIn: !!(email && emailNotificationsOptIn),
              emailNotificationsOptInAt: (email && emailNotificationsOptIn)
                ? ((parent.email === email && parent.emailNotificationsOptIn && parent.emailNotificationsOptInAt) ? parent.emailNotificationsOptInAt : new Date().toISOString())
                : ''
            };
            let updatedRow = null;
            if (isSupabaseReady()) {
              if (!supabaseSession?.access_token) {
                throw new Error(t('alert.sign_in_again'));
              }
              const { data, error } = await supabaseClient.functions.invoke('update-parent-profile', {
                body: { name, email, phone, notes, email_notifications_opt_in: updates.emailNotificationsOptIn },
                headers: { Authorization: `Bearer ${supabaseSession.access_token}` }
              });
              if (error) throw error;
              if (data?.error) throw new Error(data.error);
              updatedRow = data?.parent || null;
              if (!updatedRow) throw new Error(t('alert.profile_update_failed'));
            }
            if (updatedRow || !isSupabaseReady()) {
              const applied = updatedRow || {
                name,
                email: email || '',
                phone: phone || '',
                notes: notes || ''
              };
              parent.name = applied.name;
              parent.email = (applied.email || '').toLowerCase();
              parent.phone = applied.phone || '';
              parent.notes = applied.notes || '';
              parent.emailNotificationsOptIn = !!(applied.email_notifications_opt_in ?? applied.emailNotificationsOptIn ?? updates.emailNotificationsOptIn);
              parent.emailNotificationsOptInAt = parent.emailNotificationsOptIn
                ? (applied.email_notifications_opt_in_at || applied.emailNotificationsOptInAt || updates.emailNotificationsOptInAt || '')
                : '';
            }
            saveState();
            markParentProfilePrompted(parent);
            closeModal();
            renderParentPortal();
          } catch (err) {
            console.warn('Parent profile update failed', err);
            if (status) status.textContent = err?.message || t('alert.profile_update_failed_generic');
          } finally {
            if (saveBtn) saveBtn.disabled = false;
          }
        };
      });
    }

    function updateParentProfilePrompt(parent) {
      const promptCard = document.getElementById('parentProfilePrompt');
      const promptText = document.getElementById('parentProfilePromptText');
      const completeBtn = document.getElementById('parentCompleteProfileBtn');
      const writeLocked = isMaintenanceGracefulWriteBlocked();
      if (completeBtn) {
        completeBtn.onclick = () => openParentSelfProfileModal(parent);
        completeBtn.disabled = writeLocked;
        completeBtn.title = writeLocked ? 'Temporarily disabled during maintenance restricted mode.' : '';
      }
      if (!promptCard) return;
      if (!parent) {
        promptCard.classList.add('hidden');
        return;
      }
      const missing = getMissingParentFields(parent);
      if (!missing.length) {
        promptCard.classList.add('hidden');
        return;
      }
      promptCard.classList.remove('hidden');
      if (promptText) {
        const missingLabels = missing.map(key => t(key)).join(', ');
        promptText.textContent = t('parent.profile_missing_prompt', { fields: missingLabels });
      }
      if (!tourMode && !hasPromptedParentProfile(parent) && !writeLocked) {
        markParentProfilePrompted(parent);
        openParentSelfProfileModal(parent, { forcePrompt: true });
      }
    }

    function updateParentEmailOptInCard(parent) {
      const card = document.getElementById('parentEmailOptInCard');
      const textEl = document.getElementById('parentEmailOptInText');
      const btn = document.getElementById('parentEmailOptInBtn');
      const writeLocked = isMaintenanceGracefulWriteBlocked();
      if (btn) {
        btn.onclick = () => openParentSelfProfileModal(parent);
        btn.disabled = writeLocked;
        btn.title = writeLocked ? 'Temporarily disabled during maintenance restricted mode.' : '';
      }
      if (!card) return;
      if (!parent) {
        card.classList.add('hidden');
        return;
      }
      const email = normalizePersonValue(parent.email || '').toLowerCase();
      const optedIn = !!parent.emailNotificationsOptIn && !!email;
      if (optedIn) {
        card.classList.add('hidden');
        return;
      }
      if (textEl) {
        textEl.textContent = email
          ? 'Enable service email notices to receive invoice reminders, schedule updates, and policy/domain notices.'
          : 'Add an email address and enable service email notices so you do not miss invoice or schedule updates.';
      }
      if (btn) {
        btn.textContent = email ? 'Enable now' : 'Add email';
      }
      card.classList.remove('hidden');
    }

    function renderParentPortal() {
      const parent = tourMode ? getTourParent() : getParentProfileBySession();
      const maintenanceWriteLocked = isMaintenanceGracefulWriteBlocked();
      const students = tourMode && parent ? getParentLinkedStudents(parent.id) : getChildrenForParent();
      let contractUpdated = false;
      students.forEach(s => {
        if (ensureStudentContractState(s)) contractUpdated = true;
      });
      if (contractUpdated) saveState();
      const editProfileBtn = document.getElementById('parentEditProfileBtn');
      if (editProfileBtn) {
        editProfileBtn.onclick = () => openParentSelfProfileModal(parent);
        editProfileBtn.disabled = maintenanceWriteLocked;
        editProfileBtn.title = maintenanceWriteLocked ? 'Temporarily disabled during maintenance restricted mode.' : '';
      }
      updateParentProfilePrompt(parent);
      updateParentEmailOptInCard(parent);
      const guideCard = document.getElementById('parentGuideCard');
      const guideSummary = document.getElementById('parentGuideSummary');
      const guideSteps = document.getElementById('parentGuideSteps');
      const guideDismissBtn = document.getElementById('parentGuideDismissBtn');
      const sList = document.getElementById('parentStudentsList');
      if (sList) {
        sList.innerHTML = students.length ? students.map(s => {
          const safeStudentId = cleanId(s.id);
          const sig = getLatestSignature(s.id);
          const signed = !!s.contractSigned;
          const contractLabel = signed ? t('parent.contract_valid') : t('parent.contract_invalid');
          const contractClass = signed ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700';
          const contractAction = signed
            ? `<button class="portal-cta-btn portal-cta-subtle opacity-60 cursor-not-allowed" disabled>${t('parent.contract_signed_button')}</button>`
            : maintenanceWriteLocked
              ? `<button class="portal-cta-btn portal-cta-subtle opacity-60 cursor-not-allowed" disabled title="Temporarily disabled during maintenance restricted mode.">${t('parent.sign_contract_button')}</button>`
              : `<button class="portal-cta-btn portal-cta-contract" onclick="event.stopPropagation(); openContractLink('${safeStudentId}')" aria-label="Sign contract for ${esc(s.name)}">${t('parent.sign_contract_button')}</button>`;
          const aiSummaryBtn = isOwner()
            ? `<button id="btn-summary-${safeStudentId}" class="px-2 py-1 rounded-lg border border-indigo-300 text-indigo-700 hover:bg-indigo-50" onclick="parentSummaryAI('${safeStudentId}')">${t('parent.ai_summary_button')}</button>`
            : '';
          return `
            <li class="border border-slate-200 rounded-lg px-3 py-2 bg-white/80 space-y-1" data-student-id="${safeStudentId}">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-medium">${esc(s.name)}</div>
                  <div class="text-[10px] text-slate-500">${esc(s.gradeLevel || '')}</div>
                </div>
                <span class="text-[10px] px-2 py-0.5 rounded-full ${contractClass}">${contractLabel}</span>
              </div>
              <div class="text-[10px] text-slate-500">${esc(s.subjects?.join(', ') || t('parent.subjects_not_set'))}</div>
              <div class="text-[10px] text-slate-500">${t('parent.email_label')} ${esc(s.studentEmail || t('common.na'))}</div>
              <div class="text-[10px] text-slate-500">${sig ? t('parent.signed_by_on', { name: esc(sig.parentName || t('parent.parent_label')), date: esc(sig.signedAt ? new Date(sig.signedAt).toLocaleDateString() : '') }) : t('parent.no_signed_contract')}</div>
              <div class="flex flex-wrap items-center gap-2 text-[10px]">
                ${contractAction}
                ${aiSummaryBtn}
              </div>
              <div id="ai-summary-${safeStudentId}" class="text-[10px] text-slate-600 whitespace-pre-wrap"></div>
            </li>
          `;
        }).join('') : `<li class="text-slate-500 text-xs">${esc(t('parent.no_linked_students'))}</li>`;
      }
      const sessionsUl = document.getElementById('parentSessions');
      const hwUl = document.getElementById('parentHomework');
      const resUl = document.getElementById('parentResources');
      const invUl = document.getElementById('parentInvoices');
      const msgsUl = document.getElementById('parentMessages');
      // allow parent to click into student profile
      const studentsList = document.getElementById('parentStudentsList');
      if (studentsList) {
        studentsList.querySelectorAll('[data-student-id]').forEach(li => {
          li.addEventListener('click', () => selectStudent(li.dataset.studentId));
        });
      }
      const childIds = new Set(students.map(s => s.id));

      const unsignedStudents = students.filter(s => !s.contractSigned);
      const pendingInvoices = state.invoices.filter(inv =>
        childIds.has(inv.studentId) &&
        !inv.paid &&
        !isInvoiceVoid(inv) &&
        (inv.invoiceType || inv.invoice_type) !== 'refund'
      );
      const invoiceAlert = document.getElementById('parentInvoiceAlert');
      if (invoiceAlert) {
        invoiceAlert.classList.toggle('hidden', pendingInvoices.length === 0);
      }
      const invoiceAlertActionBtn = document.getElementById('parentInvoiceAlertActionBtn');
      if (invoiceAlertActionBtn) {
        invoiceAlertActionBtn.classList.toggle('hidden', pendingInvoices.length === 0);
        invoiceAlertActionBtn.onclick = () => scrollToParentInvoices();
      }
      const invoiceStatus = document.getElementById('parentInvoiceStatus');
      const invoiceStatusTitle = document.getElementById('parentInvoiceStatusTitle');
      const invoiceStatusDetail = document.getElementById('parentInvoiceStatusDetail');
      if (invoiceStatus && invoiceStatusTitle && invoiceStatusDetail) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const soonCutoff = new Date(today);
        soonCutoff.setDate(soonCutoff.getDate() + 7);
        const overdue = pendingInvoices.filter(inv => inv.dueDate && new Date(inv.dueDate) < today);
        const dueSoon = pendingInvoices.filter(inv => inv.dueDate && new Date(inv.dueDate) >= today && new Date(inv.dueDate) <= soonCutoff);
        const showStatus = overdue.length || dueSoon.length;
        invoiceStatus.classList.toggle('hidden', !showStatus);
        if (showStatus) {
          const titleKey = overdue.length ? 'parent.invoice_status_title_overdue' : 'parent.invoice_status_title_due_soon';
          invoiceStatusTitle.textContent = t(titleKey);
          invoiceStatusDetail.textContent = t('parent.invoice_status_detail', {
            overdue: overdue.length,
            soon: dueSoon.length,
            days: 7
          });
          invoiceStatus.className = overdue.length
            ? 'rounded-lg border border-rose-200 bg-rose-50/70 p-2'
            : 'rounded-lg border border-amber-200 bg-amber-50/70 p-2';
          invoiceStatusTitle.className = overdue.length
            ? 'text-[11px] font-medium text-rose-900'
            : 'text-[11px] font-medium text-amber-900';
          invoiceStatusDetail.className = overdue.length
            ? 'text-[10px] text-rose-800'
            : 'text-[10px] text-amber-800';
        }
      }
      const guideKey = `parent_guide_dismissed_${parent?.id || getSessionEmail() || 'session'}`;
      const guideDismissed = localStorage.getItem(guideKey) === '1';
      const showGuide = (unsignedStudents.length || pendingInvoices.length) && !guideDismissed;
      if (guideCard) {
        guideCard.classList.toggle('hidden', !showGuide);
        if (showGuide) {
          if (guideSummary) {
            guideSummary.textContent = t('parent.guide_summary');
          }
          const contractItems = unsignedStudents.length ? `
            <div class="border border-slate-200 rounded-lg p-2 bg-white/80">
              <div class="font-medium text-[11px]">${t('parent.guide_step1_title')}</div>
              <ul class="mt-1 space-y-1">
                ${unsignedStudents.map(s => {
                  const safeStudentId = cleanId(s.id);
                  return `
                    <li class="flex items-center justify-between gap-2">
                      <span>${esc(s.name)}</span>
                      ${maintenanceWriteLocked
            ? `<button class="portal-cta-btn portal-cta-subtle opacity-60 cursor-not-allowed" disabled title="Temporarily disabled during maintenance restricted mode.">${t('parent.guide_sign_button')}</button>`
            : `<button class="portal-cta-btn portal-cta-contract"
                        onclick="openContractLink('${safeStudentId}')">${t('parent.guide_sign_button')}</button>`}
                    </li>
                `;
                }).join('')}
              </ul>
              <div class="mt-1 text-[10px] text-slate-500">${t('parent.guide_sign_hint')}</div>
            </div>
          ` : `
            <div class="border border-slate-200 rounded-lg p-2 bg-white/80">
              <div class="font-medium text-[11px]">${t('parent.guide_step1_done_title')}</div>
              <div class="text-[10px] text-slate-500">${t('parent.guide_step1_done_detail')}</div>
            </div>
          `;
          const invoiceItems = pendingInvoices.length ? `
            <div class="border border-slate-200 rounded-lg p-2 bg-white/80">
              <div class="font-medium text-[11px]">${t('parent.guide_step2_title')}</div>
              <ul class="mt-1 space-y-1">
                ${pendingInvoices.map(inv => {
                  const stu = getStudentById(inv.studentId);
                  const safeInvId = cleanId(inv.id);
                  return `
                    <li class="flex items-center justify-between gap-2">
                      <span>${esc(stu?.name || t('common.student'))} ‚Ä¢ ${esc(inv.dueDate || t('common.na'))} ‚Ä¢ R ${esc(Number(inv.total || 0).toFixed(2))}</span>
                      ${maintenanceWriteLocked
            ? `<button class="portal-cta-btn portal-cta-subtle opacity-60 cursor-not-allowed" disabled title="Temporarily disabled during maintenance restricted mode.">${t('invoice.pay_now')}</button>`
            : `<button class="portal-cta-btn portal-cta-pay"
                        onclick="startPayfastPayment('${safeInvId}')">${t('invoice.pay_now')}</button>`}
                    </li>
                  `;
                }).join('')}
              </ul>
              <button class="mt-2 portal-cta-btn portal-cta-subtle"
                onclick="scrollToParentInvoices()">${t('parent.guide_go_to_invoices')}</button>
            </div>
          ` : `
            <div class="border border-slate-200 rounded-lg p-2 bg-white/80">
              <div class="font-medium text-[11px]">${t('parent.guide_step2_done_title')}</div>
              <div class="text-[10px] text-slate-500">${t('parent.guide_step2_done_detail')}</div>
            </div>
          `;
          const accessNote = `
            <div class="border border-slate-200 rounded-lg p-2 bg-white/80">
              <div class="font-medium text-[11px]">${t('parent.guide_step3_title')}</div>
              <div class="text-[10px] text-slate-500">${t('parent.guide_step3_detail')}</div>
            </div>
            <div class="text-[10px] text-slate-500">${t('parent.guide_contact_note')}</div>
          `;
          if (guideSteps) guideSteps.innerHTML = contractItems + invoiceItems + accessNote;
          if (guideDismissBtn) {
            guideDismissBtn.onclick = () => {
              localStorage.setItem(guideKey, '1');
              guideCard.classList.add('hidden');
            };
          }
        }
      }

      const parentBusyNotice = document.getElementById('parentBusyNotice');
      const parentBusyList = document.getElementById('parentBusyList');
      const upcomingBusy = getUpcomingBusyDays(45);
      if (parentBusyNotice && parentBusyList) {
        if (!upcomingBusy.length) {
          parentBusyNotice.classList.add('hidden');
        } else {
          parentBusyNotice.classList.remove('hidden');
          parentBusyList.innerHTML = upcomingBusy.map(b => `
            <li class="flex items-start gap-2">
              <span class="busy-badge">${esc(t('schedule.busy'))}</span>
              <span>${esc(b.date)}${b.note ? ` ‚Ä¢ ${esc(b.note)}` : ''}</span>
            </li>
          `).join('');
        }
      }

      const now = new Date();
      const sessionsWithDates = state.sessions
        .filter(s => s.studentIds.some(id => childIds.has(id)))
        .filter(s => {
          if (!s.invoiceId) return false;
          const inv = state.invoices.find(i => i.id === s.invoiceId);
          return !!(inv && inv.paid && !isInvoiceVoid(inv));
        })
        .map(s => ({
          session: s,
          when: new Date(s.date + 'T' + (s.startTime || '00:00'))
        }));
      const upcomingSessions = sessionsWithDates
        .filter(s => s.when >= now)
        .sort((a, b) => a.when - b.when);
      const pastSessions = sessionsWithDates
        .filter(s => s.when < now)
        .sort((a, b) => b.when - a.when);
      const mySessions = [...upcomingSessions, ...pastSessions].map(s => s.session);
      const sessionNotice = document.getElementById('parentSessionPaymentNotice');
      if (sessionNotice) {
        sessionNotice.classList.toggle('hidden', pendingInvoices.length === 0);
      }
      if (sessionsUl) {
        sessionsUl.innerHTML = mySessions.length ? mySessions.map(s => {
          const namesRaw = s.studentIds.map(id => getStudentById(id)?.name || t('common.unknown')).join(', ');
          const names = esc(namesRaw);
          const when = new Date(s.date + 'T' + (s.startTime || '00:00'));
          const isPast = when < now;
          const sessStatus = getSessionStatus(s);
          const status = sessStatus === SESSION_STATUS.COMPLETE
            ? t('schedule.completed')
            : sessStatus === SESSION_STATUS.PENDING_REVIEW
              ? t('schedule.pending_review')
              : sessStatus === SESSION_STATUS.VOIDED
                ? t('schedule.voided')
                : sessStatus === SESSION_STATUS.NO_SHOW_CHARGEABLE
                  ? t('schedule.no_show_chargeable')
                  : (isPast ? t('schedule.past') : t('schedule.upcoming'));
          const statusClass = sessStatus === SESSION_STATUS.COMPLETE
            ? 'bg-emerald-100 text-emerald-700'
            : sessStatus === SESSION_STATUS.PENDING_REVIEW
              ? 'bg-amber-100 text-amber-800'
              : sessStatus === SESSION_STATUS.VOIDED
                ? 'bg-slate-100 text-slate-600'
                : sessStatus === SESSION_STATUS.NO_SHOW_CHARGEABLE
                  ? 'bg-indigo-100 text-indigo-700'
                  : (isPast ? 'bg-slate-100 text-slate-600' : 'bg-indigo-100 text-indigo-700');
          const modeLabel = getSessionModeLabel(s.sessionMode ?? s.session_mode ?? s.mode);
          const isOnline = isOnlineSession(s);
          const isBusyDay = isBusyDate(s.date);
          const busyLabel = isBusyDay ? `<span class="session-chip session-chip-busy">${esc(t('schedule.busy_date'))}</span>` : '';
          const safeSessionId = cleanId(s.id);
          const joinBtn = isOnline
            ? (isBusyDay
              ? `<button class="portal-cta-btn portal-cta-subtle portal-cta-btn-block mt-2 text-rose-700 border-rose-300 cursor-not-allowed" disabled>
                  ${esc(t('schedule.tutor_busy_on_date'))}
                </button>`
              : canJoinMeetingNow(s)
              ? `<button class="portal-cta-btn portal-cta-join portal-cta-btn-block mt-2" onclick="openMeetingForSession('${safeSessionId}')" aria-label="Join online lesson for ${esc(namesRaw)} on ${esc(s.date)}">${esc(t('meeting.join_online_session'))}</button>`
              : `<button class="portal-cta-btn portal-cta-subtle portal-cta-btn-block mt-2 cursor-not-allowed" disabled>
                  ${esc(t('meeting.join_available_10_min'))}
                </button>`)
            : '';
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="flex items-center justify-between gap-2">
              <div class="font-medium">${esc(s.subject)} ‚Ä¢ ${esc(s.topic || t('common.lesson'))}</div>
              <span class="text-[10px] px-2 py-0.5 rounded-full ${statusClass}">${esc(status)}</span>
            </div>
            <div class="text-[10px] text-slate-500">${esc(s.date)} ${esc(s.startTime || '')} ‚Ä¢ ${esc(s.durationHours || 1)}h ‚Ä¢ ${names} ‚Ä¢ ${esc(modeLabel)}</div>
            ${busyLabel ? `<div class="mt-1">${busyLabel}</div>` : ''}
            ${joinBtn}
          </li>`;
        }).join('') : `<li class="text-slate-500 text-xs">${esc(pendingInvoices.length ? t('parent.sessions_locked_detail') : t('parent.no_sessions'))}</li>`;
      }

      const myHw = state.homework.filter(hw => childIds.has(hw.studentId));
      if (hwUl) {
        hwUl.innerHTML = myHw.length ? myHw.map(hw => {
          const res = getResourceById(hw.resourceId);
          const stu = getStudentById(hw.studentId);
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${esc(res?.title || t('common.homework'))}</div>
            <div class="text-[10px] text-slate-500">${esc(stu?.name || '')} ‚Ä¢ ${esc(t('homework.status_label'))} ${esc(hw.status)} ‚Ä¢ ${esc(t('homework.due_label'))} ${esc(hw.dueDate || t('common.na'))}</div>
          </li>`;
        }).join('') : `<li class="text-slate-500 text-xs">${esc(t('parent.no_homework'))}</li>`;
      }

      const myResIds = new Set(myHw.map(hw => hw.resourceId));
      const myRes = state.resources.filter(r => myResIds.has(r.id));
      if (resUl) {
        resUl.innerHTML = myRes.length ? myRes.map(r => `
          <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${esc(r.title)}</div>
            <div class="text-[10px] text-slate-500">${esc(r.subject)} ‚Ä¢ ${esc(r.level || '')}</div>
            ${getResourceOpenUrl(r) ? `<a class="text-[10px] text-indigo-600" href="${esc(getResourceOpenUrl(r))}" target="_blank">${esc(t('resources.open_resource'))}</a>` : ''}
          </li>
        `).join('') : `<li class="text-slate-500 text-xs">${esc(t('parent.no_resources'))}</li>`;
      }

      const myInv = state.invoices.filter(inv => childIds.has(inv.studentId) && !isInvoiceVoid(inv))
        .sort((a, b) => new Date(a.dueDate || 0) - new Date(b.dueDate || 0));
      if (invUl) {
        invUl.innerHTML = myInv.length ? myInv.map(inv => {
          const s = getStudentById(inv.studentId);
          const methodLabel = getInvoicePaymentLabel(inv);
          const safeInvId = cleanId(inv.id);
          const aiBtn = isOwner()
            ? `<button id="btn-inv-${safeInvId}" class="px-2 py-1 rounded-lg border border-indigo-300 text-indigo-700 hover:bg-indigo-50" onclick="explainInvoiceAI('${safeInvId}')">${t('ai.explain_invoice')}</button>`
            : '';
          const sessionLabel = inv.numSessions === 1 ? t('common.session') : t('common.sessions');
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${esc(t('invoice.label', { id: inv.id }))}</div>
            <div class="text-[10px] text-slate-500">
              ${esc(s?.name || '')} ‚Ä¢ ${esc(t('invoice.issued_label'))} ${esc(inv.issueDate || t('common.na'))} ‚Ä¢ ${esc(t('invoice.due_label'))} ${esc(inv.dueDate || t('common.na'))}
              ${inv.servicePeriodStart && inv.servicePeriodEnd ? ` ‚Ä¢ ${esc(inv.servicePeriodStart)} ‚Üí ${esc(inv.servicePeriodEnd)}` : ''}
              ${inv.numSessions ? ` ‚Ä¢ ${esc(inv.numSessions)} ${esc(sessionLabel)}` : ''}
              ‚Ä¢ R ${esc(Number(inv.total || 0).toFixed(2))} ‚Ä¢ ${esc(getInvoiceStatusLabel(inv))}
              ${methodLabel ? ` ‚Ä¢ ${esc(methodLabel)}` : ''}
              ${(inv.invoiceType || inv.invoice_type) === 'adjustment' ? ` ‚Ä¢ ${esc(t('invoice.adjustment'))}` : ''}
              ${(inv.invoiceType || inv.invoice_type) === 'refund' ? ` ‚Ä¢ ${esc(t('invoice.refund'))}` : ''}
            </div>
            <div class="flex flex-wrap gap-2 mt-1 text-[10px]">
              ${aiBtn}
              ${!inv.paid && !isInvoiceVoid(inv) && (inv.invoiceType || inv.invoice_type) !== 'refund'
                ? maintenanceWriteLocked
                  ? `<button class="parent-pay-now-btn portal-cta-btn portal-cta-subtle opacity-60 cursor-not-allowed" disabled title="Temporarily disabled during maintenance restricted mode.">${t('invoice.pay_now')}</button>`
                  : `<button class="parent-pay-now-btn portal-cta-btn portal-cta-pay" onclick="startPayfastPayment('${safeInvId}')" aria-label="Pay invoice ${esc(inv.id)} now">${t('invoice.pay_now')}</button>`
                : ''}
            </div>
            <div id="ai-invoice-${safeInvId}" class="text-[10px] text-slate-600 whitespace-pre-wrap"></div>
          </li>`;
        }).join('') : `<li class="text-slate-500 text-xs">${esc(t('parent.no_invoices'))}</li>`;
      }

      if (msgsUl) {
        const msgs = state.messages
          .filter(m => childIds.has(m.studentId))
          .sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
        msgsUl.innerHTML = msgs.length ? msgs.map(m => {
          const s = getStudentById(m.studentId);
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="flex justify-between text-[10px] text-slate-500">
              <span>${esc(s?.name || t('common.student'))}</span>
              <span>${esc(m.created_at ? new Date(m.created_at).toLocaleString() : '')}</span>
            </div>
            <div>${esc(m.text)}</div>
          </li>`;
        }).join('') : `<li class="text-slate-500 text-xs">${esc(t('parent.no_messages'))}</li>`;
      }
      void renderParentSupportCard();
    }

    async function explainInvoiceAI(invoiceId) {
      const btn = document.getElementById(`btn-inv-${invoiceId}`);
      const out = document.getElementById(`ai-invoice-${invoiceId}`);
      if (btn) { btn.disabled = true; btn.textContent = t('ai.explaining'); }
      if (out) out.textContent = '';
      try {
        const inv = state.invoices.find(i => i.id === invoiceId);
        if (!inv) throw new Error(t('alert.invoice_not_found'));
        const sessions = state.sessions
          .filter(s => s.studentIds.includes(inv.studentId))
          .map(s => ({
            date: s.date,
            subject: s.subject,
            topic: s.topic,
            duration: s.durationHours
          }));
        const text = await callLLM('invoice_explainer', { invoice: inv, sessions });
        if (out) renderAiMarkup(out, text);
      } catch (err) {
        if (out) out.textContent = err?.message || t('ai.failed');
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = t('ai.explain_invoice'); }
      }
    }

    async function parentSummaryAI(studentId) {
      const btn = document.getElementById(`btn-summary-${studentId}`);
      const out = document.getElementById(`ai-summary-${studentId}`);
      if (btn) { btn.disabled = true; btn.textContent = t('ai.summarizing'); }
      if (out) out.textContent = '';
      try {
        const stu = getStudentById(studentId);
        if (!stu) throw new Error(t('alert.student_not_found'));
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - 30);
        const sessions = state.sessions
          .filter(s => s.studentIds.includes(studentId))
          .filter(s => new Date(s.date) >= cutoff)
          .map(s => ({ date: s.date, subject: s.subject, topic: s.topic, notes: s.notes }));
        const homework = state.homework
          .filter(h => h.studentId === studentId)
          .map(h => ({ resource: getResourceById(h.resourceId)?.title || t('common.homework'), status: h.status, due: h.dueDate }));
        const text = await callLLM('progress_summary', {
          student: { name: stu.name, grade: stu.gradeLevel, subjects: stu.subjects },
          range: 'last 30 days',
          sessions,
          homework
        });
        if (out) renderAiMarkup(out, text);
      } catch (err) {
        if (out) out.textContent = err?.message || t('ai.failed');
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = t('parent.ai_summary_button'); }
      }
    }

    function getAvailableStudentEmails(currentEmail = '') {
      const assigned = new Set(
        state.students
          .filter(s => s.studentEmail && s.studentEmail !== currentEmail)
          .map(s => s.studentEmail)
      );
      const options = (accountEmails || []).filter(e => !assigned.has(e));
      if (currentEmail && !options.includes(currentEmail)) options.push(currentEmail);
      return options.sort();
    }

    function getAvailableParentEmails(currentEmail = '') {
      const assigned = new Set(
        state.parents
          .filter(p => p.email && p.email !== currentEmail)
          .map(p => p.email)
      );
      const options = (accountEmails || []).filter(e => !assigned.has(e));
      if (currentEmail && !options.includes(currentEmail)) options.push(currentEmail);
      return options.sort();
    }

    async function deleteStudentAndDependencies(studentId) {
      const previousState = deepClone(state);
      // Local cleanup
      state.students = state.students.filter(s => s.id !== studentId);
      state.documents = state.documents.filter(d => d.studentId !== studentId);
      state.contracts = state.contracts.filter(c => c.studentId !== studentId);
      state.contractSignatures = state.contractSignatures.filter(c => c.studentId !== studentId);
      state.homework = state.homework.filter(h => h.studentId !== studentId);
      state.studentTodos = state.studentTodos.filter(t => t.studentId !== studentId);
      state.studentCheckins = state.studentCheckins.filter(c => c.studentId !== studentId);
      state.parentLinks = state.parentLinks.filter(pl => pl.studentId !== studentId);
      // sessions: remove student from studentIds; drop sessions with no students left
      const sessionsToRemove = [];
      const removedSessionInvoiceIds = new Set();
      state.sessions.forEach(sess => {
        sess.studentIds = (sess.studentIds || []).filter(id => id !== studentId);
        if (!sess.studentIds.length) {
          sessionsToRemove.push(sess.id);
          const invId = cleanId(sess.invoiceId || '');
          if (invId) removedSessionInvoiceIds.add(invId);
        }
      });
      if (sessionsToRemove.length) {
        state.sessions = state.sessions.filter(s => !sessionsToRemove.includes(s.id));
      }
      const removedSessionIdSet = new Set(sessionsToRemove.map(cleanId).filter(Boolean));
      const invoiceStillReferenced = new Set(
        state.sessions
          .map(s => cleanId(s.invoiceId || ''))
          .filter(Boolean)
      );
      state.invoices = state.invoices.filter(inv => {
        const invStudentId = cleanId(inv.studentId || inv.student_id || '');
        const invId = cleanId(inv.id || '');
        const relatedSessionId = cleanId(inv.relatedSessionId || inv.related_session_id || '');
        if (invStudentId === cleanId(studentId)) return false;
        if (relatedSessionId && removedSessionIdSet.has(relatedSessionId)) return false;
        if (removedSessionInvoiceIds.has(invId) && !invoiceStillReferenced.has(invId)) return false;
        return true;
      });
      saveState();

      // Remote cleanup if signed in
      if (isSupabaseReady()) {
        const isIgnorableDbError = (err) => {
          const msg = String(err?.message || err || '').toLowerCase();
          return msg.includes('does not exist') || (msg.includes('column') && msg.includes('does not exist'));
        };
        const throwIfError = (error, label) => {
          if (!error) return;
          if (isIgnorableDbError(error)) return;
          throw new Error(`${label}: ${error.message || error}`);
        };
        const deleteBy = async (table, column, value) => {
          const { error } = await supabaseClient.from(table).delete().eq(column, value);
          throwIfError(error, `Delete failed for ${table}`);
        };

        try {
          // Fetch login_code before deleting to also remove auth user.
          let loginCodeToDelete = '';
          const { data: studentMeta, error: studentMetaErr } = await supabaseClient
            .from('students')
            .select('login_code')
            .eq('id', studentId)
            .maybeSingle();
          throwIfError(studentMetaErr, 'Student lookup failed');
          loginCodeToDelete = normalizeCode(studentMeta?.login_code || '');

          let removedViaCode = false;
          if (loginCodeToDelete) {
            const accessToken = requireAccessToken(t('alert.sign_in_first'));
            const stepUp = await issueActionNonce(
              ACTION_NONCE_ACTIONS.deleteAccountByCode,
              { login_code: loginCodeToDelete },
              accessToken
            );
            const { data: deleteByCodeData, error: deleteByCodeErr } = await supabaseClient.functions.invoke('delete-account', {
              body: {
                login_code: loginCodeToDelete,
                action_nonce: stepUp.nonce,
                request_fingerprint: stepUp.requestFingerprint
              },
              headers: { Authorization: `Bearer ${accessToken}` }
            });
            if (deleteByCodeErr || !deleteByCodeData?.success) {
              throw new Error(deleteByCodeErr?.message || deleteByCodeData?.error || 'Delete by login code failed.');
            }
            removedViaCode = true;
            if (Array.isArray(deleteByCodeData?.warnings) && deleteByCodeData.warnings.length) {
              console.warn('Delete by login code warnings', deleteByCodeData.warnings);
            }
          }

          if (!removedViaCode) {
            // Remove dependents first to avoid FK failures.
            await deleteBy('session_students', 'student_id', studentId);
            await deleteBy('parent_students', 'student_id', studentId);
            await deleteBy('session_cancellations', 'student_id', studentId);
            const dependentStudentTables = [
              'documents',
              'contracts',
              'invoices',
              'homework',
              'support_tickets',
              'student_todos',
              'student_checkins',
              'parent_contract_signatures',
              'messages',
              'contract_sign_tokens',
              'presence'
            ];
            for (const table of dependentStudentTables) {
              await deleteBy(table, 'student_id', studentId);
            }
          }

          if (sessionsToRemove.length) {
            const { error: lessonDeleteErr } = await supabaseClient
              .from('lesson_sessions')
              .delete()
              .in('id', sessionsToRemove);
            throwIfError(lessonDeleteErr, 'Delete failed for lesson_sessions');
          }
          if (sessionsToRemove.length) {
            const { error: invByRelatedErr } = await supabaseClient
              .from('invoices')
              .delete()
              .in('related_session_id', sessionsToRemove);
            throwIfError(invByRelatedErr, 'Delete failed for invoices by related_session_id');
          }
          const invoiceIdsToDelete = [...removedSessionInvoiceIds].filter(id => !invoiceStillReferenced.has(id));
          if (invoiceIdsToDelete.length) {
            const { error: invByIdErr } = await supabaseClient
              .from('invoices')
              .delete()
              .in('id', invoiceIdsToDelete);
            throwIfError(invByIdErr, 'Delete failed for invoices by id');
          }

          // Finally delete student row itself (if not already removed by delete-account login_code flow).
          if (!removedViaCode) {
            const { error: studentDeleteErr } = await supabaseClient.from('students').delete().eq('id', studentId);
            throwIfError(studentDeleteErr, 'Delete failed for students');
          }
        } catch (err) {
          // Roll back local state when remote delete fails, so UI and DB don't diverge.
          state = previousState;
          saveState();
          renderAllViews();
          throw err;
        }
      }
      await pruneOrphanInvoices({ persistRemote: isSupabaseReady() && isOwner(), skipSave: true });
      saveState();
    }

    async function deleteAccountFlow() {
      const statusEl = document.getElementById('deleteAccountStatus');
      const confirm1 = confirm(t('confirm.delete_account_primary'));
      if (!confirm1) return;
      const confirm2 = confirm(t('confirm.delete_account_secondary'));
      if (!confirm2) return;
      if (!isSupabaseReady()) {
        alert(t('alert.sign_in_first'));
        return;
      }
      const uid = supabaseSession.user.id;
      try {
        if (statusEl) statusEl.textContent = t('status.deleting_account');
        const { data, error } = await supabaseClient.functions.invoke('delete-account', {
          headers: { Authorization: `Bearer ${supabaseSession.access_token}` }
        });
        if (error || !data?.success) {
          throw error || new Error(data?.error || t('alert.delete_failed_backend'));
        }
        // Clear local state and sign out
        localStorage.removeItem(getStorageKey());
        state = deepClone(defaultState);
        await supabaseClient.auth.signOut();
        alert(t('alert.account_deleted'));
        window.location.reload();
      } catch (err) {
        console.error(err);
        const msg = err?.message || t('alert.delete_failed_try_again');
        if (statusEl) statusEl.textContent = msg;
        alert(msg);
      }
    }

    /***********************
     * SUPABASE AUTH
     ***********************/
    function loadHCaptcha() {
      if (!HCAPTCHA_ENABLED || !HCAPTCHA_SITEKEY || HCAPTCHA_SITEKEY.includes('YOUR_HCAPTCHA')) return;
      const existing = document.querySelector('script[src*="js.hcaptcha.com/1/api.js"]');
      if (existing) {
        if (window.hcaptcha) {
          hcaptchaOnLoad();
        } else {
          existing.addEventListener('load', hcaptchaOnLoad, { once: true });
        }
        return;
      }
      const script = document.createElement('script');
      script.src = 'https://js.hcaptcha.com/1/api.js?onload=hcaptchaOnLoad&render=explicit';
      script.async = true;
      script.onload = hcaptchaOnLoad;
      document.head.appendChild(script);
    }

    function hcaptchaOnLoad() {
      if (!HCAPTCHA_ENABLED || !window.hcaptcha) return;
      if (hcaptchaWidgetId !== null) return; // already rendered
      const container = document.getElementById('hcaptchaContainer');
      if (!container) return;
      hcaptchaWidgetId = hcaptcha.render(container, {
        sitekey: HCAPTCHA_SITEKEY,
        callback: 'onHCaptchaSuccess',
        'expired-callback': 'onHCaptchaExpired'
      });
    }

    function onHCaptchaSuccess(token) {
      hcaptchaToken = token;
    }

    function onHCaptchaExpired() {
      hcaptchaToken = '';
      if (window.hcaptcha && hcaptchaWidgetId != null) {
        hcaptcha.reset(hcaptchaWidgetId);
      }
    }

    async function ensureHCaptcha() {
      if (!HCAPTCHA_ENABLED) return undefined;
      if (!HCAPTCHA_SITEKEY || HCAPTCHA_SITEKEY.includes('YOUR_HCAPTCHA')) {
        throw new Error('hCaptcha site key missing.');
      }
      if (!window.hcaptcha) {
        throw new Error('hCaptcha did not load. Please allow scripts for js.hcaptcha.com and retry.');
      }
      if (!hcaptchaToken) {
        throw new Error('Please complete hCaptcha.');
      }
      const token = hcaptchaToken;
      // reset after consuming to avoid re-use / expiry errors
      if (window.hcaptcha && hcaptchaWidgetId != null) {
        hcaptcha.reset(hcaptchaWidgetId);
      }
      hcaptchaToken = '';
      return token;
    }

    async function initSupabaseAuth() {
      if (!supabaseAvailable) {
        toggleLanding(false);
        toggleAuthOverlay(false);
        return;
      }
      if (HCAPTCHA_ENABLED) {
        loadHCaptcha();
      }
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const { data: sessionData } = await supabaseClient.auth.getSession();
      supabaseSession = sessionData.session;
      toggleLanding(!supabaseSession);
      toggleAuthOverlay(false);
      if (supabaseSession) {
        document.getElementById('signOutBtn')?.classList.remove('hidden');
        startPresence();
      }
      updateReadOnlyUI();
      supabaseClient.auth.onAuthStateChange((event, session) => {
        supabaseSession = session;
        toggleLanding(!session);
        toggleAuthOverlay(false);
        if (session) {
          document.getElementById('signOutBtn')?.classList.remove('hidden');
          loadAccountEmails().catch(err => console.warn('Account email fetch failed', err));
          tryLoadRemoteThenLocal()
            .then(() => {
              renderAllViews();
              maybeShowPendingAnnouncement().catch(err => console.warn('Announcement check failed', err));
              try {
                setupRealtime();
                startPresence();
              } catch (err) {
                console.warn('Post-login setup failed', err);
              }
            })
            .catch(err => console.warn('Initial load failed', err));
        } else {
          document.getElementById('signOutBtn')?.classList.add('hidden');
          state = deepClone(defaultState);
          accountEmails = [];
          privacyRead = false;
          tosRead = false;
          resetAnnouncementSessionState();
          teardownRealtime();
          stopPresence();
        }
        updateReadOnlyUI();
      });

      const authForm = document.getElementById('authForm');
      const authMsg = document.getElementById('authMessage');
      const readPrivacyBtn = document.getElementById('readPrivacyBtn');
      const readTosBtn = document.getElementById('readTosBtn');
      if (readPrivacyBtn) readPrivacyBtn.onclick = () => openPolicyModal('privacy');
      if (readTosBtn) readTosBtn.onclick = () => openPolicyModal('tos');
      if (authForm) {
        authForm.onsubmit = async (e) => {
          e.preventDefault();
          const action = e.submitter?.dataset?.action || 'signin';
          const email = authForm.email.value.trim();
          const password = authForm.password.value.trim();
          authMsg.textContent = '';
          try {
            if (action === 'signup' && !authForm.consent.checked) {
              throw new Error('Please provide consent to receive account emails.');
            }
            if (action === 'signup' && (!privacyRead || !tosRead)) {
              throw new Error('Please read and acknowledge the Privacy Policy and Terms of Service before signing up.');
            }
            const captchaToken = await ensureHCaptcha();
            if (action === 'signup') {
              const { error } = await supabaseClient.auth.signUp({
                email,
                password,
                options: {
                  ...(HCAPTCHA_ENABLED ? { captchaToken } : {}),
                  emailRedirectTo: appUrl('/confirmation.html')
                }
              });
              if (error) throw error;
              authMsg.textContent = 'Check your email to confirm, then sign in.';
            } else {
              const { error } = await supabaseClient.auth.signInWithPassword({
                email,
                password,
                options: HCAPTCHA_ENABLED ? { captchaToken } : {}
              });
              if (error) throw error;
            }
          } catch (err) {
            const msg = err?.message || 'Auth error';
            if (msg.toLowerCase().includes('captcha')) {
              authMsg.textContent = 'Captcha verification failed. If Supabase captcha is enabled, set HCAPTCHA_ENABLED=true and allow the widget to load, or disable captcha in Supabase Auth settings.';
            } else {
              authMsg.textContent = msg;
            }
          }
        };
      }
    }

    function toggleLanding(show) {
      const lp = document.getElementById('landingPage');
      const shell = document.getElementById('appShell');
      if (lp) lp.classList.toggle('hidden', !show);
      if (shell) shell.classList.toggle('hidden', show);
    }

    function toggleAuthOverlay(show) {
      const overlay = document.getElementById('authOverlay');
      if (!overlay) return;
      const mustShow = supabaseAvailable ? show : show;
      overlay.classList.toggle('show', !!mustShow);
      if (mustShow) {
        document.body.classList.add('overflow-hidden');
      } else {
        document.body.classList.remove('overflow-hidden');
      }
    }

    function getSessionEmail() {
      return (supabaseSession?.user?.email || '').trim().toLowerCase();
    }

    function getSessionMetadata() {
      return supabaseSession?.user?.user_metadata || {};
    }

    function getSessionRole() {
      const metaRole = (getSessionMetadata().sys_role || '').toLowerCase();
      if (metaRole) return metaRole;
      const email = getSessionEmail();
      if (email && email === OWNER_EMAIL.toLowerCase()) return 'owner';
      const uid = cleanId(supabaseSession?.user?.id || '');
      if (uid) {
        const hasParent = state.parents.some(p => cleanId(p.authUserId || p.auth_user_id || '') === uid);
        if (hasParent) return 'parent';
        const hasStudent = state.students.some(s => cleanId(s.authUserId || s.auth_user_id || '') === uid);
        if (hasStudent) return 'student';
      }
      return '';
    }

    function getSessionStudentId() {
      return cleanId(getSessionMetadata().student_id || '');
    }

    function getSessionParentId() {
      return cleanId(getSessionMetadata().parent_id || '');
    }

    function getSessionLoginCode() {
      const meta = getSessionMetadata();
      const metaCode = normalizeCode(meta.login_code || meta.loginCode || '');
      if (metaCode) return metaCode;
      const email = getSessionEmail();
      if (email && email.endsWith(CODE_EMAIL_SUFFIX)) {
        return normalizeCode(email.slice(0, -CODE_EMAIL_SUFFIX.length));
      }
      return '';
    }

    function getParentProfileBySession() {
      const parentId = getSessionParentId();
      if (parentId) {
        const byId = state.parents.find(p => p.id === parentId);
        if (byId) return byId;
      }
      const uid = cleanId(supabaseSession?.user?.id || '');
      if (uid) {
        const byAuthUser = state.parents.find(p => cleanId(p.authUserId || p.auth_user_id || '') === uid);
        if (byAuthUser) return byAuthUser;
      }
      const email = getSessionEmail();
      return state.parents.find(p => (p.email || '').toLowerCase() === email);
    }

    function getStudentProfileBySession() {
      let candidate = null;
      const studentId = getSessionStudentId();
      if (studentId) {
        candidate = state.students.find(s => s.id === studentId) || null;
      }
      if (!candidate) {
        const uid = cleanId(supabaseSession?.user?.id || '');
        if (uid) {
          candidate = state.students.find(s => cleanId(s.authUserId || s.auth_user_id || '') === uid) || null;
        }
      }
      if (!candidate) {
        const loginCode = getSessionLoginCode();
        if (loginCode) {
          candidate = state.students.find(s => normalizeCode(s.loginCode || s.login_code || '') === loginCode) || null;
        }
      }
      if (!candidate) {
        const email = getSessionEmail();
        if (email) {
          candidate = state.students.find(s => (s.studentEmail || '').toLowerCase() === email) || null;
        }
      }
      if (candidate && ensureStudentContractState(candidate)) {
        saveState();
      }
      return candidate;
    }

    function getTourStudent() {
      if (!tourMode) return null;
      return state.students.find(s => s.contractSigned) || state.students[0] || null;
    }

    function getTourParent() {
      if (!tourMode) return null;
      return state.parents[0] || null;
    }

    function getViewerStudentIds() {
      if (studentMode) {
        const student = getStudentProfileBySession();
        return student ? [student.id] : [];
      }
      if (parentMode) {
        const parent = getParentProfileBySession();
        const students = parent ? getParentLinkedStudents(parent.id) : getChildrenForParent();
        return students.map(s => s.id);
      }
      return state.students.map(s => s.id);
    }

    function getTodayUpcomingSessionsForViewer() {
      const todayStr = toDateOnly(new Date());
      const now = new Date();
      return getScheduleVisibleSessions()
        .filter(s => s.date === todayStr)
        .filter(s => {
          const status = getSessionStatus(s);
          return status === SESSION_STATUS.SCHEDULED || status === SESSION_STATUS.RESTORED;
        })
        .filter(s => new Date(s.date + 'T' + (s.startTime || '00:00')) >= now)
        .sort((a, b) => (a.date + 'T' + (a.startTime || '00:00')).localeCompare(b.date + 'T' + (b.startTime || '00:00')));
    }

    function formatSessionAlertLine(sess) {
      const start = new Date(sess.date + 'T' + (sess.startTime || '00:00'));
      const mins = Math.max(0, Math.round((start - new Date()) / 60000));
      const hours = Math.floor(mins / 60);
      const minutes = mins % 60;
      const countdown = mins ? (hours ? `${hours}h ${minutes}m` : `${minutes}m`) : 'now';
      const timeLabel = esc(sess.startTime || 'TBD');
      const subject = esc(sess.subject || 'Lesson');
      const names = studentMode ? '' : esc(sess.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', '));
      const who = names ? ` ‚Ä¢ ${names}` : '';
      const modeLabel = esc(getSessionModeLabel(sess.sessionMode ?? sess.session_mode ?? sess.mode));
      return `<li><strong>${timeLabel}</strong> (${countdown}) ‚Ä¢ ${subject}${who} ‚Ä¢ ${modeLabel}</li>`;
    }

    function renderSessionAlerts() {
      const banner = document.getElementById('sessionAlertBanner');
      if (!banner) return;
      const sessions = getTodayUpcomingSessionsForViewer();
      if (!sessions.length) {
        banner.classList.add('hidden');
        return;
      }
      const role = studentMode ? 'student' : parentMode ? 'parent' : 'owner';
      const key = `session_alert_dismissed_${role}_${toDateOnly(new Date())}`;
      if (sessionStorage.getItem(key) === '1') {
        banner.classList.add('hidden');
        return;
      }
      const title = studentMode
        ? 'Today: your upcoming lesson'
        : parentMode
          ? 'Today: your child has upcoming lessons'
          : 'Today: upcoming lessons';
      const meetingSessions = parentMode ? [] : sessions.filter(canJoinMeetingNow);
      const meetingBlock = meetingSessions.length ? `
        <div class="mt-2 flex flex-wrap gap-2">
          ${meetingSessions.map(s => {
            const safeSessionId = cleanId(s.id);
            return `
              <button class="portal-cta-btn portal-cta-join" onclick="openMeetingForSession('${safeSessionId}')">
                ${t('meeting.join_label', { time: esc(s.startTime || t('meeting.session')) })}
              </button>`;
          }).join('')}
        </div>` : '';
      banner.innerHTML = `
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="font-semibold">${title}</div>
            <ul class="text-[11px] mt-1 space-y-0.5">
              ${sessions.map(formatSessionAlertLine).join('')}
            </ul>
            ${meetingBlock}
          </div>
          <button class="text-[11px] px-2 py-1 rounded-lg border border-rose-300 bg-white/80">${t('common.dismiss')}</button>
        </div>
      `;
      banner.classList.remove('hidden');
      const btn = banner.querySelector('button');
      if (btn) {
        btn.onclick = () => {
          sessionStorage.setItem(key, '1');
          banner.classList.add('hidden');
        };
      }
    }

    function isOwner() {
      if (!supabaseAvailable) return true;
      if (getSessionRole() === 'owner') return true;
      return !!(supabaseSession && getSessionEmail() === OWNER_EMAIL.toLowerCase());
    }

    function canJoinMeetingNow(session) {
      if (!isOnlineSession(session)) return false;
      const status = getSessionStatus(session);
      if (status === SESSION_STATUS.COMPLETE || status === SESSION_STATUS.VOIDED || status === SESSION_STATUS.NO_SHOW_CHARGEABLE) return false;
      if (!session?.date) return false;
      const start = new Date(session.date + 'T' + (session.startTime || '00:00'));
      const durationMs = Number(session.durationHours || 1) * 60 * 60 * 1000;
      const end = new Date(start.getTime() + durationMs);
      const joinFrom = new Date(start.getTime() - MEETING_JOIN_LEAD_MINUTES * 60 * 1000);
      const now = new Date();
      return now >= joinFrom && now <= end;
    }

	    async function fetchMeetingJoinUrl(sessionId) {
	      if (!supabaseAvailable || !supabaseSession) throw new Error(t('alert.sign_in_join_meetings'));
	      const body = { session_id: sessionId };
	      if (studentMode) {
	        const student = getStudentProfileBySession();
        const loginCode = normalizeCode(student?.loginCode || student?.login_code || '');
        if (student?.id && loginCode) {
          body.student_id = student.id;
          body.login_code = loginCode;
        }
      }
      const { data, error } = await supabaseClient.functions.invoke('jaas-token', {
        body
      });
      if (error) throw error;
	      if (!data?.join_url) throw new Error(t('alert.meeting_link_not_available'));
	      return data.join_url;
	    }

	    function showPopupBlockedModal(url, label = '') {
	      if (!url) return;
	      const safeLabel = label || t('common.link');
	      openModal(`
	        <h2 class="text-sm font-semibold mb-2">${esc(safeLabel)}</h2>
	        <p class="text-[11px] text-slate-600 mb-3">${esc(t('alert.popup_blocked_copy'))}</p>
	        <div class="flex flex-wrap gap-2">
	          <a class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-xs font-medium"
	             href="${esc(url)}" target="_blank" rel="noopener noreferrer">${esc(t('common.open'))}</a>
	          <button type="button" id="popupBlockedCopyBtn"
	            class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs">${esc(t('common.copy'))}</button>
	        </div>
	        <div class="mt-2 p-2 rounded-lg border border-slate-200 bg-slate-50 text-[10px] text-slate-700 break-all">${esc(url)}</div>
	      `, () => {
	        const btn = document.getElementById('popupBlockedCopyBtn');
	        if (!btn) return;
	        btn.onclick = () => {
	          navigator.clipboard?.writeText(url).then(() => {
	            btn.textContent = t('common.copied_exclaim');
	            setTimeout(() => { btn.textContent = t('common.copy'); }, 1500);
	          }).catch(() => {
	            prompt(t('prompt.copy_link'), url);
	          });
	        };
	      });
	    }

	    function renderPopupState(win, { title = '', message = '', url = '' } = {}) {
	      if (!win || win.closed) return;
	      const safeTitle = title || t('common.link');
	      const safeMessage = message || 'Opening...';
	      const safeUrl = String(url || '').trim();
	      try {
	        win.document.title = safeTitle;
	        win.document.body.innerHTML = `
	          <div style="font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 18px; color: #0f172a;">
	            <div style="font-size: 14px; font-weight: 700; margin-bottom: 6px;">${esc(safeTitle)}</div>
	            <div style="font-size: 12px; color: #475569;">${esc(safeMessage)}</div>
	            ${safeUrl ? `
	              <a href="${esc(safeUrl)}" target="_self" rel="noopener noreferrer"
	                 style="display:inline-block;margin-top:12px;padding:8px 12px;border-radius:10px;background:#4f46e5;color:#fff;text-decoration:none;font-size:12px;font-weight:600;">
	                ${esc(t('common.open'))}
	              </a>
	              <div style="margin-top:8px;font-size:10px;color:#64748b;word-break:break-all;">${esc(safeUrl)}</div>
	            ` : ''}
	          </div>
	        `;
	      } catch {}
	    }

	    // Important: must be called synchronously from a user gesture (e.g. click) or the browser will block it.
	    function openPopupPlaceholder(label = '') {
	      const win = window.open('about:blank', '_blank');
	      if (!win) return null;
	      try { win.opener = null; } catch {}
	      renderPopupState(win, {
	        title: label || t('common.link'),
	        message: 'Opening...'
	      });
	      return win;
	    }

	    function navigatePopupToUrl(popup, url, label = '') {
	      const targetUrl = String(url || '').trim();
	      if (!targetUrl) return false;
	      const safeLabel = label || t('common.link');
	      if (popup && !popup.closed) {
	        try {
	          popup.location.replace(targetUrl);
	          popup.focus();
	          return true;
	        } catch (err) {
	          console.warn('Popup navigation failed', err);
	          renderPopupState(popup, {
	            title: safeLabel,
	            message: 'Tap below to continue.',
	            url: targetUrl
	          });
	          return true;
	        }
	      }
	      const win = window.open(targetUrl, '_blank');
	      if (win) {
	        try { win.opener = null; } catch {}
	        try { win.focus(); } catch {}
	        return true;
	      }
	      showPopupBlockedModal(targetUrl, safeLabel);
	      return false;
	    }

	    async function openMeetingForSession(sessionId) {
	      let popup = null;
	      try {
	        if (parentMode) {
	          alert(t('alert.meeting_links_students_only'));
	          return;
	        }
	        // Open a placeholder tab immediately so pop-up blockers don't block the final join URL.
	        popup = openPopupPlaceholder(t('meeting.label_online_session'));
	        const joinUrl = await fetchMeetingJoinUrl(sessionId);
	        navigatePopupToUrl(popup, joinUrl, t('meeting.label_online_session'));
	      } catch (err) {
	        renderPopupState(popup, {
	          title: t('meeting.label_online_session'),
	          message: err?.message || t('alert.unable_open_meeting')
	        });
	        console.error('Meeting launch failed', err);
	        alert(err?.message || t('alert.unable_open_meeting'));
	      }
	    }

	    function openPopupWithConfirm(url, label, _features = '') {
	      if (!url) return false;
	      const safeLabel = label || t('common.link');
	      const ok = confirm(t('confirm.open_new_tab', { label: safeLabel }));
	      if (!ok) return false;
	      const popup = openPopupPlaceholder(safeLabel);
	      return navigatePopupToUrl(popup, url, safeLabel);
	    }

    function applyTourUI() {
      const tourBanner = document.getElementById('tourBanner');
      if (tourBanner) tourBanner.classList.toggle('hidden', !tourMode);
      const tourBadge = document.getElementById('tourBadge');
      if (tourBadge) tourBadge.classList.toggle('hidden', !tourMode);
      const exitBtn = document.getElementById('exitTourBtn');
      if (exitBtn) exitBtn.classList.toggle('hidden', !tourMode);
      const signOutBtn = document.getElementById('signOutBtn');
      if (tourMode && signOutBtn) signOutBtn.classList.add('hidden');
      if (tourMode) {
        document.getElementById('navPortalBtn')?.classList.remove('hidden');
        document.getElementById('navParentPortalBtn')?.classList.remove('hidden');
      }
    }

    function getActiveViewName() {
      const active = document.querySelector('.view:not(.hidden)');
      if (active && active.id && active.id.startsWith('view-')) {
        return active.id.slice('view-'.length);
      }
      return currentView;
    }

    function updateReadOnlyUI() {
      applyTourUI();
      if (supabaseAvailable && !supabaseSession) {
        // Session not resolved yet; keep UI as-is
        return;
      }
      const role = supabaseAvailable ? getSessionRole() : '';
      const parentProfile = supabaseAvailable ? getParentProfileBySession() : null;
      studentMode = role === 'student';
      parentMode = role === 'parent';
      if (!studentMode && !parentMode && supabaseAvailable && supabaseSession) {
        // Legacy fallback based on email linkage if metadata is missing
        studentMode = !!getSessionEmail() && !isOwner() && !parentProfile;
        parentMode = !!parentProfile && !isOwner();
      }
      readOnlyMode = studentMode || parentMode || (supabaseAvailable ? !isOwner() : false);
      const banner = document.getElementById('readOnlyBanner');
      if (banner) {
        if (studentMode) banner.textContent = t('banner.student_read_only');
        else if (parentMode) banner.textContent = t('banner.parent_read_only');
        else banner.textContent = t('banner.read_only');
        banner.classList.toggle('hidden', !readOnlyMode);
      }
      const main = document.querySelector('main#viewsContainer');
      if (main) main.classList.toggle('opacity-70', readOnlyMode);
      document.querySelectorAll('[data-owner-only]').forEach(el => {
        if (el.tagName === 'BUTTON' || el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.disabled = readOnlyMode;
        }
        el.classList.toggle('owner-locked', readOnlyMode);
      });
      const navFinance = document.getElementById('navFinanceBtn');
      const navReports = document.getElementById('navReportsBtn');
      const navDashboard = document.querySelector('.nav-btn[data-view="dashboard"]');
      const navStudents = document.querySelector('.nav-btn[data-view="students"]');
      const navSchedule = document.querySelector('.nav-btn[data-view="schedule"]');
      const navResources = document.querySelector('.nav-btn[data-view="resources"]');
      if (navFinance) navFinance.classList.toggle('hidden', studentMode || parentMode);
      if (navReports) navReports.classList.toggle('hidden', studentMode || parentMode);
      if (navDashboard) navDashboard.classList.toggle('hidden', studentMode || parentMode);
      if (navStudents) navStudents.classList.toggle('hidden', studentMode); // show for owner & parent
      if (navSchedule) navSchedule.classList.toggle('hidden', studentMode); // show for owner & parent
      if (navResources) navResources.classList.remove('hidden');

      const activeView = getActiveViewName();
      if (studentMode) {
        const blocked = new Set(['finance', 'reports', 'dashboard', 'parent-portal']);
        if (!activeView || blocked.has(activeView)) {
          switchView('portal');
        }
      } else if (parentMode) {
        const allowed = new Set(['parent-portal', 'students', 'schedule', 'resources', 'profile', 'settings']);
        if (!activeView || !allowed.has(activeView)) {
          switchView('parent-portal');
        }
      }
      applyOwnerDashboardPanel();
      applyOwnerSettingsPanel();
      renderMaintenanceUI();
    }

    function guardEdit() {
      if (readOnlyMode || studentMode) {
        alert(t('banner.read_only'));
        return false;
      }
      if (!guardMaintenanceWrite('Editing')) {
        return false;
      }
      return true;
    }

    async function tryLoadRemoteThenLocal() {
      if (supabaseAvailable && !supabaseSession) {
        // hold current/local state until session resolved
        state = loadState();
        return;
      }
      if (isSupabaseReady()) {
        try {
          state = await loadStateFromSupabase();
          if (isOwner()) {
            await pruneOrphanInvoices({ persistRemote: true, skipSave: true });
          }
          if (!readOnlyMode) saveState({ skipSync: true }); // persist locally as cache
          if (isSupabaseReady()) {
            await refreshPresence().catch(() => { });
          }
          setSupabaseStatusBanner('');
          updateReadOnlyUI();
          await maybeShowPendingAnnouncement().catch(err => console.warn('Announcement check failed', err));
          return;
        } catch (e) {
          console.error('Failed to load from Supabase, falling back to local', e);
          if (isNetworkLoadFailure(e)) {
            registerSupabaseNetworkIssue('Cannot reach Supabase right now (network/CORS). Using local data until connection recovers.');
          } else {
            setSupabaseStatusBanner('Supabase connection issue or maintenance detected. Some actions may be temporarily unavailable.');
          }
          state = loadState(); // keep local data instead of wiping to defaults
          updateReadOnlyUI();
          return;
        }
      }
      if (supabaseAvailable) {
        setSupabaseStatusBanner('Supabase connection not ready. Edits that require syncing are temporarily disabled.');
      }
      state = loadState();
      updateReadOnlyUI();
    }

    function setSupabaseStatusBanner(message) {
      const banner = document.getElementById('supabaseStatusBanner');
      if (!banner) return;
      if (message) {
        banner.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <span>${esc(message)}</span>
            <button id="supabaseRetryBtn" class="px-2 py-1 rounded-lg border border-amber-300 text-amber-900 text-[10px] hover:bg-amber-100">
              Force refresh
            </button>
          </div>
        `;
        banner.classList.remove('hidden');
        const retryBtn = document.getElementById('supabaseRetryBtn');
        if (retryBtn) {
          retryBtn.onclick = async () => {
            await tryLoadRemoteThenLocal();
            renderAllViews();
          };
        }
      } else {
        banner.textContent = '';
        banner.classList.add('hidden');
      }
    }

    const contractWatchTimers = new Map();
    function startContractStatusWatch(studentIds = [], opts = {}) {
      if (!supabaseAvailable) return;
      const ids = [...new Set((studentIds || []).map(cleanId).filter(Boolean))];
      if (!ids.length) return;
      const key = ids.join('|');
      if (contractWatchTimers.has(key)) return;
      const maxMs = Number(opts.maxMs || 120000);
      const intervalMs = Number(opts.intervalMs || 10000);
      const startedAt = Date.now();

      const stop = () => {
        const timer = contractWatchTimers.get(key);
        if (timer) clearInterval(timer);
        contractWatchTimers.delete(key);
      };

      const tick = async () => {
        try {
          await tryLoadRemoteThenLocal();
          renderAllViews();
          const allSigned = ids.every(id => {
            const stu = getStudentById(id);
            return stu && (stu.contractSigned || getLatestSignature(id) || state.contracts.some(c => c.studentId === id && c.status === 'Signed'));
          });
          if (allSigned || Date.now() - startedAt > maxMs) {
            stop();
          }
        } catch (err) {
          console.warn('Contract status refresh failed', err);
          if (Date.now() - startedAt > maxMs) stop();
        }
      };

      tick();
      const timer = setInterval(tick, intervalMs);
      contractWatchTimers.set(key, timer);
    }

    async function loadStateFromSupabase() {
      const uid = supabaseSession?.user?.id;
      const email = getSessionEmail();
      if (!uid) return supabaseAvailable ? deepClone(defaultState) : loadState();
      const isOwnerUser = isOwner();

      // Owner: load everything (existing behaviour)
      if (isOwnerUser) {
        const fetchTable = (table, cols = '*') => supabaseClient.from(table).select(cols);
        const fetchRecentActivity = () => supabaseClient
          .from('activity_log')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(500);
        const [
          studentsRes,
          parentsRes,
          parentLinksRes,
          sessionsRes,
          sessionStudentsRes,
          cancellationsRes,
          busyDaysRes,
          ownerSettingsRes,
          resourcesRes,
          homeworkRes,
          documentsRes,
          contractsRes,
          invoicesRes,
          todosRes,
          checkinsRes,
          activityRes,
          messagesRes,
          contractSignaturesRes
        ] = await Promise.all([
          fetchTable('students'),
          fetchTable('parents'),
          fetchTable('parent_students'),
          fetchTable('lesson_sessions'),
          fetchTable('session_students'),
          fetchTable('session_cancellations'),
          fetchTable('busy_days'),
          fetchTable('owner_settings'),
          fetchTable('resources'),
          fetchTable('homework'),
          fetchTable('documents'),
          fetchTable('contracts'),
          fetchTable('invoices'),
          fetchTable('student_todos'),
          fetchTable('student_checkins'),
          fetchRecentActivity(),
          fetchTable('messages'),
          fetchTable('parent_contract_signatures')
        ]);

        [studentsRes, parentsRes, parentLinksRes, sessionsRes, sessionStudentsRes, busyDaysRes, ownerSettingsRes, resourcesRes, homeworkRes, documentsRes, contractsRes, invoicesRes, todosRes, checkinsRes, activityRes, messagesRes, contractSignaturesRes].forEach(res => {
          if (res.error) throw res.error;
        });
        if (cancellationsRes?.error) {
          console.warn('Session cancellations fetch failed', cancellationsRes.error);
        }

        const sessions = (sessionsRes.data || []).map(sess => {
          const studentIds = (sessionStudentsRes.data || [])
            .filter(ss => ss.session_id === sess.id)
            .map(ss => cleanId(ss.student_id))
            .filter(Boolean);
          return {
            id: sess.id,
            date: sess.date,
            startTime: normalizeTimeValue(sess.start_time),
            durationHours: sess.duration_hours,
            subject: sess.subject,
            topic: sess.topic,
            notes: sess.notes,
            attended: !!sess.attended,
            completed: sess.completed,
            status: sess.status || '',
            absenceReason: sess.absence_reason || '',
            pendingReviewStartedAt: sess.pending_review_started_at || '',
            billingRate: sess.billing_rate ?? null,
            invoiceId: sess.invoice_id,
            studentIds,
            sessionMode: normalizeSessionMode(sess.session_mode),
            meetingRoom: sess.meeting_room || '',
            meetingProvider: sess.meeting_provider || '',
            meetingStatus: sess.meeting_status || '',
            meetingStartedAt: sess.meeting_started_at || '',
            meetingEndedAt: sess.meeting_ended_at || ''
          };
        });
        const sessionsWithStudents = sessions.filter(s => (s.studentIds || []).length > 0);

        const contracts = await Promise.all(
          (contractsRes.data || []).map(async c => {
            return {
              id: c.id,
              studentId: c.student_id,
              fileName: c.file_name,
              storage_path: c.storage_path,
              status: c.status,
              notes: c.notes,
              uploadedAt: c.uploaded_at,
              signedUrl: ''
            };
          })
        );

        const merged = deepClone(defaultState);
        merged.students = (studentsRes.data || []).map(s => ({
          id: s.id,
          name: s.name,
          gradeLevel: s.grade_level ?? s.gradeLevel,
          rate: s.rate,
          subjects: s.subjects,
          notes: s.notes,
          studentEmail: s.student_email || '',
          createdAt: s.created_at,
          contractSigned: s.contract_signed,
          contractSignedAt: s.contract_signed_at,
          contractVersion: s.contract_version || 'v1',
          contractSignerName: s.contract_signer_name,
          contractSignerEmail: s.contract_signer_email,
          lastContractId: s.last_contract_id,
          loginCode: normalizeCode(s.login_code),
          authUserId: cleanId(s.auth_user_id || ''),
          scheduleSlots: normalizeScheduleSlots(s.schedule_slots || [], s.schedule_timezone || DEFAULT_TIMEZONE),
          scheduleDays: normalizeScheduleDays(s.schedule_days || []),
          preferredTime: normalizeTimeValue(s.preferred_time || ''),
          scheduleTimezone: s.schedule_timezone || DEFAULT_TIMEZONE,
          scheduleStartDate: s.schedule_start_date || '',
          sessionLengthHours: s.session_length_hours || null,
          scheduleNotes: s.schedule_notes || ''
        }));
        merged.parents = (parentsRes?.data || []).map(p => ({
          id: p.id,
          email: (p.email || '').toLowerCase(),
          name: p.name,
          phone: p.phone,
          notes: p.notes,
          verified: p.verified,
          loginCode: normalizeCode(p.login_code),
          authUserId: cleanId(p.auth_user_id || ''),
          emailNotificationsOptIn: !!p.email_notifications_opt_in,
          emailNotificationsOptInAt: p.email_notifications_opt_in_at || ''
        }));
        merged.parentLinks = (parentLinksRes?.data || []).map(pl => ({
          id: pl.id,
          parentId: pl.parent_id,
          studentId: pl.student_id,
          relationship: pl.relationship
        }));
        merged.sessions = sessionsWithStudents;
        merged.sessionCancellations = (cancellationsRes?.data || []).map(c => ({
          id: c.id,
          studentId: c.student_id,
          date: c.session_date,
          startTime: normalizeTimeValue(c.start_time || ''),
          durationHours: c.duration_hours || null,
          sessionId: c.session_id || '',
          invoiceId: c.invoice_id || '',
          reason: c.reason || '',
          cancelledAt: c.cancelled_at || ''
        }));
        merged.busyDays = (busyDaysRes?.data || []).map(b => ({
          id: b.id,
          date: b.date,
          note: b.note || '',
          createdAt: b.created_at || ''
        }));
        const resources = await Promise.all(
          (resourcesRes.data || []).map(async r => {
            let signedUrl = '';
            try {
              if (r.storage_path && supabaseClient.storage) {
                const { data, error } = await supabaseClient.storage.from('resources').createSignedUrl(r.storage_path, 60 * 60);
                if (!error && data?.signedUrl) signedUrl = data.signedUrl;
              }
            } catch (err) {
              console.warn('Resource signed URL fetch failed', err);
            }
            return {
              id: r.id,
              title: r.title,
              subject: r.subject,
              level: r.level,
              tags: r.tags,
              description: r.description,
              resourceType: r.resource_type || '',
              estimatedMinutes: r.estimated_minutes || null,
              linkUrl: r.link_url || '',
              createdAt: r.created_at,
              favorite: r.favorite,
              storage_path: r.storage_path,
              fileName: r.file_name,
              signedUrl
            };
          })
        );
        merged.resources = resources;
        merged.homework = (homeworkRes.data || []).map(h => ({
          id: h.id,
          studentId: h.student_id,
          resourceId: h.resource_id,
          status: h.status,
          dueDate: h.due_date,
          assignedDate: h.assigned_date
        }));
        merged.documents = (documentsRes.data || []).map(d => ({
          id: d.id,
          studentId: d.student_id,
          title: d.title,
          status: d.status,
          date: d.date,
          notes: d.notes,
          createdAt: d.created_at
        }));
        merged.contracts = contracts;
        merged.invoices = (invoicesRes.data || []).map(inv => ({
          id: inv.id,
          studentId: inv.student_id,
          issueDate: inv.issue_date,
          dueDate: inv.due_date,
          baseAmount: inv.base_amount,
          total: inv.total,
          lateFeePercent: inv.late_fee_percent,
          shortNoticePercent: inv.short_notice_percent,
          lateApplied: inv.late_applied,
          shortApplied: inv.short_applied,
          paid: inv.paid,
          notes: inv.notes,
          servicePeriodStart: inv.service_period_start,
          servicePeriodEnd: inv.service_period_end,
          numSessions: inv.num_sessions,
          invoiceType: inv.invoice_type || 'manual',
          autoGenerated: !!inv.auto_generated,
          paidAt: inv.paid_at,
          paymentProvider: inv.payment_provider || '',
          paymentProviderId: inv.payment_provider_id || '',
          paymentMethod: inv.payment_method || '',
          amountReceived: inv.amount_received || null,
          amountRefunded: inv.amount_refunded || null,
          refundStatus: inv.refund_status || '',
          refundLastAt: inv.refund_last_at || '',
          invoiceStatus: inv.invoice_status || (inv.paid ? 'paid' : 'issued'),
          voidedAt: inv.voided_at || '',
          adjustmentReason: inv.adjustment_reason || '',
          relatedSessionId: inv.related_session_id || '',
          moveToDate: inv.move_to_date || '',
          moveToTime: normalizeTimeValue(inv.move_to_time || ''),
          moveToDurationHours: inv.move_to_duration_hours || null,
          moveRequestedAt: inv.move_requested_at || '',
          moveAppliedAt: inv.move_applied_at || ''
        }));
        merged.studentTodos = (todosRes.data || []).map(t => ({
          id: t.id,
          studentId: t.student_id,
          text: t.text,
          dueDate: t.due_date,
          done: t.done,
          createdAt: t.created_at
        }));
        merged.studentCheckins = (checkinsRes.data || []).map(c => ({
          id: c.id,
          studentId: c.student_id,
          text: c.text,
          date: c.date,
          createdAt: c.created_at
        }));
        merged.messages = (messagesRes?.data || []).map(m => ({
          id: m.id,
          studentId: m.student_id,
          text: m.text,
          sender: m.sender,
          created_at: m.created_at
        }));
        merged.activityLog = (activityRes?.data || []).map(a => ({
          id: a.id,
          action: a.action,
          detail: a.detail,
          created_at: a.created_at
        })).reverse();
        merged.settings = loadState().settings; // keep local settings
        const ownerSettings = (ownerSettingsRes?.data || [])[0];
        if (ownerSettings) {
          applyOwnerMaintenanceSettings(merged.settings, ownerSettings);
        }

        // Merge in any local resources not yet in Supabase so they don't disappear on reload/switch
        const localState = loadState();
        if (localState?.resources?.length) {
          const remoteIds = new Set(merged.resources.map(r => cleanId(r.id)));
          localState.resources.forEach(r => {
            const id = cleanId(r.id);
            if (!remoteIds.has(id)) {
              merged.resources.push({
                id,
                title: r.title,
                subject: r.subject,
                level: r.level,
                tags: r.tags,
                description: r.description,
                resourceType: r.resourceType || '',
                estimatedMinutes: r.estimatedMinutes || null,
                linkUrl: r.linkUrl || '',
                createdAt: r.createdAt,
                favorite: r.favorite,
                storage_path: r.storage_path,
                fileName: r.fileName,
                signedUrl: r.signedUrl,
                dataUrl: r.dataUrl
              });
            }
          });
        }
        // Merge local homework if missing remotely (e.g., if an upsert failed due to RLS)
        if (localState?.homework?.length) {
          const remoteIds = new Set(merged.homework.map(h => cleanId(h.id)));
          localState.homework.forEach(hw => {
            const id = cleanId(hw.id);
            if (!remoteIds.has(id)) merged.homework.push(hw);
          });
        }
        // Merge local invoices/messages if rows are missing (e.g., legacy rows without user_id)
        if (localState?.invoices?.length) {
          const remoteIds = new Set(merged.invoices.map(i => cleanId(i.id)));
          localState.invoices.forEach(inv => {
            const id = cleanId(inv.id);
            if (!remoteIds.has(id)) merged.invoices.push(inv);
          });
        }
        if (localState?.sessionCancellations?.length) {
          const remoteIds = new Set(merged.sessionCancellations.map(c => cleanId(c.id)));
          localState.sessionCancellations.forEach(c => {
            const id = cleanId(c.id);
            if (!remoteIds.has(id)) merged.sessionCancellations.push(c);
          });
        }
        if (localState?.messages?.length) {
          const remoteIds = new Set(merged.messages.map(m => cleanId(m.id)));
          localState.messages.forEach(msg => {
            const id = cleanId(msg.id);
            if (!remoteIds.has(id)) merged.messages.push(msg);
          });
        }

        sanitizeState(merged);
        normalizeIdsToUuid();
        return merged;
      }

      // Student / parent: load only allowed rows; ignore tables that RLS blocks
      const merged = deepClone(defaultState);
      const localSettings = loadState().settings;
      merged.settings = localSettings;

      const sessionRole = getSessionRole();
      const sessionStudentId = getSessionStudentId();
      const sessionParentId = getSessionParentId();
      const sessionLoginCode = getSessionLoginCode();
      const localFallbackState = loadState();

      function buildRoleScopedLocalFallback() {
        const local = deepClone(localFallbackState || defaultState);
        const out = deepClone(defaultState);
        out.settings = deepClone(localSettings || defaultState.settings);

        const filterStudentScoped = (studentIds) => {
          const idSet = new Set((studentIds || []).map(cleanId).filter(Boolean));
          if (!idSet.size) return out;
          out.students = (local.students || []).filter(s => idSet.has(cleanId(s.id)));
          out.parentLinks = (local.parentLinks || []).filter(pl => idSet.has(cleanId(pl.studentId || pl.student_id)));
          const parentIdSet = new Set(out.parentLinks.map(pl => cleanId(pl.parentId || pl.parent_id)));
          out.parents = (local.parents || []).filter(p => parentIdSet.has(cleanId(p.id)));
          out.sessions = (local.sessions || []).filter(sess => (sess.studentIds || []).some(id => idSet.has(cleanId(id))));
          out.sessionCancellations = (local.sessionCancellations || []).filter(c => idSet.has(cleanId(c.studentId || c.student_id)));
          out.homework = (local.homework || []).filter(h => idSet.has(cleanId(h.studentId || h.student_id)));
          out.documents = (local.documents || []).filter(d => idSet.has(cleanId(d.studentId || d.student_id)));
          out.contracts = (local.contracts || []).filter(c => idSet.has(cleanId(c.studentId || c.student_id)));
          out.invoices = (local.invoices || []).filter(inv => idSet.has(cleanId(inv.studentId || inv.student_id)));
          out.studentTodos = (local.studentTodos || []).filter(td => idSet.has(cleanId(td.studentId || td.student_id)));
          out.studentCheckins = (local.studentCheckins || []).filter(ch => idSet.has(cleanId(ch.studentId || ch.student_id)));
          out.messages = (local.messages || []).filter(m => idSet.has(cleanId(m.studentId || m.student_id)));
          out.contractSignatures = (local.contractSignatures || []).filter(cs => idSet.has(cleanId(cs.studentId || cs.student_id)));
          const resIds = new Set(out.homework.map(h => cleanId(h.resourceId || h.resource_id)).filter(Boolean));
          out.resources = (local.resources || []).filter(r => resIds.has(cleanId(r.id)));
          sanitizeState(out);
          return out;
        };

        if (sessionRole === 'student' || sessionStudentId || sessionLoginCode) {
          const sid = cleanId(sessionStudentId);
          let student = sid ? (local.students || []).find(s => cleanId(s.id) === sid) : null;
          if (!student && sessionLoginCode) {
            const code = normalizeCode(sessionLoginCode);
            student = (local.students || []).find(s => normalizeCode(s.loginCode || s.login_code || '') === code) || null;
          }
          if (student) return filterStudentScoped([student.id]);
        }

        if (sessionRole === 'parent' || sessionParentId || sessionLoginCode) {
          const pid = cleanId(sessionParentId);
          let parent = pid ? (local.parents || []).find(p => cleanId(p.id) === pid) : null;
          if (!parent && sessionLoginCode) {
            const code = normalizeCode(sessionLoginCode);
            parent = (local.parents || []).find(p => normalizeCode(p.loginCode || p.login_code || '') === code) || null;
          }
          if (parent) {
            const linked = (local.parentLinks || [])
              .filter(pl => cleanId(pl.parentId || pl.parent_id) === cleanId(parent.id))
              .map(pl => cleanId(pl.studentId || pl.student_id))
              .filter(Boolean);
            const filtered = filterStudentScoped(linked);
            filtered.parents = [parent];
            filtered.parentLinks = (local.parentLinks || []).filter(pl => cleanId(pl.parentId || pl.parent_id) === cleanId(parent.id));
            sanitizeState(filtered);
            return filtered;
          }
        }

        const authUid = cleanId(supabaseSession?.user?.id || '');
        if (authUid) {
          const byStudentAuth = (local.students || []).find(s => cleanId(s.authUserId || s.auth_user_id || '') === authUid);
          if (byStudentAuth) return filterStudentScoped([byStudentAuth.id]);

          const byParentAuth = (local.parents || []).find(p => cleanId(p.authUserId || p.auth_user_id || '') === authUid);
          if (byParentAuth) {
            const linked = (local.parentLinks || [])
              .filter(pl => cleanId(pl.parentId || pl.parent_id) === cleanId(byParentAuth.id))
              .map(pl => cleanId(pl.studentId || pl.student_id))
              .filter(Boolean);
            const filtered = filterStudentScoped(linked);
            filtered.parents = [byParentAuth];
            filtered.parentLinks = (local.parentLinks || []).filter(pl => cleanId(pl.parentId || pl.parent_id) === cleanId(byParentAuth.id));
            sanitizeState(filtered);
            return filtered;
          }
        }

        return out;
      }

      async function mapSnapshotToState(snapshot) {
        const snap = snapshot || {};
        const out = deepClone(defaultState);
        out.settings = localSettings;
        const ownerSettings = snap.ownerSettings || snap.owner_settings;
        if (ownerSettings) {
          applyOwnerMaintenanceSettings(out.settings, ownerSettings);
        }
        out.students = (snap.students || []).map(s => ({
          id: s.id,
          name: s.name,
          gradeLevel: s.grade_level ?? s.gradeLevel,
          rate: s.rate,
          subjects: s.subjects,
          notes: s.notes,
          studentEmail: s.student_email || '',
          createdAt: s.created_at,
          contractSigned: s.contract_signed,
          contractSignedAt: s.contract_signed_at,
          contractVersion: s.contract_version || 'v1',
          contractSignerName: s.contract_signer_name,
          contractSignerEmail: s.contract_signer_email,
          lastContractId: s.last_contract_id,
          loginCode: normalizeCode(s.login_code),
          authUserId: cleanId(s.auth_user_id || ''),
          scheduleSlots: normalizeScheduleSlots(s.schedule_slots || [], s.schedule_timezone || DEFAULT_TIMEZONE),
          scheduleDays: normalizeScheduleDays(s.schedule_days || []),
          preferredTime: normalizeTimeValue(s.preferred_time || ''),
          scheduleTimezone: s.schedule_timezone || DEFAULT_TIMEZONE,
          scheduleStartDate: s.schedule_start_date || '',
          sessionLengthHours: s.session_length_hours || null,
          scheduleNotes: s.schedule_notes || ''
        }));
        out.parents = (snap.parents || []).map(p => ({
          id: p.id,
          email: (p.email || '').toLowerCase(),
          name: p.name,
          phone: p.phone,
          notes: p.notes,
          verified: p.verified,
          loginCode: normalizeCode(p.login_code),
          authUserId: cleanId(p.auth_user_id || ''),
          emailNotificationsOptIn: !!p.email_notifications_opt_in,
          emailNotificationsOptInAt: p.email_notifications_opt_in_at || ''
        }));
        out.parentLinks = (snap.parentLinks || []).map(pl => ({
          id: pl.id,
          parentId: pl.parent_id,
          studentId: pl.student_id,
          relationship: pl.relationship
        }));
        out.busyDays = (snap.busyDays || []).map(b => ({
          id: b.id,
          date: b.date,
          note: b.note || '',
          createdAt: b.created_at || b.createdAt || ''
        }));
        out.sessions = (snap.sessions || []).map(sess => ({
          id: sess.id,
          date: sess.date,
          startTime: normalizeTimeValue(sess.start_time),
          durationHours: sess.duration_hours,
          subject: sess.subject,
          topic: sess.topic,
          notes: sess.notes,
          attended: !!sess.attended,
          completed: sess.completed,
          status: sess.status || '',
          absenceReason: sess.absence_reason || '',
          pendingReviewStartedAt: sess.pending_review_started_at || '',
          billingRate: sess.billing_rate ?? null,
          invoiceId: sess.invoice_id,
          sessionMode: normalizeSessionMode(sess.session_mode),
          meetingRoom: sess.meeting_room || '',
          meetingProvider: sess.meeting_provider || '',
          meetingStatus: sess.meeting_status || '',
          meetingStartedAt: sess.meeting_started_at || '',
          meetingEndedAt: sess.meeting_ended_at || '',
          studentIds: (snap.sessionStudents || [])
            .filter(ss => ss.session_id === sess.id)
            .map(ss => cleanId(ss.student_id))
            .filter(Boolean)
        })).filter(s => (s.studentIds || []).length > 0);
        out.homework = (snap.homework || []).map(h => ({
          id: h.id,
          studentId: h.student_id,
          resourceId: h.resource_id,
          status: h.status,
          dueDate: h.due_date,
          assignedDate: h.assigned_date
        }));
        out.resources = (snap.resources || []).map(r => ({
          id: r.id,
          title: r.title,
          subject: r.subject,
          level: r.level,
          tags: r.tags,
          description: r.description,
          resourceType: r.resource_type || '',
          estimatedMinutes: r.estimated_minutes || null,
          linkUrl: r.link_url || '',
          createdAt: r.created_at,
          favorite: r.favorite,
          storage_path: r.storage_path,
          fileName: r.file_name,
          signedUrl: r.signed_url || r.signedUrl || ''
        }));
        out.invoices = (snap.invoices || []).map(inv => ({
          id: inv.id,
          studentId: inv.student_id,
          issueDate: inv.issue_date,
          dueDate: inv.due_date,
          baseAmount: inv.base_amount,
          total: inv.total,
          lateFeePercent: inv.late_fee_percent,
          shortNoticePercent: inv.short_notice_percent,
          lateApplied: inv.late_applied,
          shortApplied: inv.short_applied,
          paid: inv.paid,
          notes: inv.notes,
          servicePeriodStart: inv.service_period_start,
          servicePeriodEnd: inv.service_period_end,
          numSessions: inv.num_sessions,
          invoiceType: inv.invoice_type || 'manual',
          autoGenerated: !!inv.auto_generated,
          paidAt: inv.paid_at,
          paymentProvider: inv.payment_provider || '',
          paymentProviderId: inv.payment_provider_id || '',
          paymentMethod: inv.payment_method || '',
          amountReceived: inv.amount_received || null,
          amountRefunded: inv.amount_refunded || null,
          refundStatus: inv.refund_status || '',
          refundLastAt: inv.refund_last_at || '',
          invoiceStatus: inv.invoice_status || (inv.paid ? 'paid' : 'issued'),
          voidedAt: inv.voided_at || '',
          adjustmentReason: inv.adjustment_reason || '',
          relatedSessionId: inv.related_session_id || '',
          moveToDate: inv.move_to_date || '',
          moveToTime: normalizeTimeValue(inv.move_to_time || ''),
          moveToDurationHours: inv.move_to_duration_hours || null,
          moveRequestedAt: inv.move_requested_at || '',
          moveAppliedAt: inv.move_applied_at || ''
        }));
        out.contractSignatures = (snap.contractSignatures || []).map(cs => ({
          id: cs.id,
          studentId: cs.student_id,
          parentName: cs.parent_name,
          parentEmail: cs.parent_email,
          signedAt: cs.signed_at,
          contractVersion: cs.contract_version || 'v1',
          contractTextSnapshot: cs.contract_text_snapshot,
          renderedPdfUrl: cs.rendered_pdf_url,
          signatureMethod: cs.signature_method,
          parentIp: cs.parent_ip
        }));
        out.contracts = (snap.contracts || []).map(c => ({
          id: c.id,
          studentId: c.student_id,
          fileName: c.file_name,
          storage_path: c.storage_path,
          status: c.status,
          notes: c.notes,
          uploadedAt: c.uploaded_at,
          signedUrl: ''
        }));
        out.messages = (snap.messages || []).map(m => ({
          id: m.id,
          studentId: m.student_id,
          text: m.text,
          sender: m.sender,
          created_at: m.created_at
        }));
        out.documents = (snap.documents || []).map(d => ({
          id: d.id,
          studentId: d.student_id,
          title: d.title,
          status: d.status,
          date: d.date,
          notes: d.notes,
          createdAt: d.created_at
        }));
        sanitizeState(out);
        normalizeIdsToUuid();
        return out;
      }

      const shouldUseSnapshot = !isOwnerUser;
      if (shouldUseSnapshot) {
        try {
          const accessToken = supabaseSession?.access_token;
          if (!accessToken) {
            console.warn('Portal snapshot requires sign-in.');
            return merged;
          }
          const body = {};
          if (sessionLoginCode) body.code = sessionLoginCode;
          if (sessionRole) body.role = sessionRole;
          const { data: snapshot, error: snapErr } = await supabaseClient.functions.invoke('portal-snapshot', {
            body,
            headers: { Authorization: `Bearer ${accessToken}` }
          });
          if (snapErr) throw snapErr;
          if (snapshot) {
            return await mapSnapshotToState(snapshot);
          }
        } catch (err) {
          const ctx = err?.context || {};
          let details = ctx?.error || ctx?.message || '';
          if (!details && ctx?.body) {
            try {
              const parsed = typeof ctx.body === 'string' ? JSON.parse(ctx.body) : ctx.body;
              details = parsed?.error || parsed?.code || '';
            } catch { }
          }
          if (!details) {
            const resp = (typeof Response !== 'undefined' && ctx instanceof Response)
              ? ctx
              : (typeof Response !== 'undefined' && err?.response instanceof Response ? err.response : null);
            if (resp) {
              try {
                const raw = await resp.clone().text();
                if (raw) {
                  try {
                    const parsed = JSON.parse(raw);
                    details = parsed?.code || parsed?.error || raw;
                  } catch {
                    details = raw;
                  }
                }
              } catch { }
            }
          }
          console.warn('Portal snapshot fetch failed; snapshot is required for this role.', details || err?.message || err);
        }
        const fallback = buildRoleScopedLocalFallback();
        const hasCachedData = (fallback.students?.length || 0) > 0 ||
          (fallback.parents?.length || 0) > 0 ||
          (fallback.sessions?.length || 0) > 0 ||
          (fallback.invoices?.length || 0) > 0 ||
          (fallback.homework?.length || 0) > 0;
        if (hasCachedData) {
          console.warn('Using local cached portal state after snapshot failure');
          return fallback;
        }
        console.warn('No cached portal data available; attempting direct scoped table queries.');
      }

      let studentsRes = { data: [] };
      let parentsRes = { data: [] };
      let parentLinksRes = { data: [] };
      let parentLinksAltRes = { data: [] };
      let sessionStudentsRes = { data: [] };
      let sessionsRes = { data: [] };
      let homeworkRes = { data: [] };
      let resourcesRes = { data: [] };
      let invoicesRes = { data: [] };
      let messagesRes = { data: [] };
      let contractSignaturesRes = { data: [] };
      let contractsRes = { data: [] };

      try {
        if (sessionRole === 'student' && sessionStudentId) {
          studentsRes = await supabaseClient.from('students').select('*').eq('id', sessionStudentId);
        } else if (sessionLoginCode) {
          studentsRes = await supabaseClient.from('students').select('*').eq('login_code', sessionLoginCode);
        } else if (uid) {
          studentsRes = await supabaseClient.from('students').select('*').eq('auth_user_id', uid);
        } else {
          studentsRes = await supabaseClient.from('students').select('*').ilike('student_email', email);
        }
      } catch { }
      if (!(studentsRes.data || []).length && uid) {
        try {
          studentsRes = await supabaseClient.from('students').select('*').eq('auth_user_id', uid);
        } catch { }
      }
      if (!(studentsRes.data || []).length && email) {
        try {
          studentsRes = await supabaseClient.from('students').select('*').ilike('student_email', email);
        } catch { }
      }
      try {
        if (sessionRole === 'parent' && sessionParentId) {
          parentsRes = await supabaseClient.from('parents').select('*').eq('id', sessionParentId);
        } else if (sessionLoginCode) {
          parentsRes = await supabaseClient.from('parents').select('*').eq('login_code', sessionLoginCode);
        } else if (uid) {
          parentsRes = await supabaseClient.from('parents').select('*').eq('auth_user_id', uid);
        } else if (email) {
          parentsRes = await supabaseClient.from('parents').select('*').ilike('email', email);
        }
      } catch { }
      if (!(parentsRes.data || []).length && uid) {
        try {
          parentsRes = await supabaseClient.from('parents').select('*').eq('auth_user_id', uid);
        } catch { }
      }
      if (!(parentsRes.data || []).length && email) {
        try {
          parentsRes = await supabaseClient.from('parents').select('*').ilike('email', email);
        } catch { }
      }

      let parentIds = (parentsRes.data || []).map(p => p.id);
      if (!parentIds.length && sessionRole === 'parent' && sessionParentId) {
        parentIds = [sessionParentId];
      }
      if (parentIds.length) {
        try {
          parentLinksRes = await supabaseClient.from('parent_students').select('*').in('parent_id', parentIds);
        } catch { }
        try {
          parentLinksAltRes = await supabaseClient.from('parent_student_links').select('*').in('parent_id', parentIds);
        } catch { }
      }

      const parentLinksRaw = [
        ...(parentLinksRes.data || []),
        ...(parentLinksAltRes.data || [])
      ];
      const parentLinksData = Array.from(new Map(
        parentLinksRaw.map(pl => {
          const key = `${cleanId(pl.parent_id)}|${cleanId(pl.student_id)}|${String(pl.relationship || '')}`;
          return [key, pl];
        })
      ).values());

      const studentIds = new Set([
        ...(studentsRes.data || []).map(s => s.id),
        ...parentLinksData.map(pl => pl.student_id)
      ]);
      if (sessionRole === 'student' && sessionStudentId) studentIds.add(sessionStudentId);
      const studentIdArray = Array.from(studentIds);

      // If this is a parent with linked students, fetch those student rows
      if (studentIdArray.length && !(studentsRes.data || []).length) {
        try {
          studentsRes = await supabaseClient.from('students').select('*').in('id', studentIdArray);
        } catch { }
      }

      if (studentIdArray.length) {
        try {
          sessionStudentsRes = await supabaseClient.from('session_students').select('*').in('student_id', studentIdArray);
        } catch { }
        const sessionIds = Array.from(new Set((sessionStudentsRes.data || []).map(ss => ss.session_id)));
        if (sessionIds.length) {
          try {
            sessionsRes = await supabaseClient.from('lesson_sessions').select('*').in('id', sessionIds);
          } catch { }
        }
        try {
          homeworkRes = await supabaseClient.from('homework').select('*').in('student_id', studentIdArray);
        } catch { }
        try {
          invoicesRes = await supabaseClient.from('invoices').select('*').in('student_id', studentIdArray);
        } catch { }
        try {
          messagesRes = await supabaseClient.from('messages').select('*').in('student_id', studentIdArray);
        } catch { }
        try {
          contractSignaturesRes = await supabaseClient.from('parent_contract_signatures').select('*').in('student_id', studentIdArray);
        } catch { }
        try {
          contractsRes = await supabaseClient.from('contracts').select('*').in('student_id', studentIdArray);
        } catch { }
      }

      // Resources tied to homework
      const resourceIds = Array.from(new Set((homeworkRes.data || []).map(h => h.resource_id).filter(Boolean)));
      if (resourceIds.length) {
        try {
          resourcesRes = await supabaseClient.from('resources').select('*').in('id', resourceIds);
        } catch { }
      }

      let busyDaysRes = { data: [] };
      let ownerSettingsRes = { data: [] };
      const ownerIds = new Set();
      (studentsRes.data || []).forEach(s => {
        if (s.user_id) ownerIds.add(s.user_id);
      });
      (parentsRes.data || []).forEach(p => {
        if (p.user_id) ownerIds.add(p.user_id);
      });
      if (ownerIds.size) {
        try {
          busyDaysRes = await supabaseClient.from('busy_days').select('*').in('user_id', Array.from(ownerIds));
        } catch { }
        try {
          ownerSettingsRes = await supabaseClient
            .from('owner_settings')
            .select('*')
            .in('user_id', Array.from(ownerIds))
            .order('updated_at', { ascending: false })
            .limit(1);
        } catch { }
      }

      // Map into state
      merged.students = (studentsRes.data || []).map(s => ({
        id: s.id,
        name: s.name,
        gradeLevel: s.grade_level ?? s.gradeLevel,
        rate: s.rate,
        subjects: s.subjects,
        notes: s.notes,
        studentEmail: s.student_email || '',
        createdAt: s.created_at,
        contractSigned: s.contract_signed,
        contractSignedAt: s.contract_signed_at,
        contractVersion: s.contract_version || 'v1',
        contractSignerName: s.contract_signer_name,
        contractSignerEmail: s.contract_signer_email,
        lastContractId: s.last_contract_id,
        loginCode: normalizeCode(s.login_code),
        authUserId: cleanId(s.auth_user_id || ''),
        scheduleSlots: normalizeScheduleSlots(s.schedule_slots || [], s.schedule_timezone || DEFAULT_TIMEZONE),
        scheduleDays: normalizeScheduleDays(s.schedule_days || []),
        preferredTime: normalizeTimeValue(s.preferred_time || ''),
        scheduleTimezone: s.schedule_timezone || DEFAULT_TIMEZONE,
        scheduleStartDate: s.schedule_start_date || '',
        sessionLengthHours: s.session_length_hours || null,
        scheduleNotes: s.schedule_notes || ''
      }));
      merged.parents = (parentsRes.data || []).map(p => ({
        id: p.id,
        email: (p.email || '').toLowerCase(),
        name: p.name,
        phone: p.phone,
        notes: p.notes,
        verified: p.verified,
        loginCode: normalizeCode(p.login_code),
        authUserId: cleanId(p.auth_user_id || ''),
        emailNotificationsOptIn: !!p.email_notifications_opt_in,
        emailNotificationsOptInAt: p.email_notifications_opt_in_at || ''
      }));
      merged.parentLinks = parentLinksData.map(pl => ({
        id: pl.id,
        parentId: pl.parent_id,
        studentId: pl.student_id,
        relationship: pl.relationship
      }));
      merged.busyDays = (busyDaysRes.data || []).map(b => ({
        id: b.id,
        date: b.date,
        note: b.note || '',
        createdAt: b.created_at || ''
      }));
      const ownerSettings = (ownerSettingsRes.data || [])[0];
      if (ownerSettings) {
        applyOwnerMaintenanceSettings(merged.settings, ownerSettings);
      }

      const sessions = (sessionsRes.data || []).map(sess => {
        const studentIdsForSess = (sessionStudentsRes.data || [])
          .filter(ss => ss.session_id === sess.id)
          .map(ss => cleanId(ss.student_id))
          .filter(Boolean);
        return {
          id: sess.id,
          date: sess.date,
          startTime: normalizeTimeValue(sess.start_time),
          durationHours: sess.duration_hours,
          subject: sess.subject,
          topic: sess.topic,
          notes: sess.notes,
          attended: !!sess.attended,
          completed: sess.completed,
          status: sess.status || '',
          absenceReason: sess.absence_reason || '',
          pendingReviewStartedAt: sess.pending_review_started_at || '',
          billingRate: sess.billing_rate ?? null,
          invoiceId: sess.invoice_id,
          studentIds: studentIdsForSess
        };
      });
      merged.sessions = sessions.filter(s => (s.studentIds || []).length > 0);

      merged.homework = (homeworkRes.data || []).map(h => ({
        id: h.id,
        studentId: h.student_id,
        resourceId: h.resource_id,
        status: h.status,
        dueDate: h.due_date,
        assignedDate: h.assigned_date
      }));

      merged.resources = await Promise.all(
        (resourcesRes.data || []).map(async r => {
          let signedUrl = r.signed_url || '';
          if (!signedUrl && r.storage_path && supabaseClient.storage) {
            try {
              const { data, error } = await supabaseClient.storage.from('resources').createSignedUrl(r.storage_path, 60 * 60);
              if (!error && data?.signedUrl) signedUrl = data.signedUrl;
            } catch (err) {
              console.warn('Student/parent resource signed URL fetch failed', err);
            }
          }
            return {
              id: r.id,
              title: r.title,
              subject: r.subject,
              level: r.level,
              tags: r.tags,
              description: r.description,
              resourceType: r.resource_type || '',
              estimatedMinutes: r.estimated_minutes || null,
              linkUrl: r.link_url || '',
              createdAt: r.created_at,
              favorite: r.favorite,
              storage_path: r.storage_path,
              fileName: r.file_name,
              signedUrl
          };
        })
      );

      merged.invoices = (invoicesRes.data || []).map(inv => ({
        id: inv.id,
        studentId: inv.student_id,
        issueDate: inv.issue_date,
        dueDate: inv.due_date,
        baseAmount: inv.base_amount,
        total: inv.total,
        lateFeePercent: inv.late_fee_percent,
        shortNoticePercent: inv.short_notice_percent,
        lateApplied: inv.late_applied,
        shortApplied: inv.short_applied,
        paid: inv.paid,
        notes: inv.notes,
        servicePeriodStart: inv.service_period_start,
        servicePeriodEnd: inv.service_period_end,
        numSessions: inv.num_sessions,
        invoiceType: inv.invoice_type || 'manual',
        autoGenerated: !!inv.auto_generated,
        paidAt: inv.paid_at,
        paymentProvider: inv.payment_provider || '',
        paymentProviderId: inv.payment_provider_id || '',
        paymentMethod: inv.payment_method || '',
        amountReceived: inv.amount_received || null,
        amountRefunded: inv.amount_refunded || null,
        refundStatus: inv.refund_status || '',
        refundLastAt: inv.refund_last_at || '',
        invoiceStatus: inv.invoice_status || (inv.paid ? 'paid' : 'issued'),
        voidedAt: inv.voided_at || '',
        adjustmentReason: inv.adjustment_reason || '',
        relatedSessionId: inv.related_session_id || '',
        moveToDate: inv.move_to_date || '',
        moveToTime: normalizeTimeValue(inv.move_to_time || ''),
        moveToDurationHours: inv.move_to_duration_hours || null,
        moveRequestedAt: inv.move_requested_at || '',
        moveAppliedAt: inv.move_applied_at || ''
      }));
      merged.contractSignatures = (contractSignaturesRes?.data || []).map(cs => ({
        id: cs.id,
        studentId: cs.student_id,
        parentName: cs.parent_name,
        parentEmail: cs.parent_email,
        signedAt: cs.signed_at,
        contractVersion: cs.contract_version || 'v1',
        contractTextSnapshot: cs.contract_text_snapshot,
        renderedPdfUrl: cs.rendered_pdf_url,
        signatureMethod: cs.signature_method,
        parentIp: cs.parent_ip
      }));
      merged.contracts = await Promise.all(
        (contractsRes.data || []).map(async c => {
          return {
            id: c.id,
            studentId: c.student_id,
            fileName: c.file_name,
            storage_path: c.storage_path,
            status: c.status,
            notes: c.notes,
            uploadedAt: c.uploaded_at,
            signedUrl: ''
          };
        })
      );

      merged.messages = (messagesRes?.data || []).map(m => ({
        id: m.id,
        studentId: m.student_id,
        text: m.text,
        sender: m.sender,
        created_at: m.created_at
      }));
      merged.contractSignatures = (contractSignaturesRes?.data || []).map(cs => ({
        id: cs.id,
        studentId: cs.student_id,
        parentName: cs.parent_name,
        parentEmail: cs.parent_email,
        signedAt: cs.signed_at,
        contractVersion: cs.contract_version || 'v1',
        contractTextSnapshot: cs.contract_text_snapshot,
        renderedPdfUrl: cs.rendered_pdf_url,
        signatureMethod: cs.signature_method,
        parentIp: cs.parent_ip
      }));

      sanitizeState(merged);
      normalizeIdsToUuid();
      return merged;
    }

    function applyTheme() {
      const isDark = state.settings.theme === 'dark';
      document.body.classList.toggle('dark', isDark);
      const btn = document.getElementById('themeToggleBtn');
      btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    function toggleTheme() {
      state.settings.theme = state.settings.theme === 'dark' ? 'light' : 'dark';
      applyTheme();
      saveState();
    }

    function getPolicyHtml(type) {
      const lang = typeof getLanguage === 'function' ? getLanguage() : 'en';
      const dict = window.LEGAL_I18N || {};
      if (type === 'privacy') return dict.PRIVACY_HTML?.[lang] || dict.PRIVACY_HTML?.en || '';
      if (type === 'tos') return dict.TOS_HTML?.[lang] || dict.TOS_HTML?.en || '';
      return '';
    }

    function openPolicyModal(type) {
      const content = getPolicyHtml(type);
      if (!content) return;
      const title = type === 'privacy' ? t('policy.title_privacy') : t('policy.title_tos');
      const html = `
        <h2 class="text-sm font-semibold mb-2">${title}</h2>
        <div id="policyScroll" class="border border-slate-200 rounded-lg p-3 max-h-72 overflow-y-auto text-xs space-y-2 bg-white">
          ${content}
        </div>
        <button id="policyAcknowledgeBtn" class="mt-3 px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium" disabled>
          ${t('policy.scroll_continue')}
        </button>
      `;
      openModal(html, () => {
        const box = document.getElementById('policyScroll');
        const btn = document.getElementById('policyAcknowledgeBtn');
        if (window.applyBusinessText) {
          const scope = document.getElementById('policyScroll') || document;
          window.applyBusinessText(scope);
        }
        const onScroll = () => {
          if (box.scrollTop + box.clientHeight >= box.scrollHeight - 4) {
            btn.disabled = false;
            btn.textContent = t('policy.read_ack');
          }
        };
        if (box) box.addEventListener('scroll', onScroll);
        if (btn) {
          btn.onclick = () => {
            if (type === 'privacy') privacyRead = true;
            if (type === 'tos') tosRead = true;
            closeModal();
          };
        }
      });
    }

    async function loadAccountEmails() {
      if (!isSupabaseReady() || !isOwner()) {
        accountEmails = [];
        return;
      }
      if (Date.now() < supabaseNetworkBackoffUntil) {
        accountEmails = [];
        return;
      }
      try {
        const accessToken = requireAccessToken(t('alert.sign_in_first'));
        const { data, error } = await supabaseClient.functions.invoke('list-account-emails', {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (error) throw error;
        accountEmails = Array.isArray(data?.emails) ? data.emails.filter(Boolean) : [];
      } catch (err) {
        const meta = await getEdgeInvokeErrorMeta(err, 'Account email lookup failed');
        if (meta.status === 401 || meta.status === 403) {
          accountEmails = [];
          return;
        }
        if (isNetworkLoadFailure(meta.message || err)) {
          registerSupabaseNetworkIssue('Cannot reach Supabase right now (network/CORS). Account email lookup is paused temporarily.');
        }
        console.warn('Account emails fetch failed', meta.message || err);
      }
    }

    function applyDensity() {
      const compact = state.settings.density === 'compact';
      const container = document.getElementById('viewsContainer');
      container.classList.toggle('py-8', !compact);
      container.classList.toggle('py-5', compact);
      container.classList.toggle('dense-mode', compact);
    }

    /******************
     * PRESENCE       *
     ******************/
    async function refreshPresence(opts = {}) {
      const force = !!opts.force;
      if (!isSupabaseReady() || !isOwner()) return;
      if (Date.now() < supabaseNetworkBackoffUntil) return;
      const nowMs = Date.now();
      if (!force && (nowMs - lastPresenceRefreshAt) < PRESENCE_REFRESH_MIN_INTERVAL_MS) return;
      if (presenceRefreshInFlight) return presenceRefreshInFlight;
      presenceRefreshInFlight = (async () => {
        try {
          const { data, error } = await supabaseClient.from('presence').select('*');
          if (error) throw error;
          const now = Date.now();
          presenceMap = new Map();
          (data || []).forEach(row => {
            const keyUser = cleanId(row.user_id || row.id || row.email);
            const keyEmail = (row.email || '').toLowerCase();
            const fresh = now - new Date(row.updated_at).getTime() < 65000;
            presenceMap.set(keyUser, { email: row.email, role: row.role, fresh });
            presenceMap.set(keyEmail, { email: row.email, role: row.role, fresh });
          });
          lastPresenceRefreshAt = Date.now();
        } catch (err) {
          if (isNetworkLoadFailure(err)) {
            registerSupabaseNetworkIssue('Cannot reach Supabase right now (network/CORS). Presence updates are paused temporarily.');
          }
          console.warn('Presence fetch failed', err);
        }
      })().finally(() => {
        presenceRefreshInFlight = null;
      });
      return presenceRefreshInFlight;
    }

    function startPresence() {
      if (!isSupabaseReady() || !isOwner()) return;
      stopPresence();
      const run = async () => {
        if (Date.now() < supabaseNetworkBackoffUntil) return;
        if (document.visibilityState === 'hidden') return;
        try {
          const sessionRole = getSessionRole() || (isOwner() ? 'owner' : parentMode ? 'parent' : 'student');
          await supabaseClient.from('presence').upsert({
            user_id: supabaseSession.user.id,
            email: getSessionEmail(),
            role: sessionRole,
            updated_at: new Date().toISOString()
          });
          await refreshPresence();
          renderStudentsView();
        } catch (err) {
          if (isNetworkLoadFailure(err)) {
            registerSupabaseNetworkIssue('Cannot reach Supabase right now (network/CORS). Presence updates are paused temporarily.');
          }
          console.warn('Presence heartbeat failed', err);
        }
      };
      run();
      presenceHeartbeat = setInterval(run, PRESENCE_HEARTBEAT_MS);
    }

    function stopPresence() {
      if (presenceHeartbeat) clearInterval(presenceHeartbeat);
      presenceHeartbeat = null;
      lastPresenceRefreshAt = 0;
      presenceRefreshInFlight = null;
      presenceMap = new Map();
    }

    async function buildContractSigningLink(studentId) {
      const student = getStudentById(studentId);
      if (student?.contractSigned) {
        throw new Error(t('contract.already_signed'));
      }
      if (!isSupabaseReady()) {
        throw new Error(t('alert.contract_link_offline'));
      }
      const studentName = student?.name ? `&student_name=${encodeURIComponent(student.name)}` : '';
      const parentProfile = parentMode ? getParentProfileBySession() : null;
      const accessToken = requireAccessToken(t('alert.sign_in_first'));
      const { data, error } = await supabaseClient.functions.invoke('issue-contract-sign-token', {
        body: { student_id: studentId, parent_email: parentProfile?.email || student?.parentEmail || null },
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      if (error || !data?.token) {
        throw new Error(data?.error || error?.message || t('alert.contract_link_failed'));
      }
      return `${appUrl('/contract-sign.html')}?student_id=${encodeURIComponent(studentId)}&v=v1&token=${encodeURIComponent(data.token)}${studentName}`;
    }

    async function copyContractLink(studentId) {
      try {
        const link = await buildContractSigningLink(studentId);
        navigator.clipboard?.writeText(link).then(() => {
          alert(t('alert.parent_link_copied'));
        }).catch(() => {
          prompt(t('prompt.copy_link'), link);
        });
      } catch (err) {
        console.warn('issue-contract-sign-token failed', err);
        alert(err?.message || t('alert.contract_link_failed'));
      }
    }

	    async function openContractLink(studentId) {
      if (!guardMaintenanceWrite('Contract signing')) return;
	      let popup = null;
	      try {
	        // Open a placeholder tab immediately so pop-up blockers don't block the tokenized link.
	        popup = openPopupPlaceholder(t('contract.signing_page'));
	        const link = await buildContractSigningLink(studentId);
	        navigatePopupToUrl(popup, link, t('contract.signing_page'));
	        navigator.clipboard?.writeText(link).catch(() => {});
	        // If we stayed on this page, watch for the contract to be signed.
	        startContractStatusWatch([studentId], { maxMs: 180000 });
	      } catch (err) {
	        renderPopupState(popup, {
	          title: t('contract.signing_page'),
	          message: err?.message || t('alert.contract_link_failed')
	        });
	        console.warn('issue-contract-sign-token failed', err);
	        alert(err?.message || t('alert.contract_link_failed'));
	      }
	    }

    function scrollToParentInvoices() {
      const target = document.getElementById('parentInvoicesCard');
      if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      setTimeout(() => {
        const firstPayBtn = document.querySelector('#parentInvoices .parent-pay-now-btn');
        if (firstPayBtn && typeof firstPayBtn.focus === 'function') {
          firstPayBtn.focus({ preventScroll: true });
        }
      }, 320);
    }

    function renderAllViewsUI() {
      updateKPIsAndCharts();
      renderStudentsView();
      renderScheduleView();
      renderResourcesView();
      renderFinanceView();
      renderProfileView();
      renderActivityLog();
      renderReportsView();
      if (studentMode) renderStudentPortal();
      if (parentMode) renderParentPortal();
      renderSessionAlerts();
      renderMaintenanceUI();
      applyOwnerDashboardPanel();
      applyOwnerSettingsPanel();
    }

    function renderAllViews() {
      if (refreshAutoBilling()) saveState();
      renderAllViewsUI();
    }

    /******************
     * GLOBAL SEARCH  *
     ******************/
    function handleGlobalSearch(e) {
      const query = e.target.value.trim().toLowerCase();
      const resultsBox = document.getElementById('globalSearchResults');
      if (!query) {
        resultsBox.innerHTML = '';
        resultsBox.classList.add('hidden');
        return;
      }

      const results = [];

      const typeLabels = {
        student: t('search.type_student'),
        resource: t('search.type_resource'),
        session: t('search.type_session'),
        invoice: t('search.type_invoice')
      };

      // Students
      state.students.forEach(s => {
        if (s.name.toLowerCase().includes(query) || (s.notes || '').toLowerCase().includes(query)) {
          results.push({ type: 'student', label: s.name, id: s.id });
        }
      });

      // Resources
      state.resources.forEach(r => {
        if (r.title.toLowerCase().includes(query) || (r.tags || []).some(t => t.toLowerCase().includes(query))) {
          const subjectLabel = r.subject ? ` (${r.subject})` : '';
          results.push({ type: 'resource', label: r.title + subjectLabel, id: r.id });
        }
      });

      // Sessions
      state.sessions.forEach(sess => {
        const studentNames = sess.studentIds.map(id => getStudentById(id)?.name || t('common.unknown')).join(', ');
        const text = (sess.topic || '') + ' ' + studentNames;
        if (text.toLowerCase().includes(query)) {
          results.push({ type: 'session', label: studentNames + ' ‚Äì ' + (sess.topic || t('common.lesson')), id: sess.id });
        }
      });

      // Invoices
      state.invoices.forEach(inv => {
        const s = getStudentById(inv.studentId);
        const label = (s?.name || t('common.unknown')) + ' ‚Äì ' + inv.id;
        if (label.toLowerCase().includes(query)) {
          results.push({ type: 'invoice', label, id: inv.id });
        }
      });

      if (!results.length) {
        resultsBox.innerHTML = `<div class="px-3 py-2 text-slate-500">${esc(t('search.no_results'))}</div>`;
        resultsBox.classList.remove('hidden');
        return;
      }

      resultsBox.innerHTML = results.map(r => `
        <div class="px-3 py-1.5 hover:bg-slate-50 cursor-pointer" data-type="${esc(r.type)}" data-id="${cleanId(r.id)}">
          <span class="text-[10px] uppercase text-slate-400">${esc(typeLabels[r.type] || r.type)}</span>
          <div class="text-xs">${esc(r.label)}</div>
        </div>
      `).join('');
      resultsBox.classList.remove('hidden');

      resultsBox.querySelectorAll('[data-type]').forEach(el => {
        el.addEventListener('click', () => {
          const type = el.dataset.type;
          const id = el.dataset.id;
          if (type === 'student') {
            switchView('students');
            selectStudent(id);
          } else if (type === 'resource') {
            switchView('resources');
          } else if (type === 'session') {
            switchView('schedule');
          } else if (type === 'invoice') {
            switchView('finance');
          }
          resultsBox.classList.add('hidden');
        });
      });
    }

    /***************
     * DASHBOARD   *
     ***************/
    let subjectMixChart;

    function updateKPIsAndCharts() {
      const now = new Date();
      const cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      const today = new Date();
      const knownStudentIds = new Set((state.students || []).map(s => cleanId(s.id)).filter(Boolean));
      const financeInvoices = (state.invoices || []).filter(inv =>
        knownStudentIds.has(cleanId(inv.studentId || inv.student_id || ''))
      );

      const activeStudentIds = new Set(
        state.sessions
          .filter(s => new Date(s.date) >= cutoff)
          .filter(s => getSessionStatus(s) !== SESSION_STATUS.VOIDED)
          .flatMap(s => s.studentIds)
      );
      document.getElementById('kpiStudents').textContent = activeStudentIds.size;

      const startOfWeek = getMonday(now);
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(endOfWeek.getDate() + 7);

      let hoursThisWeek = 0;
      state.sessions.forEach(s => {
        if (getSessionStatus(s) === SESSION_STATUS.VOIDED) return;
        const d = new Date(s.date);
        if (d >= startOfWeek && d < endOfWeek) {
          hoursThisWeek += Number(s.durationHours || 0);
        }
      });
      document.getElementById('kpiHoursWeek').textContent = hoursThisWeek.toFixed(1);

      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      let expected = 0;
      financeInvoices.forEach(inv => {
        const d = new Date(inv.issueDate);
        if (d >= startOfMonth && d < endOfMonth && !isInvoiceVoid(inv)) {
          expected += Number(inv.total || 0);
        }
      });
      if (studentMode) {
        document.getElementById('kpiExpectedIncome').textContent = 'N/A';
      } else {
        document.getElementById('kpiExpectedIncome').textContent = 'R ' + expected.toFixed(2);
      }

      const overdueCount = studentMode ? 0 : financeInvoices.filter(inv => invoiceRequiresPayment(inv) && inv.dueDate && new Date(inv.dueDate) < today).length;
      document.getElementById('kpiOverdue').textContent = studentMode ? 'N/A' : overdueCount;

      // Goals & focus
      const weeklyGoal = Number(state.settings.weeklyGoalHours || 0);
      const weeklyPct = weeklyGoal ? Math.min(100, (hoursThisWeek / weeklyGoal) * 100) : 0;
      document.getElementById('goalHoursLabel').textContent = `${hoursThisWeek.toFixed(1)} / ${weeklyGoal || 0}h`;
      document.getElementById('goalHoursProgress').style.width = `${weeklyPct}%`;

      const monthlyGoal = Number(state.settings.monthlyIncomeGoal || 0);
      const monthlyPct = monthlyGoal ? Math.min(100, (expected / monthlyGoal) * 100) : 0;
      document.getElementById('goalIncomeLabel').textContent = `R ${expected.toFixed(0)} / R ${monthlyGoal || 0}`;
      document.getElementById('goalIncomeProgress').style.width = `${monthlyPct}%`;

      const reflection = (state.settings.reflection || '').trim();
      document.getElementById('reflectionText').textContent = reflection || 'Add a short intention in Settings to keep this week focused.';

      const upcomingSoon = [...state.sessions]
        .filter(s => {
          const status = getSessionStatus(s);
          if (status !== SESSION_STATUS.SCHEDULED && status !== SESSION_STATUS.RESTORED) return false;
          return new Date(s.date + 'T' + (s.startTime || '00:00')) >= now;
        })
        .sort((a, b) => new Date(a.date + 'T' + (a.startTime || '00:00')) - new Date(b.date + 'T' + (b.startTime || '00:00')));
      if (upcomingSoon.length) {
        const next = upcomingSoon[0];
        const names = next.studentIds.map(id => getStudentById(id)?.name || t('common.unknown')).join(', ');
        document.getElementById('focusNextSession').textContent = names;
        document.getElementById('focusNextSessionMeta').textContent = `${next.subject} ‚Ä¢ ${next.date} ${next.startTime || ''}`;
      } else {
        document.getElementById('focusNextSession').textContent = t('dashboard.no_sessions_planned');
        document.getElementById('focusNextSessionMeta').textContent = '';
      }

      const homeworkDueSoon = state.homework.filter(hw => {
        if (hw.status === 'Completed') return false;
        if (!hw.dueDate) return false;
        const due = new Date(hw.dueDate);
        const fiveDays = new Date(now.getTime() + 5 * 24 * 60 * 60 * 1000);
        return due >= today && due <= fiveDays;
      });
      document.getElementById('focusHomework').textContent = homeworkDueSoon.length;
      document.getElementById('focusInvoices').textContent = overdueCount;

      const hours = { Physics: 0, Chemistry: 0, Maths: 0 };
      state.sessions.forEach(s => {
        if (getSessionStatus(s) === SESSION_STATUS.VOIDED) return;
        if (hours[s.subject] != null) {
          hours[s.subject] += Number(s.durationHours || 0);
        }
      });

      const ctx = document.getElementById('subjectMixChart').getContext('2d');
      if (subjectMixChart) subjectMixChart.destroy();
      subjectMixChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Physics', 'Chemistry', 'Maths'],
          datasets: [{
            label: 'Hours taught',
            data: [hours.Physics, hours.Chemistry, hours.Maths],
            backgroundColor: ['#4f46e5', '#16a34a', '#dc2626'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });

      const upcomingList = document.getElementById('upcomingSessionsList');
      const sevenDays = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
      const upcoming = state.sessions
        .filter(s => {
          const status = getSessionStatus(s);
          if (status !== SESSION_STATUS.SCHEDULED && status !== SESSION_STATUS.RESTORED) return false;
          const d = new Date(s.date + 'T' + (s.startTime || '00:00'));
          return d >= now && d <= sevenDays;
        })
        .sort((a, b) => new Date(a.date + 'T' + (a.startTime || '00:00')) - new Date(b.date + 'T' + (b.startTime || '00:00')))
        .slice(0, 10);

      if (!upcoming.length) {
        upcomingList.innerHTML = `<li class="text-slate-500">${esc(t('dashboard.no_upcoming_sessions_7'))}</li>`;
      } else {
        upcomingList.innerHTML = upcoming.map(s => {
          const names = esc(s.studentIds.map(id => getStudentById(id)?.name || t('common.unknown')).join(', '));
          return `<li class="border border-slate-200 bg-white/80 rounded-lg px-2 py-1">
              <div class="font-medium">${names}</div>
              <div class="text-[10px] text-slate-500">${esc(s.subject)} ‚Ä¢ ${esc(s.date)} ‚Ä¢ ${esc(s.startTime || '')} (${esc(s.durationHours || 1)}h)</div>
              <div class="text-[10px]">${esc(s.topic || '')}</div>
            </li>`;
        }).join('');
      }

      const atRiskList = document.getElementById('atRiskList');
      const atRisk = state.students
        .map(s => {
          const last = getLastSessionDate(s.id);
          const daysSince = last ? Math.floor((now - last) / (1000 * 60 * 60 * 24)) : 999;
          return { student: s, daysSince };
        })
        .filter(item => item.daysSince >= 21)
        .sort((a, b) => b.daysSince - a.daysSince)
        .slice(0, 6);
      if (!atRisk.length) {
        atRiskList.innerHTML = `<li class="text-slate-500">${esc(t('dashboard.at_risk_all_good'))}</li>`;
      } else {
        atRiskList.innerHTML = atRisk.map(item => `
          <li class="border border-amber-200 bg-amber-50 rounded-lg px-2 py-1">
            <div class="font-medium">${esc(item.student.name)}</div>
            <div class="text-[10px] text-slate-600">${esc(t('dashboard.days_since_last_session', { days: item.daysSince }))}</div>
          </li>
        `).join('');
      }

      const dueList = document.getElementById('dueHomeworkList');
      if (!homeworkDueSoon.length) {
        dueList.innerHTML = `<li class="text-slate-500">${esc(t('dashboard.nothing_due'))}</li>`;
      } else {
        dueList.innerHTML = homeworkDueSoon.slice(0, 6).map(hw => {
          const res = getResourceById(hw.resourceId);
          const stu = getStudentById(hw.studentId);
          return `<li class="border border-slate-200 bg-white/80 rounded-lg px-2 py-1">
            <div class="font-medium">${esc(res?.title || t('common.homework'))}</div>
            <div class="text-[10px] text-slate-500">${esc(stu?.name || '')} ‚Ä¢ ${esc(t('common.due', { date: hw.dueDate }))}</div>
          </li>`;
        }).join('');
      }

      const prepQueue = document.getElementById('prepQueueList');
      const prepItems = upcomingSoon.slice(0, 3);
      if (!prepItems.length) {
        prepQueue.innerHTML = `<li class="text-slate-500">${esc(t('dashboard.prep_none'))}</li>`;
      } else {
        prepQueue.innerHTML = prepItems.map(sess => {
          const names = esc(sess.studentIds.map(id => getStudentById(id)?.name || t('common.unknown')).join(', '));
          const safeSessionId = cleanId(sess.id);
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
            <div>
              <div class="font-medium">${names}</div>
              <div class="text-[10px] text-slate-500">${esc(sess.date)} ‚Ä¢ ${esc(sess.startTime || '')} ‚Ä¢ ${esc(sess.subject)}</div>
              <div class="text-[10px]">${esc(sess.topic || t('students.lesson_focus'))}</div>
            </div>
            <button class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                    onclick="openSessionQuickActions('${safeSessionId}')">${t('common.open')}</button>
          </li>`;
        }).join('');
      }
      if (isOwner()) {
        void renderOwnerSupportCard();
      }
    }

    /****************
     * STUDENTS VIEW *
     ****************/
    let selectedStudentId = null;

    function renderStudentsView() {
      const list = document.getElementById('studentsList');
      const subjectSelect = document.getElementById('studentSubjectFilter');
      const activitySelect = document.getElementById('studentActivityFilter');
      if (subjectSelect) subjectSelect.onchange = renderStudentsView;
      if (activitySelect) activitySelect.onchange = renderStudentsView;

      const subjectFilter = subjectSelect?.value || '';
      const activityFilter = activitySelect?.value || '';
      const now = new Date();

      const filtered = state.students.filter(s => {
        if (subjectFilter && !(s.subjects || []).includes(subjectFilter)) return false;
        const last = getLastSessionDate(s.id);
        const daysSince = last ? (now - last) / (1000 * 60 * 60 * 24) : Infinity;
        if (activityFilter === 'active' && daysSince > 14) return false;
        if (activityFilter === 'quiet' && daysSince <= 14) return false;
        return true;
      });

      if (!filtered.length) {
        list.innerHTML = `<li class="text-slate-500 text-xs">${esc(t('students.none_filter'))}</li>`;
      } else {
        list.innerHTML = filtered.map(s => {
          const hours = getStudentSubjectHours(s.id);
          const total = hours.Physics + hours.Chemistry + hours.Maths || 1;
          const pPhysics = (hours.Physics / total * 100).toFixed(0);
          const pChem = (hours.Chemistry / total * 100).toFixed(0);
          const pMath = (hours.Maths / total * 100).toFixed(0);
          const last = getLastSessionDate(s.id);
          const daysSince = last ? Math.floor((now - last) / (1000 * 60 * 60 * 24)) : null;
          const next = getNextSessionForStudent(s.id);
          const nextLabel = next ? `${next.date} ${next.startTime || ''}` : t('schedule.unscheduled');
          const presence = presenceMap.get((s.studentEmail || '').toLowerCase()) || presenceMap.get(cleanId(s.id));
          const online = !!presence?.fresh;
          const safeStudentId = cleanId(s.id);
          const lastLabel = daysSince != null
            ? t('students.days_since_last', { days: daysSince })
            : t('students.no_sessions_yet');
          return `<li class="border border-slate-200 bg-white/85 rounded-xl px-3 py-2 cursor-pointer hover:bg-slate-50 flex flex-col gap-1"
                     data-student-id="${safeStudentId}">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-semibold">${esc(s.name)}</div>
                  <div class="text-[10px] text-slate-500">${esc(s.gradeLevel || '')}</div>
                </div>
                <div class="text-right flex items-center gap-2">
                  <span class="inline-flex items-center gap-1 text-[10px] ${online ? 'text-emerald-600' : 'text-slate-500'}">
                    <span class="h-2.5 w-2.5 rounded-full ${online ? 'bg-emerald-500' : 'bg-slate-400'}"></span>
                    ${online ? t('schedule.online') : t('status.offline')}
                  </span>
                  <span class="text-[11px] text-slate-600">${esc(s.subjects?.join(', ') || '')}</span>
                </div>
              </div>
              <div class="flex items-center justify-between text-[10px] text-slate-500">
                <span>${esc(lastLabel)}</span>
                <span>${esc(nextLabel)}</span>
              </div>
              <div class="mt-1 w-full h-1.5 rounded-full bg-slate-100 overflow-hidden flex">
                <div style="width:${pPhysics}%" class="bg-indigo-500"></div>
                <div style="width:${pChem}%" class="bg-emerald-500"></div>
                <div style="width:${pMath}%" class="bg-rose-500"></div>
              </div>
            </li>`;
        }).join('');
      }

      list.querySelectorAll('[data-student-id]').forEach(li => {
        li.addEventListener('click', () => {
          selectStudent(li.dataset.studentId);
        });
      });

      const current = getStudentById(selectedStudentId);
      if (current) {
        showStudentDetail(selectedStudentId);
      } else {
        document.getElementById('studentDetailEmpty').classList.remove('hidden');
        document.getElementById('studentDetail').classList.add('hidden');
      }
      renderParentsList();
    }

    function getStudentById(id) {
      return state.students.find(s => s.id === id);
    }

    function getParentById(id) {
      return state.parents.find(p => p.id === id);
    }

    function getParentLinkedStudents(parentId) {
      const links = state.parentLinks.filter(pl => pl.parentId === parentId);
      return links.map(pl => getStudentById(pl.studentId)).filter(Boolean);
    }

    function getLatestSignature(studentId) {
      const sigs = state.contractSignatures
        .filter(cs => cs.studentId === studentId)
        .sort((a, b) => new Date(b.signedAt || 0) - new Date(a.signedAt || 0));
      return sigs[0] || null;
    }

    function getSignatureById(signatureId) {
      return state.contractSignatures.find(cs => cs.id === signatureId) || null;
    }

    function buildContractTextDataUrl(text) {
      return `data:text/plain;charset=utf-8,${encodeURIComponent(text || '')}`;
    }

    async function requestFreshContractUrlFromServer(contractId, studentId = '') {
      if (!supabaseClient?.functions || !supabaseSession?.access_token) return '';
      try {
        const body = { contract_id: contractId };
        if (studentId) body.student_id = studentId;
        const { data, error } = await supabaseClient.functions.invoke('get-contract-file-url', {
          body,
          headers: { Authorization: `Bearer ${supabaseSession.access_token}` }
        });
        if (error) throw error;
        return data?.url || data?.signed_url || '';
      } catch (err) {
        console.warn('get-contract-file-url failed', err);
        return '';
      }
    }

    async function getFreshContractUrl(contractId) {
      const contract = state.contracts.find(c => c.id === contractId) || null;
      const signature = getSignatureById(contractId);

      // Primary path: ask backend to issue a fresh, validated URL.
      const freshFromServer = await requestFreshContractUrlFromServer(contractId, contract?.studentId || signature?.studentId || '');
      if (freshFromServer) {
        if (contract) contract.signedUrl = freshFromServer;
        if (signature) {
          signature.renderedPdfUrl = freshFromServer;
          signature.rendered_pdf_url = freshFromServer;
        }
        return freshFromServer;
      }

      // Never trust cached URLs from DB/local state. Use backend-issued URL only.
      return '';
    }

    function triggerDownloadFromUrl(url, fileName) {
      if (!url) return;
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName || t('contract.file_default');
      a.rel = 'noopener';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    async function openContractFile(contractId) {
      const signature = getSignatureById(contractId);
      let popup = openPopupPlaceholder(t('contract.view_signed_copy'));
      try {
        const fileUrl = await getFreshContractUrl(contractId);
        if (!fileUrl) {
          renderPopupState(popup, {
            title: t('contract.view_signed_copy'),
            message: t('contract.signed_missing')
          });
          if (signature?.contractTextSnapshot) {
            openContractSnapshotModal(contractId);
            return;
          }
          alert(t('contract.signed_missing'));
          return;
        }
        navigatePopupToUrl(popup, fileUrl, t('contract.view_signed_copy'));
      } catch (err) {
        renderPopupState(popup, {
          title: t('contract.view_signed_copy'),
          message: t('contract.signed_missing')
        });
        console.warn('Contract open failed', err);
        alert(t('contract.signed_missing'));
      }
    }

    async function downloadContractFile(contractId) {
      const contract = state.contracts.find(c => c.id === contractId) || null;
      const signature = getSignatureById(contractId);
      const fileName = contract?.fileName || t('contract.file_default');
      let fileUrl = '';
      try {
        fileUrl = await getFreshContractUrl(contractId);
        if (fileUrl) {
          const res = await fetch(fileUrl);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const blob = await res.blob();
          const objectUrl = URL.createObjectURL(blob);
          triggerDownloadFromUrl(objectUrl, fileName);
          setTimeout(() => URL.revokeObjectURL(objectUrl), 1500);
          return;
        }
        if (signature?.contractTextSnapshot) {
          const textName = fileName.replace(/\.pdf$/i, '.txt');
          triggerDownloadFromUrl(buildContractTextDataUrl(signature.contractTextSnapshot), textName);
          return;
        }
        alert(t('contract.signed_missing'));
      } catch (err) {
        console.warn('Contract download failed', err);
        if (signature?.contractTextSnapshot) {
          const textName = fileName.replace(/\.pdf$/i, '.txt');
          triggerDownloadFromUrl(buildContractTextDataUrl(signature.contractTextSnapshot), textName);
          return;
        }
        if (fileUrl) {
          const popup = openPopupPlaceholder(t('common.download'));
          navigatePopupToUrl(popup, fileUrl, t('common.download'));
          return;
        }
        alert(t('contract.signed_missing'));
      }
    }

    function openContractSnapshotModal(signatureId) {
      const sig = getSignatureById(signatureId);
      if (!sig || !sig.contractTextSnapshot) {
        alert(t('contract.signed_missing'));
        return;
      }
      const text = sig.contractTextSnapshot;
      const defaultName = t('contract.file_default').replace(/\.pdf$/i, '.txt');
      const downloadUrl = buildContractTextDataUrl(text);
      openModal(`
        <h2 class="text-sm font-semibold mb-2">${esc(t('contract.view_signed_copy'))}</h2>
        <div class="border border-slate-200 rounded-lg p-2 text-[11px] whitespace-pre-wrap max-h-[50vh] overflow-y-auto bg-white/80">${esc(text)}</div>
        <div class="mt-3 flex gap-2">
          <a class="text-[11px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50" href="${downloadUrl}" download="${esc(defaultName)}">${t('common.download')}</a>
        </div>
      `);
    }

    function ensureStudentContractState(student) {
      if (!student) return false;
      if (student.contractSigned) return false;
      const latestSig = getLatestSignature(student.id);
      const contractEntry = state.contracts.find(c => c.studentId === student.id && c.status === 'Signed') || null;
      if (!latestSig && !contractEntry) return false;
      student.contractSigned = true;
      if (!student.contractSignedAt) {
        student.contractSignedAt = latestSig?.signedAt || contractEntry?.uploadedAt || new Date().toISOString();
      }
      if (!student.lastContractId) {
        student.lastContractId = latestSig?.id || contractEntry?.id || '';
      }
      return true;
    }

    async function deleteParentAndLinks(parentId) {
      // Local
      const parent = getParentById(parentId);
      state.parents = state.parents.filter(p => p.id !== parentId);
      state.parentLinks = state.parentLinks.filter(pl => pl.parentId !== parentId);
      if (Array.isArray(supportTicketsCache?.tickets) && supportTicketsCache.tickets.length) {
        supportTicketsCache.tickets = supportTicketsCache.tickets.filter(ticket => cleanId(ticket?.parent_id || '') !== cleanId(parentId));
      }
      saveState();
      renderParentsList();
      // Remote
      if (isSupabaseReady()) {
        let loginCodeToDelete = '';
        try {
          const { data } = await supabaseClient.from('parents').select('login_code').eq('id', parentId).single();
          loginCodeToDelete = data?.login_code || '';
        } catch { }
        try {
          await supabaseClient.from('support_tickets').delete().eq('parent_id', parentId);
          supportTicketsCache.loadedAt = 0;
        } catch (err) {
          console.warn('Remote support_tickets delete failed', err);
        }
        try {
          await supabaseClient.from('parent_students').delete().eq('parent_id', parentId);
        } catch (err) {
          console.warn('Remote parent_students delete failed', err);
        }
        try {
          await supabaseClient.from('parents').delete().eq('id', parentId);
        } catch (err) {
          console.warn('Remote parents delete failed', err);
        }
        if (loginCodeToDelete) {
          try {
            const accessToken = requireAccessToken(t('alert.sign_in_first'));
            const stepUp = await issueActionNonce(
              ACTION_NONCE_ACTIONS.deleteAccountByCode,
              { login_code: loginCodeToDelete },
              accessToken
            );
            await supabaseClient.functions.invoke('delete-account', {
              body: {
                login_code: loginCodeToDelete,
                action_nonce: stepUp.nonce,
                request_fingerprint: stepUp.requestFingerprint
              },
              headers: { Authorization: `Bearer ${accessToken}` }
            });
          } catch (err) {
            console.warn('Auth user delete by code failed', err);
          }
        }
      }
    }

    function getStudentSubjectHours(studentId) {
      const res = { Physics: 0, Chemistry: 0, Maths: 0 };
      const now = new Date();
      const cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      state.sessions.forEach(sess => {
        if (!sess.studentIds.includes(studentId)) return;
        const d = new Date(sess.date);
        if (d >= cutoff) {
          if (res[sess.subject] != null) {
            res[sess.subject] += Number(sess.durationHours || 0);
          }
        }
      });
      return res;
    }

    function renderParentsList() {
      const list = document.getElementById('parentsList');
      if (!list) return;
      if (!state.parents.length) {
        list.innerHTML = `<li class="text-slate-500 text-xs">${esc(t('parents.none'))}</li>`;
        return;
      }
      list.innerHTML = state.parents.map(p => {
        const kids = getParentLinkedStudents(p.id);
        const kidNames = kids.map(k => k.name).join(', ') || t('parents.no_students_linked');
        const codeChip = p.loginCode ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 font-mono text-[10px] border border-indigo-100">${esc(p.loginCode)}</span>` : '';
        const safeParentId = cleanId(p.id);
        return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex items-start justify-between gap-2">
          <div>
            <div class="font-semibold">${esc(p.name || p.email || '')}</div>
            <div class="text-[10px] text-slate-500">${esc(p.email || '')}</div>
            <div class="text-[10px] ${p.emailNotificationsOptIn ? 'text-emerald-700' : 'text-amber-700'}">
              ${p.email ? (p.emailNotificationsOptIn ? 'Email notifications: enabled' : 'Email notifications: consent missing') : 'Email notifications: no email'}
            </div>
            <div class="text-[10px] text-slate-500">${esc(kidNames)}</div>
            ${codeChip ? `<div class="mt-1">${codeChip}</div>` : ''}
          </div>
          <button data-parent-id="${safeParentId}" class="px-2 py-1 text-[10px] rounded-lg border border-slate-300 hover:bg-slate-50">${t('common.edit')}</button>
        </li>`;
      }).join('');
      list.querySelectorAll('[data-parent-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const parent = getParentById(btn.dataset.parentId);
          if (parent) openParentModal(parent);
        });
      });
    }

    function openParentModal(parent) {
      if (!guardEdit()) return;
      const isEdit = !!parent;
      const parentEmailOptions = getAvailableParentEmails(parent?.email).map(e => `<option value="${esc(e)}">`).join('');
      const linked = new Set(
        state.parentLinks.filter(pl => pl.parentId === parent?.id).map(pl => pl.studentId)
      );
      const studentChecks = state.students.map(s => `
        <label class="flex items-center gap-2 text-[11px]">
          <input type="checkbox" name="studentIds" value="${cleanId(s.id)}" ${linked.has(s.id) ? 'checked' : ''}>
          <span>${esc(s.name)}</span>
        </label>
      `).join('');
      const existingCode = normalizeCode(parent?.loginCode);
      const existingEmailOptIn = !!parent?.emailNotificationsOptIn;
      const phoneParts = splitPhoneValue(parent?.phone || '');
      const phoneCode = phoneParts.code;
      const phoneLocal = phoneParts.local;
      const html = `
        <h2 class="text-sm font-semibold mb-3">${isEdit ? t('parents.edit_title') : t('parents.add_title')}</h2>
        <form id="parentForm" class="space-y-2 text-xs">
          <div>
            <label class="block text-[11px] mb-1">${t('common.name')}</label>
            <input name="name" value="${esc(parent?.name || '')}" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">${t('auth.email')}</label>
            <input list="parentEmailOptions" name="email" value="${esc(parent?.email || '')}" placeholder="${t('parents.email_optional')}"
              class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            <datalist id="parentEmailOptions">
              ${parentEmailOptions}
            </datalist>
          </div>
          <div class="portal-consent-card">
            <label class="flex items-start gap-3 text-[12px] text-slate-800 cursor-pointer">
              <input type="checkbox" name="emailNotificationsOptIn" ${existingEmailOptIn ? 'checked' : ''} class="mt-0.5 h-5 w-5 accent-indigo-600">
              <span>
                <span class="font-semibold">I confirm service-email consent for this address</span>
                <span class="block text-[11px] text-slate-600 mt-0.5">Required to send invoices, overdue reminders, schedule updates, and policy/domain notices.</span>
              </span>
            </label>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${t('common.phone')}</label>
            <div class="flex gap-2">
              <select name="phoneCode" class="border border-slate-300 rounded-lg px-2 py-1 text-xs w-28">
                ${PHONE_CODES.map(c => `<option value="${c}" ${phoneCode === c ? 'selected' : ''}>${c}</option>`).join('')}
                <option value="" ${!phoneCode ? 'selected' : ''}>${t('common.code')}</option>
              </select>
              <input name="phoneLocal" value="${esc(phoneLocal)}" class="flex-1 border border-slate-300 rounded-lg px-2 py-1 text-xs" placeholder="${t('common.number')}">
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${t('common.notes')}</label>
            <textarea name="notes" rows="2" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${esc(parent?.notes || '')}</textarea>
          </div>
          <div class="p-3 bg-indigo-50 border border-indigo-100 rounded-xl">
            <div class="flex items-center justify-between mb-1">
              <div>
                <div class="text-xs font-semibold text-indigo-900">${t('parents.login_code_title')}</div>
                <div class="text-[10px] text-indigo-700">${t('parents.login_code_hint')}</div>
              </div>
              ${existingCode ? `<span class="text-[10px] text-indigo-700 font-semibold">${esc(existingCode)}</span>` : ''}
            </div>
            <div class="flex gap-2">
              <button type="button" id="parentGenerateCodeBtn" class="px-3 py-1.5 bg-indigo-600 text-white text-xs rounded-lg hover:bg-indigo-700 transition shadow-sm w-full">
                ${existingCode ? t('parents.regenerate_code') : t('parents.generate_code')}
              </button>
              ${existingCode ? `<button type="button" id="parentCopyExistingBtn" class="px-3 py-1.5 bg-white border border-indigo-200 text-indigo-700 text-xs rounded-lg hover:bg-indigo-50 transition shadow-sm">${t('common.copy')}</button>` : ''}
            </div>
            <div id="parentCodeResult" class="${existingCode ? '' : 'hidden'} mt-2 p-2 bg-white border border-indigo-200 rounded-lg">
              <div class="text-[10px] text-slate-500 mb-1">${t('parents.share_code')}</div>
              <div class="flex items-center gap-2">
                <code id="parentGeneratedCode" class="text-base font-mono font-bold text-slate-900 bg-slate-100 px-2 py-1 rounded select-all tracking-wide">${esc(existingCode || '')}</code>
                <button type="button" id="parentCopyBtn" class="text-[10px] text-indigo-600 hover:underline">${t('common.copy')}</button>
              </div>
            </div>
            <input type="hidden" name="loginCode" id="parentHiddenLoginCode" value="${esc(existingCode || '')}">
          </div>
          <div class="space-y-1">
            <div class="text-[11px] font-semibold">${t('parents.link_students')}</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-1 max-h-40 overflow-y-auto">
              ${studentChecks || `<div class="text-[10px] text-slate-500">${t('students.none_yet')}</div>`}
            </div>
          </div>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-xs font-medium">
              ${isEdit ? t('parents.save_changes') : t('parents.add_submit')}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteParentBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                ${t('common.delete')}
              </button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('parentForm');
        const parentGenerateBtn = document.getElementById('parentGenerateCodeBtn');
        const parentCodeBox = document.getElementById('parentCodeResult');
        const parentCodeDisplay = document.getElementById('parentGeneratedCode');
        const parentCopyBtn = document.getElementById('parentCopyBtn');
        const parentCopyExistingBtn = document.getElementById('parentCopyExistingBtn');
        const parentHiddenLoginCode = document.getElementById('parentHiddenLoginCode');
        if (parentGenerateBtn) {
          parentGenerateBtn.onclick = () => {
            const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) code += alphabet[Math.floor(Math.random() * alphabet.length)];
            parentCodeDisplay.textContent = code;
            parentHiddenLoginCode.value = code;
            parentCodeBox.classList.remove('hidden');
            parentGenerateBtn.textContent = t('parents.regenerate_code');
          };
        }
        if (parentCopyBtn) {
          parentCopyBtn.onclick = () => {
            if (!parentCodeDisplay.textContent) return;
            navigator.clipboard.writeText(parentCodeDisplay.textContent);
            parentCopyBtn.textContent = t('common.copied_exclaim');
            setTimeout(() => parentCopyBtn.textContent = t('common.copy'), 2000);
          };
        }
        if (parentCopyExistingBtn && existingCode) {
          parentCopyExistingBtn.onclick = () => {
            navigator.clipboard.writeText(existingCode);
            parentCopyExistingBtn.textContent = t('common.copied');
            setTimeout(() => parentCopyExistingBtn.textContent = t('common.copy'), 1800);
          };
        }
        form.onsubmit = (e) => {
          e.preventDefault();
          const emailVal = form.email.value.trim().toLowerCase();
          const emailNotificationsOptIn = !!form.emailNotificationsOptIn?.checked;
          if (emailVal && !emailNotificationsOptIn) {
            alert('Please confirm email consent before saving this parent email.');
            return;
          }
          const previousEmail = String(parent?.email || '').trim().toLowerCase();
          const previousOptInAt = String(parent?.emailNotificationsOptInAt || '').trim();
          const emailNotificationsOptInAt = emailVal && emailNotificationsOptIn
            ? ((isEdit && previousEmail === emailVal && parent?.emailNotificationsOptIn && previousOptInAt) ? previousOptInAt : new Date().toISOString())
            : '';
          const loginCode = normalizeCode(form.loginCode?.value || parent?.loginCode || '');
          const newParent = {
            id: parent?.id || generateId('par'),
            name: form.name.value.trim(),
            email: emailVal,
            phone: buildPhoneValue(form.phoneCode.value, form.phoneLocal.value),
            notes: form.notes.value.trim(),
            loginCode,
            emailNotificationsOptIn: !!(emailVal && emailNotificationsOptIn),
            emailNotificationsOptInAt
          };
          const taken = newParent.email && state.parents.some(p => p.email === newParent.email && p.id !== newParent.id);
          if (taken) {
            alert(t('alert.parent_email_taken'));
            return;
          }
          if (!newParent.loginCode && !isEdit) {
            if (!confirm(t('confirm.parent_no_login_code'))) return;
          }
          if (isEdit) {
            const idx = state.parents.findIndex(p => p.id === parent.id);
            state.parents[idx] = { ...state.parents[idx], ...newParent };
            logActivity(t('activity.parent_updated'), newParent.email);
          } else {
            state.parents.push(newParent);
            logActivity(t('activity.parent_added'), newParent.email);
          }
          const selected = Array.from(form.querySelectorAll('input[name="studentIds"]:checked')).map(i => i.value);
          state.parentLinks = state.parentLinks.filter(pl => pl.parentId !== newParent.id);
          selected.forEach(sid => {
            state.parentLinks.push({
              id: generateId('plink'),
              parentId: newParent.id,
              studentId: sid,
              relationship: ''
            });
          });
          saveState();
          closeModal();
          renderParentsList();
          if (newParent.loginCode && isSupabaseReady() && isOwner()) {
            provisionLoginCode('parent', newParent.loginCode, { parentId: newParent.id, fullName: newParent.name });
          }
        };
        if (isEdit) {
          const delBtn = document.getElementById('deleteParentBtn');
          delBtn.onclick = () => {
            if (!confirm(t('confirm.delete_parent'))) return;
            deleteParentAndLinks(parent.id).then(() => {
              closeModal();
            }).catch(err => {
              console.error(err);
              alert(t('alert.parent_delete_failed', { error: err?.message || err }));
            });
          };
        }
      });
    }

    function getLastSessionDate(studentId) {
      const sessions = state.sessions
        .filter(sess => sess.studentIds.includes(studentId))
        .filter(sess => getSessionStatus(sess) !== SESSION_STATUS.VOIDED)
        .map(sess => new Date(sess.date))
        .sort((a, b) => b - a);
      return sessions[0] || null;
    }

    function getNextSessionForStudent(studentId) {
      const now = new Date();
      const sessions = state.sessions
        .filter(sess => sess.studentIds.includes(studentId))
        .filter(sess => {
          const status = getSessionStatus(sess);
          return status === SESSION_STATUS.SCHEDULED || status === SESSION_STATUS.RESTORED;
        })
        .sort((a, b) => new Date(a.date + 'T' + (a.startTime || '00:00')) - new Date(b.date + 'T' + (b.startTime || '00:00')));
      return sessions.find(sess => new Date(sess.date + 'T' + (sess.startTime || '00:00')) >= now) || null;
    }

    function getStudentHomeworkStats(studentId) {
      const items = state.homework.filter(hw => hw.studentId === studentId);
      const total = items.length;
      const completed = items.filter(hw => hw.status === 'Completed').length;
      return { total, completed, rate: total ? Math.round((completed / total) * 100) : 0 };
    }

    function getWeeklyStreak(studentId) {
      let streak = 0;
      const today = new Date();
      let cursor = getMonday(today);
      while (true) {
        const end = new Date(cursor);
        end.setDate(end.getDate() + 7);
        const hasSession = state.sessions.some(sess => {
          if (!sess.studentIds.includes(studentId)) return false;
          const d = new Date(sess.date);
          return d >= cursor && d < end;
        });
        if (hasSession) {
          streak++;
          cursor.setDate(cursor.getDate() - 7);
        } else {
          break;
        }
      }
      return streak;
    }

    function selectStudent(id) {
      selectedStudentId = id;
      showStudentDetail(id);
      switchView('students');
    }

    function showStudentDetail(id) {
      const s = getStudentById(id);
      if (!s) return;
      document.getElementById('studentDetailEmpty').classList.add('hidden');
      document.getElementById('studentDetail').classList.remove('hidden');

      document.getElementById('studentDetailName').textContent = s.name;
      const rateLabel = s.rate ? t('students.rate_per_hour', { rate: s.rate }) : t('common.na');
      document.getElementById('studentDetailMeta').textContent =
        `${s.gradeLevel || ''} ‚Ä¢ ${s.subjects?.join(', ') || ''} ‚Ä¢ ${rateLabel}`;
      const scheduleMeta = document.getElementById('studentScheduleMeta');
      if (scheduleMeta) scheduleMeta.textContent = formatScheduleSummary(s);
      const contractBadge = document.getElementById('studentContractBadge');
      const contractLinkBtn = document.getElementById('studentContractLinkBtn');
      const contractDeleteBtn = document.getElementById('studentContractDeleteBtn');
      const contractMeta = document.getElementById('studentContractMeta');
      const latestSig = getLatestSignature(s.id);
      const contractEntry = state.contracts.find(c => c.studentId === s.id && c.status === 'Signed') || null;
      const hasContract = !!latestSig || !!contractEntry || !!s.contractSigned;
      const loginCodeBadge = document.getElementById('studentLoginCodeBadge');
      const loginCodeCopy = document.getElementById('studentLoginCodeCopy');
      if (loginCodeBadge) {
        loginCodeBadge.textContent = s.loginCode ? t('students.login_code_prefix', { code: s.loginCode }) : '';
        loginCodeBadge.classList.toggle('hidden', !s.loginCode);
      }
      if (loginCodeCopy) {
        const hasCode = !!s.loginCode;
        loginCodeCopy.classList.toggle('hidden', !hasCode || parentMode);
        loginCodeCopy.onclick = () => {
          if (!hasCode) return;
          navigator.clipboard.writeText(s.loginCode);
          loginCodeCopy.textContent = t('common.copied_exclaim');
          setTimeout(() => loginCodeCopy.textContent = t('students.copy_code'), 2000);
        };
      }
      if (contractBadge) {
        const signed = !!s.contractSigned;
        contractBadge.textContent = signed ? t('contract.status_valid') : t('contract.status_invalid');
        contractBadge.className = signed
          ? 'px-2 py-1 text-[11px] rounded-lg bg-emerald-100 text-emerald-700 font-semibold'
          : 'px-2 py-1 text-[11px] rounded-lg bg-rose-100 text-rose-700 font-semibold';
      }
      if (contractDeleteBtn) {
        contractDeleteBtn.classList.toggle('hidden', !hasContract || parentMode);
        contractDeleteBtn.onclick = () => {
          if (!guardEdit()) return;
          const targetId = latestSig?.id || contractEntry?.id || s.lastContractId || '';
          deleteContractForStudent(targetId, s.id).catch((err) => {
            console.error('Contract delete failed', err);
            alert(err?.message || t('alert.delete_failed_try_again'));
          });
        };
      }
      if (contractMeta) {
        if (latestSig) {
          const signedName = esc(latestSig.parentName || t('parent.parent_label'));
          const signedAt = esc(latestSig.signedAt ? new Date(latestSig.signedAt).toLocaleString() : '');
          const signedVersion = esc(latestSig.contractVersion || 'v1');
          const hasSignedFile = !!(contractEntry?.storage_path || contractEntry?.signedUrl || latestSig.renderedPdfUrl || latestSig.rendered_pdf_url);
          const hasSnapshot = !!latestSig.contractTextSnapshot;
          const signedLine = t('contract.signed_by_on', { name: signedName, date: signedAt, version: signedVersion });
          const signedLink = hasSignedFile
            ? `<button class="underline text-indigo-600" onclick="openContractFile('${cleanId(latestSig.id)}')">${t('contract.view_signed_copy')}</button>`
            : (hasSnapshot ? `<button class="underline text-indigo-600" onclick="openContractSnapshotModal('${cleanId(latestSig.id)}')">${t('contract.view_signed_copy')}</button>` : '');
          contractMeta.innerHTML = `${signedLine} ${signedLink}`.trim();
        } else if (contractEntry?.storage_path || contractEntry?.signedUrl) {
          contractMeta.innerHTML = `${t('contract.signed_on_file')} <button class="underline text-indigo-600" onclick="openContractFile('${cleanId(contractEntry.id)}')">${t('contract.view_signed_copy')}</button>`;
        } else {
          contractMeta.textContent = t('contract.none_signed');
        }
      }
      if (contractLinkBtn) {
        contractLinkBtn.onclick = () => copyContractLink(s.id);
      }

      const hours = getStudentSubjectHours(id);
      const total = hours.Physics + hours.Chemistry + hours.Maths || 1;
      const pPhysics = (hours.Physics / total * 100).toFixed(0);
      const pChem = (hours.Chemistry / total * 100).toFixed(0);
      const pMath = (hours.Maths / total * 100).toFixed(0);
      const physEl = document.getElementById('mixPhysics');
      const chemEl = document.getElementById('mixChemistry');
      const mathEl = document.getElementById('mixMaths');
      physEl.style.width = pPhysics + '%';
      chemEl.style.width = pChem + '%';
      mathEl.style.width = pMath + '%';
      physEl.textContent = pPhysics > 15 ? pPhysics + '%' : '';
      chemEl.textContent = pChem > 15 ? pChem + '%' : '';
      mathEl.textContent = pMath > 15 ? pMath + '%' : '';

      const totalHours = (hours.Physics + hours.Chemistry + hours.Maths).toFixed(1);
      document.getElementById('engagementHours').textContent = totalHours + 'h';
      const streak = getWeeklyStreak(id);
      document.getElementById('engagementStreak').textContent = streak;
      const last = getLastSessionDate(id);
      document.getElementById('engagementNextGap').textContent = last
        ? t('students.days_since_last', { days: Math.floor((new Date() - last) / (1000 * 60 * 60 * 24)) })
        : t('students.no_sessions_yet');
      const hwStats = getStudentHomeworkStats(id);
      document.getElementById('engagementHomework').textContent = `${hwStats.rate}%`;
      document.getElementById('engagementHomeworkProgress').style.width = `${hwStats.rate}%`;
      // If contract not signed, show a blocking notice in detail tabs
      const unsignedNotice = document.getElementById('studentUnsignedNotice');
      if (unsignedNotice) {
        unsignedNotice.classList.toggle('hidden', !!s.contractSigned);
      }

      renderStudentTimeline(id);
      renderStudentSessions(id);
      renderStudentDocuments(id);
      renderStudentFinance(id);
      renderStudentTodos(id);
      renderStudentCheckins(id);
      renderStudentContracts(id);
      renderStudentMessages(id);

      document.getElementById('editStudentBtn').onclick = () => openStudentModal(s);
      document.getElementById('studentCreateInvoiceBtn').onclick = () => { if (guardEdit()) openInvoiceModal(null); };

      document.querySelectorAll('#studentDetailTabs .student-tab').forEach(tab => {
        tab.classList.remove('border-indigo-500', 'text-slate-900');
        tab.classList.add('text-slate-500');
      });
      const defaultTab = document.querySelector('#studentDetailTabs .student-tab[data-student-tab="timeline"]');
      defaultTab.classList.add('border-indigo-500', 'text-slate-900');
      defaultTab.classList.remove('text-slate-500');
      document.querySelectorAll('.student-tab-pane').forEach(p => p.classList.add('hidden'));
      document.getElementById('studentTab-timeline').classList.remove('hidden');

      document.querySelectorAll('#studentDetailTabs .student-tab').forEach(tab => {
        tab.onclick = () => {
          const tabId = tab.dataset.studentTab;
          document.querySelectorAll('#studentDetailTabs .student-tab').forEach(t => {
            t.classList.remove('border-indigo-500', 'text-slate-900');
            t.classList.add('text-slate-500');
          });
          tab.classList.add('border-indigo-500', 'text-slate-900');
          tab.classList.remove('text-slate-500');
          document.querySelectorAll('.student-tab-pane').forEach(p => p.classList.add('hidden'));
          document.getElementById('studentTab-' + tabId).classList.remove('hidden');
        };
      });

      document.getElementById('addDocumentForStudentBtn').onclick = () => { if (guardEdit()) openDocumentModal(null, s.id); };
      const todoForm = document.getElementById('studentTodoForm');
      if (todoForm) {
        todoForm.onsubmit = (e) => {
          if (!guardEdit()) return;
          e.preventDefault();
          const text = todoForm.todoText.value.trim();
          const dueDate = todoForm.todoDue.value;
          if (!text) return;
          state.studentTodos.push({
            id: generateId('todo'),
            studentId: id,
            text,
            dueDate,
            done: false
          });
          saveState();
          renderStudentTodos(id);
          todoForm.reset();
        };
      }
      const checkinForm = document.getElementById('studentCheckinForm');
      if (checkinForm) {
        checkinForm.onsubmit = (e) => {
          if (!guardEdit()) return;
          e.preventDefault();
          const text = checkinForm.checkinText.value.trim();
          if (!text) return;
          state.studentCheckins.push({
            id: generateId('note'),
            studentId: id,
            text,
            date: new Date().toISOString().slice(0, 10)
          });
          saveState();
          renderStudentCheckins(id);
          renderStudentTimeline(id);
          checkinForm.reset();
        };
      }
      const contractBtn = document.getElementById('uploadContractBtn');
      if (contractBtn) {
        contractBtn.onclick = () => openContractUpload(id);
      }
      const msgForm = document.getElementById('studentMessageForm');
      if (msgForm) {
        msgForm.onsubmit = (e) => {
          e.preventDefault();
          const text = msgForm.messageText.value.trim();
          if (!text) return;
          const sender = isOwner() ? 'owner' : 'student';
          state.messages.push({
            id: generateId('msg'),
            studentId: id,
            text,
            sender,
            created_at: new Date().toISOString()
          });
          saveState();
          renderStudentMessages(id);
          logActivity(t('activity.message_posted'), text.slice(0, 50));
          msgForm.reset();
        };
      }
      const msgAiBtn = document.getElementById('studentMessageAiBtn');
      if (msgAiBtn) {
          msgAiBtn.onclick = async () => {
            if (!guardEdit()) return;
            const textarea = msgForm?.messageText;
          const recent = state.sessions
            .filter(sess => sess.studentIds.includes(id))
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 3)
            .map(sess => `${sess.date}: ${sess.subject} ‚Äì ${sess.topic || ''}`);
          const ctxParts = [
            `Student: ${s.name || ''}`,
            `Grade: ${s.gradeLevel || 'n/a'}`,
            `Subjects: ${(s.subjects || []).join(', ') || 'n/a'}`,
            `Recent sessions: ${recent.join(' | ') || 'none'}`,
          ];
          msgAiBtn.disabled = true;
          msgAiBtn.textContent = t('ai.drafting');
          try {
            const draft = await draftMessageAI({
              purpose: 'progress update',
              audience: 'student',
              tone: 'friendly and clear',
              context: ctxParts.join('; ')
            });
            if (textarea) textarea.value = draft;
          } catch (err) {
            alert(err?.message || t('alert.ai_draft_failed'));
          } finally {
            msgAiBtn.disabled = false;
            msgAiBtn.textContent = t('students.draft_ai');
          }
        };
      }
    }

    function renderStudentTimeline(studentId) {
      const ul = document.getElementById('studentTimeline');
      const events = [];
      const typeSession = t('timeline.session');
      const typeHomework = t('timeline.homework');
      const typeInvoice = t('timeline.invoice');
      const typeDocument = t('timeline.document');
      const typeCheckin = t('timeline.checkin');
      const typeContract = t('timeline.contract');

      state.sessions.filter(sess => sess.studentIds.includes(studentId)).forEach(sess => {
        events.push({
          date: sess.date,
          type: typeSession,
          description: `${sess.subject} ‚Ä¢ ${sess.topic || t('common.lesson')} (${sess.durationHours || 1}h)`
        });
      });

      state.homework.filter(hw => hw.studentId === studentId).forEach(hw => {
        const res = state.resources.find(r => r.id === hw.resourceId);
        if (!res) return;
        events.push({
          date: hw.assignedDate || res.createdAt || new Date().toISOString().slice(0, 10),
          type: typeHomework,
          description: `${res.title} [${hw.status}]`
        });
      });

      state.invoices.filter(inv => inv.studentId === studentId).forEach(inv => {
        const periodLabel = inv.servicePeriodStart && inv.servicePeriodEnd
          ? ` ${inv.servicePeriodStart}‚Üí${inv.servicePeriodEnd}`
          : '';
        const sessionLabel = inv.numSessions === 1 ? t('common.session') : t('common.sessions');
        const countLabel = inv.numSessions ? ` ${inv.numSessions} ${sessionLabel}` : '';
        events.push({
          date: inv.issueDate,
          type: typeInvoice,
          description: `${inv.id} ‚Äì R ${inv.total?.toFixed(2) || inv.total} (${getInvoiceStatusLabel(inv)})${periodLabel}${countLabel}`
        });
      });

      state.documents.filter(doc => doc.studentId === studentId).forEach(doc => {
        events.push({
          date: doc.date || doc.createdAt || new Date().toISOString().slice(0, 10),
          type: typeDocument,
          description: `${doc.title} [${doc.status}]`
        });
      });

      state.studentCheckins.filter(note => note.studentId === studentId).forEach(note => {
        events.push({
          date: note.date || new Date().toISOString().slice(0, 10),
          type: typeCheckin,
          description: note.text
        });
      });

      state.contracts.filter(c => c.studentId === studentId).forEach(c => {
        const contractStatus = c.status === 'Signed' ? t('contract.status_signed') : t('contract.status_pending');
        events.push({
          date: c.uploadedAt || new Date().toISOString().slice(0, 10),
          type: typeContract,
          description: `${t('contract.label')} [${contractStatus}]`
        });
      });

      events.sort((a, b) => new Date(b.date) - new Date(a.date));

      if (!events.length) {
        ul.innerHTML = `<li class="text-slate-500">${esc(t('students.timeline_empty'))}</li>`;
        return;
      }

      ul.innerHTML = events.map(ev => `
        <li class="flex items-start gap-2">
          <div class="mt-1 h-2 w-2 rounded-full ${ev.type === 'Session' ? 'bg-indigo-500' :
          ev.type === 'Invoice' ? 'bg-emerald-500' :
            ev.type === 'Document' ? 'bg-amber-500' :
              'bg-slate-400'}"></div>
          <div>
            <div class="text-[10px] text-slate-500">${esc(ev.date)} ‚Ä¢ ${esc(ev.type)}</div>
            <div>${esc(ev.description)}</div>
          </div>
        </li>
      `).join('');
    }

    function renderStudentSessions(studentId) {
      const ul = document.getElementById('studentSessionsList');
      const sessions = state.sessions.filter(sess => sess.studentIds.includes(studentId))
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      if (!sessions.length) {
        ul.innerHTML = `<li class="text-slate-500">${esc(t('students.sessions_empty'))}</li>`;
        return;
      }
      ul.innerHTML = sessions.map(sess => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 flex justify-between items-center bg-white/80">
          <div>
            <div class="font-medium">${esc(sess.subject)} ‚Äì ${esc(sess.topic || t('common.lesson'))}</div>
            <div class="text-[10px] text-slate-500">${esc(sess.date)} ‚Ä¢ ${esc(sess.startTime || '')} ‚Ä¢ ${esc(sess.durationHours || 1)}h</div>
            ${(() => {
              const st = getSessionStatus(sess);
              if (st === SESSION_STATUS.COMPLETE) return `<div class="text-[10px] text-emerald-600">${esc(t('schedule.completed'))}</div>`;
              if (st === SESSION_STATUS.PENDING_REVIEW) return `<div class="text-[10px] text-amber-700">${esc(t('schedule.pending_review'))}</div>`;
              if (st === SESSION_STATUS.NO_SHOW_CHARGEABLE) return `<div class="text-[10px] text-indigo-700">${esc(t('schedule.no_show_chargeable'))}</div>`;
              if (st === SESSION_STATUS.VOIDED) return `<div class="text-[10px] text-slate-600">${esc(t('schedule.voided'))}</div>`;
              if (st === SESSION_STATUS.RESTORED) return `<div class="text-[10px] text-teal-700">${esc(t('schedule.restored'))}</div>`;
              return '';
            })()}
          </div>
            <button data-owner-only class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                    onclick="if(guardEdit()) openSessionModal(getSessionById('${cleanId(sess.id)}'))">
            ${t('common.edit')}
          </button>
        </li>
      `).join('');
    }

    function renderStudentDocuments(studentId) {
      const ul = document.getElementById('studentDocumentsList');
      const docs = state.documents.filter(doc => doc.studentId === studentId);
      if (!docs.length) {
        ul.innerHTML = `<li class="text-slate-500">${esc(t('students.documents_empty'))}</li>`;
        return;
      }
      ul.innerHTML = docs.map(doc => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 flex justify-between items-center bg-white/85">
          <div>
            <div class="font-medium">${esc(doc.title)}</div>
            <div class="text-[10px] text-slate-500">${esc(doc.status)} ‚Ä¢ ${esc(doc.date || '')}</div>
          </div>
          <button data-owner-only class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                  onclick="if(guardEdit()) openDocumentModal(getDocumentById('${cleanId(doc.id)}'))">
            ${t('common.edit')}
          </button>
        </li>
      `).join('');
    }

    function renderStudentFinance(studentId) {
      const ul = document.getElementById('studentInvoicesList');
      const showVoided = !!state.settings.showVoidedInvoices;
      const invs = state.invoices.filter(inv => inv.studentId === studentId && (showVoided || !isInvoiceVoid(inv)))
        .sort((a, b) => new Date(b.issueDate) - new Date(a.issueDate));
      let balance = 0;
      invs.forEach(inv => {
        if (invoiceRequiresPayment(inv)) balance += Number(inv.total || 0);
      });
      const balanceLabel = balance > 0 ? t('finance.owed_balance') : t('finance.balance');
      document.getElementById('studentBalance').textContent = `${balanceLabel}: R ${balance.toFixed(2)}`;
      if (!invs.length) {
        ul.innerHTML = `<li class="text-slate-500">${esc(t('students.invoices_empty'))}</li>`;
        return;
      }
      ul.innerHTML = invs.map(inv => {
        const methodLabel = getInvoicePaymentLabel(inv);
        const safeInvId = cleanId(inv.id);
        return `
        <li class="border border-slate-200 rounded-lg px-2 py-1 flex justify-between items-center bg-white/80">
          <div>
            <div class="font-medium">${esc(inv.id)}</div>
            <div class="text-[10px] text-slate-500">
              ${esc(t('invoice.issued_label'))} ${esc(inv.issueDate)} ‚Ä¢ ${esc(t('invoice.due_label'))} ${esc(inv.dueDate || t('common.na'))}
              ${inv.servicePeriodStart && inv.servicePeriodEnd ? ` ‚Ä¢ ${esc(t('invoice.period_label'))} ${esc(inv.servicePeriodStart)} ‚Üí ${esc(inv.servicePeriodEnd)}` : ''}
              ${inv.numSessions ? ` ‚Ä¢ ${esc(inv.numSessions)} ${esc(inv.numSessions === 1 ? t('common.session') : t('common.sessions'))}` : ''}
              ‚Ä¢ ${esc(t('invoice.total_label'))} R ${esc(Number(inv.total || 0).toFixed(2))}
              ‚Ä¢ ${esc(getInvoiceStatusLabel(inv))}
              ${methodLabel ? ` ‚Ä¢ ${esc(methodLabel)}` : ''}
              ${(inv.invoiceType || inv.invoice_type) === 'adjustment' ? ` ‚Ä¢ ${esc(t('invoice.adjustment'))}` : ''}
              ${(inv.invoiceType || inv.invoice_type) === 'refund' ? ` ‚Ä¢ ${esc(t('invoice.refund'))}` : ''}
              ${inv.lateApplied && inv.lateFeePercent ? ` ‚Ä¢ ${esc(t('invoice.late_fee_label'))} ${esc(inv.lateFeePercent)}%` : ''}
              ${inv.shortApplied && inv.shortNoticePercent ? ` ‚Ä¢ ${esc(t('invoice.short_notice_label'))} ${esc(inv.shortNoticePercent)}%` : ''}
            </div>
          </div>
          <button data-owner-only class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                  onclick="if(guardEdit()) openInvoiceModal(getInvoiceById('${safeInvId}'))">
            ${t('common.edit')}
          </button>
        </li>
      `;
      }).join('');
    }

    function renderStudentTodos(studentId) {
      const list = document.getElementById('studentTodosList');
      if (!list) return;
      const todos = state.studentTodos.filter(t => t.studentId === studentId);
      if (!todos.length) {
        list.innerHTML = `<li class="text-slate-500">${esc(t('students.followups_empty'))}</li>`;
        return;
      }
      list.innerHTML = todos.map(t => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 flex justify-between items-center bg-white/80">
          <div>
            <div class="${t.done ? 'line-through text-slate-400' : ''}">${esc(t.text)}</div>
            <div class="text-[10px] text-slate-500">${esc(t.dueDate ? t('common.due', { date: t.dueDate }) : t('students.no_due_date'))}</div>
          </div>
          <div class="flex gap-1">
            <button class="text-[10px] px-2 py-0.5 rounded-lg border border-slate-300"
                    onclick="toggleTodoStatus('${cleanId(t.id)}')">${t.done ? t('common.undo') : t('common.done')}</button>
            <button class="text-[10px] px-2 py-0.5 rounded-lg border border-rose-200 text-rose-600"
                    onclick="deleteTodo('${cleanId(t.id)}')">‚úï</button>
          </div>
        </li>
      `).join('');
    }

    function toggleTodoStatus(todoId) {
      const todo = state.studentTodos.find(t => t.id === todoId);
      if (!todo) return;
      todo.done = !todo.done;
      saveState();
      if (selectedStudentId) renderStudentTodos(selectedStudentId);
    }

    function deleteTodo(todoId) {
      if (!guardEdit()) return;
      state.studentTodos = state.studentTodos.filter(t => t.id !== todoId);
      saveState();
      if (selectedStudentId) renderStudentTodos(selectedStudentId);
    }

    function renderStudentContracts(studentId) {
      const list = document.getElementById('studentContractsList');
      if (!list) return;
      const contracts = state.contracts
        .filter(c => c.studentId === studentId)
        .sort((a, b) => new Date(b.uploadedAt || 0) - new Date(a.uploadedAt || 0));
      // If no contract record but a signature exists with a rendered URL, surface it as a synthetic entry
      const sig = getLatestSignature(studentId);
      if (sig && !contracts.find(c => c.id === sig.id)) {
        contracts.unshift({
          id: sig.id,
          studentId,
          fileName: 'signed_contract.pdf',
          status: 'Signed',
          uploadedAt: sig.signedAt || '',
          signedUrl: ''
        });
      }
      if (!contracts.length) {
        list.innerHTML = `<li class="text-slate-500">${esc(t('students.contracts_empty'))}</li>`;
        return;
      }
      list.innerHTML = contracts.map(c => {
        const signature = getSignatureById(c.id);
        const hasFile = !!(c.storage_path || c.signedUrl || signature?.renderedPdfUrl || signature?.rendered_pdf_url);
        const textSnapshot = signature?.contractTextSnapshot || c.contractTextSnapshot || '';
        const hasText = !!textSnapshot;
        const safeTextName = esc((c.fileName || t('contract.file_default')).replace(/\.pdf$/i, '.txt'));
        const textUrl = hasText ? buildContractTextDataUrl(textSnapshot) : '';
        const safeContractId = cleanId(c.id);
        const viewLink = hasFile
          ? `<button class="text-[10px] px-2 py-0.5 rounded-lg border border-slate-300 hover:bg-slate-50" onclick="openContractFile('${safeContractId}')">${t('common.view')}</button>`
          : (hasText ? `<button class="text-[10px] px-2 py-0.5 rounded-lg border border-slate-300 hover:bg-slate-50" onclick="openContractSnapshotModal('${cleanId(c.id)}')">${t('common.view')}</button>` : '');
        const downloadLink = hasFile
          ? `<button class="text-[10px] px-2 py-0.5 rounded-lg border border-slate-300 hover:bg-slate-50" onclick="downloadContractFile('${safeContractId}')">${t('common.download')}</button>`
          : (hasText ? `<a class="text-[10px] px-2 py-0.5 rounded-lg border border-slate-300 hover:bg-slate-50" href="${textUrl}" download="${safeTextName}">${t('common.download')}</a>` : '');
        const statusLabel = c.status === 'Signed' ? t('contract.status_signed') : t('contract.status_pending');
        return `
        <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
          <div>
            <div class="font-medium flex items-center gap-1">${esc(t('contract.label'))} <span class="text-[10px] px-2 py-0.5 rounded-full ${c.status === 'Signed' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${esc(statusLabel)}</span></div>
            <div class="text-[10px] text-slate-500">${t('contract.uploaded_label')} ${esc(c.uploadedAt || '')}</div>
            ${(!hasFile && !hasText) ? `<div class="text-[10px] text-amber-600">${t('contract.signed_missing')}</div>` : ''}
          </div>
          <div class="flex gap-1">
            ${viewLink}
            ${downloadLink}
            <button data-owner-only class="text-[10px] px-2 py-0.5 rounded-lg border border-emerald-300 text-emerald-700"
                    onclick="if(guardEdit()) markContractStatus('${safeContractId}', '${c.status === 'Signed' ? 'Pending' : 'Signed'}')">
              ${c.status === 'Signed' ? t('contract.mark_pending') : t('contract.mark_signed')}
            </button>
          </div>
        </li>
      `;
      }).join('');
    }

    function renderStudentCheckins(studentId) {
      const list = document.getElementById('studentCheckinsList');
      if (!list) return;
      const notes = state.studentCheckins
        .filter(n => n.studentId === studentId)
        .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
      if (!notes.length) {
        list.innerHTML = `<li class="text-slate-500">${esc(t('students.checkins_empty'))}</li>`;
        return;
      }
      list.innerHTML = notes.map(n => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
          <div class="text-[10px] text-slate-500">${esc(n.date)}</div>
          <div>${esc(n.text)}</div>
        </li>
      `).join('');
    }

    function renderStudentMessages(studentId) {
      const list = document.getElementById('studentMessagesList');
      if (!list) return;
      const msgs = state.messages
        .filter(m => m.studentId === studentId)
        .sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
      if (!msgs.length) {
        list.innerHTML = `<li class="text-slate-500">${esc(t('students.messages_empty'))}</li>`;
        return;
      }
      list.innerHTML = msgs.map(m => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
          <div class="flex items-center justify-between text-[10px] text-slate-500">
            <span>${m.sender === 'owner' ? t('messages.tutor') : t('common.student')}</span>
            <span>${esc(m.created_at ? new Date(m.created_at).toLocaleString() : '')}</span>
          </div>
          <div>${esc(m.text)}</div>
        </li>
      `).join('');
    }

    function openContractUpload(studentId) {
      const student = getStudentById(studentId);
      if (!student) return;
      if (!guardEdit()) return;
      const html = `
        <h2 class="text-sm font-semibold mb-3">Upload contract for ${esc(student.name)}</h2>
        <form id="contractForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Contract file (PDF or image)</label>
            <input type="file" name="file" accept=".pdf,image/*" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Status</label>
            <select name="status" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              <option value="Pending">Pending</option>
              <option value="Signed">Signed</option>
            </select>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Notes</label>
            <textarea name="notes" rows="2" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]" placeholder="Optional notes" data-i18n-attr="placeholder:form.notes_optional"></textarea>
          </div>
          <button type="submit" class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-xs font-medium">Upload</button>
        </form>
        <p class="hint mt-2">If signed in, files go to Supabase Storage; otherwise they stay local (base64).</p>
      `;
      openModal(html, () => {
        const form = document.getElementById('contractForm');
        form.onsubmit = (e) => {
          e.preventDefault();
          const file = form.file.files[0];
          const status = form.status.value;
          const notes = form.notes.value.trim();
          if (!file) {
            alert(t('alert.select_pdf_image'));
            return;
          }
          if (isSupabaseReady()) {
            uploadContractToSupabase(studentId, file, status, notes)
              .then(() => {
                closeModal();
                renderStudentContracts(studentId);
                renderStudentTimeline(studentId);
              })
              .catch(err => {
                console.error(err);
                alert(t('alert.upload_failed_console'));
              });
          } else {
            const reader = new FileReader();
            reader.onload = () => {
              state.contracts.push({
                id: generateId('contract'),
                studentId,
                fileName: file.name,
                dataUrl: reader.result,
                status,
                notes,
                uploadedAt: new Date().toISOString().slice(0, 10)
              });
              saveState();
              closeModal();
              renderStudentContracts(studentId);
              renderStudentTimeline(studentId);
            };
            reader.readAsDataURL(file);
          }
        };
      });
    }

    async function uploadContractToSupabase(studentId, file, status, notes) {
      const uid = supabaseSession?.user?.id;
      if (!uid) throw new Error('No session');
      const ext = file.name.includes('.') ? file.name.split('.').pop() : 'bin';
      // Object key must NOT include bucket name; folder prefix is the user id for RLS.
      const path = `${uid}/${generateId('file')}.${ext}`;
      const { error: uploadErr } = await supabaseClient.storage.from('contracts').upload(path, file, { upsert: false });
      if (uploadErr) throw uploadErr;
      const contract = {
        id: generateId('contract'),
        studentId,
        user_id: uid,
        fileName: file.name,
        storage_path: path,
        status,
        notes,
        uploadedAt: new Date().toISOString().slice(0, 10),
        signedUrl: signed?.signedUrl
      };
      state.contracts.push(contract);
      saveState();
    }

    function markContractStatus(contractId, status) {
      const c = state.contracts.find(ct => ct.id === contractId);
      if (!c) return;
      c.status = status;
      // Update student contract flags when toggling status
      const stu = getStudentById(c.studentId);
      if (stu) {
        if (status === 'Signed') {
          stu.contractSigned = true;
          stu.contractSignedAt = new Date().toISOString();
          stu.lastContractId = contractId;
          refreshAutoBilling();
        } else {
          stu.contractSigned = false;
          stu.contractSignedAt = null;
          stu.contractSignerName = '';
          stu.contractSignerEmail = '';
          stu.lastContractId = null;
        }
      }
      saveState();
      if (selectedStudentId) {
        renderStudentContracts(selectedStudentId);
        renderStudentTimeline(selectedStudentId);
        renderStudentsView();
      }
      // Persist to Supabase
      if (isSupabaseReady()) {
        supabaseClient.from('contracts').update({ status }).eq('id', contractId).catch(err => {
          console.warn('Contract status update failed', err);
        });
        if (stu) {
          supabaseClient.from('students').update({
            contract_signed: status === 'Signed',
            contract_signed_at: status === 'Signed' ? stu.contractSignedAt : null,
            last_contract_id: status === 'Signed' ? contractId : null
          }).eq('id', stu.id).catch(err => console.warn('Student contract flag update failed', err));
        }
      }
    }

    /**************
     * SCHEDULE   *
     **************/
    let currentWeekStart = getMonday(new Date());

    function getMonday(d) {
      const date = new Date(d);
      const day = date.getDay();
      const diff = (day === 0 ? -6 : 1 - day);
      date.setDate(date.getDate() + diff);
      date.setHours(0, 0, 0, 0);
      return date;
    }

    function getScheduleVisibleSessions() {
      if (parentMode) {
        const parent = getParentProfileBySession();
        const students = parent ? getParentLinkedStudents(parent.id) : getChildrenForParent();
        const ids = new Set(students.map(s => s.id));
        return state.sessions
          .filter(s => s.studentIds.some(id => ids.has(id)))
          .filter(s => {
            const inv = s.invoiceId ? getInvoiceById(s.invoiceId) : null;
            if (inv && inv.paid && !isInvoiceVoid(inv)) return true;
            // If the session isn't linked yet, still show it once a paid invoice covers that date
            // (prevents missing Join buttons when invoice was paid but the session didn't store invoice_id).
            return (s.studentIds || []).some(id => ids.has(id) && hasPaidInvoiceForDate(id, s.date));
          });
      }
      if (studentMode) {
        const student = getStudentProfileBySession();
        if (student) {
          return state.sessions
            .filter(s => s.studentIds.includes(student.id))
            .filter(s => {
              const inv = s.invoiceId ? getInvoiceById(s.invoiceId) : null;
              if (inv && inv.paid && !isInvoiceVoid(inv)) return true;
              return hasPaidInvoiceForDate(student.id, s.date);
            });
        }
      }
      return state.sessions;
    }

    function normalizeBusyNote(note) {
      return String(note || '').replace(/\s+/g, ' ').trim();
    }

    function getBusyDay(dateStr) {
      const target = String(dateStr || '').slice(0, 10);
      return state.busyDays.find(b => b.date === target);
    }

    function isBusyDate(dateStr) {
      return !!getBusyDay(dateStr);
    }

    function addBusyDay(dateStr, note = '') {
      const target = String(dateStr || '').slice(0, 10);
      if (!target || isBusyDate(target)) return false;
      state.busyDays.push({
        id: generateId('busy'),
        date: target,
        note: normalizeBusyNote(note),
        createdAt: new Date().toISOString()
      });
      return true;
    }

    function removeBusyDay(dateStr) {
      const target = String(dateStr || '').slice(0, 10);
      const before = state.busyDays.length;
      state.busyDays = state.busyDays.filter(b => b.date !== target);
      return state.busyDays.length !== before;
    }

    function recalcInvoicesForBusyDays() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      let changed = false;
      state.invoices.forEach(inv => {
        if ((inv.invoiceType || inv.invoice_type) !== 'monthly') return;
        if (inv.paid || isInvoiceVoid(inv)) return;
        const student = getStudentById(inv.studentId);
        if (!student) return;
        if (recalculateMonthlyInvoice(inv, student, today)) changed = true;
      });
      return changed;
    }

    async function toggleBusyDay(dateStr) {
      const target = String(dateStr || '').slice(0, 10);
      if (!target) return;
      const existing = getBusyDay(target);
      if (existing) {
        if (!confirm(t('confirm.clear_busy_day', { date: target }))) return;
        removeBusyDay(target);
        if (isSupabaseReady()) {
          let deleted = true;
          try {
            const uid = supabaseSession?.user?.id;
            let del = supabaseClient.from('busy_days').delete().eq('date', target);
            if (uid) del = del.eq('user_id', uid);
            if (existing.id) del = del.eq('id', existing.id);
            const { error } = await del;
            if (error) {
              deleted = false;
              console.warn('Busy day delete failed', error);
            }
          } catch (err) {
            deleted = false;
            console.warn('Busy day delete failed', err);
          }
          if (!deleted) {
            if (!getBusyDay(target)) state.busyDays.push(existing);
            alert(t('alert.busy_clear_failed'));
          }
        }
      } else {
        const note = prompt(t('prompt.busy_note'), '') || '';
        addBusyDay(target, note);
      }
      recalcInvoicesForBusyDays();
      saveState();
      renderScheduleView();
      renderStudentPortal();
      renderParentPortal();
    }

    function getUpcomingBusyDays(limitDays = 30) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const cutoff = new Date(today);
      cutoff.setDate(cutoff.getDate() + Number(limitDays || 30));
      const startStr = toDateOnly(today);
      const endStr = toDateOnly(cutoff);
      return state.busyDays
        .filter(b => b.date >= startStr && b.date <= endStr)
        .sort((a, b) => a.date.localeCompare(b.date));
    }

    function renderScheduleView() {
      const scheduleSessions = getScheduleVisibleSessions();
      const label = document.getElementById('scheduleWeekLabel');
      const end = new Date(currentWeekStart);
      end.setDate(end.getDate() + 6);
      label.textContent = `${toDateOnly(currentWeekStart)} ‚Äì ${toDateOnly(end)}`;

      const grid = document.getElementById('scheduleCalendarGrid');
      const dayLoadRow = document.getElementById('dayLoadRow');
      const dayLoads = [];
      grid.innerHTML = '';
      for (let i = 0; i < 7; i++) {
        const day = new Date(currentWeekStart);
        day.setDate(day.getDate() + i);
        const isoDate = toDateOnly(day);
        const sessions = scheduleSessions.filter(s => s.date === isoDate);
        const totalHours = sessions.filter(s => !isSessionVoided(s)).reduce((acc, s) => acc + Number(s.durationHours || 0), 0);
        const dayName = getDayShortLabel(i);
        dayLoads.push({ totalHours, dayName });
        const busyEntry = getBusyDay(isoDate);
        const isBusy = !!busyEntry;
        const canEditBusy = !parentMode && !studentMode;
        const busyAction = canEditBusy
          ? `<button class="text-[9px] px-2 py-0.5 rounded-full border ${isBusy ? 'border-rose-300 text-rose-700 bg-rose-50' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}" onclick="toggleBusyDay('${isoDate}')">
              ${isBusy ? esc(t('schedule.clear_busy')) : esc(t('schedule.mark_busy'))}
            </button>`
          : (isBusy ? `<span class="busy-badge">${esc(t('schedule.busy'))}</span>` : '');
        const busyNote = isBusy
          ? `<div class="mt-1 text-[10px] text-rose-600">${busyEntry?.note ? t('schedule.busy_note', { note: esc(busyEntry.note) }) : esc(t('schedule.tutor_busy_on_date'))}</div>`
          : '';
        grid.innerHTML += `
          <div class="calendar-day ${isBusy ? 'busy-day' : ''}" data-date="${esc(isoDate)}">
            <div class="calendar-day-header mb-1">
              <div class="calendar-day-title">
                <span class="font-semibold">${dayName}</span>
                <span class="text-[10px] text-slate-500 whitespace-nowrap">${isoDate}</span>
              </div>
              <div class="calendar-day-action">${busyAction}</div>
            </div>
            ${busyNote}
            <div class="space-y-1 text-[11px]">
              ${sessions.map(s => {
          const subjectClass = s.subject === 'Physics'
            ? 'text-indigo-700'
            : s.subject === 'Chemistry'
              ? 'text-emerald-700'
              : 'text-rose-700';
          const names = esc(s.studentIds.map(id => getStudentById(id)?.name || t('common.unknown')).join(', '));
          const status = getSessionStatus(s);
          const statusClass = status === SESSION_STATUS.COMPLETE
            ? 'completed'
            : status === SESSION_STATUS.PENDING_REVIEW
              ? 'pending-review'
              : status === SESSION_STATUS.VOIDED
                ? 'voided'
                : status === SESSION_STATUS.NO_SHOW_CHARGEABLE
                  ? 'no-show-chargeable'
                  : '';
          const modeLabel = isOnlineSession(s) ? t('schedule.online') : t('schedule.in_person');
          const modeClass = isOnlineSession(s) ? 'session-chip-online' : 'session-chip-inperson';
          const attendedChip = (status !== SESSION_STATUS.COMPLETE && s.attended) ? `<span class="session-chip session-chip-attended">${esc(t('schedule.attended'))}</span>` : '';
          const completedChip = status === SESSION_STATUS.COMPLETE ? `<span class="session-chip session-chip-completed">${esc(t('schedule.completed'))}</span>` : '';
          const restoredChip = status === SESSION_STATUS.RESTORED ? `<span class="session-chip session-chip-restored">${esc(t('schedule.restored'))}</span>` : '';
          const pendingChip = status === SESSION_STATUS.PENDING_REVIEW ? `<span class="session-chip session-chip-pending-review">${esc(t('schedule.pending_review'))}</span>` : '';
          const voidedChip = status === SESSION_STATUS.VOIDED ? `<span class="session-chip session-chip-voided">${esc(t('schedule.voided'))}</span>` : '';
          const noShowChip = status === SESSION_STATUS.NO_SHOW_CHARGEABLE ? `<span class="session-chip session-chip-no-show">${esc(t('schedule.no_show_chargeable'))}</span>` : '';
          const busyChip = isBusy ? `<span class="session-chip session-chip-busy">${esc(t('schedule.busy_date'))}</span>` : '';
          const safeSessionId = cleanId(s.id);
          return `<div class="session-card ${statusClass} cursor-pointer" onclick="openSessionQuickActions('${safeSessionId}')">
                            <div class="flex items-center justify-between">
                              <span class="session-time ${subjectClass}">${esc(s.startTime || '')}</span>
                              <span class="text-[10px] text-slate-500">${esc(s.durationHours ? `${Number(s.durationHours).toFixed(1)}h` : '')}</span>
                            </div>
                            <div class="text-[11px] font-semibold text-slate-800">${names}</div>
                            <div class="text-[10px] text-slate-600 leading-snug">${esc(s.topic || '')}</div>
                            <div class="session-chip-row session-chip-row-center mt-1">
                              ${attendedChip}
                              ${completedChip}
                              ${restoredChip}
                              ${pendingChip}
                              ${voidedChip}
                              ${noShowChip}
                              ${busyChip}
                              <span class="session-chip ${modeClass}">${esc(modeLabel)}</span>
                              <span class="session-chip ${subjectClass}">${esc(s.subject)}</span>
                            </div>
                          </div>`;
        }).join('')
          }
            </div>
          </div>
        `;
      }
      if (dayLoadRow) {
        const maxLoad = Math.max(...dayLoads.map(d => d.totalHours), 1);
        dayLoadRow.innerHTML = dayLoads.map(dl => {
          const pct = maxLoad ? Math.min(100, (dl.totalHours / maxLoad) * 100) : 0;
          return `<div class="flex flex-col gap-1">
            <div class="text-[10px] font-semibold">${dl.dayName}</div>
            <div class="w-full bg-slate-100 rounded-full h-2">
              <div class="h-2 rounded-full bg-indigo-500" style="width:${pct}%"></div>
            </div>
            <div class="text-[10px] text-slate-500">${dl.totalHours.toFixed(1)}h</div>
          </div>`;
        }).join('');
      }

      document.getElementById('schedulePrevWeek').onclick = () => {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        renderScheduleView();
      };
      document.getElementById('scheduleNextWeek').onclick = () => {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        renderScheduleView();
      };
      document.getElementById('scheduleToday').onclick = () => {
        currentWeekStart = getMonday(new Date());
        renderScheduleView();
      };
      const exportBtn = document.getElementById('exportIcsBtn');
      if (exportBtn) exportBtn.onclick = downloadIcsFile;

      const todayIso = toDateOnly(new Date());
      const todayList = document.getElementById('todaySessionsList');
      const todaySessions = scheduleSessions.filter(s => s.date === todayIso)
        .sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));
      if (!todaySessions.length) {
        todayList.innerHTML = `<li class="text-slate-500">${esc(t('schedule.no_sessions_today'))}</li>`;
      } else {
        todayList.innerHTML = todaySessions.map(s => {
          const names = esc(s.studentIds.map(id => getStudentById(id)?.name || t('common.unknown')).join(', '));
          const status = getSessionStatus(s);
          const statusClass = status === SESSION_STATUS.COMPLETE
            ? 'completed'
            : status === SESSION_STATUS.PENDING_REVIEW
              ? 'pending-review'
              : status === SESSION_STATUS.VOIDED
                ? 'voided'
                : status === SESSION_STATUS.NO_SHOW_CHARGEABLE
                  ? 'no-show-chargeable'
                  : '';
          const modeLabel = isOnlineSession(s) ? t('schedule.online') : t('schedule.in_person');
          const modeClass = isOnlineSession(s) ? 'session-chip-online' : 'session-chip-inperson';
          const attendedChip = (status !== SESSION_STATUS.COMPLETE && s.attended) ? `<span class="session-chip session-chip-attended">${esc(t('schedule.attended'))}</span>` : '';
          const completedChip = status === SESSION_STATUS.COMPLETE ? `<span class="session-chip session-chip-completed">${esc(t('schedule.completed'))}</span>` : '';
          const restoredChip = status === SESSION_STATUS.RESTORED ? `<span class="session-chip session-chip-restored">${esc(t('schedule.restored'))}</span>` : '';
          const pendingChip = status === SESSION_STATUS.PENDING_REVIEW ? `<span class="session-chip session-chip-pending-review">${esc(t('schedule.pending_review'))}</span>` : '';
          const voidedChip = status === SESSION_STATUS.VOIDED ? `<span class="session-chip session-chip-voided">${esc(t('schedule.voided'))}</span>` : '';
          const noShowChip = status === SESSION_STATUS.NO_SHOW_CHARGEABLE ? `<span class="session-chip session-chip-no-show">${esc(t('schedule.no_show_chargeable'))}</span>` : '';
          const busyChip = isBusyDate(s.date) ? `<span class="session-chip session-chip-busy">${esc(t('schedule.busy_date'))}</span>` : '';
          const safeSessionId = cleanId(s.id);
          return `<li class="session-card ${statusClass}">
            <div class="flex items-center justify-between">
              <div class="text-[10px] uppercase tracking-wide text-slate-500">${esc(s.subject)}</div>
              <div class="session-time">${esc(s.startTime || '')}</div>
            </div>
            <div class="text-[11px] font-semibold text-slate-800">${names}</div>
            <div class="text-[10px] text-slate-600">${esc(s.topic || '')} ‚Ä¢ ${esc(s.durationHours || 1)}h</div>
            <div class="session-chip-row mt-1">
              ${attendedChip}
              ${completedChip}
              ${restoredChip}
              ${pendingChip}
              ${voidedChip}
              ${noShowChip}
              ${busyChip}
              <span class="session-chip ${modeClass}">${esc(modeLabel)}</span>
            </div>
            <button class="mt-1 text-[10px] px-2 py-0.5 rounded-lg border border-slate-300 hover:bg-slate-50"
                    onclick="openSessionQuickActions('${safeSessionId}')">
              ${esc(t('common.open'))}
            </button>
          </li>`;
        }).join('');
      }

      renderClashes();
      renderTightTransitions();
    }

    function renderClashes() {
      const ul = document.getElementById('clashList');
      const clashes = [];
      const sessions = [...getScheduleVisibleSessions()].sort((a, b) => (a.date + 'T' + (a.startTime || '00:00')).localeCompare(b.date + 'T' + (b.startTime || '00:00')));
      for (let i = 0; i < sessions.length; i++) {
        for (let j = i + 1; j < sessions.length; j++) {
          const a = sessions[i], b = sessions[j];
          if (a.date !== b.date) continue;
          const aStart = timeToMinutes(a.startTime || '00:00');
          const aEnd = aStart + Number(a.durationHours || 1) * 60;
          const bStart = timeToMinutes(b.startTime || '00:00');
          const bEnd = bStart + Number(b.durationHours || 1) * 60;
          if (aEnd <= bStart || bEnd <= aStart) continue;
          const sharedStudents = a.studentIds.filter(id => b.studentIds.includes(id));
          if (sharedStudents.length) {
            clashes.push({ a, b, sharedStudents });
          }
        }
      }
      if (!clashes.length) {
        ul.innerHTML = `<li class="text-slate-500">${esc(t('schedule.no_clashes'))}</li>`;
        return;
      }
      ul.innerHTML = clashes.slice(0, 10).map(c => {
        const names = esc(c.sharedStudents.map(id => getStudentById(id)?.name || t('common.unknown')).join(', '));
        return `<li class="border border-amber-300 bg-amber-50 text-amber-900 rounded-lg px-2 py-1">
          <div class="font-medium">${esc(t('schedule.clash_for', { names }))}</div>
          <div class="text-[10px]">
            ${esc(c.a.date)} ‚Ä¢ ${esc(c.a.startTime || '')} vs ${esc(c.b.startTime || '')}<br>
            ${esc(c.a.subject)} ‚Äì ${esc(c.a.topic || t('common.lesson'))} <br>
            ${esc(c.b.subject)} ‚Äì ${esc(c.b.topic || t('common.lesson'))}
          </div>
        </li>`;
      }).join('');
    }

    function renderTightTransitions() {
      const list = document.getElementById('tightTransitionsList');
      const byDate = {};
      getScheduleVisibleSessions().forEach(s => {
        if (!byDate[s.date]) byDate[s.date] = [];
        byDate[s.date].push(s);
      });
      const tight = [];
      Object.keys(byDate).forEach(date => {
        const sessions = byDate[date].sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));
        for (let i = 0; i < sessions.length - 1; i++) {
          const currentEnd = timeToMinutes(sessions[i].startTime || '00:00') + Number(sessions[i].durationHours || 1) * 60;
          const nextStart = timeToMinutes(sessions[i + 1].startTime || '00:00');
          const gap = nextStart - currentEnd;
          if (gap >= 0 && gap < 20) {
            tight.push({ a: sessions[i], b: sessions[i + 1], gap, date });
          }
        }
      });
      if (!tight.length) {
        list.innerHTML = `<li class="text-slate-500">${esc(t('schedule.no_tight_transitions'))}</li>`;
        return;
      }
      list.innerHTML = tight.slice(0, 6).map(item => {
        const aNames = esc(item.a.studentIds.map(id => getStudentById(id)?.name || t('common.unknown')).join(', '));
        const bNames = esc(item.b.studentIds.map(id => getStudentById(id)?.name || t('common.unknown')).join(', '));
        return `<li class="border border-amber-200 bg-amber-50 rounded-lg px-2 py-1">
          <div class="font-medium">${esc(t('schedule.min_gap', { minutes: item.gap }))}</div>
          <div class="text-[10px]">${esc(item.date)}: ${esc(item.a.startTime || '')} ${aNames} ‚Üí ${esc(item.b.startTime || '')} ${bNames}</div>
        </li>`;
      }).join('');
    }

    function timeToMinutes(t) {
      const [h, m] = t.split(':').map(Number);
      return h * 60 + m;
    }

    function getScheduleAnchorDate(student) {
      const prefs = getSchedulePrefs(student);
      const signedRaw = student.contractSignedAt || '';
      let anchor = parseDateOnly(signedRaw) || new Date();
      const start = parseDateOnly(prefs.scheduleStartDate);
      if (start && start > anchor) anchor = start;
      anchor.setHours(0, 0, 0, 0);
      return anchor;
    }

    function findFirstScheduleDate(slots, start, end) {
      const dates = listScheduleOccurrences(slots, start, end);
      return dates[0]?.date || '';
    }

    function generateInvoiceIdForPeriod(studentId, periodStart) {
      const monthTag = (periodStart || '').replace(/-/g, '').slice(0, 6) || 'INV';
      const suffix = Math.random().toString(36).slice(2, 6).toUpperCase();
      return `INV-${monthTag}-${suffix}`;
    }

    function getInvoiceMonthKey(inv) {
      const raw = inv?.servicePeriodEnd || inv?.service_period_end || inv?.servicePeriodStart || inv?.service_period_start || inv?.issueDate || '';
      return raw ? String(raw).slice(0, 7) : '';
    }

    function getMonthKeyFromDate(d) {
      if (!d) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }

    function isDateWithinRange(dateStr, startStr, endStr) {
      if (!dateStr) return false;
      const date = parseDateOnly(dateStr);
      if (!date) return false;
      const start = parseDateOnly(startStr);
      const end = parseDateOnly(endStr);
      if (start && date < start) return false;
      if (end && date > end) return false;
      return true;
    }

    function getLinkedInvoiceSessions(inv, studentId, startStr, endStr) {
      return state.sessions.filter(s => {
        if (s.invoiceId !== inv.id) return false;
        if (!s.studentIds || !s.studentIds.includes(studentId)) return false;
        if (!s.date) return false;
        if (startStr || endStr) {
          return isDateWithinRange(s.date, startStr, endStr);
        }
        return true;
      });
    }

    function computeInvoiceBaseFromSessions(sessions, student) {
      const baseAmount = Number(sessions.reduce((sum, s) => {
        return sum + getSessionBillableAmount(s, student);
      }, 0).toFixed(2));
      return { numSessions: sessions.length, baseAmount };
    }

    function getMonthlyInvoiceBillables(inv, student) {
      const serviceStartStr = inv.servicePeriodStart || inv.service_period_start || '';
      const serviceEndStr = inv.servicePeriodEnd || inv.service_period_end || '';
      const sessionsInRange = state.sessions
        .filter(s => (s.studentIds || []).length === 1 && s.studentIds[0] === student.id)
        .filter(s => !!s.date && isDateWithinRange(s.date, serviceStartStr, serviceEndStr))
        .filter(s => !s.invoiceId || s.invoiceId === inv.id);
      const billable = sessionsInRange.filter(s => !isSessionVoided(s));
      if (billable.length) {
        return computeInvoiceBaseFromSessions(billable, student);
      }
      // Fallback for legacy states where sessions have not been created yet.
      const prefs = getSchedulePrefs(student);
      const serviceStart = parseDateOnly(serviceStartStr);
      const serviceEnd = parseDateOnly(serviceEndStr);
      if (!prefs.scheduleSlots.length || !serviceStart || !serviceEnd) return { numSessions: 0, baseAmount: 0 };
      const occurrences = listScheduleOccurrences(prefs.scheduleSlots, serviceStart, serviceEnd);
      const numSessions = occurrences.length;
      const baseAmount = Number(occurrences.reduce((sum, occ) => {
        const rate = Number(student.rate || 0);
        const hours = Number(occ.slot.durationHours || 0) || Number(state.settings.defaultSessionDuration || 1);
        return sum + rate * hours;
      }, 0).toFixed(2));
      return { numSessions, baseAmount };
    }

    function syncMonthlyInvoiceSessionLinks(inv, student) {
      if ((inv.invoiceType || inv.invoice_type) !== 'monthly' || isInvoiceVoid(inv)) return false;
      const startStr = inv.servicePeriodStart || inv.service_period_start || '';
      const endStr = inv.servicePeriodEnd || inv.service_period_end || '';
      if (!startStr || !endStr) return false;
      const locked = isInvoiceLocked(inv);
      let changed = false;
      state.sessions.forEach(s => {
        if (!s.studentIds || s.studentIds.length !== 1) return;
        if (s.studentIds[0] !== student.id) return;
        if (!s.date) return;
        const inRange = isDateWithinRange(s.date, startStr, endStr);
        if (inRange) {
          if (!s.invoiceId) {
            s.invoiceId = inv.id;
            changed = true;
          }
          return;
        }
        if (!locked && s.invoiceId === inv.id) {
          s.invoiceId = '';
          changed = true;
        }
      });
      return changed;
    }

    function seedUnpaidInvoiceSessions(inv, student) {
      // Deprecated: sessions are scheduled independently of invoices.
      return false;
    }

    function ensureMonthlyInvoiceForPeriod(student, periodStartDate, today) {
      const prefs = getSchedulePrefs(student);
      if (!student.contractSigned) return false;
      const periodStart = new Date(periodStartDate.getFullYear(), periodStartDate.getMonth(), 1);
      const periodEnd = endOfMonth(periodStart);
      const monthKey = getMonthKeyFromDate(periodStart);
      const serviceStart = toDateOnly(periodStart);
      const serviceEnd = toDateOnly(periodEnd);

      const existing = state.invoices.find(inv =>
        inv.studentId === student.id &&
        (inv.invoiceType || inv.invoice_type) === 'monthly' &&
        !isInvoiceVoid(inv) &&
        getInvoiceMonthKey(inv) === monthKey
      );

      const anchor = getScheduleAnchorDate(student);
      const scheduleStart = maxDate(anchor, periodStart);
      const expectedOccurrences = prefs.scheduleSlots.length
        ? listScheduleOccurrences(prefs.scheduleSlots, scheduleStart, periodEnd)
        : [];
      const sessionsInRange = state.sessions
        .filter(s => (s.studentIds || []).length === 1 && s.studentIds[0] === student.id)
        .filter(s => !!s.date && isDateWithinRange(s.date, serviceStart, serviceEnd));
      if (!existing && !sessionsInRange.length && !expectedOccurrences.length) return false;

      if (existing) {
        let changed = false;
        if (!existing.invoiceType) { existing.invoiceType = 'monthly'; changed = true; }
        if (!existing.autoGenerated) { existing.autoGenerated = true; changed = true; }
        if (!existing.paymentProvider) { existing.paymentProvider = PAYFAST_PROVIDER; changed = true; }
        // Monthly invoices should always cover calendar month boundaries.
        if (existing.servicePeriodStart !== serviceStart) { existing.servicePeriodStart = serviceStart; changed = true; }
        if (existing.servicePeriodEnd !== serviceEnd) { existing.servicePeriodEnd = serviceEnd; changed = true; }
        if (!existing.dueDate) { existing.dueDate = existing.servicePeriodStart || serviceStart; changed = true; }
        if (!existing.issueDate) { existing.issueDate = toDateOnly(today); changed = true; }
        const normalizedNote = `Monthly prepaid sessions (${existing.servicePeriodStart || serviceStart} to ${existing.servicePeriodEnd || serviceEnd}).`;
        if (!existing.notes || String(existing.notes).startsWith('Monthly prepaid sessions (')) {
          if (existing.notes !== normalizedNote) {
            existing.notes = normalizedNote;
            changed = true;
          }
        }
        if (!existing.invoiceStatus) {
          existing.invoiceStatus = existing.paid ? 'paid' : 'issued';
          changed = true;
        }

        if (!existing.paid) {
          if (recalculateMonthlyInvoice(existing, student, today)) changed = true;
        }
        return changed;
      }

      const billableSessions = sessionsInRange.filter(s => !isSessionVoided(s));
      let { numSessions, baseAmount } = billableSessions.length
        ? computeInvoiceBaseFromSessions(billableSessions, student)
        : { numSessions: 0, baseAmount: 0 };
      if (!numSessions) {
        numSessions = expectedOccurrences.length;
        if (!numSessions) return false;
        baseAmount = Number(expectedOccurrences.reduce((sum, occ) => {
          const rate = Number(student.rate || 0);
          const hours = Number(occ.slot.durationHours || 0) || Number(state.settings.defaultSessionDuration || 1);
          return sum + rate * hours;
        }, 0).toFixed(2));
      }
      const inv = {
        id: generateInvoiceIdForPeriod(student.id, serviceStart),
        studentId: student.id,
        issueDate: toDateOnly(today),
        dueDate: serviceStart,
        baseAmount,
        total: baseAmount,
        lateFeePercent: 0,
        shortNoticePercent: 0,
        lateApplied: false,
        shortApplied: false,
        paid: false,
        notes: `Monthly prepaid sessions (${serviceStart} to ${serviceEnd}).`,
        servicePeriodStart: serviceStart,
        servicePeriodEnd: serviceEnd,
        numSessions,
        invoiceType: 'monthly',
        autoGenerated: true,
        paidAt: '',
        paymentProvider: PAYFAST_PROVIDER,
        paymentMethod: '',
        invoiceStatus: 'issued',
        voidedAt: '',
        adjustmentReason: '',
        relatedSessionId: '',
        moveToDate: '',
        moveToTime: '',
        moveToDurationHours: 0,
        moveRequestedAt: '',
        moveAppliedAt: ''
      };
      state.invoices.push(inv);
      logActivity('Created invoice', inv.id);
      maybeNotifyInvoiceIssued(inv);
      return true;
    }

    function ensureMonthlyInvoiceForStudent(student, today) {
      const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
      let changed = ensureMonthlyInvoiceForPeriod(student, currentMonthStart, today);
      const end = endOfMonth(currentMonthStart);
      const threshold = new Date(end);
      threshold.setDate(end.getDate() - 7);
      if (today >= threshold) {
        const nextMonthStart = new Date(today.getFullYear(), today.getMonth() + 1, 1);
        if (ensureMonthlyInvoiceForPeriod(student, nextMonthStart, today)) changed = true;
      }
      return changed;
    }

    function recalculateMonthlyInvoice(inv, student, today) {
      if (inv.paid || isInvoiceVoid(inv)) return false;
      const { numSessions, baseAmount } = getMonthlyInvoiceBillables(inv, student);
      const total = computeInvoiceTotal(baseAmount, inv);
      let changed = false;
      if (numSessions !== inv.numSessions) { inv.numSessions = numSessions; changed = true; }
      if (baseAmount !== inv.baseAmount) { inv.baseAmount = baseAmount; changed = true; }
      if (total !== inv.total) { inv.total = total; changed = true; }
      return changed;
    }

    function scheduleSessionsForInvoice(inv, student, today) {
      // Deprecated: sessions are scheduled independently of invoices.
      return false;
    }

    function getAutoScheduleWindow(today) {
      // Schedule from the start of the current month so missed/unpaid sessions can still be rescheduled.
      const start = new Date(today.getFullYear(), today.getMonth(), 1);
      start.setHours(0, 0, 0, 0);
      const nextMonthStart = new Date(today.getFullYear(), today.getMonth() + 1, 1);
      const end = endOfMonth(nextMonthStart);
      end.setHours(0, 0, 0, 0);
      return { start, end };
    }

    function ensureScheduledSessionsForStudent(student, windowStart, windowEnd) {
      const prefs = getSchedulePrefs(student);
      if (!student?.contractSigned || !prefs.scheduleSlots.length) return false;
      const anchor = getScheduleAnchorDate(student);
      const start = maxDate(anchor, windowStart);
      const occurrences = listScheduleOccurrences(prefs.scheduleSlots, start, windowEnd);
      if (!occurrences.length) return false;

      const existingKeys = new Set();
      state.sessions.forEach(s => {
        if (!s?.date) return;
        if (!s.studentIds || s.studentIds.length !== 1) return;
        if (s.studentIds[0] !== student.id) return;
        const key = `${s.date}|${normalizeTimeValue(s.startTime || '')}`;
        existingKeys.add(key);
      });

      let added = 0;
      occurrences.forEach(occ => {
        const slot = occ.slot || {};
        const slotTime = normalizeTimeValue(slot.startTime || '');
        if (!slotTime) return;
        const durationHours = Number(slot.durationHours || 0) || Number(state.settings.defaultSessionDuration || 1);
        const key = `${occ.date}|${slotTime}`;
        if (existingKeys.has(key)) return;
        if (isBusyDate(occ.date)) return;
        if (isCancelledOccurrence(student.id, occ.date, slotTime, durationHours)) return;

        const sessionMode = getSlotSessionMode(slot, 'in_person');
        state.sessions.push({
          id: generateId('sess'),
          studentIds: [student.id],
          date: occ.date,
          startTime: slotTime,
          durationHours,
          subject: student.subjects?.[0] || 'Tutoring',
          topic: 'Scheduled session',
          notes: '',
          attended: false,
          completed: false,
          status: SESSION_STATUS.SCHEDULED,
          absenceReason: '',
          pendingReviewStartedAt: '',
          billingRate: Number(student.rate || 0) || null,
          invoiceId: '',
          sessionMode,
          meetingProvider: sessionMode === 'online' ? 'JaaS' : '',
          meetingRoom: '',
          meetingStatus: sessionMode === 'online' ? 'scheduled' : '',
          meetingStartedAt: '',
          meetingEndedAt: ''
        });
        existingKeys.add(key);
        added++;
      });

      if (added) {
        logActivity('Auto-scheduled sessions', `${student.name} (+${added})`);
      }
      return added > 0;
    }

    function refreshAutoSchedule(today) {
      const { start, end } = getAutoScheduleWindow(today);
      let changed = false;
      state.students.forEach(student => {
        if (ensureScheduledSessionsForStudent(student, start, end)) changed = true;
      });
      return changed;
    }

    function refreshSessionOutcomes(now = new Date()) {
      const graceHours = Number(state.settings.pendingReviewGraceHours || 24) || 24;
      const graceMs = graceHours * 60 * 60 * 1000;
      let changed = false;
      state.sessions.forEach(sess => {
        if (!sess?.date) return;
        if (!hasSessionEnded(sess, now)) return;

        const status = getSessionStatus(sess);
        const absenceReason = String(sess.absenceReason || sess.absence_reason || '').trim().toLowerCase();

        if (sess.attended) {
          if (status !== SESSION_STATUS.COMPLETE) {
            sess.status = SESSION_STATUS.COMPLETE;
            sess.completed = true;
            sess.attended = true;
            sess.pendingReviewStartedAt = '';
            changed = true;
            logActivity('Auto-completed session', `${sess.date} ${sess.startTime || ''}`);
          }
          return;
        }

        // If the outcome is already known and always non-billable, void immediately (no grace).
        const immediateVoid = absenceReason === SESSION_ABSENCE_REASONS.TUTOR_ABSENT ||
          absenceReason === SESSION_ABSENCE_REASONS.CANCELLED_IN_TIME ||
          absenceReason === SESSION_ABSENCE_REASONS.ADMIN_VOID;
        if (immediateVoid && status !== SESSION_STATUS.VOIDED) {
          sess.status = SESSION_STATUS.VOIDED;
          sess.completed = false;
          sess.attended = false;
          sess.pendingReviewStartedAt = '';
          changed = true;
          const inv = sess.invoiceId ? getInvoiceById(sess.invoiceId) : null;
          if (inv && isInvoiceLocked(inv)) {
            if ((sess.studentIds || []).length === 1) {
              const student = getStudentById(sess.studentIds[0]) || getStudentById(inv.studentId);
              if (student) {
                if (!(Number(sess.billingRate ?? sess.billing_rate ?? 0) > 0) && Number(student.rate || 0) > 0) {
                  sess.billingRate = Number(student.rate || 0);
                }
                createVoidedSessionCreditNote(sess, student, inv.id);
              }
            }
            logActivity('Voided session after payment', `${sess.date} ${sess.startTime || ''} (credit may be owed)`);
          } else {
            logActivity('Voided session', `${sess.date} ${sess.startTime || ''}`);
          }
          return;
        }

        // Not attended: give a grace period before voiding/charging.
        if (status === SESSION_STATUS.SCHEDULED || status === SESSION_STATUS.RESTORED) {
          sess.status = SESSION_STATUS.PENDING_REVIEW;
          sess.completed = false;
          if (!sess.pendingReviewStartedAt) sess.pendingReviewStartedAt = now.toISOString();
          changed = true;
          logActivity('Session pending review', `${sess.date} ${sess.startTime || ''}`);
          return;
        }

        if (status !== SESSION_STATUS.PENDING_REVIEW) return;

        const startAt = sess.pendingReviewStartedAt ? new Date(sess.pendingReviewStartedAt) : (getSessionEndAt(sess) || now);
        const deadline = new Date(startAt.getTime() + graceMs);
        if (now < deadline) return;

        const chargeableNoShow = absenceReason === SESSION_ABSENCE_REASONS.STUDENT_NO_SHOW && !!state.settings.policyChargeableNoShow;
        const chargeableLateCancel = absenceReason === SESSION_ABSENCE_REASONS.CANCELLED_LATE && !!state.settings.policyChargeableLateCancel;
        const forceVoid = absenceReason === SESSION_ABSENCE_REASONS.TUTOR_ABSENT ||
          absenceReason === SESSION_ABSENCE_REASONS.CANCELLED_IN_TIME ||
          absenceReason === SESSION_ABSENCE_REASONS.ADMIN_VOID;

        const nextStatus = (chargeableNoShow || chargeableLateCancel) && !forceVoid
          ? SESSION_STATUS.NO_SHOW_CHARGEABLE
          : SESSION_STATUS.VOIDED;

        if (nextStatus === status) return;

        sess.status = nextStatus;
        sess.completed = false;
        sess.attended = false;
        changed = true;

        const inv = sess.invoiceId ? getInvoiceById(sess.invoiceId) : null;
        if (nextStatus === SESSION_STATUS.VOIDED && inv && isInvoiceLocked(inv)) {
          if ((sess.studentIds || []).length === 1) {
            const student = getStudentById(sess.studentIds[0]) || getStudentById(inv.studentId);
            if (student) {
              if (!(Number(sess.billingRate ?? sess.billing_rate ?? 0) > 0) && Number(student.rate || 0) > 0) {
                sess.billingRate = Number(student.rate || 0);
              }
              createVoidedSessionCreditNote(sess, student, inv.id);
            }
          }
          logActivity('Voided session after payment', `${sess.date} ${sess.startTime || ''} (credit may be owed)`);
        } else {
          logActivity(nextStatus === SESSION_STATUS.VOIDED ? 'Auto-voided session' : 'Auto-charged no-show', `${sess.date} ${sess.startTime || ''}`);
        }
      });
      return changed;
    }

    function refreshAutoBilling() {
      if (readOnlyMode || studentMode || parentMode) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      let changed = false;
      if (refreshAutoSchedule(today)) changed = true;
      if (refreshSessionOutcomes(new Date())) changed = true;
      state.students.forEach(student => {
        if (ensureMonthlyInvoiceForStudent(student, today)) changed = true;
      });
      state.invoices.forEach(inv => {
        const student = getStudentById(inv.studentId);
        if (!student) return;
        if ((inv.invoiceType || inv.invoice_type) === 'monthly' && !isInvoiceVoid(inv)) {
          if (syncMonthlyInvoiceSessionLinks(inv, student)) changed = true;
        }
        if ((inv.invoiceType || inv.invoice_type) === 'monthly' && !inv.paid && !isInvoiceVoid(inv)) {
          if (recalculateMonthlyInvoice(inv, student, today)) changed = true;
        }
      });
      if (applyPaidMoveInvoices()) changed = true;
      return changed;
    }

    function isWithin24Hours(sess) {
      const start = new Date(sess.date + 'T' + (sess.startTime || '00:00'));
      const diffMs = start - new Date();
      return diffMs > 0 && diffMs < 24 * 60 * 60 * 1000;
    }

    function hasLateChangeInvoice(studentId, sessionId, reason, dateStr) {
      return state.invoices.some(inv => {
        if (inv.studentId !== studentId) return false;
        if ((inv.invoiceType || inv.invoice_type) !== 'adjustment') return false;
        if (isInvoiceVoid(inv)) return false;
        const invReason = inv.adjustmentReason || inv.adjustment_reason || '';
        if (reason && invReason && invReason !== reason) return false;
        if (invReason === 'late_move' && inv.paid && (inv.moveAppliedAt || inv.move_applied_at)) return false;
        const relatedId = inv.relatedSessionId || inv.related_session_id || '';
        if (sessionId) return relatedId ? relatedId === sessionId : false;
        if (dateStr) return (inv.servicePeriodStart || inv.service_period_start) === dateStr;
        return true;
      });
    }

    function hasPendingMoveInvoice(sessionId) {
      if (!sessionId) return false;
      return state.invoices.some(inv => {
        if ((inv.invoiceType || inv.invoice_type) !== 'adjustment') return false;
        const reason = inv.adjustmentReason || inv.adjustment_reason || '';
        if (reason !== 'late_move') return false;
        const relatedId = inv.relatedSessionId || inv.related_session_id || '';
        if (relatedId !== sessionId) return false;
        if (isInvoiceVoid(inv)) return false;
        if (inv.moveAppliedAt || inv.move_applied_at) return false;
        return !inv.paid;
      });
    }

    function isCancelledOccurrence(studentId, dateStr, startTime, durationHours) {
      const targetTime = normalizeTimeValue(startTime || '');
      const targetDuration = Number(durationHours || 0) || 0;
      return state.sessionCancellations.some(c => {
        if (cleanId(c.studentId) !== cleanId(studentId)) return false;
        if ((c.date || '') !== dateStr) return false;
        if (normalizeTimeValue(c.startTime || '') !== targetTime) return false;
        const cancelledDuration = Number(c.durationHours || 0) || 0;
        if (cancelledDuration && targetDuration && Math.abs(cancelledDuration - targetDuration) > 0.01) return false;
        return true;
      });
    }

    function recordSessionCancellation(sess, reason = '') {
      if (!sess?.date) return;
      const startTime = normalizeTimeValue(sess.startTime || '');
      if (!startTime) return;
      const durationHours = Number(sess.durationHours || 0) || 0;
      const nowIso = new Date().toISOString();
      (sess.studentIds || []).forEach(rawId => {
        const studentId = cleanId(rawId);
        if (!studentId) return;
        const exists = state.sessionCancellations.some(c => (
          cleanId(c.studentId) === studentId &&
          (c.date || '') === sess.date &&
          normalizeTimeValue(c.startTime || '') === startTime
        ));
        if (exists) return;
        state.sessionCancellations.push({
          id: generateId('cancel'),
          studentId,
          date: sess.date,
          startTime,
          durationHours,
          sessionId: sess.id || '',
          invoiceId: sess.invoiceId || '',
          reason,
          cancelledAt: nowIso
        });
      });
    }

    function findVoidedSessionCreditNote(studentId, sessionId) {
      if (!studentId || !sessionId) return null;
      return state.invoices.find(inv => {
        if (inv.studentId !== studentId) return false;
        if ((inv.invoiceType || inv.invoice_type) !== 'refund') return false;
        if (isInvoiceVoid(inv)) return false;
        const reason = inv.adjustmentReason || inv.adjustment_reason || '';
        if (reason !== 'voided_credit') return false;
        const related = inv.relatedSessionId || inv.related_session_id || '';
        return related === sessionId;
      }) || null;
    }

    function createVoidedSessionCreditNote(sess, student, paidInvoiceId = '') {
      if (!sess || !student?.id) return null;
      const existing = findVoidedSessionCreditNote(student.id, sess.id);
      if (existing) return existing;
      const nowStr = toDateOnly(new Date());
      const amount = getSessionBillableAmount(sess, student);
      if (!(amount > 0.009)) return null;
      const baseAmount = Number((-Math.abs(amount)).toFixed(2));
      const noteBits = [
        `Credit note for voided session on ${sess.date} ${sess.startTime || ''}.`,
        paidInvoiceId ? `Original invoice: ${paidInvoiceId}.` : ''
      ].filter(Boolean).join(' ');
      const inv = {
        id: generateId('inv'),
        studentId: student.id,
        issueDate: nowStr,
        dueDate: nowStr,
        baseAmount,
        total: baseAmount,
        lateFeePercent: 0,
        shortNoticePercent: 0,
        lateApplied: false,
        shortApplied: false,
        paid: false,
        notes: noteBits,
        servicePeriodStart: sess.date,
        servicePeriodEnd: sess.date,
        numSessions: 1,
        invoiceType: 'refund',
        autoGenerated: true,
        paidAt: '',
        paymentProvider: '',
        paymentMethod: '',
        invoiceStatus: 'issued',
        voidedAt: '',
        adjustmentReason: 'voided_credit',
        relatedSessionId: sess.id,
        moveToDate: '',
        moveToTime: '',
        moveToDurationHours: 0,
        moveRequestedAt: '',
        moveAppliedAt: ''
      };
      state.invoices.push(inv);
      logActivity('Created credit note', inv.id);
      return inv;
    }

    function createLateChangeInvoices(sess, actionLabel, movePayload = null) {
      const now = new Date();
      const nowStr = now.toISOString().slice(0, 10);
      const adjustmentReason = actionLabel === 'moved' ? 'late_move' : 'late_cancel';
      const moveNote = movePayload?.date
        ? ` Requested additional session on ${movePayload.date} ${movePayload.startTime || ''}.`
        : '';
      const actionText = actionLabel === 'moved'
        ? 'moved within 24 hours (additional session)'
        : 'cancelled within 24 hours';
      sess.studentIds.forEach(sid => {
        if (hasLateChangeInvoice(sid, sess.id, adjustmentReason, sess.date)) return;
        const student = getStudentById(sid);
        const rate = Number(student?.rate || 0);
        const sessionHours = actionLabel === 'moved' && movePayload?.durationHours
          ? Number(movePayload.durationHours || 1)
          : Number(sess.durationHours || 1);
        const baseAmount = Number((rate * sessionHours).toFixed(2));
        const inv = {
          id: generateId('inv'),
          studentId: sid,
          issueDate: nowStr,
          dueDate: nowStr,
          baseAmount,
          total: baseAmount,
          lateFeePercent: 0,
          shortNoticePercent: 0,
          lateApplied: false,
          shortApplied: false,
          paid: false,
          notes: `Lesson on ${sess.date} ${actionText}.${moveNote}`,
          servicePeriodStart: sess.date,
          servicePeriodEnd: sess.date,
          numSessions: 1,
          invoiceType: 'adjustment',
          autoGenerated: true,
          paidAt: '',
          paymentProvider: PAYFAST_PROVIDER,
          paymentMethod: '',
          invoiceStatus: 'issued',
          voidedAt: '',
          adjustmentReason,
          relatedSessionId: sess.id,
          moveToDate: movePayload?.date || '',
          moveToTime: movePayload?.startTime || '',
          moveToDurationHours: Number(movePayload?.durationHours || 0) || 0,
          moveRequestedAt: movePayload ? now.toISOString() : '',
          moveAppliedAt: ''
        };
        state.invoices.push(inv);
        logActivity('Created invoice', inv.id);
        maybeNotifyInvoiceIssued(inv);
      });
    }

    function findPaidInvoiceForSession(studentId, sess) {
      if (!studentId || !sess) return null;
      let invoice = null;
      if (sess.invoiceId) {
        invoice = state.invoices.find(inv => inv.id === sess.invoiceId) || null;
      }
      if (!invoice) {
        invoice = state.invoices.find(inv => {
          if (inv.studentId !== studentId || !inv.paid || isInvoiceVoid(inv)) return false;
          const start = inv.servicePeriodStart || inv.service_period_start || '';
          const end = inv.servicePeriodEnd || inv.service_period_end || '';
          if (start && end) return start <= sess.date && end >= sess.date;
          return false;
        }) || null;
      }
      if (!invoice || !invoice.paid || isInvoiceVoid(invoice)) return null;
      return invoice;
    }

    function recordCashRefund(sess, studentId, invoice) {
      const student = getStudentById(studentId);
      const rate = Number(student?.rate || 0);
      const duration = Number(sess.durationHours || 1);
      const refundAmount = Number((rate * duration).toFixed(2));
      if (!refundAmount) return null;

      const existing = state.invoices.find(inv =>
        inv.studentId === studentId &&
        (inv.invoiceType || inv.invoice_type) === 'refund' &&
        (inv.relatedSessionId || inv.related_session_id) === sess.id
      );
      if (existing) return existing;

      const nowIso = new Date().toISOString();
      const refundInv = {
        id: generateId('inv'),
        studentId,
        issueDate: sess.date,
        dueDate: sess.date,
        baseAmount: -refundAmount,
        total: -refundAmount,
        lateFeePercent: 0,
        shortNoticePercent: 0,
        lateApplied: false,
        shortApplied: false,
        paid: true,
        notes: `Cash refund for session on ${sess.date} ${sess.startTime || ''}.`,
        servicePeriodStart: sess.date,
        servicePeriodEnd: sess.date,
        numSessions: 1,
        invoiceType: 'refund',
        autoGenerated: true,
        paidAt: nowIso,
        paymentProvider: 'Cash',
        paymentProviderId: '',
        paymentMethod: 'cash',
        invoiceStatus: 'paid',
        voidedAt: '',
        adjustmentReason: 'refund',
        relatedSessionId: sess.id,
        moveToDate: '',
        moveToTime: '',
        moveToDurationHours: 0,
        moveRequestedAt: '',
        moveAppliedAt: '',
        amountReceived: null,
        amountRefunded: null,
        refundStatus: '',
        refundLastAt: ''
      };
      state.invoices.push(refundInv);

      if (invoice) {
        const amountReceived = Number(invoice.amountReceived ?? invoice.amount_received ?? invoice.total ?? 0) || 0;
        const amountRefunded = Number(invoice.amountRefunded ?? invoice.amount_refunded ?? 0) || 0;
        const newRefunded = amountRefunded + refundAmount;
        invoice.amountRefunded = newRefunded;
        invoice.refundLastAt = nowIso;
        if (amountReceived) {
          invoice.refundStatus = newRefunded >= amountReceived - 0.01 ? 'full' : 'partial';
        }
        if (!invoice.paymentMethod) invoice.paymentMethod = 'cash';
        if (!invoice.paymentProvider) invoice.paymentProvider = 'Cash';
      }

      state.messages.push({
        id: generateId('msg'),
        studentId,
        text: `Lesson on ${sess.date} cancelled. Cash refund due: R ${refundAmount.toFixed(2)}.`,
        sender: 'owner',
        created_at: nowIso
      });
      return refundInv;
    }

    async function requestRefundForSession(sess) {
      if (!isSupabaseReady()) {
        throw new Error('Refunds require a Supabase session.');
      }
      const refunds = [];
      for (const sid of sess.studentIds || []) {
        const localInvoice = findPaidInvoiceForSession(sid, sess);
        const method = localInvoice ? getInvoicePaymentMethod(localInvoice) : '';
        if (method === 'cash') {
          recordCashRefund(sess, sid, localInvoice);
          refunds.push({ success: true, cash: true });
          continue;
        }
        const accessToken = requireAccessToken(t('alert.sign_in_first'));
        const stepUp = await issueActionNonce(
          ACTION_NONCE_ACTIONS.refund,
          { session_id: sess.id, student_id: sid },
          accessToken
        );
        const { data, error } = await supabaseClient.functions.invoke('payfast-refund', {
          body: {
            session_id: sess.id,
            student_id: sid,
            action_nonce: stepUp.nonce,
            request_fingerprint: stepUp.requestFingerprint
          },
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (error) {
          throw new Error(error.message || 'Refund failed.');
        }
        if (!data?.success) {
          const code = data?.code || '';
          if (code === 'offline_payment') {
            const cashInv = localInvoice || findPaidInvoiceForSession(sid, sess);
            recordCashRefund(sess, sid, cashInv);
            continue;
          }
          if (code === 'no_paid_invoice' || code === 'already_refunded') {
            continue;
          }
          throw new Error(data?.error || 'Refund failed.');
        }
        if (data.refund_invoice) {
          const refundInv = mapInvoiceRowToState(data.refund_invoice);
          state.invoices.push(refundInv);
        }
        if (data.updated_invoice?.id) {
          const idx = state.invoices.findIndex(i => i.id === data.updated_invoice.id);
          if (idx >= 0) {
            const current = state.invoices[idx];
            current.amountRefunded = data.updated_invoice.amount_refunded ?? current.amountRefunded;
            current.refundStatus = data.updated_invoice.refund_status || current.refundStatus;
            current.refundLastAt = data.updated_invoice.refund_last_at || current.refundLastAt;
          }
        }
        if (data.message) {
          state.messages.push(mapMessageRowToState(data.message));
        }
        refunds.push(data);
      }
      return refunds;
    }

    function applyPaidMoveInvoices() {
      let changed = false;
      const now = new Date();
      state.invoices.forEach(inv => {
        if ((inv.invoiceType || inv.invoice_type) !== 'adjustment') return;
        const reason = inv.adjustmentReason || inv.adjustment_reason || '';
        if (reason !== 'late_move') return;
        if (!inv.paid || isInvoiceVoid(inv) || inv.moveAppliedAt) return;
        const sessionId = inv.relatedSessionId || inv.related_session_id;
        const sess = getSessionById(sessionId);
        if (!sess) return;
        if (!inv.moveToDate || !inv.moveToTime) return;
        const moveTime = normalizeTimeValue(inv.moveToTime || '');
        const durationHours = Number(inv.moveToDurationHours || 0) || Number(sess.durationHours || 1);
        const oldSnapshot = {
          ...sess,
          studentIds: [...(sess.studentIds || [])],
          date: sess.date,
          startTime: sess.startTime,
          durationHours: sess.durationHours
        };
        const duplicate = state.sessions.find(s => (
          s.id !== sess.id &&
          s.studentIds.some(id => sess.studentIds.includes(id)) &&
          s.date === inv.moveToDate &&
          normalizeTimeValue(s.startTime || '') === moveTime
        ));
        const alreadyMoved = sess.date === inv.moveToDate &&
          normalizeTimeValue(sess.startTime || '') === moveTime &&
          Number(sess.durationHours || 1) === Number(durationHours || 1);
        if (!alreadyMoved) {
          recordSessionCancellation(oldSnapshot, 'moved_paid');
          sess.date = inv.moveToDate;
          sess.startTime = moveTime;
          sess.durationHours = durationHours;
          sess.topic = sess.topic || 'Rescheduled session';
          if (duplicate) {
            state.sessions = state.sessions.filter(s => s.id !== duplicate.id);
          }
        }
        inv.moveAppliedAt = now.toISOString();
        if (inv.invoiceStatus !== 'paid') inv.invoiceStatus = 'paid';
        changed = true;
      });
      return changed;
    }

    function hasPaidInvoiceForDate(studentId, dateStr) {
      const targetDate = String(dateStr || '').slice(0, 10);
      if (!studentId || !targetDate) return false;
      return state.invoices.some(inv => {
        if (inv.studentId !== studentId || !inv.paid || isInvoiceVoid(inv)) return false;
        const type = String(inv.invoiceType || inv.invoice_type || '').toLowerCase();
        if (type === 'adjustment' || type === 'refund') return false;
        // Only treat invoices with an explicit service period as covering sessions.
        const start = String(inv.servicePeriodStart || inv.service_period_start || '').slice(0, 10);
        const end = String(inv.servicePeriodEnd || inv.service_period_end || '').slice(0, 10);
        if (start && end) return start <= targetDate && end >= targetDate;
        // Fallback for legacy invoices missing service_period_* fields: treat monthly invoices as covering the invoice month.
        if (type !== 'monthly') return false;
        const invMonth = String(inv.servicePeriodEnd || inv.servicePeriodStart || inv.issueDate || inv.dueDate || '').slice(0, 7);
        return !!invMonth && invMonth === targetDate.slice(0, 7);
      });
    }

    function guardSessionCreation(studentIds, dateStr, opts = {}) {
      if (!studentIds.length) {
        alert(t('alert.select_student_at_least_one'));
        return false;
      }
      for (const sid of studentIds) {
        const stu = getStudentById(sid);
        if (!stu?.contractSigned) {
          alert(t('alert.contract_must_signed'));
          return false;
        }
      }
      return true;
    }

    function guardSessionCompletion(sess) {
      return true;
    }

    function downloadIcsFile() {
      const lines = [];
      lines.push('BEGIN:VCALENDAR');
      lines.push('VERSION:2.0');
      lines.push(`PRODID:-//${PLATFORM_NAME}//ICS`);
      getScheduleVisibleSessions().forEach(sess => {
        const dtStart = new Date(sess.date + 'T' + (sess.startTime || '00:00'));
        const durationMs = Number(sess.durationHours || 1) * 60 * 60 * 1000;
        const dtEnd = new Date(dtStart.getTime() + durationMs);
        const format = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        const names = sess.studentIds.map(id => getStudentById(id)?.name || 'Student').join(', ');
        lines.push('BEGIN:VEVENT');
        lines.push('UID:' + sess.id + '@tutor-mcp.com');
        lines.push('DTSTAMP:' + format(new Date()));
        lines.push('DTSTART:' + format(dtStart));
        lines.push('DTEND:' + format(dtEnd));
        lines.push('SUMMARY:' + (sess.subject || 'Session') + ' - ' + names);
        lines.push('DESCRIPTION:' + (sess.topic || '') + ' ' + (sess.notes || ''));
        lines.push('END:VEVENT');
      });
      lines.push('END:VCALENDAR');
      const blob = new Blob([lines.join('\n')], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tutor-sessions.ics';
      a.click();
      URL.revokeObjectURL(url);
    }

    function getSessionById(id) {
      return state.sessions.find(s => s.id === id);
    }

    function openSessionQuickActions(sessionId) {
      const sess = getSessionById(sessionId);
      if (!sess) return;
      const names = esc(sess.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', '));
      const modeLabel = esc(getSessionModeLabel(sess.sessionMode ?? sess.session_mode ?? sess.mode));
      const status = getSessionStatus(sess);
      const statusLabel = status === SESSION_STATUS.COMPLETE
        ? t('schedule.completed')
        : status === SESSION_STATUS.PENDING_REVIEW
          ? t('schedule.pending_review')
          : status === SESSION_STATUS.VOIDED
            ? t('schedule.voided')
            : status === SESSION_STATUS.NO_SHOW_CHARGEABLE
              ? t('schedule.no_show_chargeable')
              : status === SESSION_STATUS.RESTORED
                ? t('schedule.restored')
                : t('schedule.scheduled');
      const safeSessionId = cleanId(sess.id);
      const joinBtn = (!parentMode && canJoinMeetingNow(sess))
        ? `<button id="sessionJoinBtn" class="portal-cta-btn portal-cta-join portal-cta-btn-block">${esc(t('meeting.join_online_session'))}</button>`
        : '';
      const attended = !!sess.attended;
      const isComplete = status === SESSION_STATUS.COMPLETE;
      const attendedLabel = attended || isComplete ? t('sessions.attended') : t('sessions.mark_attended');
      const completedLabel = isComplete ? t('sessions.completed') : t('sessions.mark_complete');
      const attendedDisabled = attended || isComplete || status === SESSION_STATUS.VOIDED;
      openModal(`
        <h2 class="text-sm font-semibold mb-2">${esc(t('sessions.quick_title', { names }))}</h2>
        <p class="text-[11px] mb-2">${esc(sess.subject)} ‚Ä¢ ${esc(sess.date)} ‚Ä¢ ${esc(sess.startTime || '')} (${esc(sess.durationHours || 1)}h) ‚Ä¢ ${modeLabel} ‚Ä¢ ${esc(statusLabel)}</p>
        <p class="text-[11px] mb-3">${esc(sess.topic || '')}</p>

        <div class="space-y-2">
          ${joinBtn}
          <button id="sessionMarkAttendedBtn" class="w-full px-3 py-1.5 rounded-xl border border-amber-300 text-amber-800 text-xs font-medium ${attendedDisabled ? 'opacity-60 cursor-not-allowed' : ''}" data-owner-only ${attendedDisabled ? 'disabled' : ''}>
            ${esc(attendedLabel)}
          </button>
          <button id="sessionMarkCompletedBtn" class="w-full px-3 py-1.5 rounded-xl bg-emerald-600 text-white text-xs font-medium ${isComplete || status === SESSION_STATUS.VOIDED ? 'opacity-60 cursor-not-allowed' : ''}" data-owner-only ${isComplete || status === SESSION_STATUS.VOIDED ? 'disabled' : ''}>
            ${esc(completedLabel)}
          </button>
          <button id="sessionEditBtn" class="w-full px-3 py-1.5 rounded-xl border border-slate-300 text-xs" data-owner-only>
            ${esc(t('common.edit'))}
          </button>
        </div>
      `, () => {
        const joinButton = document.getElementById('sessionJoinBtn');
        if (joinButton) joinButton.onclick = () => openMeetingForSession(safeSessionId);
        const markAttendedBtn = document.getElementById('sessionMarkAttendedBtn');
        if (markAttendedBtn) {
          markAttendedBtn.onclick = () => {
            if (!guardEdit()) return;
            sess.attended = true;
            if (hasSessionEnded(sess) || getSessionStatus(sess) === SESSION_STATUS.PENDING_REVIEW) {
              sess.status = SESSION_STATUS.COMPLETE;
              sess.completed = true;
              sess.pendingReviewStartedAt = '';
            }
            saveState();
            closeModal();
            renderAllViews();
          };
        }
        document.getElementById('sessionMarkCompletedBtn').onclick = () => {
          if (!guardEdit()) return;
          sess.attended = true;
          sess.completed = true;
          sess.status = SESSION_STATUS.COMPLETE;
          sess.pendingReviewStartedAt = '';
          saveState();
          closeModal();
          renderAllViews();
        };
        document.getElementById('sessionEditBtn').onclick = () => {
          if (!guardEdit()) return;
          closeModal();
          openSessionModal(sess);
        };
      });
    }

    /*************
     * RESOURCES *
     *************/
    function renderResourcesView() {
      const list = document.getElementById('resourcesList');
      const subjectFilterEl = document.getElementById('resourceSubjectFilter');
      const searchInput = document.getElementById('resourceSearchInput');
      const subjectFilter = subjectFilterEl?.value || '';
      const searchTerm = searchInput?.value?.trim().toLowerCase() || '';
      const tagFiltersEl = document.getElementById('resourceTagFilters');
      const activeTag = tagFiltersEl?.dataset.active || '';
      const ownerView = !studentMode && !parentMode;
      const addBtn = document.getElementById('addResourceBtn');
      const homeworkBoard = document.getElementById('resourcesHomeworkBoard');
      const homeworkTitle = document.getElementById('homeworkBoardTitle');
      const homeworkHint = document.getElementById('homeworkBoardHint');

      if (addBtn) addBtn.classList.toggle('hidden', !ownerView);

      const viewerStudentIds = ownerView ? [] : getViewerStudentIds();
      if (!ownerView && (!viewerStudentIds || !viewerStudentIds.length)) {
        const msg = studentMode
          ? t('portal.no_student_linked')
          : t('parent.no_linked_students');
        list.innerHTML = `<li class="text-slate-500 text-xs">${msg}</li>`;
        if (homeworkBoard) homeworkBoard.classList.add('hidden');
        return;
      }
      if (homeworkBoard) homeworkBoard.classList.remove('hidden');
      if (!ownerView) {
        if (homeworkTitle) homeworkTitle.textContent = parentMode ? t('resources.homework_board_parent') : t('resources.homework_board_student');
        if (homeworkHint) homeworkHint.textContent = t('resources.homework_board_readonly_hint');
      } else {
        if (homeworkTitle) homeworkTitle.textContent = t('resources.homework_board');
        if (homeworkHint) homeworkHint.textContent = t('resources.homework_board_owner_hint');
      }

      const scopedHomework = ownerView
        ? state.homework
        : state.homework.filter(hw => viewerStudentIds.includes(hw.studentId));
      const scopedResourceIds = new Set(scopedHomework.map(hw => hw.resourceId));
      const baseResources = ownerView
        ? state.resources
        : state.resources.filter(r => scopedResourceIds.has(r.id));

      const tagCounts = {};
      baseResources.forEach(r => {
        (r.tags || []).forEach(tag => {
          const key = tag.trim();
          if (!key) return;
          tagCounts[key] = (tagCounts[key] || 0) + 1;
        });
      });
      const topTags = Object.entries(tagCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);
      if (tagFiltersEl) {
        tagFiltersEl.innerHTML = (topTags.length ? topTags.map(([tag, count]) => `
          <button class="chip-btn ${activeTag === tag.toLowerCase() ? 'active' : ''}" data-tag="${esc(tag)}">#${esc(tag)} (${esc(count)})</button>
        `).join('') : `<span class="text-slate-500">${esc(t('resources.tags_empty'))}</span>`)
          + (activeTag ? ` <button class="chip-btn" data-tag="">${esc(t('common.clear'))}</button>` : '');
        tagFiltersEl.querySelectorAll('button[data-tag]').forEach(btn => {
          btn.onclick = () => {
            tagFiltersEl.dataset.active = (btn.dataset.tag || '').toLowerCase();
            renderResourcesView();
          };
        });
      }

      const filtered = baseResources.filter(r => {
        if (subjectFilter && r.subject !== subjectFilter) return false;
        const haystack = [
          r.title,
          r.description,
          r.resourceType,
          r.linkUrl,
          r.level
        ].filter(Boolean).join(' ').toLowerCase();
        if (searchTerm && !haystack.includes(searchTerm) && !(r.tags || []).some(t => t.toLowerCase().includes(searchTerm))) {
          return false;
        }
        if (activeTag && !(r.tags || []).some(t => t.toLowerCase() === activeTag)) return false;
        return true;
      }).sort((a, b) => (b.favorite === true) - (a.favorite === true));
      if (!filtered.length) {
        const emptyMsg = ownerView
          ? t('resources.none_owner')
          : t('resources.none_assigned');
        list.innerHTML = `<li class="text-slate-500 text-xs">${emptyMsg}</li>`;
      } else {
        const dueDefault = toDateOnly(new Date(Date.now() + 7 * 24 * 60 * 60 * 1000));
        list.innerHTML = filtered.map(r => {
          const stats = getResourceAssignmentStats(r.id, ownerView ? null : viewerStudentIds);
          const progress = stats.total ? Math.round((stats.completed / stats.total) * 100) : 0;
          const openUrl = getResourceOpenUrl(r);
          const assignmentLines = !ownerView ? getResourceAssignments(r.id, viewerStudentIds).map(a => {
            const statusLabel = getHomeworkStatusLabel(a.status);
            const dueLabel = t('homework.due_label');
            const dueValue = a.dueDate || t('common.na');
            return `
            <div class="text-[10px] text-slate-500">${studentMode ? '' : `${esc(a.studentName)} ‚Ä¢ `}${esc(statusLabel)} ‚Ä¢ ${esc(dueLabel)} ${esc(dueValue)}</div>
          `;
          }).join('') : '';
          const minutesLabel = r.estimatedMinutes ? `${esc(r.estimatedMinutes)} ${t('common.minutes_short')}` : '';
          const metaBits = [
            esc(r.subject || t('resources.default_label')),
            esc(r.level || ''),
            esc(r.resourceType || ''),
            minutesLabel
          ].filter(Boolean).join(' ‚Ä¢ ');
          const safeResourceId = cleanId(r.id);
          const safeTitle = esc(r.title);
          const safeDescription = esc(r.description || '');
          const safeOpenUrl = openUrl ? esc(openUrl) : '';
          const safeSignedUrl = r.signedUrl ? esc(r.signedUrl) : '';
          const safeDataUrl = r.dataUrl ? esc(r.dataUrl) : '';
          const safeFileName = esc(r.fileName || 'resource');
          return `
          <li class="border border-slate-200 rounded-xl px-3 py-2 bg-white/85" data-resource-card="${safeResourceId}">
            <div class="flex justify-between items-start gap-2">
              <div>
                <div class="font-semibold">${safeTitle}</div>
                <div class="text-[10px] text-slate-500">${metaBits || esc(t('resources.default_label'))}</div>
              </div>
              ${ownerView ? `
                <div class="flex items-center gap-1">
                  <button class="text-[12px]" title="${esc(t('resources.favorite'))}"
                          onclick="toggleResourceFavorite('${safeResourceId}')">${r.favorite ? '‚≠ê' : '‚òÜ'}</button>
                  <button class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                          onclick="openResourceModal(getResourceById('${safeResourceId}'))">
                    ${esc(t('common.edit'))}
                  </button>
                </div>
              ` : ''}
            </div>
            ${r.description ? `<div class="mt-1 text-[10px]">${safeDescription}</div>` : ''}
            <div class="mt-1 flex flex-wrap">
              ${(r.tags || []).map(tag => `<span class="tag-pill">#${esc(tag)}</span>`).join('')}
            </div>
            <div class="mt-2">
              <div class="text-[10px] text-slate-500">${stats.total ? t('homework.assigned_summary', { total: stats.total, completed: stats.completed }) : t('homework.not_assigned')}</div>
              ${stats.total ? `<div class="progress-track mt-1"><div class="progress-thumb" style="width:${progress}%"></div></div>` : ''}
            </div>
            ${assignmentLines ? `<div class="mt-2 border border-slate-200 rounded-lg p-2 bg-slate-50/60">${assignmentLines}</div>` : ''}
            <div class="mt-2 flex gap-2 text-[11px] flex-wrap items-center">
              ${ownerView ? `
                <button data-owner-only class="px-2 py-1 rounded-lg bg-slate-900 text-white hover:bg-slate-800"
                        onclick="if(guardEdit()) openAssignResourceModal('${safeResourceId}')">
                  ${esc(t('resources.assign_students'))}
                </button>
              ` : ''}
              ${openUrl ? `<button class="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                        onclick="openResourceLink('${safeResourceId}')">${esc(t('common.open'))}</button>` : ''}
              ${ownerView && openUrl ? `<button class="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                        onclick="copyResourceLink('${safeResourceId}')">${esc(t('resources.copy_link'))}</button>` : ''}
              ${r.signedUrl ? `<a class="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50" href="${safeSignedUrl}" target="_blank">${esc(t('resources.download_file'))}</a>` : ''}
              ${!r.signedUrl && r.dataUrl ? `<a class="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50" href="${safeDataUrl}" download="${safeFileName}" target="_blank">${esc(t('resources.download_local_copy'))}</a>` : ''}
              ${r.signedUrl && r.fileName && (r.fileName.endsWith('.png') || r.fileName.endsWith('.jpg') || r.fileName.endsWith('.jpeg')) ? `<img src="${safeSignedUrl}" alt="${safeTitle}" class="h-12 rounded border border-slate-200">` : ''}
            </div>
            ${ownerView && state.students.length ? `
              <div class="mt-2 flex flex-wrap gap-2 items-center text-[10px]" data-quick-assign="${safeResourceId}">
                <select class="border border-slate-300 rounded-lg px-2 py-1 text-[10px]" data-quick-student>
                  ${state.students.map(s => `<option value="${cleanId(s.id)}">${esc(s.name)}</option>`).join('')}
                </select>
                <input type="date" class="border border-slate-300 rounded-lg px-2 py-1 text-[10px]" data-quick-due value="${dueDefault}">
                <button class="px-2 py-1 rounded-lg bg-indigo-600 text-white" data-quick-assign-btn>${esc(t('resources.quick_assign'))}</button>
              </div>
            ` : ''}
          </li>
        `;
        }).join('');
      }

      if (ownerView) {
        list.querySelectorAll('[data-quick-assign]').forEach(row => {
          const resourceId = row.dataset.quickAssign;
          const studentSelect = row.querySelector('[data-quick-student]');
          const dueInput = row.querySelector('[data-quick-due]');
          const btn = row.querySelector('[data-quick-assign-btn]');
          if (!btn) return;
          btn.onclick = () => {
            const studentId = studentSelect?.value;
            if (!studentId) return alert(t('alert.select_student'));
            assignResourceToStudents(resourceId, [studentId], dueInput?.value || '');
          };
        });
      }

      if (subjectFilterEl) subjectFilterEl.onchange = renderResourcesView;
      if (searchInput) searchInput.oninput = renderResourcesView;

      renderHomeworkBoard(ownerView ? null : viewerStudentIds, !ownerView);
    }

    function getResourceById(id) {
      return state.resources.find(r => r.id === id);
    }

    function getResourceUsageText(resourceId) {
      const stats = getResourceAssignmentStats(resourceId);
      if (!stats.total) return t('homework.not_assigned');
      return t('homework.assigned_summary', { total: stats.total, completed: stats.completed });
    }

    function ensureHttpUrl(url) {
      const raw = String(url || '').trim();
      if (!raw) return '';
      if (/^(https?:|data:|blob:|mailto:)/i.test(raw)) return raw;
      return `https://${raw}`;
    }

    function getResourceOpenUrl(resource) {
      if (!resource) return '';
      return ensureHttpUrl(resource.signedUrl || resource.dataUrl || resource.linkUrl || '');
    }

    function getResourceAssignments(resourceId, studentFilterIds = null) {
      return state.homework
        .filter(hw => hw.resourceId === resourceId)
        .filter(hw => !studentFilterIds || studentFilterIds.includes(hw.studentId))
        .map(hw => ({
          id: hw.id,
          studentId: hw.studentId,
          studentName: getStudentById(hw.studentId)?.name || t('common.unknown'),
          status: hw.status || 'To do',
          dueDate: hw.dueDate || '',
          assignedDate: hw.assignedDate || ''
        }));
    }

    function getResourceAssignmentStats(resourceId, studentFilterIds = null) {
      const assignments = getResourceAssignments(resourceId, studentFilterIds);
      const total = assignments.length;
      const completed = assignments.filter(a => a.status === 'Completed').length;
      const inProgress = assignments.filter(a => a.status === 'In progress').length;
      const todo = assignments.filter(a => a.status === 'To do').length;
      return { total, completed, inProgress, todo };
    }

    function openResourceLink(resourceId) {
      const res = getResourceById(resourceId);
      const url = getResourceOpenUrl(res);
      if (!url) {
        alert(t('alert.resource_no_link'));
        return;
      }
      openPopupWithConfirm(url, t('resources.default_label'));
    }

    function copyResourceLink(resourceId) {
      const res = getResourceById(resourceId);
      const url = getResourceOpenUrl(res);
      if (!url) {
        alert(t('alert.resource_no_link'));
        return;
      }
      navigator.clipboard?.writeText(url).then(() => {
        alert(t('alert.resource_link_copied'));
      }).catch(() => {
        prompt(t('prompt.copy_link'), url);
      });
    }

    function assignResourceToStudents(resourceId, studentIds, dueDate) {
      if (!resourceId || !studentIds?.length) return;
      const res = getResourceById(resourceId);
      if (!res) return;
      const students = studentIds.map(id => getStudentById(id)).filter(Boolean);
      if (!students.length) return;
      // Normalize ids before creating assignments so resource/student ids match DB rows.
      normalizeIdsToUuid();
      enforceUuidFields();
      const resolvedResourceId = cleanId(res.id);
      const today = new Date().toISOString().slice(0, 10);
      const newAssignments = students.map(stu => {
        const id = crypto?.randomUUID ? crypto.randomUUID() : generateId('hw');
        const hw = {
          id,
          studentId: cleanId(stu.id),
          resourceId: resolvedResourceId,
          status: 'To do',
          dueDate,
          assignedDate: today
        };
        state.homework.push(hw);
        return hw;
      });
      saveState();
      if (isSupabaseReady()) {
        const token = requireAccessToken(t('alert.sign_in_first'));
        supabaseClient.functions.invoke('assign-homework', {
          body: { assignments: newAssignments },
          headers: { Authorization: `Bearer ${token}` }
        }).then(({ error, data }) => {
          if (error || data?.error) {
            console.error('Homework assignment failed', error || data?.error);
          }
        }).catch(err => console.error('Homework assignment failed', err));
      }
      renderResourcesView();
      if (selectedStudentId) {
        renderStudentTimeline(selectedStudentId);
      }
    }

    function toggleResourceFavorite(resourceId) {
      const res = getResourceById(resourceId);
      if (!res) return;
      res.favorite = !res.favorite;
      saveState();
      renderResourcesView();
    }

    function renderHomeworkBoard(studentFilterIds = null, readOnly = false) {
      const todo = document.getElementById('hwTodo');
      const doing = document.getElementById('hwInProgress');
      const done = document.getElementById('hwDone');
      todo.innerHTML = doing.innerHTML = done.innerHTML = '';

      const grouped = {
        'To do': [],
        'In progress': [],
        'Completed': []
      };

      const filteredHomework = studentFilterIds && studentFilterIds.length
        ? state.homework.filter(hw => studentFilterIds.includes(hw.studentId))
        : state.homework;
      filteredHomework.forEach(hw => {
        const res = state.resources.find(r => r.id === hw.resourceId);
        const student = getStudentById(hw.studentId);
        if (!res || !student) return;
        grouped[hw.status || 'To do'].push({
          ...hw,
          res, student
        });
      });

      function makeCard(hwObj) {
        const hw = hwObj;
        const safeHwId = cleanId(hw.id);
        return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/85">
          <div class="font-medium">${esc(hw.res.title)}</div>
          <div class="text-[10px] text-slate-500">${esc(hw.student.name)} ‚Ä¢ ${esc(t('homework.due_label'))} ${esc(hw.dueDate || t('common.na'))}</div>
          <div class="mt-1 flex items-center gap-2">
            <select class="w-full border border-slate-300 rounded-lg px-1 py-0.5 text-[10px]"
                    ${readOnly ? 'disabled' : ''}
                    onchange="updateHomeworkStatus('${safeHwId}', this.value)">
              <option value="To do" ${hw.status === 'To do' ? 'selected' : ''}>${esc(t('homework.status_todo'))}</option>
              <option value="In progress" ${hw.status === 'In progress' ? 'selected' : ''}>${esc(t('homework.status_in_progress'))}</option>
              <option value="Completed" ${hw.status === 'Completed' ? 'selected' : ''}>${esc(t('homework.status_completed'))}</option>
            </select>
            ${readOnly ? '' : `<button class="px-2 py-0.5 text-[10px] rounded-lg border border-slate-300 hover:bg-slate-50"
                    onclick="unassignHomework('${safeHwId}')">${esc(t('resources.unassign'))}</button>`}
          </div>
        </li>`;
      }

      todo.innerHTML = grouped['To do'].map(makeCard).join('') || `<li class="text-slate-500 text-[11px]">${esc(t('homework.nothing_here'))}</li>`;
      doing.innerHTML = grouped['In progress'].map(makeCard).join('') || `<li class="text-slate-500 text-[11px]">${esc(t('homework.nothing_here'))}</li>`;
      done.innerHTML = grouped['Completed'].map(makeCard).join('') || `<li class="text-slate-500 text-[11px]">${esc(t('homework.nothing_here'))}</li>`;
    }

    function updateHomeworkStatus(hwId, status) {
      if (readOnlyMode || studentMode || parentMode) return;
      const hw = state.homework.find(h => h.id === hwId);
      if (!hw) return;
      hw.status = status;
      saveState();
      renderResourcesView();
      if (selectedStudentId) {
        renderStudentTimeline(selectedStudentId);
      }
    }

    function unassignHomework(hwId) {
      if (readOnlyMode || studentMode || parentMode) return;
      const idx = state.homework.findIndex(h => h.id === hwId);
      if (idx === -1) return;
      const hw = state.homework[idx];
      const res = getResourceById(hw.resourceId);
      const student = getStudentById(hw.studentId);
      const label = t('homework.unassign_label', {
        resource: res?.title || t('resources.default_label'),
        student: student?.name || t('common.student')
      });
      if (!confirm(t('confirm.unassign_item', { item: label }))) return;
      state.homework.splice(idx, 1);
      saveState();
      renderResourcesView();
      if (selectedStudentId) {
        renderStudentTimeline(selectedStudentId);
      }
      if (isSupabaseReady()) {
        supabaseClient
          .from('homework')
          .delete()
          .eq('id', hwId)
          .then(({ error }) => {
            if (error) console.warn('Homework delete failed', error);
          })
          .catch(err => console.warn('Homework delete failed', err));
      }
    }

    /*************
     * FINANCE   *
     *************/
    function getInvoiceById(id) {
      return state.invoices.find(inv => inv.id === id);
    }

    function mapInvoiceRowToState(inv) {
      return {
        id: inv.id,
        studentId: inv.student_id,
        issueDate: inv.issue_date,
        dueDate: inv.due_date,
        baseAmount: inv.base_amount,
        total: inv.total,
        lateFeePercent: inv.late_fee_percent,
        shortNoticePercent: inv.short_notice_percent,
        lateApplied: inv.late_applied,
        shortApplied: inv.short_applied,
        paid: inv.paid,
        notes: inv.notes,
        servicePeriodStart: inv.service_period_start,
        servicePeriodEnd: inv.service_period_end,
        numSessions: inv.num_sessions,
        invoiceType: inv.invoice_type || 'manual',
        autoGenerated: !!inv.auto_generated,
        paidAt: inv.paid_at,
        paymentProvider: inv.payment_provider || '',
        paymentProviderId: inv.payment_provider_id || '',
        paymentMethod: inv.payment_method || '',
        amountReceived: inv.amount_received || null,
        amountRefunded: inv.amount_refunded || null,
        refundStatus: inv.refund_status || '',
        refundLastAt: inv.refund_last_at || '',
        invoiceStatus: inv.invoice_status || (inv.paid ? 'paid' : 'issued'),
        voidedAt: inv.voided_at || '',
        adjustmentReason: inv.adjustment_reason || '',
        relatedSessionId: inv.related_session_id || '',
        moveToDate: inv.move_to_date || '',
        moveToTime: normalizeTimeValue(inv.move_to_time || ''),
        moveToDurationHours: inv.move_to_duration_hours || null,
        moveRequestedAt: inv.move_requested_at || '',
        moveAppliedAt: inv.move_applied_at || ''
      };
    }

    function mapMessageRowToState(msg) {
      return {
        id: msg.id,
        studentId: msg.student_id,
        text: msg.text,
        sender: msg.sender,
        created_at: msg.created_at
      };
    }

    function applyOwnerMaintenanceSettings(settings, ownerSettings) {
      if (!settings || !ownerSettings) return;
      settings.maintenanceEnabled = !!ownerSettings.maintenance_enabled;
      settings.maintenanceStart = ownerSettings.maintenance_start || '';
      settings.maintenanceEnd = ownerSettings.maintenance_end || '';
      settings.maintenanceStartAt = ownerSettings.maintenance_start_at || '';
      settings.maintenanceEndAt = ownerSettings.maintenance_end_at || '';
      settings.maintenanceWarningStartAt = ownerSettings.maintenance_warning_start_at || '';
      settings.maintenanceMode = normalizeMaintenanceMode(ownerSettings.maintenance_mode || settings.maintenanceMode || 'graceful');
      settings.maintenanceRetryAfterSeconds = Math.max(
        60,
        Number(ownerSettings.maintenance_retry_after_seconds || settings.maintenanceRetryAfterSeconds || 3600) || 3600
      );
      settings.maintenanceMessage = ownerSettings.maintenance_message || '';
    }

    function setOverdueReminderEmailStatus(message = '', tone = 'info') {
      const el = document.getElementById('sendOverdueReminderEmailsStatus');
      if (!el) return;
      if (!message) {
        el.textContent = '';
        el.classList.add('hidden');
        el.classList.remove('border-emerald-200', 'bg-emerald-50', 'text-emerald-800');
        el.classList.remove('border-rose-200', 'bg-rose-50', 'text-rose-800');
        el.classList.remove('border-slate-200', 'bg-slate-50', 'text-slate-700');
        return;
      }
      el.classList.remove('hidden');
      el.textContent = message;
      el.classList.remove('border-emerald-200', 'bg-emerald-50', 'text-emerald-800');
      el.classList.remove('border-rose-200', 'bg-rose-50', 'text-rose-800');
      el.classList.remove('border-slate-200', 'bg-slate-50', 'text-slate-700');
      if (tone === 'success') {
        el.classList.add('border-emerald-200', 'bg-emerald-50', 'text-emerald-800');
      } else if (tone === 'error') {
        el.classList.add('border-rose-200', 'bg-rose-50', 'text-rose-800');
      } else {
        el.classList.add('border-slate-200', 'bg-slate-50', 'text-slate-700');
      }
    }

    async function sendOverdueReminderEmails() {
      if (overdueReminderSendInFlight) return;
      if (!guardEdit()) return;
      if (!supabaseAvailable || !isSupabaseReady()) {
        alert(t('alert.sign_in_first'));
        return;
      }
      if (!isOwner()) {
        alert('Only the owner account can send overdue reminder emails.');
        return;
      }

      const confirmSend = confirm('Send overdue reminder emails now to opted-in parents with valid emails?');
      if (!confirmSend) return;

      const btn = document.getElementById('sendOverdueReminderEmailsBtn');
      const accessToken = requireAccessToken(t('alert.sign_in_first'));
      overdueReminderSendInFlight = true;
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Sending reminders...';
      }
      setOverdueReminderEmailStatus('Sending overdue reminders...', 'info');

      try {
        const { data, error } = await supabaseClient.functions.invoke('send-overdue-invoice-reminders', {
          body: { dry_run: false },
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (error) {
          const ctx = error?.context || {};
          let message = error?.message || 'Failed to send overdue reminders.';
          if (ctx.body) {
            try {
              const parsed = typeof ctx.body === 'string' ? JSON.parse(ctx.body) : ctx.body;
              message = parsed?.error || parsed?.message || message;
            } catch (_) { }
          }
          throw new Error(message);
        }

        const sent = Number(data?.sent_count || 0);
        const failed = Number(data?.failed_count || 0);
        const skipped = data?.skipped || {};
        const skippedTotal = Number(skipped?.no_email || 0)
          + Number(skipped?.invalid_email || 0)
          + Number(skipped?.opt_out || 0)
          + Number(skipped?.cooldown || 0);
        const summary = `Done. Sent: ${sent}. Failed: ${failed}. Skipped: ${skippedTotal}.`;
        setOverdueReminderEmailStatus(summary, failed > 0 ? 'error' : 'success');
        logActivity('Sent overdue reminder emails', summary);
      } catch (err) {
        console.error('Overdue reminder send failed', err);
        setOverdueReminderEmailStatus(err?.message || 'Failed to send overdue reminders.', 'error');
      } finally {
        overdueReminderSendInFlight = false;
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Send overdue reminder emails';
        }
      }
    }

    async function sendOverdueReminderTestEmail() {
      if (overdueReminderTestSendInFlight) return;
      if (!guardEdit()) return;
      if (!supabaseAvailable || !isSupabaseReady()) {
        alert(t('alert.sign_in_first'));
        return;
      }
      if (!isOwner()) {
        alert('Only the owner account can send test reminder emails.');
        return;
      }

      const confirmSend = confirm('Send a test overdue reminder email to eh8125809@gmail.com now?');
      if (!confirmSend) return;

      const btn = document.getElementById('sendOverdueReminderTestEmailBtn');
      const accessToken = requireAccessToken(t('alert.sign_in_first'));
      overdueReminderTestSendInFlight = true;
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Sending test email...';
      }
      setOverdueReminderEmailStatus('Sending test reminder email...', 'info');

      try {
        const { data, error } = await supabaseClient.functions.invoke('send-overdue-invoice-reminders', {
          body: { debug_test: true, dry_run: false },
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (error) {
          const ctx = error?.context || {};
          let message = error?.message || 'Failed to send test reminder email.';
          if (ctx.body) {
            try {
              const parsed = typeof ctx.body === 'string' ? JSON.parse(ctx.body) : ctx.body;
              message = parsed?.error || parsed?.message || message;
            } catch (_) { }
          }
          throw new Error(message);
        }
        const debugEmail = String(data?.debug_target_email || 'eh8125809@gmail.com');
        const invoiceId = String(data?.invoice_id || '');
        const summary = invoiceId
          ? `Test email sent to ${debugEmail} (invoice ${invoiceId}).`
          : `Test email sent to ${debugEmail}.`;
        setOverdueReminderEmailStatus(summary, 'success');
        logActivity('Sent test overdue reminder email', summary);
      } catch (err) {
        console.error('Overdue reminder test send failed', err);
        setOverdueReminderEmailStatus(err?.message || 'Failed to send test reminder email.', 'error');
      } finally {
        overdueReminderTestSendInFlight = false;
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Send test reminder email (eh8125809@gmail.com)';
        }
      }
    }

    function renderFinanceView() {
      const showVoided = !!state.settings.showVoidedInvoices;
      const knownStudentIds = new Set((state.students || []).map(s => cleanId(s.id)).filter(Boolean));
      const financeInvoices = (state.invoices || []).filter(inv =>
        knownStudentIds.has(cleanId(inv.studentId || inv.student_id || ''))
      );
      const toggleBtn = document.getElementById('toggleVoidedInvoicesBtn');
      if (toggleBtn) {
        toggleBtn.classList.toggle('hidden', studentMode || parentMode);
        toggleBtn.textContent = showVoided ? t('finance.hide_voided') : t('finance.show_voided');
        toggleBtn.onclick = () => {
          state.settings.showVoidedInvoices = !state.settings.showVoidedInvoices;
          saveState();
          renderFinanceView();
          if (selectedStudentId) renderStudentFinance(selectedStudentId);
        };
      }
      const reminderBtn = document.getElementById('sendOverdueReminderEmailsBtn');
      if (reminderBtn) {
        reminderBtn.disabled = readOnlyMode || overdueReminderSendInFlight || overdueReminderTestSendInFlight;
        reminderBtn.textContent = overdueReminderSendInFlight ? 'Sending reminders...' : 'Send overdue reminder emails';
      }
      const reminderTestBtn = document.getElementById('sendOverdueReminderTestEmailBtn');
      if (reminderTestBtn) {
        reminderTestBtn.disabled = readOnlyMode || overdueReminderSendInFlight || overdueReminderTestSendInFlight;
        reminderTestBtn.textContent = overdueReminderTestSendInFlight
          ? 'Sending test email...'
          : 'Send test reminder email (eh8125809@gmail.com)';
      }
      const tbody = document.getElementById('financeStudentTable');
      if (!state.students.length) {
        tbody.innerHTML = '';
      } else {
        tbody.innerHTML = state.students.map(s => {
          const invs = state.invoices.filter(inv => inv.studentId === s.id);
          let balance = 0;
          let unpaidCount = 0;
          invs.forEach(inv => {
            if (invoiceRequiresPayment(inv)) {
              balance += Number(inv.total || 0);
              unpaidCount++;
            }
          });
          return `<tr>
            <td class="py-1 pr-1">${esc(s.name || '')}</td>
            <td class="py-1 pr-1 text-right ${balance > 0 ? 'text-rose-600' : 'text-emerald-600'}">
              R ${balance.toFixed(2)}
            </td>
            <td class="py-1 pr-1 text-right">${unpaidCount}</td>
          </tr>`;
        }).join('');
      }

      const overdueList = document.getElementById('overdueInvoicesList');
      const today = new Date();
      const overdue = financeInvoices.filter(inv => invoiceRequiresPayment(inv) && inv.dueDate && new Date(inv.dueDate) < today)
        .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

      if (!overdue.length) {
        overdueList.innerHTML = `<li class="text-slate-500">${esc(t('finance.no_overdue'))}</li>`;
      } else {
        overdueList.innerHTML = overdue.map(inv => {
          const s = getStudentById(inv.studentId);
          const studentName = esc(s?.name || t('common.unknown'));
          const safeInvId = cleanId(inv.id);
          const dueLine = t('finance.invoice_due_line', {
            id: inv.id,
            date: inv.dueDate || t('common.na'),
            total: Number(inv.total || 0).toFixed(2)
          });
          const feesLabel = [
            inv.lateApplied && inv.lateFeePercent ? `Late ${inv.lateFeePercent}%` : '',
            inv.shortApplied && inv.shortNoticePercent ? `Short ${inv.shortNoticePercent}%` : ''
          ].filter(Boolean).join(' ');
          return `<li class="border border-rose-200 bg-rose-50 text-rose-900 rounded-lg px-2 py-1">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-medium">${studentName}</div>
                <div class="text-[10px]">${esc(dueLine)}</div>
                ${feesLabel ? `<div class="text-[10px]">${esc(t('finance.fees_line', { fees: feesLabel.trim() }))}</div>` : ''}
              </div>
              <div class="flex flex-col gap-1">
                <button class="text-[10px] px-2 py-0.5 rounded-lg border border-rose-300 bg-rose-100"
                        onclick="markInvoicePaid('${safeInvId}')">
                  ${esc(t('finance.mark_paid'))}
                </button>
                <button class="text-[10px] px-2 py-0.5 rounded-lg border border-rose-300 bg-white"
                        onclick="generateReminder('${safeInvId}')">
                  ${esc(t('finance.reminder_text'))}
                </button>
              </div>
            </div>
          </li>`;
        }).join('');
      }

      const unbilledList = document.getElementById('unbilledList');
      if (unbilledList) {
        const unbilledSessions = state.sessions.filter(sess => !sess.invoiceId && !isSessionVoided(sess));
        const grouped = {};
        unbilledSessions.forEach(sess => {
          (sess.studentIds || []).forEach(sid => {
            if (!grouped[sid]) grouped[sid] = [];
            grouped[sid].push(sess);
          });
        });
        const unbilled = Object.entries(grouped).map(([sid, sessList]) => {
          const student = getStudentById(sid);
          const hours = sessList.reduce((acc, s) => acc + Number(s.durationHours || 0), 0);
          const amount = sessList.reduce((sum, s) => sum + getSessionBillableAmount(s, student), 0);
          const lastDate = sessList.length ? sessList.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date : 'n/a';
          return { student, hours, amount, lastDate };
        }).filter(item => item.student)
          .sort((a, b) => b.amount - a.amount)
          .slice(0, 6);
        if (!unbilled.length) {
          unbilledList.innerHTML = `<li class="text-slate-500">${esc(t('finance.no_unbilled'))}</li>`;
        } else {
          unbilledList.innerHTML = unbilled.map(item => `
            <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
              <div>
                <div class="font-medium">${esc(item.student.name || '')}</div>
                <div class="text-[10px] text-slate-500">${esc(t('finance.unbilled_item', { hours: item.hours.toFixed(1), date: item.lastDate || t('common.na') }))}</div>
              </div>
              <div class="text-right text-[11px] font-semibold">R ${esc(item.amount.toFixed(0))}</div>
            </li>
          `).join('');
        }
      }

      const forecastList = document.getElementById('forecastList');
      const forecastSummary = document.getElementById('forecastSummary');
      if (forecastList && forecastSummary) {
        const soonCutoff = new Date();
        soonCutoff.setDate(soonCutoff.getDate() + 14);
        const overdueInvoices = financeInvoices.filter(inv => invoiceRequiresPayment(inv) && inv.dueDate && new Date(inv.dueDate) < today);
        const dueSoon = financeInvoices
          .filter(inv => invoiceRequiresPayment(inv) && inv.dueDate && new Date(inv.dueDate) >= today && new Date(inv.dueDate) <= soonCutoff)
          .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        const overdueTotal = overdueInvoices.reduce((sum, inv) => sum + Number(inv.total || 0), 0);
        const dueSoonTotal = dueSoon.reduce((sum, inv) => sum + Number(inv.total || 0), 0);
        forecastSummary.textContent = t('finance.forecast_summary', { due: dueSoonTotal.toFixed(0), overdue: overdueTotal.toFixed(0) });
        if (!dueSoon.length) {
          forecastList.innerHTML = `<li class="text-slate-500">${esc(t('finance.no_due_14'))}</li>`;
        } else {
          forecastList.innerHTML = dueSoon.map(inv => {
            const s = getStudentById(inv.studentId);
            return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
              <div>
                <div class="font-medium">${esc(s?.name || t('common.unknown'))}</div>
                <div class="text-[10px] text-slate-500">${esc(t('finance.invoice_due_line', { id: inv.id, date: inv.dueDate || t('common.na'), total: Number(inv.total || 0).toFixed(2) }))}</div>
              </div>
              <div class="text-right text-[11px] font-semibold">R ${esc(Number(inv.total || 0).toFixed(0))}</div>
            </li>`;
          }).join('');
        }
      }
    }

    function renderReportsView() {
      // Earnings month
      const now = new Date();
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      const invs = state.invoices.filter(inv => {
        const d = new Date(inv.issueDate || inv.dueDate || 0);
        return d >= startOfMonth && d < endOfMonth && !isInvoiceVoid(inv);
      });
      const earnings = invs.reduce((sum, inv) => sum + Number(inv.total || 0), 0);

      // Attendance
      const totalSessions = state.sessions.filter(s => getSessionStatus(s) !== SESSION_STATUS.VOIDED).length;
      const completedSessions = state.sessions.filter(s => getSessionStatus(s) === SESSION_STATUS.COMPLETE).length;
      const attendancePct = totalSessions ? Math.round((completedSessions / totalSessions) * 100) : 0;

      // Homework completion
      const hwTotal = state.homework.length;
      const hwCompleted = state.homework.filter(h => h.status === 'Completed').length;
      const hwPct = hwTotal ? Math.round((hwCompleted / hwTotal) * 100) : 0;

      // Subject hours
      const subjectKeys = {
        Physics: 'subjects.physics',
        Chemistry: 'subjects.chemistry',
        Maths: 'subjects.maths'
      };
      const subjectHours = { Physics: 0, Chemistry: 0, Maths: 0 };
      state.sessions.forEach(s => {
        if (getSessionStatus(s) === SESSION_STATUS.VOIDED) return;
        if (subjectHours[s.subject] != null) subjectHours[s.subject] += Number(s.durationHours || 0);
      });

      // Unpaid invoices
      const unpaid = state.invoices.filter(inv => invoiceRequiresPayment(inv))
        .sort((a, b) => new Date(a.dueDate || 0) - new Date(b.dueDate || 0));

      const reportEarnings = document.getElementById('repEarningsMonth');
      const reportEarningsCount = document.getElementById('repEarningsCount');
      const reportAttendance = document.getElementById('repAttendance');
      const reportAttendanceMeta = document.getElementById('repAttendanceMeta');
      const reportHomework = document.getElementById('repHomework');
      const reportHomeworkMeta = document.getElementById('repHomeworkMeta');
      if (reportEarnings) reportEarnings.textContent = 'R ' + earnings.toFixed(2);
      if (reportEarningsCount) reportEarningsCount.textContent = t('reports.invoices_this_month', { count: invs.length });
      if (reportAttendance) reportAttendance.textContent = attendancePct + '%';
      if (reportAttendanceMeta) reportAttendanceMeta.textContent = t('reports.completed_summary', { completed: completedSessions, total: totalSessions });
      if (reportHomework) reportHomework.textContent = hwPct + '%';
      if (reportHomeworkMeta) reportHomeworkMeta.textContent = t('reports.completed_summary', { completed: hwCompleted, total: hwTotal });

      const mixUl = document.getElementById('repSubjectMix');
      if (mixUl) {
        mixUl.innerHTML = Object.entries(subjectHours).map(([k, v]) => {
          const labelKey = subjectKeys[k];
          const label = labelKey ? t(labelKey) : k;
          return `<li class="flex justify-between"><span>${esc(label)}</span><span>${esc(v.toFixed(1))}h</span></li>`;
        }).join('');
      }
      const unpaidUl = document.getElementById('repUnpaidList');
      if (unpaidUl) {
        unpaidUl.innerHTML = unpaid.length ? unpaid.map(inv => {
          const stu = esc(getStudentById(inv.studentId)?.name || t('common.student'));
          const dueLine = t('finance.invoice_due_line', {
            id: inv.id,
            date: inv.dueDate || t('common.na'),
            total: Number(inv.total || 0).toFixed(2)
          });
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${stu}</div>
            <div class="text-[10px] text-slate-500">${esc(dueLine)}</div>
          </li>`;
        }).join('') : `<li class="text-slate-500 text-xs">${esc(t('reports.no_unpaid'))}</li>`;
      }
    }

    function markInvoicePaid(id) {
      if (!guardEdit()) return;
      const inv = getInvoiceById(id);
      if (!inv) return;
      if (isInvoiceVoid(inv)) {
        alert(t('alert.invoice_voided'));
        return;
      }
      if (!inv.paid) {
        const student = getStudentById(inv.studentId);
        if ((inv.invoiceType || inv.invoice_type) === 'monthly' && student) {
          recalculateMonthlyInvoice(inv, student, new Date());
        }
        inv.paid = true;
        inv.paidAt = new Date().toISOString();
        inv.paymentProvider = 'Cash';
        inv.paymentMethod = 'cash';
        inv.invoiceStatus = 'paid';
        applyPaidMoveInvoices();
      }
      saveState();
      renderFinanceView();
      if (selectedStudentId) renderStudentFinance(selectedStudentId);
      renderScheduleView();
      renderStudentsView();
    }

    function generateReminder(id) {
      const inv = getInvoiceById(id);
      if (!inv) return;
      const s = getStudentById(inv.studentId);
      const name = s?.name || t('common.student');
      const today = new Date().toISOString().slice(0, 10);
      const text = t('finance.reminder_template', {
        id: inv.id,
        name,
        issueDate: inv.issueDate || t('common.na'),
        total: Number(inv.total || 0).toFixed(2),
        dueDate: inv.dueDate || t('common.na'),
        merchant: MERCHANT_NAME,
        operator: OPERATOR_NAME,
        today
      });
      openModal(`
        <h2 class="text-sm font-semibold mb-2">${esc(t('finance.reminder_title'))}</h2>
        <textarea class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]" rows="8">${esc(text)}</textarea>
        <p class="mt-2 text-[10px] text-slate-500">
          ${esc(t('finance.reminder_copy_hint'))}
        </p>
      `);
    }

    /*************
     * MODALS    *
     *************/
    function openModal(html, onReady) {
      const overlay = document.getElementById('modalOverlay');
      const container = document.getElementById('modalContainer');
      container.innerHTML = `
        <div class="flex justify-between items-start mb-3">
          <div></div>
          <button id="modalCloseBtn" class="h-7 w-7 rounded-full border border-slate-300 flex items-center justify-center text-xs">‚úï</button>
        </div>
        ${html}
      `;
      overlay.classList.add('show');
      document.getElementById('modalCloseBtn').onclick = closeModal;
      overlay.onclick = (e) => {
        if (e.target === overlay) closeModal();
      };
      if (onReady) onReady();
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('show');
    }

    /***********************
     * STUDENT CRUD MODAL  *
     ***********************/
    async function openStudentModal(student) {
      if (!guardEdit()) return;
      if (isSupabaseReady() && isOwner()) {
        await loadAccountEmails().catch(err => console.warn('Account email fetch failed', err));
      }
      const isEdit = !!student;
      const emailOptions = getAvailableStudentEmails(student?.studentEmail).map(e => `<option value="${esc(e)}">${esc(e)}</option>`).join('');

      const existingCode = normalizeCode(student?.loginCode);
      const scheduleSlots = getScheduleSlots(student || {});
      const scheduleStartDate = student?.scheduleStartDate || student?.schedule_start_date || '';
      const scheduleTimezone = student?.scheduleTimezone || student?.schedule_timezone || DEFAULT_TIMEZONE;
      const defaultSlotDuration = Number(state.settings.defaultSessionDuration || 1);
      const scheduleNotes = student?.scheduleNotes || student?.schedule_notes || '';
      const codeSection = `
        <div class="mb-4 p-3 bg-indigo-50 border border-indigo-100 rounded-xl">
          <h3 class="text-xs font-semibold text-indigo-900 mb-2">üîë ${esc(t('students.login_code_title'))}</h3>
          <p class="text-[10px] text-indigo-700 mb-2">
            ${esc(t('students.login_code_hint'))}
          </p>
          <div class="flex gap-2">
            <button type="button" id="generateCodeBtn"
              class="px-3 py-1.5 bg-indigo-600 text-white text-xs rounded-lg hover:bg-indigo-700 transition shadow-sm w-full">
              ${esc(existingCode ? t('students.regenerate_code') : t('students.generate_code'))}
            </button>
            ${existingCode ? `<button type="button" id="copyExistingCodeBtn" class="px-3 py-1.5 bg-white border border-indigo-200 text-indigo-700 text-xs rounded-lg hover:bg-indigo-50 transition shadow-sm">${esc(t('common.copy'))}</button>` : ''}
          </div>
          <div id="codeResult" class="${existingCode ? '' : 'hidden'} mt-2 p-2 bg-white border border-indigo-200 rounded-lg">
            <div class="text-[10px] text-slate-500 mb-1">${esc(t('students.login_code_share'))}</div>
            <div class="flex items-center gap-2">
              <code id="generatedCodeDisplay" class="text-base font-mono font-bold text-slate-900 bg-slate-100 px-2 py-1 rounded select-all tracking-wide">${esc(existingCode || '')}</code>
              <button type="button" id="copyCodeBtn" class="text-[10px] text-indigo-600 hover:underline">${esc(t('common.copy'))}</button>
            </div>
          </div>
        </div>
        <hr class="border-slate-100 my-4">
      `;

      const html = `
        <h2 class="text-sm font-semibold mb-3">${esc(isEdit ? t('students.edit_title') : t('students.add_title'))}</h2>
        ${codeSection}
        <form id="studentForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">${esc(t('common.name'))}</label>
            <input name="name" value="${esc(student?.name || '')}" required
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <input type="hidden" name="loginCode" id="hiddenLoginCode" value="${esc(existingCode || '')}">
          
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">${esc(t('students.grade_level'))}</label>
              <input name="gradeLevel" value="${esc(student?.gradeLevel || '')}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div>
              <label class="block text-[11px] mb-1">${esc(t('students.hourly_rate'))}</label>
              <input name="rate" type="number" step="0.01" value="${esc(student?.rate || '')}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('students.subjects_comma'))}</label>
            <input name="subjects" value="${esc(student?.subjects?.join(', ') || '')}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('common.notes'))}</label>
            <textarea name="notes" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${esc(student?.notes || '')}</textarea>
          </div>
          <div class="border border-slate-200 rounded-lg p-2 bg-slate-50">
            <div class="text-[11px] font-semibold mb-1">${esc(t('schedule.preferences_title'))}</div>
            <div class="text-[10px] text-slate-500 mb-2">${esc(t('schedule.preferences_hint'))}</div>
            <div id="scheduleSlotsContainer" class="space-y-2"></div>
            <div id="scheduleSlotsEmpty" class="text-[10px] text-slate-500">${esc(t('schedule.no_slots'))}</div>
            <button type="button" id="addScheduleSlotBtn" class="mt-2 px-2 py-1 rounded-lg border border-slate-300 text-[11px]">
              ${esc(t('schedule.add_weekly_slot'))}
            </button>
            <div class="grid grid-cols-2 gap-2 mt-3">
              <div>
                <label class="block text-[11px] mb-1">${esc(t('schedule.start_date'))}</label>
                <input type="date" name="scheduleStartDate" value="${esc(scheduleStartDate)}"
                       class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              </div>
              <div>
                <label class="block text-[11px] mb-1">${esc(t('schedule.timezone'))}</label>
                <input name="scheduleTimezone" value="${esc(scheduleTimezone)}"
                       class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              </div>
            </div>
            <div class="mt-2">
              <label class="block text-[11px] mb-1">${esc(t('schedule.notes'))}</label>
              <input name="scheduleNotes" value="${esc(scheduleNotes)}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs" placeholder="${esc(t('common.optional'))}">
            </div>
          </div>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium">
              ${esc(isEdit ? t('common.save_changes') : t('students.add_submit'))}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteStudentBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                ${esc(t('common.delete'))}
              </button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        // Invite Code Logic
        const generateBtn = document.getElementById('generateCodeBtn');
        const resultBox = document.getElementById('codeResult');
        const codeDisplay = document.getElementById('generatedCodeDisplay');
        const copyBtn = document.getElementById('copyCodeBtn');
        const hiddenInput = document.getElementById('hiddenLoginCode');
        const copyExistingBtn = document.getElementById('copyExistingCodeBtn');

        if (copyExistingBtn && existingCode) {
          copyExistingBtn.onclick = () => {
            navigator.clipboard.writeText(existingCode);
            copyExistingBtn.textContent = t('common.copied');
            setTimeout(() => copyExistingBtn.textContent = t('common.copy'), 1800);
          };
        }

        generateBtn.onclick = () => {
          const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
          let code = '';
          for (let i = 0; i < 8; i++) code += alphabet[Math.floor(Math.random() * alphabet.length)];
          codeDisplay.textContent = code;
          hiddenInput.value = code;
          resultBox.classList.remove('hidden');
          generateBtn.textContent = t('students.regenerate_code');
        };

        if (copyBtn) {
          copyBtn.onclick = () => {
            if (!codeDisplay.textContent) return;
            navigator.clipboard.writeText(codeDisplay.textContent);
            copyBtn.textContent = t('common.copied_exclaim');
            setTimeout(() => copyBtn.textContent = t('common.copy'), 2000);
          };
        }

        const slotsContainer = document.getElementById('scheduleSlotsContainer');
        const slotsEmpty = document.getElementById('scheduleSlotsEmpty');
        const addSlotBtn = document.getElementById('addScheduleSlotBtn');
        const dayOptions = WEEKDAY_KEYS.map((key, idx) => `<option value="${idx}">${esc(t(key))}</option>`).join('');

        function updateSlotsEmpty() {
          if (!slotsEmpty) return;
          const hasSlots = slotsContainer && slotsContainer.querySelector('.schedule-slot-row');
          slotsEmpty.classList.toggle('hidden', !!hasSlots);
        }

        function addSlotRow(slot = {}) {
          if (!slotsContainer) return;
          const row = document.createElement('div');
          row.className = 'schedule-slot-row grid grid-cols-[1.1fr_1fr_1fr_1fr_auto] gap-2 items-end';
          const dayOfWeek = Number(slot.dayOfWeek ?? slot.day_of_week ?? 1);
          const startTime = normalizeTimeValue(slot.startTime || slot.start_time || '16:00');
          const durationHours = Number(slot.durationHours || slot.duration_hours || defaultSlotDuration || 1);
          const sessionMode = getSlotSessionMode(slot, 'in_person');
          row.innerHTML = `
            <div>
              <label class="block text-[10px] mb-1">${esc(t('common.day'))}</label>
              <select class="slot-day w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                ${dayOptions}
              </select>
            </div>
            <div>
              <label class="block text-[10px] mb-1">${esc(t('common.start_time'))}</label>
              <input type="time" class="slot-time w-full border border-slate-300 rounded-lg px-2 py-1 text-xs" value="${esc(startTime)}">
            </div>
            <div>
              <label class="block text-[10px] mb-1">${esc(t('common.duration_hours'))}</label>
              <input type="number" step="0.25" class="slot-duration w-full border border-slate-300 rounded-lg px-2 py-1 text-xs" value="${esc(durationHours)}">
            </div>
            <div>
              <label class="block text-[10px] mb-1">${esc(t('common.mode'))}</label>
              <select class="slot-mode w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                <option value="in_person">${esc(t('schedule.in_person'))}</option>
                <option value="online">${esc(t('schedule.online'))}</option>
              </select>
            </div>
            <button type="button" class="remove-slot-btn px-2 py-1 rounded-lg border border-slate-300 text-[11px]">${esc(t('common.remove'))}</button>
          `;
          const daySelect = row.querySelector('.slot-day');
          if (daySelect) daySelect.value = String(Number.isFinite(dayOfWeek) ? dayOfWeek : 1);
          const modeSelect = row.querySelector('.slot-mode');
          if (modeSelect) modeSelect.value = sessionMode;
          const removeBtn = row.querySelector('.remove-slot-btn');
          if (removeBtn) {
            removeBtn.onclick = () => {
              row.remove();
              updateSlotsEmpty();
            };
          }
          slotsContainer.appendChild(row);
          updateSlotsEmpty();
        }

        (scheduleSlots || []).forEach(slot => addSlotRow(slot));
        updateSlotsEmpty();
        if (addSlotBtn) {
          addSlotBtn.onclick = () => addSlotRow({ dayOfWeek: 1, startTime: '16:00', durationHours: defaultSlotDuration, timezone: scheduleTimezone, sessionMode: 'in_person' });
        }

        document.getElementById('studentForm').onsubmit = (e) => {
          e.preventDefault();
          const form = e.target;
          const slotRows = [...form.querySelectorAll('.schedule-slot-row')];
          const scheduleTimezoneValue = (form.scheduleTimezone.value || DEFAULT_TIMEZONE).trim() || DEFAULT_TIMEZONE;
          const collectedSlots = [];
          for (const row of slotRows) {
            const day = Number(row.querySelector('.slot-day')?.value);
            const startTime = normalizeTimeValue(row.querySelector('.slot-time')?.value || '');
            const duration = Number(row.querySelector('.slot-duration')?.value || 0);
            const mode = normalizeSessionMode(row.querySelector('.slot-mode')?.value || 'in_person');
            if (!startTime || !Number.isFinite(day) || day < 0 || day > 6 || duration <= 0) {
              alert(t('alert.schedule_slot_incomplete'));
              return;
            }
            collectedSlots.push({
              dayOfWeek: day,
              startTime,
              durationHours: duration,
              timezone: scheduleTimezoneValue,
              sessionMode: mode
            });
          }
          const newStudent = {
            id: student?.id || generateId('stu'),
            name: form.name.value.trim(),
            gradeLevel: form.gradeLevel.value.trim(),
            rate: Number(form.rate.value || 0),
            subjects: form.subjects.value.split(',').map(s => s.trim()).filter(Boolean),
            notes: form.notes.value.trim(),
            studentEmail: '', // No longer using explicit email linking here
            loginCode: normalizeCode(form.loginCode?.value || student?.loginCode || ''), // Save the Code
            contractSigned: student?.contractSigned || false,
            contractSignedAt: student?.contractSignedAt || null,
            contractVersion: student?.contractVersion || 'v1',
            contractSignerName: student?.contractSignerName || '',
            contractSignerEmail: student?.contractSignerEmail || '',
            scheduleSlots: collectedSlots,
            scheduleDays: getScheduleDaysFromSlots(collectedSlots),
            preferredTime: collectedSlots[0]?.startTime || '',
            scheduleStartDate: form.scheduleStartDate.value,
            sessionLengthHours: Number(collectedSlots[0]?.durationHours || state.settings.defaultSessionDuration || 1),
            scheduleTimezone: scheduleTimezoneValue,
            scheduleNotes: form.scheduleNotes.value.trim()
          };

          if (!newStudent.name) {
            alert(t('alert.name_required'));
            return;
          }
          if (newStudent.scheduleSlots.length === 0) {
            // schedule is optional, but warn if start date exists without slots
            if (newStudent.scheduleStartDate) {
              const ok = confirm(t('confirm.no_schedule_slots_continue'));
              if (!ok) return;
            }
          }

          // Validation: If adding, emphasize code?
          if (!isEdit && !newStudent.loginCode) {
            if (!confirm(t('confirm.student_no_login_code'))) return;
          }

        if (isEdit) {
          const idx = state.students.findIndex(s => s.id === student.id);
          state.students[idx] = newStudent;
          logActivity('Updated student', newStudent.name);
        } else {
          state.students.push(newStudent);
          logActivity('Added student', newStudent.name);
        }
        refreshAutoBilling();
        saveState();
        closeModal();
        renderStudentsView();

        // Provision Supabase auth account for code-based login
        if (newStudent.loginCode && isSupabaseReady() && isOwner()) {
          provisionLoginCode('student', newStudent.loginCode, { studentId: newStudent.id, fullName: newStudent.name });
        }
        };
        if (isEdit) {
          document.getElementById('deleteStudentBtn').onclick = () => {
            if (!confirm(t('confirm.delete_student'))) return;
            deleteStudentAndDependencies(student.id).then(() => {
              closeModal();
              selectedStudentId = null;
              renderStudentsView();
              logActivity('Deleted student', student.name);
            }).catch(err => {
              console.error(err);
              alert(err?.message || t('alert.delete_failed'));
            });
          };
        }
      });
    }

    /***********************
     * SESSION CRUD MODAL  *
     ***********************/
    function openSessionModal(session) {
      if (!guardEdit()) return;
      const isEdit = !!session;
      const html = `
        <h2 class="text-sm font-semibold mb-3">${esc(isEdit ? t('sessions.edit_title') : t('sessions.add_title'))}</h2>
        <div class="flex items-center gap-2 mb-2">
          <button type="button" id="aiSuggestPlanBtn" class="px-2 py-1 rounded-lg border border-indigo-300 text-[10px] text-indigo-700 hover:bg-indigo-50" data-owner-only>
            ${esc(t('sessions.ai_suggest'))}
          </button>
          <span class="hint">${esc(t('common.owner_only'))}</span>
        </div>
        <form id="sessionForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">${esc(t('students.title'))}</label>
            <div class="grid grid-cols-2 gap-1 max-h-32 overflow-y-auto border border-slate-300 rounded-lg px-2 py-1">
              ${state.students.length
          ? state.students.map(s => `
                      <label class="flex items-center gap-1 text-[11px]">
                        <input type="checkbox" name="studentIds" value="${cleanId(s.id)}"
                          ${session?.studentIds?.includes(s.id) ? 'checked' : ''}>
                        <span>${esc(s.name)}</span>
                      </label>
                    `).join('')
          : `<div class="text-slate-500 text-[11px]">${esc(t('sessions.no_students'))}</div>`
        }
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">${esc(t('common.date'))}</label>
              <input type="date" name="date" value="${esc(session?.date || new Date().toISOString().slice(0, 10))}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs" required>
            </div>
            <div>
              <label class="block text-[11px] mb-1">${esc(t('common.start_time'))}</label>
              <input type="time" name="startTime" value="${esc(session?.startTime || '16:00')}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">${esc(t('common.duration_hours'))}</label>
              <input type="number" step="0.25" name="durationHours" value="${esc((session?.durationHours ?? state.settings.defaultSessionDuration) || 1)}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div>
              <label class="block text-[11px] mb-1">${esc(t('common.subject'))}</label>
              <select name="subject" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                <option value="Physics" ${session?.subject === 'Physics' ? 'selected' : ''}>${esc(t('subjects.physics'))}</option>
                <option value="Chemistry" ${session?.subject === 'Chemistry' ? 'selected' : ''}>${esc(t('subjects.chemistry'))}</option>
                <option value="Maths" ${session?.subject === 'Maths' ? 'selected' : ''}>${esc(t('subjects.maths'))}</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">${esc(t('common.mode'))}</label>
              <select name="sessionMode" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                <option value="in_person">${esc(t('schedule.in_person'))}</option>
                <option value="online">${esc(t('schedule.online'))}</option>
              </select>
            </div>
            <div class="text-[10px] text-slate-500 flex items-end pb-1">
              ${esc(t('schedule.online_join_hint'))}
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('sessions.topic_focus'))}</label>
            <input name="topic" value="${esc(session?.topic || '')}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('common.notes'))}</label>
            <textarea name="notes" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${esc(session?.notes || '')}</textarea>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">${esc(t('sessions.status_label'))}</label>
              <select name="sessionStatus" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                <option value="${SESSION_STATUS.SCHEDULED}">${esc(t('sessions.status_scheduled'))}</option>
                <option value="${SESSION_STATUS.RESTORED}">${esc(t('sessions.status_restored'))}</option>
                <option value="${SESSION_STATUS.COMPLETE}">${esc(t('sessions.status_complete'))}</option>
                <option value="${SESSION_STATUS.PENDING_REVIEW}">${esc(t('sessions.status_pending_review'))}</option>
                <option value="${SESSION_STATUS.NO_SHOW_CHARGEABLE}">${esc(t('sessions.status_no_show_chargeable'))}</option>
                <option value="${SESSION_STATUS.VOIDED}">${esc(t('sessions.status_voided'))}</option>
              </select>
            </div>
            <div>
              <label class="block text-[11px] mb-1">${esc(t('sessions.absence_reason_label'))}</label>
              <select name="absenceReason" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                <option value="">${esc(t('common.none'))}</option>
                <option value="${SESSION_ABSENCE_REASONS.STUDENT_NO_SHOW}">${esc(t('sessions.absence_student_no_show'))}</option>
                <option value="${SESSION_ABSENCE_REASONS.TUTOR_ABSENT}">${esc(t('sessions.absence_tutor_absent'))}</option>
                <option value="${SESSION_ABSENCE_REASONS.CANCELLED_IN_TIME}">${esc(t('sessions.absence_cancelled_in_time'))}</option>
                <option value="${SESSION_ABSENCE_REASONS.CANCELLED_LATE}">${esc(t('sessions.absence_cancelled_late'))}</option>
                <option value="${SESSION_ABSENCE_REASONS.ADMIN_VOID}">${esc(t('sessions.absence_admin_void'))}</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">${esc(t('sessions.billing_rate_label'))}</label>
              <input type="number" step="1" min="0" name="billingRate" value="${esc(session?.billingRate ?? session?.billing_rate ?? '')}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs" placeholder="0">
            </div>
            <div class="text-[10px] text-slate-500 flex items-end pb-1">
              ${esc(t('sessions.billing_rate_hint'))}
            </div>
          </div>
          ${isEdit ? `
            <div class="rounded-lg border border-amber-200 bg-amber-50/70 p-2">
              <label class="flex items-center gap-2 text-[11px]">
                <input type="checkbox" name="rescheduleNoInvoice">
                <span>${esc(t('sessions.reschedule_no_invoice'))}</span>
              </label>
              <div class="text-[10px] text-amber-800 mt-1">
                ${esc(t('sessions.reschedule_no_invoice_hint'))}
              </div>
            </div>
          ` : ''}
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium">
              ${esc(isEdit ? t('common.save_changes') : t('sessions.add_title'))}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteSessionBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                ${esc(t('sessions.void'))}
              </button>` : ''}
          </div>
          <div id="sessionClashWarning" class="mt-2 text-[10px] text-amber-600"></div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('sessionForm');
        if (form?.sessionMode) {
          form.sessionMode.value = normalizeSessionMode(session?.sessionMode ?? session?.session_mode ?? 'in_person');
        }
        if (form?.sessionStatus) {
          form.sessionStatus.value = getSessionStatus(session || {});
        }
        if (form?.absenceReason) {
          form.absenceReason.value = String(session?.absenceReason || session?.absence_reason || '').trim().toLowerCase();
        }

        function updateBillingRateUI() {
          if (!form?.billingRate) return;
          const ids = [...form.querySelectorAll('input[name="studentIds"]:checked')].map(i => i.value);
          if (ids.length !== 1) {
            form.billingRate.value = '';
            form.billingRate.disabled = true;
            return;
          }
          form.billingRate.disabled = false;
          if (form.billingRate.value) return;
          const stu = getStudentById(ids[0]);
          const existingRate = Number(session?.billingRate ?? session?.billing_rate ?? 0);
          const fallbackRate = Number(stu?.rate || 0);
          const rate = existingRate > 0 ? existingRate : (fallbackRate > 0 ? fallbackRate : 0);
          if (rate > 0) form.billingRate.value = String(rate);
        }
        updateBillingRateUI();

        function updateClashWarning() {
          const date = form.date.value;
          const startTime = form.startTime.value || '00:00';
          const durationHours = Number(form.durationHours.value || 1);
          const selectedIds = [...form.querySelectorAll('input[name="studentIds"]:checked')].map(i => i.value);
          const warningEl = document.getElementById('sessionClashWarning');
          const clashes = state.sessions.filter(s => {
            if (isEdit && s.id === session.id) return false;
            if (s.date !== date) return false;
            const shared = s.studentIds.some(id => selectedIds.includes(id));
            if (!shared) return false;
            const aStart = timeToMinutes(startTime);
            const aEnd = aStart + durationHours * 60;
            const bStart = timeToMinutes(s.startTime || '00:00');
            const bEnd = bStart + Number(s.durationHours || 1) * 60;
            return !(aEnd <= bStart || bEnd <= aStart);
          });
          if (clashes.length) {
            warningEl.textContent = t('sessions.clash_warning');
          } else {
            warningEl.textContent = '';
          }
        }

        const originalSnapshot = (isEdit && session)
          ? {
            date: session.date || '',
            startTime: normalizeTimeValue(session.startTime || ''),
            durationHours: Number(session.durationHours || 1)
          }
          : null;
        const originalStatus = getSessionStatus(session || {});

        function maybeAutoUpdateStatusForFuture() {
          if (!form?.sessionStatus) return;
          const date = form.date.value;
          if (!date) return;
          const startTime = normalizeTimeValue(form.startTime.value || '00:00');
          const durationHours = Number(form.durationHours.value || 1);
          const probe = { date, startTime, durationHours };
          // If it's in the future, pending_review should not stick around; treat date edits as rescheduling.
          if (hasSessionEnded(probe, new Date())) return;
          const statusVal = normalizeSessionStatus(form.sessionStatus.value, originalStatus || SESSION_STATUS.SCHEDULED);
          if (!originalSnapshot) {
            if (statusVal === SESSION_STATUS.PENDING_REVIEW) form.sessionStatus.value = SESSION_STATUS.SCHEDULED;
            return;
          }
          const changed = originalSnapshot.date !== date ||
            originalSnapshot.startTime !== startTime ||
            Number(originalSnapshot.durationHours || 0) !== Number(durationHours || 0);
          if (!changed) return;
          if (originalStatus === SESSION_STATUS.VOIDED && statusVal === SESSION_STATUS.VOIDED) {
            form.sessionStatus.value = SESSION_STATUS.RESTORED;
            return;
          }
          if (statusVal === SESSION_STATUS.PENDING_REVIEW) {
            form.sessionStatus.value = SESSION_STATUS.SCHEDULED;
            return;
          }
        }

        ['change', 'input'].forEach(ev => {
          form.date.addEventListener(ev, () => { updateClashWarning(); maybeAutoUpdateStatusForFuture(); });
          form.startTime.addEventListener(ev, () => { updateClashWarning(); maybeAutoUpdateStatusForFuture(); });
          form.durationHours.addEventListener(ev, () => { updateClashWarning(); maybeAutoUpdateStatusForFuture(); });
          form.querySelectorAll('input[name="studentIds"]').forEach(cb => cb.addEventListener(ev, () => {
            updateClashWarning();
            updateBillingRateUI();
          }));
        });
        updateClashWarning();

        form.onsubmit = (e) => {
          e.preventDefault();
          const selectedIds = [...form.querySelectorAll('input[name="studentIds"]:checked')].map(i => i.value);
          if (!selectedIds.length) {
            alert(t('alert.select_student_at_least_one'));
            return;
          }
          const newSession = {
            id: session?.id || generateId('sess'),
            studentIds: selectedIds,
            date: form.date.value,
            startTime: normalizeTimeValue(form.startTime.value),
            durationHours: Number(form.durationHours.value || 1),
            subject: form.subject.value,
            topic: form.topic.value.trim(),
            notes: form.notes.value.trim(),
            attended: session?.attended || false,
            completed: session?.completed || false,
            status: normalizeSessionStatus(form.sessionStatus?.value || session?.status || '', getSessionStatus(session || {})),
            absenceReason: String(form.absenceReason?.value || session?.absenceReason || '').trim().toLowerCase(),
            pendingReviewStartedAt: session?.pendingReviewStartedAt || session?.pending_review_started_at || '',
            billingRate: selectedIds.length === 1
              ? (Number(form.billingRate?.value || session?.billingRate || session?.billing_rate || getStudentById(selectedIds[0])?.rate || 0) || null)
              : null,
            invoiceId: session?.invoiceId || '',
            sessionMode: normalizeSessionMode(form.sessionMode?.value || session?.sessionMode || 'in_person'),
            meetingProvider: session?.meetingProvider || session?.meeting_provider || '',
            meetingRoom: session?.meetingRoom || session?.meeting_room || '',
            meetingStatus: session?.meetingStatus || session?.meeting_status || '',
            meetingStartedAt: session?.meetingStartedAt || session?.meeting_started_at || '',
            meetingEndedAt: session?.meetingEndedAt || session?.meeting_ended_at || ''
          };
          if (newSession.sessionMode === 'online' && !newSession.meetingProvider) {
            newSession.meetingProvider = 'JaaS';
          }
          if (newSession.sessionMode !== 'online') {
            newSession.meetingProvider = '';
            newSession.meetingRoom = '';
            newSession.meetingStatus = '';
          }

          // Normalize status -> legacy booleans for backward compatibility.
          const prevStatus = isEdit && session ? getSessionStatus(session) : SESSION_STATUS.SCHEDULED;
          const nextStatus = normalizeSessionStatus(newSession.status, prevStatus || SESSION_STATUS.SCHEDULED);
          newSession.status = nextStatus;
          if (nextStatus === SESSION_STATUS.COMPLETE) {
            newSession.attended = true;
            newSession.completed = true;
            newSession.pendingReviewStartedAt = '';
          } else if (nextStatus === SESSION_STATUS.PENDING_REVIEW) {
            newSession.attended = false;
            newSession.completed = false;
            if (!newSession.pendingReviewStartedAt) newSession.pendingReviewStartedAt = new Date().toISOString();
          } else if (nextStatus === SESSION_STATUS.VOIDED) {
            newSession.attended = false;
            newSession.completed = false;
            newSession.pendingReviewStartedAt = '';
          } else if (nextStatus === SESSION_STATUS.NO_SHOW_CHARGEABLE) {
            newSession.attended = false;
            newSession.completed = false;
            newSession.pendingReviewStartedAt = '';
          } else {
            newSession.completed = false;
            if (!newSession.pendingReviewStartedAt) newSession.pendingReviewStartedAt = '';
          }
          // If the session is being rescheduled into the future, clear any pending-review timestamp.
          if (!hasSessionEnded(newSession, new Date()) &&
            (nextStatus === SESSION_STATUS.SCHEDULED || nextStatus === SESSION_STATUS.RESTORED)) {
            newSession.pendingReviewStartedAt = '';
          }
          const existingInvoice = session?.invoiceId ? state.invoices.find(i => i.id === session.invoiceId) : null;
          const allowUnpaidReschedule = isEdit &&
            existingInvoice &&
            (existingInvoice.invoiceType || existingInvoice.invoice_type) === 'monthly' &&
            !existingInvoice.paid &&
            !isInvoiceVoid(existingInvoice);
          const bypassInvoice = !!form.rescheduleNoInvoice?.checked;
          if (bypassInvoice) {
            const existingInvoice = session?.invoiceId ? state.invoices.find(i => i.id === session.invoiceId) : null;
            const paidExisting = existingInvoice && existingInvoice.paid && !isInvoiceVoid(existingInvoice);
            if (!paidExisting) newSession.invoiceId = '';
          }
          const within24 = isEdit && session && isWithin24Hours(session);
          const timeChanged = isEdit && session
            ? session.date !== newSession.date || (session.startTime || '') !== (newSession.startTime || '')
            : false;
          const durationChanged = isEdit && session
            ? Number(session.durationHours || 0) !== Number(newSession.durationHours || 0)
            : false;
          const isMoveRequest = within24 && (timeChanged || durationChanged) && !bypassInvoice;

          if (!bypassInvoice && (!isEdit || !isMoveRequest)) {
            if (!guardSessionCreation(selectedIds, form.date.value, { allowUnpaidInvoice: allowUnpaidReschedule })) return;
          }

          if (allowUnpaidReschedule && existingInvoice) {
            const startStr = existingInvoice.servicePeriodStart || existingInvoice.service_period_start || '';
            const endStr = existingInvoice.servicePeriodEnd || existingInvoice.service_period_end || '';
            if (startStr && endStr && !isDateWithinRange(newSession.date, startStr, endStr)) {
              newSession.invoiceId = '';
            }
          }

          if (isEdit && (timeChanged || durationChanged) && !isMoveRequest) {
            recordSessionCancellation({
              ...session,
              studentIds: [...(session.studentIds || [])],
              date: session.date,
              startTime: session.startTime,
              durationHours: session.durationHours
            }, bypassInvoice ? 'admin_reschedule' : 'rescheduled');
          }

          if (isMoveRequest && !bypassInvoice) {
            if (hasPendingMoveInvoice(session.id)) {
              alert(t('alert.move_request_pending'));
              return;
            }
            createLateChangeInvoices(session, 'moved', {
              date: newSession.date,
              startTime: newSession.startTime || '',
              durationHours: newSession.durationHours
            });
            const idx = state.sessions.findIndex(s => s.id === session.id);
            if (idx >= 0) {
              state.sessions[idx] = {
                ...session,
                studentIds: newSession.studentIds,
                subject: newSession.subject,
                topic: newSession.topic,
                notes: newSession.notes,
                status: newSession.status,
                absenceReason: newSession.absenceReason,
                pendingReviewStartedAt: newSession.pendingReviewStartedAt,
                billingRate: newSession.billingRate,
                sessionMode: newSession.sessionMode,
                meetingProvider: newSession.meetingProvider,
                meetingRoom: newSession.meetingRoom,
                meetingStatus: newSession.meetingStatus,
                meetingStartedAt: newSession.meetingStartedAt,
                meetingEndedAt: newSession.meetingEndedAt
              };
            }
            logActivity('Move requested', session.topic || session.subject || 'Session');
            saveState();
            closeModal();
            renderScheduleView();
            renderStudentsView();
            alert(t('alert.move_requested_pending_payment'));
            return;
          }

          if (isEdit && session) {
            const next = newSession.status;
            if (prevStatus !== next) {
              logActivity('Session status changed', `${prevStatus} ‚Üí ${next} (${newSession.date} ${newSession.startTime || ''})`);
            }
            // Restore rule: a restored session on a paid/locked invoice must be re-invoiced.
            if (prevStatus === SESSION_STATUS.VOIDED && next !== SESSION_STATUS.VOIDED) {
              const inv = session.invoiceId ? getInvoiceById(session.invoiceId) : null;
              const canRebillHere = inv && !isInvoiceLocked(inv);
              if (!canRebillHere && (newSession.studentIds || []).length === 1) {
                const sid = newSession.studentIds[0];
                const student = getStudentById(sid);
                // If a credit note was created when the session was voided, restore by voiding the credit note
                // instead of generating a new invoice (keeps paid invoice immutable without double-charging).
                let restoredByCredit = false;
                if (student && inv && isInvoiceLocked(inv)) {
                  const credit = findVoidedSessionCreditNote(sid, session.id);
                  if (credit && !isInvoiceVoid(credit)) {
                    credit.invoiceStatus = 'void';
                    credit.voidedAt = new Date().toISOString();
                    logActivity('Voided credit note', credit.id);
                    // Keep the session linked to the original paid invoice.
                    newSession.invoiceId = session.invoiceId || newSession.invoiceId;
                    restoredByCredit = true;
                  }
                }
                if (!restoredByCredit) {
                  const already = student && hasLateChangeInvoice(sid, session.id, 'restore_session');
                  if (student && already) {
                    const existingRestore = state.invoices.find(i =>
                      i.studentId === sid &&
                      (i.invoiceType || i.invoice_type) === 'adjustment' &&
                      (i.adjustmentReason || i.adjustment_reason) === 'restore_session' &&
                      (i.relatedSessionId || i.related_session_id) === session.id &&
                      !isInvoiceVoid(i)
                    );
                    if (existingRestore) {
                      newSession.invoiceId = existingRestore.id;
                      logActivity('Restored session invoice reused', existingRestore.id);
                    }
                  } else if (student) {
                    const nowStr = toDateOnly(new Date());
                    const baseAmount = getSessionBillableAmount(newSession, student);
                    const restoreInv = {
                      id: generateId('inv'),
                      studentId: sid,
                      issueDate: nowStr,
                      dueDate: nowStr,
                      baseAmount,
                      total: baseAmount,
                      lateFeePercent: 0,
                      shortNoticePercent: 0,
                      lateApplied: false,
                      shortApplied: false,
                      paid: false,
                      notes: `Restored session charge for ${newSession.date} ${newSession.startTime || ''}.`,
                      servicePeriodStart: newSession.date,
                      servicePeriodEnd: newSession.date,
                      numSessions: 1,
                      invoiceType: 'adjustment',
                      autoGenerated: true,
                      paidAt: '',
                      paymentProvider: PAYFAST_PROVIDER,
                      paymentMethod: '',
                      invoiceStatus: 'issued',
                      voidedAt: '',
                      adjustmentReason: 'restore_session',
                      relatedSessionId: session.id,
                      moveToDate: '',
                      moveToTime: '',
                      moveToDurationHours: 0,
                      moveRequestedAt: '',
                      moveAppliedAt: ''
                    };
                    state.invoices.push(restoreInv);
                    newSession.invoiceId = restoreInv.id;
                    logActivity('Restored session invoiced', restoreInv.id);
                    maybeNotifyInvoiceIssued(restoreInv);
                  }
                }
              }
            }
            // Voiding after payment should not mutate the paid invoice; log for admin.
            if (prevStatus !== SESSION_STATUS.VOIDED && next === SESSION_STATUS.VOIDED) {
              const inv = newSession.invoiceId ? getInvoiceById(newSession.invoiceId) : null;
              if (inv && isInvoiceLocked(inv)) {
                if ((newSession.studentIds || []).length === 1) {
                  const sid = newSession.studentIds[0];
                  const student = getStudentById(sid) || getStudentById(inv.studentId);
                  if (student) {
                    if (!(Number(newSession.billingRate ?? newSession.billing_rate ?? 0) > 0) && Number(student.rate || 0) > 0) {
                      newSession.billingRate = Number(student.rate || 0);
                    }
                    createVoidedSessionCreditNote(newSession, student, inv.id);
                  }
                }
                logActivity('Voided session on paid invoice', `${newSession.date} ${newSession.startTime || ''}`);
              }
            }
          }

          if (isEdit) {
            const idx = state.sessions.findIndex(s => s.id === session.id);
            state.sessions[idx] = newSession;
            logActivity('Updated session', newSession.topic || newSession.subject || 'Session');
          } else {
            state.sessions.push(newSession);
            logActivity('Added session', newSession.topic || newSession.subject || 'Session');
          }
          if (isEdit && session) {
            if ((timeChanged || durationChanged) && !isMoveRequest) {
              const prevDateTime = `${session.date || ''} ${normalizeTimeValue(session.startTime || '')}`.trim();
              const nextDateTime = `${newSession.date || ''} ${normalizeTimeValue(newSession.startTime || '')}`.trim();
              const studentIdsForNotice = Array.from(new Set((newSession.studentIds || []).filter(Boolean)));
              studentIdsForNotice.forEach((sid) => {
                const stu = getStudentById(sid);
                void notifyParentServiceEvent({
                  event_type: 'lesson_rescheduled',
                  student_id: sid,
                  session_id: newSession.id,
                  dedupe_key: `lesson_rescheduled:${newSession.id}:${sid}:${newSession.date}:${newSession.startTime}:${newSession.durationHours}`,
                  meta: {
                    student_name: stu?.name || '',
                    date: newSession.date || '',
                    time: normalizeTimeValue(newSession.startTime || ''),
                    message: prevDateTime && nextDateTime ? `Previous time: ${prevDateTime}. New time: ${nextDateTime}.` : '',
                    cta_label: 'View schedule',
                    cta_url: buildPortalStudentLink(sid)
                  }
                });
              });
            }
            if (prevStatus !== SESSION_STATUS.VOIDED && nextStatus === SESSION_STATUS.VOIDED) {
              const studentIdsForNotice = Array.from(new Set((newSession.studentIds || []).filter(Boolean)));
              studentIdsForNotice.forEach((sid) => {
                const stu = getStudentById(sid);
                void notifyParentServiceEvent({
                  event_type: 'lesson_cancelled',
                  student_id: sid,
                  session_id: newSession.id,
                  dedupe_key: `lesson_cancelled:${newSession.id}:${sid}:${newSession.date}:${newSession.startTime}`,
                  meta: {
                    student_name: stu?.name || '',
                    date: newSession.date || '',
                    time: normalizeTimeValue(newSession.startTime || ''),
                    cta_label: 'Review schedule',
                    cta_url: buildPortalStudentLink(sid)
                  }
                });
              });
            }
          }
          refreshAutoBilling();
          saveState();
          closeModal();
          renderScheduleView();
          renderStudentsView();
        };

        if (isEdit) {
          document.getElementById('deleteSessionBtn').onclick = () => {
            if (!confirm(t('confirm.void_session'))) return;
            const idx = state.sessions.findIndex(s => s.id === session.id);
            if (idx >= 0) {
              const sess = state.sessions[idx];
              state.sessions[idx] = {
                ...sess,
                status: SESSION_STATUS.VOIDED,
                absenceReason: sess.absenceReason || SESSION_ABSENCE_REASONS.ADMIN_VOID,
                attended: false,
                completed: false,
                pendingReviewStartedAt: ''
              };
              const invoice = sess.invoiceId ? getInvoiceById(sess.invoiceId) : null;
              if (invoice && isInvoiceLocked(invoice) && (sess.studentIds || []).length === 1) {
                const student = getStudentById(sess.studentIds[0]) || getStudentById(invoice.studentId);
                if (student) {
                  const updatedSess = state.sessions[idx];
                  if (!(Number(updatedSess.billingRate ?? updatedSess.billing_rate ?? 0) > 0) && Number(student.rate || 0) > 0) {
                    updatedSess.billingRate = Number(student.rate || 0);
                  }
                  createVoidedSessionCreditNote(updatedSess, student, invoice.id);
                }
              }
              logActivity('Voided session', `${sess.date} ${sess.startTime || ''}`);
              const studentIdsForNotice = Array.from(new Set((sess.studentIds || []).filter(Boolean)));
              studentIdsForNotice.forEach((sid) => {
                const stu = getStudentById(sid);
                void notifyParentServiceEvent({
                  event_type: 'lesson_cancelled',
                  student_id: sid,
                  session_id: sess.id,
                  dedupe_key: `lesson_cancelled:${sess.id}:${sid}:${sess.date}:${sess.startTime || ''}`,
                  meta: {
                    student_name: stu?.name || '',
                    date: sess.date || '',
                    time: normalizeTimeValue(sess.startTime || ''),
                    cta_label: 'Review schedule',
                    cta_url: buildPortalStudentLink(sid)
                  }
                });
              });
              refreshAutoBilling();
              saveState();
              closeModal();
              renderScheduleView();
              renderStudentsView();
            }
          };
        }

        const aiBtn = document.getElementById('aiSuggestPlanBtn');
        if (aiBtn) {
          aiBtn.onclick = async () => {
            const firstChecked = form.querySelector('input[name="studentIds"]:checked')?.value || selectedStudentId || selectedIds?.[0];
            if (!firstChecked) {
              alert(t('alert.select_student_first'));
              return;
            }
            aiBtn.disabled = true;
            const prev = aiBtn.textContent;
            aiBtn.textContent = t('sessions.ai_generating');
            try {
              const plan = await suggestLessonPlan(firstChecked, form.subject.value, 'N/A', form.date.value);
              form.notes.value = (plan || '').trim();
              alert(t('alert.ai_plan_added'));
            } catch (err) {
              console.error(err);
              alert(t('alert.ai_suggestion_failed', { error: err?.message || err }));
            } finally {
              aiBtn.disabled = false;
              aiBtn.textContent = prev;
            }
          };
        }
      });
    }

    function removeSessionsByInvoiceId(invoiceId, opts = {}) {
      if (!invoiceId) return 0;
      const skipCancellation = !!opts.skipCancellation;
      const toRemove = state.sessions.filter(s => s.invoiceId === invoiceId);
      if (!skipCancellation) {
        toRemove.forEach(sess => recordSessionCancellation(sess, 'cancelled'));
      }
      state.sessions = state.sessions.filter(s => s.invoiceId !== invoiceId);
      return toRemove.length;
    }

    async function deleteSessionRemote(sessionId) {
      if (!isSupabaseReady()) throw new Error('Supabase not ready');
      const { error: linkErr } = await supabaseClient.from('session_students').delete().eq('session_id', sessionId);
      if (linkErr) throw linkErr;
      const { error: sessErr } = await supabaseClient.from('lesson_sessions').delete().eq('id', sessionId);
      if (sessErr) throw sessErr;
    }

    async function deleteSessionAndLinks(sessionId, opts = {}) {
      const skipCancellation = !!opts.skipCancellation;
      // remove locally
      const sess = getSessionById(sessionId);
      const linkedInvoiceId = cleanId(sess?.invoiceId || '');
      if (sess && !skipCancellation) {
        const start = new Date(sess.date + 'T' + (sess.startTime || '00:00'));
        recordSessionCancellation(sess, 'cancelled');
      }
      state.sessions = state.sessions.filter(s => s.id !== sessionId);
      const deletedSessionId = cleanId(sessionId);
      const invoiceStillReferenced = new Set(
        state.sessions
          .map(s => cleanId(s.invoiceId || ''))
          .filter(Boolean)
      );
      const shouldDeleteLinkedInvoice = !!linkedInvoiceId && !invoiceStillReferenced.has(linkedInvoiceId);
      state.invoices = state.invoices.filter(inv => {
        const invId = cleanId(inv.id || '');
        const relatedSessionId = cleanId(inv.relatedSessionId || inv.related_session_id || '');
        if (relatedSessionId && relatedSessionId === deletedSessionId) return false;
        if (shouldDeleteLinkedInvoice && invId === linkedInvoiceId) return false;
        return true;
      });
      saveState();
      if (!studentMode && !parentMode) {
        renderFinanceView();
      }
      // remove remotely if connected
      if (isSupabaseReady()) {
        const isIgnorableDbError = (err) => {
          const msg = String(err?.message || err || '').toLowerCase();
          return msg.includes('does not exist') || (msg.includes('column') && msg.includes('does not exist'));
        };
        const throwIfError = (error, label) => {
          if (!error) return;
          if (isIgnorableDbError(error)) return;
          throw new Error(`${label}: ${error.message || error}`);
        };
        const { error: linkErr } = await supabaseClient.from('session_students').delete().eq('session_id', sessionId);
        throwIfError(linkErr, 'Delete failed for session_students');
        const { error: sessErr } = await supabaseClient.from('lesson_sessions').delete().eq('id', sessionId);
        throwIfError(sessErr, 'Delete failed for lesson_sessions');
        const { error: invByRelatedErr } = await supabaseClient.from('invoices').delete().eq('related_session_id', sessionId);
        throwIfError(invByRelatedErr, 'Delete failed for invoices by related_session_id');
        if (shouldDeleteLinkedInvoice) {
          const { error: invByIdErr } = await supabaseClient.from('invoices').delete().eq('id', linkedInvoiceId);
          throwIfError(invByIdErr, 'Delete failed for invoices by id');
        }
      }
      await pruneOrphanInvoices({ persistRemote: isSupabaseReady() && isOwner(), skipSave: true });
      saveState();
    }

    /***********************
     * RESOURCE CRUD MODAL *
     ***********************/
    function openResourceModal(resource) {
      if (!guardEdit()) return;
      const isEdit = !!resource;
      const html = `
        <h2 class="text-sm font-semibold mb-3">${esc(isEdit ? t('resources.edit_title') : t('resources.add_title'))}</h2>
        <form id="resourceForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">${esc(t('resources.field_title'))}</label>
            <input name="title" value="${esc(resource?.title || '')}" required
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">${esc(t('resources.field_subject'))}</label>
              <select name="subject" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                <option value="Physics" ${resource?.subject === 'Physics' ? 'selected' : ''}>${esc(t('subjects.physics'))}</option>
                <option value="Chemistry" ${resource?.subject === 'Chemistry' ? 'selected' : ''}>${esc(t('subjects.chemistry'))}</option>
                <option value="Maths" ${resource?.subject === 'Maths' ? 'selected' : ''}>${esc(t('subjects.maths'))}</option>
              </select>
            </div>
            <div>
              <label class="block text-[11px] mb-1">${esc(t('resources.field_level'))}</label>
              <input name="level" value="${esc(resource?.level || '')}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('resources.field_tags'))}</label>
            <input name="tags" value="${esc((resource?.tags || []).join(', '))}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">${esc(t('resources.field_type'))}</label>
              <select name="resourceType" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                <option value="" ${!resource?.resourceType ? 'selected' : ''}>${esc(t('resources.type_general'))}</option>
                <option value="Worksheet" ${resource?.resourceType === 'Worksheet' ? 'selected' : ''}>${esc(t('resources.type_worksheet'))}</option>
                <option value="Video" ${resource?.resourceType === 'Video' ? 'selected' : ''}>${esc(t('resources.type_video'))}</option>
                <option value="Notes" ${resource?.resourceType === 'Notes' ? 'selected' : ''}>${esc(t('resources.type_notes'))}</option>
                <option value="Past paper" ${resource?.resourceType === 'Past paper' ? 'selected' : ''}>${esc(t('resources.type_past_paper'))}</option>
                <option value="Link" ${resource?.resourceType === 'Link' ? 'selected' : ''}>${esc(t('resources.type_link'))}</option>
              </select>
            </div>
            <div>
              <label class="block text-[11px] mb-1">${esc(t('resources.field_estimated_minutes'))}</label>
              <input type="number" min="0" name="estimatedMinutes" value="${esc(resource?.estimatedMinutes || '')}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs" placeholder="${esc(t('resources.estimated_minutes_placeholder'))}">
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('resources.field_link'))}</label>
            <input name="linkUrl" value="${esc(resource?.linkUrl || '')}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs" placeholder="https://">
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('resources.field_description'))}</label>
            <textarea name="description" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${esc(resource?.description || '')}</textarea>
          </div>
          <div class="border border-dashed border-slate-300 rounded-lg p-2 bg-slate-50">
            <label class="block text-[11px] mb-1">${esc(t('resources.field_file_attach'))}</label>
            <input type="file" name="file" class="w-full text-[11px]">
            <p class="text-[10px] text-slate-500 mt-1">${esc(t('resources.uploads_require_signin', { file: resource?.fileName || t('resources.file_none') }))}</p>
            <div class="flex gap-2 mt-2">
              <button type="button" id="uploadResourceFileBtn" class="px-2 py-1 rounded-lg bg-slate-900 text-white text-[11px]">${esc(t('resources.upload_button'))}</button>
              ${resource?.signedUrl ? `<a class="px-2 py-1 rounded-lg border border-slate-300 text-[11px]" href="${esc(resource.signedUrl)}" target="_blank">${esc(t('resources.download_file'))}</a>` : ''}
            </div>
            <div id="uploadResourceStatus" class="text-[10px] text-slate-500 mt-1"></div>
          </div>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-xs font-medium">
              ${esc(isEdit ? t('common.save_changes') : t('resources.add_submit'))}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteResourceBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                ${esc(t('common.delete'))}
              </button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('resourceForm');
        const statusEl = document.getElementById('uploadResourceStatus');
        form.onsubmit = (e) => {
          e.preventDefault();
          const newRes = {
            id: resource?.id || generateId('res'),
            title: form.title.value.trim(),
            subject: form.subject.value,
            level: form.level.value.trim(),
            tags: form.tags.value.split(',').map(t => t.trim()).filter(Boolean),
            resourceType: form.resourceType.value,
            estimatedMinutes: Number(form.estimatedMinutes.value || 0) || null,
            linkUrl: form.linkUrl.value.trim(),
            description: form.description.value.trim(),
            createdAt: resource?.createdAt || new Date().toISOString().slice(0, 10),
            storage_path: resource?.storage_path || '',
            fileName: resource?.fileName || '',
            signedUrl: resource?.signedUrl || '',
            favorite: resource?.favorite || false
          };
          if (!newRes.title) {
            alert(t('alert.title_required'));
            return;
          }
          if (isEdit) {
            const idx = state.resources.findIndex(r => r.id === resource.id);
            state.resources[idx] = newRes;
            logActivity('Updated resource', newRes.title);
          } else {
            state.resources.push(newRes);
            logActivity('Added resource', newRes.title);
          }
          saveState();
          closeModal();
          renderResourcesView();
        };

        if (isEdit) {
          document.getElementById('deleteResourceBtn').onclick = async () => {
            if (!confirm(t('confirm.delete_resource'))) return;
            // attempt to delete from storage if present
            if (resource?.storage_path && isSupabaseReady()) {
              supabaseClient.storage.from('resources').remove([resource.storage_path])
                .catch(err => console.warn('Storage delete failed', err));
            }
            if (isSupabaseReady()) {
              const resId = cleanId(resource?.id);
              try {
                // Remove dependent homework rows first to satisfy FK constraints.
                await supabaseClient.from('homework').delete().eq('resource_id', resId);
                await supabaseClient.from('resources').delete().eq('id', resId);
              } catch (err) {
                console.warn('Resource delete failed', err);
              }
            }
            state.resources = state.resources.filter(r => r.id !== resource.id);
            state.homework = state.homework.filter(hw => hw.resourceId !== resource.id);
            saveState();
            closeModal();
            renderResourcesView();
          };
        }

        const uploadBtn = document.getElementById('uploadResourceFileBtn');
        if (uploadBtn) {
          uploadBtn.onclick = async () => {
            const file = form.file?.files?.[0];
            if (!file) {
              alert(t('alert.choose_file_upload'));
              return;
            }
            const maxSize = 15 * 1024 * 1024;
            const allowed = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            if (file.size > maxSize) {
              alert(t('alert.file_too_large'));
              return;
            }
            if (!allowed.some(t => file.type === t)) {
              alert(t('alert.file_type_not_allowed'));
              return;
            }
            if (!isSupabaseReady()) {
              alert(t('alert.sign_in_upload'));
              return;
            }
            try {
              if (statusEl) statusEl.textContent = t('resources.upload_status_uploading');
              uploadBtn.disabled = true;
              const uploaded = await uploadResourceFile(file);
              resource = {
                ...(resource || { id: generateId('res') }),
                storage_path: uploaded.storage_path,
                fileName: uploaded.fileName,
                signedUrl: uploaded.signedUrl,
                dataUrl: uploaded.dataUrl || ''
              };
              if (statusEl) statusEl.textContent = uploaded.storage_path
                ? t('resources.upload_status_uploaded')
                : t('resources.upload_status_local');
            } catch (err) {
              console.error(err);
              alert(t('alert.upload_failed_console'));
            } finally {
              uploadBtn.disabled = false;
            }
          };
        }
      });
    }

    let storageBlocked = false;

    async function uploadResourceFile(file) {
      // Fallback-friendly upload: try Supabase storage; if blocked by RLS/bucket issues, fall back to data URL so the user can still attach the file.
      const readAsDataUrl = (blob) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });

      const uid = supabaseSession?.user?.id;
      // If storage uploads are disabled or blocked, or not signed in, store locally as data URL
      if (!ALLOW_STORAGE_UPLOADS || storageBlocked || !uid || !supabaseClient?.storage) {
        const dataUrl = await readAsDataUrl(file);
        return { dataUrl, fileName: file.name, storage_path: '', signedUrl: '' };
      }

      const ext = file.name.includes('.') ? file.name.split('.').pop() : 'bin';
      // Object key must NOT include bucket name; folder prefix is the user id for RLS.
      const path = `${uid}/${generateId('file')}.${ext}`;
      const { error: uploadErr } = await supabaseClient.storage.from('resources').upload(path, file, { upsert: false });
      if (uploadErr) {
        const msg = (uploadErr?.message || '').toLowerCase();
        if (msg.includes('bucket') || msg.includes('policy') || msg.includes('row-level')) {
          storageBlocked = true;
          console.warn('Storage upload blocked, using local data URL fallback', uploadErr);
          const dataUrl = await readAsDataUrl(file);
          return { dataUrl, fileName: file.name, storage_path: '', signedUrl: '' };
        }
        throw uploadErr;
      }
      const { data: signed } = await supabaseClient.storage.from('resources').createSignedUrl(path, 60 * 60);
      return {
        storage_path: path,
        fileName: file.name,
        signedUrl: signed?.signedUrl || ''
      };
    }

    function openAssignResourceModal(resourceId) {
      if (!guardEdit()) return;
      const res = getResourceById(resourceId);
      if (!res) return;
      const assignTitle = t('resources.assign_title', { title: esc(res.title) });
      const html = `
        <h2 class="text-sm font-semibold mb-3">${assignTitle}</h2>
        <form id="assignForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">${esc(t('resources.assign_students_label'))}</label>
            <div class="grid grid-cols-2 gap-1 max-h-32 overflow-y-auto border border-slate-300 rounded-lg px-2 py-1">
              ${state.students.length
          ? state.students.map(s => `
                      <label class="flex items-center gap-1 text-[11px]">
                        <input type="checkbox" name="studentIds" value="${cleanId(s.id)}">
                        <span>${esc(s.name)}</span>
                      </label>
                    `).join('')
          : `<div class="text-slate-500 text-[11px]">${esc(t('students.none_yet'))}</div>`
        }
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('resources.assign_due_label'))}</label>
            <input type="date" name="dueDate" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs"
                   value="${new Date().toISOString().slice(0, 10)}">
          </div>
          <button type="submit" class="mt-2 px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium">
            ${esc(t('resources.assign_submit'))}
          </button>
        </form>
      `;
      openModal(html, () => {
        document.getElementById('assignForm').onsubmit = (e) => {
          e.preventDefault();
          const form = e.target;
          const ids = [...form.querySelectorAll('input[name="studentIds"]:checked')].map(i => i.value);
          if (!ids.length) {
            alert(t('alert.select_student_at_least_one'));
            return;
          }
          const dueDate = form.dueDate.value;
          assignResourceToStudents(resourceId, ids, dueDate);
          closeModal();
          renderResourcesView();
          if (selectedStudentId) {
            renderStudentTimeline(selectedStudentId);
          }
        };
      });
    }

    /***********************
     * DOCUMENTS CRUD      *
     ***********************/
    function getDocumentById(id) {
      return state.documents.find(doc => doc.id === id);
    }

    function openDocumentModal(doc, fixedStudentId) {
      if (!guardEdit()) return;
      const isEdit = !!doc;
      const html = `
        <h2 class="text-sm font-semibold mb-3">${esc(isEdit ? t('documents.edit_title') : t('documents.add_title'))}</h2>
        <form id="docForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">${esc(t('documents.field_student'))}</label>
            <select name="studentId" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              ${state.students.map(s => `
                  <option value="${cleanId(s.id)}"
                    ${(doc?.studentId === s.id || fixedStudentId === s.id) ? 'selected' : ''}>
                    ${esc(s.name)}
                  </option>
                `).join('')
        }
            </select>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('documents.field_title'))}</label>
            <input name="title" value="${esc(doc?.title || '')}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('documents.field_status'))}</label>
            <select name="status" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              <option value="Draft" ${doc?.status === 'Draft' ? 'selected' : ''}>${esc(t('documents.status_draft'))}</option>
              <option value="Sent" ${doc?.status === 'Sent' ? 'selected' : ''}>${esc(t('documents.status_sent'))}</option>
              <option value="Signed" ${doc?.status === 'Signed' ? 'selected' : ''}>${esc(t('documents.status_signed'))}</option>
              <option value="Expired" ${doc?.status === 'Expired' ? 'selected' : ''}>${esc(t('documents.status_expired'))}</option>
            </select>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('documents.field_date'))}</label>
            <input type="date" name="date" value="${esc(doc?.date || new Date().toISOString().slice(0, 10))}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('documents.field_notes'))}</label>
            <textarea name="notes" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${esc(doc?.notes || '')}</textarea>
          </div>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-amber-600 text-white text-xs font-medium">
              ${esc(isEdit ? t('common.save_changes') : t('documents.add_submit'))}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteDocBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                ${esc(t('common.delete'))}
              </button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('docForm');
        form.onsubmit = (e) => {
          e.preventDefault();
          const newDoc = {
            id: doc?.id || generateId('doc'),
            studentId: form.studentId.value,
            title: form.title.value.trim(),
            status: form.status.value,
            date: form.date.value,
            notes: form.notes.value.trim(),
            createdAt: doc?.createdAt || new Date().toISOString().slice(0, 10)
          };
          if (!newDoc.studentId) {
            alert(t('alert.select_student'));
            return;
          }
          if (!newDoc.title) {
            alert(t('alert.title_required'));
            return;
          }
          if (isEdit) {
            const idx = state.documents.findIndex(d => d.id === doc.id);
            state.documents[idx] = newDoc;
            logActivity('Updated document', newDoc.title);
          } else {
            state.documents.push(newDoc);
            logActivity('Added document', newDoc.title);
          }
          saveState();
          closeModal();
          if (selectedStudentId) {
            renderStudentDocuments(selectedStudentId);
            renderStudentTimeline(selectedStudentId);
          }
        };

        if (isEdit) {
          document.getElementById('deleteDocBtn').onclick = () => {
            if (!confirm(t('confirm.delete_document'))) return;
            state.documents = state.documents.filter(d => d.id !== doc.id);
            saveState();
            closeModal();
            if (selectedStudentId) {
              renderStudentDocuments(selectedStudentId);
              renderStudentTimeline(selectedStudentId);
            }
          };
        }
      });
    }

    /***********************
     * INVOICE CRUD MODAL  *
     ***********************/
    function openInvoiceModal(inv) {
      if (!guardEdit()) return;
      const isEdit = !!inv;
      const servicePeriodStart = inv?.servicePeriodStart || inv?.service_period_start || '';
      const servicePeriodEnd = inv?.servicePeriodEnd || inv?.service_period_end || '';
      const numSessions = inv?.numSessions ?? inv?.num_sessions ?? '';
      const invoiceType = inv?.invoiceType || inv?.invoice_type || 'manual';
      const autoGenerated = !!(inv?.autoGenerated ?? inv?.auto_generated);
      const paidAt = inv?.paidAt || inv?.paid_at || '';
      const paymentProvider = inv?.paymentProvider || inv?.payment_provider || '';
      const paymentMethod = getInvoicePaymentMethod(inv) || inv?.paymentMethod || inv?.payment_method || '';
      const html = `
        <h2 class="text-sm font-semibold mb-3">${esc(isEdit ? t('invoice.edit_title') : t('invoice.create_title'))}</h2>
        <form id="invoiceForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">${esc(t('common.student'))}</label>
            <select name="studentId" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              ${state.students.map(s => `
                  <option value="${cleanId(s.id)}"
                    ${(inv?.studentId === s.id || (!inv && selectedStudentId === s.id)) ? 'selected' : ''}>
                    ${esc(s.name)}
                  </option>
                `).join('')
        }
            </select>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('invoice.bill_sessions'))}</label>
            <div id="invoiceSessions" class="border border-slate-200 rounded-lg p-2 max-h-40 overflow-y-auto space-y-1 text-xs bg-white/70"></div>
            <p class="text-[10px] text-slate-500 mt-1">${esc(t('invoice.bill_sessions_hint'))}</p>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">${esc(t('invoice.id_label'))}</label>
              <input name="id" value="${esc(inv?.id || generateId('inv'))}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div>
              <label class="block text-[11px] mb-1">${esc(t('invoice.issue_date'))}</label>
              <input type="date" name="issueDate" value="${esc(inv?.issueDate || new Date().toISOString().slice(0, 10))}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">${esc(t('invoice.due_date'))}</label>
              <input type="date" name="dueDate" value="${esc(inv?.dueDate || '')}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div>
              <label class="block text-[11px] mb-1">${esc(t('invoice.base_amount'))}</label>
              <input type="number" step="0.01" name="baseAmount" value="${esc(inv?.baseAmount ?? inv?.total ?? '')}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div class="text-[10px] text-slate-500">
            ${servicePeriodStart && servicePeriodEnd
              ? esc(t('invoice.service_period_range', { start: servicePeriodStart, end: servicePeriodEnd }))
              : esc(t('invoice.service_period_na'))}
            ${numSessions ? ` ‚Ä¢ ${esc(t('invoice.sessions_count', { count: numSessions }))}` : ''}
            ${invoiceType ? ` ‚Ä¢ ${esc(t('invoice.type_label'))} ${esc(invoiceType)}` : ''}
          </div>
          <input type="hidden" name="servicePeriodStart" value="${esc(servicePeriodStart)}">
          <input type="hidden" name="servicePeriodEnd" value="${esc(servicePeriodEnd)}">
          <input type="hidden" name="numSessions" value="${esc(numSessions)}">
          <input type="hidden" name="invoiceType" value="${esc(invoiceType)}">
          <input type="hidden" name="autoGenerated" value="${autoGenerated ? '1' : ''}">
          <input type="hidden" name="paidAt" value="${esc(paidAt)}">
          <input type="hidden" name="paymentProvider" value="${esc(paymentProvider)}">
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">${esc(t('invoice.late_fee_label'))}</label>
              <div class="flex items-center gap-2">
                <select name="lateFeePercent" class="flex-1 border border-slate-300 rounded-lg px-2 py-1 text-xs">
                  ${[0, 5, 10, 15, 20].map(p => `<option value="${p}" ${inv?.lateFeePercent === p ? 'selected' : ''}>${p}%</option>`).join('')}
                </select>
                <label class="flex items-center gap-1 text-[10px]">
                  <input type="checkbox" name="applyLate" ${inv?.lateApplied ? 'checked' : ''}>
                  <span>${esc(t('invoice.apply_label'))}</span>
                </label>
              </div>
            </div>
            <div>
              <label class="block text-[11px] mb-1">${esc(t('invoice.short_notice_label'))}</label>
              <div class="flex items-center gap-2">
                <select name="shortNoticePercent" class="flex-1 border border-slate-300 rounded-lg px-2 py-1 text-xs">
                  ${[0, 5, 10, 15].map(p => `<option value="${p}" ${inv?.shortNoticePercent === p ? 'selected' : ''}>${p}%</option>`).join('')}
                </select>
                <label class="flex items-center gap-1 text-[10px]">
                  <input type="checkbox" name="applyShort" ${inv?.shortApplied ? 'checked' : ''}>
                  <span>${esc(t('invoice.apply_label'))}</span>
                </label>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">${esc(t('invoice.total_amount'))}</label>
              <input type="number" step="0.01" name="total" value="${esc(inv?.total || '')}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div class="flex items-end">
              <div class="text-[10px] text-slate-500">${esc(t('invoice.computed_with_fees'))} <span id="computedTotal">R 0.00</span></div>
            </div>
          </div>
          <div class="flex items-center gap-1 mt-1">
            <input type="checkbox" name="paid" id="invPaid" ${inv?.paid ? 'checked' : ''}>
            <label for="invPaid" class="text-[11px]">${esc(t('invoice.mark_paid'))}</label>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">${esc(t('invoice.payment_method'))}</label>
              <select name="paymentMethod" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                <option value="">${esc(t('invoice.payment_method_auto'))}</option>
                <option value="online" ${paymentMethod === 'online' ? 'selected' : ''}>${esc(t('invoice.payment_method_online'))}</option>
                <option value="cash" ${paymentMethod === 'cash' ? 'selected' : ''}>${esc(t('invoice.payment_method_cash'))}</option>
              </select>
            </div>
            <div class="flex items-end">
              <div class="text-[10px] text-slate-500">${esc(t('invoice.payment_method_hint'))}</div>
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">${esc(t('common.notes'))}</label>
            <textarea name="notes" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${esc(inv?.notes || '')}</textarea>
          </div>
          <p class="text-[10px] text-slate-500">
            ${esc(t('invoice.tip_fees'))}
          </p>
          ${isEdit ? `
            <div class="mt-2 rounded-lg border border-amber-200 bg-amber-50/70 p-2">
              <div class="text-[11px] font-medium text-amber-900">${esc(t('invoice.fix_schedule_title'))}</div>
              <div class="text-[10px] text-amber-800">${esc(t('invoice.fix_schedule_desc'))}</div>
              <button type="button" id="rebuildInvoiceSessionsBtn"
                class="mt-2 px-2 py-1 rounded-lg border border-amber-300 text-amber-900 text-[11px] hover:bg-amber-100">
                ${esc(t('invoice.rebuild_sessions'))}
              </button>
              <button type="button" id="fixInvoiceScheduleBtn"
                class="mt-2 ml-2 px-2 py-1 rounded-lg border border-amber-300 text-amber-900 text-[11px] hover:bg-amber-100">
                ${esc(t('invoice.void_remove_sessions'))}
              </button>
            </div>
          ` : ''}
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-emerald-600 text-white text-xs font-medium">
              ${esc(isEdit ? t('invoice.save') : t('invoice.create'))}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteInvoiceBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                ${esc(t('common.delete'))}
              </button>` : ''}
          </div>
        </form>
        <div class="mt-2 text-[10px] text-slate-500" data-yoco-merchant-line></div>
        <div class="text-[10px] text-slate-500" data-merchant-receipt></div>
      `;
      openModal(html, () => {
        const form = document.getElementById('invoiceForm');
        if (window.applyBusinessText) {
          window.applyBusinessText(document.getElementById('modalContainer'));
        }
        const sessionBox = form.querySelector('#invoiceSessions');

        const renderSessionChoices = () => {
          if (!sessionBox) return;
          const studentId = form.studentId.value || state.students[0]?.id || '';
          const selectedExisting = new Set([...form.querySelectorAll('input[name="sessionIds"]:checked')].map(i => i.value));
          const eligible = state.sessions.filter(s => s.studentIds.includes(studentId));
          if (!eligible.length) {
            sessionBox.innerHTML = `<div class="text-[10px] text-slate-500">${esc(t('invoice.no_sessions_student'))}</div>`;
            return;
          }
          sessionBox.innerHTML = eligible.map(s => {
            const safeSessionId = cleanId(s.id);
            const billedElsewhere = !!s.invoiceId && s.invoiceId !== (inv?.id || '');
            const checked = selectedExisting.has(safeSessionId) || s.invoiceId === inv?.id;
            const status = getSessionStatus(s);
            const statusLabel = status === SESSION_STATUS.COMPLETE
              ? t('schedule.completed')
              : status === SESSION_STATUS.PENDING_REVIEW
                ? t('schedule.pending_review')
                : status === SESSION_STATUS.VOIDED
                  ? t('schedule.voided')
                  : status === SESSION_STATUS.NO_SHOW_CHARGEABLE
                    ? t('schedule.no_show_chargeable')
                    : t('schedule.scheduled');
            const detail = esc(`${s.date} ${s.startTime || ''} ‚Ä¢ ${s.subject} ‚Ä¢ ${s.durationHours || 1}h ‚Ä¢ ${statusLabel}`);
            return `<label class="flex items-center gap-2 text-[11px] ${billedElsewhere ? 'opacity-50' : ''}">
              <input type="checkbox" name="sessionIds" value="${safeSessionId}" ${checked && !billedElsewhere ? 'checked' : ''} ${billedElsewhere ? 'disabled' : ''}>
              <span>${detail}</span>
              ${billedElsewhere ? `<span class="text-amber-600 text-[10px]">${esc(t('invoice.already_billed'))}</span>` : ''}
            </label>`;
          }).join('');
        };
        renderSessionChoices();
        form.studentId.onchange = renderSessionChoices;

        function computeTotalFromFees() {
          const base = Number(form.baseAmount.value || form.total.value || 0);
          const latePct = form.applyLate.checked ? Number(form.lateFeePercent.value || 0) : 0;
          const shortPct = form.applyShort.checked ? Number(form.shortNoticePercent.value || 0) : 0;
          const total = base * (1 + latePct / 100 + shortPct / 100);
          if (base > 0) {
            form.total.value = total.toFixed(2);
            const display = document.getElementById('computedTotal');
            if (display) display.textContent = 'R ' + total.toFixed(2);
          }
        }

        ['baseAmount', 'lateFeePercent', 'shortNoticePercent'].forEach(name => {
          const el = form[name];
          if (el) el.addEventListener('input', computeTotalFromFees);
        });
        ['applyLate', 'applyShort'].forEach(name => {
          const el = form[name];
          if (el) el.addEventListener('change', computeTotalFromFees);
        });
        computeTotalFromFees();

        form.onsubmit = async (e) => {
          e.preventDefault();
          const selectedSessionIds = new Set([...form.querySelectorAll('input[name="sessionIds"]:checked')].map(i => i.value));
          const newInv = {
            id: form.id.value.trim(),
            studentId: form.studentId.value,
            issueDate: form.issueDate.value,
            dueDate: form.dueDate.value,
            total: Number(form.total.value || 0),
            baseAmount: Number(form.baseAmount.value || 0),
            lateFeePercent: Number(form.lateFeePercent.value || 0),
            shortNoticePercent: Number(form.shortNoticePercent.value || 0),
            lateApplied: form.applyLate.checked,
            shortApplied: form.applyShort.checked,
            paid: form.paid.checked,
            notes: form.notes.value.trim(),
            servicePeriodStart: form.servicePeriodStart.value || servicePeriodStart || '',
            servicePeriodEnd: form.servicePeriodEnd.value || servicePeriodEnd || '',
            numSessions: Number(form.numSessions.value || numSessions || 0),
            invoiceType: form.invoiceType.value || invoiceType || 'manual',
            autoGenerated: !!form.autoGenerated.value || autoGenerated,
            paidAt: form.paidAt.value || paidAt || '',
            paymentProvider: form.paymentProvider.value || paymentProvider || '',
            paymentMethod: form.paymentMethod.value || paymentMethod || '',
            invoiceStatus: inv?.invoiceStatus || inv?.invoice_status || (form.paid.checked ? 'paid' : 'issued'),
            voidedAt: inv?.voidedAt || inv?.voided_at || '',
            adjustmentReason: inv?.adjustmentReason || inv?.adjustment_reason || '',
            relatedSessionId: inv?.relatedSessionId || inv?.related_session_id || '',
            moveToDate: inv?.moveToDate || inv?.move_to_date || '',
            moveToTime: inv?.moveToTime || inv?.move_to_time || '',
            moveToDurationHours: inv?.moveToDurationHours || inv?.move_to_duration_hours || 0,
            moveRequestedAt: inv?.moveRequestedAt || inv?.move_requested_at || '',
            moveAppliedAt: inv?.moveAppliedAt || inv?.move_applied_at || '',
            paymentProviderId: inv?.paymentProviderId || inv?.payment_provider_id || '',
            amountReceived: inv?.amountReceived ?? inv?.amount_received ?? null,
            amountRefunded: inv?.amountRefunded ?? inv?.amount_refunded ?? null,
            refundStatus: inv?.refundStatus || inv?.refund_status || '',
            refundLastAt: inv?.refundLastAt || inv?.refund_last_at || ''
          };
          if (!newInv.studentId) {
            alert(t('alert.select_student'));
            return;
          }
            if (!newInv.id) {
              alert(t('alert.invoice_id_required'));
              return;
            }
            if (newInv.paid && !inv?.paid) {
              newInv.paidAt = new Date().toISOString();
              if (newInv.paymentMethod === 'cash') {
                newInv.paymentProvider = 'Cash';
              } else {
                newInv.paymentProvider = PAYFAST_PROVIDER;
                newInv.paymentMethod = 'online';
              }
            }
            if (!newInv.paid) {
              newInv.paidAt = '';
              newInv.paymentMethod = '';
            }
            if (newInv.paid && !newInv.paymentMethod) {
              const providerLower = String(newInv.paymentProvider || '').toLowerCase();
              if (providerLower === 'cash') newInv.paymentMethod = 'cash';
              else newInv.paymentMethod = 'online';
            }
            if (isInvoiceVoid(newInv)) {
              newInv.invoiceStatus = 'void';
              newInv.paid = false;
              newInv.paidAt = '';
          } else {
            newInv.invoiceStatus = newInv.paid ? 'paid' : 'issued';
          }
          try {
            if (isSupabaseReady()) {
              await upsertInvoiceRemote(newInv);
            }
            // relink sessions to this invoice
            state.sessions.forEach(s => {
              if (s.invoiceId === inv?.id && !selectedSessionIds.has(s.id)) {
                s.invoiceId = '';
              }
              if (selectedSessionIds.has(s.id)) {
                s.invoiceId = newInv.id;
              }
            });
            if (isEdit) {
              const idx = state.invoices.findIndex(i => i.id === inv.id);
              state.invoices[idx] = newInv;
              logActivity('Updated invoice', newInv.id);
            } else {
              const idx = state.invoices.findIndex(i => i.id === newInv.id);
              if (idx >= 0) state.invoices[idx] = newInv;
              else state.invoices.push(newInv);
              logActivity('Created invoice', newInv.id);
            }
            const shouldEmailInvoiceIssued = !isInvoiceVoid(newInv) &&
              !newInv.paid &&
              (!isEdit || isInvoiceVoid(inv) || !!inv?.paid);
            if (shouldEmailInvoiceIssued) {
              maybeNotifyInvoiceIssued(newInv, { dedupeKey: `invoice_issued:${newInv.id}` });
            }
            saveState();
            closeModal();
            renderFinanceView();
            if (selectedStudentId) renderStudentFinance(selectedStudentId);
          } catch (err) {
            console.error('Invoice sync failed', err);
            alert(t('alert.saved_local_sync_failed', { error: err?.message || err }));
            // still update local state so UI stays consistent
            if (isEdit) {
              const idx = state.invoices.findIndex(i => i.id === inv.id);
              state.invoices[idx] = newInv;
              logActivity('Updated invoice (local only)', newInv.id);
            } else {
              const idx = state.invoices.findIndex(i => i.id === newInv.id);
              if (idx >= 0) state.invoices[idx] = newInv;
              else state.invoices.push(newInv);
              logActivity('Created invoice (local only)', newInv.id);
            }
            saveState();
          }
        };

        const rebuildBtn = document.getElementById('rebuildInvoiceSessionsBtn');
        if (rebuildBtn && inv) {
          rebuildBtn.onclick = async () => {
            const student = getStudentById(inv.studentId);
            if (!student) {
              alert(t('alert.invoice_student_not_found'));
              return;
            }
            const prefs = getSchedulePrefs(student);
            if (!prefs.scheduleSlots.length) {
              alert(t('alert.student_no_schedule'));
              return;
            }
            const serviceStart = parseDateOnly(inv.servicePeriodStart || inv.service_period_start);
            const serviceEnd = parseDateOnly(inv.servicePeriodEnd || inv.service_period_end);
            if (!serviceStart || !serviceEnd) {
              alert(t('alert.invoice_missing_service_period'));
              return;
            }
            const paidAtDate = inv.paid ? (parseDateOnly(inv.paidAt || inv.paid_at) || new Date()) : null;
            const scheduleStart = inv.paid ? maxDate(serviceStart, paidAtDate) : serviceStart;
            const occurrences = listScheduleOccurrences(prefs.scheduleSlots, scheduleStart, serviceEnd);
            const expectedKeys = new Set();
            occurrences.forEach(occ => {
              const slotTime = normalizeTimeValue(occ.slot.startTime || '');
              const key = `${student.id}|${occ.date}|${slotTime}`;
              expectedKeys.add(key);
            });
            const linked = state.sessions.filter(s => s.invoiceId === inv.id && s.studentIds.includes(student.id));
            const removeCount = linked.filter(s => {
              const key = `${student.id}|${s.date}|${normalizeTimeValue(s.startTime || '')}`;
              return !expectedKeys.has(key);
            }).length;
            const confirmMsg = t('invoice.rebuild_confirm', { id: inv.id, count: removeCount });
            if (!confirm(confirmMsg)) return;

            const locked = isInvoiceLocked(inv);
            let changed = false;
            let missingCount = 0;
            const existingByKey = new Map();
            state.sessions.forEach(s => {
              if (!s.studentIds.includes(student.id)) return;
              const key = `${student.id}|${s.date}|${normalizeTimeValue(s.startTime || '')}`;
              if (!existingByKey.has(key)) existingByKey.set(key, s);
            });

            occurrences.forEach(occ => {
              const slot = occ.slot;
              const slotTime = normalizeTimeValue(slot.startTime || '');
              if (!slotTime) return;
              const key = `${student.id}|${occ.date}|${slotTime}`;
              const durationHours = Number(slot.durationHours || 0) || Number(state.settings.defaultSessionDuration || 1);
              const sessionMode = getSlotSessionMode(slot, 'in_person');
              const existing = existingByKey.get(key);
              if (existing) {
                if (existing.invoiceId !== inv.id) {
                  existing.invoiceId = inv.id;
                  changed = true;
                }
                if (Number(existing.durationHours || 0) !== durationHours) {
                  existing.durationHours = durationHours;
                  changed = true;
                }
                if (normalizeSessionMode(existing.sessionMode || existing.session_mode || existing.mode) !== sessionMode) {
                  existing.sessionMode = sessionMode;
                  existing.meetingProvider = sessionMode === 'online' ? 'JaaS' : '';
                  if (sessionMode !== 'online') {
                    existing.meetingRoom = '';
                    existing.meetingStatus = '';
                  }
                  changed = true;
                }
                return;
              }
              missingCount++;
            });

            const toUnlink = state.sessions.filter(s => {
              if (s.invoiceId !== inv.id) return false;
              if (!s.studentIds.includes(student.id)) return false;
              const key = `${student.id}|${s.date}|${normalizeTimeValue(s.startTime || '')}`;
              return !expectedKeys.has(key);
            });
            if (!locked && toUnlink.length) {
              toUnlink.forEach(s => {
                s.invoiceId = '';
                changed = true;
              });
            }

            if (changed) refreshAutoBilling();
            if (changed) saveState();
            renderFinanceView();
            renderScheduleView();
            renderStudentsView();
            if (selectedStudentId) renderStudentFinance(selectedStudentId);
            if (missingCount) {
              alert(t('alert.invoice_rebuild_missing_sessions', { count: missingCount }));
            } else if (changed) {
              alert(t('alert.invoice_sessions_rebuilt'));
            } else {
              alert(t('alert.invoice_no_changes'));
            }
          };
        }

        const fixBtn = document.getElementById('fixInvoiceScheduleBtn');
        if (fixBtn && inv) {
          fixBtn.onclick = async () => {
            if (!isSupabaseReady()) {
              setSupabaseStatusBanner('Supabase connection not ready. Please try again when it is back online.');
              alert(t('alert.supabase_not_ready'));
              return;
            }
            const linked = state.sessions.filter(s => s.invoiceId === inv.id);
            const count = linked.length;
            const confirmMsg = t('invoice.void_confirm', { id: inv.id, count });
            if (!confirm(confirmMsg)) return;
            const nowIso = new Date().toISOString();
            const note = `Voided due to scheduling error on ${nowIso.slice(0, 10)}.`;
            const updated = {
              ...inv,
              invoiceStatus: 'void',
              voidedAt: nowIso,
              paid: false,
              paidAt: '',
              paymentMethod: '',
              notes: [inv.notes, note].filter(Boolean).join(' | ')
            };
            try {
              await upsertInvoiceRemote(updated);
              // Unlink sessions instead of deleting them.
              try {
                await supabaseClient.from('lesson_sessions').update({ invoice_id: null }).eq('invoice_id', inv.id);
              } catch (err) {
                console.warn('Session unlink failed during invoice void', err);
              }
              state.sessions.forEach(s => { if (s.invoiceId === inv.id) s.invoiceId = ''; });
              saveState();
              await tryLoadRemoteThenLocal();
              renderAllViews();
              closeModal();
              alert(t('alert.invoice_voided_sessions_unlinked'));
            } catch (err) {
              console.error('Fix scheduling error failed', err);
              setSupabaseStatusBanner('Supabase action failed. Please retry in a moment.');
              alert(t('alert.fix_failed', { error: err?.message || err }));
            }
          };
        }

        if (isEdit) {
          document.getElementById('deleteInvoiceBtn').onclick = async () => {
            if (!isSupabaseReady()) {
              setSupabaseStatusBanner('Supabase connection not ready. Please try again when it is back online.');
              alert(t('alert.supabase_not_ready'));
              return;
            }
            if (!confirm(t('confirm.delete_invoice'))) return;
            try {
              if (isInvoiceVoid(inv)) {
                await deleteInvoiceRemote(inv.id);
              } else {
                await supabaseClient.from('lesson_sessions').update({ invoice_id: null }).eq('invoice_id', inv.id);
                await deleteInvoiceRemote(inv.id);
              }
              // keep local state in sync so the deleted invoice is not re-merged back in
              if (!isInvoiceVoid(inv)) {
                state.sessions.forEach(s => { if (s.invoiceId === inv.id) s.invoiceId = ''; });
              }
              state.invoices = state.invoices.filter(i => i.id !== inv.id);
              saveState();
              await tryLoadRemoteThenLocal();
              renderAllViews();
              closeModal();
            } catch (err) {
              console.error('Invoice delete sync failed', err);
              setSupabaseStatusBanner('Supabase action failed. Please retry in a moment.');
              alert(t('alert.delete_failed_error', { error: err?.message || err }));
            }
          };
        }
      });
    }
  </script>
</body>

</html>
