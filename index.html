<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tutoring Dashboard ‚Äì Physics ‚Ä¢ Chemistry ‚Ä¢ Maths</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- hCaptcha -->
  <script src="https://js.hcaptcha.com/1/api.js?onload=hcaptchaOnLoad&render=explicit" async defer></script>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Favicons (SVG with cache-bust + inline fallback for GH Pages) -->
  <link rel="icon" type="image/svg+xml" href="./favicon.svg?v=7">
  <link rel="shortcut icon" type="image/svg+xml" href="./favicon.svg?v=7">
  <link rel="apple-touch-icon" href="./favicon.svg?v=7">
  <link rel="alternate icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%234f46e5'/%3E%3Cstop offset='100%25' stop-color='%230ea5e9'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='2' y='2' width='60' height='60' rx='12' fill='%23f8fafc' stroke='%233b82f6' stroke-width='3'/%3E%3Cpath d='M18 18h28v6H34v22h-6V24H18z' fill='url(%23g)'/%3E%3Ccircle cx='46' cy='42' r='6' fill='%23f97316'/%3E%3C/svg%3E">

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg-main-light: #f3f4f6;
      --bg-main-dark: #020617;
      --card-light: #ffffff;
      --card-dark: #020617;
      --text-light: #020617;
      --text-dark: #e5e7eb;
      --border-dark: #1e293b;
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:
        radial-gradient(circle at 12% 20%, rgba(79,70,229,0.12), transparent 45%),
        radial-gradient(circle at 88% 18%, rgba(14,165,233,0.14), transparent 46%),
        linear-gradient(135deg, #f8fafc 0%, #eef2ff 50%, #f1f5f9 100%);
      background-attachment: fixed;
      color: var(--text-light);
    }
    body.dark {
      background:
        radial-gradient(circle at 12% 20%, rgba(59,130,246,0.18), transparent 42%),
        radial-gradient(circle at 85% 25%, rgba(34,211,238,0.12), transparent 50%),
        linear-gradient(135deg, #020617 0%, #0b1221 45%, #0b1324 100%);
      background-attachment: fixed;
      color: var(--text-dark);
    }
    body.dark .sidebar,
    body.dark .topbar {
      background: rgba(15,23,42,0.98) !important;
      border-color: var(--border-dark) !important;
      backdrop-filter: blur(18px);
    }
    body.dark #viewsContainer {
      background: transparent !important;
    }
    .card {
      background-color: var(--card-light);
      border: 1px solid rgba(148,163,184,0.25);
      border-radius: 1.1rem;
      box-shadow:
        0 20px 60px -34px rgba(15,23,42,0.7),
        0 0 0 1px rgba(148,163,184,0.12);
      transition: background 0.25s ease, border-color 0.2s ease, box-shadow 0.25s ease, transform 0.18s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow:
        0 26px 70px -36px rgba(15,23,42,0.85),
        0 0 0 1px rgba(148,163,184,0.2);
    }
    body.dark .card {
      background: radial-gradient(circle at 0% 0%, #111827 0, #0b1221 48%);
      border-color: var(--border-dark);
      color: var(--text-dark);
      box-shadow:
        0 20px 60px -30px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,0.85);
    }
    .sidebar {
      background: radial-gradient(circle at 0% 0%, #0f172a 0, #020617 70%);
      border-right: 1px solid #020617;
      box-shadow: 6px 0 24px -20px rgba(15,23,42,0.9);
    }
    .topbar {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(18px);
      border-bottom: 1px solid rgba(148,163,184,0.25);
    }
    body.dark .topbar {
      color: var(--text-dark);
      border-color: rgba(51,65,85,0.75);
      background: rgba(8,15,27,0.92);
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(148,163,184,0.8);
      border-radius: 999px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background-color: transparent;
    }
    .badge {
      border-radius: 999px;
      padding: 0.15rem 0.6rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .subject-physics { background-color: #eff6ff; color: #1d4ed8; }
    .subject-chemistry { background-color: #ecfdf3; color: #15803d; }
    .subject-maths { background-color: #fef2f2; color: #b91c1c; }
    body.dark .subject-physics { background-color: rgba(37,99,235,0.16); color: #93c5fd; }
    body.dark .subject-chemistry { background-color: rgba(22,163,74,0.14); color: #6ee7b7; }
    body.dark .subject-maths { background-color: rgba(248,113,113,0.16); color: #fecaca; }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 0.35rem;
    }
    .calendar-day {
      min-height: 6rem;
      border-radius: 0.8rem;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 0.4rem 0.45rem;
      display: flex;
      flex-direction: column;
      font-size: 0.75rem;
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(12px);
    }
    body.dark .calendar-day {
      background: radial-gradient(circle at 0% 0%, #020617 0, #020617 55%);
      border-color: rgba(51,65,85,0.9);
    }

    .tag-pill {
      font-size: 0.7rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      background-color: #e5e7eb;
      margin-right: 0.25rem;
      margin-bottom: 0.15rem;
      display: inline-flex;
      align-items: center;
      gap: 0.15rem;
    }
    body.dark .tag-pill {
      background-color: rgba(51,65,85,0.9);
      color: #e5e7eb;
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 80;
      backdrop-filter: blur(18px);
    }
    .overlay.show {
      display: flex;
    }

    /* Session chips */
    .session-card {
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 0.75rem;
      padding: 0.45rem 0.55rem;
      background: rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    .session-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px -20px rgba(15,23,42,0.4);
    }
    .session-chip {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: rgba(248,250,252,0.7);
    }
    .session-time {
      font-weight: 700;
      font-size: 0.8rem;
    }

    /* AUTH OVERLAY */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      backdrop-filter: blur(20px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
      padding: 1.5rem;
    }
    .auth-overlay.show {
      display: flex;
    }

    .read-only-banner {
      background: #fef3c7;
      color: #92400e;
      border-bottom: 1px solid #f59e0b;
    }

    .owner-locked {
      opacity: 0.55;
      pointer-events: none;
      cursor: not-allowed;
    }

    /* NAV */
    .nav-btn {
      border-radius: 999px;
      margin-inline: 0.5rem;
      margin-bottom: 0.2rem;
      padding-inline: 0.75rem;
      transition: background 0.18s ease, color 0.18s ease, transform 0.12s ease;
    }
    .nav-btn span:first-child {
      width: 1.3rem;
      text-align: center;
    }
    .nav-btn.active,
    .nav-btn.bg-slate-800 {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: #e5e7eb;
      transform: translateY(-1px);
    }
    .nav-btn:hover {
      background-color: rgba(15,23,42,0.6);
    }

    /* INPUTS / TEXTAREAS / SELECTS */
    input[type="text"],
    input[type="search"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    textarea,
    select {
      transition: background 0.16s ease, border-color 0.16s ease, color 0.16s ease, box-shadow 0.16s ease;
    }
    body.dark input[type="text"],
    body.dark input[type="search"],
    body.dark input[type="number"],
    body.dark input[type="date"],
    body.dark input[type="time"],
    body.dark textarea,
    body.dark select {
      background-color: #020617;
      border-color: var(--border-dark);
      color: var(--text-dark);
    }
    body.dark input::placeholder,
    body.dark textarea::placeholder {
      color: #64748b;
    }

    /* THEME TOGGLE BUTTON */
    #themeToggleBtn {
      box-shadow: 0 6px 18px -8px rgba(15,23,42,0.9);
      background: radial-gradient(circle at 30% 20%, #fef3c7 0, #fbbf24 40%, #f97316 100%);
      color: #111827;
    }
    body.dark #themeToggleBtn {
      background: radial-gradient(circle at 30% 20%, #22d3ee 0, #0ea5e9 40%, #1d4ed8 100%);
      color: #e5e7eb;
      box-shadow: 0 6px 20px -8px rgba(59,130,246,0.9);
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    .sr-only:focus {
      position: static;
      width: auto;
      height: auto;
      margin: 0;
      overflow: visible;
      clip: auto;
      white-space: normal;
    }

    /* TIGHTEN TABLES IN COMPACT MODE (density) ‚Äì class is toggled on #viewsContainer */
    .dense-mode table td,
    .dense-mode table th {
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
    }

    /* Light utility chips */
    .chip-btn {
      border: 1px solid rgba(148,163,184,0.6);
      border-radius: 999px;
      padding: 0.25rem 0.65rem;
      font-size: 0.75rem;
      transition: all 0.15s ease;
    }
    .chip-btn.active {
      background: linear-gradient(135deg, #4f46e5, #22d3ee);
      color: #f8fafc;
      border-color: transparent;
      box-shadow: 0 10px 30px -20px rgba(79,70,229,0.8);
    }

    .progress-track {
      height: 0.55rem;
      border-radius: 999px;
      background: rgba(148,163,184,0.25);
      overflow: hidden;
    }
    .progress-thumb {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #6366f1, #22c55e);
      transition: width 0.2s ease;
    }
    body.dark .progress-track {
      background: rgba(51,65,85,0.9);
    }

    .hint {
      font-size: 0.7rem;
      color: #94a3b8;
    }

    /* Section breathing */
    .section-shell {
      background: linear-gradient(135deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
      border: 1px solid rgba(148,163,184,0.22);
      border-radius: 1.3rem;
      padding: 1.25rem;
      box-shadow: 0 24px 70px -48px rgba(15,23,42,0.55);
    }
    body.dark .section-shell {
      background: linear-gradient(135deg, rgba(15,23,42,0.75), rgba(15,23,42,0.65));
      border-color: rgba(51,65,85,0.8);
    }
  </style>
</head>
<body>
  <a href="#mainContent" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-indigo-600 text-white px-3 py-2 rounded-lg">Skip to main content</a>
  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="sidebar w-64 text-slate-200 flex flex-col border-r border-slate-900" role="navigation" aria-label="Primary">
      <div class="px-4 py-4 flex items-center gap-2 border-b border-slate-800">
        <div class="h-9 w-9 rounded-2xl bg-indigo-500 flex items-center justify-center text-white font-bold text-lg">
          T
        </div>
        <div>
          <div class="font-semibold text-sm">Tutor Control Center</div>
          <div class="text-xs text-slate-400">Physics ‚Ä¢ Chemistry ‚Ä¢ Maths</div>
        </div>
      </div>

      <nav class="mt-4 flex-1 overflow-y-auto scrollbar-thin pb-2">
        <button data-view="dashboard" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üè†</span><span>Dashboard</span>
        </button>
        <button data-view="students" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üë•</span><span>Students</span>
        </button>
        <button data-view="schedule" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üìÖ</span><span>Schedule</span>
        </button>
        <button data-view="resources" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üìö</span><span>Resources</span>
        </button>
        <button id="navFinanceBtn" data-view="finance" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üí∞</span><span>Finance</span>
        </button>
        <button data-view="settings" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>‚öôÔ∏è</span><span>Settings</span>
        </button>
        <button id="navReportsBtn" data-view="reports" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üìä</span><span>Reports</span>
        </button>
        <button data-view="profile" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition">
          <span>üë§</span><span>Profile</span>
        </button>
        <button data-view="portal" id="navPortalBtn" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition hidden">
          <span>üìÇ</span><span>My portal</span>
        </button>
        <button data-view="parent-portal" id="navParentPortalBtn" class="nav-btn w-full text-left px-4 py-2 flex items-center gap-2 text-sm hover:bg-slate-800/60 transition hidden">
          <span>üë™</span><span>Parent portal</span>
        </button>
      </nav>

    </aside>

    <!-- Main content -->
    <div class="flex-1 flex flex-col" id="mainContent" role="main">
      <!-- Top bar -->
      <header class="topbar h-16 flex items-center justify-between px-6 gap-4">
        <!-- Search -->
        <div class="flex-1 max-w-xl">
          <div class="relative">
            <input id="globalSearchInput" type="search" placeholder="Search students, sessions, resources, invoices‚Ä¶"
                   class="w-full rounded-2xl border border-slate-200 px-10 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white/80">
            <span class="absolute left-3 top-1.5">üîç</span>
            <div id="globalSearchResults" class="absolute mt-1 w-full bg-white border border-slate-200 rounded-xl shadow-xl text-xs hidden max-h-64 overflow-y-auto z-20"></div>
          </div>
        </div>

        <!-- Quick actions -->
        <div class="flex items-center gap-2">
          <button id="quickAddStudentBtn" data-owner-only class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700 shadow-sm">
            Ôºã Student
          </button>
          <button id="quickAddSessionBtn" data-owner-only class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-slate-900 text-white text-xs font-medium hover:bg-slate-800 shadow-sm">
            Ôºã Session
          </button>
          <button id="refreshBtn" class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl border border-slate-300 text-xs font-medium hover:bg-slate-50">
            ‚ü≥ Refresh
          </button>
          <button id="signOutBtn" class="hidden inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl border border-slate-300 text-xs font-medium hover:bg-slate-50">
            ‚èè Sign out
          </button>

          <!-- Theme toggle -->
          <button id="themeToggleBtn" class="ml-2 inline-flex items-center justify-center h-8 w-8 rounded-full border border-slate-300 text-sm">
            üåô
          </button>
        </div>
      </header>
      <div id="readOnlyBanner" class="read-only-banner hidden px-6 py-2 text-xs">
        Read-only mode: sign in as the owner to edit.
      </div>

      <!-- Views container -->
      <main id="viewsContainer" class="flex-1 overflow-y-auto bg-transparent px-8 py-8 space-y-8 max-w-7xl mx-auto w-full">
        <!-- Dashboard -->
        <section id="view-dashboard" class="view">
          <div class="section-shell space-y-6">
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
              <div class="card p-5 col-span-8 space-y-3">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-[10px] uppercase tracking-wide text-slate-500">Weekly direction</p>
                    <h3 class="text-sm font-semibold">Focus & reflection</h3>
                  </div>
                  <span class="hint">Set in Settings</span>
                </div>
                <div id="reflectionText" class="text-sm text-slate-700 leading-relaxed">
                  Add a short note in settings to keep this week intentional.
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                  <div class="border border-slate-200 rounded-lg p-3 bg-white/70">
                    <div class="text-[10px] text-slate-500">Next session</div>
                    <div id="focusNextSession" class="font-semibold">No sessions planned</div>
                    <div id="focusNextSessionMeta" class="text-[10px] text-slate-500"></div>
                  </div>
                  <div class="border border-slate-200 rounded-lg p-3 bg-white/70">
                    <div class="text-[10px] text-slate-500">Homework due soon</div>
                    <div id="focusHomework" class="font-semibold">0</div>
                    <div class="text-[10px] text-slate-500">Due within 5 days</div>
                  </div>
                    <div class="border border-slate-200 rounded-lg p-3 bg-white/70">
                    <div class="text-[10px] text-slate-500">Overdue invoices</div>
                    <div id="focusInvoices" class="font-semibold text-rose-600">0</div>
                    <div class="text-[10px] text-slate-500">Follow up today</div>
                  </div>
                </div>
              </div>
              <div class="card p-5 col-span-4 space-y-4">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold">Goals</h3>
                  <span class="hint">Live progress</span>
                </div>
                <div>
                  <div class="flex items-center justify-between text-[11px] mb-1">
                    <span>Hours this week</span>
                    <span id="goalHoursLabel">0 / 0h</span>
                  </div>
                  <div class="progress-track">
                    <div id="goalHoursProgress" class="progress-thumb" style="width:0%"></div>
                  </div>
                </div>
                <div>
                  <div class="flex items-center justify-between text-[11px] mb-1">
                    <span>Income this month</span>
                    <span id="goalIncomeLabel">R 0 / R 0</span>
                  </div>
                  <div class="progress-track">
                    <div id="goalIncomeProgress" class="progress-thumb" style="width:0%"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
              <div class="card p-5 col-span-1">
                <div class="flex items-center justify-between mb-1">
                  <h3 class="text-xs font-medium text-slate-500">Active students</h3>
                </div>
                <div id="kpiStudents" class="text-2xl font-semibold text-slate-900">0</div>
                <p class="text-[11px] text-slate-500 mt-1">Students with at least one session in the last 30 days.</p>
              </div>
              <div class="card p-5 col-span-1">
                <h3 class="text-xs font-medium text-slate-500 mb-1">Hours this week</h3>
                <div id="kpiHoursWeek" class="text-2xl font-semibold text-slate-900">0</div>
                <p class="text-[11px] text-slate-500 mt-1">Sum of completed sessions.</p>
              </div>
              <div class="card p-5 col-span-1">
                <h3 class="text-xs font-medium text-slate-500 mb-1">Expected income (month)</h3>
                <div id="kpiExpectedIncome" class="text-2xl font-semibold text-slate-900">0</div>
                <p class="text-[11px] text-slate-500 mt-1">From issued & upcoming sessions.</p>
              </div>
              <div class="card p-5 col-span-1">
                <h3 class="text-xs font-medium text-slate-500 mb-1">Overdue invoices</h3>
                <div id="kpiOverdue" class="text-2xl font-semibold text-rose-600">0</div>
                <p class="text-[11px] text-slate-500 mt-1">Count of unpaid invoices past due date.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
              <div class="card p-5 col-span-7">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">Subject mix (hours)</h3>
                </div>
                <canvas id="subjectMixChart" class="w-full h-64"></canvas>
              </div>
              <div class="card p-5 col-span-5">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">Upcoming sessions (next 7 days)</h3>
                </div>
                <ul id="upcomingSessionsList" class="text-xs space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
              <div class="card p-5 col-span-4">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">At-risk students</h3>
                  <span class="hint">No session in 21+ days</span>
                </div>
                <ul id="atRiskList" class="text-xs space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-5 col-span-4">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">Homework due soon</h3>
                  <span class="hint">Next 5 days</span>
                </div>
                <ul id="dueHomeworkList" class="text-xs space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-5 col-span-4">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">Prep queue (next 3)</h3>
                  <span class="hint">Click to open</span>
                </div>
                <ul id="prepQueueList" class="text-xs space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
            </div>
          </div>
        </section>

        <!-- Students -->
        <section id="view-students" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold">Students</h2>
                <p class="text-xs text-slate-500">Manage profiles, 360¬∞ timelines and subject mix.</p>
              </div>
              <button id="addStudentBtn" data-owner-only class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700 shadow-sm">
                Ôºã Add student
              </button>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
              <!-- Student list -->
              <div class="card p-4 col-span-1 max-h-[75vh] overflow-y-auto scrollbar-thin">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-sm font-semibold">All students</h3>
                </div>
                <div class="flex flex-wrap gap-2 mb-2 text-[11px]">
                  <select id="studentSubjectFilter" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                    <option value="">All subjects</option>
                    <option value="Physics">Physics</option>
                    <option value="Chemistry">Chemistry</option>
                    <option value="Maths">Maths</option>
                  </select>
                  <select id="studentActivityFilter" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                    <option value="">All activity</option>
                    <option value="active">Active (&lt;14 days)</option>
                    <option value="quiet">Quiet (14+ days)</option>
                  </select>
                </div>
                <ul id="studentsList" class="space-y-2 text-xs"></ul>
                <div class="border-t border-slate-200 mt-4 pt-3 space-y-2" data-owner-only>
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold">Parents</h3>
                    <button id="addParentBtn" class="px-2 py-1 rounded-lg border border-slate-300 text-[11px]">Ôºã Add</button>
                  </div>
                  <ul id="parentsList" class="space-y-2 text-xs"></ul>
                </div>
              </div>

              <!-- Student detail -->
              <div class="card p-4 col-span-2 max-h-[75vh] overflow-y-auto scrollbar-thin">
              <div id="studentDetailEmpty" class="text-xs text-slate-500">
                Select a student on the left to view their 360¬∞ panel.
              </div>
              <div id="studentDetail" class="hidden text-xs space-y-3">
                <div class="flex items-center justify-between">
                <div>
                  <div id="studentDetailName" class="text-base font-semibold"></div>
                  <div id="studentDetailMeta" class="text-[11px] text-slate-500"></div>
                  <div id="studentContractMeta" class="text-[10px] text-slate-500"></div>
                </div>
                <div class="flex items-center gap-2">
                  <span id="studentContractBadge" class="px-2 py-1 text-[11px] rounded-lg bg-rose-100 text-rose-700 font-semibold">INVALID ‚Äì CONTRACT NOT SIGNED</span>
                  <button id="studentContractLinkBtn" data-owner-only class="px-2 py-1 text-[10px] rounded-lg border border-slate-300 hover:bg-slate-50">Copy parent link</button>
                  <button id="studentContractDeleteBtn" data-owner-only class="px-2 py-1 text-[10px] rounded-lg border border-rose-300 text-rose-700 hover:bg-rose-50 hidden">Remove contract</button>
                </div>
                <button id="editStudentBtn" data-owner-only class="px-2 py-1 text-[11px] rounded-lg border border-slate-300 hover:bg-slate-50">
                  Edit
                </button>
                </div>

                <!-- Subject mix bar -->
                <div>
                  <h4 class="text-[11px] font-semibold mb-1">Subject mix (last 30 days)</h4>
                  <div class="w-full h-3 rounded-full bg-slate-100 overflow-hidden flex text-[10px]">
                    <div id="mixPhysics" class="bg-indigo-500 h-full text-center text-white"></div>
                    <div id="mixChemistry" class="bg-emerald-500 h-full text-center text-white"></div>
                    <div id="mixMaths" class="bg-rose-500 h-full text-center text-white"></div>
                  </div>
                  <div class="flex justify-between mt-1 text-[10px] text-slate-500">
                    <span>Physics</span><span>Chemistry</span><span>Maths</span>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                  <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                    <div class="text-[10px] text-slate-500">Hours (last 30 days)</div>
                    <div id="engagementHours" class="text-lg font-semibold">0</div>
                  </div>
                  <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                    <div class="text-[10px] text-slate-500">Streak (weeks)</div>
                    <div id="engagementStreak" class="text-lg font-semibold">0</div>
                    <div class="text-[10px] text-slate-500" id="engagementNextGap"></div>
                  </div>
                  <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                    <div class="text-[10px] text-slate-500">Homework completion</div>
                    <div class="flex items-center justify-between">
                      <div id="engagementHomework" class="text-lg font-semibold">0%</div>
                      <div class="progress-track w-24">
                        <div id="engagementHomeworkProgress" class="progress-thumb" style="width:0%"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                  <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                    <div class="flex items-center justify-between mb-1">
                      <h4 class="text-[11px] font-semibold">Follow-ups</h4>
                      <span class="hint">Personal tasks</span>
                    </div>
                    <ul id="studentTodosList" class="space-y-1 text-[11px]"></ul>
                    <form id="studentTodoForm" class="mt-2 grid grid-cols-3 gap-1 text-[11px]">
                      <input name="todoText" placeholder="Email parent‚Ä¶" class="col-span-2 border border-slate-300 rounded-lg px-2 py-1">
                      <input name="todoDue" type="date" class="border border-slate-300 rounded-lg px-2 py-1">
                      <button class="col-span-3 bg-slate-900 text-white rounded-lg py-1">Add follow-up</button>
                    </form>
                  </div>
                  <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                    <div class="flex items-center justify-between mb-1">
                      <h4 class="text-[11px] font-semibold">Check-ins</h4>
                      <span class="hint">Timestamped notes</span>
                    </div>
                    <ul id="studentCheckinsList" class="space-y-1 text-[11px] max-h-32 overflow-y-auto scrollbar-thin"></ul>
                    <form id="studentCheckinForm" class="mt-2 space-y-1 text-[11px]">
                      <textarea name="checkinText" rows="2" class="w-full border border-slate-300 rounded-lg px-2 py-1" placeholder="Short note..."></textarea>
                      <button class="w-full bg-indigo-600 text-white rounded-lg py-1">Add check-in</button>
                    </form>
                  </div>
                  <div class="border border-slate-200 rounded-lg p-2 bg-white/70">
                    <div class="flex items-center justify-between mb-1">
                      <h4 class="text-[11px] font-semibold">Lesson contracts</h4>
                      <button id="uploadContractBtn" class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50">Upload scan</button>
                    </div>
                    <ul id="studentContractsList" class="space-y-1 text-[11px] max-h-32 overflow-y-auto scrollbar-thin"></ul>
                    <p class="hint mt-1">PDF or image stored locally; attach one per agreement.</p>
                  </div>
                </div>

                <!-- Tabs for detail -->
        <div class="border-b border-slate-200 flex gap-4 text-[11px]" id="studentDetailTabs">
          <button data-student-tab="timeline" class="student-tab border-b-2 border-indigo-500 pb-1 font-medium">
            Timeline
          </button>
          <button data-student-tab="sessions" class="student-tab pb-1 text-slate-500">
            Sessions
          </button>
          <button data-student-tab="documents" class="student-tab pb-1 text-slate-500">
            Documents
          </button>
          <button data-student-tab="finance" class="student-tab pb-1 text-slate-500">
            Finance
          </button>
          <button data-student-tab="messages" class="student-tab pb-1 text-slate-500">
            Messages
          </button>
        </div>
        <div id="studentUnsignedNotice" class="border border-rose-300 bg-rose-50 text-rose-800 text-[11px] rounded-lg px-3 py-2 hidden">
          Contract not signed. Share the parent link so the guardian can sign. Some features may be limited until signing is complete.
        </div>

                <div id="studentTab-timeline" class="student-tab-pane space-y-2 mt-2">
                  <ul id="studentTimeline" class="space-y-2 text-[11px]"></ul>
                </div>
                <div id="studentTab-sessions" class="student-tab-pane hidden mt-2">
                  <ul id="studentSessionsList" class="space-y-2 text-[11px]"></ul>
                </div>
                <div id="studentTab-documents" class="student-tab-pane hidden mt-2">
                  <div class="flex items-center justify-between mb-1">
                    <h4 class="text-[11px] font-semibold">Documents</h4>
                    <button id="addDocumentForStudentBtn" data-owner-only class="px-2 py-1 rounded-lg border border-slate-300 text-[10px] hover:bg-slate-50">
                      Ôºã Add document
                    </button>
                  </div>
                  <ul id="studentDocumentsList" class="space-y-2 text-[11px]"></ul>
                </div>
        <div id="studentTab-finance" class="student-tab-pane hidden mt-2">
          <div class="flex items-center justify-between mb-1">
            <h4 class="text-[11px] font-semibold">Invoices & balance</h4>
            <button id="studentCreateInvoiceBtn" data-owner-only class="px-2 py-1 rounded-lg border border-emerald-500 text-emerald-600 text-[10px] hover:bg-emerald-50">
              Ôºã Invoice for this student
            </button>
          </div>
          <div id="studentBalance" class="text-xs mb-1"></div>
          <ul id="studentInvoicesList" class="space-y-1 text-[11px]"></ul>
        </div>
        <div id="studentTab-messages" class="student-tab-pane hidden mt-2">
          <div class="flex items-center justify-between mb-1">
            <h4 class="text-[11px] font-semibold">Messages</h4>
            <span class="hint">Owner & student thread</span>
          </div>
          <ul id="studentMessagesList" class="space-y-1 text-[11px] max-h-64 overflow-y-auto scrollbar-thin"></ul>
          <form id="studentMessageForm" class="mt-2 space-y-1 text-[11px]">
            <textarea name="messageText" rows="2" class="w-full border border-slate-300 rounded-lg px-2 py-1" placeholder="Write a note to this student"></textarea>
            <button class="w-full bg-slate-900 text-white rounded-lg py-1">Send</button>
          </form>
        </div>
      </div>
            </div>
          </div>
        </section>

        <!-- Schedule -->
        <section id="view-schedule" class="view hidden">
          <div class="section-shell space-y-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-[10px] uppercase tracking-wide text-slate-500">Planner</p>
                <h2 class="text-lg font-semibold">Schedule</h2>
                <p class="text-xs text-slate-500">Week grid, quick stats, and conflict signals.</p>
              </div>
              <div class="flex items-center gap-2">
                <button id="schedulePrevWeek" class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs hover:bg-slate-50">‚Üê Prev</button>
                <button id="scheduleToday" class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs hover:bg-slate-50">Today</button>
                <button id="scheduleNextWeek" class="px-3 py-1.5 rounded-xl border border-slate-300 text-xs hover:bg-slate-50">Next ‚Üí</button>
                <button id="addSessionBtn" data-owner-only class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium hover:bg-slate-800 shadow-sm">
                  Ôºã Session
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 items-start">
              <!-- Left column: week grid -->
              <div class="card p-5 col-span-2 space-y-3 h-full">
                <div class="flex items-center justify-between text-xs">
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-slate-700"><span class="h-2 w-2 rounded-full bg-indigo-500"></span> Physics</span>
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-slate-700"><span class="h-2 w-2 rounded-full bg-emerald-500"></span> Chemistry</span>
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-slate-700"><span class="h-2 w-2 rounded-full bg-rose-500"></span> Maths</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <button id="exportIcsBtn" class="px-2 py-1 rounded-lg border border-indigo-300 text-indigo-700 hover:bg-indigo-50">Export ICS</button>
                    <div id="scheduleWeekLabel" class="font-medium text-slate-700"></div>
                  </div>
                </div>
                <div id="dayLoadRow" class="grid grid-cols-7 gap-2 text-[11px]"></div>
                <div class="calendar-grid text-[11px] min-h-[520px]" id="scheduleCalendarGrid">
                  <!-- days injected here -->
                </div>
                <div class="flex items-center justify-between text-[10px] text-slate-500">
                  <span>Click a session chip to open quick actions.</span>
                  <span class="flex items-center gap-2">
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 border border-amber-200">‚ö† Clash</span>
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-sky-50 text-sky-700 border border-sky-200">‚è± Tight gap</span>
                  </span>
                </div>
              </div>

              <!-- Right column: daily + conflict cards -->
              <div class="flex flex-col gap-4 h-full">
                <div class="card p-4 text-xs space-y-2 h-full">
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold">Today</h3>
                    <span class="text-[10px] text-slate-500">Live list</span>
                  </div>
                  <ul id="todaySessionsList" class="space-y-1 max-h-60 overflow-y-auto scrollbar-thin"></ul>
                </div>
                <div class="card p-4 text-xs space-y-2">
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold">Potential clashes</h3>
                    <span class="text-[10px] text-amber-600">Overlap same student</span>
                  </div>
                  <ul id="clashList" class="space-y-1 max-h-32 overflow-y-auto scrollbar-thin text-[11px]"></ul>
                </div>
                <div class="card p-4 text-xs space-y-2">
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold">Tight transitions</h3>
                    <span class="text-[10px] text-slate-500">&lt; 20 min gap</span>
                  </div>
                  <ul id="tightTransitionsList" class="space-y-1 max-h-32 overflow-y-auto scrollbar-thin text-[11px]"></ul>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Resources -->
        <section id="view-resources" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
            <h2 class="text-lg font-semibold">Resources</h2>
            <p class="text-xs text-slate-500">Worksheets, lectures, and homework tracking. Upload files for quick download.</p>
              </div>
              <button id="addResourceBtn" data-owner-only class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700 shadow-sm">
                Ôºã Add resource
              </button>
            </div>

          <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <div class="card p-4 col-span-2 max-h-[75vh] overflow-y-auto scrollbar-thin">
              <div class="flex items-center justify-between mb-2 text-xs">
                <div class="flex gap-2">
                  <select id="resourceSubjectFilter" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                    <option value="">All subjects</option>
                    <option value="Physics">Physics</option>
                    <option value="Chemistry">Chemistry</option>
                    <option value="Maths">Maths</option>
                  </select>
                  <input id="resourceSearchInput" type="text" placeholder="Search resources"
                         class="border border-slate-300 rounded-xl px-2 py-1 text-xs w-40">
                </div>
              </div>
              <div id="resourceTagFilters" class="flex flex-wrap gap-2 mb-3 text-[10px]"></div>
              <ul id="resourcesList" class="space-y-2 text-xs"></ul>
            </div>

            <!-- Homework board -->
            <div class="card p-4 col-span-1 max-h-[75vh] overflow-y-auto scrollbar-thin text-xs">
              <h3 class="text-sm font-semibold mb-2">Homework board</h3>
              <div class="grid grid-cols-3 gap-2 text-[11px]">
                <div>
                  <div class="font-semibold mb-1">To Do</div>
                  <ul id="hwTodo" class="space-y-1"></ul>
                </div>
                <div>
                  <div class="font-semibold mb-1">In progress</div>
                  <ul id="hwInProgress" class="space-y-1"></ul>
                </div>
                <div>
                  <div class="font-semibold mb-1">Completed</div>
                  <ul id="hwDone" class="space-y-1"></ul>
                </div>
              </div>
              <p class="mt-2 text-[10px] text-slate-500">Change status using the dropdown on each card.</p>
            </div>
            </div>
          </div>
        </section>

        <!-- Finance -->
        <section id="view-finance" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold">Finance</h2>
                <p class="text-xs text-slate-500">Invoices, balances & overdue reminders.</p>
              </div>
              <button id="addInvoiceBtn" data-owner-only class="inline-flex items-center gap-1 px-3 py-1.5 rounded-2xl bg-emerald-600 text-white text-xs font-medium hover:bg-emerald-700 shadow-sm">
                Ôºã Create invoice
              </button>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 text-xs">
              <div class="card p-4 col-span-2 max-h-[75vh] overflow-y-auto scrollbar-thin">
              <h3 class="text-sm font-semibold mb-2">Student balances</h3>
              <table class="w-full text-[11px]">
                <thead>
                <tr class="text-left text-[10px] text-slate-500 border-b border-slate-200">
                  <th class="py-1 pr-1">Student</th>
                  <th class="py-1 pr-1 text-right">Balance</th>
                  <th class="py-1 pr-1 text-right">Unpaid invoices</th>
                </tr>
                </thead>
                <tbody id="financeStudentTable"></tbody>
              </table>
            </div>
            <div class="card p-4 col-span-1 max-h-[75vh] overflow-y-auto scrollbar-thin">
              <h3 class="text-sm font-semibold mb-2">Overdue invoices</h3>
              <ul id="overdueInvoicesList" class="space-y-2 text-[11px]"></ul>
              <p class="mt-2 text-[10px] text-slate-500">Click ‚ÄúReminder text‚Äù to generate a polite message you can paste into email or chat.</p>
            </div>
          </div>

          <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 text-xs mt-4">
            <div class="card p-4 col-span-2">
              <h3 class="text-sm font-semibold mb-2">Unbilled hours</h3>
              <ul id="unbilledList" class="space-y-2 text-[11px]"></ul>
              <p class="mt-2 text-[10px] text-slate-500">Calculated from sessions since the last invoice per student (using their rate).</p>
            </div>
            <div class="card p-4 col-span-1">
              <h3 class="text-sm font-semibold mb-2">Cashflow forecast (14 days)</h3>
              <div id="forecastSummary" class="text-sm font-semibold"></div>
              <ul id="forecastList" class="space-y-1 text-[11px] mt-2"></ul>
            </div>
          </div>
        </section>

        <!-- Settings -->
        <section id="view-settings" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold">Settings</h2>
                <p class="text-xs text-slate-500">Theme, layout & data backup.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="card p-5 text-xs space-y-3">
              <h3 class="text-sm font-semibold mb-1">Appearance</h3>
              <div class="flex items-center justify-between">
                <span>Theme</span>
                <select id="settingsThemeSelect" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                  <option value="light">Light</option>
                  <option value="dark">Dark</option>
                </select>
              </div>
              <div class="flex items-center justify-between">
                <span>Layout density</span>
                <select id="settingsDensitySelect" class="border border-slate-300 rounded-xl px-2 py-1 text-xs">
                  <option value="comfortable">Comfortable</option>
                  <option value="compact">Compact</option>
                </select>
              </div>
            </div>

            <div class="card p-5 text-xs space-y-3">
              <h3 class="text-sm font-semibold mb-1">Goals & defaults</h3>
              <div class="flex items-center justify-between gap-2">
                <span>Weekly hours goal</span>
                <input id="settingsWeeklyGoal" type="number" step="0.5" class="border border-slate-300 rounded-xl px-2 py-1 text-xs w-24">
              </div>
              <div class="flex items-center justify-between gap-2">
                <span>Monthly income goal (R)</span>
                <input id="settingsMonthlyGoal" type="number" step="100" class="border border-slate-300 rounded-xl px-2 py-1 text-xs w-24">
              </div>
              <div class="flex items-center justify-between gap-2">
                <span>Default session duration (h)</span>
                <input id="settingsDefaultDuration" type="number" step="0.25" class="border border-slate-300 rounded-xl px-2 py-1 text-xs w-24">
              </div>
              <div>
                <label class="block text-[11px] mb-1">Weekly reflection note</label>
                <textarea id="settingsReflection" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]" placeholder="What matters this week?"></textarea>
              </div>
            </div>

            <div class="card p-5 text-xs space-y-3">
              <h3 class="text-sm font-semibold mb-1">Data backup</h3>
              <p>Export your dashboard data as JSON and paste it somewhere safe. You can import it later.</p>
              <div class="flex gap-2">
                <button id="exportDataBtn" class="px-3 py-1.5 rounded-2xl bg-slate-900 text-white text-xs shadow-sm">Export</button>
                <button id="importDataBtn" class="px-3 py-1.5 rounded-2xl border border-slate-300 text-xs">Import</button>
              </div>
              <textarea id="backupTextarea" rows="5" class="mt-2 w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]" placeholder="Exported JSON will appear here. Paste JSON here to import."></textarea>
            </div>

            <div class="card p-5 text-xs space-y-3">
              <h3 class="text-sm font-semibold mb-1">Activity log</h3>
              <p class="text-[11px] text-slate-500">Recent actions for this account (last 25).</p>
              <ul id="activityLogList" class="space-y-1 max-h-64 overflow-y-auto scrollbar-thin"></ul>
            </div>
          </div>
        </section>

        <!-- Profile -->
        <section id="view-profile" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold">Your profile</h2>
                <p class="text-xs text-slate-500">Account details, security, and data controls.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 text-xs">
              <div class="card p-5 space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold">Account</h3>
                  <span id="profileEmailVerified" class="text-[10px] px-2 py-0.5 rounded-full bg-amber-100 text-amber-700">Unverified</span>
                </div>
                <div class="text-[11px] text-slate-500">Email</div>
                <div id="profileEmail" class="text-sm font-semibold">‚Äî</div>
                <div class="grid grid-cols-2 gap-3 mt-2">
                  <div>
                    <div class="text-[11px] text-slate-500">Role</div>
                    <div id="profileRole" class="text-[11px] font-semibold">‚Äî</div>
                  </div>
                  <div>
                    <div class="text-[11px] text-slate-500">User ID</div>
                    <div id="profileUid" class="text-[11px] font-semibold truncate">‚Äî</div>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-2">
                  <div>
                    <div class="text-[11px] text-slate-500">Created</div>
                    <div id="profileCreated" class="text-[11px] font-semibold">‚Äî</div>
                  </div>
                  <div>
                    <div class="text-[11px] text-slate-500">Last sign-in</div>
                    <div id="profileLastSignIn" class="text-[11px] font-semibold">‚Äî</div>
                  </div>
                </div>
                <div class="text-[10px] text-slate-500 mt-2" id="profileSessionMeta"></div>
              </div>

              <div class="card p-5 space-y-3 border border-rose-200 bg-rose-50">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold text-rose-700">Delete account</h3>
                  <span class="text-[10px] text-rose-600">Irreversible</span>
                </div>
                <p class="text-[11px] text-rose-700">
                  This deletes your account and all associated data (students, sessions, invoices, resources, notes). You‚Äôll need to sign up again to use the dashboard.
                </p>
                <button id="deleteAccountBtn" class="px-3 py-1.5 rounded-xl border border-rose-400 bg-rose-600 text-white text-xs font-semibold hover:bg-rose-700">
                  Delete my account
                </button>
                <div id="deleteAccountStatus" class="text-[11px] text-rose-700"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Student portal (student-mode only) -->
        <section id="view-portal" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold">My portal</h2>
                <p class="text-xs text-slate-500">Your schedule, homework, invoices, and resources.</p>
              </div>
            </div>
            <div id="portalBlocker" class="hidden border border-rose-300 bg-rose-50 text-rose-800 rounded-lg px-3 py-2 text-xs">
              INVALID ‚Äì CONTRACT NOT SIGNED. Ask your parent/guardian to sign the contract to unlock this portal.
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 text-xs">
              <div class="card p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold">Upcoming sessions</h3>
                  <span class="hint">Next 14 days</span>
                </div>
                <ul id="portalSessions" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold">Homework</h3>
                  <span class="hint">Open items</span>
                </div>
                <ul id="portalHomework" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold">Invoices</h3>
                  <span class="hint">Unpaid first</span>
                </div>
                <ul id="portalInvoices" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
        <div class="card p-4 space-y-2">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-semibold">Resources</h3>
            <span class="hint">Assigned to you</span>
          </div>
          <ul id="portalResources" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
        </div>
        <div class="card p-4 space-y-2">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-semibold">Messages</h3>
            <span class="hint">Tutor ‚Üî Student</span>
          </div>
          <ul id="portalMessages" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
        </div>
      </div>
    </div>
  </section>

        <!-- Reports -->
        <section id="view-reports" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold">Reports</h2>
                <p class="text-xs text-slate-500">Earnings, attendance, subject mix, and homework completion.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
              <div class="card p-4">
                <div class="text-[11px] text-slate-500">This month earnings</div>
                <div id="repEarningsMonth" class="text-2xl font-semibold">R 0</div>
                <div class="text-[10px] text-slate-500" id="repEarningsCount"></div>
              </div>
              <div class="card p-4">
                <div class="text-[11px] text-slate-500">Attendance</div>
                <div id="repAttendance" class="text-2xl font-semibold">0%</div>
                <div class="text-[10px] text-slate-500" id="repAttendanceMeta"></div>
              </div>
              <div class="card p-4">
                <div class="text-[11px] text-slate-500">Homework completion</div>
                <div id="repHomework" class="text-2xl font-semibold">0%</div>
                <div class="text-[10px] text-slate-500" id="repHomeworkMeta"></div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
              <div class="card p-4">
                <h3 class="text-sm font-semibold mb-2">Subject hours (total)</h3>
                <ul id="repSubjectMix" class="space-y-1"></ul>
              </div>
              <div class="card p-4">
                <h3 class="text-sm font-semibold mb-2">Unpaid invoices</h3>
                <ul id="repUnpaidList" class="space-y-1 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
            </div>
          </div>
        </section>

        <!-- Parent portal (parent-mode only) -->
        <section id="view-parent-portal" class="view hidden">
          <div class="section-shell space-y-4">
            <div class="flex items-center justify-between mb-1">
              <div>
                <h2 class="text-lg font-semibold">Parent portal</h2>
                <p class="text-xs text-slate-500">Linked students, schedules, homework, invoices, and messages.</p>
              </div>
            </div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 text-xs">
              <div class="card p-4 space-y-2">
                <h3 class="text-sm font-semibold">Linked students</h3>
                <ul id="parentStudentsList" class="space-y-2 max-h-72 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-4 space-y-2">
                <h3 class="text-sm font-semibold">Messages</h3>
                <ul id="parentMessages" class="space-y-2 max-h-72 overflow-y-auto scrollbar-thin"></ul>
              </div>
            </div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 text-xs">
              <div class="card p-4 space-y-2">
                <h3 class="text-sm font-semibold">Upcoming sessions</h3>
                <ul id="parentSessions" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-4 space-y-2">
                <h3 class="text-sm font-semibold">Homework status</h3>
                <ul id="parentHomework" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
            </div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 text-xs">
              <div class="card p-4 space-y-2">
                <h3 class="text-sm font-semibold">Invoices</h3>
                <ul id="parentInvoices" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
              <div class="card p-4 space-y-2">
                <h3 class="text-sm font-semibold">Resources</h3>
                <ul id="parentResources" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin"></ul>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- OVERLAY & MODALS -->

  <div id="modalOverlay" class="overlay">
    <div id="modalContainer" class="card w-full max-w-lg max-h-[90vh] overflow-y-auto p-4 text-xs">
      <!-- modal content injected here -->
    </div>
  </div>

  <!-- AUTH OVERLAY -->
  <div id="authOverlay" class="auth-overlay">
    <div class="card w-full max-w-sm p-5 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold">Sign in</h2>
      </div>
      <p class="text-[11px] text-slate-500">Please sign in or sign up from the dedicated pages.</p>
      <div class="space-y-2">
        <a href="./login.html" class="block px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium text-center">Go to Sign in</a>
        <a href="./signup.html" class="block px-3 py-1.5 rounded-xl border border-slate-300 text-xs font-medium text-center">Go to Sign up</a>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * STATE & PERSISTENCE *
     ***********************/
    const STORAGE_KEY = 'tutoringDashboardState_v1';

    /***********************
     * SUPABASE CONFIG      *
     ***********************/
    const SUPABASE_URL = 'https://wdsqnbebutuhwckjpwqf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indkc3FuYmVidXR1aHdja2pwd3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMDE1NzcsImV4cCI6MjA3OTY3NzU3N30.pJglpTaZouSQFUVCbQONHK1UsB9CgWewKQCIV13NOEM';
    const OWNER_EMAIL = 'erichuang.shangjing@outlook.com';
    // If true, try Supabase Storage uploads; if false, always fall back to local data URL to avoid 400/RLS spam until backend is fixed.
    const ALLOW_STORAGE_UPLOADS = true;
    // hCaptcha config
    const HCAPTCHA_ENABLED = true;
    const HCAPTCHA_SITEKEY = '3ff631fc-4c9c-43ee-a486-3232939eedb2';
    const supabaseAvailable =
      typeof supabase !== 'undefined' &&
      SUPABASE_URL.startsWith('https://') &&
      !SUPABASE_URL.includes('YOUR_PROJECT') &&
      SUPABASE_ANON_KEY.length > 10 &&
      !SUPABASE_ANON_KEY.includes('YOUR_ANON');
    let supabaseClient = null;
    let supabaseSession = null;
    let readOnlyMode = false;
    let studentMode = false;
    let parentMode = false;
    let hcaptchaWidgetId = null;
    let hcaptchaToken = '';
    let accountEmails = [];
    let privacyRead = false;
    let tosRead = false;
    let presenceHeartbeat = null;
    let presenceMap = new Map();

    // SAFE deep clone helper
    function deepClone(obj) {
      return JSON.parse(JSON.stringify(obj));
    }

    const defaultState = {
      students: [],
      parents: [],
      parentLinks: [],
      sessions: [],
      resources: [],
      invoices: [],
      documents: [],
      homework: [],
      studentTodos: [],
      studentCheckins: [],
      contracts: [],
      contractSignatures: [],
      messages: [],
      activityLog: [],
      settings: {
        theme: 'light',
        density: 'comfortable',
        weeklyGoalHours: 10,
        monthlyIncomeGoal: 0,
        reflection: '',
        defaultSessionDuration: 1.5
      }
    };

    let state = loadState();

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return deepClone(defaultState);
        const parsed = JSON.parse(raw);
        const merged = Object.assign(deepClone(defaultState), parsed);
        merged.settings = Object.assign(deepClone(defaultState.settings), parsed.settings || {});
        return merged;
      } catch (e) {
        console.error('Failed to load state', e);
        return deepClone(defaultState);
      }
    }

    function cleanId(val) {
      return String(val || '').trim().replace(/['"]/g, '');
    }

    function isUuid(val) {
      const cleaned = cleanId(val);
      return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(cleaned);
    }

    function stripBucketPrefix(path, bucket) {
      if (!path) return '';
      const trimmed = cleanId(path);
      if (trimmed.startsWith(bucket + '/')) {
        return trimmed.slice(bucket.length + 1);
      }
      return trimmed;
    }

    function sanitizeState(st) {
      ['students','parents','parentLinks','sessions','resources','homework','documents','contracts','invoices','studentTodos','studentCheckins','messages'].forEach(key => {
        if (!Array.isArray(st[key])) st[key] = [];
      });
      if (!Array.isArray(st.activityLog)) st.activityLog = [];
      st.students.forEach(s => {
        s.id = cleanId(s.id);
        s.studentEmail = (s.studentEmail || s.student_email || '').trim().toLowerCase();
        s.contractSigned = !!s.contractSigned;
        s.contractSignedAt = s.contractSignedAt || s.contract_signed_at || '';
        s.contractVersion = s.contractVersion || s.contract_version || 'v1';
        s.contractSignerName = s.contractSignerName || s.contract_signer_name || '';
        s.contractSignerEmail = s.contractSignerEmail || s.contract_signer_email || '';
        s.lastContractId = s.lastContractId || s.last_contract_id || '';
      });
      st.parents.forEach(p => { p.id = cleanId(p.id); p.email = (p.email || '').trim().toLowerCase(); });
      st.parentLinks.forEach(pl => { pl.id = cleanId(pl.id); pl.parentId = cleanId(pl.parentId); pl.studentId = cleanId(pl.studentId); });
      st.sessions.forEach(s => {
        s.id = cleanId(s.id);
        s.studentIds = (s.studentIds || []).map(cleanId);
        s.invoiceId = cleanId(s.invoiceId);
      });
      st.resources.forEach(r => {
        r.id = cleanId(r.id);
        r.storage_path = stripBucketPrefix(r.storage_path, 'resources');
        r.fileName = r.fileName || r.file_name || '';
      });
      st.homework.forEach(h => { h.id = cleanId(h.id); h.studentId = cleanId(h.studentId); h.resourceId = cleanId(h.resourceId); });
      st.documents.forEach(d => { d.id = cleanId(d.id); d.studentId = cleanId(d.studentId); });
      st.contracts.forEach(c => {
        c.id = cleanId(c.id);
        c.studentId = cleanId(c.studentId);
        c.storage_path = stripBucketPrefix(stripBucketPrefix(c.storage_path, 'signed_contracts'), 'contracts');
      });
      st.invoices.forEach(i => { i.id = cleanId(i.id); i.studentId = cleanId(i.studentId); });
      st.studentTodos.forEach(t => { t.id = cleanId(t.id); t.studentId = cleanId(t.studentId); });
      st.studentCheckins.forEach(c => { c.id = cleanId(c.id); c.studentId = cleanId(c.studentId); });
      if (!Array.isArray(st.contractSignatures)) st.contractSignatures = [];
      st.contractSignatures.forEach(cs => {
        cs.id = cleanId(cs.id);
        cs.studentId = cleanId(cs.studentId);
        cs.contract_version = cs.contract_version || cs.contractVersion || 'v1';
        cs.rendered_pdf_url = cs.rendered_pdf_url || cs.renderedPdfUrl || '';
        cs.contract_text_snapshot = cs.contract_text_snapshot || cs.contractTextSnapshot || '';
      });
      st.activityLog.forEach(a => { a.id = cleanId(a.id); });
      st.messages.forEach(m => { m.id = cleanId(m.id); m.studentId = cleanId(m.studentId); m.sender = (m.sender || '').trim(); });
      st.messages.forEach(m => { m.id = cleanId(m.id); m.studentId = cleanId(m.studentId); });
    }

    function forceUuid(val) {
      const cleaned = cleanId(val);
      return isUuid(cleaned) ? cleaned : (crypto?.randomUUID ? crypto.randomUUID() : cleaned);
    }

    function enforceUuidFields() {
      state.students.forEach(s => { s.id = forceUuid(s.id); });
      state.parents.forEach(p => { p.id = forceUuid(p.id); });
      state.parentLinks.forEach(pl => { pl.id = forceUuid(pl.id); pl.parentId = forceUuid(pl.parentId); pl.studentId = forceUuid(pl.studentId); });
      state.sessions.forEach(sess => { sess.id = forceUuid(sess.id); sess.studentIds = (sess.studentIds || []).map(forceUuid); sess.invoiceId = cleanId(sess.invoiceId); });
      state.resources.forEach(r => { r.id = forceUuid(r.id); });
      state.homework.forEach(hw => { hw.id = forceUuid(hw.id); hw.studentId = forceUuid(hw.studentId); hw.resourceId = forceUuid(hw.resourceId); });
      state.documents.forEach(d => { d.id = forceUuid(d.id); d.studentId = forceUuid(d.studentId); });
      state.contracts.forEach(c => { c.id = forceUuid(c.id); c.studentId = forceUuid(c.studentId); });
      state.contractSignatures.forEach(cs => { cs.id = forceUuid(cs.id); cs.studentId = forceUuid(cs.studentId); });
      // Do NOT force invoice IDs to UUIDs to preserve existing invoice identifiers in the DB.
      state.invoices.forEach(inv => { inv.id = cleanId(inv.id); inv.studentId = forceUuid(inv.studentId); });
      state.studentTodos.forEach(t => { t.id = forceUuid(t.id); t.studentId = forceUuid(t.studentId); });
      state.studentCheckins.forEach(c => { c.id = forceUuid(c.id); c.studentId = forceUuid(c.studentId); });
      state.activityLog.forEach(l => { l.id = forceUuid(l.id); });
      state.messages.forEach(m => { m.id = forceUuid(m.id); m.studentId = forceUuid(m.studentId); });
    }

    function normalizeIdsToUuid() {
      sanitizeState(state);
      const maps = {
        students: new Map(),
        parents: new Map(),
        parentLinks: new Map(),
        sessions: new Map(),
        resources: new Map(),
        homework: new Map(),
        documents: new Map(),
        contracts: new Map(),
        studentTodos: new Map(),
        studentCheckins: new Map(),
        messages: new Map()
      };
      function ensureId(entity, key, map) {
        entity.id = cleanId(entity.id);
        if (isUuid(entity.id)) return entity.id;
        const existing = map.get(entity.id);
        if (existing) {
          entity.id = existing;
          return existing;
        }
        const newId = crypto.randomUUID();
        map.set(entity.id, newId);
        entity.id = newId;
        return newId;
      }
      state.students.forEach(s => ensureId(s, 'students', maps.students));
      state.parents.forEach(p => ensureId(p, 'parents', maps.parents));
      state.parentLinks.forEach(pl => ensureId(pl, 'parentLinks', maps.parentLinks));
      state.sessions.forEach(sess => ensureId(sess, 'sessions', maps.sessions));
      state.resources.forEach(r => ensureId(r, 'resources', maps.resources));
      state.homework.forEach(hw => ensureId(hw, 'homework', maps.homework));
      state.documents.forEach(d => ensureId(d, 'documents', maps.documents));
      state.contracts.forEach(c => ensureId(c, 'contracts', maps.contracts));
      state.studentTodos.forEach(t => ensureId(t, 'studentTodos', maps.studentTodos));
      state.studentCheckins.forEach(c => ensureId(c, 'studentCheckins', maps.studentCheckins));
      state.messages.forEach(m => ensureId(m, 'messages', maps.messages));
      state.messages.forEach(m => ensureId(m, 'messages', maps.messages));

      // remap references
      state.sessions.forEach(sess => {
        const seen = new Set();
        sess.studentIds = (sess.studentIds || [])
          .map(id => {
            const cleaned = cleanId(id);
            return maps.students.get(cleaned) || cleaned;
          })
          .filter(id => {
            if (!id) return false;
            if (seen.has(id)) return false;
            seen.add(id);
            return true;
          });
      });
      state.homework.forEach(hw => {
        const sid = cleanId(hw.studentId);
        const rid = cleanId(hw.resourceId);
        hw.studentId = maps.students.get(sid) || sid;
        hw.resourceId = maps.resources.get(rid) || rid;
      });
      state.documents.forEach(d => {
        const sid = cleanId(d.studentId);
        d.studentId = maps.students.get(sid) || sid;
      });
      state.contracts.forEach(c => {
        const sid = cleanId(c.studentId);
        c.studentId = maps.students.get(sid) || sid;
      });
      state.contractSignatures.forEach(cs => {
        const sid = cleanId(cs.studentId);
        cs.studentId = maps.students.get(sid) || sid;
      });
      state.invoices.forEach(inv => {
        const sid = cleanId(inv.studentId);
        inv.studentId = maps.students.get(sid) || sid;
      });
      state.studentTodos.forEach(t => {
        const sid = cleanId(t.studentId);
        t.studentId = maps.students.get(sid) || sid;
      });
      state.studentCheckins.forEach(c => {
        const sid = cleanId(c.studentId);
        c.studentId = maps.students.get(sid) || sid;
      });
    }

    function saveState() {
      if (readOnlyMode) {
        console.warn('Read-only mode: changes are not saved.');
        return;
      }
      normalizeIdsToUuid();
      enforceUuidFields();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      updateKPIsAndCharts();
      if (isSupabaseReady()) {
        syncStateToSupabase().catch(err => console.error('Supabase sync failed', err));
      }
    }

    function isSupabaseReady() {
      return !!(supabaseClient && supabaseSession);
    }

    async function syncStateToSupabase() {
      if (readOnlyMode) return;
      normalizeIdsToUuid();
      enforceUuidFields();
      const uid = supabaseSession?.user?.id;
      if (!uid) return;

      const parents = state.parents.map(p => ({
        id: cleanId(p.id),
        user_id: uid,
        email: (p.email || '').trim().toLowerCase(),
        name: p.name,
        phone: p.phone,
        notes: p.notes,
        verified: p.verified || false
      }));
      await upsertAndPrune('parents', parents, 'id');

      const parentLinks = state.parentLinks.map(pl => ({
        id: cleanId(pl.id),
        user_id: uid,
        parent_id: cleanId(pl.parentId),
        student_id: cleanId(pl.studentId),
        relationship: pl.relationship
      }));
      await upsertAndPrune('parent_students', parentLinks, 'id');

      // prepare rows with user_id
      const students = state.students.map(s => ({
        id: cleanId(s.id),
        user_id: uid,
        name: s.name,
        grade_level: s.gradeLevel,
        rate: s.rate,
        subjects: s.subjects,
        notes: s.notes,
        student_email: (s.studentEmail || '').trim(),
        created_at: s.createdAt,
        contract_signed: !!s.contractSigned,
        contract_signed_at: s.contractSignedAt || null,
        contract_version: s.contractVersion || 'v1',
        contract_signer_name: s.contractSignerName || null,
        contract_signer_email: s.contractSignerEmail || null,
        last_contract_id: s.lastContractId || null
      }));
      await upsertAndPrune('students', students, 'id');

      const sessionsClean = state.sessions
        .map(sess => ({
          ...sess,
          studentIds: (sess.studentIds || []).map(cleanId).filter(Boolean)
        }))
        .filter(sess => sess.date && sess.studentIds.length > 0);

      const sessions = sessionsClean.map(sess => ({
        id: cleanId(sess.id),
        user_id: uid,
        date: sess.date,
        start_time: sess.startTime,
        duration_hours: sess.durationHours,
        subject: sess.subject,
        topic: sess.topic,
        notes: sess.notes,
        completed: sess.completed,
        invoice_id: cleanId(sess.invoiceId)
      }));
      try {
        await upsertAndPrune('sessions', sessions, 'id');
      } catch (err) {
        console.warn('Sessions sync failed (check schema for invoice_id column):', err?.message || err);
      }

      const sessionStudents = [];
      const pairSeen = new Set();
      sessionsClean.forEach(sess => {
        const sId = cleanId(sess.id);
        if (!sId) return;
        (sess.studentIds || []).forEach(stuId => {
          const stuClean = cleanId(stuId);
          if (!stuClean) return;
          const key = `${sId}|${stuClean}`;
          if (pairSeen.has(key)) return;
          pairSeen.add(key);
          sessionStudents.push({
            session_id: sId,
            student_id: stuClean,
            user_id: uid
          });
        });
      });
      if (sessionStudents.length) {
        const { error } = await supabaseClient
          .from('session_students')
          .upsert(sessionStudents, { onConflict: 'session_id,student_id', ignoreDuplicates: true });
        if (error) console.error('session_students insert failed', error);
      }

      const resources = state.resources.map(r => ({
        id: cleanId(r.id),
        user_id: uid,
        title: r.title,
        subject: r.subject,
        level: r.level,
        tags: r.tags,
        description: r.description,
        created_at: r.createdAt,
        favorite: r.favorite,
        storage_path: r.storage_path,
        file_name: r.fileName
      }));
      try {
        await upsertAndPrune('resources', resources, 'id');
      } catch (err) {
        console.error('Resources upsert failed (check RLS on table "resources")', err);
      }

      const activity = state.activityLog.map(a => ({
        id: cleanId(a.id),
        user_id: uid,
        action: a.action,
        detail: a.detail,
        created_at: a.created_at
      }));
      try {
        await upsertAndPrune('activity_log', activity, 'id');
      } catch (err) {
        console.warn('Activity log sync skipped', err);
      }

      const homework = state.homework.map(h => ({
        id: cleanId(h.id),
        user_id: uid,
        student_id: cleanId(h.studentId),
        resource_id: cleanId(h.resourceId),
        status: h.status,
        due_date: h.dueDate,
        assigned_date: h.assignedDate
      }));
      await upsertAndPrune('homework', homework, 'id');

      const documents = state.documents.map(d => ({
        id: cleanId(d.id),
        user_id: uid,
        student_id: cleanId(d.studentId),
        title: d.title,
        status: d.status,
        date: d.date,
        notes: d.notes,
        created_at: d.createdAt
      }));
      await upsertAndPrune('documents', documents, 'id');

      const contracts = state.contracts.map(c => ({
        id: cleanId(c.id),
        user_id: uid,
        student_id: cleanId(c.studentId),
        file_name: c.fileName,
        storage_path: c.storage_path,
        status: c.status,
        notes: c.notes,
        uploaded_at: c.uploadedAt
      }));
      await upsertAndPrune('contracts', contracts, 'id');

      const invoices = state.invoices.map(inv => ({
        id: cleanId(inv.id),
        user_id: uid,
        student_id: cleanId(inv.studentId),
        issue_date: inv.issueDate,
        due_date: inv.dueDate,
        base_amount: inv.baseAmount,
        total: inv.total,
        late_fee_percent: inv.lateFeePercent,
        short_notice_percent: inv.shortNoticePercent,
        late_applied: inv.lateApplied,
        short_applied: inv.shortApplied,
        paid: inv.paid,
        notes: inv.notes
      }));
      await upsertAndPrune('invoices', invoices, 'id');

      const todos = state.studentTodos.map(t => ({
        id: cleanId(t.id),
        user_id: uid,
        student_id: cleanId(t.studentId),
        text: t.text,
        due_date: t.dueDate,
        done: t.done,
        created_at: t.createdAt
      }));
      await upsertAndPrune('student_todos', todos, 'id');

      const checkins = state.studentCheckins.map(c => ({
        id: cleanId(c.id),
        user_id: uid,
        student_id: cleanId(c.studentId),
        text: c.text,
        date: c.date,
        created_at: c.createdAt
      }));
      await upsertAndPrune('student_checkins', checkins, 'id');

      const messages = state.messages.map(m => ({
        id: cleanId(m.id),
        user_id: uid,
        student_id: cleanId(m.studentId),
        text: m.text,
        sender: m.sender,
        created_at: m.created_at
      }));
      try {
        await upsertAndPrune('messages', messages, 'id');
      } catch (err) {
        console.warn('Messages sync skipped', err);
      }
    }

    async function upsertAndPrune(table, rows, pk) {
      if (!supabaseClient) return;
      const uid = supabaseSession?.user?.id;
      if (!uid) return;
      // Upsert rows
      if (rows.length) {
        const { error } = await supabaseClient.from(table).upsert(rows);
      if (error) {
        console.error(`Upsert failed for ${table}`, error);
        throw error;
      }
      }
      // Prune skipped to avoid accidental deletions; Supabase is source of truth.
    }

    async function deleteContractForStudent(signatureId, studentId) {
      // identify storage objects to remove
      const targets = signatureId
        ? state.contracts.filter(c => c.id === signatureId || c.studentId === studentId)
        : state.contracts.filter(c => c.studentId === studentId);
      // Try deleting from both buckets because storage_path may be stored without bucket prefix
      const storageObjects = targets
        .flatMap(c => {
          const raw = c.storage_path || '';
          const possible = ['signed_contracts', 'contracts'].map(bucket => {
            const path = stripBucketPrefix(raw, bucket);
            return path ? { bucket, path } : null;
          }).filter(Boolean);
          return possible;
        })
        .filter(Boolean);

      // local cleanup
      if (signatureId) {
        state.contractSignatures = state.contractSignatures.filter(cs => cs.id !== signatureId);
        state.contracts = state.contracts.filter(c => c.id !== signatureId);
      } else {
        state.contractSignatures = state.contractSignatures.filter(cs => cs.studentId !== studentId);
        state.contracts = state.contracts.filter(c => c.studentId !== studentId);
      }
      const stu = getStudentById(studentId);
      if (stu) {
        stu.contractSigned = false;
        stu.contractSignedAt = null;
        stu.contractSignerName = '';
        stu.contractSignerEmail = '';
        stu.lastContractId = '';
      }
      saveState();
      renderStudentContracts(studentId);
      renderStudentFinance(studentId);
      renderStudentTimeline(studentId);
      renderStudentsView();
      // remote cleanup
      if (isSupabaseReady()) {
        try {
          if (signatureId) {
            await supabaseClient.from('parent_contract_signatures').delete().eq('id', signatureId);
            await supabaseClient.from('contracts').delete().eq('id', signatureId);
          } else {
            await supabaseClient.from('parent_contract_signatures').delete().eq('student_id', studentId);
            await supabaseClient.from('contracts').delete().eq('student_id', studentId);
          }
          // remove storage objects if paths exist
          for (const obj of storageObjects) {
            try {
              await supabaseClient.storage.from(obj.bucket).remove([obj.path]);
            } catch (err) {
              console.warn('Storage delete failed', err);
            }
          }
          await supabaseClient.from('students').update({
            contract_signed: false,
            contract_signed_at: null,
            contract_signer_name: null,
            contract_signer_email: null,
            last_contract_id: null
          }).eq('id', studentId);
        } catch (err) {
          console.error('Contract delete failed', err);
        }
      }
    }

    async function upsertInvoiceRemote(inv) {
      if (!isSupabaseReady()) return;
      const { error } = await supabaseClient.from('invoices').upsert({
        id: cleanId(inv.id),
        user_id: supabaseSession.user.id,
        student_id: cleanId(inv.studentId),
        issue_date: inv.issueDate,
        due_date: inv.dueDate,
        base_amount: inv.baseAmount,
        total: inv.total,
        late_fee_percent: inv.lateFeePercent,
        short_notice_percent: inv.shortNoticePercent,
        late_applied: inv.lateApplied,
        short_applied: inv.shortApplied,
        paid: inv.paid,
        notes: inv.notes
      });
      if (error) throw new Error('Supabase invoice upsert failed: ' + error.message);
    }

    async function deleteInvoiceRemote(id) {
      if (!isSupabaseReady()) return;
      const { error } = await supabaseClient.from('invoices').delete().eq('id', cleanId(id));
      if (error) throw new Error('Supabase invoice delete failed: ' + error.message);
    }

    function generateId(prefix) {
      return prefix + '_' + Math.random().toString(36).slice(2, 10);
    }

    /****************
     * INITIAL SETUP *
     ****************/
    // Catch errors to avoid Safari ‚Äúoutput‚Äù ReferenceErrors and noisy hCaptcha CSP iframe errors
    const suppressOutputError = (msg = '', src = '') => {
      const lowerMsg = String(msg).toLowerCase();
      const lowerSrc = String(src || '').toLowerCase();
      if (lowerMsg.includes('output')) return true;
      if (lowerMsg.includes('refused to execute a script') && lowerSrc.includes('hcaptcha')) return true;
      if (lowerMsg.includes('csp') && lowerSrc.includes('hcaptcha')) return true;
      return false;
    };
    window.addEventListener('error', (event) => {
      if (suppressOutputError(event.message, event.filename)) {
        event.preventDefault();
        return true;
      }
      return false;
    });
    window.onerror = (msg, src, line, col, err) => {
      if (suppressOutputError(msg, src)) return true;
      console.error('Global error', msg, err);
      return true;
    };
    // Catch any unhandled promise rejections so Safari doesn‚Äôt throw ‚Äúoutput‚Äù ReferenceErrors
    window.addEventListener('unhandledrejection', (event) => {
      const reason = String(event.reason?.message || event.reason || '');
      const lower = reason.toLowerCase();
      if (lower.includes('output')) {
        event.preventDefault();
        return true;
      }
      console.error('Unhandled promise rejection', event.reason);
      event.preventDefault();
      return true;
    });
    window.onunhandledrejection = (event) => {
      const reason = String(event.reason?.message || event.reason || '');
      const lower = reason.toLowerCase();
      if (lower.includes('output')) {
        if (event.preventDefault) event.preventDefault();
        return true;
      }
      console.error('Unhandled promise rejection (onunhandledrejection)', event.reason);
      if (event.preventDefault) event.preventDefault();
      return true;
    };

    document.addEventListener('DOMContentLoaded', async () => {
      await initSupabaseAuth();
      setupNav();
      setupTopbar();
      applySettingsToUI();
      if (!supabaseAvailable || supabaseSession) {
        await tryLoadRemoteThenLocal();
        await loadAccountEmails().catch(err => console.warn('Account email fetch failed', err));
        renderAllViews();
      }
      updateReadOnlyUI();

      // expose functions for inline onclick handlers
      window.openSessionModal = openSessionModal;
      window.getSessionById = getSessionById;
      window.openSessionQuickActions = openSessionQuickActions;
      window.openResourceModal = openResourceModal;
      window.getResourceById = getResourceById;
      window.openAssignResourceModal = openAssignResourceModal;
      window.updateHomeworkStatus = updateHomeworkStatus;
      window.openDocumentModal = openDocumentModal;
      window.getDocumentById = getDocumentById;
      window.openInvoiceModal = openInvoiceModal;
      window.getInvoiceById = getInvoiceById;
      window.markInvoicePaid = markInvoicePaid;
      window.generateReminder = generateReminder;
      window.selectStudent = selectStudent;
      window.toggleResourceFavorite = toggleResourceFavorite;
      window.toggleTodoStatus = toggleTodoStatus;
      window.deleteTodo = deleteTodo;
      window.openContractUpload = openContractUpload;
      window.markContractStatus = markContractStatus;
      setupRealtime();
    });

    function setupNav() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          switchView(view);
          document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-slate-800', 'active'));
          btn.classList.add('bg-slate-800', 'active');
        });
      });
      // default view
      const defaultView = studentMode ? 'portal' : parentMode ? 'parent-portal' : 'dashboard';
      switchView(defaultView);
      const activeBtn = document.querySelector(`.nav-btn[data-view="${defaultView}"]`);
      if (activeBtn) activeBtn.classList.add('bg-slate-800', 'active');
    }

    /***********************
     * REALTIME UPDATES
     ***********************/
    function setupRealtime() {
      if (!supabaseClient || !supabaseSession) return;
      const tables = ['students','sessions','homework','invoices','messages','resources','documents','contracts','student_todos','student_checkins','parent_contract_signatures','presence'];
      tables.forEach(table => {
        supabaseClient
          .channel(`${table}-changes`)
          .on('postgres_changes', { event: '*', schema: 'public', table }, async () => {
            try {
              if (table === 'presence') {
                await refreshPresence();
                renderStudentsView();
              } else {
                await tryLoadRemoteThenLocal();
                renderAllViews();
              }
            } catch (err) {
              console.error('Realtime refresh failed', err);
            }
          })
          .subscribe();
      });
    }

    function switchView(viewName) {
      document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
      // block switching if Supabase is configured but not signed in
      if (supabaseAvailable && !supabaseSession) {
        toggleAuthOverlay(true);
        return;
      }
      let targetView = viewName;
      if (studentMode && ['finance','reports','dashboard','parent-portal'].includes(targetView)) {
        targetView = 'portal';
      }
      if (parentMode) {
        const allowed = new Set(['parent-portal','students','schedule','resources','profile','settings']);
        if (!allowed.has(targetView)) targetView = 'parent-portal';
      }
      document.getElementById('view-' + targetView)?.classList.remove('hidden');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-slate-800', 'active'));
      const activeBtn = document.querySelector(`.nav-btn[data-view="${targetView}"]`);
      if (activeBtn) activeBtn.classList.add('bg-slate-800','active');
      if (targetView === 'dashboard') updateKPIsAndCharts();
      if (targetView === 'students') renderStudentsView();
      if (targetView === 'schedule') renderScheduleView();
      if (targetView === 'resources') renderResourcesView();
      if (targetView === 'finance') renderFinanceView();
      if (targetView === 'settings') applySettingsToUI();
      if (targetView === 'profile') renderProfileView();
      if (targetView === 'portal') renderStudentPortal();
      if (targetView === 'parent-portal') renderParentPortal();
      if (targetView === 'reports') renderReportsView();
    }

    function setupTopbar() {
      document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);
      document.getElementById('quickAddStudentBtn').addEventListener('click', () => { if (guardEdit()) openStudentModal(); });
      document.getElementById('quickAddSessionBtn').addEventListener('click', () => { if (guardEdit()) openSessionModal(); });
      document.getElementById('globalSearchInput').addEventListener('input', handleGlobalSearch);
      const signOutBtn = document.getElementById('signOutBtn');
      if (signOutBtn) {
        signOutBtn.onclick = async () => {
          if (supabaseClient) {
            await supabaseClient.auth.signOut();
          }
          supabaseSession = null;
          toggleAuthOverlay(true);
        };
      }

      // Settings bindings
      document.getElementById('settingsThemeSelect').addEventListener('change', e => {
        state.settings.theme = e.target.value;
        applyTheme();
        saveState();
      });
      document.getElementById('settingsDensitySelect').addEventListener('change', e => {
        state.settings.density = e.target.value;
        applyDensity();
        saveState();
      });
      document.getElementById('settingsWeeklyGoal').addEventListener('input', e => {
        state.settings.weeklyGoalHours = Number(e.target.value || 0);
        saveState();
      });
      document.getElementById('settingsMonthlyGoal').addEventListener('input', e => {
        state.settings.monthlyIncomeGoal = Number(e.target.value || 0);
        saveState();
      });
      document.getElementById('settingsReflection').addEventListener('input', e => {
        state.settings.reflection = e.target.value;
        saveState();
      });
      document.getElementById('settingsDefaultDuration').addEventListener('input', e => {
        state.settings.defaultSessionDuration = Number(e.target.value || 1);
        saveState();
      });
      const ns = document.getElementById('notifySessionsDays');
      const nh = document.getElementById('notifyHomeworkDays');
      const ni = document.getElementById('notifyInvoicesDays');
      if (ns) ns.addEventListener('input', e => { state.settings.notifySessionsDays = Number(e.target.value || 0); saveState(); });
      if (nh) nh.addEventListener('input', e => { state.settings.notifyHomeworkDays = Number(e.target.value || 0); saveState(); });
      if (ni) ni.addEventListener('input', e => { state.settings.notifyInvoicesDays = Number(e.target.value || 0); saveState(); });
      document.getElementById('exportDataBtn').addEventListener('click', () => {
        document.getElementById('backupTextarea').value = JSON.stringify(state, null, 2);
      });
      document.getElementById('importDataBtn').addEventListener('click', () => {
        const txt = document.getElementById('backupTextarea').value.trim();
        if (!txt) return alert('Paste JSON first.');
        try {
          const imported = JSON.parse(txt);
          state = Object.assign(deepClone(defaultState), imported);
          saveState();
          renderAllViews();
          applySettingsToUI();
          alert('Data imported.');
        } catch (e) {
          alert('Invalid JSON.');
        }
      });

      document.getElementById('addStudentBtn').addEventListener('click', () => { if (guardEdit()) openStudentModal(); });
      document.getElementById('addSessionBtn').addEventListener('click', () => { if (guardEdit()) openSessionModal(); });
      document.getElementById('addResourceBtn').addEventListener('click', () => { if (guardEdit()) openResourceModal(); });
      document.getElementById('addInvoiceBtn').addEventListener('click', () => { if (guardEdit()) openInvoiceModal(); });
      const addParentBtn = document.getElementById('addParentBtn');
      if (addParentBtn) addParentBtn.onclick = () => { if (guardEdit()) openParentModal(); };
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) {
        refreshBtn.onclick = async () => {
          if (supabaseAvailable) {
            await tryLoadRemoteThenLocal();
            renderAllViews();
          } else {
            state = loadState();
            renderAllViews();
          }
        };
      }
      const deleteBtn = document.getElementById('deleteAccountBtn');
      if (deleteBtn) deleteBtn.onclick = deleteAccountFlow;

      // Show portal nav only for student mode
      const navPortal = document.getElementById('navPortalBtn');
      if (navPortal) {
        navPortal.classList.toggle('hidden', !studentMode);
        if (studentMode) navPortal.classList.add('bg-slate-800', 'active');
      }
      const navParentPortal = document.getElementById('navParentPortalBtn');
      if (navParentPortal) {
        navParentPortal.classList.toggle('hidden', !parentMode);
        if (parentMode) navParentPortal.classList.add('bg-slate-800', 'active');
      }
      const navFinance = document.getElementById('navFinanceBtn');
      const navReports = document.getElementById('navReportsBtn');
      if (navFinance) navFinance.classList.toggle('hidden', studentMode || parentMode);
      if (navReports) navReports.classList.toggle('hidden', studentMode || parentMode);
      const navDashboard = document.querySelector('.nav-btn[data-view="dashboard"]');
      if (navDashboard) navDashboard.classList.toggle('hidden', studentMode || parentMode);

      const exportIcsBtn = document.getElementById('exportIcsBtn');
      if (exportIcsBtn) {
        exportIcsBtn.onclick = downloadIcsFile;
      }
    }

    function applySettingsToUI() {
      const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.value = val ?? '';
      };
      setVal('settingsThemeSelect', state.settings.theme);
      setVal('settingsDensitySelect', state.settings.density);
      setVal('settingsWeeklyGoal', state.settings.weeklyGoalHours);
      setVal('settingsMonthlyGoal', state.settings.monthlyIncomeGoal);
      setVal('settingsReflection', state.settings.reflection || '');
      setVal('settingsDefaultDuration', state.settings.defaultSessionDuration ?? 1.5);
      setVal('notifySessionsDays', state.settings.notifySessionsDays ?? 3);
      setVal('notifyHomeworkDays', state.settings.notifyHomeworkDays ?? 3);
      setVal('notifyInvoicesDays', state.settings.notifyInvoicesDays ?? 3);
      // lock settings for students
      const lockIds = [
        'settingsWeeklyGoal','settingsMonthlyGoal','settingsDefaultDuration',
        'settingsReflection','notifySessionsDays','notifyHomeworkDays','notifyInvoicesDays'
      ];
      lockIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = studentMode;
      });
      applyTheme();
      applyDensity();
    }

    function renderActivityLog() {
      const list = document.getElementById('activityLogList');
      if (!list) return;
      const items = [...(state.activityLog || [])].sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      if (!items.length) {
        list.innerHTML = '<li class="text-slate-500 text-xs">No activity recorded yet.</li>';
        return;
      }
      list.innerHTML = items.slice(0, 25).map(a => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
          <div>
            <div class="font-medium">${a.action}</div>
            <div class="text-[10px] text-slate-500">${a.detail || ''}</div>
          </div>
          <div class="text-[10px] text-slate-500">${a.created_at ? new Date(a.created_at).toLocaleString() : ''}</div>
        </li>
      `).join('');
    }

    function logActivity(action, detail) {
      const entry = {
        id: generateId('act'),
        action,
        detail,
        created_at: new Date().toISOString()
      };
      state.activityLog.push(entry);
      // keep last 200
      if (state.activityLog.length > 200) {
        state.activityLog = state.activityLog.slice(-200);
      }
      saveState();
      renderActivityLog();
    }

    /***********************
     * PROFILE
     ***********************/
    function renderProfileView() {
      const user = supabaseSession?.user;
      const emailEl = document.getElementById('profileEmail');
      const createdEl = document.getElementById('profileCreated');
      const lastEl = document.getElementById('profileLastSignIn');
      const badge = document.getElementById('profileEmailVerified');
      const roleEl = document.getElementById('profileRole');
      const uidEl = document.getElementById('profileUid');
      const sessMeta = document.getElementById('profileSessionMeta');
      if (!user) {
        if (emailEl) emailEl.textContent = 'Not signed in';
        if (createdEl) createdEl.textContent = '‚Äî';
        if (lastEl) lastEl.textContent = '‚Äî';
        if (badge) {
          badge.textContent = 'Not signed in';
          badge.className = 'text-[10px] px-2 py-0.5 rounded-full bg-amber-100 text-amber-700';
        }
        if (roleEl) roleEl.textContent = '‚Äî';
        if (uidEl) uidEl.textContent = '‚Äî';
        if (sessMeta) sessMeta.textContent = '';
        return;
      }
      if (emailEl) emailEl.textContent = user.email || '‚Äî';
      const metadata = user.user_metadata || {};
      const created = user.created_at ? new Date(user.created_at).toLocaleString() : '‚Äî';
      const lastSignIn = user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleString() : '‚Äî';
      if (createdEl) createdEl.textContent = created;
      if (lastEl) lastEl.textContent = lastSignIn;
      if (roleEl) {
        if (isOwner()) roleEl.textContent = 'Owner';
        else if (parentMode) roleEl.textContent = 'Parent';
        else roleEl.textContent = 'Student';
      }
      if (uidEl) uidEl.textContent = user.id || '‚Äî';
      if (sessMeta && supabaseSession?.expires_at) {
        const exp = new Date(supabaseSession.expires_at * 1000).toLocaleString();
        sessMeta.textContent = `Session expires: ${exp}`;
      }
      const verified = metadata.email_verified || user.email_confirmed_at;
      if (badge) {
        if (verified) {
          badge.textContent = 'Verified';
          badge.className = 'text-[10px] px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700';
        } else {
          badge.textContent = 'Unverified';
          badge.className = 'text-[10px] px-2 py-0.5 rounded-full bg-amber-100 text-amber-700';
        }
      }
    }

    function renderStudentPortal() {
      const email = getSessionEmail();
      const student = state.students.find(s => s.studentEmail === email);
      const sessionsUl = document.getElementById('portalSessions');
      const hwUl = document.getElementById('portalHomework');
      const invUl = document.getElementById('portalInvoices');
      const resUl = document.getElementById('portalResources');
      const portalBlocker = document.getElementById('portalBlocker');
      if (!student) {
        const msg = '<li class="text-slate-500 text-xs">No student profile linked to this account.</li>';
        if (sessionsUl) sessionsUl.innerHTML = msg;
        if (hwUl) hwUl.innerHTML = msg;
        if (invUl) invUl.innerHTML = msg;
        if (resUl) resUl.innerHTML = msg;
        return;
      }
      // If contract not signed, show blocker and limit content
      const signed = !!student.contractSigned;
      if (portalBlocker) {
        portalBlocker.classList.toggle('hidden', signed);
      }
      if (!signed) {
        const msg = '<li class="text-slate-500 text-xs">Contract not signed yet.</li>';
        if (sessionsUl) sessionsUl.innerHTML = msg;
        if (hwUl) hwUl.innerHTML = msg;
        if (invUl) invUl.innerHTML = msg;
        if (resUl) resUl.innerHTML = msg;
        const msgsList = document.getElementById('portalMessages');
        if (msgsList) msgsList.innerHTML = msg;
        return;
      }
      const now = new Date();
      const soon = new Date(now.getTime() + 14*24*60*60*1000);
      const mySessions = state.sessions.filter(s => s.studentIds.includes(student.id))
        .filter(s => {
          const d = new Date(s.date + 'T' + (s.startTime || '00:00'));
          return d >= now && d <= soon;
        })
        .sort((a,b) => new Date(a.date) - new Date(b.date));
      if (sessionsUl) {
        sessionsUl.innerHTML = mySessions.length ? mySessions.map(s => `
          <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${s.subject} ‚Ä¢ ${s.topic || 'Lesson'}</div>
            <div class="text-[10px] text-slate-500">${s.date} ${s.startTime || ''} ‚Ä¢ ${s.durationHours || 1}h</div>
          </li>
        `).join('') : '<li class="text-slate-500 text-xs">No sessions in the next 14 days.</li>';
      }

      const myHw = state.homework.filter(hw => hw.studentId === student.id && hw.status !== 'Completed');
      if (hwUl) {
        hwUl.innerHTML = myHw.length ? myHw.map(hw => {
          const res = getResourceById(hw.resourceId);
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${res?.title || 'Homework'}</div>
            <div class="text-[10px] text-slate-500">Status: ${hw.status} ‚Ä¢ Due ${hw.dueDate || 'n/a'}</div>
          </li>`;
        }).join('') : '<li class="text-slate-500 text-xs">No open homework.</li>';
      }

      const myInv = state.invoices.filter(inv => inv.studentId === student.id)
        .sort((a,b) => new Date(a.dueDate||0) - new Date(b.dueDate||0));
      if (invUl) {
        invUl.innerHTML = myInv.length ? myInv.map(inv => `
          <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">Invoice ${inv.id}</div>
            <div class="text-[10px] text-slate-500">Issued ${inv.issueDate || 'n/a'} ‚Ä¢ Due ${inv.dueDate || 'n/a'} ‚Ä¢ R ${Number(inv.total||0).toFixed(2)} ‚Ä¢ ${inv.paid ? 'Paid' : 'Unpaid'}</div>
          </li>
        `).join('') : '<li class="text-slate-500 text-xs">No invoices yet.</li>';
      }

      // Resources assigned via homework
      const resourceIds = new Set(myHw.map(hw => hw.resourceId));
      const myRes = state.resources.filter(r => resourceIds.has(r.id));
      if (resUl) {
        resUl.innerHTML = myRes.length ? myRes.map(r => `
          <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${r.title}</div>
            <div class="text-[10px] text-slate-500">${r.subject} ‚Ä¢ ${r.level || ''}</div>
            ${r.signedUrl ? `<a class="text-[10px] text-indigo-600" href="${r.signedUrl}" target="_blank">Download</a>` : ''}
          </li>
        `).join('') : '<li class="text-slate-500 text-xs">No resources assigned.</li>';
      }

      // Messages in portal
      const msgsList = document.getElementById('portalMessages');
      if (msgsList) {
        const msgs = state.messages
          .filter(m => m.studentId === student.id)
          .sort((a,b) => new Date(a.created_at||0) - new Date(b.created_at||0));
        msgsList.innerHTML = msgs.length ? msgs.map(m => `
          <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="flex justify-between text-[10px] text-slate-500">
              <span>${m.sender === 'owner' ? 'Tutor' : 'You'}</span>
              <span>${m.created_at ? new Date(m.created_at).toLocaleString() : ''}</span>
            </div>
            <div>${m.text}</div>
          </li>
        `).join('') : '<li class="text-slate-500 text-xs">No messages yet.</li>';
      }
    }

    function getChildrenForParent() {
      const parent = getParentProfileBySession();
      if (!parent) return [];
      const links = state.parentLinks.filter(pl => pl.parentId === parent.id);
      return links.map(pl => state.students.find(s => s.id === pl.studentId)).filter(Boolean);
    }

    function renderParentPortal() {
      const parent = getParentProfileBySession();
      const students = getChildrenForParent();
      const sList = document.getElementById('parentStudentsList');
      if (sList) {
        sList.innerHTML = students.length ? students.map(s => {
          const sig = getLatestSignature(s.id);
          const signed = !!s.contractSigned;
          const contractLabel = signed ? 'VALID ‚Äì CONTRACT SIGNED' : 'INVALID ‚Äì CONTRACT NOT SIGNED';
          const contractClass = signed ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700';
          return `
            <li class="border border-slate-200 rounded-lg px-3 py-2 bg-white/80 space-y-1" data-student-id="${s.id}">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-medium">${s.name}</div>
                  <div class="text-[10px] text-slate-500">${s.gradeLevel || ''}</div>
                </div>
                <span class="text-[10px] px-2 py-0.5 rounded-full ${contractClass}">${contractLabel}</span>
              </div>
              <div class="text-[10px] text-slate-500">${s.subjects?.join(', ') || 'Subjects not set'}</div>
              <div class="text-[10px] text-slate-500">Email: ${s.studentEmail || '‚Äî'}</div>
              <div class="text-[10px] text-slate-500">${sig ? `Signed by ${sig.parentName || 'Parent'} on ${sig.signedAt ? new Date(sig.signedAt).toLocaleDateString() : ''}` : 'No signed contract yet.'}</div>
              <div class="flex items-center gap-2 text-[10px]">
                <button class="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50" onclick="copyContractLink('${s.id}')">Copy contract link</button>
              </div>
            </li>
          `;
        }).join('') : '<li class="text-slate-500 text-xs">No linked students.</li>';
      }
      const sessionsUl = document.getElementById('parentSessions');
      const hwUl = document.getElementById('parentHomework');
      const resUl = document.getElementById('parentResources');
      const invUl = document.getElementById('parentInvoices');
      const msgsUl = document.getElementById('parentMessages');
      // allow parent to click into student profile
      const studentsList = document.getElementById('parentStudentsList');
      if (studentsList) {
        studentsList.querySelectorAll('[data-student-id]').forEach(li => {
          li.addEventListener('click', () => selectStudent(li.dataset.studentId));
        });
      }
      const childIds = new Set(students.map(s => s.id));

      const now = new Date();
      const soon = new Date(now.getTime() + 14*24*60*60*1000);
      const mySessions = state.sessions.filter(s => s.studentIds.some(id => childIds.has(id)))
        .filter(s => {
          const d = new Date(s.date + 'T' + (s.startTime || '00:00'));
          return d >= now && d <= soon;
        })
        .sort((a,b) => new Date(a.date) - new Date(b.date));
      if (sessionsUl) {
        sessionsUl.innerHTML = mySessions.length ? mySessions.map(s => {
          const names = s.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${s.subject} ‚Ä¢ ${s.topic || 'Lesson'}</div>
            <div class="text-[10px] text-slate-500">${s.date} ${s.startTime || ''} ‚Ä¢ ${s.durationHours || 1}h ‚Ä¢ ${names}</div>
          </li>`;
        }).join('') : '<li class="text-slate-500 text-xs">No sessions in the next 14 days.</li>';
      }

      const myHw = state.homework.filter(hw => childIds.has(hw.studentId));
      if (hwUl) {
        hwUl.innerHTML = myHw.length ? myHw.map(hw => {
          const res = getResourceById(hw.resourceId);
          const stu = getStudentById(hw.studentId);
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${res?.title || 'Homework'}</div>
            <div class="text-[10px] text-slate-500">${stu?.name || ''} ‚Ä¢ Status: ${hw.status} ‚Ä¢ Due ${hw.dueDate || 'n/a'}</div>
          </li>`;
        }).join('') : '<li class="text-slate-500 text-xs">No homework posted.</li>';
      }

      const myResIds = new Set(myHw.map(hw => hw.resourceId));
      const myRes = state.resources.filter(r => myResIds.has(r.id));
      if (resUl) {
        resUl.innerHTML = myRes.length ? myRes.map(r => `
          <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${r.title}</div>
            <div class="text-[10px] text-slate-500">${r.subject} ‚Ä¢ ${r.level || ''}</div>
            ${r.signedUrl ? `<a class="text-[10px] text-indigo-600" href="${r.signedUrl}" target="_blank">Download</a>` : ''}
          </li>
        `).join('') : '<li class="text-slate-500 text-xs">No resources yet.</li>';
      }

      const myInv = state.invoices.filter(inv => childIds.has(inv.studentId))
        .sort((a,b) => new Date(a.dueDate||0) - new Date(b.dueDate||0));
      if (invUl) {
        invUl.innerHTML = myInv.length ? myInv.map(inv => {
          const s = getStudentById(inv.studentId);
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">Invoice ${inv.id}</div>
            <div class="text-[10px] text-slate-500">${s?.name || ''} ‚Ä¢ Issued ${inv.issueDate || 'n/a'} ‚Ä¢ Due ${inv.dueDate || 'n/a'} ‚Ä¢ R ${Number(inv.total||0).toFixed(2)} ‚Ä¢ ${inv.paid ? 'Paid' : 'Unpaid'}</div>
          </li>`;
        }).join('') : '<li class="text-slate-500 text-xs">No invoices yet.</li>';
      }

      if (msgsUl) {
        const msgs = state.messages
          .filter(m => childIds.has(m.studentId))
          .sort((a,b) => new Date(a.created_at||0) - new Date(b.created_at||0));
        msgsUl.innerHTML = msgs.length ? msgs.map(m => {
          const s = getStudentById(m.studentId);
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="flex justify-between text-[10px] text-slate-500">
              <span>${s?.name || 'Student'}</span>
              <span>${m.created_at ? new Date(m.created_at).toLocaleString() : ''}</span>
            </div>
            <div>${m.text}</div>
          </li>`;
        }).join('') : '<li class="text-slate-500 text-xs">No messages yet.</li>';
      }
    }

    function getAvailableStudentEmails(currentEmail = '') {
      const assigned = new Set(
        state.students
          .filter(s => s.studentEmail && s.studentEmail !== currentEmail)
          .map(s => s.studentEmail)
      );
      const options = (accountEmails || []).filter(e => !assigned.has(e));
      if (currentEmail && !options.includes(currentEmail)) options.push(currentEmail);
      return options.sort();
    }

    function getAvailableParentEmails(currentEmail = '') {
      const assigned = new Set(
        state.parents
          .filter(p => p.email && p.email !== currentEmail)
          .map(p => p.email)
      );
      const options = (accountEmails || []).filter(e => !assigned.has(e));
      if (currentEmail && !options.includes(currentEmail)) options.push(currentEmail);
      return options.sort();
    }

    async function deleteStudentAndDependencies(studentId) {
      // Local cleanup
      state.students = state.students.filter(s => s.id !== studentId);
      state.documents = state.documents.filter(d => d.studentId !== studentId);
      state.contracts = state.contracts.filter(c => c.studentId !== studentId);
      state.invoices = state.invoices.filter(i => i.studentId !== studentId);
      state.homework = state.homework.filter(h => h.studentId !== studentId);
      state.studentTodos = state.studentTodos.filter(t => t.studentId !== studentId);
      state.studentCheckins = state.studentCheckins.filter(c => c.studentId !== studentId);
      state.parentLinks = state.parentLinks.filter(pl => pl.studentId !== studentId);
      // sessions: remove student from studentIds; drop sessions with no students left
      const sessionsToRemove = [];
      state.sessions.forEach(sess => {
        sess.studentIds = (sess.studentIds || []).filter(id => id !== studentId);
        if (!sess.studentIds.length) sessionsToRemove.push(sess.id);
      });
      if (sessionsToRemove.length) {
        state.sessions = state.sessions.filter(s => !sessionsToRemove.includes(s.id));
      }
      saveState();

      // Remote cleanup if signed in
      if (isSupabaseReady()) {
        // Remove join rows
        await supabaseClient.from('session_students').delete().eq('student_id', studentId);
        // Delete dependents
        const tables = [
          'documents','contracts','invoices','homework',
          'student_todos','student_checkins','session_students'
        ];
        for (const t of tables) {
          await supabaseClient.from(t).delete().eq('student_id', studentId);
        }
        try {
          await supabaseClient.from('parent_students').delete().eq('student_id', studentId);
        } catch (err) {
          console.warn('Remote parent_students delete failed', err);
        }
        if (sessionsToRemove.length) {
          await supabaseClient.from('sessions').delete().in('id', sessionsToRemove);
        }
        // Finally delete student
        await supabaseClient.from('students').delete().eq('id', studentId);
      }
    }

    async function deleteAccountFlow() {
      const statusEl = document.getElementById('deleteAccountStatus');
      const confirm1 = confirm('Delete your account and all associated data? This cannot be undone.');
      if (!confirm1) return;
      const confirm2 = confirm('Are you absolutely sure? This will remove all your tutoring data.');
      if (!confirm2) return;
      if (!isSupabaseReady()) {
        alert('Sign in first.');
        return;
      }
      const uid = supabaseSession.user.id;
      try {
        if (statusEl) statusEl.textContent = 'Deleting your data & account...';
        const { data, error } = await supabaseClient.functions.invoke('delete-account', {
          headers: { Authorization: `Bearer ${supabaseSession.access_token}` }
        });
        if (error || !data?.success) {
          throw error || new Error(data?.error || 'Deletion failed (backend).');
        }
        // Clear local state and sign out
        localStorage.removeItem(STORAGE_KEY);
        state = deepClone(defaultState);
        await supabaseClient.auth.signOut();
        alert('Your account has been deleted.');
        window.location.reload();
      } catch (err) {
        console.error(err);
        const msg = err?.message || 'Delete failed. Please try again.';
        if (statusEl) statusEl.textContent = msg;
        alert(msg);
      }
    }

    /***********************
     * SUPABASE AUTH
     ***********************/
    function loadHCaptcha() {
      if (!HCAPTCHA_ENABLED || !HCAPTCHA_SITEKEY || HCAPTCHA_SITEKEY.includes('YOUR_HCAPTCHA')) return;
      const existing = document.querySelector('script[src*="js.hcaptcha.com/1/api.js"]');
      if (existing) {
        if (window.hcaptcha) {
          hcaptchaOnLoad();
        } else {
          existing.addEventListener('load', hcaptchaOnLoad, { once: true });
        }
        return;
      }
      const script = document.createElement('script');
      script.src = 'https://js.hcaptcha.com/1/api.js?onload=hcaptchaOnLoad&render=explicit';
      script.async = true;
      script.onload = hcaptchaOnLoad;
      document.head.appendChild(script);
    }

    function hcaptchaOnLoad() {
      if (!HCAPTCHA_ENABLED || !window.hcaptcha) return;
      if (hcaptchaWidgetId !== null) return; // already rendered
      const container = document.getElementById('hcaptchaContainer');
      if (!container) return;
      hcaptchaWidgetId = hcaptcha.render(container, {
        sitekey: HCAPTCHA_SITEKEY,
        callback: 'onHCaptchaSuccess',
        'expired-callback': 'onHCaptchaExpired'
      });
    }

    function onHCaptchaSuccess(token) {
      hcaptchaToken = token;
    }

    function onHCaptchaExpired() {
      hcaptchaToken = '';
      if (window.hcaptcha && hcaptchaWidgetId != null) {
        hcaptcha.reset(hcaptchaWidgetId);
      }
    }

    async function ensureHCaptcha() {
      if (!HCAPTCHA_ENABLED) return undefined;
      if (!HCAPTCHA_SITEKEY || HCAPTCHA_SITEKEY.includes('YOUR_HCAPTCHA')) {
        throw new Error('hCaptcha site key missing.');
      }
      if (!window.hcaptcha) {
        throw new Error('hCaptcha did not load. Please allow scripts for js.hcaptcha.com and retry.');
      }
      if (!hcaptchaToken) {
        throw new Error('Please complete hCaptcha.');
      }
      const token = hcaptchaToken;
      // reset after consuming to avoid re-use / expiry errors
      if (window.hcaptcha && hcaptchaWidgetId != null) {
        hcaptcha.reset(hcaptchaWidgetId);
      }
      hcaptchaToken = '';
      return token;
    }

    async function initSupabaseAuth() {
      if (!supabaseAvailable) {
        toggleAuthOverlay(false);
        return;
      }
    if (HCAPTCHA_ENABLED) {
      loadHCaptcha();
    }
    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const { data: sessionData } = await supabaseClient.auth.getSession();
      supabaseSession = sessionData.session;
      toggleAuthOverlay(!supabaseSession);
      if (supabaseSession) {
        document.getElementById('signOutBtn')?.classList.remove('hidden');
        startPresence();
      }
      updateReadOnlyUI();
      supabaseClient.auth.onAuthStateChange((event, session) => {
        supabaseSession = session;
        toggleAuthOverlay(!session);
        if (session) {
          document.getElementById('signOutBtn')?.classList.remove('hidden');
          loadAccountEmails().catch(err => console.warn('Account email fetch failed', err));
          tryLoadRemoteThenLocal().then(() => {
            renderAllViews();
            setupRealtime();
            startPresence();
          });
        } else {
          document.getElementById('signOutBtn')?.classList.add('hidden');
          state = deepClone(defaultState);
          accountEmails = [];
          privacyRead = false;
          tosRead = false;
          stopPresence();
        }
        updateReadOnlyUI();
      });

      const authForm = document.getElementById('authForm');
      const authMsg = document.getElementById('authMessage');
      const readPrivacyBtn = document.getElementById('readPrivacyBtn');
      const readTosBtn = document.getElementById('readTosBtn');
      if (readPrivacyBtn) readPrivacyBtn.onclick = () => openPolicyModal('privacy');
      if (readTosBtn) readTosBtn.onclick = () => openPolicyModal('tos');
      if (authForm) {
        authForm.onsubmit = async (e) => {
          e.preventDefault();
          const action = e.submitter?.dataset?.action || 'signin';
          const email = authForm.email.value.trim();
          const password = authForm.password.value.trim();
          authMsg.textContent = '';
          try {
            if (action === 'signup' && !authForm.consent.checked) {
              throw new Error('Please provide consent to receive account emails.');
            }
            if (action === 'signup' && (!privacyRead || !tosRead)) {
              throw new Error('Please read and acknowledge the Privacy Policy and Terms of Service before signing up.');
            }
            const captchaToken = await ensureHCaptcha();
            if (action === 'signup') {
              const { error } = await supabaseClient.auth.signUp({
                email,
                password,
                options: {
                  ...(HCAPTCHA_ENABLED ? { captchaToken } : {}),
                  emailRedirectTo: new URL('./confirmation.html', window.location.href).href
                }
              });
              if (error) throw error;
              authMsg.textContent = 'Check your email to confirm, then sign in.';
            } else {
              const { error } = await supabaseClient.auth.signInWithPassword({
                email,
                password,
                options: HCAPTCHA_ENABLED ? { captchaToken } : {}
              });
              if (error) throw error;
            }
          } catch (err) {
            const msg = err?.message || 'Auth error';
            if (msg.toLowerCase().includes('captcha')) {
              authMsg.textContent = 'Captcha verification failed. If Supabase captcha is enabled, set HCAPTCHA_ENABLED=true and allow the widget to load, or disable captcha in Supabase Auth settings.';
            } else {
              authMsg.textContent = msg;
            }
          }
        };
      }
    }

    function toggleAuthOverlay(show) {
      const overlay = document.getElementById('authOverlay');
      if (!overlay) return;
      const mustShow = supabaseAvailable ? show : show;
      overlay.classList.toggle('show', !!mustShow);
      if (mustShow) {
        document.body.classList.add('overflow-hidden');
      } else {
        document.body.classList.remove('overflow-hidden');
      }
    }

    function getSessionEmail() {
      return (supabaseSession?.user?.email || '').trim().toLowerCase();
    }

    function getParentProfileBySession() {
      const email = getSessionEmail();
      return state.parents.find(p => p.email === email);
    }

    function isOwner() {
      if (!supabaseAvailable) return true;
      return !!(supabaseSession && getSessionEmail() === OWNER_EMAIL.toLowerCase());
    }

    function updateReadOnlyUI() {
      if (supabaseAvailable && !supabaseSession) {
        // Session not resolved yet; keep UI as-is
        return;
      }
      const parentProfile = supabaseAvailable ? getParentProfileBySession() : null;
      studentMode = supabaseAvailable ? (!isOwner() && !!getSessionEmail() && !parentProfile) : false;
      parentMode = supabaseAvailable ? (!isOwner() && !!parentProfile) : false;
      readOnlyMode = studentMode || parentMode || (supabaseAvailable ? !isOwner() : false);
      const banner = document.getElementById('readOnlyBanner');
      if (banner) {
        if (studentMode) banner.textContent = 'Student view: read-only access to your profile.';
        else if (parentMode) banner.textContent = 'Parent view: read-only access to your child/children.';
        else banner.textContent = 'Read-only mode: sign in as the owner to edit.';
        banner.classList.toggle('hidden', !readOnlyMode);
      }
      const main = document.querySelector('main#viewsContainer');
      if (main) main.classList.toggle('opacity-70', readOnlyMode);
      document.querySelectorAll('[data-owner-only]').forEach(el => {
        if (el.tagName === 'BUTTON' || el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.disabled = readOnlyMode;
        }
        el.classList.toggle('owner-locked', readOnlyMode);
      });
      const navFinance = document.getElementById('navFinanceBtn');
      const navReports = document.getElementById('navReportsBtn');
      const navDashboard = document.querySelector('.nav-btn[data-view="dashboard"]');
      const navStudents = document.querySelector('.nav-btn[data-view="students"]');
      const navSchedule = document.querySelector('.nav-btn[data-view="schedule"]');
      const navResources = document.querySelector('.nav-btn[data-view="resources"]');
      if (navFinance) navFinance.classList.toggle('hidden', studentMode || parentMode);
      if (navReports) navReports.classList.toggle('hidden', studentMode || parentMode);
      if (navDashboard) navDashboard.classList.toggle('hidden', studentMode || parentMode);
      if (navStudents) navStudents.classList.toggle('hidden', studentMode); // show for owner & parent
      if (navSchedule) navSchedule.classList.toggle('hidden', studentMode); // show for owner & parent
      if (navResources) navResources.classList.toggle('hidden', studentMode); // show for owner & parent
      if (studentMode) switchView('portal');
      if (parentMode) switchView('parent-portal');
    }

    function guardEdit() {
      if (readOnlyMode || studentMode) {
        alert('Read-only mode: sign in as the owner to edit.');
        return false;
      }
      return true;
    }

    async function tryLoadRemoteThenLocal() {
      if (supabaseAvailable && !supabaseSession) {
        // hold current/local state until session resolved
        state = loadState();
        return;
      }
      if (isSupabaseReady()) {
        try {
          state = await loadStateFromSupabase();
          if (!readOnlyMode) saveState(); // persist locally as cache
          if (isSupabaseReady()) {
            await refreshPresence().catch(() => {});
          }
          updateReadOnlyUI();
          return;
        } catch (e) {
          console.error('Failed to load from Supabase, falling back to local', e);
          state = loadState(); // keep local data instead of wiping to defaults
          updateReadOnlyUI();
          return;
        }
      }
      state = loadState();
      updateReadOnlyUI();
    }

    async function loadStateFromSupabase() {
      const uid = supabaseSession?.user?.id;
      const email = getSessionEmail();
      if (!uid) return supabaseAvailable ? deepClone(defaultState) : loadState();
      const isOwnerUser = isOwner();

      // Owner: load everything (existing behaviour)
      if (isOwnerUser) {
        const fetchTable = (table, cols = '*') => supabaseClient.from(table).select(cols);
        const [
          studentsRes,
          parentsRes,
          parentLinksRes,
          sessionsRes,
          sessionStudentsRes,
          resourcesRes,
          homeworkRes,
          documentsRes,
          contractsRes,
          invoicesRes,
          todosRes,
          checkinsRes,
          activityRes,
          messagesRes,
          contractSignaturesRes
        ] = await Promise.all([
          fetchTable('students'),
          fetchTable('parents'),
          fetchTable('parent_students'),
          fetchTable('sessions'),
          fetchTable('session_students'),
          fetchTable('resources'),
          fetchTable('homework'),
          fetchTable('documents'),
          fetchTable('contracts'),
          fetchTable('invoices'),
          fetchTable('student_todos'),
          fetchTable('student_checkins'),
          fetchTable('activity_log'),
          fetchTable('messages'),
          fetchTable('parent_contract_signatures')
        ]);

        [studentsRes, parentsRes, parentLinksRes, sessionsRes, sessionStudentsRes, resourcesRes, homeworkRes, documentsRes, contractsRes, invoicesRes, todosRes, checkinsRes, activityRes, messagesRes, contractSignaturesRes].forEach(res => {
          if (res.error) throw res.error;
        });

        const sessions = (sessionsRes.data || []).map(sess => {
          const studentIds = (sessionStudentsRes.data || [])
            .filter(ss => ss.session_id === sess.id)
            .map(ss => cleanId(ss.student_id))
            .filter(Boolean);
          return {
            id: sess.id,
            date: sess.date,
            startTime: sess.start_time,
            durationHours: sess.duration_hours,
            subject: sess.subject,
            topic: sess.topic,
            notes: sess.notes,
            completed: sess.completed,
            invoiceId: sess.invoice_id,
            studentIds
          };
        });
        const sessionsWithStudents = sessions.filter(s => (s.studentIds || []).length > 0);

        // Fetch signed URLs for contracts if storage_path exists (ignore missing/forbidden)
        const getSignedUrlWithFallback = async (pathRaw) => {
          const tryBuckets = ['signed_contracts', 'contracts'];
          for (const bucket of tryBuckets) {
            const path = stripBucketPrefix(pathRaw, bucket);
            if (!path || !supabaseClient.storage) continue;
            const { data, error } = await supabaseClient.storage.from(bucket).createSignedUrl(path, 60 * 60 * 24);
            if (!error && data?.signedUrl) return data.signedUrl;
          }
          return '';
        };

        const contracts = await Promise.all(
          (contractsRes.data || []).map(async c => {
            let signedUrl = '';
            try {
              if (c.storage_path) {
                signedUrl = await getSignedUrlWithFallback(c.storage_path);
              }
            } catch (err) {
              console.warn('Contract signed URL fetch failed', err);
            }
            return {
              id: c.id,
              studentId: c.student_id,
              fileName: c.file_name,
              storage_path: c.storage_path,
              status: c.status,
              notes: c.notes,
              uploadedAt: c.uploaded_at,
              signedUrl
            };
          })
        );

        const merged = deepClone(defaultState);
        merged.students = (studentsRes.data || []).map(s => ({
          id: s.id,
          name: s.name,
          gradeLevel: s.grade_level ?? s.gradeLevel,
          rate: s.rate,
          subjects: s.subjects,
          notes: s.notes,
          studentEmail: s.student_email || '',
          createdAt: s.created_at,
          contractSigned: s.contract_signed,
          contractSignedAt: s.contract_signed_at,
          contractVersion: s.contract_version || 'v1',
          contractSignerName: s.contract_signer_name,
          contractSignerEmail: s.contract_signer_email,
          lastContractId: s.last_contract_id
        }));
        merged.parents = (parentsRes?.data || []).map(p => ({
          id: p.id,
          email: (p.email || '').toLowerCase(),
          name: p.name,
          phone: p.phone,
          notes: p.notes,
          verified: p.verified
        }));
        merged.parentLinks = (parentLinksRes?.data || []).map(pl => ({
          id: pl.id,
          parentId: pl.parent_id,
          studentId: pl.student_id,
          relationship: pl.relationship
        }));
        merged.sessions = sessionsWithStudents;
        const resources = await Promise.all(
          (resourcesRes.data || []).map(async r => {
            let signedUrl = '';
            try {
              if (r.storage_path && supabaseClient.storage) {
                const { data, error } = await supabaseClient.storage.from('resources').createSignedUrl(r.storage_path, 60 * 60 * 24);
                if (!error && data?.signedUrl) signedUrl = data.signedUrl;
              }
            } catch (err) {
              console.warn('Resource signed URL fetch failed', err);
            }
            return {
              id: r.id,
              title: r.title,
              subject: r.subject,
              level: r.level,
              tags: r.tags,
              description: r.description,
              createdAt: r.created_at,
              favorite: r.favorite,
              storage_path: r.storage_path,
              fileName: r.file_name,
              signedUrl
            };
          })
        );
        merged.resources = resources;
        merged.homework = (homeworkRes.data || []).map(h => ({
          id: h.id,
          studentId: h.student_id,
          resourceId: h.resource_id,
          status: h.status,
          dueDate: h.due_date,
          assignedDate: h.assigned_date
        }));
        merged.documents = (documentsRes.data || []).map(d => ({
          id: d.id,
          studentId: d.student_id,
          title: d.title,
          status: d.status,
          date: d.date,
          notes: d.notes,
          createdAt: d.created_at
        }));
        merged.contracts = contracts;
        merged.invoices = (invoicesRes.data || []).map(inv => ({
          id: inv.id,
          studentId: inv.student_id,
          issueDate: inv.issue_date,
          dueDate: inv.due_date,
          baseAmount: inv.base_amount,
          total: inv.total,
          lateFeePercent: inv.late_fee_percent,
          shortNoticePercent: inv.short_notice_percent,
          lateApplied: inv.late_applied,
          shortApplied: inv.short_applied,
          paid: inv.paid,
          notes: inv.notes
        }));
        merged.studentTodos = (todosRes.data || []).map(t => ({
          id: t.id,
          studentId: t.student_id,
          text: t.text,
          dueDate: t.due_date,
          done: t.done,
          createdAt: t.created_at
        }));
        merged.studentCheckins = (checkinsRes.data || []).map(c => ({
          id: c.id,
          studentId: c.student_id,
          text: c.text,
          date: c.date,
          createdAt: c.created_at
        }));
        merged.messages = (messagesRes?.data || []).map(m => ({
          id: m.id,
          studentId: m.student_id,
          text: m.text,
          sender: m.sender,
          created_at: m.created_at
        }));
      merged.activityLog = (activityRes?.data || []).map(a => ({
        id: a.id,
        action: a.action,
        detail: a.detail,
        created_at: a.created_at
      }));
        merged.settings = loadState().settings; // keep local settings

      // Merge in any local resources not yet in Supabase so they don't disappear on reload/switch
      const localState = loadState();
      if (localState?.resources?.length) {
        const remoteIds = new Set(merged.resources.map(r => cleanId(r.id)));
        localState.resources.forEach(r => {
          const id = cleanId(r.id);
          if (!remoteIds.has(id)) {
            merged.resources.push({
              id,
              title: r.title,
              subject: r.subject,
              level: r.level,
              tags: r.tags,
              description: r.description,
              createdAt: r.createdAt,
              favorite: r.favorite,
              storage_path: r.storage_path,
              fileName: r.fileName,
              signedUrl: r.signedUrl,
              dataUrl: r.dataUrl
            });
          }
        });
      }
      // Merge local homework if missing remotely (e.g., if an upsert failed due to RLS)
      if (localState?.homework?.length) {
        const remoteIds = new Set(merged.homework.map(h => cleanId(h.id)));
        localState.homework.forEach(hw => {
          const id = cleanId(hw.id);
          if (!remoteIds.has(id)) merged.homework.push(hw);
        });
      }
      // Merge local invoices/messages if rows are missing (e.g., legacy rows without user_id)
      if (localState?.invoices?.length) {
        const remoteIds = new Set(merged.invoices.map(i => cleanId(i.id)));
        localState.invoices.forEach(inv => {
          const id = cleanId(inv.id);
            if (!remoteIds.has(id)) merged.invoices.push(inv);
          });
        }
        if (localState?.messages?.length) {
          const remoteIds = new Set(merged.messages.map(m => cleanId(m.id)));
          localState.messages.forEach(msg => {
            const id = cleanId(msg.id);
            if (!remoteIds.has(id)) merged.messages.push(msg);
          });
        }

        sanitizeState(merged);
        normalizeIdsToUuid();
        return merged;
      }

      // Student / parent: load only allowed rows; ignore tables that RLS blocks
      const merged = deepClone(defaultState);
      const localSettings = loadState().settings;
      merged.settings = localSettings;

      let studentsRes = { data: [] };
      let parentsRes = { data: [] };
      let parentLinksRes = { data: [] };
      let sessionStudentsRes = { data: [] };
      let sessionsRes = { data: [] };
      let homeworkRes = { data: [] };
      let resourcesRes = { data: [] };
      let invoicesRes = { data: [] };
      let messagesRes = { data: [] };
      let contractSignaturesRes = { data: [] };
      let contractsRes = { data: [] };

      try {
        studentsRes = await supabaseClient.from('students').select('*').eq('student_email', email);
      } catch {}
      try {
        parentsRes = await supabaseClient.from('parents').select('*').eq('email', email);
      } catch {}

      const parentIds = (parentsRes.data || []).map(p => p.id);
      if (parentIds.length) {
        try {
          parentLinksRes = await supabaseClient.from('parent_students').select('*').in('parent_id', parentIds);
        } catch {}
      }

      const studentIds = new Set([
        ...(studentsRes.data || []).map(s => s.id),
        ...(parentLinksRes.data || []).map(pl => pl.student_id)
      ]);
      const studentIdArray = Array.from(studentIds);

      // If this is a parent with linked students, fetch those student rows
      if (studentIdArray.length && !(studentsRes.data || []).length) {
        try {
          studentsRes = await supabaseClient.from('students').select('*').in('id', studentIdArray);
        } catch {}
      }

      if (studentIdArray.length) {
        try {
          sessionStudentsRes = await supabaseClient.from('session_students').select('*').in('student_id', studentIdArray);
        } catch {}
        const sessionIds = Array.from(new Set((sessionStudentsRes.data || []).map(ss => ss.session_id)));
        if (sessionIds.length) {
          try {
            sessionsRes = await supabaseClient.from('sessions').select('*').in('id', sessionIds);
          } catch {}
        }
        try {
          homeworkRes = await supabaseClient.from('homework').select('*').in('student_id', studentIdArray);
        } catch {}
        try {
          invoicesRes = await supabaseClient.from('invoices').select('*').in('student_id', studentIdArray);
        } catch {}
        try {
          messagesRes = await supabaseClient.from('messages').select('*').in('student_id', studentIdArray);
        } catch {}
        try {
          contractSignaturesRes = await supabaseClient.from('parent_contract_signatures').select('*').in('student_id', studentIdArray);
        } catch {}
        try {
          contractsRes = await supabaseClient.from('contracts').select('*').in('student_id', studentIdArray);
        } catch {}
      }

      // Resources tied to homework
      const resourceIds = Array.from(new Set((homeworkRes.data || []).map(h => h.resource_id).filter(Boolean)));
      if (resourceIds.length) {
        try {
          resourcesRes = await supabaseClient.from('resources').select('*').in('id', resourceIds);
        } catch {}
      }

      // Map into state
      merged.students = (studentsRes.data || []).map(s => ({
        id: s.id,
        name: s.name,
        gradeLevel: s.grade_level ?? s.gradeLevel,
        rate: s.rate,
        subjects: s.subjects,
        notes: s.notes,
        studentEmail: s.student_email || '',
        createdAt: s.created_at,
        contractSigned: s.contract_signed,
        contractSignedAt: s.contract_signed_at,
        contractVersion: s.contract_version || 'v1',
        contractSignerName: s.contract_signer_name,
        contractSignerEmail: s.contract_signer_email,
        lastContractId: s.last_contract_id
      }));
      merged.parents = (parentsRes.data || []).map(p => ({
        id: p.id,
        email: (p.email || '').toLowerCase(),
        name: p.name,
        phone: p.phone,
        notes: p.notes,
        verified: p.verified
      }));
      merged.parentLinks = (parentLinksRes.data || []).map(pl => ({
        id: pl.id,
        parentId: pl.parent_id,
        studentId: pl.student_id,
        relationship: pl.relationship
      }));

      const sessions = (sessionsRes.data || []).map(sess => {
        const studentIdsForSess = (sessionStudentsRes.data || [])
          .filter(ss => ss.session_id === sess.id)
          .map(ss => cleanId(ss.student_id))
          .filter(Boolean);
        return {
          id: sess.id,
          date: sess.date,
          startTime: sess.start_time,
          durationHours: sess.duration_hours,
          subject: sess.subject,
          topic: sess.topic,
          notes: sess.notes,
          completed: sess.completed,
          invoiceId: sess.invoice_id,
          studentIds: studentIdsForSess
        };
      });
      merged.sessions = sessions.filter(s => (s.studentIds || []).length > 0);

      merged.homework = (homeworkRes.data || []).map(h => ({
        id: h.id,
        studentId: h.student_id,
        resourceId: h.resource_id,
        status: h.status,
        dueDate: h.due_date,
        assignedDate: h.assigned_date
      }));

      merged.resources = await Promise.all(
        (resourcesRes.data || []).map(async r => {
          let signedUrl = r.signed_url || '';
          if (!signedUrl && r.storage_path && supabaseClient.storage) {
            try {
              const { data, error } = await supabaseClient.storage.from('resources').createSignedUrl(r.storage_path, 60 * 60 * 24);
              if (!error && data?.signedUrl) signedUrl = data.signedUrl;
            } catch (err) {
              console.warn('Student/parent resource signed URL fetch failed', err);
            }
          }
          return {
            id: r.id,
            title: r.title,
            subject: r.subject,
            level: r.level,
            tags: r.tags,
            description: r.description,
            createdAt: r.created_at,
            favorite: r.favorite,
            storage_path: r.storage_path,
            fileName: r.file_name,
            signedUrl
          };
        })
      );

      merged.invoices = (invoicesRes.data || []).map(inv => ({
        id: inv.id,
        studentId: inv.student_id,
        issueDate: inv.issue_date,
        dueDate: inv.due_date,
        baseAmount: inv.base_amount,
        total: inv.total,
        lateFeePercent: inv.late_fee_percent,
        shortNoticePercent: inv.short_notice_percent,
        lateApplied: inv.late_applied,
        shortApplied: inv.short_applied,
        paid: inv.paid,
        notes: inv.notes
      }));
      merged.contractSignatures = (contractSignaturesRes?.data || []).map(cs => ({
        id: cs.id,
        studentId: cs.student_id,
        parentName: cs.parent_name,
        parentEmail: cs.parent_email,
        signedAt: cs.signed_at,
        contractVersion: cs.contract_version || 'v1',
        contractTextSnapshot: cs.contract_text_snapshot,
        renderedPdfUrl: cs.rendered_pdf_url,
        signatureMethod: cs.signature_method,
        parentIp: cs.parent_ip
      }));
      const getSignedUrlWithFallback = async (pathRaw) => {
        const tryBuckets = ['signed_contracts', 'contracts'];
        for (const bucket of tryBuckets) {
          const path = stripBucketPrefix(pathRaw, bucket);
          if (!path || !supabaseClient.storage) continue;
          const { data, error } = await supabaseClient.storage.from(bucket).createSignedUrl(path, 60 * 60 * 24);
          if (!error && data?.signedUrl) return data.signedUrl;
        }
        return '';
      };

      merged.contracts = await Promise.all(
        (contractsRes.data || []).map(async c => {
          let signedUrl = '';
          try {
            if (c.storage_path) {
              signedUrl = await getSignedUrlWithFallback(c.storage_path);
            }
          } catch (err) {
            console.warn('Contract signed URL fetch failed (student/parent)', err);
          }
          return {
            id: c.id,
            studentId: c.student_id,
            fileName: c.file_name,
            storage_path: c.storage_path,
            status: c.status,
            notes: c.notes,
            uploadedAt: c.uploaded_at,
            signedUrl
          };
        })
      );

      merged.messages = (messagesRes?.data || []).map(m => ({
        id: m.id,
        studentId: m.student_id,
        text: m.text,
        sender: m.sender,
        created_at: m.created_at
      }));
      merged.contractSignatures = (contractSignaturesRes?.data || []).map(cs => ({
        id: cs.id,
        studentId: cs.student_id,
        parentName: cs.parent_name,
        parentEmail: cs.parent_email,
        signedAt: cs.signed_at,
        contractVersion: cs.contract_version || 'v1',
        contractTextSnapshot: cs.contract_text_snapshot,
        renderedPdfUrl: cs.rendered_pdf_url,
        signatureMethod: cs.signature_method,
        parentIp: cs.parent_ip
      }));

      sanitizeState(merged);
      normalizeIdsToUuid();
      return merged;
    }

    function applyTheme() {
      const isDark = state.settings.theme === 'dark';
      document.body.classList.toggle('dark', isDark);
      const btn = document.getElementById('themeToggleBtn');
      btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    function toggleTheme() {
      state.settings.theme = state.settings.theme === 'dark' ? 'light' : 'dark';
      applyTheme();
      saveState();
    }

    const policyContent = {
      privacy: `
<h3 class="text-sm font-semibold mb-2">Privacy Policy (Last Updated: 28 November 2025)</h3>
<p class="text-[11px] mb-2">This Privacy Policy describes how personal information is collected, used, and protected in connection with the tutoring dashboard (‚ÄúDashboard‚Äù). By creating an account or using the Dashboard, you consent to these practices.</p>
<ul class="list-disc list-inside text-[11px] space-y-2">
  <li><strong>Information Collected:</strong> name, email, password (Supabase Auth), subjects, sessions, homework status, resources accessed, invoices/payment status (no card/bank details), and device-only preferences (localStorage/IndexedDB).</li>
  <li><strong>Purpose:</strong> authenticate accounts; schedule/track sessions, homework, resources; display/manage invoices; communicate about lessons or changes.</li>
  <li><strong>Storage & Security:</strong> Supabase hosts auth/academic data; on-device preferences stay local; access limited to me (the tutor) unless you request otherwise.</li>
  <li><strong>Sharing:</strong> No selling/renting; only if legally required or at your request (e.g., parent/teacher). No school sharing without your direction.</li>
  <li><strong>Your Rights:</strong> Access, correct, export, or delete your data; withdraw at any time.</li>
  <li><strong>Retention:</strong> Kept while you are an active student; deletable on request when lessons end.</li>
  <li><strong>Minors:</strong> Only essential data is collected; no non-academic use; guardian instructions are followed.</li>
  <li><strong>Contact:</strong> erichuang.shangjing@outlook.com</li>
</ul>
      `,
      tos: `
<h3 class="text-sm font-semibold mb-2">Terms of Service (Last Updated: 28 November 2025)</h3>
<ul class="list-disc list-inside text-[11px] space-y-2">
  <li><strong>Eligibility:</strong> Limited to students receiving tutoring; under 18 requires guardian approval.</li>
  <li><strong>Account Responsibilities:</strong> Keep credentials confidential; use only for tutoring; report unauthorized access.</li>
  <li><strong>Acceptable Use:</strong> No hacking/tampering, sharing other students‚Äô data, or harmful uploads.</li>
  <li><strong>Sessions:</strong> Attend scheduled sessions; provide reasonable notice for changes; late cancellations may incur charges.</li>
  <li><strong>Payments:</strong> Invoices are visible in the Dashboard; payment is due by the stated due date; repeated late payment may lead to fees/suspension.</li>
  <li><strong>Resources:</strong> Materials are for personal academic use only; no redistribution or resale.</li>
  <li><strong>Privacy:</strong> Data handled per the Privacy Policy; use of the Dashboard signifies acceptance.</li>
  <li><strong>Limitation of Liability:</strong> Dashboard provided ‚Äúas is‚Äù; no liability for outages, third-party downtime, device failures, or academic outcomes.</li>
  <li><strong>Termination:</strong> Access may be restricted for violations/misuse or when tutoring concludes; you may request deletion anytime.</li>
  <li><strong>Contact:</strong> erichuang.shangjing@outlook.com</li>
</ul>
      `
    };

    function openPolicyModal(type) {
      const content = policyContent[type];
      if (!content) return;
      const title = type === 'privacy' ? 'Privacy Policy' : 'Terms of Service';
      const html = `
        <h2 class="text-sm font-semibold mb-2">${title}</h2>
        <div id="policyScroll" class="border border-slate-200 rounded-lg p-3 max-h-72 overflow-y-auto text-xs space-y-2 bg-white">
          ${content}
        </div>
        <button id="policyAcknowledgeBtn" class="mt-3 px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium" disabled>
          Scroll to the bottom to continue
        </button>
      `;
      openModal(html, () => {
        const box = document.getElementById('policyScroll');
        const btn = document.getElementById('policyAcknowledgeBtn');
        const onScroll = () => {
          if (box.scrollTop + box.clientHeight >= box.scrollHeight - 4) {
            btn.disabled = false;
            btn.textContent = 'I have read this';
          }
        };
        if (box) box.addEventListener('scroll', onScroll);
        if (btn) {
          btn.onclick = () => {
            if (type === 'privacy') privacyRead = true;
            if (type === 'tos') tosRead = true;
            closeModal();
          };
        }
      });
    }

    async function loadAccountEmails() {
      if (!isSupabaseReady() || !isOwner()) {
        accountEmails = [];
        return;
      }
      try {
        const { data, error } = await supabaseClient.functions.invoke('list-account-emails');
        if (error) throw error;
        accountEmails = Array.isArray(data?.emails) ? data.emails.filter(Boolean) : [];
      } catch (err) {
        console.warn('Account emails fetch failed', err);
      }
    }

    function applyDensity() {
      const compact = state.settings.density === 'compact';
      const container = document.getElementById('viewsContainer');
      container.classList.toggle('py-8', !compact);
      container.classList.toggle('py-5', compact);
      container.classList.toggle('dense-mode', compact);
    }

    /******************
     * PRESENCE       *
     ******************/
    async function refreshPresence() {
      if (!isSupabaseReady()) return;
      try {
        const { data, error } = await supabaseClient.from('presence').select('*');
        if (error) throw error;
        const now = Date.now();
        presenceMap = new Map();
        (data || []).forEach(row => {
          const keyUser = cleanId(row.user_id || row.id || row.email);
          const keyEmail = (row.email || '').toLowerCase();
          const fresh = now - new Date(row.updated_at).getTime() < 65000;
          presenceMap.set(keyUser, { email: row.email, role: row.role, fresh });
          presenceMap.set(keyEmail, { email: row.email, role: row.role, fresh });
        });
      } catch (err) {
        console.warn('Presence fetch failed', err);
      }
    }

    function startPresence() {
      if (!isSupabaseReady()) return;
      stopPresence();
      const run = async () => {
        try {
          await supabaseClient.from('presence').upsert({
            user_id: supabaseSession.user.id,
            email: getSessionEmail(),
            role: isOwner() ? 'owner' : parentMode ? 'parent' : 'student',
            updated_at: new Date().toISOString()
          });
          await refreshPresence();
          renderStudentsView();
        } catch (err) {
          console.warn('Presence heartbeat failed', err);
        }
      };
      run();
      presenceHeartbeat = setInterval(run, 30000);
    }

    function stopPresence() {
      if (presenceHeartbeat) clearInterval(presenceHeartbeat);
      presenceHeartbeat = null;
      presenceMap = new Map();
    }

    function copyContractLink(studentId) {
      const basePath = window.location.pathname.replace(/[^/]*$/, '');
      const link = `${window.location.origin}${basePath}contract-sign.html?student_id=${encodeURIComponent(studentId)}&v=v1`;
      navigator.clipboard?.writeText(link).then(() => {
        alert('Parent signing link copied to clipboard.');
      }).catch(() => {
        prompt('Copy this link and send to the parent:', link);
      });
    }

    function renderAllViews() {
      updateKPIsAndCharts();
      renderStudentsView();
      renderScheduleView();
      renderResourcesView();
      renderFinanceView();
      renderProfileView();
      renderActivityLog();
      renderReportsView();
      if (studentMode) renderStudentPortal();
      if (parentMode) renderParentPortal();
    }

    /******************
     * GLOBAL SEARCH  *
     ******************/
    function handleGlobalSearch(e) {
      const query = e.target.value.trim().toLowerCase();
      const resultsBox = document.getElementById('globalSearchResults');
      if (!query) {
        resultsBox.innerHTML = '';
        resultsBox.classList.add('hidden');
        return;
      }

      const results = [];

      // Students
      state.students.forEach(s => {
        if (s.name.toLowerCase().includes(query) || (s.notes || '').toLowerCase().includes(query)) {
          results.push({ type: 'Student', label: s.name, id: s.id });
        }
      });

      // Resources
      state.resources.forEach(r => {
        if (r.title.toLowerCase().includes(query) || (r.tags || []).some(t => t.toLowerCase().includes(query))) {
          results.push({ type: 'Resource', label: r.title + ' (' + r.subject + ')', id: r.id });
        }
      });

      // Sessions
      state.sessions.forEach(sess => {
        const studentNames = sess.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
        const text = (sess.topic || '') + ' ' + studentNames;
        if (text.toLowerCase().includes(query)) {
          results.push({ type: 'Session', label: studentNames + ' ‚Äì ' + (sess.topic || 'Session'), id: sess.id });
        }
      });

      // Invoices
      state.invoices.forEach(inv => {
        const s = getStudentById(inv.studentId);
        const label = (s?.name || 'Unknown') + ' ‚Äì ' + inv.id;
        if (label.toLowerCase().includes(query)) {
          results.push({ type: 'Invoice', label, id: inv.id });
        }
      });

      if (!results.length) {
        resultsBox.innerHTML = '<div class="px-3 py-2 text-slate-500">No results</div>';
        resultsBox.classList.remove('hidden');
        return;
      }

      resultsBox.innerHTML = results.map(r => `
        <div class="px-3 py-1.5 hover:bg-slate-50 cursor-pointer" data-type="${r.type}" data-id="${r.id}">
          <span class="text-[10px] uppercase text-slate-400">${r.type}</span>
          <div class="text-xs">${r.label}</div>
        </div>
      `).join('');
      resultsBox.classList.remove('hidden');

      resultsBox.querySelectorAll('[data-type]').forEach(el => {
        el.addEventListener('click', () => {
          const type = el.dataset.type;
          const id = el.dataset.id;
          if (type === 'Student') {
            switchView('students');
            selectStudent(id);
          } else if (type === 'Resource') {
            switchView('resources');
          } else if (type === 'Session') {
            switchView('schedule');
          } else if (type === 'Invoice') {
            switchView('finance');
          }
          resultsBox.classList.add('hidden');
        });
      });
    }

    /***************
     * DASHBOARD   *
     ***************/
    let subjectMixChart;

    function updateKPIsAndCharts() {
      const now = new Date();
      const cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      const today = new Date();

      const activeStudentIds = new Set(
        state.sessions
          .filter(s => new Date(s.date) >= cutoff)
          .flatMap(s => s.studentIds)
      );
      document.getElementById('kpiStudents').textContent = activeStudentIds.size;

      const startOfWeek = getMonday(now);
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(endOfWeek.getDate() + 7);

      let hoursThisWeek = 0;
      state.sessions.forEach(s => {
        const d = new Date(s.date);
        if (d >= startOfWeek && d < endOfWeek) {
          hoursThisWeek += Number(s.durationHours || 0);
        }
      });
      document.getElementById('kpiHoursWeek').textContent = hoursThisWeek.toFixed(1);

      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      let expected = 0;
      state.invoices.forEach(inv => {
        const d = new Date(inv.issueDate);
        if (d >= startOfMonth && d < endOfMonth) {
          expected += Number(inv.total || 0);
        }
      });
      if (studentMode) {
        document.getElementById('kpiExpectedIncome').textContent = 'N/A';
      } else {
        document.getElementById('kpiExpectedIncome').textContent = 'R ' + expected.toFixed(2);
      }

      const overdueCount = studentMode ? 0 : state.invoices.filter(inv => !inv.paid && inv.dueDate && new Date(inv.dueDate) < today).length;
      document.getElementById('kpiOverdue').textContent = studentMode ? 'N/A' : overdueCount;

      // Goals & focus
      const weeklyGoal = Number(state.settings.weeklyGoalHours || 0);
      const weeklyPct = weeklyGoal ? Math.min(100, (hoursThisWeek / weeklyGoal) * 100) : 0;
      document.getElementById('goalHoursLabel').textContent = `${hoursThisWeek.toFixed(1)} / ${weeklyGoal || 0}h`;
      document.getElementById('goalHoursProgress').style.width = `${weeklyPct}%`;

      const monthlyGoal = Number(state.settings.monthlyIncomeGoal || 0);
      const monthlyPct = monthlyGoal ? Math.min(100, (expected / monthlyGoal) * 100) : 0;
      document.getElementById('goalIncomeLabel').textContent = `R ${expected.toFixed(0)} / R ${monthlyGoal || 0}`;
      document.getElementById('goalIncomeProgress').style.width = `${monthlyPct}%`;

      const reflection = (state.settings.reflection || '').trim();
      document.getElementById('reflectionText').textContent = reflection || 'Add a short intention in Settings to keep this week focused.';

      const upcomingSoon = [...state.sessions]
        .filter(s => new Date(s.date + 'T' + (s.startTime || '00:00')) >= now)
        .sort((a, b) => new Date(a.date + 'T' + (a.startTime || '00:00')) - new Date(b.date + 'T' + (b.startTime || '00:00')));
      if (upcomingSoon.length) {
        const next = upcomingSoon[0];
        const names = next.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
        document.getElementById('focusNextSession').textContent = names;
        document.getElementById('focusNextSessionMeta').textContent = `${next.subject} ‚Ä¢ ${next.date} ${next.startTime || ''}`;
      } else {
        document.getElementById('focusNextSession').textContent = 'No sessions planned';
        document.getElementById('focusNextSessionMeta').textContent = '';
      }

      const homeworkDueSoon = state.homework.filter(hw => {
        if (hw.status === 'Completed') return false;
        if (!hw.dueDate) return false;
        const due = new Date(hw.dueDate);
        const fiveDays = new Date(now.getTime() + 5 * 24 * 60 * 60 * 1000);
        return due >= today && due <= fiveDays;
      });
      document.getElementById('focusHomework').textContent = homeworkDueSoon.length;
      document.getElementById('focusInvoices').textContent = overdueCount;

      const hours = { Physics: 0, Chemistry: 0, Maths: 0 };
      state.sessions.forEach(s => {
        if (hours[s.subject] != null) {
          hours[s.subject] += Number(s.durationHours || 0);
        }
      });

      const ctx = document.getElementById('subjectMixChart').getContext('2d');
      if (subjectMixChart) subjectMixChart.destroy();
      subjectMixChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Physics', 'Chemistry', 'Maths'],
          datasets: [{
            label: 'Hours taught',
            data: [hours.Physics, hours.Chemistry, hours.Maths],
            backgroundColor: ['#4f46e5', '#16a34a', '#dc2626'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });

      const upcomingList = document.getElementById('upcomingSessionsList');
      const sevenDays = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
      const upcoming = state.sessions
        .filter(s => {
          const d = new Date(s.date + 'T' + (s.startTime || '00:00'));
          return d >= now && d <= sevenDays;
        })
        .sort((a, b) => new Date(a.date + 'T' + (a.startTime || '00:00')) - new Date(b.date + 'T' + (b.startTime || '00:00')))
        .slice(0, 10);

      if (!upcoming.length) {
        upcomingList.innerHTML = '<li class="text-slate-500">No upcoming sessions in the next 7 days.</li>';
      } else {
        upcomingList.innerHTML = upcoming.map(s => {
          const names = s.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
          return `<li class="border border-slate-200 bg-white/80 rounded-lg px-2 py-1">
              <div class="font-medium">${names}</div>
              <div class="text-[10px] text-slate-500">${s.subject} ‚Ä¢ ${s.date} ‚Ä¢ ${s.startTime || ''} (${s.durationHours || 1}h)</div>
              <div class="text-[10px]">${s.topic || ''}</div>
            </li>`;
        }).join('');
      }

      const atRiskList = document.getElementById('atRiskList');
      const atRisk = state.students
        .map(s => {
          const last = getLastSessionDate(s.id);
          const daysSince = last ? Math.floor((now - last) / (1000 * 60 * 60 * 24)) : 999;
          return { student: s, daysSince };
        })
        .filter(item => item.daysSince >= 21)
        .sort((a, b) => b.daysSince - a.daysSince)
        .slice(0, 6);
      if (!atRisk.length) {
        atRiskList.innerHTML = '<li class="text-slate-500">All students taught in the last 21 days.</li>';
      } else {
        atRiskList.innerHTML = atRisk.map(item => `
          <li class="border border-amber-200 bg-amber-50 rounded-lg px-2 py-1">
            <div class="font-medium">${item.student.name}</div>
            <div class="text-[10px] text-slate-600">${item.daysSince} days since last session</div>
          </li>
        `).join('');
      }

      const dueList = document.getElementById('dueHomeworkList');
      if (!homeworkDueSoon.length) {
        dueList.innerHTML = '<li class="text-slate-500">Nothing due soon.</li>';
      } else {
        dueList.innerHTML = homeworkDueSoon.slice(0, 6).map(hw => {
          const res = getResourceById(hw.resourceId);
          const stu = getStudentById(hw.studentId);
          return `<li class="border border-slate-200 bg-white/80 rounded-lg px-2 py-1">
            <div class="font-medium">${res?.title || 'Homework'}</div>
            <div class="text-[10px] text-slate-500">${stu?.name || ''} ‚Ä¢ Due ${hw.dueDate}</div>
          </li>`;
        }).join('');
      }

      const prepQueue = document.getElementById('prepQueueList');
      const prepItems = upcomingSoon.slice(0, 3);
      if (!prepItems.length) {
        prepQueue.innerHTML = '<li class="text-slate-500">No prep needed right now.</li>';
      } else {
        prepQueue.innerHTML = prepItems.map(sess => {
          const names = sess.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
            <div>
              <div class="font-medium">${names}</div>
              <div class="text-[10px] text-slate-500">${sess.date} ‚Ä¢ ${sess.startTime || ''} ‚Ä¢ ${sess.subject}</div>
              <div class="text-[10px]">${sess.topic || 'Lesson focus'}</div>
            </div>
            <button class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                    onclick="openSessionQuickActions('${sess.id}')">Open</button>
          </li>`;
        }).join('');
      }
    }

    /****************
     * STUDENTS VIEW *
     ****************/
    let selectedStudentId = null;

    function renderStudentsView() {
      const list = document.getElementById('studentsList');
      const subjectSelect = document.getElementById('studentSubjectFilter');
      const activitySelect = document.getElementById('studentActivityFilter');
      if (subjectSelect) subjectSelect.onchange = renderStudentsView;
      if (activitySelect) activitySelect.onchange = renderStudentsView;

      const subjectFilter = subjectSelect?.value || '';
      const activityFilter = activitySelect?.value || '';
      const now = new Date();

      const filtered = state.students.filter(s => {
        if (subjectFilter && !(s.subjects || []).includes(subjectFilter)) return false;
        const last = getLastSessionDate(s.id);
        const daysSince = last ? (now - last) / (1000 * 60 * 60 * 24) : Infinity;
        if (activityFilter === 'active' && daysSince > 14) return false;
        if (activityFilter === 'quiet' && daysSince <= 14) return false;
        return true;
      });

      if (!filtered.length) {
        list.innerHTML = '<li class="text-slate-500 text-xs">No students match this filter.</li>';
      } else {
        list.innerHTML = filtered.map(s => {
          const hours = getStudentSubjectHours(s.id);
          const total = hours.Physics + hours.Chemistry + hours.Maths || 1;
          const pPhysics = (hours.Physics / total * 100).toFixed(0);
          const pChem = (hours.Chemistry / total * 100).toFixed(0);
          const pMath = (hours.Maths / total * 100).toFixed(0);
          const last = getLastSessionDate(s.id);
          const daysSince = last ? Math.floor((now - last) / (1000 * 60 * 60 * 24)) : null;
          const next = getNextSessionForStudent(s.id);
          const nextLabel = next ? `${next.date} ${next.startTime || ''}` : 'Unscheduled';
          const presence = presenceMap.get((s.studentEmail || '').toLowerCase()) || presenceMap.get(cleanId(s.id));
          const online = !!presence?.fresh;
          return `<li class="border border-slate-200 bg-white/85 rounded-xl px-3 py-2 cursor-pointer hover:bg-slate-50 flex flex-col gap-1"
                     data-student-id="${s.id}">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-semibold">${s.name}</div>
                  <div class="text-[10px] text-slate-500">${s.gradeLevel || ''}</div>
                </div>
                <div class="text-right flex items-center gap-2">
                  <span class="inline-flex items-center gap-1 text-[10px] ${online ? 'text-emerald-600' : 'text-slate-500'}">
                    <span class="h-2.5 w-2.5 rounded-full ${online ? 'bg-emerald-500' : 'bg-slate-400'}"></span>
                    ${online ? 'Online' : 'Offline'}
                  </span>
                  <span class="text-[11px] text-slate-600">${s.subjects?.join(', ') || ''}</span>
                </div>
              </div>
              <div class="flex items-center justify-between text-[10px] text-slate-500">
                <span>${daysSince != null ? `${daysSince}d since last` : 'No sessions yet'}</span>
                <span>${nextLabel}</span>
              </div>
              <div class="mt-1 w-full h-1.5 rounded-full bg-slate-100 overflow-hidden flex">
                <div style="width:${pPhysics}%" class="bg-indigo-500"></div>
                <div style="width:${pChem}%" class="bg-emerald-500"></div>
                <div style="width:${pMath}%" class="bg-rose-500"></div>
              </div>
            </li>`;
        }).join('');
      }

      list.querySelectorAll('[data-student-id]').forEach(li => {
        li.addEventListener('click', () => {
          selectStudent(li.dataset.studentId);
        });
      });

      const current = getStudentById(selectedStudentId);
      if (current) {
        showStudentDetail(selectedStudentId);
      } else {
        document.getElementById('studentDetailEmpty').classList.remove('hidden');
        document.getElementById('studentDetail').classList.add('hidden');
      }
      renderParentsList();
    }

    function getStudentById(id) {
      return state.students.find(s => s.id === id);
    }

    function getParentById(id) {
      return state.parents.find(p => p.id === id);
    }

    function getParentLinkedStudents(parentId) {
      const links = state.parentLinks.filter(pl => pl.parentId === parentId);
      return links.map(pl => getStudentById(pl.studentId)).filter(Boolean);
    }

    function getLatestSignature(studentId) {
      const sigs = state.contractSignatures
        .filter(cs => cs.studentId === studentId)
        .sort((a, b) => new Date(b.signedAt || 0) - new Date(a.signedAt || 0));
      return sigs[0] || null;
    }

    async function deleteParentAndLinks(parentId) {
      // Local
      state.parents = state.parents.filter(p => p.id !== parentId);
      state.parentLinks = state.parentLinks.filter(pl => pl.parentId !== parentId);
      saveState();
      renderParentsList();
      // Remote
      if (isSupabaseReady()) {
        try {
          await supabaseClient.from('parent_students').delete().eq('parent_id', parentId);
        } catch (err) {
          console.warn('Remote parent_students delete failed', err);
        }
        try {
          await supabaseClient.from('parents').delete().eq('id', parentId);
        } catch (err) {
          console.warn('Remote parents delete failed', err);
        }
      }
    }

    function getStudentSubjectHours(studentId) {
      const res = { Physics: 0, Chemistry: 0, Maths: 0 };
      const now = new Date();
      const cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      state.sessions.forEach(sess => {
        if (!sess.studentIds.includes(studentId)) return;
        const d = new Date(sess.date);
        if (d >= cutoff) {
          if (res[sess.subject] != null) {
            res[sess.subject] += Number(sess.durationHours || 0);
          }
        }
      });
      return res;
    }

    function renderParentsList() {
      const list = document.getElementById('parentsList');
      if (!list) return;
      if (!state.parents.length) {
        list.innerHTML = '<li class="text-slate-500 text-xs">No parents added yet.</li>';
        return;
      }
      list.innerHTML = state.parents.map(p => {
        const kids = getParentLinkedStudents(p.id);
        const kidNames = kids.map(k => k.name).join(', ') || 'No students linked';
        return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex items-start justify-between gap-2">
          <div>
            <div class="font-semibold">${p.name || p.email}</div>
            <div class="text-[10px] text-slate-500">${p.email}</div>
            <div class="text-[10px] text-slate-500">${kidNames}</div>
          </div>
          <button data-parent-id="${p.id}" class="px-2 py-1 text-[10px] rounded-lg border border-slate-300 hover:bg-slate-50">Edit</button>
        </li>`;
      }).join('');
      list.querySelectorAll('[data-parent-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const parent = getParentById(btn.dataset.parentId);
          if (parent) openParentModal(parent);
        });
      });
    }

    function openParentModal(parent) {
      if (!guardEdit()) return;
      const isEdit = !!parent;
      const parentEmailOptions = getAvailableParentEmails(parent?.email).map(e => `<option value="${e}">${e}</option>`).join('');
      const linked = new Set(
        state.parentLinks.filter(pl => pl.parentId === parent?.id).map(pl => pl.studentId)
      );
      const studentChecks = state.students.map(s => `
        <label class="flex items-center gap-2 text-[11px]">
          <input type="checkbox" name="studentIds" value="${s.id}" ${linked.has(s.id) ? 'checked' : ''}>
          <span>${s.name}</span>
        </label>
      `).join('');
      const html = `
        <h2 class="text-sm font-semibold mb-3">${isEdit ? 'Edit parent' : 'Add parent'}</h2>
        <form id="parentForm" class="space-y-2 text-xs">
          <div>
            <label class="block text-[11px] mb-1">Name</label>
            <input name="name" value="${parent?.name || ''}" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Email</label>
            <select name="email" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              <option value="">Select an account email</option>
              ${parentEmailOptions}
            </select>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Phone</label>
            <div class="flex gap-2">
              <select name="phoneCode" class="border border-slate-300 rounded-lg px-2 py-1 text-xs w-28">
                ${['+1','+27','+44','+61','+65','+91'].map(c => `<option value="${c}" ${parent?.phone?.startsWith(c) ? 'selected' : ''}>${c}</option>`).join('')}
                <option value="" ${!(parent?.phone) ? 'selected' : ''}>Code</option>
              </select>
              <input name="phoneLocal" value="${parent?.phone ? parent.phone.replace(/^\\+\\d+\\s?/, '') : ''}" class="flex-1 border border-slate-300 rounded-lg px-2 py-1 text-xs" placeholder="Number">
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Notes</label>
            <textarea name="notes" rows="2" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${parent?.notes || ''}</textarea>
          </div>
          <div class="space-y-1">
            <div class="text-[11px] font-semibold">Link students</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-1 max-h-40 overflow-y-auto">
              ${studentChecks || '<div class="text-[10px] text-slate-500">No students yet.</div>'}
            </div>
          </div>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-xs font-medium">
              ${isEdit ? 'Save changes' : 'Add parent'}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteParentBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                Delete
              </button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('parentForm');
        form.onsubmit = (e) => {
          e.preventDefault();
          const newParent = {
            id: parent?.id || generateId('par'),
            name: form.name.value.trim(),
            email: form.email.value.trim().toLowerCase(),
            phone: (form.phoneCode.value || '') + (form.phoneLocal.value.trim() ? (' ' + form.phoneLocal.value.trim()) : ''),
            notes: form.notes.value.trim()
          };
          if (!newParent.email) {
            alert('Email is required.');
            return;
          }
          const taken = state.parents.some(p => p.email === newParent.email && p.id !== newParent.id);
          if (taken) {
            alert('That email is already used by another parent.');
            return;
          }
          if (isEdit) {
            const idx = state.parents.findIndex(p => p.id === parent.id);
            state.parents[idx] = { ...state.parents[idx], ...newParent };
            logActivity('Updated parent', newParent.email);
          } else {
            state.parents.push(newParent);
            logActivity('Added parent', newParent.email);
          }
          const selected = Array.from(form.querySelectorAll('input[name="studentIds"]:checked')).map(i => i.value);
          state.parentLinks = state.parentLinks.filter(pl => pl.parentId !== newParent.id);
          selected.forEach(sid => {
            state.parentLinks.push({
              id: generateId('plink'),
              parentId: newParent.id,
              studentId: sid,
              relationship: ''
            });
          });
          saveState();
          closeModal();
          renderParentsList();
        };
          if (isEdit) {
            const delBtn = document.getElementById('deleteParentBtn');
          delBtn.onclick = () => {
            if (!confirm('Delete this parent and unlink from all students?')) return;
            deleteParentAndLinks(parent.id).then(() => {
              closeModal();
            }).catch(err => {
              console.error(err);
              alert('Failed to delete parent: ' + (err?.message || err));
            });
          };
        }
      });
    }

    function getLastSessionDate(studentId) {
      const sessions = state.sessions
        .filter(sess => sess.studentIds.includes(studentId))
        .map(sess => new Date(sess.date))
        .sort((a, b) => b - a);
      return sessions[0] || null;
    }

    function getNextSessionForStudent(studentId) {
      const now = new Date();
      const sessions = state.sessions
        .filter(sess => sess.studentIds.includes(studentId))
        .sort((a, b) => new Date(a.date + 'T' + (a.startTime || '00:00')) - new Date(b.date + 'T' + (b.startTime || '00:00')));
      return sessions.find(sess => new Date(sess.date + 'T' + (sess.startTime || '00:00')) >= now) || null;
    }

    function getStudentHomeworkStats(studentId) {
      const items = state.homework.filter(hw => hw.studentId === studentId);
      const total = items.length;
      const completed = items.filter(hw => hw.status === 'Completed').length;
      return { total, completed, rate: total ? Math.round((completed / total) * 100) : 0 };
    }

    function getWeeklyStreak(studentId) {
      let streak = 0;
      const today = new Date();
      let cursor = getMonday(today);
      while (true) {
        const end = new Date(cursor);
        end.setDate(end.getDate() + 7);
        const hasSession = state.sessions.some(sess => {
          if (!sess.studentIds.includes(studentId)) return false;
          const d = new Date(sess.date);
          return d >= cursor && d < end;
        });
        if (hasSession) {
          streak++;
          cursor.setDate(cursor.getDate() - 7);
        } else {
          break;
        }
      }
      return streak;
    }

    function selectStudent(id) {
      selectedStudentId = id;
      showStudentDetail(id);
      switchView('students');
    }

    function showStudentDetail(id) {
      const s = getStudentById(id);
      if (!s) return;
      document.getElementById('studentDetailEmpty').classList.add('hidden');
      document.getElementById('studentDetail').classList.remove('hidden');

      document.getElementById('studentDetailName').textContent = s.name;
      document.getElementById('studentDetailMeta').textContent =
        `${s.gradeLevel || ''} ‚Ä¢ ${s.subjects?.join(', ') || ''} ‚Ä¢ Rate: ${s.rate ? 'R ' + s.rate + '/h' : '‚Äî'}`;
      const contractBadge = document.getElementById('studentContractBadge');
      const contractLinkBtn = document.getElementById('studentContractLinkBtn');
      const contractDeleteBtn = document.getElementById('studentContractDeleteBtn');
      const contractMeta = document.getElementById('studentContractMeta');
      const latestSig = getLatestSignature(s.id);
      const contractEntry = state.contracts.find(c => c.studentId === s.id && c.status === 'Signed') || null;
      const hasContract = !!latestSig || !!contractEntry || !!s.contractSigned;
      if (contractBadge) {
        const signed = !!s.contractSigned;
        contractBadge.textContent = signed ? 'VALID ‚Äì CONTRACT SIGNED' : 'INVALID ‚Äì CONTRACT NOT SIGNED';
        contractBadge.className = signed
          ? 'px-2 py-1 text-[11px] rounded-lg bg-emerald-100 text-emerald-700 font-semibold'
          : 'px-2 py-1 text-[11px] rounded-lg bg-rose-100 text-rose-700 font-semibold';
      }
      if (contractDeleteBtn) {
        contractDeleteBtn.classList.toggle('hidden', !hasContract || parentMode);
        contractDeleteBtn.onclick = () => {
          if (!guardEdit()) return;
          const targetId = latestSig?.id || contractEntry?.id || s.lastContractId || '';
          deleteContractForStudent(targetId, s.id);
        };
      }
      if (contractMeta) {
        if (latestSig) {
          contractMeta.innerHTML = `Signed by ${latestSig.parentName || 'Parent'} on ${latestSig.signedAt ? new Date(latestSig.signedAt).toLocaleString() : ''} ‚Ä¢ Version ${latestSig.contractVersion || 'v1'} ${latestSig.renderedPdfUrl ? `<a href="${latestSig.renderedPdfUrl}" target="_blank" rel="noopener" class="underline text-indigo-600">View signed copy</a>` : ''}`;
        } else if (contractEntry?.signedUrl) {
          contractMeta.innerHTML = `Signed contract on file. <a href="${contractEntry.signedUrl}" target="_blank" rel="noopener" class="underline text-indigo-600">View signed copy</a>`;
        } else {
          contractMeta.textContent = 'No signed contract on file.';
        }
      }
      if (contractLinkBtn) {
        contractLinkBtn.onclick = () => copyContractLink(s.id);
      }

      const hours = getStudentSubjectHours(id);
      const total = hours.Physics + hours.Chemistry + hours.Maths || 1;
      const pPhysics = (hours.Physics / total * 100).toFixed(0);
      const pChem = (hours.Chemistry / total * 100).toFixed(0);
      const pMath = (hours.Maths / total * 100).toFixed(0);
      const physEl = document.getElementById('mixPhysics');
      const chemEl = document.getElementById('mixChemistry');
      const mathEl = document.getElementById('mixMaths');
      physEl.style.width = pPhysics + '%';
      chemEl.style.width = pChem + '%';
      mathEl.style.width = pMath + '%';
      physEl.textContent = pPhysics > 15 ? pPhysics + '%' : '';
      chemEl.textContent = pChem > 15 ? pChem + '%' : '';
      mathEl.textContent = pMath > 15 ? pMath + '%' : '';

      const totalHours = (hours.Physics + hours.Chemistry + hours.Maths).toFixed(1);
      document.getElementById('engagementHours').textContent = totalHours + 'h';
      const streak = getWeeklyStreak(id);
      document.getElementById('engagementStreak').textContent = streak;
      const last = getLastSessionDate(id);
      document.getElementById('engagementNextGap').textContent = last
        ? `${Math.floor((new Date() - last) / (1000 * 60 * 60 * 24))} days since last`
        : 'No sessions yet';
      const hwStats = getStudentHomeworkStats(id);
      document.getElementById('engagementHomework').textContent = `${hwStats.rate}%`;
      document.getElementById('engagementHomeworkProgress').style.width = `${hwStats.rate}%`;
      // If contract not signed, show a blocking notice in detail tabs
      const unsignedNotice = document.getElementById('studentUnsignedNotice');
      if (unsignedNotice) {
        unsignedNotice.classList.toggle('hidden', !!s.contractSigned);
      }

      renderStudentTimeline(id);
      renderStudentSessions(id);
      renderStudentDocuments(id);
      renderStudentFinance(id);
      renderStudentTodos(id);
      renderStudentCheckins(id);
      renderStudentContracts(id);
      renderStudentMessages(id);

      document.getElementById('editStudentBtn').onclick = () => openStudentModal(s);
      document.getElementById('studentCreateInvoiceBtn').onclick = () => { if (guardEdit()) openInvoiceModal(null); };

      document.querySelectorAll('#studentDetailTabs .student-tab').forEach(tab => {
        tab.classList.remove('border-indigo-500', 'text-slate-900');
        tab.classList.add('text-slate-500');
      });
      const defaultTab = document.querySelector('#studentDetailTabs .student-tab[data-student-tab="timeline"]');
      defaultTab.classList.add('border-indigo-500', 'text-slate-900');
      defaultTab.classList.remove('text-slate-500');
      document.querySelectorAll('.student-tab-pane').forEach(p => p.classList.add('hidden'));
      document.getElementById('studentTab-timeline').classList.remove('hidden');

      document.querySelectorAll('#studentDetailTabs .student-tab').forEach(tab => {
        tab.onclick = () => {
          const tabId = tab.dataset.studentTab;
          document.querySelectorAll('#studentDetailTabs .student-tab').forEach(t => {
            t.classList.remove('border-indigo-500', 'text-slate-900');
            t.classList.add('text-slate-500');
          });
          tab.classList.add('border-indigo-500', 'text-slate-900');
          tab.classList.remove('text-slate-500');
          document.querySelectorAll('.student-tab-pane').forEach(p => p.classList.add('hidden'));
          document.getElementById('studentTab-' + tabId).classList.remove('hidden');
        };
      });

      document.getElementById('addDocumentForStudentBtn').onclick = () => { if (guardEdit()) openDocumentModal(null, s.id); };
      const todoForm = document.getElementById('studentTodoForm');
      if (todoForm) {
        todoForm.onsubmit = (e) => {
          if (!guardEdit()) return;
          e.preventDefault();
          const text = todoForm.todoText.value.trim();
          const dueDate = todoForm.todoDue.value;
          if (!text) return;
          state.studentTodos.push({
            id: generateId('todo'),
            studentId: id,
            text,
            dueDate,
            done: false
          });
          saveState();
          renderStudentTodos(id);
          todoForm.reset();
        };
      }
      const checkinForm = document.getElementById('studentCheckinForm');
      if (checkinForm) {
        checkinForm.onsubmit = (e) => {
          if (!guardEdit()) return;
          e.preventDefault();
          const text = checkinForm.checkinText.value.trim();
          if (!text) return;
          state.studentCheckins.push({
            id: generateId('note'),
            studentId: id,
            text,
            date: new Date().toISOString().slice(0, 10)
          });
          saveState();
          renderStudentCheckins(id);
          renderStudentTimeline(id);
          checkinForm.reset();
        };
      }
      const contractBtn = document.getElementById('uploadContractBtn');
      if (contractBtn) {
        contractBtn.onclick = () => openContractUpload(id);
      }
      const msgForm = document.getElementById('studentMessageForm');
      if (msgForm) {
        msgForm.onsubmit = (e) => {
          e.preventDefault();
          const text = msgForm.messageText.value.trim();
          if (!text) return;
          const sender = isOwner() ? 'owner' : 'student';
          state.messages.push({
            id: generateId('msg'),
            studentId: id,
            text,
            sender,
            created_at: new Date().toISOString()
          });
          saveState();
          renderStudentMessages(id);
          logActivity('Message posted', text.slice(0,50));
          msgForm.reset();
        };
      }
    }

    function renderStudentTimeline(studentId) {
      const ul = document.getElementById('studentTimeline');
      const events = [];

      state.sessions.filter(sess => sess.studentIds.includes(studentId)).forEach(sess => {
        events.push({
          date: sess.date,
          type: 'Session',
          description: `${sess.subject} ‚Ä¢ ${sess.topic || 'Lesson'} (${sess.durationHours || 1}h)`
        });
      });

      state.homework.filter(hw => hw.studentId === studentId).forEach(hw => {
        const res = state.resources.find(r => r.id === hw.resourceId);
        if (!res) return;
        events.push({
          date: hw.assignedDate || res.createdAt || new Date().toISOString().slice(0,10),
          type: 'Homework',
          description: `${res.title} [${hw.status}]`
        });
      });

      state.invoices.filter(inv => inv.studentId === studentId).forEach(inv => {
        events.push({
          date: inv.issueDate,
          type: 'Invoice',
          description: `${inv.id} ‚Äì R ${inv.total?.toFixed(2) || inv.total} (${inv.paid ? 'Paid' : 'Unpaid'})`
        });
      });

      state.documents.filter(doc => doc.studentId === studentId).forEach(doc => {
        events.push({
          date: doc.date || doc.createdAt || new Date().toISOString().slice(0,10),
          type: 'Document',
          description: `${doc.title} [${doc.status}]`
        });
      });

      state.studentCheckins.filter(note => note.studentId === studentId).forEach(note => {
        events.push({
          date: note.date || new Date().toISOString().slice(0,10),
          type: 'Check-in',
          description: note.text
        });
      });

      state.contracts.filter(c => c.studentId === studentId).forEach(c => {
        events.push({
          date: c.uploadedAt || new Date().toISOString().slice(0,10),
          type: 'Contract',
          description: `${c.fileName || 'Contract'} [${c.status || 'Pending'}]`
        });
      });

      events.sort((a, b) => new Date(b.date) - new Date(a.date));

      if (!events.length) {
        ul.innerHTML = '<li class="text-slate-500">No events yet.</li>';
        return;
      }

      ul.innerHTML = events.map(ev => `
        <li class="flex items-start gap-2">
          <div class="mt-1 h-2 w-2 rounded-full ${ev.type === 'Session' ? 'bg-indigo-500' :
                                                ev.type === 'Invoice' ? 'bg-emerald-500' :
                                                ev.type === 'Document' ? 'bg-amber-500' :
                                                'bg-slate-400'}"></div>
          <div>
            <div class="text-[10px] text-slate-500">${ev.date} ‚Ä¢ ${ev.type}</div>
            <div>${ev.description}</div>
          </div>
        </li>
      `).join('');
    }

    function renderStudentSessions(studentId) {
      const ul = document.getElementById('studentSessionsList');
      const sessions = state.sessions.filter(sess => sess.studentIds.includes(studentId))
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      if (!sessions.length) {
        ul.innerHTML = '<li class="text-slate-500">No sessions recorded.</li>';
        return;
      }
      ul.innerHTML = sessions.map(sess => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 flex justify-between items-center bg-white/80">
          <div>
            <div class="font-medium">${sess.subject} ‚Äì ${sess.topic || 'Lesson'}</div>
            <div class="text-[10px] text-slate-500">${sess.date} ‚Ä¢ ${sess.startTime || ''} ‚Ä¢ ${sess.durationHours || 1}h</div>
          </div>
            <button data-owner-only class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                    onclick="if(guardEdit()) openSessionModal(getSessionById('${sess.id}'))">
            Edit
          </button>
        </li>
      `).join('');
    }

    function renderStudentDocuments(studentId) {
      const ul = document.getElementById('studentDocumentsList');
      const docs = state.documents.filter(doc => doc.studentId === studentId);
      if (!docs.length) {
        ul.innerHTML = '<li class="text-slate-500">No documents for this student.</li>';
        return;
      }
      ul.innerHTML = docs.map(doc => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 flex justify-between items-center bg-white/85">
          <div>
            <div class="font-medium">${doc.title}</div>
            <div class="text-[10px] text-slate-500">${doc.status} ‚Ä¢ ${doc.date || ''}</div>
          </div>
          <button data-owner-only class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                  onclick="if(guardEdit()) openDocumentModal(getDocumentById('${doc.id}'))">
            Edit
          </button>
        </li>
      `).join('');
    }

    function renderStudentFinance(studentId) {
      const ul = document.getElementById('studentInvoicesList');
      const invs = state.invoices.filter(inv => inv.studentId === studentId)
        .sort((a, b) => new Date(b.issueDate) - new Date(a.issueDate));
      let balance = 0;
      invs.forEach(inv => {
        if (!inv.paid) balance += Number(inv.total || 0);
      });
      const balanceLabel = balance > 0 ? 'Owed balance' : 'Balance';
      document.getElementById('studentBalance').textContent = `${balanceLabel}: R ${balance.toFixed(2)}`;
      if (!invs.length) {
        ul.innerHTML = '<li class="text-slate-500">No invoices yet.</li>';
        return;
      }
      ul.innerHTML = invs.map(inv => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 flex justify-between items-center bg-white/80">
          <div>
            <div class="font-medium">${inv.id}</div>
            <div class="text-[10px] text-slate-500">
              Issued ${inv.issueDate} ‚Ä¢ Due ${inv.dueDate || '‚Äî'}
              ‚Ä¢ Total R ${Number(inv.total || 0).toFixed(2)}
              ‚Ä¢ ${inv.paid ? 'Paid' : 'Unpaid'}
              ${inv.lateApplied && inv.lateFeePercent ? ` ‚Ä¢ Late fee ${inv.lateFeePercent}%` : ''}
              ${inv.shortApplied && inv.shortNoticePercent ? ` ‚Ä¢ Short notice ${inv.shortNoticePercent}%` : ''}
            </div>
          </div>
          <button data-owner-only class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                  onclick="if(guardEdit()) openInvoiceModal(getInvoiceById('${inv.id}'))">
            Edit
          </button>
        </li>
      `).join('');
    }

    function renderStudentTodos(studentId) {
      const list = document.getElementById('studentTodosList');
      if (!list) return;
      const todos = state.studentTodos.filter(t => t.studentId === studentId);
      if (!todos.length) {
        list.innerHTML = '<li class="text-slate-500">No follow-ups yet.</li>';
        return;
      }
      list.innerHTML = todos.map(t => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 flex justify-between items-center bg-white/80">
          <div>
            <div class="${t.done ? 'line-through text-slate-400' : ''}">${t.text}</div>
            <div class="text-[10px] text-slate-500">${t.dueDate ? 'Due ' + t.dueDate : 'No due date'}</div>
          </div>
          <div class="flex gap-1">
            <button class="text-[10px] px-2 py-0.5 rounded-lg border border-slate-300"
                    onclick="toggleTodoStatus('${t.id}')">${t.done ? 'Undo' : 'Done'}</button>
            <button class="text-[10px] px-2 py-0.5 rounded-lg border border-rose-200 text-rose-600"
                    onclick="deleteTodo('${t.id}')">‚úï</button>
          </div>
        </li>
      `).join('');
    }

    function toggleTodoStatus(todoId) {
      const todo = state.studentTodos.find(t => t.id === todoId);
      if (!todo) return;
      todo.done = !todo.done;
      saveState();
      if (selectedStudentId) renderStudentTodos(selectedStudentId);
    }

    function deleteTodo(todoId) {
      if (!guardEdit()) return;
      state.studentTodos = state.studentTodos.filter(t => t.id !== todoId);
      saveState();
      if (selectedStudentId) renderStudentTodos(selectedStudentId);
    }

    function renderStudentContracts(studentId) {
      const list = document.getElementById('studentContractsList');
      if (!list) return;
      const contracts = state.contracts
        .filter(c => c.studentId === studentId)
        .sort((a, b) => new Date(b.uploadedAt || 0) - new Date(a.uploadedAt || 0));
      // If no contract record but a signature exists with a rendered URL, surface it as a synthetic entry
      const sig = getLatestSignature(studentId);
      if (sig && !contracts.find(c => c.id === sig.id)) {
        contracts.unshift({
          id: sig.id,
          studentId,
          fileName: 'signed_contract.pdf',
          status: 'Signed',
          uploadedAt: sig.signedAt || '',
          signedUrl: sig.renderedPdfUrl || sig.rendered_pdf_url || ''
        });
      }
      if (!contracts.length) {
        list.innerHTML = '<li class="text-slate-500">No contracts uploaded yet.</li>';
        return;
      }
      list.innerHTML = contracts.map(c => {
        const hasFile = !!c.signedUrl;
        const viewLink = hasFile ? `<a class="text-[10px] px-2 py-0.5 rounded-lg border border-slate-300 hover:bg-slate-50" href="${c.signedUrl}" target="_blank" rel="noopener">View</a>` : '';
        const downloadLink = hasFile ? `<a class="text-[10px] px-2 py-0.5 rounded-lg border border-slate-300 hover:bg-slate-50" href="${c.signedUrl}" download="${c.fileName || 'contract.pdf'}">Download</a>` : '';
        return `
        <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
          <div>
            <div class="font-medium flex items-center gap-1">${c.fileName || 'Contract'} <span class="text-[10px] px-2 py-0.5 rounded-full ${c.status === 'Signed' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${c.status || 'Pending'}</span></div>
            <div class="text-[10px] text-slate-500">Uploaded ${c.uploadedAt || ''}</div>
            ${!hasFile ? '<div class="text-[10px] text-amber-600">Signed file not available yet; refresh or re-sign if needed.</div>' : ''}
          </div>
          <div class="flex gap-1">
            ${viewLink}
            ${downloadLink}
            <button data-owner-only class="text-[10px] px-2 py-0.5 rounded-lg border border-emerald-300 text-emerald-700"
                    onclick="if(guardEdit()) markContractStatus('${c.id}', '${c.status === 'Signed' ? 'Pending' : 'Signed'}')">
              ${c.status === 'Signed' ? 'Mark pending' : 'Mark signed'}
            </button>
          </div>
        </li>
      `;
      }).join('');
    }

    function renderStudentCheckins(studentId) {
      const list = document.getElementById('studentCheckinsList');
      if (!list) return;
      const notes = state.studentCheckins
        .filter(n => n.studentId === studentId)
        .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
      if (!notes.length) {
        list.innerHTML = '<li class="text-slate-500">No check-ins yet.</li>';
        return;
      }
      list.innerHTML = notes.map(n => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
          <div class="text-[10px] text-slate-500">${n.date}</div>
          <div>${n.text}</div>
        </li>
      `).join('');
    }

    function renderStudentMessages(studentId) {
      const list = document.getElementById('studentMessagesList');
      if (!list) return;
      const msgs = state.messages
        .filter(m => m.studentId === studentId)
        .sort((a,b) => new Date(a.created_at||0) - new Date(b.created_at||0));
      if (!msgs.length) {
        list.innerHTML = '<li class="text-slate-500">No messages yet.</li>';
        return;
      }
      list.innerHTML = msgs.map(m => `
        <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
          <div class="flex items-center justify-between text-[10px] text-slate-500">
            <span>${m.sender === 'owner' ? 'Tutor' : 'Student'}</span>
            <span>${m.created_at ? new Date(m.created_at).toLocaleString() : ''}</span>
          </div>
          <div>${m.text}</div>
        </li>
      `).join('');
    }

    function openContractUpload(studentId) {
      const student = getStudentById(studentId);
      if (!student) return;
      if (!guardEdit()) return;
      const html = `
        <h2 class="text-sm font-semibold mb-3">Upload contract for ${student.name}</h2>
        <form id="contractForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Contract file (PDF or image)</label>
            <input type="file" name="file" accept=".pdf,image/*" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Status</label>
            <select name="status" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              <option value="Pending">Pending</option>
              <option value="Signed">Signed</option>
            </select>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Notes</label>
            <textarea name="notes" rows="2" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]" placeholder="Optional notes"></textarea>
          </div>
          <button type="submit" class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-xs font-medium">Upload</button>
        </form>
        <p class="hint mt-2">If signed in, files go to Supabase Storage; otherwise they stay local (base64).</p>
      `;
      openModal(html, () => {
        const form = document.getElementById('contractForm');
        form.onsubmit = (e) => {
          e.preventDefault();
          const file = form.file.files[0];
          const status = form.status.value;
          const notes = form.notes.value.trim();
          if (!file) {
            alert('Select a PDF or image file.');
            return;
          }
          if (isSupabaseReady()) {
            uploadContractToSupabase(studentId, file, status, notes)
              .then(() => {
                closeModal();
                renderStudentContracts(studentId);
                renderStudentTimeline(studentId);
              })
              .catch(err => {
                console.error(err);
                alert('Upload failed. See console for details.');
              });
          } else {
            const reader = new FileReader();
            reader.onload = () => {
              state.contracts.push({
                id: generateId('contract'),
                studentId,
                fileName: file.name,
                dataUrl: reader.result,
                status,
                notes,
                uploadedAt: new Date().toISOString().slice(0,10)
              });
              saveState();
              closeModal();
              renderStudentContracts(studentId);
              renderStudentTimeline(studentId);
            };
            reader.readAsDataURL(file);
          }
        };
      });
    }

    async function uploadContractToSupabase(studentId, file, status, notes) {
      const uid = supabaseSession?.user?.id;
      if (!uid) throw new Error('No session');
      const ext = file.name.includes('.') ? file.name.split('.').pop() : 'bin';
      // Object key must NOT include bucket name; folder prefix is the user id for RLS.
      const path = `${uid}/${generateId('file')}.${ext}`;
      const { error: uploadErr } = await supabaseClient.storage.from('contracts').upload(path, file, { upsert: false });
      if (uploadErr) throw uploadErr;
      const contract = {
        id: generateId('contract'),
        studentId,
        user_id: uid,
        fileName: file.name,
        storage_path: path,
        status,
        notes,
        uploadedAt: new Date().toISOString().slice(0,10),
        signedUrl: signed?.signedUrl
      };
      state.contracts.push(contract);
      saveState();
    }

    function markContractStatus(contractId, status) {
      const c = state.contracts.find(ct => ct.id === contractId);
      if (!c) return;
      c.status = status;
      // Update student contract flags when toggling status
      const stu = getStudentById(c.studentId);
      if (stu) {
        if (status === 'Signed') {
          stu.contractSigned = true;
          stu.contractSignedAt = new Date().toISOString();
          stu.lastContractId = contractId;
        } else {
          stu.contractSigned = false;
          stu.contractSignedAt = null;
          stu.contractSignerName = '';
          stu.contractSignerEmail = '';
          stu.lastContractId = null;
        }
      }
      saveState();
      if (selectedStudentId) {
        renderStudentContracts(selectedStudentId);
        renderStudentTimeline(selectedStudentId);
        renderStudentsView();
      }
      // Persist to Supabase
      if (isSupabaseReady()) {
        supabaseClient.from('contracts').update({ status }).eq('id', contractId).catch(err => {
          console.warn('Contract status update failed', err);
        });
        if (stu) {
          supabaseClient.from('students').update({
            contract_signed: status === 'Signed',
            contract_signed_at: status === 'Signed' ? stu.contractSignedAt : null,
            last_contract_id: status === 'Signed' ? contractId : null
          }).eq('id', stu.id).catch(err => console.warn('Student contract flag update failed', err));
        }
      }
    }

    /**************
     * SCHEDULE   *
     **************/
    let currentWeekStart = getMonday(new Date());

    function getMonday(d) {
      const date = new Date(d);
      const day = date.getDay();
      const diff = (day === 0 ? -6 : 1 - day);
      date.setDate(date.getDate() + diff);
      date.setHours(0,0,0,0);
      return date;
    }

    function renderScheduleView() {
      const label = document.getElementById('scheduleWeekLabel');
      const end = new Date(currentWeekStart);
      end.setDate(end.getDate() + 6);
      label.textContent = `${currentWeekStart.toISOString().slice(0,10)} ‚Äì ${end.toISOString().slice(0,10)}`;

      const grid = document.getElementById('scheduleCalendarGrid');
      const dayLoadRow = document.getElementById('dayLoadRow');
      const dayLoads = [];
      grid.innerHTML = '';
      for (let i = 0; i < 7; i++) {
        const day = new Date(currentWeekStart);
        day.setDate(day.getDate() + i);
        const isoDate = day.toISOString().slice(0,10);
        const sessions = state.sessions.filter(s => s.date === isoDate);
        const totalHours = sessions.reduce((acc, s) => acc + Number(s.durationHours || 0), 0);
        dayLoads.push({ totalHours, dayName: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][i] });
        const dayName = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][i];
        grid.innerHTML += `
          <div class="calendar-day" data-date="${isoDate}">
            <div class="flex flex-col mb-1">
              <span class="font-semibold">${dayName}</span>
              <span class="text-[10px] text-slate-500 whitespace-nowrap">${isoDate}</span>
            </div>
            <div class="space-y-1 text-[11px]">
              ${
        sessions.map(s => {
                  const subjectClass = s.subject === 'Physics'
                    ? 'text-indigo-700'
                    : s.subject === 'Chemistry'
                      ? 'text-emerald-700'
                      : 'text-rose-700';
                  const names = s.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
                  return `<div class="session-card cursor-pointer" onclick="openSessionQuickActions('${s.id}')">
                            <div class="flex items-center justify-between">
                              <span class="session-time ${subjectClass}">${s.startTime || ''}</span>
                              <span class="session-chip ${subjectClass}">${s.subject}</span>
                            </div>
                            <div class="text-[11px] font-semibold text-slate-800">${names}</div>
                            <div class="text-[10px] text-slate-600 leading-snug">${s.topic || ''}</div>
                          </div>`;
                }).join('')
              }
            </div>
          </div>
        `;
      }
      if (dayLoadRow) {
        const maxLoad = Math.max(...dayLoads.map(d => d.totalHours), 1);
        dayLoadRow.innerHTML = dayLoads.map(dl => {
          const pct = maxLoad ? Math.min(100, (dl.totalHours / maxLoad) * 100) : 0;
          return `<div class="flex flex-col gap-1">
            <div class="text-[10px] font-semibold">${dl.dayName}</div>
            <div class="w-full bg-slate-100 rounded-full h-2">
              <div class="h-2 rounded-full bg-indigo-500" style="width:${pct}%"></div>
            </div>
            <div class="text-[10px] text-slate-500">${dl.totalHours.toFixed(1)}h</div>
          </div>`;
        }).join('');
      }

      document.getElementById('schedulePrevWeek').onclick = () => {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        renderScheduleView();
      };
      document.getElementById('scheduleNextWeek').onclick = () => {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        renderScheduleView();
      };
      document.getElementById('scheduleToday').onclick = () => {
        currentWeekStart = getMonday(new Date());
        renderScheduleView();
      };
      const exportBtn = document.getElementById('exportIcsBtn');
      if (exportBtn) exportBtn.onclick = downloadIcsFile;

      const todayIso = new Date().toISOString().slice(0,10);
      const todayList = document.getElementById('todaySessionsList');
      const todaySessions = state.sessions.filter(s => s.date === todayIso)
        .sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));
      if (!todaySessions.length) {
        todayList.innerHTML = '<li class="text-slate-500">No sessions today.</li>';
      } else {
        todayList.innerHTML = todaySessions.map(s => {
          const names = s.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
          return `<li class="session-card">
            <div class="flex items-center justify-between">
              <div class="text-[10px] uppercase tracking-wide text-slate-500">${s.subject}</div>
              <div class="session-time">${s.startTime || ''}</div>
            </div>
            <div class="text-[11px] font-semibold text-slate-800">${names}</div>
            <div class="text-[10px] text-slate-600">${s.topic || ''} ‚Ä¢ ${s.durationHours || 1}h</div>
            <button class="mt-1 text-[10px] px-2 py-0.5 rounded-lg border border-slate-300 hover:bg-slate-50"
                    onclick="openSessionQuickActions('${s.id}')">
              Open
            </button>
          </li>`;
        }).join('');
      }

      renderClashes();
      renderTightTransitions();
    }

    function renderClashes() {
      const ul = document.getElementById('clashList');
      const clashes = [];
      const sessions = [...state.sessions].sort((a, b) => (a.date + 'T' + (a.startTime || '00:00')).localeCompare(b.date + 'T' + (b.startTime || '00:00')));
      for (let i = 0; i < sessions.length; i++) {
        for (let j = i+1; j < sessions.length; j++) {
          const a = sessions[i], b = sessions[j];
          if (a.date !== b.date) continue;
          const aStart = timeToMinutes(a.startTime || '00:00');
          const aEnd = aStart + Number(a.durationHours || 1) * 60;
          const bStart = timeToMinutes(b.startTime || '00:00');
          const bEnd = bStart + Number(b.durationHours || 1) * 60;
          if (aEnd <= bStart || bEnd <= aStart) continue;
          const sharedStudents = a.studentIds.filter(id => b.studentIds.includes(id));
          if (sharedStudents.length) {
            clashes.push({ a, b, sharedStudents });
          }
        }
      }
      if (!clashes.length) {
        ul.innerHTML = '<li class="text-slate-500">No clashes detected.</li>';
        return;
      }
      ul.innerHTML = clashes.slice(0, 10).map(c => {
        const names = c.sharedStudents.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
        return `<li class="border border-amber-300 bg-amber-50 text-amber-900 rounded-lg px-2 py-1">
          <div class="font-medium">Clash for ${names}</div>
          <div class="text-[10px]">
            ${c.a.date} ‚Ä¢ ${c.a.startTime || ''} vs ${c.b.startTime || ''}<br>
            ${c.a.subject} ‚Äì ${c.a.topic || 'Lesson'} <br>
            ${c.b.subject} ‚Äì ${c.b.topic || 'Lesson'}
          </div>
        </li>`;
      }).join('');
    }

    function renderTightTransitions() {
      const list = document.getElementById('tightTransitionsList');
      const byDate = {};
      state.sessions.forEach(s => {
        if (!byDate[s.date]) byDate[s.date] = [];
        byDate[s.date].push(s);
      });
      const tight = [];
      Object.keys(byDate).forEach(date => {
        const sessions = byDate[date].sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));
        for (let i = 0; i < sessions.length - 1; i++) {
          const currentEnd = timeToMinutes(sessions[i].startTime || '00:00') + Number(sessions[i].durationHours || 1) * 60;
          const nextStart = timeToMinutes(sessions[i+1].startTime || '00:00');
          const gap = nextStart - currentEnd;
          if (gap >= 0 && gap < 20) {
            tight.push({ a: sessions[i], b: sessions[i+1], gap, date });
          }
        }
      });
      if (!tight.length) {
        list.innerHTML = '<li class="text-slate-500">No tight transitions.</li>';
        return;
      }
      list.innerHTML = tight.slice(0, 6).map(item => {
        const aNames = item.a.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
        const bNames = item.b.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
        return `<li class="border border-amber-200 bg-amber-50 rounded-lg px-2 py-1">
          <div class="font-medium">${item.gap} min gap</div>
          <div class="text-[10px]">${item.date}: ${item.a.startTime || ''} ${aNames} ‚Üí ${item.b.startTime || ''} ${bNames}</div>
        </li>`;
      }).join('');
    }

    function timeToMinutes(t) {
      const [h, m] = t.split(':').map(Number);
      return h*60 + m;
    }

    function downloadIcsFile() {
      const lines = [];
      lines.push('BEGIN:VCALENDAR');
      lines.push('VERSION:2.0');
      lines.push('PRODID:-//Tutor Dashboard//ICS');
      state.sessions.forEach(sess => {
        const dtStart = new Date(sess.date + 'T' + (sess.startTime || '00:00'));
        const durationMs = Number(sess.durationHours || 1) * 60 * 60 * 1000;
        const dtEnd = new Date(dtStart.getTime() + durationMs);
        const format = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        const names = sess.studentIds.map(id => getStudentById(id)?.name || 'Student').join(', ');
        lines.push('BEGIN:VEVENT');
        lines.push('UID:' + sess.id + '@tutor-dashboard');
        lines.push('DTSTAMP:' + format(new Date()));
        lines.push('DTSTART:' + format(dtStart));
        lines.push('DTEND:' + format(dtEnd));
        lines.push('SUMMARY:' + (sess.subject || 'Session') + ' - ' + names);
        lines.push('DESCRIPTION:' + (sess.topic || '') + ' ' + (sess.notes || ''));
        lines.push('END:VEVENT');
      });
      lines.push('END:VCALENDAR');
      const blob = new Blob([lines.join('\n')], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tutor-sessions.ics';
      a.click();
      URL.revokeObjectURL(url);
    }

    function getSessionById(id) {
      return state.sessions.find(s => s.id === id);
    }

    function openSessionQuickActions(sessionId) {
      const sess = getSessionById(sessionId);
      if (!sess) return;
      const names = sess.studentIds.map(id => getStudentById(id)?.name || 'Unknown').join(', ');
      openModal(`
        <h2 class="text-sm font-semibold mb-2">Session with ${names}</h2>
        <p class="text-[11px] mb-2">${sess.subject} ‚Ä¢ ${sess.date} ‚Ä¢ ${sess.startTime || ''} (${sess.durationHours || 1}h)</p>
        <p class="text-[11px] mb-3">${sess.topic || ''}</p>

        <div class="space-y-2">
          <button id="sessionMarkCompletedBtn" class="w-full px-3 py-1.5 rounded-xl bg-emerald-600 text-white text-xs font-medium" data-owner-only>
            Mark attended & complete session
          </button>
          <button id="sessionEditBtn" class="w-full px-3 py-1.5 rounded-xl border border-slate-300 text-xs" data-owner-only>
            Edit session
          </button>
        </div>
      `, () => {
        document.getElementById('sessionMarkCompletedBtn').onclick = () => {
          if (!guardEdit()) return;
          sess.completed = true;
          saveState();
          closeModal();
          renderScheduleView();
          renderStudentsView();
        };
        document.getElementById('sessionEditBtn').onclick = () => {
          if (!guardEdit()) return;
          closeModal();
          openSessionModal(sess);
        };
      });
    }

    /*************
     * RESOURCES *
     *************/
    function renderResourcesView() {
      const list = document.getElementById('resourcesList');
      const subjectFilter = document.getElementById('resourceSubjectFilter').value;
      const searchTerm = document.getElementById('resourceSearchInput').value.trim().toLowerCase();
      const tagFiltersEl = document.getElementById('resourceTagFilters');
      const activeTag = tagFiltersEl?.dataset.active || '';

      const tagCounts = {};
      state.resources.forEach(r => {
        (r.tags || []).forEach(tag => {
          const key = tag.trim();
          if (!key) return;
          tagCounts[key] = (tagCounts[key] || 0) + 1;
        });
      });
      const topTags = Object.entries(tagCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);
      if (tagFiltersEl) {
        tagFiltersEl.innerHTML = (topTags.length ? topTags.map(([tag, count]) => `
          <button class="chip-btn ${activeTag === tag.toLowerCase() ? 'active' : ''}" data-tag="${tag}">#${tag} (${count})</button>
        `).join('') : '<span class="text-slate-500">Tags will appear after you add resources.</span>')
          + (activeTag ? ' <button class="chip-btn" data-tag="">Clear</button>' : '');
        tagFiltersEl.querySelectorAll('button[data-tag]').forEach(btn => {
          btn.onclick = () => {
            tagFiltersEl.dataset.active = (btn.dataset.tag || '').toLowerCase();
            renderResourcesView();
          };
        });
      }

      const filtered = state.resources.filter(r => {
        if (subjectFilter && r.subject !== subjectFilter) return false;
        if (searchTerm && !r.title.toLowerCase().includes(searchTerm) && !(r.tags || []).some(t => t.toLowerCase().includes(searchTerm))) {
          return false;
        }
        if (activeTag && !(r.tags || []).some(t => t.toLowerCase() === activeTag)) return false;
        return true;
      }).sort((a, b) => (b.favorite === true) - (a.favorite === true));
      if (!filtered.length) {
        list.innerHTML = '<li class="text-slate-500 text-xs">No resources yet. Add worksheets, lectures, or notes.</li>';
      } else {
        list.innerHTML = filtered.map(r => `
          <li class="border border-slate-200 rounded-xl px-3 py-2 bg-white/85">
            <div class="flex justify-between items-start gap-2">
              <div>
                <div class="font-semibold">${r.title}</div>
                <div class="text-[10px] text-slate-500">${r.subject} ‚Ä¢ ${r.level || ''}</div>
              </div>
              <div class="flex items-center gap-1">
                <button class="text-[12px]" title="Favorite"
                        onclick="toggleResourceFavorite('${r.id}')">${r.favorite ? '‚≠ê' : '‚òÜ'}</button>
                <button class="text-[10px] px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50"
                        onclick="openResourceModal(getResourceById('${r.id}'))">
                  Edit
                </button>
              </div>
            </div>
            <div class="mt-1 text-[10px]">${r.description || ''}</div>
          <div class="mt-1 flex flex-wrap">
              ${(r.tags || []).map(tag => `<span class="tag-pill">#${tag}</span>`).join('')}
            </div>
            <div class="mt-1 text-[10px] text-slate-500">
              ${getResourceUsageText(r.id)}
            </div>
            <div class="mt-2 flex gap-2 text-[11px] flex-wrap items-center">
              <button data-owner-only class="px-2 py-1 rounded-lg bg-slate-900 text-white hover:bg-slate-800"
                      onclick="if(guardEdit()) openAssignResourceModal('${r.id}')">
                Assign to student(s)
              </button>
              ${r.signedUrl ? `<a class="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50" href="${r.signedUrl}" target="_blank">Download file</a>` : ''}
              ${!r.signedUrl && r.dataUrl ? `<a class="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-50" href="${r.dataUrl}" download="${r.fileName || 'resource'}" target="_blank">Download local copy</a>` : ''}
              ${r.signedUrl && r.fileName && (r.fileName.endsWith('.png') || r.fileName.endsWith('.jpg') || r.fileName.endsWith('.jpeg')) ? `<img src="${r.signedUrl}" alt="${r.title}" class="h-12 rounded border border-slate-200">` : ''}
            </div>
          </li>
        `).join('');
      }

      document.getElementById('resourceSubjectFilter').onchange = renderResourcesView;
      document.getElementById('resourceSearchInput').oninput = renderResourcesView;

      renderHomeworkBoard();
    }

    function getResourceById(id) {
      return state.resources.find(r => r.id === id);
    }

    function getResourceUsageText(resourceId) {
      const assignments = state.homework.filter(hw => hw.resourceId === resourceId);
      if (!assignments.length) return 'Not assigned yet.';
      const last = assignments
        .map(a => a.dueDate || a.assignedDate)
        .filter(Boolean)
        .sort((a, b) => new Date(b) - new Date(a))[0];
      return `Assigned ${assignments.length}√ó ‚Ä¢ Last due ${last || 'n/a'}`;
    }

    function toggleResourceFavorite(resourceId) {
      const res = getResourceById(resourceId);
      if (!res) return;
      res.favorite = !res.favorite;
      saveState();
      renderResourcesView();
    }

    function renderHomeworkBoard() {
      const todo = document.getElementById('hwTodo');
      const doing = document.getElementById('hwInProgress');
      const done = document.getElementById('hwDone');
      todo.innerHTML = doing.innerHTML = done.innerHTML = '';

      const grouped = {
        'To do': [],
        'In progress': [],
        'Completed': []
      };

      state.homework.forEach(hw => {
        const res = state.resources.find(r => r.id === hw.resourceId);
        const student = getStudentById(hw.studentId);
        if (!res || !student) return;
        grouped[hw.status || 'To do'].push({
          ...hw,
          res, student
        });
      });

      function makeCard(hwObj) {
        const hw = hwObj;
        return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/85">
          <div class="font-medium">${hw.res.title}</div>
          <div class="text-[10px] text-slate-500">${hw.student.name} ‚Ä¢ Due ${hw.dueDate || 'n/a'}</div>
          <select class="mt-1 w-full border border-slate-300 rounded-lg px-1 py-0.5 text-[10px]"
                  onchange="updateHomeworkStatus('${hw.id}', this.value)">
            <option value="To do" ${hw.status === 'To do' ? 'selected' : ''}>To do</option>
            <option value="In progress" ${hw.status === 'In progress' ? 'selected' : ''}>In progress</option>
            <option value="Completed" ${hw.status === 'Completed' ? 'selected' : ''}>Completed</option>
          </select>
        </li>`;
      }

      todo.innerHTML = grouped['To do'].map(makeCard).join('') || '<li class="text-slate-500 text-[11px]">Nothing here.</li>';
      doing.innerHTML = grouped['In progress'].map(makeCard).join('') || '<li class="text-slate-500 text-[11px]">Nothing here.</li>';
      done.innerHTML = grouped['Completed'].map(makeCard).join('') || '<li class="text-slate-500 text-[11px]">Nothing here.</li>';
    }

    function updateHomeworkStatus(hwId, status) {
      const hw = state.homework.find(h => h.id === hwId);
      if (!hw) return;
      hw.status = status;
      saveState();
      renderResourcesView();
      if (selectedStudentId) {
        renderStudentTimeline(selectedStudentId);
      }
    }

    /*************
     * FINANCE   *
     *************/
    function getInvoiceById(id) {
      return state.invoices.find(inv => inv.id === id);
    }

    function renderFinanceView() {
      const tbody = document.getElementById('financeStudentTable');
      if (!state.students.length) {
        tbody.innerHTML = '';
      } else {
        tbody.innerHTML = state.students.map(s => {
          const invs = state.invoices.filter(inv => inv.studentId === s.id);
          let balance = 0;
          let unpaidCount = 0;
          invs.forEach(inv => {
            if (!inv.paid) {
              balance += Number(inv.total || 0);
              unpaidCount++;
            }
          });
          return `<tr>
            <td class="py-1 pr-1">${s.name}</td>
            <td class="py-1 pr-1 text-right ${balance > 0 ? 'text-rose-600' : 'text-emerald-600'}">
              R ${balance.toFixed(2)}
            </td>
            <td class="py-1 pr-1 text-right">${unpaidCount}</td>
          </tr>`;
        }).join('');
      }

      const overdueList = document.getElementById('overdueInvoicesList');
      const today = new Date();
      const overdue = state.invoices.filter(inv => !inv.paid && inv.dueDate && new Date(inv.dueDate) < today)
        .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

      if (!overdue.length) {
        overdueList.innerHTML = '<li class="text-slate-500">No overdue invoices.</li>';
      } else {
        overdueList.innerHTML = overdue.map(inv => {
          const s = getStudentById(inv.studentId);
          const studentName = s?.name || 'Unknown';
          return `<li class="border border-rose-200 bg-rose-50 text-rose-900 rounded-lg px-2 py-1">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-medium">${studentName}</div>
                <div class="text-[10px]">Invoice ${inv.id} ‚Ä¢ Due ${inv.dueDate} ‚Ä¢ R ${Number(inv.total || 0).toFixed(2)}</div>
                ${(inv.lateApplied && inv.lateFeePercent) || (inv.shortApplied && inv.shortNoticePercent) ? `<div class="text-[10px]">Fees: ${inv.lateApplied && inv.lateFeePercent ? 'Late ' + inv.lateFeePercent + '%' : ''} ${inv.shortApplied && inv.shortNoticePercent ? 'Short ' + inv.shortNoticePercent + '%' : ''}</div>` : ''}
              </div>
              <div class="flex flex-col gap-1">
                <button class="text-[10px] px-2 py-0.5 rounded-lg border border-rose-300 bg-rose-100"
                        onclick="markInvoicePaid('${inv.id}')">
                  Mark paid
                </button>
                <button class="text-[10px] px-2 py-0.5 rounded-lg border border-rose-300 bg-white"
                        onclick="generateReminder('${inv.id}')">
                  Reminder text
                </button>
              </div>
            </div>
          </li>`;
        }).join('');
      }

      const unbilledList = document.getElementById('unbilledList');
      if (unbilledList) {
      const unbilledSessions = state.sessions.filter(sess => !sess.invoiceId);
        const grouped = {};
        unbilledSessions.forEach(sess => {
          (sess.studentIds || []).forEach(sid => {
            if (!grouped[sid]) grouped[sid] = [];
            grouped[sid].push(sess);
          });
        });
        const unbilled = Object.entries(grouped).map(([sid, sessList]) => {
          const student = getStudentById(sid);
          const hours = sessList.reduce((acc, s) => acc + Number(s.durationHours || 0), 0);
          const amount = hours * (Number(student?.rate) || 0);
          const lastDate = sessList.length ? sessList.sort((a,b) => new Date(b.date) - new Date(a.date))[0].date : 'n/a';
          return { student, hours, amount, lastDate };
        }).filter(item => item.student)
          .sort((a, b) => b.amount - a.amount)
          .slice(0, 6);
        if (!unbilled.length) {
          unbilledList.innerHTML = '<li class="text-slate-500">No unbilled sessions detected.</li>';
        } else {
          unbilledList.innerHTML = unbilled.map(item => `
            <li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
              <div>
                <div class="font-medium">${item.student.name}</div>
                <div class="text-[10px] text-slate-500">${item.hours.toFixed(1)}h unbilled ‚Ä¢ Last ${item.lastDate}</div>
              </div>
              <div class="text-right text-[11px] font-semibold">R ${item.amount.toFixed(0)}</div>
            </li>
          `).join('');
        }
      }

      const forecastList = document.getElementById('forecastList');
      const forecastSummary = document.getElementById('forecastSummary');
      if (forecastList && forecastSummary) {
        const soonCutoff = new Date();
        soonCutoff.setDate(soonCutoff.getDate() + 14);
        const overdueInvoices = state.invoices.filter(inv => !inv.paid && inv.dueDate && new Date(inv.dueDate) < today);
        const dueSoon = state.invoices
          .filter(inv => !inv.paid && inv.dueDate && new Date(inv.dueDate) >= today && new Date(inv.dueDate) <= soonCutoff)
          .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        const overdueTotal = overdueInvoices.reduce((sum, inv) => sum + Number(inv.total || 0), 0);
        const dueSoonTotal = dueSoon.reduce((sum, inv) => sum + Number(inv.total || 0), 0);
        forecastSummary.textContent = `R ${dueSoonTotal.toFixed(0)} due in 14 days ‚Ä¢ R ${overdueTotal.toFixed(0)} overdue`;
        if (!dueSoon.length) {
          forecastList.innerHTML = '<li class="text-slate-500">No invoices due in the next 14 days.</li>';
        } else {
          forecastList.innerHTML = dueSoon.map(inv => {
            const s = getStudentById(inv.studentId);
            return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80 flex justify-between items-center">
              <div>
                <div class="font-medium">${s?.name || 'Unknown'}</div>
                <div class="text-[10px] text-slate-500">Invoice ${inv.id} ‚Ä¢ Due ${inv.dueDate}</div>
              </div>
              <div class="text-right text-[11px] font-semibold">R ${Number(inv.total || 0).toFixed(0)}</div>
            </li>`;
          }).join('');
        }
      }
    }

    function renderReportsView() {
      // Earnings month
      const now = new Date();
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      const invs = state.invoices.filter(inv => {
        const d = new Date(inv.issueDate || inv.dueDate || 0);
        return d >= startOfMonth && d < endOfMonth;
      });
      const earnings = invs.reduce((sum, inv) => sum + Number(inv.total || 0), 0);

      // Attendance
      const totalSessions = state.sessions.length;
      const completedSessions = state.sessions.filter(s => s.completed).length;
      const attendancePct = totalSessions ? Math.round((completedSessions / totalSessions) * 100) : 0;

      // Homework completion
      const hwTotal = state.homework.length;
      const hwCompleted = state.homework.filter(h => h.status === 'Completed').length;
      const hwPct = hwTotal ? Math.round((hwCompleted / hwTotal) * 100) : 0;

      // Subject hours
      const subjectHours = { Physics: 0, Chemistry: 0, Maths: 0 };
      state.sessions.forEach(s => {
        if (subjectHours[s.subject] != null) subjectHours[s.subject] += Number(s.durationHours || 0);
      });

      // Unpaid invoices
      const unpaid = state.invoices.filter(inv => !inv.paid).sort((a,b) => new Date(a.dueDate||0) - new Date(b.dueDate||0));

      const reportEarnings = document.getElementById('repEarningsMonth');
      const reportEarningsCount = document.getElementById('repEarningsCount');
      const reportAttendance = document.getElementById('repAttendance');
      const reportAttendanceMeta = document.getElementById('repAttendanceMeta');
      const reportHomework = document.getElementById('repHomework');
      const reportHomeworkMeta = document.getElementById('repHomeworkMeta');
      if (reportEarnings) reportEarnings.textContent = 'R ' + earnings.toFixed(2);
      if (reportEarningsCount) reportEarningsCount.textContent = invs.length + ' invoices this month';
      if (reportAttendance) reportAttendance.textContent = attendancePct + '%';
      if (reportAttendanceMeta) reportAttendanceMeta.textContent = `${completedSessions}/${totalSessions} completed`;
      if (reportHomework) reportHomework.textContent = hwPct + '%';
      if (reportHomeworkMeta) reportHomeworkMeta.textContent = `${hwCompleted}/${hwTotal} completed`;

      const mixUl = document.getElementById('repSubjectMix');
      if (mixUl) {
        mixUl.innerHTML = Object.entries(subjectHours).map(([k,v]) => `
          <li class="flex justify-between"><span>${k}</span><span>${v.toFixed(1)}h</span></li>
        `).join('');
      }
      const unpaidUl = document.getElementById('repUnpaidList');
      if (unpaidUl) {
        unpaidUl.innerHTML = unpaid.length ? unpaid.map(inv => {
          const stu = getStudentById(inv.studentId)?.name || 'Student';
          return `<li class="border border-slate-200 rounded-lg px-2 py-1 bg-white/80">
            <div class="font-medium">${stu}</div>
            <div class="text-[10px] text-slate-500">Invoice ${inv.id} ‚Ä¢ Due ${inv.dueDate || 'n/a'} ‚Ä¢ R ${Number(inv.total||0).toFixed(2)}</div>
          </li>`;
        }).join('') : '<li class="text-slate-500 text-xs">No unpaid invoices.</li>';
      }
    }

    function markInvoicePaid(id) {
      if (!guardEdit()) return;
      const inv = getInvoiceById(id);
      if (!inv) return;
      inv.paid = true;
      saveState();
      renderFinanceView();
      if (selectedStudentId) renderStudentFinance(selectedStudentId);
    }

    function generateReminder(id) {
      const inv = getInvoiceById(id);
      if (!inv) return;
      const s = getStudentById(inv.studentId);
      const name = s?.name || 'your child';
      const today = new Date().toISOString().slice(0,10);
      const text =
`Hi,

Just a friendly reminder about invoice ${inv.id} for ${name}, issued on ${inv.issueDate}, for R ${Number(inv.total || 0).toFixed(2)}. The due date was ${inv.dueDate || 'n/a'}.

If you have already made payment, please ignore this message. Otherwise, I‚Äôd appreciate it if you could settle it at your convenience.

Best regards,
[Your name]
(${today})`;
      openModal(`
        <h2 class="text-sm font-semibold mb-2">Reminder text</h2>
        <textarea class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]" rows="8">${text}</textarea>
        <p class="mt-2 text-[10px] text-slate-500">
          You can copy this message and paste it into email or WhatsApp.
        </p>
      `);
    }

    /*************
     * MODALS    *
     *************/
    function openModal(html, onReady) {
      const overlay = document.getElementById('modalOverlay');
      const container = document.getElementById('modalContainer');
      container.innerHTML = `
        <div class="flex justify-between items-start mb-3">
          <div></div>
          <button id="modalCloseBtn" class="h-7 w-7 rounded-full border border-slate-300 flex items-center justify-center text-xs">‚úï</button>
        </div>
        ${html}
      `;
      overlay.classList.add('show');
      document.getElementById('modalCloseBtn').onclick = closeModal;
      overlay.onclick = (e) => {
        if (e.target === overlay) closeModal();
      };
      if (onReady) onReady();
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('show');
    }

    /***********************
     * STUDENT CRUD MODAL  *
     ***********************/
    async function openStudentModal(student) {
      if (!guardEdit()) return;
      if (isSupabaseReady() && isOwner()) {
        await loadAccountEmails().catch(err => console.warn('Account email fetch failed', err));
      }
      const isEdit = !!student;
      const emailOptions = getAvailableStudentEmails(student?.studentEmail).map(e => `<option value="${e}">${e}</option>`).join('');
      const html = `
        <h2 class="text-sm font-semibold mb-3">${isEdit ? 'Edit student' : 'Add student'}</h2>
        <form id="studentForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Name</label>
            <input name="name" value="${student?.name || ''}" required
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Student email (for login)</label>
            <input list="studentEmailOptions" name="studentEmail" type="email" value="${student?.studentEmail || ''}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs" ${readOnlyMode ? 'disabled' : ''} placeholder="email@example.com">
            <datalist id="studentEmailOptions">${emailOptions}</datalist>
            <p class="text-[10px] text-slate-500 mt-1">Type or select an existing user email; each email can be used for only one student.</p>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Grade / Level</label>
              <input name="gradeLevel" value="${student?.gradeLevel || ''}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div>
              <label class="block text-[11px] mb-1">Hourly rate (R)</label>
              <input name="rate" type="number" step="0.01" value="${student?.rate || ''}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Subjects (comma separated)</label>
            <input name="subjects" value="${student?.subjects?.join(', ') || ''}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Notes</label>
            <textarea name="notes" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${student?.notes || ''}</textarea>
          </div>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-xs font-medium">
              ${isEdit ? 'Save changes' : 'Add student'}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteStudentBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                Delete
              </button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        document.getElementById('studentForm').onsubmit = (e) => {
          e.preventDefault();
          const form = e.target;
          const newStudent = {
            id: student?.id || generateId('stu'),
            name: form.name.value.trim(),
            gradeLevel: form.gradeLevel.value.trim(),
            rate: Number(form.rate.value || 0),
            subjects: form.subjects.value.split(',').map(s => s.trim()).filter(Boolean),
            notes: form.notes.value.trim(),
            studentEmail: form.studentEmail.value.trim(),
            contractSigned: student?.contractSigned || false,
            contractSignedAt: student?.contractSignedAt || null,
            contractVersion: student?.contractVersion || 'v1',
            contractSignerName: student?.contractSignerName || '',
            contractSignerEmail: student?.contractSignerEmail || ''
          };
          if (!newStudent.name) {
            alert('Name is required.');
            return;
          }
          if (newStudent.studentEmail) {
            const taken = state.students.some(s => s.studentEmail === newStudent.studentEmail && s.id !== newStudent.id);
            if (taken) {
              alert('That email is already linked to another student.');
              return;
            }
          }
          if (isEdit) {
            const idx = state.students.findIndex(s => s.id === student.id);
            state.students[idx] = newStudent;
            logActivity('Updated student', newStudent.name);
          } else {
            state.students.push(newStudent);
            logActivity('Added student', newStudent.name);
          }
          saveState();
          closeModal();
          renderStudentsView();
        };
        if (isEdit) {
          document.getElementById('deleteStudentBtn').onclick = () => {
            if (!confirm('Delete this student and all associated data?')) return;
            deleteStudentAndDependencies(student.id).then(() => {
              closeModal();
              selectedStudentId = null;
              renderStudentsView();
              logActivity('Deleted student', student.name);
            }).catch(err => {
              console.error(err);
              alert('Delete failed.');
            });
          };
        }
      });
    }

    /***********************
     * SESSION CRUD MODAL  *
     ***********************/
    function openSessionModal(session) {
      if (!guardEdit()) return;
      const isEdit = !!session;
      const html = `
        <h2 class="text-sm font-semibold mb-3">${isEdit ? 'Edit session' : 'Add session'}</h2>
        <form id="sessionForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Students</label>
            <div class="grid grid-cols-2 gap-1 max-h-32 overflow-y-auto border border-slate-300 rounded-lg px-2 py-1">
              ${
                state.students.length
                  ? state.students.map(s => `
                      <label class="flex items-center gap-1 text-[11px]">
                        <input type="checkbox" name="studentIds" value="${s.id}"
                          ${session?.studentIds?.includes(s.id) ? 'checked' : ''}>
                        <span>${s.name}</span>
                      </label>
                    `).join('')
                  : '<div class="text-slate-500 text-[11px]">No students yet.</div>'
              }
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Date</label>
              <input type="date" name="date" value="${session?.date || new Date().toISOString().slice(0,10)}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs" required>
            </div>
            <div>
              <label class="block text-[11px] mb-1">Start time</label>
              <input type="time" name="startTime" value="${session?.startTime || '16:00'}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Duration (hours)</label>
              <input type="number" step="0.25" name="durationHours" value="${(session?.durationHours ?? state.settings.defaultSessionDuration) || 1}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div>
              <label class="block text-[11px] mb-1">Subject</label>
              <select name="subject" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                <option value="Physics" ${session?.subject === 'Physics' ? 'selected' : ''}>Physics</option>
                <option value="Chemistry" ${session?.subject === 'Chemistry' ? 'selected' : ''}>Chemistry</option>
                <option value="Maths" ${session?.subject === 'Maths' ? 'selected' : ''}>Maths</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Topic / focus</label>
            <input name="topic" value="${session?.topic || ''}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Notes</label>
            <textarea name="notes" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${session?.notes || ''}</textarea>
          </div>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium">
              ${isEdit ? 'Save changes' : 'Add session'}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteSessionBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                Delete
              </button>` : ''}
          </div>
          <div id="sessionClashWarning" class="mt-2 text-[10px] text-amber-600"></div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('sessionForm');

        function updateClashWarning() {
          const date = form.date.value;
          const startTime = form.startTime.value || '00:00';
          const durationHours = Number(form.durationHours.value || 1);
          const selectedIds = [...form.querySelectorAll('input[name="studentIds"]:checked')].map(i => i.value);
          const warningEl = document.getElementById('sessionClashWarning');
          const clashes = state.sessions.filter(s => {
            if (isEdit && s.id === session.id) return false;
            if (s.date !== date) return false;
            const shared = s.studentIds.some(id => selectedIds.includes(id));
            if (!shared) return false;
            const aStart = timeToMinutes(startTime);
            const aEnd = aStart + durationHours * 60;
            const bStart = timeToMinutes(s.startTime || '00:00');
            const bEnd = bStart + Number(s.durationHours || 1) * 60;
            return !(aEnd <= bStart || bEnd <= aStart);
          });
          if (clashes.length) {
            warningEl.textContent = '‚ö† Potential clash: this overlaps with another session for the same student(s).';
          } else {
            warningEl.textContent = '';
          }
        }

        ['change','input'].forEach(ev => {
          form.date.addEventListener(ev, updateClashWarning);
          form.startTime.addEventListener(ev, updateClashWarning);
          form.durationHours.addEventListener(ev, updateClashWarning);
          form.querySelectorAll('input[name="studentIds"]').forEach(cb => cb.addEventListener(ev, updateClashWarning));
        });
        updateClashWarning();

        form.onsubmit = (e) => {
          e.preventDefault();
          const selectedIds = [...form.querySelectorAll('input[name="studentIds"]:checked')].map(i => i.value);
          if (!selectedIds.length) {
            alert('Select at least one student.');
            return;
          }
          const newSession = {
            id: session?.id || generateId('sess'),
            studentIds: selectedIds,
            date: form.date.value,
            startTime: form.startTime.value,
            durationHours: Number(form.durationHours.value || 1),
            subject: form.subject.value,
            topic: form.topic.value.trim(),
            notes: form.notes.value.trim(),
            completed: session?.completed || false
          };
        if (isEdit) {
          const idx = state.sessions.findIndex(s => s.id === session.id);
          state.sessions[idx] = newSession;
          logActivity('Updated session', newSession.topic || newSession.subject || 'Session');
        } else {
          state.sessions.push(newSession);
          logActivity('Added session', newSession.topic || newSession.subject || 'Session');
        }
          saveState();
          closeModal();
          renderScheduleView();
          renderStudentsView();
        };

        if (isEdit) {
          document.getElementById('deleteSessionBtn').onclick = () => {
            if (!confirm('Delete this session?')) return;
            deleteSessionAndLinks(session.id).then(() => {
              closeModal();
              renderScheduleView();
              renderStudentsView();
            }).catch(err => {
              console.error(err);
              alert('Delete failed. See console for details.');
            });
          };
        }
      });
    }

    async function deleteSessionAndLinks(sessionId) {
      // remove locally
      state.sessions = state.sessions.filter(s => s.id !== sessionId);
      saveState();
      // remove remotely if connected
      if (isSupabaseReady()) {
        const { error: linkErr } = await supabaseClient.from('session_students').delete().eq('session_id', sessionId);
        if (linkErr) throw linkErr;
        const { error: sessErr } = await supabaseClient.from('sessions').delete().eq('id', sessionId);
        if (sessErr) throw sessErr;
      }
    }

    /***********************
     * RESOURCE CRUD MODAL *
     ***********************/
    function openResourceModal(resource) {
      if (!guardEdit()) return;
      const isEdit = !!resource;
      const html = `
        <h2 class="text-sm font-semibold mb-3">${isEdit ? 'Edit resource' : 'Add resource'}</h2>
        <form id="resourceForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Title</label>
            <input name="title" value="${resource?.title || ''}" required
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Subject</label>
              <select name="subject" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                <option value="Physics" ${resource?.subject === 'Physics' ? 'selected' : ''}>Physics</option>
                <option value="Chemistry" ${resource?.subject === 'Chemistry' ? 'selected' : ''}>Chemistry</option>
                <option value="Maths" ${resource?.subject === 'Maths' ? 'selected' : ''}>Maths</option>
              </select>
            </div>
            <div>
              <label class="block text-[11px] mb-1">Level</label>
              <input name="level" value="${resource?.level || ''}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Tags (comma separated)</label>
            <input name="tags" value="${(resource?.tags || []).join(', ')}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Description / location</label>
            <textarea name="description" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${resource?.description || ''}</textarea>
          </div>
          <div class="border border-dashed border-slate-300 rounded-lg p-2 bg-slate-50">
            <label class="block text-[11px] mb-1">Attach file (PDF/Image/Doc)</label>
            <input type="file" name="file" class="w-full text-[11px]">
            <p class="text-[10px] text-slate-500 mt-1">Uploads require Supabase sign-in. Current file: ${resource?.fileName || 'None'}.</p>
            <div class="flex gap-2 mt-2">
              <button type="button" id="uploadResourceFileBtn" class="px-2 py-1 rounded-lg bg-slate-900 text-white text-[11px]">Upload</button>
              ${resource?.signedUrl ? `<a class="px-2 py-1 rounded-lg border border-slate-300 text-[11px]" href="${resource.signedUrl}" target="_blank">Download</a>` : ''}
            </div>
            <div id="uploadResourceStatus" class="text-[10px] text-slate-500 mt-1"></div>
          </div>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-xs font-medium">
              ${isEdit ? 'Save changes' : 'Add resource'}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteResourceBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                Delete
              </button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('resourceForm');
        const statusEl = document.getElementById('uploadResourceStatus');
        form.onsubmit = (e) => {
          e.preventDefault();
          const newRes = {
            id: resource?.id || generateId('res'),
            title: form.title.value.trim(),
            subject: form.subject.value,
            level: form.level.value.trim(),
            tags: form.tags.value.split(',').map(t => t.trim()).filter(Boolean),
            description: form.description.value.trim(),
            createdAt: resource?.createdAt || new Date().toISOString().slice(0,10),
            storage_path: resource?.storage_path || '',
            fileName: resource?.fileName || '',
            signedUrl: resource?.signedUrl || '',
            favorite: resource?.favorite || false
          };
          if (!newRes.title) {
            alert('Title is required.');
            return;
          }
        if (isEdit) {
          const idx = state.resources.findIndex(r => r.id === resource.id);
          state.resources[idx] = newRes;
          logActivity('Updated resource', newRes.title);
        } else {
          state.resources.push(newRes);
          logActivity('Added resource', newRes.title);
        }
          saveState();
          closeModal();
          renderResourcesView();
        };

        if (isEdit) {
          document.getElementById('deleteResourceBtn').onclick = () => {
            if (!confirm('Delete this resource?')) return;
            // attempt to delete from storage if present
            if (resource?.storage_path && isSupabaseReady()) {
              supabaseClient.storage.from('resources').remove([resource.storage_path])
                .catch(err => console.warn('Storage delete failed', err));
            }
            state.resources = state.resources.filter(r => r.id !== resource.id);
            state.homework = state.homework.filter(hw => hw.resourceId !== resource.id);
            saveState();
            closeModal();
            renderResourcesView();
          };
        }

        const uploadBtn = document.getElementById('uploadResourceFileBtn');
        if (uploadBtn) {
          uploadBtn.onclick = async () => {
            const file = form.file?.files?.[0];
            if (!file) {
              alert('Choose a file to upload.');
              return;
            }
            const maxSize = 15 * 1024 * 1024;
            const allowed = ['application/pdf','image/png','image/jpeg','image/jpg','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            if (file.size > maxSize) {
              alert('File too large (max 15MB).');
              return;
            }
            if (!allowed.some(t => file.type === t)) {
              alert('File type not allowed. Use PDF, PNG, JPEG, or DOC/DOCX.');
              return;
            }
            if (!isSupabaseReady()) {
              alert('Sign in to upload files.');
              return;
            }
            try {
              if (statusEl) statusEl.textContent = 'Uploading...';
              uploadBtn.disabled = true;
              const uploaded = await uploadResourceFile(file);
              resource = {
                ...(resource || { id: generateId('res') }),
                storage_path: uploaded.storage_path,
                fileName: uploaded.fileName,
                signedUrl: uploaded.signedUrl,
                dataUrl: uploaded.dataUrl || ''
              };
              if (statusEl) statusEl.textContent = uploaded.storage_path ? 'Uploaded. Save to keep link.' : 'Stored locally. Save to keep link.';
            } catch (err) {
              console.error(err);
              alert('Upload failed. See console for details.');
            } finally {
              uploadBtn.disabled = false;
            }
          };
        }
      });
    }

    let storageBlocked = false;

    async function uploadResourceFile(file) {
      // Fallback-friendly upload: try Supabase storage; if blocked by RLS/bucket issues, fall back to data URL so the user can still attach the file.
      const readAsDataUrl = (blob) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });

      const uid = supabaseSession?.user?.id;
      // If storage uploads are disabled or blocked, or not signed in, store locally as data URL
      if (!ALLOW_STORAGE_UPLOADS || storageBlocked || !uid || !supabaseClient?.storage) {
        const dataUrl = await readAsDataUrl(file);
        return { dataUrl, fileName: file.name, storage_path: '', signedUrl: '' };
      }

      const ext = file.name.includes('.') ? file.name.split('.').pop() : 'bin';
      // Object key must NOT include bucket name; folder prefix is the user id for RLS.
      const path = `${uid}/${generateId('file')}.${ext}`;
      const { error: uploadErr } = await supabaseClient.storage.from('resources').upload(path, file, { upsert: false });
      if (uploadErr) {
        const msg = (uploadErr?.message || '').toLowerCase();
        if (msg.includes('bucket') || msg.includes('policy') || msg.includes('row-level')) {
          storageBlocked = true;
          console.warn('Storage upload blocked, using local data URL fallback', uploadErr);
          const dataUrl = await readAsDataUrl(file);
          return { dataUrl, fileName: file.name, storage_path: '', signedUrl: '' };
        }
        throw uploadErr;
      }
      const { data: signed } = await supabaseClient.storage.from('resources').createSignedUrl(path, 60 * 60 * 24);
      return {
        storage_path: path,
        fileName: file.name,
        signedUrl: signed?.signedUrl || ''
      };
    }

    function openAssignResourceModal(resourceId) {
      if (!guardEdit()) return;
      const res = getResourceById(resourceId);
      if (!res) return;
      const html = `
        <h2 class="text-sm font-semibold mb-3">Assign "${res.title}"</h2>
        <form id="assignForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Students</label>
            <div class="grid grid-cols-2 gap-1 max-h-32 overflow-y-auto border border-slate-300 rounded-lg px-2 py-1">
              ${
                state.students.length
                  ? state.students.map(s => `
                      <label class="flex items-center gap-1 text-[11px]">
                        <input type="checkbox" name="studentIds" value="${s.id}">
                        <span>${s.name}</span>
                      </label>
                    `).join('')
                  : '<div class="text-slate-500 text-[11px]">No students yet.</div>'
              }
            </div>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Due date</label>
            <input type="date" name="dueDate" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs"
                   value="${new Date().toISOString().slice(0,10)}">
          </div>
          <button type="submit" class="mt-2 px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs font-medium">
            Assign
          </button>
        </form>
      `;
      openModal(html, () => {
        document.getElementById('assignForm').onsubmit = (e) => {
          e.preventDefault();
          const form = e.target;
          const ids = [...form.querySelectorAll('input[name="studentIds"]:checked')].map(i => i.value);
          if (!ids.length) {
            alert('Select at least one student.');
            return;
          }
          const dueDate = form.dueDate.value;
          const today = new Date().toISOString().slice(0,10);
          ids.forEach(stuId => {
            state.homework.push({
              id: generateId('hw'),
              studentId: stuId,
              resourceId,
              status: 'To do',
              dueDate,
              assignedDate: today
            });
          });
          saveState();
          closeModal();
          renderResourcesView();
          if (selectedStudentId) {
            renderStudentTimeline(selectedStudentId);
          }
        };
      });
    }

    /***********************
     * DOCUMENTS CRUD      *
     ***********************/
    function getDocumentById(id) {
      return state.documents.find(doc => doc.id === id);
    }

    function openDocumentModal(doc, fixedStudentId) {
      if (!guardEdit()) return;
      const isEdit = !!doc;
      const html = `
        <h2 class="text-sm font-semibold mb-3">${isEdit ? 'Edit document' : 'Add document'}</h2>
        <form id="docForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Student</label>
            <select name="studentId" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              ${
                state.students.map(s => `
                  <option value="${s.id}"
                    ${(doc?.studentId === s.id || fixedStudentId === s.id) ? 'selected' : ''}>
                    ${s.name}
                  </option>
                `).join('')
              }
            </select>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Title</label>
            <input name="title" value="${doc?.title || ''}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Status</label>
            <select name="status" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              <option value="Draft" ${doc?.status === 'Draft' ? 'selected' : ''}>Draft</option>
              <option value="Sent" ${doc?.status === 'Sent' ? 'selected' : ''}>Sent</option>
              <option value="Signed" ${doc?.status === 'Signed' ? 'selected' : ''}>Signed</option>
              <option value="Expired" ${doc?.status === 'Expired' ? 'selected' : ''}>Expired</option>
            </select>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Date</label>
            <input type="date" name="date" value="${doc?.date || new Date().toISOString().slice(0,10)}"
                   class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
          </div>
          <div>
            <label class="block text-[11px] mb-1">Location / notes</label>
            <textarea name="notes" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${doc?.notes || ''}</textarea>
          </div>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-amber-600 text-white text-xs font-medium">
              ${isEdit ? 'Save changes' : 'Add document'}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteDocBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                Delete
              </button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('docForm');
        form.onsubmit = (e) => {
          e.preventDefault();
          const newDoc = {
            id: doc?.id || generateId('doc'),
            studentId: form.studentId.value,
            title: form.title.value.trim(),
            status: form.status.value,
            date: form.date.value,
            notes: form.notes.value.trim(),
            createdAt: doc?.createdAt || new Date().toISOString().slice(0,10)
          };
          if (!newDoc.studentId) {
            alert('Select a student.');
            return;
          }
          if (!newDoc.title) {
            alert('Title required.');
            return;
          }
        if (isEdit) {
          const idx = state.documents.findIndex(d => d.id === doc.id);
          state.documents[idx] = newDoc;
          logActivity('Updated document', newDoc.title);
        } else {
          state.documents.push(newDoc);
          logActivity('Added document', newDoc.title);
        }
          saveState();
          closeModal();
          if (selectedStudentId) {
            renderStudentDocuments(selectedStudentId);
            renderStudentTimeline(selectedStudentId);
          }
        };

        if (isEdit) {
          document.getElementById('deleteDocBtn').onclick = () => {
            if (!confirm('Delete this document?')) return;
            state.documents = state.documents.filter(d => d.id !== doc.id);
            saveState();
            closeModal();
            if (selectedStudentId) {
              renderStudentDocuments(selectedStudentId);
              renderStudentTimeline(selectedStudentId);
            }
          };
        }
      });
    }

    /***********************
     * INVOICE CRUD MODAL  *
     ***********************/
    function openInvoiceModal(inv) {
      if (!guardEdit()) return;
      const isEdit = !!inv;
      const html = `
        <h2 class="text-sm font-semibold mb-3">${isEdit ? 'Edit invoice' : 'Create invoice'}</h2>
        <form id="invoiceForm" class="space-y-2">
          <div>
            <label class="block text-[11px] mb-1">Student</label>
            <select name="studentId" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
              ${
                state.students.map(s => `
                  <option value="${s.id}"
                    ${(inv?.studentId === s.id || (!inv && selectedStudentId === s.id)) ? 'selected' : ''}>
                    ${s.name}
                  </option>
                `).join('')
              }
            </select>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Bill these sessions</label>
            <div id="invoiceSessions" class="border border-slate-200 rounded-lg p-2 max-h-40 overflow-y-auto space-y-1 text-xs bg-white/70"></div>
            <p class="text-[10px] text-slate-500 mt-1">Only sessions for the selected student appear. Already-billed sessions are disabled.</p>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Invoice ID</label>
              <input name="id" value="${inv?.id || generateId('inv')}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div>
              <label class="block text-[11px] mb-1">Issue date</label>
              <input type="date" name="issueDate" value="${inv?.issueDate || new Date().toISOString().slice(0,10)}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Due date</label>
              <input type="date" name="dueDate" value="${inv?.dueDate || ''}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div>
              <label class="block text-[11px] mb-1">Base amount (R)</label>
              <input type="number" step="0.01" name="baseAmount" value="${inv?.baseAmount ?? inv?.total ?? ''}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Late fee %</label>
              <div class="flex items-center gap-2">
                <select name="lateFeePercent" class="flex-1 border border-slate-300 rounded-lg px-2 py-1 text-xs">
                  ${[0,5,10,15,20].map(p => `<option value="${p}" ${inv?.lateFeePercent === p ? 'selected' : ''}>${p}%</option>`).join('')}
                </select>
                <label class="flex items-center gap-1 text-[10px]">
                  <input type="checkbox" name="applyLate" ${inv?.lateApplied ? 'checked' : ''}>
                  <span>Apply</span>
                </label>
              </div>
            </div>
            <div>
              <label class="block text-[11px] mb-1">Short notice %</label>
              <div class="flex items-center gap-2">
                <select name="shortNoticePercent" class="flex-1 border border-slate-300 rounded-lg px-2 py-1 text-xs">
                  ${[0,5,10,15].map(p => `<option value="${p}" ${inv?.shortNoticePercent === p ? 'selected' : ''}>${p}%</option>`).join('')}
                </select>
                <label class="flex items-center gap-1 text-[10px]">
                  <input type="checkbox" name="applyShort" ${inv?.shortApplied ? 'checked' : ''}>
                  <span>Apply</span>
                </label>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-[11px] mb-1">Total amount (R)</label>
              <input type="number" step="0.01" name="total" value="${inv?.total || ''}"
                     class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
            </div>
            <div class="flex items-end">
              <div class="text-[10px] text-slate-500">Computed with fees: <span id="computedTotal">R 0.00</span></div>
            </div>
          </div>
          <div class="flex items-center gap-1 mt-1">
            <input type="checkbox" name="paid" id="invPaid" ${inv?.paid ? 'checked' : ''}>
            <label for="invPaid" class="text-[11px]">Mark as paid</label>
          </div>
          <div>
            <label class="block text-[11px] mb-1">Notes</label>
            <textarea name="notes" rows="3" class="w-full border border-slate-300 rounded-lg px-2 py-1 text-[11px]">${inv?.notes || ''}</textarea>
          </div>
          <p class="text-[10px] text-slate-500">
            Tip: set a base amount, tick ‚ÄúApply‚Äù on late/short notice fees, and we‚Äôll recalc the total automatically.
          </p>
          <div class="flex justify-between items-center mt-3">
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-emerald-600 text-white text-xs font-medium">
              ${isEdit ? 'Save invoice' : 'Create invoice'}
            </button>
            ${isEdit ? `
              <button type="button" id="deleteInvoiceBtn"
                class="px-3 py-1.5 rounded-xl border border-rose-300 text-rose-700 text-xs">
                Delete
              </button>` : ''}
          </div>
        </form>
      `;
      openModal(html, () => {
        const form = document.getElementById('invoiceForm');
        const sessionBox = form.querySelector('#invoiceSessions');

        const renderSessionChoices = () => {
          if (!sessionBox) return;
          const studentId = form.studentId.value || state.students[0]?.id || '';
          const selectedExisting = new Set([...form.querySelectorAll('input[name="sessionIds"]:checked')].map(i => i.value));
          const eligible = state.sessions.filter(s => s.studentIds.includes(studentId));
          if (!eligible.length) {
            sessionBox.innerHTML = '<div class="text-[10px] text-slate-500">No sessions for this student.</div>';
            return;
          }
          sessionBox.innerHTML = eligible.map(s => {
            const billedElsewhere = !!s.invoiceId && s.invoiceId !== (inv?.id || '');
            const checked = selectedExisting.has(s.id) || s.invoiceId === inv?.id;
            const detail = `${s.date} ${s.startTime || ''} ‚Ä¢ ${s.subject} ‚Ä¢ ${s.durationHours || 1}h`;
            return `<label class="flex items-center gap-2 text-[11px] ${billedElsewhere ? 'opacity-50' : ''}">
              <input type="checkbox" name="sessionIds" value="${s.id}" ${checked && !billedElsewhere ? 'checked' : ''} ${billedElsewhere ? 'disabled' : ''}>
              <span>${detail}</span>
              ${billedElsewhere ? '<span class="text-amber-600 text-[10px]">(already billed)</span>' : ''}
            </label>`;
          }).join('');
        };
        renderSessionChoices();
        form.studentId.onchange = renderSessionChoices;

        function computeTotalFromFees() {
          const base = Number(form.baseAmount.value || form.total.value || 0);
          const latePct = form.applyLate.checked ? Number(form.lateFeePercent.value || 0) : 0;
          const shortPct = form.applyShort.checked ? Number(form.shortNoticePercent.value || 0) : 0;
          const total = base * (1 + latePct/100 + shortPct/100);
          if (base > 0) {
            form.total.value = total.toFixed(2);
            const display = document.getElementById('computedTotal');
            if (display) display.textContent = 'R ' + total.toFixed(2);
          }
        }

        ['baseAmount','lateFeePercent','shortNoticePercent'].forEach(name => {
          const el = form[name];
          if (el) el.addEventListener('input', computeTotalFromFees);
        });
        ['applyLate','applyShort'].forEach(name => {
          const el = form[name];
          if (el) el.addEventListener('change', computeTotalFromFees);
        });
        computeTotalFromFees();

        form.onsubmit = async (e) => {
          e.preventDefault();
          const selectedSessionIds = new Set([...form.querySelectorAll('input[name="sessionIds"]:checked')].map(i => i.value));
          const newInv = {
            id: form.id.value.trim(),
            studentId: form.studentId.value,
            issueDate: form.issueDate.value,
            dueDate: form.dueDate.value,
            total: Number(form.total.value || 0),
            baseAmount: Number(form.baseAmount.value || 0),
            lateFeePercent: Number(form.lateFeePercent.value || 0),
            shortNoticePercent: Number(form.shortNoticePercent.value || 0),
            lateApplied: form.applyLate.checked,
            shortApplied: form.applyShort.checked,
            paid: form.paid.checked,
            notes: form.notes.value.trim()
          };
          if (!newInv.studentId) {
            alert('Select a student.');
            return;
          }
          if (!newInv.id) {
            alert('Invoice ID is required.');
            return;
          }
          try {
            if (isSupabaseReady()) {
              await upsertInvoiceRemote(newInv);
            }
            // relink sessions to this invoice
            state.sessions.forEach(s => {
              if (s.invoiceId === inv?.id && !selectedSessionIds.has(s.id)) {
                s.invoiceId = '';
              }
              if (selectedSessionIds.has(s.id)) {
                s.invoiceId = newInv.id;
              }
            });
            if (isEdit) {
              const idx = state.invoices.findIndex(i => i.id === inv.id);
              state.invoices[idx] = newInv;
              logActivity('Updated invoice', newInv.id);
            } else {
              const idx = state.invoices.findIndex(i => i.id === newInv.id);
              if (idx >= 0) state.invoices[idx] = newInv;
              else state.invoices.push(newInv);
              logActivity('Created invoice', newInv.id);
            }
            saveState();
            closeModal();
            renderFinanceView();
            if (selectedStudentId) renderStudentFinance(selectedStudentId);
          } catch (err) {
            console.error('Invoice sync failed', err);
            alert('Saved locally but Supabase sync failed: ' + (err?.message || err));
            // still update local state so UI stays consistent
            if (isEdit) {
              const idx = state.invoices.findIndex(i => i.id === inv.id);
              state.invoices[idx] = newInv;
              logActivity('Updated invoice (local only)', newInv.id);
            } else {
              const idx = state.invoices.findIndex(i => i.id === newInv.id);
              if (idx >= 0) state.invoices[idx] = newInv;
              else state.invoices.push(newInv);
              logActivity('Created invoice (local only)', newInv.id);
            }
            saveState();
          }
        };

        if (isEdit) {
          document.getElementById('deleteInvoiceBtn').onclick = async () => {
            if (!confirm('Delete this invoice?')) return;
            try {
              if (isSupabaseReady()) {
                await deleteInvoiceRemote(inv.id);
              }
              state.sessions.forEach(s => { if (s.invoiceId === inv.id) s.invoiceId = ''; });
              state.invoices = state.invoices.filter(i => i.id !== inv.id);
              saveState();
              closeModal();
              renderFinanceView();
              if (selectedStudentId) renderStudentFinance(selectedStudentId);
            } catch (err) {
              console.error('Invoice delete sync failed', err);
              alert('Deleted locally but Supabase delete failed: ' + (err?.message || err));
              state.invoices = state.invoices.filter(i => i.id !== inv.id);
              saveState();
            }
          };
        }
      });
    }
  </script>
</body>
</html>
