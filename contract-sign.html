<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sign Tutoring Contract</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background: #f8fafc; color: #0f172a; padding: 1.5rem; }
    .card { max-width: 720px; margin: 0 auto; background: white; border: 1px solid #e2e8f0; border-radius: 14px; padding: 1.5rem; box-shadow: 0 20px 60px -40px rgba(15,23,42,0.4);}
    label { font-size: 13px; font-weight: 600; display:block; margin-top: 0.75rem;}
    input, textarea { width:100%; padding: 0.6rem 0.75rem; border-radius: 10px; border:1px solid #cbd5e1; font-size: 14px;}
    button { padding: 0.7rem 1rem; border-radius: 12px; border: none; background:#0f172a; color:#fff; font-weight:600; cursor:pointer;}
    .muted { color:#64748b; font-size:12px;}
    .status { margin-bottom: 0.5rem; font-weight:700; }
  </style>
</head>
<body>
  <div class="card">
    <div id="status" class="status"></div>
    <h1 style="margin:0 0 0.25rem 0;">Tutoring Contract</h1>
    <p class="muted" id="studentName">Loading student…</p>
    <div style="border:1px solid #e2e8f0; border-radius:12px; padding:0.5rem; max-height:420px; overflow:hidden; background:#f8fafc; margin-top:0.5rem;">
      <iframe src="./Final_Tutor_Contract.pdf" title="Tutoring Contract PDF" style="width:100%; height:400px; border:0;"></iframe>
    </div>

    <form id="signForm">
      <label>Full name (legal guardian)</label>
      <input name="name" required>
      <label>Email</label>
      <input name="email" type="email" required>
      <label class="muted"><input type="checkbox" name="confirm" required style="width:auto; margin-right:6px;"> I confirm I am the parent or legal guardian, and I agree to this contract.</label>
      <button type="submit" style="margin-top:1rem;">Sign Contract</button>
    </form>
    <div id="message" class="muted" style="margin-top:0.75rem;"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://wdsqnbebutuhwckjpwqf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indkc3FuYmVidXR1aHdja2pwd3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMDE1NzcsImV4cCI6MjA3OTY3NzU3N30.pJglpTaZouSQFUVCbQONHK1UsB9CgWewKQCIV13NOEM';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const studentId = new URLSearchParams(location.search).get('student_id');
    const version = new URLSearchParams(location.search).get('v') || 'v1';
    const pdfPath = './Final_Tutor_Contract.pdf';
    const statusEl = document.getElementById('status');
    const msgEl = document.getElementById('message');
    const form = document.getElementById('signForm');
    let studentNameForText = '';

    if (!studentId) {
      statusEl.textContent = 'Missing student_id in the link.';
      form.style.display = 'none';
    } else {
      statusEl.textContent = 'Ready to sign';
    }

    async function loadStudent() {
      const { data, error } = await supabaseClient.from('students').select('name,contract_signed').eq('id', studentId).single();
      if (error || !data) {
        statusEl.textContent = 'Student not found.';
        form.style.display = 'none';
        return;
      }
      studentNameForText = data.name;
      document.getElementById('studentName').textContent = `Student: ${studentNameForText}`;
      if (data.contract_signed) {
        statusEl.textContent = 'Already signed';
      }
    }

    async function fetchPdfBase64() {
      const resp = await fetch(pdfPath);
      const buffer = await resp.arrayBuffer();
      const bytes = new Uint8Array(buffer);
      let binary = '';
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      if (!studentId) return;
      const name = form.name.value.trim();
      const email = form.email.value.trim();
      if (!name || !email || !form.confirm.checked) {
        msgEl.textContent = 'Please fill all fields and confirm.';
        return;
      }
      msgEl.textContent = 'Signing...';
      try {
        const pdfBase64 = await fetchPdfBase64().catch(() => '');
        const contractTextSnapshot = `Signed PDF: Final_Tutor_Contract.pdf • Version ${version} • Student: ${studentNameForText} • Signed by: ${name} (${email})`;
        const resp = await fetch(`${SUPABASE_URL}/functions/v1/sign-contract`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            student_id: studentId,
            name,
            email,
            version,
            signature_method: 'online click-to-sign',
            contract_text_snapshot: contractTextSnapshot,
            pdf_base64: pdfBase64,
            pdf_name: 'signed_contract.pdf'
          })
        });
        const json = await resp.json();
        if (!resp.ok || !json?.success) throw new Error(json?.error || 'Failed to sign.');
        msgEl.textContent = 'Signed! You may close this window.';
        statusEl.textContent = 'VALID – CONTRACT SIGNED';
        statusEl.style.color = '#16a34a';
      } catch (err) {
        msgEl.textContent = 'Error: ' + (err?.message || err);
      }
    };

    loadStudent();
  </script>
</body>
</html>
