<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sign Tutoring Contract</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer">
  <script src="./i18n.js"></script>
  <script src="./legal-i18n.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background: #f8fafc; color: #0f172a; padding: 1.5rem; }
    .page-shell { max-width: 940px; margin: 0 auto; }
    .page { background: #fff; border: 1px solid #e2e8f0; border-radius: 14px; padding: 1.5rem; box-shadow: 0 20px 60px -40px rgba(15,23,42,0.4); }
    h1 { margin: 0 0 0.3rem 0; }
    .muted { color:#64748b; font-size:12px; }
    .field-inline { border: 1px solid #cbd5e1; border-radius: 8px; padding: 4px 6px; min-width: 160px; font-size: 13px; }
    .block-field { width: 100%; margin: 4px 0; }
    .section-title { font-weight: 700; margin-top: 1rem; }
    button { padding: 0.75rem 1rem; border-radius: 12px; border: none; background:#0f172a; color:#ffffff; font-weight:600; cursor:pointer; }
    .status { margin-bottom: 0.5rem; font-weight:700; }
    ul { padding-left: 1.2rem; }
    li { margin-bottom: 4px; }
    .inline-label { font-weight: 600; }
    .lang-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .lang-label { font-size: 11px; color: #475569; font-weight: 600; }
    .lang-select { border: 1px solid #cbd5e1; border-radius: 10px; padding: 6px 10px; font-size: 12px; }
    .lang-banner {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      color: #7c2d12;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .lang-banner.hidden { display: none; }
    .lang-buttons { display: flex; gap: 6px; flex-wrap: wrap; }
    .lang-btn { border: 1px solid #fdba74; background: #ff9b5d; padding: 6px 10px; border-radius: 10px; font-size: 12px; cursor: pointer; }
    .modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 40; }
    .modal.hidden { display: none; }
    .modal-backdrop { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.45); }
    .modal-card { position: relative; background: #fff; border-radius: 16px; padding: 20px; width: min(92vw, 420px); box-shadow: 0 24px 70px -30px rgba(15, 23, 42, 0.6); }
    .modal-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; }
    .modal-message { font-size: 13px; color: #334155; white-space: pre-wrap; }
    .modal-actions { margin-top: 16px; display: flex; justify-content: flex-end; }
    .modal-actions button { background: #0f172a; color: #fff; border-radius: 10px; padding: 8px 14px; border: none; font-weight: 600; cursor: pointer; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.35); display: flex; align-items: center; justify-content: center; z-index: 45; }
    .loading-overlay.hidden { display: none; }
    .loading-card { background: #fff; border-radius: 16px; padding: 20px 24px; box-shadow: 0 24px 70px -30px rgba(15, 23, 42, 0.6); display: flex; align-items: center; gap: 12px; }
    .loading-text { font-size: 13px; color: #0f172a; font-weight: 600; }
    .spinner { width: 18px; height: 18px; border: 2px solid #cbd5e1; border-top-color: #0f172a; border-radius: 50%; animation: spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="page-shell">
    <div id="langBanner" class="lang-banner hidden">
      <div data-lang-banner-text>Choose language / Elige idioma / Choisissez la langue / 请选择语言</div>
      <div class="lang-buttons">
        <button type="button" class="lang-btn" data-lang-button="en">English</button>
        <button type="button" class="lang-btn" data-lang-button="es">Español</button>
        <button type="button" class="lang-btn" data-lang-button="fr">Français</button>
        <button type="button" class="lang-btn" data-lang-button="zh">中文（简体）</button>
      </div>
    </div>

    <div class="lang-row">
      <div class="lang-label" data-i18n="top.language_label">Language / Idioma / Langue / 中文</div>
      <select class="lang-select" data-lang-select>
        <option value="en" data-i18n="lang.option.en">English</option>
        <option value="es" data-i18n="lang.option.es">Español</option>
        <option value="fr" data-i18n="lang.option.fr">Français</option>
        <option value="zh" data-i18n="lang.option.zh">中文（简体）</option>
      </select>
    </div>

    <form id="signForm">
      <div class="page" id="contractPage">
        <div id="message" class="muted"></div>
        <div id="contractContent"></div>
      </div>
    </form>
  </div>

  <div id="loadingOverlay" class="loading-overlay hidden" role="status" aria-live="polite">
    <div class="loading-card">
      <div class="spinner"></div>
      <div class="loading-text" id="loadingText">Preparing contract...</div>
    </div>
  </div>

  <div id="contractModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-backdrop"></div>
    <div class="modal-card">
      <div class="modal-title" id="contractModalTitle"></div>
      <div class="modal-message" id="contractModalMessage"></div>
      <div class="modal-actions">
        <button type="button" id="contractModalClose"></button>
      </div>
    </div>
  </div>

  <footer style="margin: 16px auto; max-width: 900px; color: #64748b; font-size: 12px; text-align: center;" data-merchant-disclosure></footer>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    const CANONICAL_ORIGIN = 'https://tutor-mcp.com';
    const LEGACY_BASE_PATH = '/tutor-dashboard';
    const isLocalDevHost = /^(localhost|127\.0\.0\.1|0\.0\.0\.0|::1)$/i.test(window.location.hostname);
    if (!isLocalDevHost && window.location.origin !== CANONICAL_ORIGIN) {
      const target = new URL(window.location.href);
      target.protocol = 'https:';
      target.host = new URL(CANONICAL_ORIGIN).host;
      if (target.pathname === LEGACY_BASE_PATH) {
        target.pathname = '/';
      } else if (target.pathname.startsWith(`${LEGACY_BASE_PATH}/`)) {
        target.pathname = target.pathname.slice(LEGACY_BASE_PATH.length) || '/';
      }
      window.location.replace(target.toString());
    }

    const SUPABASE_URL = 'https://wdsqnbebutuhwckjpwqf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indkc3FuYmVidXR1aHdja2pwd3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMDE1NzcsImV4cCI6MjA3OTY3NzU3N30.pJglpTaZouSQFUVCbQONHK1UsB9CgWewKQCIV13NOEM';

    const params = new URLSearchParams(location.search);
    const studentId = params.get('student_id');
    const studentNameParam = (params.get('student_name') || '').trim();
    const version = params.get('v') || 'v1';
    const signingToken = (params.get('token') || '').trim();
    if (signingToken) {
      const scrubbed = new URL(window.location.href);
      scrubbed.searchParams.delete('token');
      history.replaceState({}, document.title, `${scrubbed.pathname}${scrubbed.search}${scrubbed.hash}`);
    }

    const msgEl = document.getElementById('message');
    const form = document.getElementById('signForm');
    let statusEl = null;
    let studentNameEl = null;
    let signBtn = null;
    const modal = document.getElementById('contractModal');
    const modalTitle = document.getElementById('contractModalTitle');
    const modalMessage = document.getElementById('contractModalMessage');
    const modalClose = document.getElementById('contractModalClose');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');

    function getCurrentLang() {
      return typeof getLanguage === 'function' ? getLanguage() : 'en';
    }

    function closeContractModal() {
      if (modal) modal.classList.add('hidden');
    }

    function showContractModal({ title, message }) {
      if (!modal || !modalTitle || !modalMessage || !modalClose) return;
      modalTitle.textContent = title || '';
      modalMessage.textContent = message || '';
      modalClose.textContent = t('contract.popup_cta');
      modal.classList.remove('hidden');
    }

    function showLoading(message) {
      if (!loadingOverlay || !loadingText) return;
      loadingText.textContent = message || t('contract.msg_submitting');
      loadingOverlay.classList.remove('hidden');
    }

    function setLoadingText(message) {
      if (loadingText) loadingText.textContent = message || '';
    }

    function hideLoading() {
      if (loadingOverlay) loadingOverlay.classList.add('hidden');
    }

    function clearUnloadWarning() {
      window.onbeforeunload = null;
      const blocker = (e) => {
        e.stopImmediatePropagation();
      };
      window.addEventListener('beforeunload', blocker, { capture: true, once: true });
    }

    if (modalClose) modalClose.onclick = closeContractModal;
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target.classList.contains('modal-backdrop')) closeContractModal();
      });
    }

    function renderContract() {
      const lang = getCurrentLang();
      const html = window.LEGAL_I18N?.CONTRACT_HTML?.[lang] || window.LEGAL_I18N?.CONTRACT_HTML?.en || '';
      const container = document.getElementById('contractContent');
      if (container) container.innerHTML = html;
      if (typeof applyI18n === 'function') applyI18n(container || document);
      statusEl = document.getElementById('status');
      studentNameEl = document.getElementById('studentName');
      signBtn = document.getElementById('signBtn');
      hydrateDefaults();
      updateStatus();
    }

    function updateStatus() {
      if (!statusEl) return;
      if (!studentId) {
        statusEl.textContent = t('contract.status_missing_student');
      } else if (!signingToken) {
        statusEl.textContent = t('contract.status_missing_token');
        if (signBtn) {
          signBtn.disabled = true;
          signBtn.style.opacity = '0.6';
          signBtn.style.cursor = 'not-allowed';
        }
      } else {
        statusEl.textContent = t('contract.status_ready');
      }
    }

    function normalizeSpaces(value) {
      return String(value || '').replace(/\s+/g, ' ').trim();
    }

    function getFieldsFromInputs() {
      const get = (name) => (document.querySelector(`[name="${name}"]`)?.value || '').trim();
      const today = new Date().toISOString().slice(0,10);
      return {
        date: get('date') || today,
        guardian_name: get('guardian_name'),
        guardian_id: get('guardian_id'),
        guardian_email: get('guardian_email'),
        guardian_phone: get('guardian_phone'),
        tutor_name: get('tutor_name') || get('guardian_name'),
        tutor_email: get('tutor_email') || get('guardian_email'),
        parent_name: normalizeSpaces(get('parent_name')),
        parent_id: get('parent_id'),
        parent_email: get('parent_email'),
        parent_phone: get('parent_phone'),
        student_name: normalizeSpaces(get('student_name')),
        student_dob: get('student_dob'),
        student_school: normalizeSpaces(get('student_school')),
        address: get('address'),
        relationship: normalizeSpaces(get('relationship')),
        guardian_signature: get('guardian_signature'),
        parent_signature: normalizeSpaces(get('parent_signature')),
        date_guardian: get('date_guardian') || today,
        date_parent: get('date_parent') || today,
        guardian_signature_name: get('guardian_signature_name'),
        parent_signature_name: get('parent_signature_name'),
        guardian_signature_date: get('guardian_signature_date') || today,
        parent_signature_date: get('parent_signature_date') || today,
        tutor_signature_date: get('tutor_signature_date') || today,
        signature: normalizeSpaces(get('signature_text')),
        parent_signature_text: normalizeSpaces(get('signature_text')),
      };
    }

    function hydrateDefaults() {
      if (studentNameParam && studentNameEl) {
        studentNameEl.textContent = studentNameParam;
      }
      const setIfEmpty = (name, val) => {
        const el = document.querySelector(`[name="${name}"]`);
        if (el && !el.value) el.value = val;
      };
      setIfEmpty('guardian_name', 'Yu Qin');
      setIfEmpty('guardian_email', '17449125@qq.com');
      setIfEmpty('guardian_phone', '+27 736696754');
      setIfEmpty('guardian_signature', 'Yu Qin');
      setIfEmpty('guardian_signature_name', 'Yu Qin');
      setIfEmpty('tutor_name', 'Shangjing Huang');
      setIfEmpty('tutor_email', 'erichuang.shangjing@outlook.com');
      setIfEmpty('package_months', '6');
    }

    function createContractClone() {
      const source = document.getElementById('contractContent');
      if (!source) return null;
      const clone = source.cloneNode(true);
      clone.querySelectorAll('#status, #studentName').forEach(el => el.remove());
      clone.querySelectorAll('button').forEach(el => el.remove());
      clone.querySelectorAll('input, textarea, select').forEach(input => {
        const span = document.createElement('span');
        span.textContent = input.value || '';
        span.className = input.className || '';
        span.style.whiteSpace = 'pre-wrap';
        input.replaceWith(span);
      });
      return clone;
    }

    function buildContractSnapshotFromDom(executionRecord) {
      const clone = createContractClone();
      if (!clone) return executionRecord || '';
      let text = clone.innerText || clone.textContent || '';
      text = text.replace(/\n{3,}/g, '\n\n').trim();
      return executionRecord ? `${text}\n${executionRecord}` : text;
    }

    function buildPaginatedPages(wrapper, clone, pageHeightPx, wrapperWidth) {
      if (!wrapper || !clone) return { pages: [] };
      const pagesHost = document.createElement('div');
      pagesHost.style.width = '100%';
      wrapper.appendChild(pagesHost);

      const nodes = Array.from(clone.childNodes).map(node => {
        if (node.nodeType === Node.TEXT_NODE) {
          const text = node.textContent || '';
          if (!text.trim()) return null;
          const p = document.createElement('p');
          p.textContent = text.trim();
          return p;
        }
        return node;
      }).filter(Boolean);

      const pages = [];
      const createPage = () => {
        const page = document.createElement('div');
        page.style.width = `${wrapperWidth}px`;
        page.style.height = `${pageHeightPx}px`;
        page.style.boxSizing = 'border-box';
        page.style.padding = '16px';
        page.style.background = '#ffffff';
        page.style.display = 'block';
        page.style.overflow = 'hidden';
        pagesHost.appendChild(page);
        pages.push(page);
        return page;
      };

      let page = createPage();
      const maxHeight = pageHeightPx;
      nodes.forEach(node => {
        page.appendChild(node);
        if (page.scrollHeight > maxHeight) {
          page.removeChild(node);
          if (!page.childNodes.length) {
            page.appendChild(node);
          } else {
            page = createPage();
            page.appendChild(node);
          }
        }
      });

      return { pages };
    }

    async function renderPdfFromDom(options = {}) {
      const jsPDF = window.jspdf?.jsPDF;
      if (!jsPDF || !window.html2canvas) return '';
      const scale = options.scale || 1;
      const quality = typeof options.quality === 'number' ? options.quality : 0.72;
      const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const wrapperWidth = 820;
      const pageHeightPx = Math.floor(wrapperWidth * (pageHeight / pageWidth));
      const clone = createContractClone();
      if (!clone) return '';
      const wrapper = document.createElement('div');
      wrapper.style.position = 'fixed';
      wrapper.style.left = '-9999px';
      wrapper.style.top = '0';
      wrapper.style.width = `${wrapperWidth}px`;
      wrapper.style.padding = '0';
      wrapper.style.background = '#ffffff';
      document.body.appendChild(wrapper);
      let pdfBase64 = '';
      try {
        const { pages } = buildPaginatedPages(wrapper, clone, pageHeightPx, wrapperWidth);
        if (!pages.length) return '';
        for (let i = 0; i < pages.length; i += 1) {
          const canvas = await window.html2canvas(pages[i], {
            scale,
            backgroundColor: '#ffffff',
            useCORS: true
          });
          const imgData = canvas.toDataURL('image/jpeg', quality);
          if (i > 0) pdf.addPage();
          pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pageHeight);
        }
        const dataUri = pdf.output('datauristring');
        pdfBase64 = dataUri.split(',')[1] || '';
      } finally {
        wrapper.remove();
      }
      return pdfBase64;
    }

    async function loadStudent() {
      if (!studentId) return;
      try {
        const resp = await fetch(`${SUPABASE_URL}/rest/v1/students?id=eq.${studentId}&select=name,contract_signed`, {
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        const data = await resp.json();
        const student = data && data[0];
        if (student && student.name && studentNameEl) {
          studentNameEl.textContent = student.name;
        }
      } catch (_err) {
        // ignore
      }
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      if (!studentId) {
        const message = t('contract.error_missing_student');
        msgEl.textContent = message;
        showContractModal({ title: t('contract.popup_title_error'), message });
        return;
      }
      if (!signingToken) {
        const message = t('contract.error_missing_token');
        msgEl.textContent = message;
        showContractModal({ title: t('contract.popup_title_error'), message });
        return;
      }
      const fields = getFieldsFromInputs();
      if (!fields.parent_name || !fields.parent_email || !fields.student_name || !fields.student_dob || !fields.student_school || !fields.relationship || !fields.signature) {
        const message = t('contract.error_missing_fields');
        msgEl.textContent = message;
        showContractModal({ title: t('contract.popup_title_error'), message });
        return;
      }
      if (fields.parent_phone) {
        const digits = fields.parent_phone.replace(/\D/g, '');
        if (digits.length < 7) {
          const message = t('contract.error_invalid_phone');
          msgEl.textContent = message;
          showContractModal({ title: t('contract.popup_title_error'), message });
          return;
        }
      }
      const name = fields.parent_name;
      const email = fields.parent_email;
      msgEl.textContent = t('contract.msg_preparing');
      showLoading(t('contract.msg_preparing'));
      if (signBtn) signBtn.disabled = true;
      try {
        const contractLanguage = getCurrentLang();
        const userAgent = navigator.userAgent || '';
        const executionRecord = [
          '',
          'EXECUTION RECORD',
          `Timestamp (ISO): ${new Date().toISOString()}`,
          `Parent email: ${email}`,
          `Parent typed signature: ${fields.parent_signature}`,
          `Student ID: ${studentId}`,
          `Contract version: ${version}`,
          `Contract language: ${contractLanguage}`,
          `User agent: ${userAgent}`
        ].join('\n');

        const contractTextSnapshot = buildContractSnapshotFromDom(executionRecord);
        msgEl.textContent = t('contract.msg_generating_pdf');
        setLoadingText(t('contract.msg_generating_pdf'));
        let pdfBase64 = '';
        let pdfName = 'signed_contract.pdf';
        const safeName = (fields.student_name || 'student').replace(/[^a-z0-9_-]+/gi, '_');
        const langSuffix = contractLanguage && contractLanguage !== 'en' ? `_${contractLanguage}` : '';
        pdfName = `signed_contract_${safeName}${langSuffix}.pdf`;
        try {
          pdfBase64 = await renderPdfFromDom({ scale: 1.6, quality: 0.95 });
          if (pdfBase64 && pdfBase64.length > 18000000) {
            pdfBase64 = await renderPdfFromDom({ scale: 1.45, quality: 0.9 });
          }
          if (pdfBase64 && pdfBase64.length > 14000000) {
            pdfBase64 = await renderPdfFromDom({ scale: 1.25, quality: 0.85 });
          }
        } catch (err) {
          pdfBase64 = '';
        }
        msgEl.textContent = t('contract.msg_submitting');
        setLoadingText(t('contract.msg_submitting'));
        const resp = await fetch(`${SUPABASE_URL}/functions/v1/sign-contract`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({
            student_id: studentId,
            signing_token: signingToken,
            name,
            email,
            version,
            signature_method: 'online click-to-sign',
            contract_text_snapshot: contractTextSnapshot,
            pdf_base64: pdfBase64,
            pdf_name: pdfName,
            signature_text: fields.parent_signature,
            parent_phone: fields.parent_phone,
            parent_id: fields.parent_id,
            contract_language: contractLanguage,
            student_name: fields.student_name,
            student_dob: fields.student_dob,
            student_school: fields.student_school,
            relationship: fields.relationship,
            user_agent: userAgent
          })
        });
        const text = await resp.text();
        let json = {};
        try { json = text ? JSON.parse(text) : {}; } catch {}
        if (!resp.ok || !json?.success) {
          throw new Error(json?.error || text || `Failed with status ${resp.status}`);
        }
        msgEl.textContent = t('contract.msg_success');
        if (statusEl) {
          statusEl.textContent = t('contract.status_signed');
          statusEl.style.color = '#16a34a';
        }
        clearUnloadWarning();
        showContractModal({ title: t('contract.popup_title_success'), message: t('contract.msg_success') });
      } catch (err) {
        const message = t('contract.msg_error', { error: err?.message || err });
        msgEl.textContent = message;
        showContractModal({ title: t('contract.popup_title_error'), message });
      } finally {
        hideLoading();
        if (signBtn) signBtn.disabled = false;
      }
    };

    if (window.initLanguageUI) initLanguageUI();
    renderContract();
    window.addEventListener('i18n:change', renderContract);

    loadStudent();
  </script>
  <script src="./business-config.js"></script>
  <script src="./business-ui.js"></script>
</body>
</html>
